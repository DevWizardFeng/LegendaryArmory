<h1 _ngcontent-slp-c119="" class="doc-title ng-star-inserted" title="嵌入ArkTS组件"> 嵌入ArkTS组件 </h1>

<div _ngcontent-slp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>ArkUI在Native侧提供的能力作为ArkTS的子集，部分能力不会在Native侧提供，如声明式UI语法，自定义struct组件，UI高级组件。</p>    <p>针对需要使用ArkTS侧独立能力的场景，ArkUI开发框架提供了Native侧嵌入ArkTS组件的能力，该能力依赖<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-componentcontent" target="_blank">ComponentContent</a>机制，通过ComponentContent完成对ArkTS组件的封装，然后将封装对象传递到Native侧，通过Native侧的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-napi-h#oh_arkui_getnodehandlefromnapivalue" target="_blank">OH_ArkUI_GetNodeHandleFromNapiValue</a>接口转化为ArkUI_NodeHandle对象用于Native侧组件挂载使用。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>        <p>通过OH_ArkUI_GetNodeHandleFromNapiValue接口获得的ArkUI_NodeHandle对象只能作为子组件参数使用，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#addchild" target="_blank">addChild</a>接口的第二个参数，将该对象使用在其他场景下，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#setattribute" target="_blank">setAttribute</a>设置属性将不生效并返回错误码。</p></li>       <li>        <p>针对Native侧修改ArkTS组件的场景，需要在Native侧通过Node-API方式构建ArkTS侧的更新数据，再通过ComponentContent的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-componentcontent#update" target="_blank">update</a>接口更新。</p></li>       <li>        <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-build-custom-components">构建自定义组件</a>时，相关函数如measureNode等无法对ArkTS模块内部的组件进行调用。</p></li>      </ul>     </div></div></div>    <p>以下示例代码在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-access-the-arkts-page">接入ArkTS页面</a>章节基础上引入ArkTS的Refresh组件。</p>    <p><strong>图1</strong> Refresh组件挂载文本列表</p>    <p><span><img originheight="661" originwidth="347" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114747.37340243114097859862082246945620:50001231000000:2800:4845CE6EBB1B07B8CA3AF6E4128DF894B0C451C5D7014C35F111BD6B9CC10F2E.gif" width="347" height="661"></span></p>    <ol>     <li>      <p>注册ArkTS组件创建函数给Native侧，以便Native侧调用，创建函数使用ComponentContent能力进行封装。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// MixedModule.ets</span></li><li><span class="hljs-comment">// 使用ComponentContent能力创建ArkTS组件</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeContent</span>,  <span class="hljs-title class_">UIContext</span>, <span class="hljs-title class_">RefreshModifier</span>, <span class="hljs-title class_">ComponentContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 定义Native侧和ArkTS进行交互的数据对象。</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">NativeRefreshAttribute</span> {</li><li>  <span class="hljs-attr">isRefreshing</span>: <span class="hljs-built_in">boolean</span>;</li><li>  width?: <span class="hljs-built_in">number</span>;</li><li>  height?: <span class="hljs-built_in">number</span>;</li><li>  backgroundColor?: <span class="hljs-built_in">number</span>;</li><li>  refreshOffset?: <span class="hljs-built_in">number</span>;</li><li>  pullToRefresh?: <span class="hljs-built_in">boolean</span></li><li>  onRefreshing?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>  onOffsetChange?: <span class="hljs-function">(<span class="hljs-params">offset: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义@Builder函数的入参格式。</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RefreshAttribute</span> {</li><li>  <span class="hljs-attr">isRefreshing</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-comment">// 属性设置通过Modifier优化性能</span></li><li>  modifier?: <span class="hljs-title class_">RefreshModifier</span>;</li><li>  slot?: <span class="hljs-title class_">NodeContent</span>;</li><li>  onRefreshing?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>  onOffsetChange?: <span class="hljs-function">(<span class="hljs-params">offset: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// ComponentContent封装ArkTS组件依赖全局@Builder函数，涉及复杂自定义组件场景，可以在@Builder函数中嵌套@Component自定义组件。</span></li><li><span class="hljs-comment">// @Builder函数提供入参方式，方便后续通过ComponentContent的update接口进行参数更新。</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">mixedRefresh</span>(<span class="hljs-params">attribute: RefreshAttribute</span>) {</li><li>  <span class="hljs-title class_">Refresh</span>({ <span class="hljs-attr">refreshing</span>: attribute.<span class="hljs-property">isRefreshing</span> }) {</li><li>    <span class="hljs-comment">// Refresh作为容器组件，需要使用ContentSlot机制预留子组件占位</span></li><li>    <span class="hljs-title class_">ContentSlot</span>(attribute.<span class="hljs-property">slot</span>)</li><li>  }.<span class="hljs-title function_">attributeModifier</span>(attribute.<span class="hljs-property">modifier</span>)</li><li>  .<span class="hljs-title function_">onRefreshing</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on onRefreshing"</span>);</li><li>    <span class="hljs-keyword">if</span> (attribute.<span class="hljs-property">onRefreshing</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on native onRefreshing"</span>);</li><li>      attribute.<span class="hljs-title function_">onRefreshing</span>();</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">onOffsetChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on offset change: "</span> + value);</li><li>    <span class="hljs-keyword">if</span> (attribute.<span class="hljs-property">onOffsetChange</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on native onOffsetChange"</span>);</li><li>      attribute.<span class="hljs-title function_">onOffsetChange</span>(value);</li><li>    }</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义创建函数的返回值，用于ArkTS侧和Native侧的交互。</span></li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MixedModuleResult</span> {</li><li>  <span class="hljs-comment">// 定义针对Refresh构建函数的封装对象，用于Native侧转化为ArkUI_NodeHandle对象。</span></li><li>  content?: <span class="hljs-title class_">ComponentContent</span>&lt;<span class="hljs-title class_">RefreshAttribute</span>&gt;;</li><li>  <span class="hljs-comment">// Refresh作为容器组件，需要使用ContentSlot机制挂载Native侧的子组件。</span></li><li>  childSlot?: <span class="hljs-title class_">NodeContent</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 提供创建ArkTS组件的入口函数。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createMixedRefresh</span>(<span class="hljs-params">value: NativeRefreshAttribute</span>): <span class="hljs-title class_">MixedModuleResult</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"createMixedRefresh"</span>);</li><li>  <span class="hljs-comment">// 通过AppStorage对象在Ability启动的时候保持UI上下文对象。</span></li><li>  <span class="hljs-keyword">let</span> uiContent = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"context"</span>);</li><li>  <span class="hljs-keyword">let</span> modifier = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshModifier</span>();</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">width</span>) {</li><li>    modifier.<span class="hljs-title function_">width</span>(value.<span class="hljs-property">width</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">height</span>) {</li><li>    modifier.<span class="hljs-title function_">height</span>(value.<span class="hljs-property">height</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">backgroundColor</span>) {</li><li>    modifier.<span class="hljs-title function_">backgroundColor</span>(value.<span class="hljs-property">backgroundColor</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">pullToRefresh</span>) {</li><li>    modifier.<span class="hljs-title function_">pullToRefresh</span>(value.<span class="hljs-property">pullToRefresh</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">refreshOffset</span>) {</li><li>    modifier.<span class="hljs-title function_">refreshOffset</span>(value.<span class="hljs-property">refreshOffset</span>)</li><li>  }</li><li>  <span class="hljs-comment">// 创建NodeContent插槽对象用于Refresh子组件挂载。</span></li><li>  <span class="hljs-keyword">let</span> nodeSlot = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>  <span class="hljs-comment">// 通过ComponentContent创建Refresh组件并将它封装起来。</span></li><li>  <span class="hljs-keyword">let</span> content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentContent</span>&lt;<span class="hljs-title class_">RefreshAttribute</span>&gt;(uiContent!, wrapBuilder&lt;[<span class="hljs-title class_">RefreshAttribute</span>]&gt;(mixedRefresh),</li><li>    {</li><li>      <span class="hljs-attr">isRefreshing</span>: value.<span class="hljs-property">isRefreshing</span>,</li><li>      <span class="hljs-attr">modifier</span>: modifier,</li><li>      <span class="hljs-attr">slot</span>: nodeSlot,</li><li>      <span class="hljs-attr">onRefreshing</span>: value.<span class="hljs-property">onRefreshing</span>,</li><li>      <span class="hljs-attr">onOffsetChange</span>: value.<span class="hljs-property">onOffsetChange</span></li><li>    });</li><li>  <span class="hljs-comment">// 将Refresh组件的封装对象及其子组件插槽对象传递给Native侧。</span></li><li>  <span class="hljs-keyword">return</span> { <span class="hljs-attr">content</span>: content, <span class="hljs-attr">childSlot</span>: nodeSlot };</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义Refresh组件的更新函数，用于Native侧更新。</span></li><li><span class="hljs-comment">// 在更新场景下，需要将Refresh组件的封装对象及其子组件插槽对象返回，防止组件重新创建。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateMixedRefresh</span>(<span class="hljs-params">refresh: ComponentContent&lt;RefreshAttribute&gt;, childSlot: NodeContent,</span></li><li><span class="hljs-params">  value: NativeRefreshAttribute</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> modifier = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshModifier</span>();</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">width</span>) {</li><li>    modifier.<span class="hljs-title function_">width</span>(value.<span class="hljs-property">width</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">height</span>) {</li><li>    modifier.<span class="hljs-title function_">height</span>(value.<span class="hljs-property">height</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">backgroundColor</span>) {</li><li>    modifier.<span class="hljs-title function_">backgroundColor</span>(value.<span class="hljs-property">backgroundColor</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">pullToRefresh</span>) {</li><li>    modifier.<span class="hljs-title function_">pullToRefresh</span>(value.<span class="hljs-property">pullToRefresh</span>)</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">refreshOffset</span>) {</li><li>    modifier.<span class="hljs-title function_">refreshOffset</span>(value.<span class="hljs-property">refreshOffset</span>)</li><li>  }</li><li>  <span class="hljs-comment">// 调用ComponentContent的update接口进行更新。</span></li><li>  refresh.<span class="hljs-title function_">update</span>({</li><li>    <span class="hljs-attr">isRefreshing</span>: value.<span class="hljs-property">isRefreshing</span>,</li><li>    <span class="hljs-attr">modifier</span>: modifier,</li><li>    <span class="hljs-attr">slot</span>: childSlot,</li><li>    <span class="hljs-attr">onRefreshing</span>: value.<span class="hljs-property">onRefreshing</span>,</li><li>    <span class="hljs-attr">onOffsetChange</span>: value.<span class="hljs-property">onOffsetChange</span></li><li>  })</li><li>}</li></ol></pre></div></div></li>     <li>      <p>将创建和更新函数注册给Native侧。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> nativeNode <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { createMixedRefresh, updateMixedRefresh } <span class="hljs-keyword">from</span> <span class="hljs-string">'./MixedModule'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> rootSlot = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'changeNativeFlag'</span>) <span class="hljs-attr">showNative</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 设置uiContext;</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"context"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>    <span class="hljs-comment">// 设置混合模式下的builder函数。</span></li><li>    nativeNode.<span class="hljs-title function_">registerCreateMixedRefreshNode</span>(createMixedRefresh);</li><li>    nativeNode.<span class="hljs-title function_">registerUpdateMixedRefreshNode</span>(updateMixedRefresh);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">changeNativeFlag</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">showNative</span>) {</li><li>      <span class="hljs-comment">// 创建NativeModule组件挂载</span></li><li>      nativeNode.<span class="hljs-title function_">createNativeRoot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootSlot</span>)</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 销毁NativeModule组件</span></li><li>      nativeNode.<span class="hljs-title function_">destroyNativeRoot</span>()</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">showNative</span> ? <span class="hljs-string">"HideNativeUI"</span> : <span class="hljs-string">"ShowNativeUI"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">showNative</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">showNative</span></li><li>      })</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-comment">// ArkTS插入Native组件。</span></li><li>        <span class="hljs-title class_">ContentSlot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootSlot</span>)</li><li>      }.<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// native_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedRefresh.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NativeEntry.h"</span></span></li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        <span class="hljs-comment">// 注册NDK根节点。</span></li><li>        {<span class="hljs-string">"createNativeRoot"</span>, <span class="hljs-literal">nullptr</span>, NativeModule::CreateNativeRoot, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        <span class="hljs-comment">// 注册混合模式创建方法。</span></li><li>        {<span class="hljs-string">"registerCreateMixedRefreshNode"</span>, <span class="hljs-literal">nullptr</span>, NativeModule::ArkUIMixedRefresh::RegisterCreateRefresh, <span class="hljs-literal">nullptr</span>,</li><li>         <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        <span class="hljs-comment">// 注册混合模式更新方法。</span></li><li>        {<span class="hljs-string">"registerUpdateMixedRefreshNode"</span>, <span class="hljs-literal">nullptr</span>, NativeModule::ArkUIMixedRefresh::RegisterUpdateRefresh, <span class="hljs-literal">nullptr</span>,</li><li>         <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        <span class="hljs-comment">// 销毁NDK根节点。</span></li><li>        {<span class="hljs-string">"destroyNativeRoot"</span>, <span class="hljs-literal">nullptr</span>, NativeModule::DestroyNativeRoot, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default,</li><li>         <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule); }</li></ol></pre></div></div></li>     <li>      <p>Native侧通过Node-API保存创建和更新函数，用于后续调用。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUIMixedRefresh.h</span></li><li><span class="hljs-comment">// 混合模式交互类。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedNode.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;optional&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node_napi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUIMixedRefresh</span> :</span> public ArkUIMixedNode {</li><li>public:</li><li>    <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">RegisterCreateAndUpdateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span>;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></span></li></ol></pre></div></div>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUIMixedRefresh.cpp</span></li><li><span class="hljs-comment">// 混合模式交互类。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedRefresh.h"</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> NativeModule {</li><li><span class="hljs-keyword">namespace</span> {</li><li>napi_env g_env;</li><li>napi_ref g_createRefresh;</li><li>napi_ref g_updateRefresh;</li><li>} <span class="hljs-comment">// namespace</span></li><li>
</li><li><span class="hljs-function">napi_value <span class="hljs-title">ArkUIMixedRefresh::RegisterCreateAndUpdateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    g_env = env;</li><li>    napi_ref refer;</li><li>    <span class="hljs-comment">// 创建引用之后保存，防止释放。</span></li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, &amp;refer);</li><li>
</li><li>    g_createRefresh = refer;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li></ol></pre></div></div>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>  # CMakeLists.txt</li><li>
</li><li>  <span class="hljs-meta"># the minimum version of CMake.</span></li><li>  <span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span><span class="hljs-number">.1</span>)</li><li>  <span class="hljs-built_in">project</span>(testndk)</li><li>  </li><li>  <span class="hljs-meta"># optional依赖C++17</span></li><li>  <span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)</li><li>  <span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>  </li><li>  <span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                       ${NATIVERENDER_ROOT_PATH}/include)</li><li>  </li><li>  <span class="hljs-built_in">add_library</span>(entry SHARED NativeEntry.cpp ArkUIMixedRefresh.cpp napi_init.cpp)</li><li>  # <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so, libace_ndk.z.so, libhilog_ndk.z.so)</li><li>  </li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       hilog-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       hilog_ndk.z</li><li>   )</li><li>  </li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libace-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_ndk.z</li><li>   )</li><li>  </li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libnapi-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_napi.z</li><li>   )</li><li>  </li><li>   <span class="hljs-built_in">find_library</span>(</li><li>        # Sets the name of the path variable.</li><li>        libuv-lib</li><li>        uv</li><li>    )</li><li>  </li><li>  <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC</li><li>       ${hilog-lib} ${libace-lib} ${libnapi-lib} ${libuv-lib} )</li></ol></pre></div></div></li>     <li>      <p>抽象混合模式下组件的基类，用于通用逻辑管理。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUIMixedNode.h</span></li><li><span class="hljs-comment">// 混合模式基类。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUIMIXEDNODE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUIMIXEDNODE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIBaseNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NativeModule.h"</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-comment">// Wrap ArkTS Node</span></li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUIMixedNode</span> :</span> public ArkUIBaseNode {</li><li>public:</li><li>    ArkUIMixedNode(ArkUI_NodeHandle handle, napi_env env, napi_ref componentContent)</li><li>        : ArkUIBaseNode(handle), env_(env), componentContent_(componentContent) {}</li><li>
</li><li>    <span class="hljs-comment">// 在基类析构的时候需要把混合模式在ArkTS侧的对象释放掉。</span></li><li>    ~ArkUIMixedNode() override { napi_delete_reference(env_, componentContent_); }</li><li>
</li><li>protected:</li><li>    napi_env env_;</li><li>    napi_ref componentContent_;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUIMIXEDNODE_H</span></span></li></ol></pre></div></div></li>     <li>      <p>实现Refresh组件的混合模式封装对象。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUIMixedRefresh.h</span></li><li><span class="hljs-comment">// Refresh混合模式在Native侧的封装对象。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIBaseNode.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;optional&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node_napi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-comment">// 定义Native侧和ArkTS侧的交互数据结构。</span></li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NativeRefreshAttribute</span> {</span></li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">bool</span>&gt; isRefreshing;</li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">float</span>&gt; width;</li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">float</span>&gt; height;</li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">uint32_t</span>&gt; backgroundColor;</li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">float</span>&gt; refreshOffset;</li><li>    <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-type">bool</span>&gt; pullToRefresh;</li><li>    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-type">void</span>()&gt; onRefreshing;</li><li>    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">float</span>)&gt; onOffsetChange;</li><li>};</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUIMixedRefresh</span> :</span> public ArkUIMixedNode {</li><li>public:</li><li>    <span class="hljs-comment">// 调用ArkTS的方法创建Refresh组件。</span></li><li>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIMixedRefresh&gt; <span class="hljs-title function_">Create</span><span class="hljs-params">(<span class="hljs-type">const</span> NativeRefreshAttribute &amp;attribute)</span>;</li><li>
</li><li>    ArkUIMixedRefresh(ArkUI_NodeHandle handle, ArkUI_NodeContentHandle contentHandle, napi_env env,</li><li>                      napi_ref componentContent, napi_ref nodeContent)</li><li>        : ArkUIMixedNode(handle, env, componentContent), contentHandle_(contentHandle), nodeContent_(nodeContent) {}</li><li>
</li><li>    ArkUIMixedRefresh() : ArkUIMixedNode(nullptr, nullptr, nullptr) {}</li><li>
</li><li>    ~ArkUIMixedRefresh() override { napi_delete_reference(env_, nodeContent_); } <span class="hljs-comment">// 释放子节点占位组件插槽对象。</span></li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetWidth</span><span class="hljs-params">(<span class="hljs-type">float</span> width)</span> { attribute_.width = width; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetHeight</span><span class="hljs-params">(<span class="hljs-type">float</span> height)</span> { attribute_.height = height; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetBackgroundColor</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> color)</span> { attribute_.backgroundColor = color; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetRefreshState</span><span class="hljs-params">(<span class="hljs-type">bool</span> isRefreshing)</span> { attribute_.isRefreshing = isRefreshing; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetPullToRefresh</span><span class="hljs-params">(<span class="hljs-type">bool</span> pullToRefresh)</span> { attribute_.pullToRefresh = pullToRefresh; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetRefreshOffset</span><span class="hljs-params">(<span class="hljs-type">float</span> offset)</span> { attribute_.refreshOffset = offset; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetRefreshCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-type">void</span>()&gt; &amp;callback)</span> { attribute_.onRefreshing = callback; }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetOnOffsetChange</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">float</span>)&gt; &amp;callback)</span> { attribute_.onOffsetChange = callback; }</li><li>
</li><li>    <span class="hljs-comment">// 避免频繁跨语言，在Native侧缓存属性事件，批量通知。</span></li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">FlushMixedModeCmd</span><span class="hljs-params">()</span>;</li><li>
</li><li>    <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">RegisterCreateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span>;</li><li>    <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">RegisterUpdateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span>;</li><li>
</li><li>protected:</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnAddChild</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIBaseNode&gt; &amp;child)</span> override {</li><li>        assert(contentHandle_);</li><li>        <span class="hljs-comment">// 使用NodeContent挂载组件（可以使用ArkTS在Native侧通过ComponentContent的转化对象，也可以是纯Native组件）到ArkTS组件下面。</span></li><li>        OH_ArkUI_NodeContent_AddNode(contentHandle_, child-&gt;GetHandle());</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnRemoveChild</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIBaseNode&gt; &amp;child)</span> override {</li><li>        assert(contentHandle_);</li><li>        <span class="hljs-comment">// 使用NodeContent卸载组件。</span></li><li>        OH_ArkUI_NodeContent_RemoveNode(contentHandle_, child-&gt;GetHandle());</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnInsertChild</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIBaseNode&gt; &amp;child, <span class="hljs-type">int32_t</span> index)</span> override {</li><li>        assert(contentHandle_);</li><li>        <span class="hljs-comment">// 使用NodeContent插入组件。</span></li><li>        OH_ArkUI_NodeContent_InsertNode(contentHandle_, child-&gt;GetHandle(), index);</li><li>    }</li><li>
</li><li>private:</li><li>    <span class="hljs-comment">// 使用napi接口创建ArkTS侧的数据结构。</span></li><li>    <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">CreateRefreshAttribute</span><span class="hljs-params">(<span class="hljs-type">const</span> NativeRefreshAttribute &amp;attribute, <span class="hljs-type">void</span> *userData)</span>;</li><li>
</li><li>    ArkUI_NodeContentHandle contentHandle_;</li><li>    napi_ref nodeContent_;</li><li>    NativeRefreshAttribute attribute_;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUIMIXEDREFRESH_H</span></span></li></ol></pre></div></div>      <p>相关实现类说明：</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUIMixedRefresh.cpp</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedRefresh.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>namespace {</li><li>napi_env g_env;</li><li>napi_ref g_createRefresh;</li><li>napi_ref g_updateRefresh;</li><li>} <span class="hljs-comment">// namespace</span></li><li>
</li><li><span class="hljs-comment">// 使用Napi接口创建与ArkTS侧交互的数据结构，用于Refresh组件的创建和更新。</span></li><li>napi_value <span class="hljs-title function_">ArkUIMixedRefresh::CreateRefreshAttribute</span><span class="hljs-params">(<span class="hljs-type">const</span> NativeRefreshAttribute &amp;attribute, <span class="hljs-type">void</span> *userData)</span> {</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"width"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"height"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"backgroundColor"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"pullToRefresh"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"isRefreshing"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"refreshOffset"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"onRefreshing"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>        {<span class="hljs-string">"onOffsetChange"</span>, nullptr, nullptr, nullptr, nullptr, nullptr, napi_default, userData},</li><li>    };</li><li>    <span class="hljs-keyword">if</span> (attribute.width) {</li><li>        napi_value width;</li><li>        napi_create_double(g_env, attribute.width.value(), &amp;width);</li><li>        desc[<span class="hljs-number">0</span>].value = width;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.height) {</li><li>        napi_value height;</li><li>        napi_create_double(g_env, attribute.height.value(), &amp;height);</li><li>        desc[<span class="hljs-number">1</span>].value = height;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.backgroundColor) {</li><li>        napi_value backgroundColor;</li><li>        napi_create_uint32(g_env, attribute.backgroundColor.value(), &amp;backgroundColor);</li><li>        desc[<span class="hljs-number">2</span>].value = backgroundColor;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.pullToRefresh) {</li><li>        napi_value pullToRefresh;</li><li>        napi_create_int32(g_env, attribute.pullToRefresh.value(), &amp;pullToRefresh);</li><li>        desc[<span class="hljs-number">3</span>].value = pullToRefresh;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.isRefreshing) {</li><li>        napi_value isRefreshing;</li><li>        napi_create_int32(g_env, attribute.isRefreshing.value(), &amp;isRefreshing);</li><li>        desc[<span class="hljs-number">4</span>].value = isRefreshing;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.refreshOffset) {</li><li>        napi_value refreshOffset;</li><li>        napi_create_double(g_env, attribute.refreshOffset.value(), &amp;refreshOffset);</li><li>        desc[<span class="hljs-number">5</span>].value = refreshOffset;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.onRefreshing) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"onRefreshing start"</span>);</li><li>        desc[<span class="hljs-number">6</span>].method = [](napi_env env, napi_callback_info info) -&gt; napi_value {</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"onRefreshing callback"</span>);</li><li>            <span class="hljs-type">size_t</span> argc = <span class="hljs-number">0</span>;</li><li>            napi_value args[<span class="hljs-number">0</span>];</li><li>            <span class="hljs-type">void</span> *data;</li><li>            napi_get_cb_info(env, info, &amp;argc, args, nullptr, &amp;data);</li><li>            <span class="hljs-keyword">auto</span> refresh = reinterpret_cast&lt;ArkUIMixedRefresh *&gt;(data);</li><li>            <span class="hljs-keyword">if</span> (refresh &amp;&amp; refresh-&gt;attribute_.onRefreshing) {</li><li>                refresh-&gt;attribute_.onRefreshing();</li><li>            }</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        };</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attribute.onOffsetChange) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"onOffsetChange start"</span>);</li><li>        desc[<span class="hljs-number">7</span>].method = [](napi_env env, napi_callback_info info) -&gt; napi_value {</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"onOffsetChange callback"</span>);</li><li>            <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>            napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>            <span class="hljs-type">void</span> *data;</li><li>            napi_get_cb_info(env, info, &amp;argc, args, nullptr, &amp;data);</li><li>            <span class="hljs-type">double</span> offset = <span class="hljs-number">0.0</span>;</li><li>            napi_get_value_double(env, args[<span class="hljs-number">0</span>], &amp;offset);</li><li>            <span class="hljs-keyword">auto</span> refresh = reinterpret_cast&lt;ArkUIMixedRefresh *&gt;(data);</li><li>            <span class="hljs-keyword">if</span> (refresh &amp;&amp; refresh-&gt;attribute_.onOffsetChange) {</li><li>                refresh-&gt;attribute_.onOffsetChange(offset);</li><li>            }</li><li>            <span class="hljs-keyword">return</span> nullptr;</li><li>        };</li><li>    }</li><li>    napi_value refreshAttribute = nullptr;</li><li>    <span class="hljs-keyword">auto</span> result = napi_create_object_with_properties(g_env, &amp;refreshAttribute, <span class="hljs-keyword">sizeof</span>(desc) / <span class="hljs-keyword">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">if</span> (result != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> refreshAttribute;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建ArkTS侧的组件并保存在Native侧的封装对象中。</span></li><li><span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIMixedRefresh&gt; <span class="hljs-title function_">ArkUIMixedRefresh::Create</span><span class="hljs-params">(<span class="hljs-type">const</span> NativeRefreshAttribute &amp;attribute)</span> {</li><li>    napi_handle_scope scope;</li><li>    napi_open_handle_scope(g_env, &amp;scope);</li><li>    <span class="hljs-keyword">auto</span> refresh = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUIMixedRefresh&gt;();</li><li>    <span class="hljs-keyword">auto</span> refreshAttribute = CreateRefreshAttribute(attribute, refresh.get());</li><li>    <span class="hljs-keyword">if</span> (refreshAttribute == nullptr) {</li><li>        napi_close_handle_scope(g_env, scope);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    napi_value result = nullptr;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {refreshAttribute};</li><li>    napi_value createRefresh = nullptr;</li><li>    napi_get_reference_value(g_env, g_createRefresh, &amp;createRefresh);</li><li>    <span class="hljs-comment">// 调用ArkTS的Create函数创建ArkTS的ComponentContent。</span></li><li>    napi_call_function(g_env, nullptr, createRefresh, <span class="hljs-number">1</span>, argv, &amp;result);</li><li>
</li><li>    <span class="hljs-comment">// 获取ArkTS的Refresh组件。</span></li><li>    napi_value componentContent = nullptr;</li><li>    napi_get_named_property(g_env, result, <span class="hljs-string">"content"</span>, &amp;componentContent);</li><li>    ArkUI_NodeHandle handle;</li><li>    OH_ArkUI_GetNodeHandleFromNapiValue(g_env, componentContent, &amp;handle);</li><li>    assert(handle);</li><li>    <span class="hljs-comment">// 获取ArkTS的Refresh组件的子组件插槽。</span></li><li>    napi_value nodeContent = nullptr;</li><li>    napi_get_named_property(g_env, result, <span class="hljs-string">"childSlot"</span>, &amp;nodeContent);</li><li>    ArkUI_NodeContentHandle contentHandle;</li><li>    OH_ArkUI_GetNodeContentFromNapiValue(g_env, nodeContent, &amp;contentHandle);</li><li>    assert(contentHandle);</li><li>    <span class="hljs-comment">// 保存ArkTS的ComponentContent用于防止ArkTS侧对象释放以及后续的更新。</span></li><li>    napi_ref componentContentRef;</li><li>    napi_create_reference(g_env, componentContent, <span class="hljs-number">1</span>, &amp;componentContentRef);</li><li>    <span class="hljs-comment">// 保存ArkTS的NodeContent用于防止ArkTS侧对象释放以及后续的更新。</span></li><li>    napi_ref nodeContentRef;</li><li>    napi_create_reference(g_env, nodeContent, <span class="hljs-number">1</span>, &amp;nodeContentRef);</li><li>    <span class="hljs-comment">// 更新Refresh组件相关参数。</span></li><li>    refresh-&gt;handle_ = handle;</li><li>    refresh-&gt;env_ = g_env;</li><li>    refresh-&gt;componentContent_ = componentContentRef;</li><li>    refresh-&gt;nodeContent_ = nodeContentRef;</li><li>    refresh-&gt;contentHandle_ = contentHandle;</li><li>    refresh-&gt;attribute_ = attribute;</li><li>    <span class="hljs-keyword">return</span> refresh;</li><li>}</li><li><span class="hljs-comment">// 更新函数实现。</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">ArkUIMixedRefresh::FlushMixedModeCmd</span><span class="hljs-params">()</span> {</li><li>    napi_handle_scope scope;</li><li>    napi_open_handle_scope(g_env, &amp;scope);</li><li>    <span class="hljs-comment">// 创建调用ArkTS接口入参。</span></li><li>    <span class="hljs-keyword">auto</span> refreshAttribute = CreateRefreshAttribute(attribute_, this);</li><li>    <span class="hljs-keyword">if</span> (refreshAttribute == nullptr) {</li><li>        napi_close_handle_scope(g_env, scope);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 获取更新接口的剩余两个接口参数。</span></li><li>    napi_value componentContent = nullptr;</li><li>    napi_get_reference_value(g_env, componentContent_, &amp;componentContent);</li><li>    napi_value nodeContent = nullptr;</li><li>    napi_get_reference_value(g_env, nodeContent_, &amp;nodeContent);</li><li>
</li><li>    napi_value argv[<span class="hljs-number">3</span>] = {componentContent, nodeContent, refreshAttribute};</li><li>    napi_value updateRefresh = nullptr;</li><li>    napi_get_reference_value(g_env, g_updateRefresh, &amp;updateRefresh);</li><li>    <span class="hljs-comment">// 调用ArkTS的Update函数进行更新。</span></li><li>    napi_value result = nullptr;</li><li>    napi_call_function(g_env, nullptr, updateRefresh, <span class="hljs-number">3</span>, argv, &amp;result);</li><li>}</li><li>
</li><li>napi_value <span class="hljs-title function_">ArkUIMixedRefresh::RegisterCreateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>     <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>     napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>
</li><li>     napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</li><li>
</li><li>     g_env = env;</li><li>     napi_ref refer;</li><li>     napi_create_reference(env, args[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, &amp;refer);</li><li>
</li><li>     g_createRefresh = refer;</li><li>     <span class="hljs-keyword">return</span> nullptr;</li><li> }</li><li>
</li><li>napi_value <span class="hljs-title function_">ArkUIMixedRefresh::RegisterUpdateRefresh</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</li><li>
</li><li>    g_env = env;</li><li>    napi_ref refer;</li><li>    napi_create_reference(env, args[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, &amp;refer);</li><li>
</li><li>    g_updateRefresh = refer;</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li></ol></pre></div></div></li>     <li>      <p>定时器模块相关简单实现。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// UITimer.h</span></li><li><span class="hljs-comment">// 定时器模块。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_UITIMER_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_UITIMER_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;node_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;node_api_types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">UIData</span> {</span></li><li>    <span class="hljs-type">void</span> *userData = nullptr;</li><li>    <span class="hljs-type">int32_t</span> count = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> totalCount = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> count) = nullptr;</li><li>};</li><li>
</li><li>napi_threadsafe_function threadSafeFunction = nullptr;</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">CreateNativeTimer</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> totalCount, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> count))</span> {</li><li>    napi_value name;</li><li>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> str = <span class="hljs-string">"UICallback"</span>;</li><li>    napi_create_string_utf8(env, str.c_str(), str.size(), &amp;name);</li><li>    <span class="hljs-comment">// UI主线程回调函数。</span></li><li>    napi_create_threadsafe_function(</li><li>        env, nullptr, nullptr, name, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, nullptr, nullptr, nullptr,</li><li>        [](napi_env env, napi_value value, <span class="hljs-type">void</span> *context, <span class="hljs-type">void</span> *data) {</li><li>            <span class="hljs-keyword">auto</span> userdata = reinterpret_cast&lt;UIData *&gt;(data);</li><li>            userdata-&gt;func(userdata-&gt;userData, userdata-&gt;count);</li><li>            delete userdata;</li><li>        },</li><li>        &amp;threadSafeFunction);</li><li>    <span class="hljs-comment">// 启动定时器，模拟数据变化。</span></li><li>    <span class="hljs-built_in">std</span>::thread <span class="hljs-title function_">timerThread</span><span class="hljs-params">([data = userData, totalCount, func]() {</span></li><li><span class="hljs-params">        <span class="hljs-type">uv_loop_t</span> *loop = uv_loop_new();</span></li><li><span class="hljs-params">        <span class="hljs-type">uv_timer_t</span> *timer = new <span class="hljs-type">uv_timer_t</span>();</span></li><li><span class="hljs-params">        uv_timer_init(loop, timer);</span></li><li><span class="hljs-params">        timer-&gt;data = new UIData{data, <span class="hljs-number">0</span>, totalCount, func};</span></li><li><span class="hljs-params">        uv_timer_start(</span></li><li><span class="hljs-params">            timer,</span></li><li><span class="hljs-params">            [](<span class="hljs-type">uv_timer_t</span> *handle) {</span></li><li><span class="hljs-params">                OH_LOG_INFO(LOG_APP, <span class="hljs-string">"on timeout"</span>);</span></li><li><span class="hljs-params">                napi_acquire_threadsafe_function(threadSafeFunction);</span></li><li><span class="hljs-params">                <span class="hljs-keyword">auto</span> *customData = reinterpret_cast&lt;UIData *&gt;(handle-&gt;data);</span></li><li><span class="hljs-params">                <span class="hljs-comment">// 创建回调数据。</span></span></li><li><span class="hljs-params">                <span class="hljs-keyword">auto</span> *callbackData =</span></li><li><span class="hljs-params">                    new UIData{customData-&gt;userData, customData-&gt;count, customData-&gt;totalCount, customData-&gt;func};</span></li><li><span class="hljs-params">                napi_call_threadsafe_function(threadSafeFunction, callbackData, napi_tsfn_blocking);</span></li><li><span class="hljs-params">                customData-&gt;count++;</span></li><li><span class="hljs-params">                <span class="hljs-keyword">if</span> (customData-&gt;count &gt; customData-&gt;totalCount) {</span></li><li><span class="hljs-params">                    uv_timer_stop(handle);</span></li><li><span class="hljs-params">                    delete handle;</span></li><li><span class="hljs-params">                    delete customData;</span></li><li><span class="hljs-params">                }</span></li><li><span class="hljs-params">            },</span></li><li><span class="hljs-params">            <span class="hljs-number">4000</span>, <span class="hljs-number">4000</span>);</span></li><li><span class="hljs-params">        uv_run(loop, UV_RUN_DEFAULT);</span></li><li><span class="hljs-params">        uv_loop_delete(loop);</span></li><li><span class="hljs-params">    })</span>;</li><li>    timerThread.detach();</li><li>}</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_UITIMER_H</span></span></li></ol></pre></div></div></li>     <li>      <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-access-the-arkts-page">接入ArkTS页面</a>章节的页面结构，并沿用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-embed-arkts-components">定时器模块相关简单实现</a>，将Refresh组件作为文本列表的父组件。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// MixedRefreshExample.h</span></li><li><span class="hljs-comment">// 混合模式示例代码。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_MIXEDREFRESHEXAMPLE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_MIXEDREFRESHEXAMPLE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIBaseNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedRefresh.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NormalTextListExample.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"UITimer.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIBaseNode&gt; <span class="hljs-title function_">CreateMixedRefreshList</span><span class="hljs-params">(napi_env env)</span> {</li><li>    <span class="hljs-keyword">auto</span> <span class="hljs-built_in">list</span> = CreateTextListExample();</li><li>    <span class="hljs-comment">// 混合模式创建Refresh组件并挂载List组件。</span></li><li>    NativeRefreshAttribute nativeRefreshAttribute{</li><li>        .backgroundColor = <span class="hljs-number">0xFF89CFF0</span>, .refreshOffset = <span class="hljs-number">64</span>, .pullToRefresh = <span class="hljs-literal">true</span>};</li><li>    <span class="hljs-keyword">auto</span> refresh = ArkUIMixedRefresh::Create(nativeRefreshAttribute);</li><li>    refresh-&gt;AddChild(<span class="hljs-built_in">list</span>);</li><li>
</li><li>    <span class="hljs-comment">// 设置混合模式下的事件。</span></li><li>    refresh-&gt;SetOnOffsetChange(</li><li>        [](<span class="hljs-type">float</span> offset) { OH_LOG_INFO(LOG_APP, <span class="hljs-string">"on refresh offset changed: %{public}f"</span>, offset); });</li><li>    refresh-&gt;SetRefreshCallback([refreshPtr = refresh.get(), env]() {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"on refreshing"</span>);</li><li>        <span class="hljs-comment">// 启动定时器，模拟数据获取。</span></li><li>        CreateNativeTimer(env, refreshPtr, <span class="hljs-number">1</span>, [](<span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> count) {</li><li>            <span class="hljs-comment">// 数据获取后关闭刷新。</span></li><li>            <span class="hljs-keyword">auto</span> refresh = reinterpret_cast&lt;ArkUIMixedRefresh *&gt;(userData);</li><li>            refresh-&gt;SetRefreshState(<span class="hljs-literal">false</span>);</li><li>            refresh-&gt;FlushMixedModeCmd();</li><li>        });</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 更新事件到ArkTS侧。</span></li><li>    refresh-&gt;FlushMixedModeCmd();</li><li>    <span class="hljs-keyword">return</span> refresh;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_MIXEDREFRESHEXAMPLE_H</span></span></li></ol></pre></div></div>      <p>替换入口组件创建为下拉刷新文本列表。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// NativeEntry.cpp</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NativeEntry.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIMixedRefresh.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"MixedRefreshExample.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NormalTextListExample.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node_napi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_type.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li>napi_value <span class="hljs-title function_">CreateNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</li><li>
</li><li>    <span class="hljs-comment">// 获取NodeContent</span></li><li>    ArkUI_NodeContentHandle contentHandle;</li><li>    OH_ArkUI_GetNodeContentFromNapiValue(env, args[<span class="hljs-number">0</span>], &amp;contentHandle);</li><li>    NativeEntry::GetInstance()-&gt;SetContentHandle(contentHandle);</li><li>
</li><li>    <span class="hljs-comment">// 创建Refresh文本列表</span></li><li>    <span class="hljs-keyword">auto</span> refresh = CreateMixedRefreshList(env);</li><li>
</li><li>    <span class="hljs-comment">// 保持Native侧对象到管理类中，维护生命周期。</span></li><li>    NativeEntry::GetInstance()-&gt;SetRootNode(refresh);</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>napi_value <span class="hljs-title function_">DestroyNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-comment">// 从管理类中释放Native侧对象。</span></li><li>    NativeEntry::GetInstance()-&gt;DisposeRootNode();</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li></ol></pre></div></div></li>     <li>      <p>在Native侧提供Node-API的桥接方法，实现ArkTS侧的NativeNode模块接口。</p>      <div _ngcontent-slp-c106="" class="highlight-div"><div _ngcontent-slp-c106="" class="highlight-div-header"><div _ngcontent-slp-c106="" class="highlight-div-header-left"><div _ngcontent-slp-c106="" class="handle-button expand-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-slp-c106="" class="highlight-div-header-right"><div _ngcontent-slp-c106="" class="handle-button ai-button"></div><div _ngcontent-slp-c106="" class="handle-button line-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-slp-c106="" class="handle-button theme-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-slp-c106="" class="handle-button copy-button"><div _ngcontent-slp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-slp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.d.ts</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createNativeRoot</span>: <span class="hljs-function">(<span class="hljs-params">content: <span class="hljs-built_in">Object</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">destroyNativeRoot</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerCreateMixedRefreshNode</span>: <span class="hljs-function">(<span class="hljs-params">content: <span class="hljs-built_in">Object</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerUpdateMixedRefreshNode</span>: <span class="hljs-function">(<span class="hljs-params">content: <span class="hljs-built_in">Object</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>