<h1 _ngcontent-inr-c119="" class="doc-title ng-star-inserted" title="常驻任务开发指导（Worker）"> 常驻任务开发指导（Worker） </h1>

<div _ngcontent-inr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>提供使用Worker进行常驻任务的开发指导。Worker将持续执行任务，直到宿主线程发送终止指令。</p>    <p>开发过程和示例如下：</p>    <ol>     <li>      <p>DevEco Studio支持一键生成Worker，在对应的{moduleName}目录下任意位置，单击鼠标右键 &gt; New &gt; Worker，即可自动生成Worker的模板文件及配置信息。本文以创建“Worker”为例。</p>      <p>此外，还支持手动创建Worker文件。具体方式和注意事项请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction#创建worker的注意事项">创建Worker的注意事项</a>。</p></li>     <li>      <p>首先导入Worker模块，然后在宿主线程中通过调用ThreadWorker的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-worker#constructor9" target="_blank">constructor()</a>方法创建Worker对象，创建Worker对象的线程为宿主线程。 此处的宿主线程为UI主线程，宿主线程发送'start'以开始执行某个长期运行的任务，并接收子线程返回的相关消息。当不需要执行该任务时，发送'stop'以停止该任务的执行。在此示例中，任务将在10秒后结束。</p>      <div _ngcontent-inr-c106="" class="highlight-div"><div _ngcontent-inr-c106="" class="highlight-div-header"><div _ngcontent-inr-c106="" class="highlight-div-header-left"><div _ngcontent-inr-c106="" class="handle-button expand-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-inr-c106="" class="highlight-div-header-right"><div _ngcontent-inr-c106="" class="handle-button ai-button"></div><div _ngcontent-inr-c106="" class="handle-button line-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-inr-c106="" class="handle-button theme-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-inr-c106="" class="handle-button copy-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-inr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessageEvents</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Listener task"</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">workerInstance</span>: worker.<span class="hljs-property">ThreadWorker</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/Worker.ets'</span>);</li><li>          workerInstance.<span class="hljs-title function_">postMessage</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'start'</span>})</li><li>          workerInstance.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event: MessageEvents</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'UI主线程收到消息:'</span>, event.<span class="hljs-property">data</span>);</li><li>          }</li><li>          <span class="hljs-comment">// 10秒后停止worker</span></li><li>          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            workerInstance.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'stop'</span> });</li><li>          }, <span class="hljs-number">10000</span>);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     <li>      <p>在Worker线程中，当接收到宿主线程发送的消息为'start'时，开始执行某个长时间不定期运行的任务，并实时向宿主线程返回消息。当接收到的消息为'stop'时，结束该任务的执行并返回相应的消息给宿主线程。</p>      <div _ngcontent-inr-c106="" class="highlight-div"><div _ngcontent-inr-c106="" class="highlight-div-header"><div _ngcontent-inr-c106="" class="highlight-div-header-left"><div _ngcontent-inr-c106="" class="handle-button expand-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-inr-c106="" class="highlight-div-header-right"><div _ngcontent-inr-c106="" class="handle-button ai-button"></div><div _ngcontent-inr-c106="" class="handle-button line-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-inr-c106="" class="handle-button theme-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-inr-c106="" class="handle-button copy-button"><div _ngcontent-inr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-inr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Worker.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessageEvents</span>, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li><span class="hljs-keyword">let</span> isRunning = <span class="hljs-literal">false</span>;</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'start'</span>) {</li><li>    <span class="hljs-keyword">if</span> (!isRunning) {</li><li>      isRunning = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-comment">// 开始常驻任务</span></li><li>      <span class="hljs-title function_">performTask</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'stop'</span>) {</li><li>    isRunning = <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 模拟常驻任务</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">performTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (isRunning) {</li><li>    <span class="hljs-comment">// 模拟某个长期运行的任务</span></li><li>    workerPort.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Worker is performing a task'</span>);</li><li>    <span class="hljs-comment">// 1秒后再次执行任务</span></li><li>    <span class="hljs-built_in">setTimeout</span>(performTask, <span class="hljs-number">1000</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    workerPort.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Worker has stopped performing the task'</span>);</li><li>    workerPort.<span class="hljs-title function_">close</span>();</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>   </div>   <div></div></div>