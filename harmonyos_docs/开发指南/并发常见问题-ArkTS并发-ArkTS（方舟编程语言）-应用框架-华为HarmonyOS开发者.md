<h1 _ngcontent-tpe-c119="" class="doc-title ng-star-inserted" title="并发常见问题"> 并发常见问题 </h1>

<div _ngcontent-tpe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="taskpool任务不执行快速定位指导">TaskPool任务不执行快速定位指导<i class="anchor-icon anchor-icon-link" anchorid="taskpool任务不执行快速定位指导" tips="复制节点链接"></i></h2>          <p>开发者发现TaskPool任务不执行时，可按照以下步骤快速定位。</p>     <ol>      <li>       <p><strong>taskpool.execute接口是否调用</strong>。</p>       <p>taskpool.execute被调用时，Hilog会打印TaskPool调用态日志（Task Allocation: taskId:）。</p>       <p>如果发现没有该维测日志表明taskpool.execute实际未调用，应用需排查taskpool.execute之前的其他业务逻辑是否执行完成。</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">let</span> sum = a + b;</li><li>  <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test start"</span>);</li><li>            <span class="hljs-comment">// 其他业务逻辑</span></li><li>            <span class="hljs-comment">// ...</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>            taskpool.<span class="hljs-title function_">execute</span>(task);</li><li>            <span class="hljs-comment">// ...</span></li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 如果test start在控制台打印，但是并未出现Task Allocation: taskId:的日志，则taskpool.execute没有执行，应用需要排查其他业务逻辑。</span></li></ol></pre></div></div></li>      <li>       <p><strong>TaskPool任务是否被执行</strong>。</p>       <p>调用taskpool.execute接口会打印TaskPool<strong>调用态日志</strong>（Task Allocation: taskId:）。</p>       <p>定位到目标任务对应的Task Allocation: taskId:日志后，在日志中搜索taskId后跟随的Id号，正常情况会打印<strong>执行态日志</strong>（Task Perform: name:）和<strong>结束态日志</strong>（Task PerformTask End: taskId:）。</p>       <ol>        <li>         <p>如果只有调用态日志，没有执行态日志。可能是由于先执行的TaskPool任务阻塞了TaskPool工作线程，导致TaskPool工作线程不可用，后执行的TaskPool任务无法执行。应用可以排查自身业务逻辑，或者通过trace进一步定位。</p></li>        <li>         <p>如果只有调用态日志和执行态日志，没有结束态日志。应用优先分析自定义的TaskPool任务内的业务逻辑是否存在阻塞操作。</p></li>        <li>         <p>如果调用态日志和执行态日志时间间隔较久，且应用关注任务的执行时机，可以按照以下步骤继续分析。</p>         <ol class="substepthirdol">          <li>           <p>查看是否发生大量TaskPool任务堆积未执行的情况。如果在较短时间内执行大量任务（出现大量调用态日志），后执行的任务需要等待前置任务执行完。此时可以检查TaskPool的扩容情况，如果在调用态日志打印之前，TaskPool工作线程数量已扩容到接近上限（上限数量为日志片段log2中的maxThreads字段），则可能是短时间内任务数量太多导致，应用可以通过合理设置优先级将重要任务和有时效要求的任务优先执行。</p></li>          <li>           <p>查看前置执行的TaskPool任务是否本身耗时较长或者发生阻塞。如果前置任务本身耗时较长，应用可以通过合理设置优先级解决。如果前置任务发生了意料之外的阻塞（一段时间后阻塞解除），应用需要排查自身业务逻辑。</p></li>         </ol></li>       </ol>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hilog 日志片段（模拟），格式如下，具体数值由应用运行时决定</span></li><li><span class="hljs-comment">// log1： 大量任务提交</span></li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Allocation</span>: <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>: , <span class="hljs-attr">executeState</span>:</li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Allocation</span>: <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>: , <span class="hljs-attr">executeState</span>:</li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Allocation</span>: <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>: , <span class="hljs-attr">executeState</span>:</li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Allocation</span>: <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>: , <span class="hljs-attr">executeState</span>:</li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Allocation</span>: <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>: , <span class="hljs-attr">executeState</span>:</li><li>...</li><li><span class="hljs-comment">// log2: 扩容日志</span></li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-attr">maxThreads</span>: , created <span class="hljs-attr">num</span>: , total <span class="hljs-attr">num</span>:</li><li><span class="hljs-comment">// log3: 执行态日志</span></li><li><span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Perform</span>: <span class="hljs-attr">name</span>: , <span class="hljs-attr">taskId</span>: , <span class="hljs-attr">priority</span>:</li></ol></pre></div></div></li>      <li>       <p><strong>TaskPool任务执行时是否发生异常</strong>。</p>       <ol>        <li>         <p>如果在执行TaskPool任务过程中发生JS异常，TaskPool会捕获该JS异常并通过taskpool.execute().catch((e:Error)=&gt;{})将异常信息返回，应用需要查看异常信息并修复。</p>         <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> sum = a + b;</li><li>  <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test start"</span>);</li><li>            <span class="hljs-comment">// 其他业务逻辑</span></li><li>            <span class="hljs-comment">// ...</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>            taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">object</span></span>)=&gt;</span>{</li><li>              <span class="hljs-comment">// 任务执行完处理结果</span></li><li>              <span class="hljs-comment">// ...</span></li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>)=&gt;</span>{</li><li>              <span class="hljs-comment">// 任务发生异常后处理异常</span></li><li>              <span class="hljs-comment">// ...</span></li><li>            })</li><li>            <span class="hljs-comment">// ...</span></li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>        <li>         <p>如果.catch分支无异常信息返回，但是应用通过TaskPool任务实现的功能发生问题，应用需要查看TaskPool任务逻辑是否发生阻塞，导致功能异常。</p></li>       </ol></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="taskpool任务执行慢排查思路">TaskPool任务执行慢排查思路<i class="anchor-icon anchor-icon-link" anchorid="taskpool任务执行慢排查思路" tips="复制节点链接"></i></h2>          <p>开发者发现TaskPool任务的调用态日志（如taskpool::add taskId:或者taskpool::Task Allocation: taskId:）与执行态日志（taskpool::Task Perform: name:）间隔时间较长时，可参考该排查指导进行问题定位。</p>    </div>    <div class="tiledSection">     <h3 id="排查方向出问题的taskpool任务优先级较低应用后续新增较多优先级更高的taskpool任务导致原有低优先级的taskpool任务执行延后" class="firsth2">排查方向：出问题的TaskPool任务优先级较低，应用后续新增较多优先级更高的TaskPool任务，导致原有低优先级的TaskPool任务执行延后<i class="anchor-icon anchor-icon-link" anchorid="排查方向出问题的taskpool任务优先级较低应用后续新增较多优先级更高的taskpool任务导致原有低优先级的taskpool任务执行延后" tips="复制节点链接"></i></h3>          <p><strong>场景示例一</strong></p>     <p>某应用创建了低优先级的TaskPool任务，且其他业务场景依赖这个任务执行。后续，应用又创建了很多中优先级任务，导致原有的低优先级任务执行时机延后，其他业务场景未按计划时间点完成任务。</p>     <p><strong>解决方案</strong></p>     <p>对完成执行时间点有要求的任务以低优先级执行不是好的选择，应用需要根据业务场景设置合理的任务优先级，且合理搭配任务优先级。</p>     <p><strong>场景示例二</strong></p>     <p>应用对某个TaskPool任务（简称taskA）执行时间有要求，执行超过5s时有检测机制。应用将taskA设置为MEDIUM优先级，在taskA前以MEDIUM优先级执行了较多其他任务，且这些任务耗时3s/5s不等，将已有线程和新扩容的线程均占满，导致taskA从taskpool.execute到执行结束超过5s。</p>     <p><strong>解决方案</strong></p>     <p>1.分析其他任务执行耗时3s/5s是否合理；2.调整taskA优先级。</p>    </div>    <div class="tiledSection">     <h3 id="排查方向晚执行的taskpool任务是串行任务或者依赖其他任务">排查方向：晚执行的TaskPool任务是串行任务或者依赖其他任务<i class="anchor-icon anchor-icon-link" anchorid="排查方向晚执行的taskpool任务是串行任务或者依赖其他任务" tips="复制节点链接"></i></h3>          <p><strong>场景示例</strong></p>     <p>如果问题场景对应的TaskPool任务是串行队列任务，查看该串行队列内前面任务的执行情况。如日志片段1所示该串行队列有四个任务，问题场景对应的是第四个任务，查看日志片段2发现第二个任务执行了2s，对于应用业务逻辑是不正常的。</p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// hilog 日志片段1（模拟）</span></li><li><span class="hljs-comment">// seqRunner共有四个任务</span></li><li><span class="hljs-attr">taskpool</span>:: taskId <span class="hljs-number">389508780288</span> <span class="hljs-keyword">in</span> seqRunner <span class="hljs-number">393913878464</span> immediately.</li><li><span class="hljs-attr">taskpool</span>:: add <span class="hljs-attr">taskId</span>: <span class="hljs-number">394062838784</span> to seqRunner <span class="hljs-number">393913878464</span></li><li><span class="hljs-attr">taskpool</span>:: add <span class="hljs-attr">taskId</span>: <span class="hljs-number">393918679936</span> to seqRunner <span class="hljs-number">393913878464</span></li><li><span class="hljs-attr">taskpool</span>:: add <span class="hljs-attr">taskId</span>: <span class="hljs-number">393918673408</span> to seqRunner <span class="hljs-number">393913878464</span></li><li>
</li><li><span class="hljs-comment">// hilog 日志片段2（模拟）</span></li><li><span class="hljs-comment">// 查看第二个任务, 发现任务执行到执行结束间隔2s</span></li><li><span class="hljs-number">18</span>:<span class="hljs-number">28</span>:<span class="hljs-number">28.223</span> <span class="hljs-attr">taskpool</span>:: taskId <span class="hljs-number">394062838784</span> <span class="hljs-keyword">in</span> seqRunner <span class="hljs-number">393913878464</span> immediately.</li><li><span class="hljs-number">18</span>:<span class="hljs-number">28</span>:<span class="hljs-number">28.224</span> <span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Perform</span>: name : , taskId : <span class="hljs-number">394062838784</span>, priority : <span class="hljs-number">0</span></li><li><span class="hljs-number">18</span>:<span class="hljs-number">28</span>:<span class="hljs-number">30.243</span> <span class="hljs-attr">taskpool</span>:: <span class="hljs-title class_">Task</span> <span class="hljs-title class_">Perform</span> <span class="hljs-title class_">End</span>: taskId : <span class="hljs-number">394062838784</span>, performResult : <span class="hljs-title class_">Successful</span></li></ol></pre></div></div>     <p><strong>解决方案</strong></p>     <p>应用继续分析第二个任务中的业务逻辑是否存在耗时操作。</p>    </div>    <div class="tiledSection">     <h3 id="排查方向concurrent标记的方法所在的ets文件里import过多模块">排查方向：@Concurrent标记的方法所在的ets文件里import过多模块<i class="anchor-icon anchor-icon-link" anchorid="排查方向concurrent标记的方法所在的ets文件里import过多模块" tips="复制节点链接"></i></h3>          <p><strong>场景示例</strong></p>     <p>TaskPool第一次执行任务慢，间隔几百毫秒，原因是子线程反序列化之前，会将@Concurrent标记的方法所在的ets文件import的所有模块都初始化，导致出现任务调度慢的情况。应用可通过trace进一步定位，如果反序列化成功前有许多init module的trace，应用自行排查ets文件是否import过多模块。</p>     <p><strong>解决方案</strong></p>     <p>1.可拆分@Concurrent方法到单独的ets文件，减少模块初始化时间；2.使用延迟加载（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-lazy-import">lazy import</a>）。</p>    </div>    <div class="tiledSection">     <h2 id="taskpool序列化失败问题定位指导">TaskPool序列化失败问题定位指导<i class="anchor-icon anchor-icon-link" anchorid="taskpool序列化失败问题定位指导" tips="复制节点链接"></i></h2>          <p><strong>问题现象</strong></p>     <ol>      <li>       <p>JS异常</p>       <p>入参序列化失败</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// API version 20之前版本</span></li><li><span class="hljs-title class_">Error</span> <span class="hljs-attr">message</span>:<span class="hljs-title class_">An</span> exception occurred during serialization, <span class="hljs-attr">taskpool</span>: failed to serialize <span class="hljs-variable language_">arguments</span>.</li><li>
</li><li><span class="hljs-comment">// API version 20及之后版本</span></li><li><span class="hljs-title class_">Error</span> <span class="hljs-attr">message</span>:<span class="hljs-title class_">An</span> exception occurred during serialization, <span class="hljs-attr">taskpool</span>: failed to serialize <span class="hljs-variable language_">arguments</span>.</li><li><span class="hljs-title class_">Serialize</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">Serialize</span> don<span class="hljs-string">'t support object type:</span></li></ol></pre></div></div>       <p>返回结果序列化失败</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// API version 20之前版本</span></li><li><span class="hljs-title class_">Error</span> <span class="hljs-attr">message</span>:<span class="hljs-title class_">An</span> exception occurred during serialization, <span class="hljs-attr">taskpool</span>: failed to serialize result.</li><li>
</li><li><span class="hljs-comment">// API version 20及之后版本</span></li><li><span class="hljs-title class_">Error</span> <span class="hljs-attr">message</span>:<span class="hljs-title class_">An</span> exception occurred during serialization, <span class="hljs-attr">taskpool</span>: failed to serialize result.</li><li><span class="hljs-title class_">Serialize</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">Serialize</span> don<span class="hljs-string">'t support object type:</span></li></ol></pre></div></div></li>      <li>       <p>Hilog错误日志</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// API version 20之前版本</span></li><li>[ecmascript] <span class="hljs-title class_">Unsupport</span> serialize <span class="hljs-built_in">object</span> <span class="hljs-attr">type</span>:</li><li>[ecmascript] <span class="hljs-title class_">ValueSerialize</span>: serialize data is incomplete</li><li>
</li><li><span class="hljs-comment">// API version 20及之后版本</span></li><li>[ecmascript] <span class="hljs-title class_">Serialize</span> don<span class="hljs-string">'t support object type:</span></li><li><span class="hljs-string">[ecmascript] ValueSerialize: serialize data is incomplete</span></li></ol></pre></div></div></li>     </ol>     <p><strong>问题原因</strong></p>     <p>TaskPool实现任务的函数（Concurrent函数）入参和返回结果需满足线程间通信支持的对象类型，详情请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#序列化支持类型" target="_blank">线程间通信对象</a>。当Concurrent函数的入参或返回结果是线程间通信不支持的对象类型时，会出现上述现象。应用可以结合Hilog日志中打印的对象类型进一步排查通信对象是否符合要求。</p>     <p><strong>场景示例</strong></p>     <ol>      <li>       <p>应用在启动TaskPool任务时，在Concurrent函数中传入线程间通信不支持的对象类型，导致抛出入参序列化失败异常。</p>       <p><strong>解决方案</strong>：应用需要查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#序列化支持类型" target="_blank">线程间通信对象</a>排查Concurrent函数入参。</p></li>      <li>       <p>应用在启动TaskPool任务时，抛出入参序列化失败异常，同时Hilog打印错误日志Unsupport serialize object type: Proxy（API version 20及之后版本打印错误日志：Serialize error: Serialize don't support object type: Proxy）。基于错误日志可知应用在Concurrent函数中传入代理对象，排查代码发现入参使用了@State装饰器，导致原对象实际上变为Proxy代理对象，代理对象不属于线程间通信支持的对象类型。</p>       <p><strong>解决方案</strong>：TaskPool不支持@State、@Prop等装饰器修饰的复杂类型，具体内容可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction#taskpool注意事项">TaskPool注意事项</a>。应用需要去掉@State装饰器。</p></li>      <li>       <p>应用执行TaskPool任务时，抛出返回结果序列化失败异常，排查代码发现Concurrent函数返回结果是不支持的序列化类型。</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// utils.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printArgs</span>(<span class="hljs-params">args: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">return</span> args;</li><li>}</li><li>
</li><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> { printArgs} <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> sum = a + b;</li><li>  <span class="hljs-comment">// task1: 不支持的序列化类型</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task1</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(printArgs, sum);</li><li>  <span class="hljs-keyword">return</span> task1;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// task</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 打印“返回结果序列化失败”异常信息</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"execute task failed "</span> + e.<span class="hljs-property">message</span>);</li><li>  })</li><li>}</li></ol></pre></div></div>       <p><strong>解决方案</strong>：task1在.then中创建执行，Concurrent函数的返回结果设置为可序列化的类型。</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// utils.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printArgs</span>(<span class="hljs-params">args: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">return</span> args;</li><li>}</li><li>
</li><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> { printArgs} <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-comment">// 支持的序列化类型</span></li><li>  <span class="hljs-keyword">let</span> sum = a + b;</li><li>  <span class="hljs-keyword">return</span> sum;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// task</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// task1</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">task1</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(printArgs, res);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"execute task failed "</span> + e.<span class="hljs-property">message</span>);</li><li>  })</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="sendable类a的实例对象a传递到子线程后使用a-instanceof-a判断返回false">Sendable类A的实例对象a传递到子线程后，使用a instanceof A判断返回false<i class="anchor-icon anchor-icon-link" anchorid="sendable类a的实例对象a传递到子线程后使用a-instanceof-a判断返回false" tips="复制节点链接"></i></h2>          <p>应用在子线程使用instanceof接口时，需要在导出Sendable类A的ets文件使用"use shared"指令标记该模块为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable-module">共享模块</a>。</p>     <p><strong>代码示例</strong></p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/index.ets</span></li><li><span class="hljs-keyword">import</span> { worker, <span class="hljs-title class_">ErrorEvent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { A } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendable'</span></li><li><span class="hljs-keyword">const</span> workerInstance = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'../workers/Worker.ets'</span>);</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testInstanceof</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();</li><li>  <span class="hljs-keyword">if</span> (a <span class="hljs-keyword">instanceof</span> A) {</li><li>    <span class="hljs-comment">// 打印test instanceof in main thread success</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test instanceof in main thread success"</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test instanceof in main thread failed"</span>);</li><li>  }</li><li>  workerInstance.<span class="hljs-title function_">postMessageWithSharedSendable</span>(a);</li><li>  workerInstance.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err: ErrorEvent</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"worker err :"</span> + err.<span class="hljs-property">message</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">testInstanceof</span>()</li></ol></pre></div></div>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/sendable.ets</span></li><li><span class="hljs-string">"use shared"</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"name"</span>;</li><li>    <span class="hljs-title function_">printName</span>(): <span class="hljs-built_in">string</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// workers/Worker.ets</span></li><li><span class="hljs-keyword">import</span> { A } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/sendable'</span></li><li><span class="hljs-keyword">import</span> { worker, <span class="hljs-title class_">ThreadWorkerGlobalScope</span>, <span class="hljs-title class_">MessageEvents</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">workerPort</span>: <span class="hljs-title class_">ThreadWorkerGlobalScope</span> = worker.<span class="hljs-property">workerPort</span>;</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e: MessageEvents</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> a : A = e.<span class="hljs-property">data</span> <span class="hljs-keyword">as</span> A;</li><li>    <span class="hljs-keyword">if</span> (a <span class="hljs-keyword">instanceof</span> A) {</li><li>        <span class="hljs-comment">// 打印test instanceof in worker thread success</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test instanceof in worker thread success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"test instanceof in worker thread failed"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="使用sendable特性抛js异常排查指导">使用Sendable特性抛JS异常排查指导<i class="anchor-icon anchor-icon-link" anchorid="使用sendable特性抛js异常排查指导" tips="复制节点链接"></i></h2>          <p>由于Sendable特性存在固定布局、Sendable无法持有非Sendable等规格限制，开发者在进行Sendable改造时可能触发相关约束，导致抛出相应的JS异常。应用可参考以下内容进行代码排查。</p>    </div>    <div class="tiledSection">     <h3 id="属性类型不一致异常" class="firsth2">属性类型不一致异常<i class="anchor-icon anchor-icon-link" anchorid="属性类型不一致异常" tips="复制节点链接"></i></h3>          <p><strong>问题现象</strong></p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JS</span>异常：<span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Cannot</span> set sendable property <span class="hljs-keyword">with</span> mismatched <span class="hljs-keyword">type</span></li></ol></pre></div></div>     <p><strong>问题原因与解决方案</strong></p>     <p>由于ArkTS运行时在属性赋值时会严格进行类型一致性校验，如果定义的属性类型与传入的对象类型不一致，会抛出上述JS异常。应用需要基于JS异常栈信息，定位排查相应的业务逻辑。</p>     <p><strong>场景示例</strong></p>     <ol>      <li>       <p>应用在向子线程传递Sendable类A的实例对象时，抛出类型不一致异常。基于JS栈定位到问题发生在创建类A的实例对象时，排查后发现应用当前模块与其他模块联调时，其他模块未使用Sendable类B封装数据集。</p>       <p><strong>解决方案</strong> ： 应用当前模块将其他模块传递的数据使用Sendable类重新封装。</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {}</li><li>}</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">b: B</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span> = b;</li><li>  }</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">b</span>: B | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>应用查看JS异常栈发现运行this.g = g赋值语句时，抛出类型不一致异常。排查代码后发现属性g使用了@State装饰器，导致原对象变为Proxy代理对象，造成定义类型与传入类型不一致。</p>       <p><strong>解决方案</strong>：去掉@State装饰器</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="新增属性异常">新增属性异常<i class="anchor-icon anchor-icon-link" anchorid="新增属性异常" tips="复制节点链接"></i></h3>          <p><strong>问题现象</strong></p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable constant_">JS</span>异常：<span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Cannot</span> add property <span class="hljs-keyword">in</span> prevent extensions</li></ol></pre></div></div>     <p><strong>问题原因与解决方案</strong></p>     <p>由于Sendable类的布局固定，不允许增删属性，对Sendable对象新增属性时会抛出上述JS异常。应用需要基于JS异常栈定位到对应的ts文件代码行，排查相应的业务逻辑。</p>     <p><strong>异常场景示例</strong></p>     <ol>      <li>       <p>应用基于业务需要在同一个ets文件定义了同名的Sendable类和namespace，抛出新增属性异常。由于ts会合并同名的class和namespace，将namespace中的导出的内容附加到同名类上，实际上是对Sendable类新增属性，导致抛出上述异常。</p>       <p><strong>解决方案</strong>：规格限制，暂不支持合并同名Sendable class和namespace。</p></li>      <li>       <p>应用在HAR中使用Sendable特性时，抛出新增属性异常。查看JS异常栈，发现异常代码行定位在js文件，而Sendable特性不支持在js文件中使用，导致抛出非预期的异常。</p>       <p><strong>解决方案</strong>：在HAR中使用Sendable特性时，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/har-package#编译生成ts文件">配置tsHAR</a>。</p></li>      <li>       <p>应用在Local Test单元测试或预览器中使用Sendable特性时，抛出新增属性异常。由于Sendable特性暂不支持在Local Test和预览器中使用，导致抛出非预期的异常。</p>       <p><strong>解决方案</strong>：规格限制，暂不支持。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="arkts提供的promise能力的原理是什么">ArkTS提供的Promise能力的原理是什么<i class="anchor-icon anchor-icon-link" anchorid="arkts提供的promise能力的原理是什么" tips="复制节点链接"></i></h2>          <p>Promise是ArkTS提供的异步并发能力，是标准的JS语法。详情请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/async-concurrency-overview#promise">Promise</a>概述。</p>    </div>    <div class="tiledSection">     <h2 id="taskpool线程是否可以执行不需要concurrent和sendable修饰的js闭包函数">TaskPool线程是否可以执行不需要@Concurrent和@Sendable修饰的JS闭包函数<i class="anchor-icon anchor-icon-link" anchorid="taskpool线程是否可以执行不需要concurrent和sendable修饰的js闭包函数" tips="复制节点链接"></i></h2>          <p>TaskPool执行的任务函数必须使用@Concurrent装饰器修饰，由于Concurrent函数不能访问闭包，因此函数内不可调用当前文件的其他普通函数，详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction#taskpool注意事项">TaskPool注意事项</a>。但是，开发者可以通过给Concurrent函数传参的方式，传入@Sendable装饰器修饰的普通function和Async function，在Concurrent函数内调用Sendable function。</p>     <p>因此，TaskPool线程目前不支持执行普通的JS闭包函数。如果有相关诉求，开发者可以根据业务需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction">Worker</a>并发能力进行业务改造。</p>    </div>    <div class="tiledSection">     <h2 id="taskpool任务执行后的结果如何保存到自定义的数据结构">TaskPool任务执行后的结果如何保存到自定义的数据结构<i class="anchor-icon anchor-icon-link" anchorid="taskpool任务执行后的结果如何保存到自定义的数据结构" tips="复制节点链接"></i></h2>          <p><strong>问题描述</strong></p>     <p>TaskPool的任务执行函数Concurrent函数只能使用局部变量和函数入参，TaskPool任务执行后的结果应该如何保存到自定义的数据结构。</p>     <p><strong>解决方案</strong></p>     <ol>      <li>       <p>自定义Sendable类。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable">Sendable对象</a>可以在不同的子线程中共享，开发者可以将任务执行后的结果保存到Sendable对象上。</p></li>      <li>       <p>TaskPool任务执行后的结果可以在.then中返回，需要保存的数据如果仅在当前线程使用，可以在.then中将执行结果保存到自定义的数据结构中。</p>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sendable.ets，与Index.ets在同级目录下</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">testClass</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"test"</span>;</li><li>  <span class="hljs-title function_">setName</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>  }</li><li>  <span class="hljs-title function_">getName</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>       <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> { testClass } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendable'</span></li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-string">`test<span class="hljs-subst">${a}</span>`</span>;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">testObject</span>: testClass = <span class="hljs-keyword">new</span> <span class="hljs-title function_">testClass</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask, <span class="hljs-number">1</span>)</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>    testObject.<span class="hljs-title function_">setName</span>(res <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'execute task success, name is '</span> + testObject.<span class="hljs-title function_">getName</span>());</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'execute task error: '</span> + e.<span class="hljs-property">message</span>);</li><li>  })</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="sendable类在子线程无法加载">Sendable类在子线程无法加载<i class="anchor-icon anchor-icon-link" anchorid="sendable类在子线程无法加载" tips="复制节点链接"></i></h2>          <p><strong>问题描述</strong></p>     <p>Sendable装饰器修饰的类与Observed装饰器修饰的类定义在同一个ets文件中，在TaskPool子线程加载Sendable类时捕获到错误信息：SendableItem is not initialized。</p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets: 在Index页面新增以下代码</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendable'</span></li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableItem</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'execute task success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'execute task error: '</span> + e.<span class="hljs-property">message</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-title function_">executeTask</span>();</li></ol></pre></div></div>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sendable.ets</span></li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NormalItem</span> {</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableItem</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>}</li></ol></pre></div></div>     <p><strong>根因分析</strong></p>     <p>Observed装饰器仅支持在UI线程使用，不能在子线程、Worker、TaskPool中直接或者间接使用，否则会导致应用功能失效甚至crash。由于sendable.ets文件中定义了Observed装饰器修饰的类，即使该类没有被显式调用也可能被解析执行，当解析到Observed这类UI装饰器时则抛出异常：Observed is not defined，导致当前文件中的其他模块的解析被中断。在TaskPool子线程加载Sendable类时抛出异常：SendableItem is not initialized。</p>     <p><strong>解决方案</strong></p>     <p>将Observed装饰器修饰的类NormalItem剥离到单独的ets文件后，TaskPool子线程再去加载Sendable类SendableItem，应用运行符合预期。</p>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets: 在Index页面新增以下代码</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SendableItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendable'</span></li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendableItem</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(createTask);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'execute task success'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'execute task error: '</span> + e.<span class="hljs-property">message</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-title function_">executeTask</span>();</li></ol></pre></div></div>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// sendable.ets</span></li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendableItem</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-tpe-c106="" class="highlight-div"><div _ngcontent-tpe-c106="" class="highlight-div-header"><div _ngcontent-tpe-c106="" class="highlight-div-header-left"><div _ngcontent-tpe-c106="" class="handle-button expand-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tpe-c106="" class="highlight-div-header-right"><div _ngcontent-tpe-c106="" class="handle-button ai-button"></div><div _ngcontent-tpe-c106="" class="handle-button line-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tpe-c106="" class="handle-button theme-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tpe-c106="" class="handle-button copy-button"><div _ngcontent-tpe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tpe-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ui.ets</span></li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NormalItem</span> {</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>