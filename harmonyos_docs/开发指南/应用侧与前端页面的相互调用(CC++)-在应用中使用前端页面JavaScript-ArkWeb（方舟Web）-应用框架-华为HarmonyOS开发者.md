<h1 _ngcontent-hcj-c119="" class="doc-title ng-star-inserted" title="应用侧与前端页面的相互调用(C/C++)"> 应用侧与前端页面的相互调用(C/C++) </h1>

<div _ngcontent-hcj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本指导适用于ArkWeb应用侧与前端网页通信场景，开发者可根据应用架构选择使用ArkWeb Native接口完成业务通信机制（以下简称Native JSBridge）。</p>    <p>针对JSBridge进行性能优化可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-web-develop-optimization#section58781855115017" target="_blank">JSBridge优化解决方案</a></p>    <div class="tiledSection">     <h2 id="适用的应用架构">适用的应用架构<i class="anchor-icon anchor-icon-link" anchorid="适用的应用架构" tips="复制节点链接"></i></h2>          <p>应用使用ArkTS、C++语言混合开发，或本身应用架构较贴近于小程序架构，自带C++侧环境，推荐使用ArkWeb在Native侧提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>实现JSBridge功能。</p>     <p><span><img originheight="409" originwidth="576" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114738.20826495940265334030292766629422:50001231000000:2800:7714080E5A76E7419FCB6B9080F89E1A4539917362270C0C90CF891007505249.png" width="576" height="409"></span></p>     <p>上图展示了具有普遍适用性的小程序的通用架构。在这一架构中，逻辑层依赖于应用程序自带的JavaScript运行时，该运行时在一个已有的C++环境中运行。通过Native接口，逻辑层能够直接在C++环境中与视图层（其中ArkWeb充当渲染器）进行通信，无需回退至ArkTS环境使用ArkTS JSBridge接口。</p>     <p>左图是使用ArkTS JSBridge接口构建小程序的方案，如红框所示，应用需要先调用到ArkTS环境，再调用到C++环境。右图是使用Native JSBridge接口构建小程序的方案，不需要ArkTS环境和C++环境的切换，执行效率更高。</p>     <p><span><img originheight="379" originwidth="1214" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114738.60057680059441537589860789810748:50001231000000:2800:CEAF2A117261AD7031E9C319C65E9F5EF141EEB3DEF3A6F3A5CE995DB247DD83.png" width="920" height="287.2158154859967"></span></p>     <p>Native JSBridge方案解决了ArkTS环境的冗余切换，同时允许回调在非UI线程上运行，避免造成UI阻塞。</p>    </div>    <div class="tiledSection">     <h2 id="使用native接口实现jsbridge通信推荐">使用Native接口实现JSBridge通信（推荐）<i class="anchor-icon anchor-icon-link" anchorid="使用native接口实现jsbridge通信推荐" tips="复制节点链接"></i></h2>          <p>原先，Native同步接口不支持返回值，其返回类型固定为void。然而，为满足业务扩展需求，自API version 18起，引入了替代接口，支持bool、string和buffer类型的返回值。</p>     <p>另外针对同步接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#registerjavascriptproxyex" target="_blank">registerJavaScriptProxyEx</a>和异步接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#registerasyncjavascriptproxyex" target="_blank">registerAsyncJavaScriptProxyEx</a>，新增了参数<a href="/consumer/cn/doc/harmonyos-guides/arkweb-ndk-jsbridge#前端页面调用应用侧函数">permission</a>字段，用于调用权限控制。</p>    </div>    <div class="tiledSection">     <h3 id="接口替代关系" class="firsth2">接口替代关系<i class="anchor-icon anchor-icon-link" anchorid="接口替代关系" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.1" valign="top" width="33.33333333333333%">不推荐的接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.2" valign="top" width="33.33333333333333%">替代接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_OnJavaScriptProxyCallback</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_OnJavaScriptProxyCallbackWithResult</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">Proxy方法被执行的回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_ProxyMethod</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_ProxyMethodWithResult</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">注入的Proxy方法通用结构体。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_ProxyObject</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">ArkWeb_ProxyObjectWithResult</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">注入的Proxy对象通用结构体。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">registerJavaScriptProxy</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">registerJavaScriptProxyEx</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">注入JavaScript对象到window对象中，并在window对象中调用该对象的同步方法。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">registerAsyncJavaScriptProxy</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">registerAsyncJavaScriptProxyEx</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">注入JavaScript对象到window对象中，并在window对象中调用该对象的异步方法。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="使用native接口绑定arkweb">使用Native接口绑定ArkWeb<i class="anchor-icon anchor-icon-link" anchorid="使用native接口绑定arkweb" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>ArkWeb组件声明在ArkTS侧，需要用户自定义一个标识webTag，并将webTag通过Node-API传至应用Native侧，后续ArkWeb Native接口使用，均需webTag作为对应组件的唯一标识。</p></li>      <li>       <p>ArkTS侧</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义webTag，在WebviewController创建时作为入参传入，建立controller与webTag的映射关系</span></li><li><span class="hljs-attr">webTag</span>: string = <span class="hljs-string">'ArkWeb1'</span>;</li><li><span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>
</li><li><span class="hljs-comment">// 在aboutToAppear方法中，通过Node-API接口将webTag传入C++侧，C++侧使用webTag作为ArkWeb组件的唯一标识</span></li><li><span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>  <span class="hljs-comment">//初始化web ndk</span></li><li>  testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>C++侧</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解析存储webTag</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NativeWebInit</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit start"</span>);</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>    <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit webTag:%{public}s"</span>, webTagValue);</li><li>
</li><li>    <span class="hljs-comment">// 将webTag保存在实例对象中</span></li><li>    jsbridge_object_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;JSBridgeObject&gt;(webTagValue);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="使用native接口获取api结构体">使用Native接口获取API结构体<i class="anchor-icon anchor-icon-link" anchorid="使用native接口获取api结构体" tips="复制节点链接"></i></h3>          <p>在ArkWeb Native侧，需要先获取API结构体，才能调用结构体里的Native API。ArkWeb Native侧API通过函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-interface-h#oh_arkweb_getnativeapi" target="_blank">OH_ArkWeb_GetNativeAPI</a>获取，根据入参type不同，可分别获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>结构体。其中，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>对应ArkTS侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">web_webview.WebviewController API</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>对应ArkTS侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web" target="_blank">ArkWeb组件API</a>。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> ArkWeb_ControllerAPI *controller = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ComponentAPI *component = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// ...</span></li><li>controller = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ControllerAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_CONTROLLER));</li><li>component = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ComponentAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_COMPONENT));</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native侧注册组件生命周期回调">Native侧注册组件生命周期回调<i class="anchor-icon anchor-icon-link" anchorid="native侧注册组件生命周期回调" tips="复制节点链接"></i></h3>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>注册组件生命周期回调，调用接口前，建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-type-h#宏定义" target="_blank">ARKWEB_MEMBER_MISSING</a>校验该函数结构体中是否存在对应函数指针，以避免SDK与设备ROM不匹配导致crash问题。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onControllerAttached</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onControllerAttached</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">ValidCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onControllerAttached func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onPageBegin</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onPageBegin</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">LoadStartCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageBegin func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onPageEnd</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onPageEnd</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">LoadEndCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageEnd func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onDestroy</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onDestroy</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">DestroyCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onDestroy func not exist"</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="前端页面调用应用侧函数">前端页面调用应用侧函数<i class="anchor-icon anchor-icon-link" anchorid="前端页面调用应用侧函数" tips="复制节点链接"></i></h3>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#registerjavascriptproxyex" target="_blank">registerJavaScriptProxyEx</a>将应用侧函数注册至前端页面，注册后在下次加载或者重新加载后生效。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册对象</span></li><li><span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk registerJavaScriptProxyEx begin"</span>);</li><li><span class="hljs-variable">ArkWeb_ProxyMethodWithResult</span> <span class="hljs-variable">method1</span> = {<span class="hljs-string">"method1"</span>, <span class="hljs-variable">ProxyMethod1</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-variable">ArkWeb_ProxyMethodWithResult</span> <span class="hljs-variable">method2</span> = {<span class="hljs-string">"method2"</span>, <span class="hljs-variable">ProxyMethod2</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-variable">ArkWeb_ProxyMethodWithResult</span> <span class="hljs-variable">methodList</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">method1</span>, <span class="hljs-variable">method2</span>};</li><li><span class="hljs-comment">// 调用ndk接口注册对象</span></li><li><span class="hljs-comment">// 如此注册的情况下，在H5页面就可以使用proxy.method1、proxy.method2调用此文件下的ProxyMethod1和ProxyMethod2方法了</span></li><li><span class="hljs-variable">ArkWeb_ProxyObjectWithResult</span> <span class="hljs-variable">proxyObject</span> = {<span class="hljs-string">"ndkProxy"</span>, <span class="hljs-variable">methodList</span>, <span class="hljs-number">2</span>};</li><li><span class="hljs-comment">// 参数permission为空，表示不进行权限管控</span></li><li><span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">registerJavaScriptProxyEx</span>(<span class="hljs-title class_">webTag</span>, &amp;<span class="hljs-title class_">proxyObject</span>, <span class="hljs-comment">/*permission*/</span>"");</li></ol></pre></div></div>     <ul>      <li>参数permission是一个JSON字符串，示例如下：</li>     </ul>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"javascriptProxyPermission"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"urlPermissionList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>       <span class="hljs-comment">// Object级权限，如果匹配，所有Method都授权</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>        <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rawfile"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>        <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>               <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>        <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx.com"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>        <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8080"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a/b/c"</span>          <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"methodList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"methodName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"urlPermissionList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>   <span class="hljs-comment">// Method级权限</span></li><li>          <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx.com"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>           <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>          <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span><span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rawfile"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>           <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>          <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"methodName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test11"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"urlPermissionList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>   <span class="hljs-comment">// Method级权限</span></li><li>          <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"q"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"r"</span><span class="hljs-punctuation">,</span>         <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"t"</span>          <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>          <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"u"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"v"</span><span class="hljs-punctuation">,</span>         <span class="hljs-comment">// 精确匹配，不能为空</span></li><li>            <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 精确匹配，为空不检查</span></li><li>            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>           <span class="hljs-comment">// 前缀匹配，为空不检查</span></li><li>          <span class="hljs-punctuation">}</span></li><li>        <span class="hljs-punctuation">]</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="应用侧调用前端页面函数">应用侧调用前端页面函数<i class="anchor-icon anchor-icon-link" anchorid="应用侧调用前端页面函数" tips="复制节点链接"></i></h3>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#runjavascript" target="_blank">runJavaScript</a>调用前端页面函数。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 构造runJS执行的结构体</span></li><li><span class="hljs-variable">char</span>* <span class="hljs-variable">jsCode</span> = <span class="hljs-string">"runJSRetStr()"</span>;</li><li><span class="hljs-variable">ArkWeb_JavaScriptObject</span> <span class="hljs-variable">object</span> = {(<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">jsCode</span>, <span class="hljs-variable">bufferSize</span>, &amp;<span class="hljs-title class_">JSBridgeObject</span>::<span class="hljs-title class_">StaticRunJavaScriptCallback</span>,</li><li>                                     <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-comment">// 调用前端页面runJSRetStr()函数</span></li><li><span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">runJavaScript</span>(<span class="hljs-title class_">webTagValue</span>, &amp;<span class="hljs-title class_">object</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>前端页面代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- entry/src/main/resources/rawfile/runJS.html --&gt;</span></li><li><span class="hljs-comment">&lt;!-- runJS.html --&gt;</span></li><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en-gb"</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>run javascript demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>run JavaScript Ext demo<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"webDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:30px;width:200px"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"testNdkProxyObjMethod1()"</span>&gt;</span>test ndk method1 ! <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:30px;width:200px"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"testNdkProxyObjMethod2()"</span>&gt;</span>test ndk method2 ! <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li>
</li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">testNdkProxyObjMethod1</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-property">method1</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy method1 undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName  test undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-keyword">let</span> retStr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-title function_">method1</span>(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>, [<span class="hljs-number">1.2</span>, -<span class="hljs-number">3.4</span>, <span class="hljs-number">123.456</span>], [<span class="hljs-string">"Saab"</span>, <span class="hljs-string">"Volvo"</span>, <span class="hljs-string">"BMW"</span>, <span class="hljs-literal">undefined</span>], <span class="hljs-number">1.23456</span>, <span class="hljs-number">123789</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>,  <span class="hljs-literal">undefined</span>);</span></li><li><span class="language-javascript">      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ndkProxy and method1 is ok, "</span> + retStr + <span class="hljs-string">", type:"</span> + <span class="hljs-title function_">typeof</span>(retStr));</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">testNdkProxyObjMethod2</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-property">method2</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy method2 undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName  test undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">    <span class="hljs-keyword">var</span> student = {</span></li><li><span class="language-javascript">            <span class="hljs-attr">name</span>:<span class="hljs-string">"zhang"</span>,</span></li><li><span class="language-javascript">            <span class="hljs-attr">sex</span>:<span class="hljs-string">"man"</span>,</span></li><li><span class="language-javascript">            <span class="hljs-attr">age</span>:<span class="hljs-number">25</span></span></li><li><span class="language-javascript">    };</span></li><li><span class="language-javascript">    <span class="hljs-keyword">var</span> cars = [student, <span class="hljs-number">456</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">4.567</span>];</span></li><li><span class="language-javascript">    <span class="hljs-keyword">let</span> params = <span class="hljs-string">"[\"{\\\"scope\\\"]"</span>;</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">    <span class="hljs-keyword">let</span> retStr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-title function_">method2</span>(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>, <span class="hljs-literal">false</span>, cars, params);</span></li><li><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ndkProxy and method2 is ok, "</span> + retStr + <span class="hljs-string">", type:"</span> + <span class="hljs-title function_">typeof</span>(retStr));</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">runJSRetStr</span>(<span class="hljs-params">data</span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();</span></li><li><span class="language-javascript">    <span class="hljs-keyword">let</span> time = d.<span class="hljs-title function_">getTime</span>();</span></li><li><span class="language-javascript">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(time)</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div></li>      <li>       <p>ArkTS侧代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">testObj</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">test</span>(): string {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ArkUI Web Component'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">"ArkUI Web Component"</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">toString</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Web Component toString'</span>);</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title class_">Entry</span></li><li>@<span class="hljs-title class_">Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">webTag</span>: string = <span class="hljs-string">'ArkWeb1'</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  @<span class="hljs-title class_">State</span> <span class="hljs-attr">testObjtest</span>: testObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">testObj</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-comment">//初始化web ndk</span></li><li>    testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'runJS hello'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            testNapi.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>, <span class="hljs-string">"runJSRetStr(\""</span> + <span class="hljs-string">"hello"</span> + <span class="hljs-string">"\")"</span>);</li><li>          })</li><li>      }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'20%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'runJS.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">fileAccess</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">onControllerAttached</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"ndk onControllerAttached webId: "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">getWebId</span>());</li><li>          })</li><li>      }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'80%'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API侧暴露ArkTS接口</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">nativeWebInit</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">runJavaScript</span>: <span class="hljs-function">(<span class="hljs-params">webName: string, jsCode: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li></ol></pre></div></div></li>      <li>       <p>Node-API侧编译配置entry/src/main/cpp/CMakeLists.txt</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span>.<span class="hljs-number">1</span>)</li><li><span class="hljs-built_in">project</span>(NDKJSBridg)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED hello.cpp jsbridge_object.cpp)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    hilog-lib</li><li>    # Specifies the name of the NDK library that</li><li>    # you want CMake to locate.</li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so ${hilog-lib} libohweb.so)</li></ol></pre></div></div></li>      <li>       <p>Node-API层代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/alltypes.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"web/arkweb_interface.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"jsbridge_object.h"</span></span></li><li>
</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>std::shared_ptr&lt;JSBridgeObject&gt; jsbridge_object_ptr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ControllerAPI *controller = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ComponentAPI *component = <span class="hljs-literal">nullptr</span>;</li><li>ArkWeb_JavaScriptValueAPI *javaScriptValueApi = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-comment">// 发送JS脚本到H5侧执行，该方法为执行结果的回调。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *result, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RunJavaScriptCallback webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RunJavaScriptCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">RunJavaScriptCallback</span>(result);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"ndk RunJavaScriptCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 示例代码 ，注册了1个对象，2个方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> ArkWeb_JavaScriptValuePtr <span class="hljs-title">ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">size_t</span> arraySize, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">ProxyMethod1</span>(dataArray, arraySize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">bool</span> boolValue = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">return</span> javaScriptValueApi-&gt;<span class="hljs-built_in">createJavaScriptValue</span>(ArkWeb_JavaScriptValueType::ARKWEB_JAVASCRIPT_BOOL, (<span class="hljs-type">void</span>*)(&amp;boolValue), <span class="hljs-number">1</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> ArkWeb_JavaScriptValuePtr <span class="hljs-title">ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">size_t</span> arraySize, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>
</li><li>    std::string jsCode = <span class="hljs-string">"runJSRetStr()"</span>;</li><li>    ArkWeb_JavaScriptObject object = {(<span class="hljs-type">uint8_t</span> *)jsCode.<span class="hljs-built_in">c_str</span>(), jsCode.<span class="hljs-built_in">size</span>(),</li><li>                                     &amp;JSBridgeObject::StaticRunJavaScriptCallback,</li><li>                                     <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    controller-&gt;<span class="hljs-built_in">runJavaScript</span>(webTag, &amp;object);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">ProxyMethod2</span>(dataArray, arraySize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>
</li><li>    std::string str = <span class="hljs-string">"this is a string"</span>;</li><li>    <span class="hljs-keyword">return</span> javaScriptValueApi-&gt;<span class="hljs-built_in">createJavaScriptValue</span>(ArkWeb_JavaScriptValueType::ARKWEB_JAVASCRIPT_STRING, (<span class="hljs-type">void</span>*)str.<span class="hljs-built_in">c_str</span>(), str.<span class="hljs-built_in">length</span>() + <span class="hljs-number">1</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ValidCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"ValidCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 注册对象</span></li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk registerJavaScriptProxyEx begin"</span>);</li><li>    ArkWeb_ProxyMethodWithResult method1 = {<span class="hljs-string">"method1"</span>, ProxyMethod1, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    ArkWeb_ProxyMethodWithResult method2 = {<span class="hljs-string">"method2"</span>, ProxyMethod2, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    ArkWeb_ProxyMethodWithResult methodList[<span class="hljs-number">2</span>] = {method1, method2};</li><li>    <span class="hljs-comment">// 调用ndk接口注册对象</span></li><li>    <span class="hljs-comment">// 如此注册的情况下，在H5页面就可以使用proxy.method1、proxy.method2调用此文件下的ProxyMethod1和ProxyMethod2方法了</span></li><li>    ArkWeb_ProxyObjectWithResult proxyObject = {<span class="hljs-string">"ndkProxy"</span>, methodList, <span class="hljs-number">2</span>};</li><li>    controller-&gt;<span class="hljs-built_in">registerJavaScriptProxyEx</span>(webTag, &amp;proxyObject, <span class="hljs-string">""</span>);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk registerJavaScriptProxyEx end"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadStartCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"LoadStartCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadEndCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"LoadEndCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DestroyCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"DestroyCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetComponentCallback</span><span class="hljs-params">(ArkWeb_ComponentAPI * component, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* webTagValue)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onControllerAttached)) {</li><li>        component-&gt;<span class="hljs-built_in">onControllerAttached</span>(webTagValue, ValidCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onControllerAttached func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onPageBegin)) {</li><li>        component-&gt;<span class="hljs-built_in">onPageBegin</span>(webTagValue, LoadStartCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageBegin func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onPageEnd)) {</li><li>        component-&gt;<span class="hljs-built_in">onPageEnd</span>(webTagValue, LoadEndCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageEnd func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onDestroy)) {</li><li>        component-&gt;<span class="hljs-built_in">onDestroy</span>(webTagValue, DestroyCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onDestroy func not exist"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解析存储webTag</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NativeWebInit</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>  <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit start"</span>);</li><li>  <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>  napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>  <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>  <span class="hljs-comment">// 获取第一个参数 webTag</span></li><li>  <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>  <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>  <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>  <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit webTag:%{public}s"</span>, webTagValue);</li><li>
</li><li>  jsbridge_object_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;JSBridgeObject&gt;(webTagValue);</li><li>  <span class="hljs-keyword">if</span> (jsbridge_object_ptr)</li><li>      jsbridge_object_ptr-&gt;<span class="hljs-built_in">Init</span>();</li><li>
</li><li>  controller = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ControllerAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_CONTROLLER));</li><li>  <span class="hljs-keyword">if</span> (controller)</li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_ControllerAPI success"</span>);</li><li>
</li><li>  component = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ComponentAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_COMPONENT));</li><li>  <span class="hljs-keyword">if</span> (component)</li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_ComponentAPI success"</span>);</li><li>
</li><li>  javaScriptValueApi =</li><li>      <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_JavaScriptValueAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_JAVASCRIPT_VALUE));</li><li>  <span class="hljs-keyword">if</span> (javaScriptValueApi)</li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_JavaScriptValueAPI success"</span>);</li><li>  <span class="hljs-keyword">else</span></li><li>      <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_JavaScriptValueAPI failed"</span>);</li><li>
</li><li>  <span class="hljs-built_in">SetComponentCallback</span>(component, webTagValue);</li><li>
</li><li>  <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit end"</span>);</li><li>
</li><li>  <span class="hljs-keyword">delete</span>[] webTagValue;</li><li>
</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 发送JS脚本到H5侧执行</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunJavaScript</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>    <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk OH_NativeArkWeb_RunJavaScript webTag:%{public}s"</span>,</li><li>                 webTagValue);</li><li>
</li><li>    <span class="hljs-comment">// 获取第二个参数 jsCode</span></li><li>    <span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;bufferSize);</li><li>    <span class="hljs-type">char</span> *jsCode = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[bufferSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> byteLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], jsCode, bufferSize + <span class="hljs-number">1</span>, &amp;byteLength);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"ndk OH_NativeArkWeb_RunJavaScript jsCode len:%{public}zu"</span>, <span class="hljs-built_in">strlen</span>(jsCode));</li><li>
</li><li>    <span class="hljs-comment">// 构造runJS执行的结构体</span></li><li>    ArkWeb_JavaScriptObject object = {(<span class="hljs-type">uint8_t</span> *)jsCode, bufferSize, &amp;JSBridgeObject::StaticRunJavaScriptCallback,</li><li>                                     <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    controller-&gt;<span class="hljs-built_in">runJavaScript</span>(webTagValue, &amp;object);</li><li>
</li><li>    <span class="hljs-keyword">delete</span>[] webTagValue;</li><li>
</li><li>    <span class="hljs-keyword">delete</span>[] jsCode;</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"nativeWebInit"</span>, <span class="hljs-literal">nullptr</span>, NativeWebInit, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"runJavaScript"</span>, <span class="hljs-literal">nullptr</span>, RunJavaScript, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule); }</li></ol></pre></div></div></li>      <li>       <p>Native侧业务代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/jsbridge_object.h</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"web/arkweb_type.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSBridgeObject</span> : <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;JSBridgeObject&gt; {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">JSBridgeObject</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* webTag);</li><li>    ~<span class="hljs-built_in">JSBridgeObject</span>() = <span class="hljs-keyword">default</span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function">std::weak_ptr&lt;JSBridgeObject&gt;* <span class="hljs-title">GetWeakPtr</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">StaticRunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *data, <span class="hljs-type">void</span> *userData)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *result)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SaySomething</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* say)</span></span>;</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    std::string webTag_;</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; weak_ptr_;</li><li>};</li></ol></pre></div></div>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/jsbridge_object.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"jsbridge_object.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li>JSBridgeObject::<span class="hljs-built_in">JSBridgeObject</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag) : <span class="hljs-built_in">webTag_</span>(webTag) {}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::Init</span><span class="hljs-params">()</span> </span>{ weak_ptr_ = <span class="hljs-built_in">shared_from_this</span>(); }</li><li>
</li><li><span class="hljs-function">std::weak_ptr&lt;JSBridgeObject&gt; *<span class="hljs-title">JSBridgeObject::GetWeakPtr</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> &amp;weak_ptr_; }</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::StaticRunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *data,</span></span></li><li><span class="hljs-function">                                                 <span class="hljs-type">void</span> *userData)</span> {</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)data-&gt;buffer, data-&gt;size)</span></span>;</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">RunJavaScriptCallback</span>(result.<span class="hljs-built_in">c_str</span>());</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *result)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"JSBridgeObject OH_NativeArkWeb_RunJavaScript result:%{public}s"</span>, result);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject ProxyMethod1 argc:%{public}d"</span>,</li><li>                 arraySize);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)dataArray[i].buffer, dataArray[i].size)</span></span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject ProxyMethod1 argv[%{public}d]:%{public}s, size:%{public}d"</span>, i, result.<span class="hljs-built_in">c_str</span>(),</li><li>                     dataArray[i].size);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject ProxyMethod2 argc:%{public}d"</span>,</li><li>                 arraySize);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)dataArray[i].buffer, dataArray[i].size)</span></span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject ProxyMethod2 argv[%{public}d]:%{public}s, size:%{public}d"</span>, i, result.<span class="hljs-built_in">c_str</span>(),</li><li>                     dataArray[i].size);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::SaySomething</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *say)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject SaySomething argc:%{public}s"</span>, say);</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="使用native接口实现jsbridge通信">使用Native接口实现JSBridge通信<i class="anchor-icon anchor-icon-link" anchorid="使用native接口实现jsbridge通信" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="使用native接口绑定arkweb-1" class="firsth2">使用Native接口绑定ArkWeb<i class="anchor-icon anchor-icon-link" anchorid="使用native接口绑定arkweb-1" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>ArkWeb组件声明在ArkTS侧，需要用户自定义一个标识webTag，并将webTag通过Node-API传至应用Native侧，后续ArkWeb Native接口使用，均需webTag作为对应组件的唯一标识。</p></li>      <li>       <p>ArkTS侧</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 自定义webTag，在WebviewController创建时作为入参传入，建立controller与webTag的映射关系</span></li><li><span class="hljs-attr">webTag</span>: string = <span class="hljs-string">'ArkWeb1'</span>;</li><li><span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// aboutToAppear中将webTag通过Node-API接口传入C++侧，作为C++侧ArkWeb组件的唯一标识</span></li><li><span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>  <span class="hljs-comment">//初始化web ndk</span></li><li>  testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div></li>      <li>       <p>C++侧</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解析存储webTag</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NativeWebInit</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit start"</span>);</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>    <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit webTag:%{public}s"</span>, webTagValue);</li><li>
</li><li>    <span class="hljs-comment">// 将webTag保存在实例对象中</span></li><li>    jsbridge_object_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;JSBridgeObject&gt;(webTagValue);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="使用native接口获取api结构体-1">使用Native接口获取API结构体<i class="anchor-icon anchor-icon-link" anchorid="使用native接口获取api结构体-1" tips="复制节点链接"></i></h3>          <p>ArkWeb Native侧得先获取API结构体，才能调用结构体里的Native API。ArkWeb Native侧API通过函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-interface-h#oh_arkweb_getnativeapi" target="_blank">OH_ArkWeb_GetNativeAPI</a>获取，根据入参type不同，可分别获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>函数指针结构体。其中，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>对应ArkTS侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">web_webview.WebviewController API</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>对应ArkTS侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web" target="_blank">ArkWeb组件API</a>。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> ArkWeb_ControllerAPI *controller = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ComponentAPI *component = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// ...</span></li><li>controller = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ControllerAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_CONTROLLER));</li><li>component = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ComponentAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_COMPONENT));</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="native侧注册组件生命周期回调-1">Native侧注册组件生命周期回调<i class="anchor-icon anchor-icon-link" anchorid="native侧注册组件生命周期回调-1" tips="复制节点链接"></i></h3>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-componentapi" target="_blank">ArkWeb_ComponentAPI</a>注册组件生命周期回调，在调用接口前建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-type-h#宏定义" target="_blank">ARKWEB_MEMBER_MISSING</a>校验该函数结构体是否有对应函数指针，避免SDK与设备ROM不匹配导致crash问题。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onControllerAttached</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onControllerAttached</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">ValidCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onControllerAttached func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onPageBegin</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onPageBegin</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">LoadStartCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageBegin func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onPageEnd</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onPageEnd</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">LoadEndCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageEnd func not exist"</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ARKWEB_MEMBER_MISSING</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">onDestroy</span>)) {</li><li>    <span class="hljs-variable">component</span>-&gt;<span class="hljs-title class_">onDestroy</span>(<span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">DestroyCallback</span>,</li><li>                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-variable">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>()));</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onDestroy func not exist"</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="前端页面调用应用侧函数-1">前端页面调用应用侧函数<i class="anchor-icon anchor-icon-link" anchorid="前端页面调用应用侧函数-1" tips="复制节点链接"></i></h3>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#registerjavascriptproxy" target="_blank">registerJavaScriptProxy</a>将应用侧函数注册至前端页面，注册后在下次加载或者重新加载后生效。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注册对象</span></li><li><span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RegisterJavaScriptProxy begin"</span>);</li><li><span class="hljs-variable">ArkWeb_ProxyMethod</span> <span class="hljs-variable">method1</span> = {<span class="hljs-string">"method1"</span>, <span class="hljs-variable">ProxyMethod1</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-variable">ArkWeb_ProxyMethod</span> <span class="hljs-variable">method2</span> = {<span class="hljs-string">"method2"</span>, <span class="hljs-variable">ProxyMethod2</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-variable">ArkWeb_ProxyMethod</span> <span class="hljs-variable">methodList</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">method1</span>, <span class="hljs-variable">method2</span>};</li><li><span class="hljs-comment">// 调用ndk接口注册对象</span></li><li><span class="hljs-comment">// 如此注册的情况下，在H5页面就可以使用proxy.method1、proxy.method2调用此文件下的ProxyMethod1和ProxyMethod2方法了</span></li><li><span class="hljs-variable">ArkWeb_ProxyObject</span> <span class="hljs-variable">proxyObject</span> = {<span class="hljs-string">"ndkProxy"</span>, <span class="hljs-variable">methodList</span>, <span class="hljs-number">2</span>};</li><li><span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">registerJavaScriptProxy</span>(<span class="hljs-title class_">webTag</span>, &amp;<span class="hljs-title class_">proxyObject</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="应用侧调用前端页面函数-1">应用侧调用前端页面函数<i class="anchor-icon anchor-icon-link" anchorid="应用侧调用前端页面函数-1" tips="复制节点链接"></i></h3>          <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#runjavascript" target="_blank">runJavaScript</a>调用前端页面函数。</p>     <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 构造runJS执行的结构体</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>* <span class="hljs-variable">jsCode</span> = <span class="hljs-string">"runJSRetStr()"</span>;</li><li><span class="hljs-variable">ArkWeb_JavaScriptObject</span> <span class="hljs-variable">object</span> = {(<span class="hljs-variable">uint8_t</span> *)<span class="hljs-variable">jsCode</span>, <span class="hljs-variable">bufferSize</span>, &amp;<span class="hljs-title class_">JSBridgeObject</span>::<span class="hljs-title class_">StaticRunJavaScriptCallback</span>,</li><li>                                     <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span> *&gt;(<span class="hljs-variable">jsbridge_object_ptr</span>-&gt;<span class="hljs-title class_">GetWeakPtr</span>())};</li><li><span class="hljs-comment">// 调用前端页面runJSRetStr()函数</span></li><li><span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">runJavaScript</span>(<span class="hljs-title class_">webTagValue</span>, &amp;<span class="hljs-title class_">object</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="完整示例-1">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例-1" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>前端页面代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- entry/src/main/resources/rawfile/runJS.html --&gt;</span></li><li><span class="hljs-comment">&lt;!-- runJS.html --&gt;</span></li><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en-gb"</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>run javascript demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>run JavaScript Ext demo<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"webDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:30px;width:200px"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"testNdkProxyObjMethod1()"</span>&gt;</span>test ndk method1 ! <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:30px;width:200px"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"testNdkProxyObjMethod2()"</span>&gt;</span>test ndk method2 ! <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></li><li>
</li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">testNdkProxyObjMethod1</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-property">method1</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy method1 undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName  test undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-title function_">method1</span>(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>, [<span class="hljs-number">1.2</span>, -<span class="hljs-number">3.4</span>, <span class="hljs-number">123.456</span>], [<span class="hljs-string">"Saab"</span>, <span class="hljs-string">"Volvo"</span>, <span class="hljs-string">"BMW"</span>, <span class="hljs-literal">undefined</span>], <span class="hljs-number">1.23456</span>, <span class="hljs-number">123789</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>,  <span class="hljs-literal">undefined</span>);</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">testNdkProxyObjMethod2</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-property">method2</span> == <span class="hljs-literal">undefined</span>) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"webDemo"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"ndkProxy method2 undefined"</span></span></li><li><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-string">"objName  test undefined"</span></span></li><li><span class="language-javascript">      }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">    <span class="hljs-keyword">var</span> student = {</span></li><li><span class="language-javascript">            <span class="hljs-attr">name</span>:<span class="hljs-string">"zhang"</span>,</span></li><li><span class="language-javascript">            <span class="hljs-attr">sex</span>:<span class="hljs-string">"man"</span>,</span></li><li><span class="language-javascript">            <span class="hljs-attr">age</span>:<span class="hljs-number">25</span></span></li><li><span class="language-javascript">    };</span></li><li><span class="language-javascript">    <span class="hljs-keyword">var</span> cars = [student, <span class="hljs-number">456</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">4.567</span>];</span></li><li><span class="language-javascript">    <span class="hljs-keyword">let</span> params = <span class="hljs-string">"[\"{\\\"scope\\\"]"</span>;</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ndkProxy</span>.<span class="hljs-title function_">method2</span>(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>, <span class="hljs-literal">false</span>, cars, params);</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">runJSRetStr</span>(<span class="hljs-params">data</span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();</span></li><li><span class="language-javascript">    <span class="hljs-keyword">let</span> time = d.<span class="hljs-title function_">getTime</span>();</span></li><li><span class="language-javascript">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(time)</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div></li>      <li>       <p>ArkTS侧代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">testObj</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">test</span>(): string {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ArkUI Web Component'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">"ArkUI Web Component"</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">toString</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Web Component toString'</span>);</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title class_">Entry</span></li><li>@<span class="hljs-title class_">Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-attr">webTag</span>: string = <span class="hljs-string">'ArkWeb1'</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  @<span class="hljs-title class_">State</span> <span class="hljs-attr">testObjtest</span>: testObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">testObj</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-comment">//初始化web ndk</span></li><li>    testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'runJS hello'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            testNapi.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>, <span class="hljs-string">"runJSRetStr(\""</span> + <span class="hljs-string">"hello"</span> + <span class="hljs-string">"\")"</span>);</li><li>          })</li><li>      }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'20%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'runJS.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">fileAccess</span>(<span class="hljs-literal">true</span>)</li><li>          .<span class="hljs-title function_">onControllerAttached</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"ndk onControllerAttached webId: "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">getWebId</span>());</li><li>          })</li><li>      }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'80%'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API侧暴露ArkTS接口</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">nativeWebInit</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">runJavaScript</span>: <span class="hljs-function">(<span class="hljs-params">webName: string, jsCode: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li></ol></pre></div></div></li>      <li>       <p>Node-API侧编译配置entry/src/main/cpp/CMakeLists.txt</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span>.<span class="hljs-number">1</span>)</li><li><span class="hljs-built_in">project</span>(NDKJSBridg)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(entry SHARED hello.cpp jsbridge_object.cpp)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    hilog-lib</li><li>    # Specifies the name of the NDK library that</li><li>    # you want CMake to locate.</li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so ${hilog-lib} libohweb.so)</li></ol></pre></div></div></li>      <li>       <p>Node-API层代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/hello.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/alltypes.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"web/arkweb_interface.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"jsbridge_object.h"</span></span></li><li>
</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>std::shared_ptr&lt;JSBridgeObject&gt; jsbridge_object_ptr = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ControllerAPI *controller = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_ComponentAPI *component = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-comment">// 发送JS脚本到H5侧执行，该方法为执行结果的回调。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *result, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RunJavaScriptCallback webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RunJavaScriptCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">RunJavaScriptCallback</span>(result);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"ndk RunJavaScriptCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 示例代码 ，注册了1个对象，2个方法</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">size_t</span> arraySize, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">ProxyMethod1</span>(dataArray, arraySize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod1 jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">size_t</span> arraySize, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>
</li><li>    std::string jsCode = <span class="hljs-string">"runJSRetStr()"</span>;</li><li>    ArkWeb_JavaScriptObject object = {(<span class="hljs-type">uint8_t</span> *)jsCode.<span class="hljs-built_in">c_str</span>(), jsCode.<span class="hljs-built_in">size</span>(),</li><li>                                     &amp;JSBridgeObject::StaticRunJavaScriptCallback,</li><li>                                     <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    controller-&gt;<span class="hljs-built_in">runJavaScript</span>(webTag, &amp;object);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">ProxyMethod2</span>(dataArray, arraySize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ProxyMethod2 jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ValidCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"ValidCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk ValidCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 注册对象</span></li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RegisterJavaScriptProxy begin"</span>);</li><li>    ArkWeb_ProxyMethod method1 = {<span class="hljs-string">"method1"</span>, ProxyMethod1, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    ArkWeb_ProxyMethod method2 = {<span class="hljs-string">"method2"</span>, ProxyMethod2, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    ArkWeb_ProxyMethod methodList[<span class="hljs-number">2</span>] = {method1, method2};</li><li>    <span class="hljs-comment">// 调用ndk接口注册对象</span></li><li>    <span class="hljs-comment">// 如此注册的情况下，在H5页面就可以使用proxy.method1、proxy.method2调用此文件下的ProxyMethod1和ProxyMethod2方法了</span></li><li>    ArkWeb_ProxyObject proxyObject = {<span class="hljs-string">"ndkProxy"</span>, methodList, <span class="hljs-number">2</span>};</li><li>    controller-&gt;<span class="hljs-built_in">registerJavaScriptProxy</span>(webTag, &amp;proxyObject);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk RegisterJavaScriptProxy end"</span>);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadStartCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"LoadStartCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadStartCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadEndCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"LoadEndCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk LoadEndCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DestroyCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback webTag: %{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">SaySomething</span>(<span class="hljs-string">"DestroyCallback"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk DestroyCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetComponentCallback</span><span class="hljs-params">(ArkWeb_ComponentAPI * component, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* webTagValue)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onControllerAttached)) {</li><li>        component-&gt;<span class="hljs-built_in">onControllerAttached</span>(webTagValue, ValidCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onControllerAttached func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onPageBegin)) {</li><li>        component-&gt;<span class="hljs-built_in">onPageBegin</span>(webTagValue, LoadStartCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageBegin func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onPageEnd)) {</li><li>        component-&gt;<span class="hljs-built_in">onPageEnd</span>(webTagValue, LoadEndCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onPageEnd func not exist"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ARKWEB_MEMBER_MISSING</span>(component, onDestroy)) {</li><li>        component-&gt;<span class="hljs-built_in">onDestroy</span>(webTagValue, DestroyCallback,</li><li>                                        <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>()));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"component onDestroy func not exist"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解析存储webTag</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NativeWebInit</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit start"</span>);</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>    <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit webTag:%{public}s"</span>, webTagValue);</li><li>
</li><li>    <span class="hljs-comment">// 将webTag保存在实例对象中</span></li><li>    jsbridge_object_ptr = std::<span class="hljs-built_in">make_shared</span>&lt;JSBridgeObject&gt;(webTagValue);</li><li>    <span class="hljs-keyword">if</span> (jsbridge_object_ptr)</li><li>        jsbridge_object_ptr-&gt;<span class="hljs-built_in">Init</span>();</li><li>
</li><li>    controller = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ControllerAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_CONTROLLER));</li><li>    component = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ComponentAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_COMPONENT));</li><li>    <span class="hljs-built_in">SetComponentCallback</span>(component, webTagValue);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit end"</span>);</li><li>    <span class="hljs-keyword">delete</span>[] webTagValue;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 发送JS脚本到H5侧执行</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">RunJavaScript</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-type">size_t</span> webTagSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;webTagSize);</li><li>    <span class="hljs-type">char</span> *webTagValue = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[webTagSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> webTagLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">0</span>], webTagValue, webTagSize + <span class="hljs-number">1</span>, &amp;webTagLength);</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk OH_NativeArkWeb_RunJavaScript webTag:%{public}s"</span>,</li><li>                 webTagValue);</li><li>
</li><li>    <span class="hljs-comment">// 获取第二个参数 jsCode</span></li><li>    <span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;bufferSize);</li><li>    <span class="hljs-type">char</span> *jsCode = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">char</span>[bufferSize + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-type">size_t</span> byteLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">1</span>], jsCode, bufferSize + <span class="hljs-number">1</span>, &amp;byteLength);</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"ndk OH_NativeArkWeb_RunJavaScript jsCode len:%{public}zu"</span>, <span class="hljs-built_in">strlen</span>(jsCode));</li><li>
</li><li>    <span class="hljs-comment">// 构造runJS执行的结构体</span></li><li>    ArkWeb_JavaScriptObject object = {(<span class="hljs-type">uint8_t</span> *)jsCode, bufferSize, &amp;JSBridgeObject::StaticRunJavaScriptCallback,</li><li>                                     <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(jsbridge_object_ptr-&gt;<span class="hljs-built_in">GetWeakPtr</span>())};</li><li>    controller-&gt;<span class="hljs-built_in">runJavaScript</span>(webTagValue, &amp;object);</li><li>    <span class="hljs-keyword">delete</span>[] webTagValue;</li><li>    <span class="hljs-keyword">delete</span>[] jsCode;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"nativeWebInit"</span>, <span class="hljs-literal">nullptr</span>, NativeWebInit, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"runJavaScript"</span>, <span class="hljs-literal">nullptr</span>, RunJavaScript, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule); }</li></ol></pre></div></div></li>      <li>       <p>Native侧业务代码</p>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/jsbridge_object.h</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"web/arkweb_type.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSBridgeObject</span> : <span class="hljs-keyword">public</span> std::enable_shared_from_this&lt;JSBridgeObject&gt; {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">JSBridgeObject</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* webTag);</li><li>    ~<span class="hljs-built_in">JSBridgeObject</span>() = <span class="hljs-keyword">default</span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function">std::weak_ptr&lt;JSBridgeObject&gt;* <span class="hljs-title">GetWeakPtr</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">StaticRunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *data, <span class="hljs-type">void</span> *userData)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *result)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SaySomething</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* say)</span></span>;</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    std::string webTag_;</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; weak_ptr_;</li><li>};</li></ol></pre></div></div>       <div _ngcontent-hcj-c106="" class="highlight-div"><div _ngcontent-hcj-c106="" class="highlight-div-header"><div _ngcontent-hcj-c106="" class="highlight-div-header-left"><div _ngcontent-hcj-c106="" class="handle-button expand-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcj-c106="" class="highlight-div-header-right"><div _ngcontent-hcj-c106="" class="handle-button ai-button"></div><div _ngcontent-hcj-c106="" class="handle-button line-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcj-c106="" class="handle-button theme-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcj-c106="" class="handle-button copy-button"><div _ngcontent-hcj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcj-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/jsbridge_object.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"jsbridge_object.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li>JSBridgeObject::<span class="hljs-built_in">JSBridgeObject</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag) : <span class="hljs-built_in">webTag_</span>(webTag) {}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::Init</span><span class="hljs-params">()</span> </span>{ weak_ptr_ = <span class="hljs-built_in">shared_from_this</span>(); }</li><li>
</li><li><span class="hljs-function">std::weak_ptr&lt;JSBridgeObject&gt; *<span class="hljs-title">JSBridgeObject::GetWeakPtr</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> &amp;weak_ptr_; }</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::StaticRunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *webTag, <span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *data,</span></span></li><li><span class="hljs-function">                                                 <span class="hljs-type">void</span> *userData)</span> {</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback webTag:%{public}s"</span>, webTag);</li><li>    <span class="hljs-keyword">if</span> (!userData) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback userData is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    std::weak_ptr&lt;JSBridgeObject&gt; jsb_weak_ptr = *<span class="hljs-keyword">static_cast</span>&lt;std::weak_ptr&lt;JSBridgeObject&gt; *&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> jsb_ptr = jsb_weak_ptr.<span class="hljs-built_in">lock</span>()) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)data-&gt;buffer, data-&gt;size)</span></span>;</li><li>        jsb_ptr-&gt;<span class="hljs-built_in">RunJavaScriptCallback</span>(result.<span class="hljs-built_in">c_str</span>());</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject StaticRunJavaScriptCallback jsb_weak_ptr lock failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::RunJavaScriptCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *result)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                 <span class="hljs-string">"JSBridgeObject OH_NativeArkWeb_RunJavaScript result:%{public}s"</span>, result);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::ProxyMethod1</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject ProxyMethod1 argc:%{public}d"</span>,</li><li>                 arraySize);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)dataArray[i].buffer, dataArray[i].size)</span></span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject ProxyMethod1 argv[%{public}d]:%{public}s, size:%{public}d"</span>, i, result.<span class="hljs-built_in">c_str</span>(),</li><li>                     dataArray[i].size);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::ProxyMethod2</span><span class="hljs-params">(<span class="hljs-type">const</span> ArkWeb_JavaScriptBridgeData *dataArray, <span class="hljs-type">int32_t</span> arraySize)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject ProxyMethod2 argc:%{public}d"</span>,</li><li>                 arraySize);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arraySize; i++) {</li><li>        <span class="hljs-function">std::string <span class="hljs-title">result</span><span class="hljs-params">((<span class="hljs-type">char</span> *)dataArray[i].buffer, dataArray[i].size)</span></span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>,</li><li>                     <span class="hljs-string">"JSBridgeObject ProxyMethod2 argv[%{public}d]:%{public}s, size:%{public}d"</span>, i, result.<span class="hljs-built_in">c_str</span>(),</li><li>                     dataArray[i].size);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">JSBridgeObject::SaySomething</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *say)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"JSBridgeObject SaySomething argc:%{public}s"</span>, say);</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>