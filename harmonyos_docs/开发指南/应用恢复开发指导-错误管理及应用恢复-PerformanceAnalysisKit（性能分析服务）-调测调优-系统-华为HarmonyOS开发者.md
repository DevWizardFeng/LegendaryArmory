<h1 _ngcontent-rjq-c119="" class="doc-title ng-star-inserted" title="应用恢复开发指导"> 应用恢复开发指导 </h1>

<div _ngcontent-rjq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>应用在运行中不可避免会产生一些非预期的行为，如运行时抛出未处理的异常和错误，违反框架的调用/运行约束等。</p>     <p>系统默认对异常的处理方式为进程退出，如果应用使用过程中产生了用户数据，直接退出可能会导致用户工作中断，数据丢失。</p>     <p>如果应用在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#abilitystage" target="_blank">AbilityStage</a>中使能<a href="/consumer/cn/doc/harmonyos-guides/apprecovery-guidelines#应用恢复接口功能介绍">应用恢复功能</a>，并对临时数据进行保存，应用非预期退出后的下一次启动会恢复先前的状态和数据，给用户更连贯的使用体验。这里状态包括应用的页面栈以及onSaveState接口中保存的数据。</p>     <p>API 9上的应用恢复接口支持单UIAbility的Stage模型应用开发。支持JsError故障时的状态保存与自动重启。</p>     <p>API 10在API 9的基础上新增支持多UIAbility的Stage模型应用开发。支持AppFreeze故障时的状态保存回调。支持应用被管控模式杀死后，下次启动的状态恢复。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>应用故障恢复接口由appRecovery模块提供，开发者可以通过import引入，详见<a href="/consumer/cn/doc/harmonyos-guides/apprecovery-guidelines#开发步骤">开发步骤</a>。</p>    </div>    <div class="tiledSection">     <h3 id="应用恢复接口功能介绍" class="firsth2">应用恢复接口功能介绍<i class="anchor-icon anchor-icon-link" anchorid="应用恢复接口功能介绍" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">enableAppRecovery(restart?: RestartFlag, saveOccasion?: SaveOccasionFlag, saveMode?: SaveModeFlag) : void</td>         <td class="cellrowborder" valign="top" width="50%">使能应用恢复功能。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">saveAppState(): boolean</td>         <td class="cellrowborder" valign="top" width="50%">主动保存当前应用中支持恢复的UIAbility的状态。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">restartApp(): void</td>         <td class="cellrowborder" valign="top" width="50%">重启当前进程，并启动由<strong>setRestartWant</strong>指定的UIAbility，如果未指定，将重新拉起处于前台且支持恢复的UIAbility。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">saveAppState(context?: UIAbilityContext): boolean</td>         <td class="cellrowborder" valign="top" width="50%">主动保存由Context指定的UIAbility状态。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">setRestartWant(want: Want): void</td>         <td class="cellrowborder" valign="top" width="50%">设置主动调用<strong>restartApp</strong>以及<strong>RestartFlag</strong>不为<strong>NO_RESTART</strong>时重启的UIAbility（want的abilityName属性可设置为UIAbility的名称）。该UIAbility必须在同一个包名下。</td>        </tr>             </tbody></table></div>     </div>     <p>由于上述接口可能在故障处理时使用，所以不会返回异常，需要开发者熟悉使用的场景。具体其各参数定义详见<a href="https://gitcode.com/openharmony/docs/blob/master/zh-cn/application-dev/reference/apis-ability-kit/js-apis-app-ability-appRecovery.md" target="_blank">参数说明</a>。</p>     <p><strong>enableAppRecovery</strong>：需要在应用初始化阶段调用，比如AbilityStage的OnCreate调用。调用该接口后，应用恢复时将按首个支持恢复的UIAbility进行恢复。</p>     <p><strong>saveAppState</strong>：调用后框架会回调当前进程中所有支持恢复的UIAbility的onSaveState方法。如果在onSaveState方法中同意保存数据，则会将相关数据及UIAbility的页面栈持久化到应用的本地缓存。如果需要保存指定UIAbility，则需要指定UIAbility对应的Context。</p>     <p><strong>setRestartWant</strong>：指定由appRecovery发起重启的UIAbility。</p>     <p><strong>restartApp</strong>：调用后框架会杀死当前应用进程，并重新拉起由<strong>setRestartWant</strong>指定的UIAbility，其中启动原因为APP_RECOVERY。</p>     <p>API 9以及未使用<strong>setRestartWant</strong>指定UIAbility的场景，会拉起最后一个支持恢复且在前台的UIAbility，如果当前前台的UIAbility不支持恢复，则应用表现闪退。</p>     <p>如果重启的UIAbility存在已经保存的状态，这些状态数据会在UIAbility的OnCreate生命周期回调的want参数中作为wantParam属性传入。两次重启的间隔应大于一分钟，一分钟之内重复调用此接口只会退出应用不会重启应用。自动重启的行为与主动重启一致。</p>    </div>    <div class="tiledSection">     <h3 id="应用恢复状态管理示意">应用恢复状态管理示意<i class="anchor-icon anchor-icon-link" anchorid="应用恢复状态管理示意" tips="复制节点链接"></i></h3>          <p>从API 10起，应用恢复的场景不仅局限于异常时自动重启。所以需要理解应用何时会加载恢复的状态。</p>     <p>简而言之，如果应用任务的上次退出不是由用户发起的，且应用存在用于恢复的状态，应用下一次由用户拉起时的启动原因会被设为APP_RECOVERY，并清理该任务的恢复状态。</p>     <p>应用恢复状态标识会在状态保存接口主动或者被动调用时设置。在应用正常退出或者应用异常退出重启后，该状态会被清理。正常退出目前包括用户按后退键退出以及用户清理最近任务。</p>     <p><span><img originheight="594" originwidth="966" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115041.50613535409773179937612136016371:50001231000000:2800:C1B0C207EC3E7D6E33495F8225110E5FBBED617742D53361FE3242E5DB61AC1A.png" width="920" height="565.7142857142857"></span></p>    </div>    <div class="tiledSection">     <h3 id="应用卡死的状态保存及恢复">应用卡死的状态保存及恢复<i class="anchor-icon anchor-icon-link" anchorid="应用卡死的状态保存及恢复" tips="复制节点链接"></i></h3>          <p>API 10开始支持应用卡死时的状态保存。JsError故障时，onSaveState接口在主线程进行回调。对于AppFreeze故障，主线程可能处于卡死的状态，onSaveState会在非主线程进行回调。其主要流程如下图：</p>     <p><span><img originheight="935" originwidth="1339" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115041.46674898791933450505294567409186:50001231000000:2800:4A74CC8D0F246080F47B195D8E09B1BEE0F2232B25BFEB34CC067E5B22C3F609.png" width="920" height="642.419716206124"></span></p>     <p>由于卡死时的回调不在JS线程上执行，onSaveState回调中的代码建议不要使用import进来的Native动态库，禁止访问主线程创建的thread_local对象。</p>    </div>    <div class="tiledSection">     <h3 id="框架故障管理流程示意">框架故障管理流程示意<i class="anchor-icon anchor-icon-link" anchorid="框架故障管理流程示意" tips="复制节点链接"></i></h3>          <p>故障管理是应用提升用户体验的重要手段。应用程序框架为开发者提供了故障监听、故障恢复、以及故障查询三种方式来管理应用的故障。</p>     <ul>      <li>       <p>故障监听指的是通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-errormanager" target="_blank">errorManager</a>注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-errorobserver" target="_blank">ErrorObserver</a>，监听故障的发生，并通知到监听方。</p></li>      <li>       <p>故障恢复指的是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-apprecovery" target="_blank">appRecovery</a>，及故障发生后，将应用重启恢复到故障之前的状态。</p></li>      <li>       <p>故障查询指的是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger" target="_blank">faultLogger</a>通过其查询接口获取当前的故障信息。</p></li>     </ul>     <p>下图中并没有标记faultLogger的调用时机，开发者可以根据应用启动时传入的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilityconstant#lastexitreason" target="_blank">LastExitReason</a>来决定是否调用faultLogger查询上次的故障信息。</p>     <p><span><img originheight="636" originwidth="958" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115041.26800546045323918600657222250332:50001231000000:2800:24E157F609FC60994820BD924432BF1536AA979B3DA1ED49DAB46116220F94D4.png" width="920" height="610.7724425887264"></span></p>     <p>这里建议应用开发者使用errorManager对应用的异常进行处理，处理完成后开发者可以选择调用状态保存接口并主动重启应用。</p>     <p>如果开发者没有注册ErrorObserver也没有使能应用恢复，则按照系统的默认逻辑执行进程退出。用户可以选择从启动器再次打开应用。</p>     <p>如果开发者使能应用恢复，框架会首先检查当前故障是否支持状态保存以及开发者是否配置了状态保存，如果支持则会回调UIAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onsavestate" target="_blank">onSaveState</a>的接口。最后重启应用。</p>    </div>    <div class="tiledSection">     <h3 id="应用故障管理接口支持场景">应用故障管理接口支持场景<i class="anchor-icon anchor-icon-link" anchorid="应用故障管理接口支持场景" tips="复制节点链接"></i></h3>          <p>通常的故障类型有JS程序Crash、应用程序卡死、C++程序Crash。Crash故障时应用一般都会被关闭。Freeze故障为应用无响应卡屏场景。应用上层无需关注故障类型，底层恢复框架会根据故障类型来实现不同场景的故障管理。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.6.1.1" valign="top" width="20%">故障名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.6.1.2" valign="top" width="20%">故障监听</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.6.1.3" valign="top" width="20%">状态保存</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.6.1.4" valign="top" width="20%">自动重启</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.6.1.5" valign="top" width="20%">日志查询</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="20%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faulttype" target="_blank">JS_CRASH</a></td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faulttype" target="_blank">APP_FREEZE</a></td>         <td class="cellrowborder" valign="top" width="20%">API18及以上支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faulttype" target="_blank">CPP_CRASH</a></td>         <td class="cellrowborder" valign="top" width="20%">不支持</td>         <td class="cellrowborder" valign="top" width="20%">不支持</td>         <td class="cellrowborder" valign="top" width="20%">不支持</td>         <td class="cellrowborder" valign="top" width="20%">支持</td>        </tr>             </tbody></table></div>     </div>     <p>这里状态保存指的是故障时状态保存，对于应用卡死场景，开发者可以采用定时保存状态或者在UIAbility切入后台后自动保存的方式最大限度的保护用户数据。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="使能开启自恢复特性" class="firsth2">使能开启自恢复特性<i class="anchor-icon anchor-icon-link" anchorid="使能开启自恢复特性" tips="复制节点链接"></i></h3>          <p>开发者需要在应用模块初始化时使能appRecovery功能。下面为示例的AbilityStage。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityStage</span>, appRecovery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAbilityStage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbilityStage</span> {</li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] MyAbilityStage onCreate"</span>);</li><li>        appRecovery.<span class="hljs-title function_">enableAppRecovery</span>(appRecovery.<span class="hljs-property">RestartFlag</span>.<span class="hljs-property">ALWAYS_RESTART</span>,</li><li>            appRecovery.<span class="hljs-property">SaveOccasionFlag</span>.<span class="hljs-property">SAVE_WHEN_ERROR</span> | appRecovery.<span class="hljs-property">SaveOccasionFlag</span>.<span class="hljs-property">SAVE_WHEN_BACKGROUND</span>,</li><li>            appRecovery.<span class="hljs-property">SaveModeFlag</span>.<span class="hljs-property">SAVE_WITH_FILE</span>);</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="配置支持恢复的uiability">配置支持恢复的UIAbility<i class="anchor-icon anchor-icon-link" anchorid="配置支持恢复的uiability" tips="复制节点链接"></i></h3>          <p>UIAbility的配置清单一般的名字为module.json5。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"EntryAbility"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"recoverable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="数据保存和恢复">数据保存和恢复<i class="anchor-icon anchor-icon-link" anchorid="数据保存和恢复" tips="复制节点链接"></i></h3>          <p>在使能appRecovery功能后，开发者可以在UIAbility中采用主动保存状态，主动恢复或者选择被动恢复的方式使用appRecovery功能。</p>     <p>下面为示例的EntryAbility。</p>     <p><strong>导包</strong></p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, appRecovery, errorManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div>     <p><strong>主动触发保存和恢复</strong></p>     <ul>      <li>定义和注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-errorobserver" target="_blank">ErrorObserver</a> callback，具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-errormanager" target="_blank">errorManager</a>里的使用方法。</li>     </ul>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { appRecovery, errorManager, <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> registerId = -<span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">callback</span>: errorManager.<span class="hljs-property">ErrorObserver</span> = {</li><li>    <span class="hljs-title function_">onUnhandledException</span>(<span class="hljs-params">errMsg</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(errMsg);</li><li>    appRecovery.<span class="hljs-title function_">saveAppState</span>();</li><li>    appRecovery.<span class="hljs-title function_">restartApp</span>();</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-comment">// 为已创建的主窗口设置主页面</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onWindowStageCreate"</span>);</li><li>    registerId = errorManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, callback);</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">"pages/index"</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load the content. Cause:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in loading the content. Data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>    })</li><li>    }</li><li>}</li></ol></pre></div></div>     <ul>      <li>数据保存</li>     </ul>     <p>callback触发appRecovery.saveAppState()调用后，会触发EntryAbility的onSaveState(state, wantParams)函数回调。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onSaveState</span>(<span class="hljs-params">state:AbilityConstant.StateType, wantParams: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>        <span class="hljs-comment">// UIAbility已调用以保存应用程序数据</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onSaveState"</span>);</li><li>        wantParams[<span class="hljs-string">"myData"</span>] = <span class="hljs-string">"my1234567"</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnSaveResult</span>.<span class="hljs-property">ALL_AGREE</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>     <ul>      <li>数据恢复</li>     </ul>     <p>callback触发后appRecovery.restartApp()调用后，应用会重启，重启后会走到EntryAbility的onCreate(want, launchParam)函数，保存的数据会在want参数的parameters里。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">abilityWant</span>: <span class="hljs-title class_">Want</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onCreate"</span>);</li><li>        abilityWant = want;</li><li>        <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> == <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">APP_RECOVERY</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>            <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>) {</li><li>                <span class="hljs-keyword">let</span> recoveryData = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">"myData"</span>];</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"myData"</span>, recoveryData);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>);</li><li>            }</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>     <ul>      <li>取消注册ErrorObserver callback</li>     </ul>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { errorManager, <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> registerId = -<span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onWindowStageDestroy</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-comment">// 销毁主窗口，释放相关UI资源</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onWindowStageDestroy"</span>);</li><li>
</li><li>        errorManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'error'</span>, registerId, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"[Demo] err:"</span>, err);</li><li>        });</li><li>    }</li><li>}</li></ol></pre></div></div>     <p><strong>被动保存和恢复</strong></p>     <p>被动保存和恢复依赖恢复框架底层触发，无需注册监听ErrorObserver callback，只需实现UIAbility的onSaveState接口数据保存和onCreate接口数据恢复流程即可。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">abilityWant</span>: <span class="hljs-title class_">Want</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span></li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onCreate"</span>);</li><li>        abilityWant = want;</li><li>        <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> == <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">APP_RECOVERY</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>            <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>) {</li><li>                <span class="hljs-keyword">let</span> recoveryData = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">"myData"</span>];</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"myData"</span>, recoveryData);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>);</li><li>            }</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onSaveState</span>(<span class="hljs-params">state:AbilityConstant.StateType, wantParams: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>        <span class="hljs-comment">// UIAbility已调用以保存应用程序数据</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Demo] EntryAbility onSaveState"</span>);</li><li>        wantParams[<span class="hljs-string">"myData"</span>] = <span class="hljs-string">"my1234567"</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnSaveResult</span>.<span class="hljs-property">ALL_AGREE</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>     <p><strong>故障UIAbility的重启恢复标记</strong></p>     <p>发生故障的UIAbility再次重新启动时，在调度onCreate生命周期里，参数want的parameters成员会有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantconstant#params" target="_blank">ABILITY_RECOVERY_RESTART</a>标记数据，并且值为true。</p>     <div _ngcontent-rjq-c106="" class="highlight-div"><div _ngcontent-rjq-c106="" class="highlight-div-header"><div _ngcontent-rjq-c106="" class="highlight-div-header-left"><div _ngcontent-rjq-c106="" class="handle-button expand-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rjq-c106="" class="highlight-div-header-right"><div _ngcontent-rjq-c106="" class="handle-button ai-button"></div><div _ngcontent-rjq-c106="" class="handle-button line-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rjq-c106="" class="handle-button theme-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rjq-c106="" class="handle-button copy-button"><div _ngcontent-rjq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rjq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>    <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>        <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span> === <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>[wantConstant.<span class="hljs-property">Params</span>.<span class="hljs-property">ABILITY_RECOVERY_RESTART</span>] != <span class="hljs-literal">undefined</span> &amp;&amp;</li><li>            want.<span class="hljs-property">parameters</span>[wantConstant.<span class="hljs-property">Params</span>.<span class="hljs-property">ABILITY_RECOVERY_RESTART</span>] == <span class="hljs-literal">true</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"This ability need to recovery"</span>);</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>