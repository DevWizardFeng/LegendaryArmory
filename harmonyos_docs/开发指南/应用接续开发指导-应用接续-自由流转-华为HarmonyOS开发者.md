<h1 _ngcontent-nmk-c119="" class="doc-title ng-star-inserted" title="应用接续开发指导"> 应用接续开发指导 </h1>

<div _ngcontent-nmk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>通过应用接续，可以实现将应用当前任务（包括页面控件状态变量等）迁移到目标设备，并在目标设备上接续使用。</p> <p>可以实现的功能包括：</p> <ul><li>存储及恢复自定义数据（应用业务内容）。</li><li>存储及恢复页面路由信息和页面控件状态数据。</li><li>应用兼容性检测。</li><li><p>支持应用根据实际使用场景动态设置迁移状态（默认迁移状态为ACTIVE激活状态）。</p> <p>如编辑类应用在编辑文本的页面下才需要迁移，其他页面不需要迁移，则可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#setmissioncontinuestate10" target="_blank">setMissionContinueState</a>进行控制。</p> </li><li><p>支持应用动态选择是否进行页面栈恢复（默认进行页面栈信息恢复）。</p> <p>如应用希望自定义迁移到其他设备后显示的页面，则可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantconstant#params" target="_blank">wantConstant.Params</a>进行控制。</p> </li><li><p>支持应用动态选择流转成功后是否退出迁移源端应用（默认流转成功后退出迁移源端应用）。则可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantconstant" target="_blank">@ohos.app.ability.wantConstant (wantConstant)</a>进行控制。</p> </li></ul> <div class="tiledSection"><h2 id="section17575828642">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section17575828642" tips="复制节点链接"></i></h2><p>需同时满足以下条件，才能使用该功能：</p> <ul><li><strong>设备限制</strong><p>HarmonyOS NEXT Developer Preview0及以上版本的设备。</p> </li><li><strong>使用限制</strong><ul><li>双端设备需要登录同一华为账号。</li><li>双端设备需要打开 WLAN 和蓝牙开关，或者在设置中的“多设备协同 &gt; 高级”中启用“多设备协同增强服务”功能。</li><li>双端设备需要在“设置”应用中开启“多设备协同 &gt; 接续”功能。</li><li>双端设备都需要安装该应用。</li><li>为了接续体验，在onContinue回调中使用wantParam传输的数据需要控制在100KB以下，大数据量请使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/sync-app-data-across-devices-overview" target="_blank">分布式数据对象</a>进行同步。</li></ul> </li></ul> </div> <div class="tiledSection"><h2 id="section81721582916">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section81721582916" tips="复制节点链接"></i></h2><p>以下为实现应用接续的主要接口，详细的接口说明可查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">参考文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.1" valign="top" width="50%"><p><strong>接口名</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.2" valign="top" width="50%"><p><strong>描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>onContinue(wantParam : {[key: string]: Object}): OnContinueResult</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>接续源端在该回调中保存迁移所需要的数据，同时返回是否同意迁移：</p> <ul><li>AGREE：表示同意。</li><li>REJECT：表示拒绝，如应用在onContinue中异常可以直接REJECT。</li><li>MISMATCH：表示版本不匹配，接续源端应用可以在onContinue中获取到迁移对端应用的版本号，进行协商后，如果版本不匹配导致无法迁移，可以返回该错误。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>onCreate(want: Want, param: AbilityConstant.LaunchParam): void;</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>接续目的端为冷启动或多实例应用热启动时，在该回调中完成数据恢复，并触发页面恢复。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>onNewWant(want: Want, launchParams: AbilityConstant.LaunchParam): void;</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>接续目的端为单实例应用热启动时，在该回调中完成数据恢复，并触发页面恢复。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1881084093211">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1881084093211" tips="复制节点链接"></i></h2><ol><li><span>启用应用接续能力。</span><p></p><p>在module.json5文件的abilities中，将continuable标签配置为“true”，表示该UIAbility可被迁移。配置为false的UIAbility将被系统识别为无法迁移且该配置默认值为false。</p> <div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    ...</li><li>    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        ...</li><li>        <span class="hljs-attr">"continuable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p></p></li><li><span>根据需要配置应用启动模式类型，配置详情请参照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-launch-type" target="_blank">UIAbility组件启动模式</a>。</span></li><li><span>在源端UIAbility中实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#oncontinue" target="_blank">onContinue()</a>接口。</span><p></p><p>当应用触发迁移时，onContinue()接口在源端被调用，开发者可以在该接口中保存迁移数据，实现应用兼容性检测，决定是否支持此次迁移。</p> <ol><li>保存迁移数据：开发者可以将要迁移的数据通过键值对的方式保存在wantParam中。</li><li>（可选）检测应用兼容性：开发者可以在触发迁移时从onContinue()入参wantParam.version获取到迁移对端应用的版本号，与迁移源端应用版本号做兼容校验。应用在校验版本兼容性失败后，需要提示用户迁移失败的原因。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果迁移过程中的兼容性问题对于应用迁移体验影响较小或无影响，可以跳过该步骤。</p> </div></div></div> </li><li>返回迁移结果：开发者可以通过onContinue()回调的返回值决定是否支持此次迁移，接口返回值详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilityconstant#oncontinueresult" target="_blank">AbilityConstant.OnContinueResult</a>。</li></ol> <ul><li><p>onContinue()接口传入的wantParam参数中，有部分字段由系统预置，开发者可以使用这些字段用于业务处理。同时，应用在保存自己的wantParam参数时，也应注意不要使用同样的key值，避免被系统覆盖导致数据获取异常。详见下表：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.3.2.3.1.2.1.3.1.1" valign="top" width="50%"><p>字段</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.3.2.3.1.2.1.3.1.2" valign="top" width="50%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>version</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>对端应用的版本号</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>targetDevice</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>对端设备的networkId</p> </td> </tr>  </tbody></table></div> </div> </li></ul> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L17-L200" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { promptAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onContinue</span>(<span class="hljs-params">wantParam: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>    <span class="hljs-keyword">const</span> targetVersion = wantParam.<span class="hljs-property">version</span>; <span class="hljs-comment">// 获取迁移对端应用的版本号</span></li><li>    <span class="hljs-comment">// 应用可根据源端版本号设置支持接续的最小兼容版本号，源端版本号可从app.json5文件中的versionCode字段获取；防止目标端版本号过低导致不兼容。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">versionThreshold</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 替换为应用自己支持兼容的最小版本号</span></li><li>    <span class="hljs-comment">// 兼容性校验</span></li><li>    <span class="hljs-keyword">if</span> (targetVersion &lt; versionThreshold) {</li><li>      <span class="hljs-comment">// 建议在校验版本兼容性失败后，提示用户拒绝迁移的原因</span></li><li>      promptAction.<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-attr">message</span>: <span class="hljs-string">'目标端应用版本号过低，不支持接续，请您升级应用版本后再试'</span>,</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span></li><li>      })</li><li>      <span class="hljs-comment">// 在兼容性校验不通过时返回MISMATCH</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnContinueResult</span>.<span class="hljs-property">MISMATCH</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onContinue version = <span class="hljs-subst">${wantParam.version}</span>, targetDevice: <span class="hljs-subst">${wantParam.targetDevice}</span>`</span>)</li><li>    <span class="hljs-comment">// 迁移数据保存</span></li><li>    <span class="hljs-keyword">const</span> continueInput = <span class="hljs-string">'迁移的数据'</span>;</li><li>    <span class="hljs-keyword">if</span> (continueInput) {</li><li>      <span class="hljs-comment">// 将要迁移的数据保存在wantParam的自定义字段（如：data）中;</span></li><li>      wantParam[<span class="hljs-string">'data'</span>] = continueInput;</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnContinueResult</span>.<span class="hljs-property">AGREE</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L17-L200" target="_blank">EntryAbility.ets</a></div></div></div></div> <p></p></li><li><span>在Stage模型中，应用在不同启动模式下将调用不同的接口，以恢复数据、加载界面。</span><p></p><p>不同情况下的函数调用如下图所示：</p> <p><span><img height="347.410364" originheight="397" originwidth="896" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115117.02485266599189936455554711668264:50001231000000:2800:F380C6ABD82DB80B7062B754FD4AF70B6CD53216A3ED3744CD41BACD0FD04910.png" title="点击放大" width="771.1982390000001"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ol><li>在应用迁移启动时，无论是冷启动还是热启动，都会在执行完onCreate()/onNewWant()后，触发onWindowStageRestore()生命周期函数，不执行onWindowStageCreate()生命周期函数。</li><li>开发者如果在onWindowStageCreate()中进行了一些应用启动时必要的初始化，那么迁移后需要在onWindowStageRestore()中执行同样的初始化操作，避免应用异常。</li></ol> </div></div></div> <div class="p">在目的端设备UIAbility中实现onCreate()与onNewWant()接口，恢复迁移数据。<ul><li>onCreate实现示例<ul><li><p>目的端设备上，在onCreate中根据launchReason判断该次启动是否为迁移LaunchReason.CONTINUATION。</p> </li><li><p>开发者可以从want中获取保存的迁移数据。</p> </li><li><p>若开发者使用系统页面栈恢复功能，则需要在onCreate()/onNewWant()执行完成前，调用restoreWindowStage()，来触发带有页面栈的页面恢复，如果不需要迁移页面栈可以参考<a href="/consumer/cn/doc/harmonyos-guides/app-continuation-guide#section34254151518">按需迁移页面栈</a>部分。</p> </li></ul> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L18-L201" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> === <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">CONTINUATION</span>) {</li><li>      <span class="hljs-comment">// 将上述的保存的数据取出恢复</span></li><li>      <span class="hljs-keyword">let</span> continueInput = <span class="hljs-string">''</span>;</li><li>      <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span> !== <span class="hljs-literal">undefined</span>) {</li><li>        continueInput = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(want.<span class="hljs-property">parameters</span>.<span class="hljs-property">data</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`continue input <span class="hljs-subst">${continueInput}</span>`</span>)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// 触发页面恢复</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L18-L201" target="_blank">EntryAbility.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>接口restoreWindowStage(this.storage)必须在同步接口方法中执行，如果在异步回调中执行，可能会导致应用迁移后页面加载失败。</p> </div></div></div> </li><li>如果是单实例应用，需要额外实现onNewWant()接口，实现方式与onCreate()的实现相同。<p>在onNewWant()中判断迁移场景，恢复数据，并触发页面恢复</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L19-L202" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`EntryAbility onNewWant <span class="hljs-subst">${AbilityConstant.LaunchReason.CONTINUATION}</span>`</span>)</li><li>    <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> === <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">CONTINUATION</span>) {</li><li>      <span class="hljs-comment">// 将上述的保存的数据取出恢复</span></li><li>      <span class="hljs-keyword">let</span> continueInput = <span class="hljs-string">''</span>;</li><li>      <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span> !== <span class="hljs-literal">undefined</span>) {</li><li>        continueInput = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(want.<span class="hljs-property">parameters</span>.<span class="hljs-property">data</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`continue input <span class="hljs-subst">${continueInput}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L19-L202" target="_blank">EntryAbility.ets</a></div></div></div></div> </li></ul> </div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section153010192393">迁移功能可选配置<i class="anchor-icon anchor-icon-link" anchorid="section153010192393" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19762132643912" class="firsth2">动态配置迁移能力<i class="anchor-icon anchor-icon-link" anchorid="section19762132643912" tips="复制节点链接"></i></h3><p>从API version 10起，提供了支持动态配置迁移能力的功能。即应用可以根据实际使用场景，在需要迁移功能时，设置开启应用迁移能力；在业务不需要迁移时，则可以关闭迁移能力。开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#setmissioncontinuestate10" target="_blank">setMissionContinueState</a>接口对迁移能力进行设置。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.3.1.3.1.1" valign="top" width="50%"><p>接口状态值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.3.1.3.1.2" valign="top" width="50%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>AbilityConstant.ContinueState.ACTIVE</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>应用当前可迁移能力开启</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>AbilityConstant.ContinueState.INACTIVE</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>应用当前可迁移能力关闭</p> </td> </tr>  </tbody></table></div> </div> <p><strong>设置迁移能力的时机</strong></p> <p>默认状态下，应用的迁移能力为ACTIVE状态，即可以迁移。</p> <p>如果需要实现某些特殊场景，比如只在具体某个页面下支持迁移，或者只在某个事件发生时才支持迁移，可以按照如下步骤进行配置。</p> <ol><li>在Ability的onCreate生命周期回调中，关闭迁移能力。<div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L20-L203" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">INACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setMissionContinueState: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);</li><li>      });</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L20-L203" target="_blank">EntryAbility.ets</a></div></div></div></div> </li></ol><ol start="2"><li>如果需要在具体某个页面中打开迁移能力，可以在该页面的onPageShow()函数中设置。<div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/continue/PageName.ets#L17-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PageName</span> {</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 进入该页面时，将应用设置为可迁移状态</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">ACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setMissionContinueState ACTIVE result: '</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/continue/PageName.ets#L17-L72" target="_blank">PageName.ets</a></div></div></div></div> </li></ol><ol start="3"><li>如果在某个组件的触发事件中打开迁移能力，可以在该事件中设置。下面以<strong>Button</strong>组件的<strong>onClick</strong>事件为例进行介绍。<div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/continue/PageName.ets#L18-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PageName</span> {</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-title class_">Button</span>($r(<span class="hljs-string">'app.string.setMissionContinueState_active'</span>)).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">//点击该按钮时，将应用设置为可迁移状态</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">ACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setMissionContinueState ACTIVE result: '</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>        });</li><li>      })</li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/continue/PageName.ets#L18-L73" target="_blank">PageName.ets</a></div></div></div></div> </li></ol> <p><strong>保证迁移连续性</strong></p> <p>由于迁移加载时，目标端拉起的应用可能执行过自己的迁移状态设置命令（如：冷启动时目标端在onCreate中设置了<strong>INACTIVE</strong>；热启动时对端已打开了不可迁移的页面，迁移状态为<strong>INACTIVE</strong>等情况）。为了保证迁移过后的应用依然具有可以迁移回源端的能力，应在onCreate和onNewWant的迁移调用判断中，将迁移状态设置为<strong>ACTIVE</strong>。</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L21-L204" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 迁移冷启动时，设置状态为可迁移</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">ACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setMissionContinueState: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 迁移热启动时，设置状态为可迁移</span></li><li>    <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> === <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">CONTINUATION</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">ACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setMissionContinueState ACTIVE result: '</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>      });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L21-L204" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section34254151518">按需迁移页面栈<i class="anchor-icon anchor-icon-link" anchorid="section34254151518" tips="复制节点链接"></i></h3><p>支持应用动态选择是否进行页面栈恢复（默认进行页面栈信息恢复）。如果应用不想使用系统默认恢复的页面栈，则可以设置不进行页面栈迁移，而需要在onWindowStageRestore设置迁移后进入的页面，参数定义见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantconstant#params" target="_blank">SUPPORT_CONTINUE_PAGE_STACK_KEY</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ol><li>当前仅支持router路由的页面栈信息自动恢复，暂不支持navigation路由的页面栈自动恢复。</li><li>如果应用使用navigation路由，可以设置不进行页面栈迁移，并将需要接续的页面（或页面栈）信息保存在want中传递，然后在目标端手动加载指定页面。</li></ol> </div></div></div> <p>应用在源端的页面栈中存在Index和Second路由，而在目标端恢复时不需要按照源端页面栈进行恢复，需要恢复到指定页面。</p> <p>示例：应用迁移不需要自动迁移页面栈信息</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L22-L205" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">import</span> { promptAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onContinue</span>(<span class="hljs-params">wantParam: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onContinue version = <span class="hljs-subst">${wantParam.version}</span>, targetDevice: <span class="hljs-subst">${wantParam.targetDevice}</span>`</span>);</li><li>    wantParam[wantConstant.<span class="hljs-property">Params</span>.<span class="hljs-property">SUPPORT_CONTINUE_PAGE_STACK_KEY</span>] = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnContinueResult</span>.<span class="hljs-property">AGREE</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageRestore</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-comment">// 若不需要自动迁移页面栈信息，则需要在此处设置应用迁移后进入的页面</span></li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'continue/PageName'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in loading the content. Data: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) ?? <span class="hljs-string">''</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L22-L205" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section976341819443">按需退出<i class="anchor-icon anchor-icon-link" anchorid="section976341819443" tips="复制节点链接"></i></h3><p>支持应用动态选择迁移成功后是否退出迁移源端应用（默认迁移成功后退出迁移源端应用）。如果应用不想让系统自动退出迁移源端应用，则可以设置不退出，参数定义见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantconstant#params" target="_blank">SUPPORT_CONTINUE_SOURCE_EXIT_KEY</a>。</p> <p>示例：应用迁移设置不需要迁移成功后退出迁移源端应用</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L23-L206" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span>, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onContinue</span>(<span class="hljs-params">wantParam: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onContinue version = <span class="hljs-subst">${wantParam.version}</span>, targetDevice: <span class="hljs-subst">${wantParam.targetDevice}</span>`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>    wantParam[wantConstant.<span class="hljs-property">Params</span>.<span class="hljs-property">SUPPORT_CONTINUE_SOURCE_EXIT_KEY</span>] = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">OnContinueResult</span>.<span class="hljs-property">AGREE</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/entryability/EntryAbility.ets#L23-L206" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section71450211617">支持同应用中不同Ability跨端迁移<i class="anchor-icon anchor-icon-link" anchorid="section71450211617" tips="复制节点链接"></i></h3></div> <p>一般情况下，跨端迁移的双端是同Ability之间，但有些应用在不同设备类型下的同一个业务Ability名称不同（即异Ability），为了支持该场景下的两个Ability之间能够完成迁移，可以通过在module.json5文件的abilities标签中配置迁移类型continueType进行关联。 需要迁移的两个Ability的continueType字段取值必须保持一致，示例如下：</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>continueType在本应用中要保证唯一，字符串以字母、数字和下划线组成，最大长度127个字节，不支持中文。</li><li>continueType标签类型为字符串数组，如果配置了多个字段，当前仅第一个字段会生效。</li></ul> </div></div></div> <div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 设备A</span></li><li>   {</li><li>     <span class="hljs-string">"module"</span>: {</li><li>       <span class="hljs-comment">// ...</span></li><li>       <span class="hljs-string">"abilities"</span>: [</li><li>         {</li><li>           <span class="hljs-comment">// ...</span></li><li>           <span class="hljs-string">"name"</span>: <span class="hljs-string">"Ability-deviceA"</span>,</li><li>           <span class="hljs-string">"continueType"</span>: [<span class="hljs-string">'continueType1'</span>], <span class="hljs-comment">// continueType标签配置</span></li><li>         }</li><li>       ]</li><li>     }</li><li>   }</li><li>
</li><li>   <span class="hljs-comment">// 设备B</span></li><li>   {</li><li>     <span class="hljs-string">"module"</span>: {</li><li>       <span class="hljs-comment">// ...</span></li><li>       <span class="hljs-string">"abilities"</span>: [</li><li>         {</li><li>           <span class="hljs-comment">// ...</span></li><li>           <span class="hljs-string">"name"</span>: <span class="hljs-string">"Ability-deviceB"</span>,</li><li>           <span class="hljs-string">"continueType"</span>: [<span class="hljs-string">'continueType1'</span>], <span class="hljs-comment">// 与设备A相同的continueType标签</span></li><li>         }</li><li>       ]</li><li>     }</li><li>   }</li></ol></pre></div></div> <div class="tiledSection"><h3 id="section19162158174714">支持同应用不同BundleName的Ability跨端迁移<i class="anchor-icon anchor-icon-link" anchorid="section19162158174714" tips="复制节点链接"></i></h3><p>相同应用在不同设备类型下可能使用了不同的BundleName，该场景下如果需要支持应用跨端迁移，需要在不同BundleName的应用的module.json5配置文件中的abilities标签进行如下配置：</p> <ul><li>continueBundleName字段：分别添加对端应用的BundleName。</li><li>continueType字段：必须保持一致。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>continueType在本应用中要保证唯一，字符串以字母、数字和下划线组成，最大长度127个字节，不支持中文。</li><li>continueType标签类型为字符串数组，如果配置了多个字段，当前仅第一个字段会生效。</li></ul> </div></div></div> </li></ul> <p>示例如下：</p> <div class="p">不同BundleName的相同应用在设备A和设备B之间相互迁移，设备A应用的BundleName为com.demo.example1，设备B应用的BundleName为com.demo.example2。<div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在设备A的应用配置文件中，continueBundleName字段配置包含设备B上应用的BundleName。</span></li><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-string">"continueType"</span>: [<span class="hljs-string">'continueType'</span>], </li><li>        <span class="hljs-string">"continueBundleName"</span>: [<span class="hljs-string">"com.demo.example2"</span>], <span class="hljs-comment">// continueBundleName标签配置，com.demo.example2为设备B上应用的BundleName。</span></li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> <div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在设备B的应用配置文件中，continueBundleName字段配置包含设备A上应用的BundleName。</span></li><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-string">"continueType"</span>: [<span class="hljs-string">'continueType'</span>], </li><li>        <span class="hljs-string">"continueBundleName"</span>: [<span class="hljs-string">"com.demo.example1"</span>], <span class="hljs-comment">// continueBundleName标签配置，com.demo.example1为设备A上应用的BundleName。</span></li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h3 id="section693816163171">快速启动目标应用<i class="anchor-icon anchor-icon-link" anchorid="section693816163171" tips="复制节点链接"></i></h3><p>默认情况下，发起迁移后不会立即拉起对端的目标应用，而是等待迁移数据从源端传输到对端后才会拉起应用。若应用希望在用户发起接续后立即被拉起，减少等待时间，提升体验，可以在module.json5文件的continueType标签中添加“_ContinueQuickStart”后缀，配置快速启动目标应用能力。示例如下：</p> <div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-regexp">//</span> ...</li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-regexp">//</span> ...</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span></li><li>        <span class="hljs-string">"continueType"</span>: [<span class="hljs-string">'EntryAbility_ContinueQuickStart'</span>], <span class="hljs-regexp">//</span> 如果已经配置了continueType标签，可以在该标签值后添加<span class="hljs-string">'_ContinueQuickStart'</span>后缀；如果没有配置continueType标签，可以使用AbilityName + <span class="hljs-string">'_ContinueQuickStart'</span>作为continueType标签实现快速拉起目标应用</li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <p>配置了快速拉起的应用，在用户发起接续时会立即收到一次launchReason为提前拉起（PREPARE_CONTINUATION）的onCreate()/onNewWant()请求，随后再收到一次launchReason为接续拉起（CONTINUATION）的onNewWant()请求。如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.18.1.4.1.1" valign="top" width="33.333333333333336%"><p>场景</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.18.1.4.1.2" valign="top" width="33.333333333333336%"><p>生命周期函数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.18.1.4.1.3" valign="top" width="33.333333333333336%"><p>launchParam.launchReason</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>第一次启动请求</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>onCreate (冷启动)</p> <p>或 onNewWant (热启动)</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>AbilityConstant.LaunchReason.PREPARE_CONTINUATION</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>第二次启动请求</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>onNewWant</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>AbilityConstant.LaunchReason.CONTINUATION</p> </td> </tr>  </tbody></table></div> </div> <p><span><img originheight="433" originwidth="671" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115118.46504731215187744319061671655258:50001231000000:2800:77E9EA0AD3A95236467471B9DF38C09BE2EC84CE0FB7924093F9CD37FCBB489A.png" width="671" height="433"></span></p> <p>如果没有配置快速拉起，则触发迁移时只会收到一次启动请求：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.1" valign="top" width="33.333333333333336%"><p>场景</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.2" valign="top" width="33.333333333333336%"><p>生命周期函数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.3" valign="top" width="33.333333333333336%"><p>launchParam.launchReason</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>一次启动请求</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>onCreate (冷启动)</p> <p>或 onNewWant (热启动)</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>AbilityConstant.LaunchReason.CONTINUATION</p> </td> </tr>  </tbody></table></div> </div> <p>配置快速拉起后，对应的 onCreate()/onNewWant() 接口实现可参考如下示例：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_quickstart/MigrationAbility_quickStart.ets#L17-L119" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">AbilityConstant</span>, <span class="hljs-variable">UIAbility</span>, <span class="hljs-variable">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'[MigrationAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">DOMAIN_NUMBER</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility_quickStart</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">UIAbility</span> {</li><li>  <span class="hljs-variable">storage</span> : <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">LocalStorage</span>();</li><li>
</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 1.已配置快速拉起功能，应用立即启动时触发应用生命周期回调</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">launchParam</span>.<span class="hljs-variable">launchReason</span> === <span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">LaunchReason</span>.<span class="hljs-variable">PREPARE_CONTINUATION</span>) {</li><li>      <span class="hljs-comment">//若应用迁移数据较大，可在此处添加加载页面(页面中显示loading等)</span></li><li>      <span class="hljs-comment">//可处理应用自定义跳转、时序等问题</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'onNewWant'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 1.已配置快速拉起功能，应用立即启动时触发应用生命周期回调</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">launchParam</span>.<span class="hljs-variable">launchReason</span> === <span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">LaunchReason</span>.<span class="hljs-variable">PREPARE_CONTINUATION</span>) {</li><li>      <span class="hljs-comment">//若应用迁移数据较大，可在此处添加加载页面(页面中显示loading等)</span></li><li>      <span class="hljs-comment">//可处理应用自定义跳转、时序等问题</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2.迁移数据恢复时触发应用生命周期回调</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">launchParam</span>.<span class="hljs-variable">launchReason</span> === <span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">LaunchReason</span>.<span class="hljs-variable">CONTINUATION</span>) {</li><li>      <span class="hljs-comment">// 将上述保存的数据从want.parameters中取出恢复</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">continueInput</span> = <span class="hljs-string">''</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">want</span>.<span class="hljs-variable">parameters</span> !== <span class="hljs-variable">undefined</span>) {</li><li>        <span class="hljs-variable">continueInput</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">want</span>.<span class="hljs-variable">parameters</span>.<span class="hljs-variable">data</span>);</li><li>        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-keyword">continue</span> <span class="hljs-variable">input</span> ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">continueInput</span>)}`);</li><li>      }</li><li>      <span class="hljs-comment">// 触发页面恢复</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">storage</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_quickstart/MigrationAbility_quickStart.ets#L17-L119" target="_blank">MigrationAbility_quickStart.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section14877369451">使用分布式数据对象迁移数据<i class="anchor-icon anchor-icon-link" anchorid="section14877369451" tips="复制节点链接"></i></h2><p>当需要迁移的数据较大（100KB以上）或需要迁移文件时，可以使用分布式数据对象。原理与接口说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-sync-of-distributed-data-object" target="_blank">分布式数据对象跨设备数据同步</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>自API 12起，由于直接使用跨设备文件访问实现文件的迁移，难以获取文件同步完成的时间。为了保证更高的成功率，文件的迁移不建议继续通过该方式实现，推荐使用分布式数据对象携带资产的方式。开发者此前通过跨设备文件访问实现的文件迁移依然生效。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section15931414230" class="firsth2">申请权限<i class="anchor-icon anchor-icon-link" anchorid="section15931414230" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>自API 12起，无需申请ohos.permission.DISTRIBUTED_DATASYNC权限。</li><li>API 11及以前版本，需要执行如下操作。</li></ul> </div></div></div> <ol><li>声明ohos.permission.DISTRIBUTED_DATASYNC权限，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。</li><li>由于ohos.permission.DISTRIBUTED_DATASYNC权限需要用户授权，应用需在首次启动、或进入接续页面时弹窗向用户申请授权，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization" target="_blank">向用户申请授权</a>。</li></ol> </div> <div class="tiledSection"><h3 id="section1930143018512">基础数据迁移<i class="anchor-icon anchor-icon-link" anchorid="section1930143018512" tips="复制节点链接"></i></h3><p>使用分布式数据对象，与上述开发步骤类似，需要在源端onContinue()接口中进行数据保存，并在对端的onCreate()/onNewWant()接口中进行数据恢复。</p> <ol><li><span>在源端UIAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#oncontinue" target="_blank">onContinue()</a>接口中创建分布式数据对象并保存数据，执行流程如下：</span><p></p><ol><li>在onContinue()接口中使用create()接口创建分布式数据对象，将所要迁移的数据填充到分布式数据对象数据中。</li><li>调用genSessionId()接口生成数据对象组网id，并使用该id调用setSessionId()加入组网，激活分布式数据对象。</li><li>使用save()接口将已激活的分布式数据对象持久化，确保源端退出后对端依然可以获取到数据。</li><li>将生成的sessionId通过want传递到对端，供对端激活同步使用。</li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>分布式数据对象需要先激活，再持久化，因此必须在调用setSessionId()后再调用save()接口。</li><li>对于源端迁移后需要退出的应用，为了防止数据未保存完成应用就退出，应采用await的方式等待save()接口执行完毕。从API 12 起，onContinue()接口提供了async版本供该场景使用。</li><li>当前，wantParams中“sessionId”字段在迁移流程中被系统占用，建议开发者在wantParams中定义其他key值存储该分布式数据对象生成的id，避免数据异常。</li></ul> </div></div></div> <p>示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability/MigrationAbility.ets#L17-L204" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">UIAbility</span>, <span class="hljs-variable">AbilityConstant</span>, <span class="hljs-variable">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">distributedDataObject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'[MigrationAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">DOMAIN_NUMBER</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// 业务数据定义</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentObject</span> {</li><li>  <span class="hljs-variable">mother</span>: <span class="hljs-title class_">string</span></li><li>  <span class="hljs-variable">father</span>: <span class="hljs-title class_">string</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">mother</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">father</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">mother</span> = <span class="hljs-variable">mother</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">father</span> = <span class="hljs-variable">father</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 支持字符、数字、布尔值、对象的传递</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SourceObject</span> {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">isVis</span>: <span class="hljs-title class_">boolean</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">parent</span>: <span class="hljs-title class_">ParentObject</span> | <span class="hljs-title class_">undefined</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">isVis</span>: <span class="hljs-title class_">boolean</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">parent</span>: <span class="hljs-title class_">ParentObject</span> | <span class="hljs-title class_">undefined</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">name</span> = <span class="hljs-variable">name</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">age</span> = <span class="hljs-variable">age</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">isVis</span> = <span class="hljs-variable">isVis</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">parent</span> = <span class="hljs-variable">parent</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">UIAbility</span> {</li><li>  <span class="hljs-variable">d_object</span>?: <span class="hljs-title class_">distributedDataObject</span>.<span class="hljs-title class_">DataObject</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">onContinue</span>(<span class="hljs-variable">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">OnContinueResult</span>&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">parentSource</span>: <span class="hljs-title class_">ParentObject</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ParentObject</span>(<span class="hljs-string">'jack mom'</span>, <span class="hljs-string">'jack Dad'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">source</span>: <span class="hljs-title class_">SourceObject</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SourceObject</span>(<span class="hljs-string">'jack'</span>, <span class="hljs-number">18</span>, <span class="hljs-keyword">false</span>, <span class="hljs-variable">parentSource</span>);</li><li>
</li><li>    <span class="hljs-comment">// 创建分布式数据对象</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">d_object</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">source</span>);</li><li>
</li><li>    <span class="hljs-comment">// 生成数据对象组网id，激活分布式数据对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dataSessionId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">genSessionId</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">d_object</span>.<span class="hljs-title function_">setSessionId</span>(<span class="hljs-variable">dataSessionId</span>);</li><li>
</li><li>    <span class="hljs-comment">// 将组网id存在want中传递到对端</span></li><li>    <span class="hljs-variable">wantParam</span>[<span class="hljs-string">'dataSessionId'</span>] = <span class="hljs-variable">dataSessionId</span>;</li><li>
</li><li>    <span class="hljs-comment">// 数据对象持久化，确保迁移后即使应用退出，对端依然能够恢复数据对象</span></li><li>    <span class="hljs-comment">// 从wantParam.targetDevice中获取到对端设备的networkId作为入参</span></li><li>    <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">d_object</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable">wantParam</span>.<span class="hljs-variable">targetDevice</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">result</span>:</li><li>      <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-variable">SaveSuccessResponse</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Succeeded</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">saving</span>. <span class="hljs-variable">SessionId</span>: ${<span class="hljs-variable">result</span>.<span class="hljs-variable">sessionId</span>},</li><li>        <span class="hljs-variable">version</span>:${<span class="hljs-variable">result</span>.<span class="hljs-variable">version</span>}, <span class="hljs-variable">deviceId</span>:${<span class="hljs-variable">result</span>.<span class="hljs-variable">deviceId</span>}`);</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'Failed to save. Error: '</span>, <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>) ?? <span class="hljs-string">''</span>);</li><li>    });</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability/MigrationAbility.ets#L17-L204" target="_blank">MigrationAbility.ets</a></div></div></div></div> <p></p> <p></p></li><li><span>在对端UIAbility的onCreate()/onNewWant()中，通过加入与源端一致的分布式数据对象组网进行数据恢复。</span><p></p><ol><li>创建空的分布式数据对象，用于接收恢复的数据；</li><li>从want中读取分布式数据对象组网id；</li><li>注册on()接口监听数据变更。在收到status为restore的事件的回调中，实现数据恢复完毕时需要进行的业务操作。</li><li>调用setSessionId()加入组网，激活分布式数据对象。</li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>对端加入组网的分布式数据对象不能为临时变量，因为在分布式数据对象on()接口为异步回调，可能在onCreate()/onNewWant()执行结束后才执行，临时变量被释放可能导致空指针异常。可以使用类成员变量避免该问题。</li><li>对端用于创建分布式数据对象的Object，其属性应在激活分布式数据对象前置为undefined，否则会导致新数据加入组网后覆盖源端数据，数据恢复失败。</li><li>应当在激活分布式数据对象之前，调用分布式数据对象的on()接口进行注册监听，防止错过restore事件导致数据恢复失败。</li></ul> </div></div></div> <p>示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability/MigrationAbility.ets#L18-L205" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { distributedDataObject } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MigrationAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// 示例数据对象定义与上同</span></li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  d_object?: distributedDataObject.<span class="hljs-property">DataObject</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> === <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">CONTINUATION</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// 调用封装好的分布式数据对象处理函数</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDistributedData</span>(want);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (launchParam.<span class="hljs-property">launchReason</span> === <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchReason</span>.<span class="hljs-property">CONTINUATION</span>) {</li><li>      <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span> !== <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// 调用封装好的分布式数据对象处理函数</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDistributedData</span>(want);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">handleDistributedData</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-comment">// 创建空的分布式数据对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">remoteSource</span>: <span class="hljs-title class_">SourceObject</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SourceObject</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span> = distributedDataObject.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, remoteSource);</li><li>
</li><li>    <span class="hljs-comment">// 读取分布式数据对象组网id</span></li><li>    <span class="hljs-keyword">let</span> dataSessionId = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span> !== <span class="hljs-literal">undefined</span>) {</li><li>      dataSessionId = want.<span class="hljs-property">parameters</span>.<span class="hljs-property">dataSessionId</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 添加数据变更监听</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'status'</span>, <span class="hljs-function">(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, networkId: <span class="hljs-built_in">string</span>, status: <span class="hljs-string">'online'</span> | <span class="hljs-string">'offline'</span> | <span class="hljs-string">'restored'</span></span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'status changed '</span> + sessionId + <span class="hljs-string">' '</span> + status + <span class="hljs-string">' '</span> + networkId);</li><li>      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'restored'</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>) {</li><li>          <span class="hljs-comment">// 收到迁移恢复的状态时，可以从分布式数据对象中读取数据</span></li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'restored name:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>[<span class="hljs-string">'name'</span>]);</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'restored parents:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>[<span class="hljs-string">'parent'</span>]));</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>      }</li><li>    });</li><li>    <span class="hljs-comment">// 激活分布式数据对象</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>.<span class="hljs-title function_">setSessionId</span>(dataSessionId);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability/MigrationAbility.ets#L18-L205" target="_blank">MigrationAbility.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section2163355101014">文件资产迁移<i class="anchor-icon anchor-icon-link" anchorid="section2163355101014" tips="复制节点链接"></i></h3></div> <p>对于图片、文档等文件类数据，需要先将其转换为资产commonType.Asset类型，再封装到分布式数据对象中进行迁移。迁移实现方式与普通的分布式数据对象类似，下面仅针对差异部分进行说明。</p> <ul><li>在源端，将需要迁移的文件资产保存到分布式数据对象DataObject中，执行流程如下：</li></ul> <ol><li>将文件资产拷贝到分布式文件目录下，相关接口与用法详见基础文件接口。</li><li>使用分布式文件目录下的文件创建Asset资产对象。</li><li>将Asset资产对象作为分布式数据对象的根属性保存。</li></ol> <p>随后，与普通数据对象的迁移的源端实现相同，可以使用该数据对象加入组网，并进行持久化保存。</p> <p>示例如下：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_asset/MigrationAbility_asset.ets#L17-L254" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">UIAbility</span>, <span class="hljs-variable">AbilityConstant</span>, <span class="hljs-variable">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">distributedDataObject</span>, <span class="hljs-variable">commonType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">fileIo</span>, <span class="hljs-variable">fileUri</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'[MigrationAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">DOMAIN_NUMBER</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// 数据对象定义</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentObject</span> {</li><li>  <span class="hljs-variable">mother</span>: <span class="hljs-title class_">string</span></li><li>  <span class="hljs-variable">father</span>: <span class="hljs-title class_">string</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">mother</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">father</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">mother</span> = <span class="hljs-variable">mother</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">father</span> = <span class="hljs-variable">father</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SourceObject</span> {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">isVis</span>: <span class="hljs-title class_">boolean</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">parent</span>: <span class="hljs-title class_">ParentObject</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">attachment</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> | <span class="hljs-title class_">undefined</span>  <span class="hljs-comment">// 新增资产属性</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">isVis</span>: <span class="hljs-title class_">boolean</span> | <span class="hljs-title class_">undefined</span>,</li><li>    <span class="hljs-variable">parent</span>: <span class="hljs-title class_">ParentObject</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">attachment</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> | <span class="hljs-title class_">undefined</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">name</span> = <span class="hljs-variable">name</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">age</span> = <span class="hljs-variable">age</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">isVis</span> = <span class="hljs-variable">isVis</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">parent</span> = <span class="hljs-variable">parent</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">attachment</span> = <span class="hljs-variable">attachment</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility_asset</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">UIAbility</span> {</li><li>  <span class="hljs-variable">d_object</span>?: <span class="hljs-title class_">distributedDataObject</span>.<span class="hljs-title class_">DataObject</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">onContinue</span>(<span class="hljs-variable">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">OnContinueResult</span>&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// 1. 将资产写入分布式文件目录下</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">distributedDir</span>: <span class="hljs-title class_">string</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">distributedFilesDir</span>;  <span class="hljs-comment">// 获取分布式文件目录路径</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fileName</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'/test.txt'</span>;                        <span class="hljs-comment">// 文件名</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">filePath</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">distributedDir</span> + <span class="hljs-variable">fileName</span>;          <span class="hljs-comment">// 文件路径</span></li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 在分布式目录下创建文件</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">filePath</span>, <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span> | <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">CREATE</span>);</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'Create file success.'</span>);</li><li>      <span class="hljs-comment">// 向文件中写入内容（若资产为图片，可将图片转换为buffer后写入）</span></li><li>      <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">writeSync</span>(<span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>, <span class="hljs-string">'[Sample] Insert file content here.'</span>);</li><li>      <span class="hljs-comment">// 关闭文件</span></li><li>      <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">DOMAIN_NUMBER</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">openSync</span> / <span class="hljs-variable">writeSync</span> / <span class="hljs-variable">closeSync</span>. <span class="hljs-variable">Code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2. 使用分布式文件目录下的文件创建资产对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">distributedUri</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable">filePath</span>); <span class="hljs-comment">// 获取分布式文件Uri</span></li><li>
</li><li>    <span class="hljs-comment">// 获取文件参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ctime</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mtime</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">size</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-variable">await</span> <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">stat</span>(<span class="hljs-variable">filePath</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">stat</span>: <span class="hljs-title class_">fileIo</span>.<span class="hljs-title class_">Stat</span>) =&gt; {</li><li>      <span class="hljs-variable">ctime</span> = <span class="hljs-variable">stat</span>.<span class="hljs-variable">ctime</span>.<span class="hljs-title function_">toString</span>();  <span class="hljs-comment">// 创建时间</span></li><li>      <span class="hljs-variable">mtime</span> = <span class="hljs-variable">stat</span>.<span class="hljs-variable">mtime</span>.<span class="hljs-title function_">toString</span>();  <span class="hljs-comment">// 修改时间</span></li><li>      <span class="hljs-variable">size</span> = <span class="hljs-variable">stat</span>.<span class="hljs-variable">size</span>.<span class="hljs-title function_">toString</span>();    <span class="hljs-comment">// 文件大小</span></li><li>    })</li><li>
</li><li>    <span class="hljs-comment">// 创建资产对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">attachment</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> = {</li><li>      <span class="hljs-variable">name</span>: <span class="hljs-title class_">fileName</span>,</li><li>      <span class="hljs-variable">uri</span>: <span class="hljs-title class_">distributedUri</span>,</li><li>      <span class="hljs-variable">path</span>: <span class="hljs-title class_">filePath</span>,</li><li>      <span class="hljs-variable">createTime</span>: <span class="hljs-title class_">ctime</span>,</li><li>      <span class="hljs-variable">modifyTime</span>: <span class="hljs-title class_">mtime</span>,</li><li>      <span class="hljs-variable">size</span>: <span class="hljs-title class_">size</span>,</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 3. 将资产对象作为分布式数据对象的根属性，创建分布式数据对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">parentSource</span>: <span class="hljs-title class_">ParentObject</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ParentObject</span>(<span class="hljs-string">'jack mom'</span>, <span class="hljs-string">'jack Dad'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">source</span>: <span class="hljs-title class_">SourceObject</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SourceObject</span>(<span class="hljs-string">'jack'</span>, <span class="hljs-number">18</span>, <span class="hljs-keyword">false</span>, <span class="hljs-variable">parentSource</span>, <span class="hljs-variable">attachment</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">d_object</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">source</span>);</li><li>
</li><li>    <span class="hljs-comment">// 生成组网id，激活分布式数据对象，save持久化保存</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_asset/MigrationAbility_asset.ets#L17-L254" target="_blank">MigrationAbility_asset.ets</a></div></div></div></div> <ul><li>对端需要先创建一个各属性为空的Asset资产对象作为分布式数据对象的根属性。在接收到on()接口status为restored的事件的回调时，表示包括资产在内的数据同步完成，可以像获取基本数据一样获取到源端的资产对象。</li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>对端创建分布式数据对象时，SourceObject对象中的资产不能直接使用undefined初始化，需要创建一个各属性为空的Asset资产对象，否则会导致资产同步失败。</p> </div></div></div> <p>示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_asset/MigrationAbility_asset.ets#L18-L255" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { distributedDataObject, commonType } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[MigrationAbility]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility_asset</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  d_object?: distributedDataObject.<span class="hljs-property">DataObject</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">handleDistributedData</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 创建一个各属性为空的资产对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">attachment</span>: commonType.<span class="hljs-property">Asset</span> = {</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">uri</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">createTime</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">modifyTime</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-attr">size</span>: <span class="hljs-string">''</span>,</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// 使用该空资产对象创建分布式数据对象，其余基础属性可以直接使用undefined</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">source</span>: <span class="hljs-title class_">SourceObject</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SourceObject</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, attachment);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span> = distributedDataObject.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, source);</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'status'</span>, <span class="hljs-function">(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, networkId: <span class="hljs-built_in">string</span>, status: <span class="hljs-string">'online'</span> | <span class="hljs-string">'offline'</span> | <span class="hljs-string">'restored'</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'restored'</span>) {</li><li>        <span class="hljs-comment">// 收到监听的restored回调，表示分布式资产对象同步完成</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>) {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'restored attachment:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">d_object</span>[<span class="hljs-string">'attachment'</span>]));</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>      }</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_asset/MigrationAbility_asset.ets#L18-L255" target="_blank">MigrationAbility_asset.ets</a></div></div></div></div> <p>若应用想要同步多个资产，可采用两种方式实现：</p> <ol><li>可将每个资产作为分布式数据对象的一个根属性实现，适用于要迁移的资产数量固定的场景。</li><li>可以将资产数组传化为Object传递，适用于需要迁移的资产个数会动态变化的场景（如用户选择了不定数量的图片）。当前不支持直接将资产数组作为根属性传递。</li></ol> <p>其中方式1的实现可以直接参照添加一个资产的方式添加更多资产。方式2的示例如下所示：</p> <div class="screenLinkPre"><div _ngcontent-nmk-c106="" class="highlight-div"><div _ngcontent-nmk-c106="" class="highlight-div-header"><div _ngcontent-nmk-c106="" class="highlight-div-header-left"><div _ngcontent-nmk-c106="" class="handle-button expand-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nmk-c106="" class="highlight-div-header-right"><div _ngcontent-nmk-c106="" class="handle-button ai-button"></div><div _ngcontent-nmk-c106="" class="handle-button line-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nmk-c106="" class="handle-button theme-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nmk-c106="" class="handle-button copy-button"><div _ngcontent-nmk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nmk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_multi_asset/MigrationAbility_multi_asset.ets#L17-L281" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">distributedDataObject</span>, <span class="hljs-variable">commonType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">UIAbility</span>, <span class="hljs-variable">AbilityConstant</span>, <span class="hljs-variable">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 数据对象定义</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SourceObject</span> {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span></li><li>  <span class="hljs-variable">assets</span>: <span class="hljs-title class_">Object</span> | <span class="hljs-title class_">undefined</span>  <span class="hljs-comment">// 分布式数据对象的中添加一个Object属性</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">assets</span>: <span class="hljs-title class_">Object</span> | <span class="hljs-title class_">undefined</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">name</span> = <span class="hljs-variable">name</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">assets</span> = <span class="hljs-variable">assets</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationAbility_multi_asset</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">UIAbility</span> {</li><li>  <span class="hljs-variable">d_object</span>?: <span class="hljs-title class_">distributedDataObject</span>.<span class="hljs-title class_">DataObject</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// 该函数用于将资产数组转为Record</span></li><li>  <span class="hljs-title function_">GetAssetsWrapper</span>(<span class="hljs-variable">assets</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Assets</span>): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">wrapper</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span>&gt; = {}</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">num</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">assets</span>.<span class="hljs-variable">length</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">num</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-variable">wrapper</span>[`<span class="hljs-variable">asset</span>${<span class="hljs-variable">i</span>}`] = <span class="hljs-variable">assets</span>[<span class="hljs-variable">i</span>];</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">wrapper</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">onContinue</span>(<span class="hljs-variable">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">OnContinueResult</span>&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// 创建多个资产对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">attachment1</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> = {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">attachment2</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> = {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 将资产对象插入资产数组</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">assets</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Assets</span> = [];</li><li>    <span class="hljs-variable">assets</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">attachment1</span>);</li><li>    <span class="hljs-variable">assets</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">attachment2</span>);</li><li>
</li><li>    <span class="hljs-comment">// 将资产数组转为Record Object，并用于创建分布式数据对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">assetsWrapper</span>: <span class="hljs-title class_">Object</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">GetAssetsWrapper</span>(<span class="hljs-variable">assets</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">source</span>: <span class="hljs-title class_">SourceObject</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SourceObject</span>(<span class="hljs-string">'jack'</span>, <span class="hljs-variable">assetsWrapper</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">d_object</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">source</span>);</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/DistributedAppDev/ContinueSample/entry/src/main/ets/migrationability_multi_asset/MigrationAbility_multi_asset.ets#L17-L281" target="_blank">MigrationAbility_multi_asset.ets</a></div></div></div></div> </div> <div></div></div>