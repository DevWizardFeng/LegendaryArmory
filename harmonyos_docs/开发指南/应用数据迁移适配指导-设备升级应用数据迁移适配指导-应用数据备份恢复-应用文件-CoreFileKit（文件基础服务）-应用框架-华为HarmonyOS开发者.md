<h1 _ngcontent-cjp-c119="" class="doc-title ng-star-inserted" title="应用数据迁移适配指导"> 应用数据迁移适配指导 </h1>

<div _ngcontent-cjp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7644202218474">环境准备<i class="anchor-icon anchor-icon-link" anchorid="section7644202218474" tips="复制节点链接"></i></h2></div> <p>开发者需要通过OTA升级的形式，将终端设备升级到HarmonyOS NEXT Developer Beta1及之后版本。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.1.4.1.1" valign="top" width="33.33333333333333%"><p>工具</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.4.1.2" valign="top" width="33.33333333333333%"><p>版本</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.4.1.3" valign="top" width="33.33333333333333%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>“迁移调试”工具</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>205.0.0.115及之后版本</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>模拟验证数据迁移</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>DevEco Studio</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>DevEco Studio NEXT Developer Beta3及之后版本</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-tools-overview" target="_blank">DevEco Studio使用指南</a></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>Compatible SDK</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>5.0.0(12)</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-releases/overview-allversion" target="_blank">版本说明</a></p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section581059113018">应用数据迁移适配流程<i class="anchor-icon anchor-icon-link" anchorid="section581059113018" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section183271523120" class="firsth2">创建新工程<i class="anchor-icon anchor-icon-link" anchorid="section183271523120" tips="复制节点链接"></i></h3><p>本章节从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-create-new-project" target="_blank">创建新工程</a>开始，指导开发者接入“备份恢复框架”，已经创建工程的开发者可以跳过本节。</p> </div> <div class="tiledSection"><h3 id="section184615294467">BackupExtensionAbility的实现<i class="anchor-icon anchor-icon-link" anchorid="section184615294467" tips="复制节点链接"></i></h3><p>开发者可以在BackupExtension.ts文件中自定义类继承BackupExtensionAbility，通过重写其中的onBackup和onRestore方法，自定义应用数据的转换和迁移。终端设备从HarmonyOS升级到HarmonyOS NEXT数据迁移场景中，onRestore回调接口中的参数<strong>bundleVersion.name</strong>的<strong>前缀</strong>为“<strong>0.0.0.0</strong>”。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p><strong>onRestore 接口是同步接口，其内部所有的异步操作请进行同步等待。</strong></p> </div></div></div> <p>以下步骤以空工程为例，介绍如何实现BackupExtensionAbility：</p> <ol><li><span>在<strong>entry/src/main/ets/</strong>目录下，点击 <strong>New &gt; Directory</strong> 创建<strong>backupExtension</strong>目录。</span><p></p><p><span><img height="534.2753395392403" originheight="597" originwidth="1028" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114929.12843673684897440440631214323210:50001231000000:2800:AC394B0D886F8B523774E6F4CFDB5A0E8B8F8D36308F9B80EEDD2779A6757308.png" title="点击放大" width="920"></span></p> <p></p></li><li><span>点击<strong>entry/src/main/ets/</strong><strong>backupExtension/</strong>目录，点击 <strong>New &gt; File</strong> 创建<strong>BackupExtension.ets</strong>文件。</span><p></p><p><span><img height="568.7858908852999" originheight="630" originwidth="1019" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114929.66158538545918372369386780469613:50001231000000:2800:5268650F335447C3CF5FE35EBD286E9E60559795FD6B0B141A3AADCE61AD8E5E.png" title="点击放大" width="920"></span></p> <p></p></li><li><span>参考示例代码实现BackupExtensionAbility，应用的数据转换和迁移逻辑，请在指定位置填充实现。</span><p></p><p>终端设备从HarmonyOS升级到HarmonyOS NEXT中，会将原有APK应用沙箱目录中文件放置到HarmonyOS备份恢复目录。对应关系详见<a href="/consumer/cn/doc/harmonyos-guides/app-data-migration-adaptation#section14434142512513">APK应用沙箱目录与备份恢复目录映射关系</a>。</p> <div class="screenLinkPre"><div _ngcontent-cjp-c106="" class="highlight-div"><div _ngcontent-cjp-c106="" class="highlight-div-header"><div _ngcontent-cjp-c106="" class="highlight-div-header-left"><div _ngcontent-cjp-c106="" class="handle-button expand-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjp-c106="" class="highlight-div-header-right"><div _ngcontent-cjp-c106="" class="handle-button ai-button"></div><div _ngcontent-cjp-c106="" class="handle-button line-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjp-c106="" class="handle-button theme-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjp-c106="" class="handle-button copy-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/OtaBackup/entry/src/main/ets/entrybackupability/EntryBackupAbility.ets#L2-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BackupExtensionAbility</span>, <span class="hljs-title class_">BundleVersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">`EntryBackupAbility`</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * serviceExt进程入口</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryBackupAbility</span> <span class="hljs-keyword">extends</span>  <span class="hljs-title class_ inherited__">BackupExtensionAbility</span> {</li><li>  <span class="hljs-keyword">async</span> onBackup () {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>,<span class="hljs-string">`onBackup ok`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 数据恢复处理接口。接口是同步接口，其内部所有的异步操作请进行同步等待。</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> bundleVersion 版本信息</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">async</span> onRestore (bundleVersion : <span class="hljs-title class_">BundleVersion</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onRestore ok <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(bundleVersion)}</span>`</span>);</li><li>    <span class="hljs-comment">//bundleVersion.name的前缀为“0.0.0.0”时，表示终端设备从HarmonyOS升级到HarmonyOS NEXT数据迁移场景</span></li><li>    <span class="hljs-keyword">if</span> (bundleVersion.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"0.0.0.0"</span>)){</li><li>      <span class="hljs-comment">// 在此处实现终端设备从HarmonyOS 4.x升级到HarmonyOS NEXT后，应用数据的转换和迁移</span></li><li>      <span class="hljs-comment">// 涉及异步操作请进行同步等待</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`HarmonyOS to HarmonyOS NEXT scenario`</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 在此处实现从HarmonyOS NEXT设备迁移到HarmonyOS NEXT设备后，应用数据的处理。无特殊要求，可以空实现</span></li><li>      <span class="hljs-comment">// 涉及异步操作请进行同步等待</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Other scenario`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/guide-snippets/blob/master/OtaBackup/entry/src/main/ets/entrybackupability/EntryBackupAbility.ets#L2-L33" target="_blank">EntryBackupAbility.ets</a></div></div></div></div> <div class="p"><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>1、单个应用设定的最长数据迁移时间为十五分钟，超过十五分钟还未完成应用数据迁移的应用，应用数据迁移会失败。</p> <p>2、应用的“BackupExtensionAbility”执行完后，“备份恢复框架”会清空备份恢复目录，开发者请在应用的“BackupExtensionAbility”执行结束前，完成所有所需数据的转换和迁移。</p> </div></div></div> </div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section2469293469">元数据资源配置文件适配<i class="anchor-icon anchor-icon-link" anchorid="section2469293469" tips="复制节点链接"></i></h3><p>开发者通过元数据资源配置文件backup_config.json，启用备份恢复，并定义备份恢复框架需要传输的文件。</p> <p>以下步骤以空工程为例，介绍如何配置元数据资源文件：</p> <ol><li><span>在<strong>entry/src/main/resources/base/</strong><strong>profile/</strong>目录下，点击 <strong>New &gt; File</strong> 创建<strong>backup_config.json</strong>文件。</span><p></p><p></p> <p></p></li><li><span>参考示例代码实现元数据资源文件配置。</span><p></p><div _ngcontent-cjp-c106="" class="highlight-div"><div _ngcontent-cjp-c106="" class="highlight-div-header"><div _ngcontent-cjp-c106="" class="highlight-div-header-left"><div _ngcontent-cjp-c106="" class="handle-button expand-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjp-c106="" class="highlight-div-header-right"><div _ngcontent-cjp-c106="" class="handle-button ai-button"></div><div _ngcontent-cjp-c106="" class="handle-button line-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjp-c106="" class="handle-button theme-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjp-c106="" class="handle-button copy-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class=""><span class="hljs-string">"allowToBackupRestore"</span></span>: <span class=""><span class="hljs-keyword">true</span></span>,</li><li>  <span class=""><span class="hljs-string">"extraInfo"</span></span>: {</li><li>    <span class=""><span class="hljs-string">"supportScene"</span></span>: [</li><li>      <span class=""><span class="hljs-string">"hmos2next"</span></span></li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section9477293469">module.json5适配<i class="anchor-icon anchor-icon-link" anchorid="section9477293469" tips="复制节点链接"></i></h3><p>开发者需要在应用配置文件module.json5中进行注册，其中注册类型type需要设置为backup，元数据信息metadata需要新增一个name为ohos.extension.backup的条目。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p><strong>extensionAbilities需要配置在entry内的module.json5才能正常访问。</strong></p> </div></div></div> <p>以下步骤以空工程为例，介绍如何配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#extensionabilities标签" target="_blank">module.json5</a>文件：</p> <ol><li><span>开发者需要在entry内的module.json5里面进行注册,参考示例代码实现元数据资源文件配置。</span><p></p><p></p> <div _ngcontent-cjp-c106="" class="highlight-div"><div _ngcontent-cjp-c106="" class="highlight-div-header"><div _ngcontent-cjp-c106="" class="highlight-div-header-left"><div _ngcontent-cjp-c106="" class="handle-button expand-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cjp-c106="" class="highlight-div-header-right"><div _ngcontent-cjp-c106="" class="handle-button ai-button"></div><div _ngcontent-cjp-c106="" class="handle-button line-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cjp-c106="" class="handle-button theme-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cjp-c106="" class="handle-button copy-button"><div _ngcontent-cjp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cjp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-string">"extensionAbilities"</span></span>: [</li><li>  {</li><li>    <span class=""><span class="hljs-string">"description"</span></span>: <span class=""><span class="hljs-string">"DemoBackupExtension"</span></span>,</li><li>    <span class=""><span class="hljs-string">"icon"</span></span>: <span class=""><span class="hljs-string">"$media:app_icon"</span></span>,</li><li>    <span class=""><span class="hljs-string">"name"</span></span>: <span class=""><span class="hljs-string">"BackupExtensionAbility"</span></span>,</li><li>    <span class=""><span class="hljs-string">"srcEntry"</span></span>: <span class=""><span class="hljs-string">"./ets/backupExtension/BackupExtension.ets"</span></span>,  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">对应</span></span><span class=""><span class="hljs-comment">BackupExtension.ets</span></span><span class=""><span class="hljs-comment">在代码仓中的位置</span></span></li><li>    <span class=""><span class="hljs-string">"type"</span></span>: <span class=""><span class="hljs-string">"backup"</span></span>,                                         <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">类型需要选择</span></span><span class=""><span class="hljs-comment">backup</span></span></li><li>    <span class=""><span class="hljs-string">"exported"</span></span>: <span class=""><span class="hljs-keyword">false</span></span>,</li><li>    <span class=""><span class="hljs-string">"metadata"</span></span>: [                                             <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">对应注册的元数据资源</span></span></li><li>      {</li><li>        <span class=""><span class="hljs-string">"name"</span></span>: <span class=""><span class="hljs-string">"ohos.extension.backup"</span></span>,</li><li>        <span class=""><span class="hljs-string">"resource"</span></span>: <span class=""><span class="hljs-string">"$profile:backup_config"</span></span></li><li>      }</li><li>    ]</li><li>  }</li><li>]</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section14434142512513">APK应用沙箱目录与备份恢复目录映射关系<i class="anchor-icon anchor-icon-link" anchorid="section14434142512513" tips="复制节点链接"></i></h2><p>APK应用沙箱目录与备份恢复目录映射关系见下表中所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.3.1.4.1.1" valign="top" width="28.412841284128415%"><p>APK应用沙箱目录</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.4.1.2" valign="top" width="31.04310431043104%"><p>备份恢复目录示例</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.4.1.3" valign="top" width="40.54405440544054%"><p>备份恢复目录获取方式</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="28.412841284128415%"><p>/data/user_de/{userId}/{APK包名}/</p> </td> <td class="cellrowborder" valign="top" width="31.04310431043104%"><p>/data/storage/el1/base/.backup/restore/{APK包名}/de/</p> </td> <td class="cellrowborder" valign="top" width="40.54405440544054%"><p>this.context.area = contextConstant.AreaMode.EL1;</p> <p>let deSourcePath = this.context.backupDir + "restore/{APK包名}/de/"</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.412841284128415%"><p>/data/user/{userId}/{APK包名}/</p> </td> <td class="cellrowborder" valign="top" width="31.04310431043104%"><p>/data/storage/el2/base/.backup/restore/{APK包名}/ce/</p> </td> <td class="cellrowborder" valign="top" width="40.54405440544054%"><p>this.context.area = contextConstant.AreaMode.EL2;</p> <p>let ceSourcePath = this.context.backupDir + "restore/{APK包名}/ce/"</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.412841284128415%"><p>/data/media/{userId}/Android/data/{APK包名}/</p> </td> <td class="cellrowborder" valign="top" width="31.04310431043104%"><p>/data/storage/el2/base/.backup/restore/{APK包名}/A/data/</p> </td> <td class="cellrowborder" valign="top" width="40.54405440544054%"><p>this.context.area = contextConstant.AreaMode.EL2;</p> <p>let dataSourcePath = this.context.backupDir + "restore/{APK包名}/A/data/"</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.412841284128415%"><p>/data/media/{userId}/Android/obb/{APK包名}/</p> </td> <td class="cellrowborder" valign="top" width="31.04310431043104%"><p>/data/storage/el2/base/.backup/restore/{APK包名}/A/obb/</p> </td> <td class="cellrowborder" valign="top" width="40.54405440544054%"><p>this.context.area = contextConstant.AreaMode.EL2;</p> <p>let obbSourcePath = this.context.backupDir + "restore/{APK包名}/A/obb/"</p> </td> </tr>  </tbody></table></div> </div> </div> </div> <div></div></div>