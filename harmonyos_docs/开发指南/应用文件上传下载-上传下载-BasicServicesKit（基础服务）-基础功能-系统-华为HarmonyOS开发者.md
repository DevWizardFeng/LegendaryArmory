<h1 _ngcontent-csf-c119="" class="doc-title ng-star-inserted" title="应用文件上传下载"> 应用文件上传下载 </h1>

<div _ngcontent-csf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>应用支持将文件上传到网络服务器，也支持从网络服务器下载资源文件到本地目录。</p>    <div class="tiledSection">     <h2 id="上传应用文件">上传应用文件<i class="anchor-icon anchor-icon-link" anchorid="上传应用文件" tips="复制节点链接"></i></h2>          <p>开发者可以使用上传下载模块（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request" target="_blank">ohos.request</a>）的上传接口将本地文件上传。文件上传过程通过系统服务代理完成。在api12中，request.agent.create接口增加了设置代理地址的参数，支持设置自定义代理地址。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>· 当前上传应用文件功能。request.uploadFile方式仅支持上传应用缓存文件路径（cacheDir）下的文件，request.agent方式支持上传用户公共文件和应用缓存文件路径下的文件。</p>       <p>· 使用上传下载模块，需<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>：ohos.permission.INTERNET。</p>       <p>· 上传下载模块不支持Charles、Fiddler等代理抓包工具。</p>       <p>· 上传下载模块接口目前暂不支持子线程调用场景，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction">TaskPool</a>等。</p>      </div></div></div>     <p>以下示例代码展示了两种将缓存文件上传至服务器的方法：</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 方式一:request.uploadFile</span></li><li><span class="hljs-comment">// pages/xxx.ets</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"上传"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 获取应用文件路径</span></li><li>          <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">let</span> cacheDir = context.<span class="hljs-property">cacheDir</span>;</li><li>
</li><li>          <span class="hljs-comment">// 新建一个本地应用文件</span></li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(cacheDir + <span class="hljs-string">'/test.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>            fs.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, <span class="hljs-string">'upload file test'</span>);</li><li>            fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke uploadFile failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          }</li><li>
</li><li>          <span class="hljs-comment">// 上传任务配置项</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">files</span>: <span class="hljs-title class_">Array</span>&lt;request.<span class="hljs-property">File</span>&gt; = [</li><li>          <span class="hljs-comment">//uri前缀internal://cache 对应cacheDir目录</span></li><li>            { <span class="hljs-attr">filename</span>: <span class="hljs-string">'test.txt'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span>, <span class="hljs-attr">uri</span>: <span class="hljs-string">'internal://cache/test.txt'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'txt'</span> }</li><li>          ]</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Array</span>&lt;request.<span class="hljs-property">RequestData</span>&gt; = [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'value'</span> }];</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">uploadConfig</span>: request.<span class="hljs-property">UploadConfig</span> = {</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxx'</span>,</li><li>            <span class="hljs-attr">header</span>: {</li><li>              <span class="hljs-string">'key1'</span>:<span class="hljs-string">'value1'</span>,</li><li>              <span class="hljs-string">'key2'</span>:<span class="hljs-string">'value2'</span></li><li>            },</li><li>            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,</li><li>            <span class="hljs-attr">files</span>: files,</li><li>            <span class="hljs-attr">data</span>: data</li><li>          }</li><li>
</li><li>          <span class="hljs-comment">// 将本地应用文件上传至网络服务器</span></li><li>          <span class="hljs-keyword">try</span> {</li><li>            request.<span class="hljs-title function_">uploadFile</span>(context, uploadConfig)</li><li>              .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">uploadTask: request.UploadTask</span>) =&gt;</span> {</li><li>                uploadTask.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-function">(<span class="hljs-params">taskStates: <span class="hljs-built_in">Array</span>&lt;request.TaskState&gt;</span>) =&gt;</span> {</li><li>                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; taskStates.<span class="hljs-property">length</span>; i++) {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`upload complete taskState: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(taskStates[i])}</span>`</span>);</li><li>                  }</li><li>                });</li><li>              })</li><li>              .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke uploadFile failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>              })</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke uploadFile failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 方式二:request.agent</span></li><li><span class="hljs-comment">// pages/xxx.ets</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"上传"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 获取应用文件路径</span></li><li>          <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">let</span> cacheDir = context.<span class="hljs-property">cacheDir</span>;</li><li>
</li><li>          <span class="hljs-comment">// 新建一个本地应用文件</span></li><li>          <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(cacheDir + <span class="hljs-string">'/test.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>          fs.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, <span class="hljs-string">'upload file test'</span>);</li><li>          fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">attachments</span>: <span class="hljs-title class_">Array</span>&lt;request.<span class="hljs-property">agent</span>.<span class="hljs-property">FormItem</span>&gt; = [{</li><li>            <span class="hljs-attr">name</span>: <span class="hljs-string">"test"</span>,</li><li>            <span class="hljs-attr">value</span>: [</li><li>              {</li><li>                <span class="hljs-attr">filename</span>: <span class="hljs-string">"test.txt"</span>,</li><li>                <span class="hljs-attr">path</span>: cacheDir + <span class="hljs-string">'/test.txt'</span>,</li><li>              },</li><li>            ]</li><li>          }];</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>            <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">UPLOAD</span>,</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'http://xxx'</span>,</li><li>            <span class="hljs-attr">mode</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Mode</span>.<span class="hljs-property">FOREGROUND</span>,</li><li>            <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,</li><li>            <span class="hljs-attr">headers</span>: {</li><li>              <span class="hljs-string">'key1'</span>:<span class="hljs-string">'value1'</span>,</li><li>              <span class="hljs-string">'key2'</span>:<span class="hljs-string">'value2'</span></li><li>            },</li><li>            <span class="hljs-attr">data</span>: attachments</li><li>          };</li><li>          request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>            task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">if</span> (err) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the upload task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>            });</li><li>            task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-title function_">async</span>(progress) =&gt; {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request upload status <span class="hljs-subst">${progress.state}</span>, uploaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>            })</li><li>            task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-title function_">async</span>() =&gt; {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request upload completed`</span>);</li><li>              <span class="hljs-comment">//该方法需用户管理任务生命周期，任务结束后调用remove释放task对象</span></li><li>              request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>            })</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a upload task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="下载网络资源文件至应用文件目录">下载网络资源文件至应用文件目录<i class="anchor-icon anchor-icon-link" anchorid="下载网络资源文件至应用文件目录" tips="复制节点链接"></i></h2>          <p>开发者可以使用上传下载模块（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request" target="_blank">ohos.request</a>）的下载接口将网络资源文件下载到应用文件目录。对已下载的网络资源应用文件，开发者可以使用基础文件IO接口（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">ohos.file.fs</a>）对其进行访问，使用方式与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access">应用文件访问</a>一致。文件下载过程使用系统服务代理完成，在api12中request.agent.create接口增加了设置代理地址参数，支持用户设置自定义代理地址。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>当前网络资源文件仅支持下载至应用文件目录。</p>       <p>使用上传下载模块，需<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>：ohos.permission.INTERNET。</p>      </div></div></div>     <p>以下示例代码展示了将网络资源文件下载到应用内部文件目录的两种方法：</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 方式一:request.downloadFile</span></li><li><span class="hljs-comment">// pages/xxx.ets</span></li><li><span class="hljs-comment">// 将网络资源文件下载到应用文件目录并读取一段内容</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 获取应用文件路径</span></li><li>          <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">let</span> filesDir = context.<span class="hljs-property">filesDir</span>;</li><li>
</li><li>          <span class="hljs-keyword">try</span> {</li><li>            request.<span class="hljs-title function_">downloadFile</span>(context, {</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/xxxx.txt'</span>,</li><li>              <span class="hljs-attr">filePath</span>: filesDir + <span class="hljs-string">'/xxxx.txt'</span></li><li>            }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">downloadTask: request.DownloadTask</span>) =&gt;</span> {</li><li>              downloadTask.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'download complete'</span>);</li><li>                <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(filesDir + <span class="hljs-string">'/xxxx.txt'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>                <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</li><li>                <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, arrayBuffer);</li><li>                <span class="hljs-keyword">let</span> buf = buffer.<span class="hljs-title function_">from</span>(arrayBuffer, <span class="hljs-number">0</span>, readLen);</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The content of file: <span class="hljs-subst">${buf.toString()}</span>`</span>);</li><li>                fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>              })</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke downloadTask failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke downloadFile failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 方式二:request.agent</span></li><li><span class="hljs-comment">// pages/xxx.ets</span></li><li><span class="hljs-comment">// 将网络资源文件下载到应用文件目录并读取一段内容</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> fileIo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 获取应用文件路径</span></li><li>          <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">let</span> filesDir = context.<span class="hljs-property">filesDir</span>;</li><li>
</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>            <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">DOWNLOAD</span>,</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/test.txt'</span>,</li><li>            <span class="hljs-attr">saveas</span>: <span class="hljs-string">'xxxx.txt'</span>,</li><li>            <span class="hljs-attr">gauge</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-attr">network</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Network</span>.<span class="hljs-property">WIFI</span>,</li><li>          };</li><li>          request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>            task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">if</span> (err) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the download task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>            });</li><li>            task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request download status <span class="hljs-subst">${progress.state}</span>, downloaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>            })</li><li>            task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request download completed`</span>);</li><li>              <span class="hljs-keyword">let</span> filePath = filesDir + <span class="hljs-string">'/xxxx.txt'</span>;</li><li>              <span class="hljs-keyword">let</span> file = fileIo.<span class="hljs-title function_">openSync</span>(filePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>); <span class="hljs-comment">// 先用只读模式打开获取大小</span></li><li>
</li><li>              <span class="hljs-comment">// 获取文件状态信息，其中包含大小</span></li><li>              <span class="hljs-keyword">let</span> fileStat = fileIo.<span class="hljs-title function_">statSync</span>(filePath);</li><li>              <span class="hljs-keyword">let</span> fileSize = fileStat.<span class="hljs-property">size</span>;</li><li>
</li><li>              <span class="hljs-comment">// 根据文件大小创建足够大的Buffer</span></li><li>              <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(fileSize);</li><li>              <span class="hljs-keyword">let</span> readLen = fileIo.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, arrayBuffer); <span class="hljs-comment">// 现在可以安全读取全部内容</span></li><li>              <span class="hljs-keyword">let</span> buf = buffer.<span class="hljs-title function_">from</span>(arrayBuffer, <span class="hljs-number">0</span>, readLen);</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The content of file: <span class="hljs-subst">${buf.toString()}</span>`</span>);</li><li>              fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>              request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>            })</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a download task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="下载网络资源文件至用户文件">下载网络资源文件至用户文件<i class="anchor-icon anchor-icon-link" anchorid="下载网络资源文件至用户文件" tips="复制节点链接"></i></h2>          <p>开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request" target="_blank">ohos.request</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentcreate10" target="_blank">request.agent</a>接口下载网络资源文件到指定的用户文件目录。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>从API version 20开始支持下载网络资源文件至用户文件。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="下载文档类文件" class="firsth2">下载文档类文件<i class="anchor-icon anchor-icon-link" anchorid="下载文档类文件" tips="复制节点链接"></i></h3>          <p>开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#documentviewpicker" target="_blank">DocumentViewPicker</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#save" target="_blank">save()</a>接口保存文件并获得用户文件的uri，将此uri作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentconfig10" target="_blank">Config</a>的saveas字段值进行下载。</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { picker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载文档"</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"50%"</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> }).<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>
</li><li>          <span class="hljs-comment">// 创建文件管理器选项实例。</span></li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">const</span> documentSaveOptions = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentSaveOptions</span>();</li><li>            <span class="hljs-comment">// 保存文件名（可选）。 默认为空。</span></li><li>            documentSaveOptions.<span class="hljs-property">newFileNames</span> = [<span class="hljs-string">"xxxx.txt"</span>];</li><li>            <span class="hljs-comment">// 保存文件类型['后缀类型描述|后缀类型']，选择所有文件：'所有文件(*.*)|.*'（可选），如果选择项存在多个后缀（最大限制100个过滤后缀），默认选择第一个。如果不传该参数，默认无过滤后缀。</span></li><li>            documentSaveOptions.<span class="hljs-property">fileSuffixChoices</span> = [<span class="hljs-string">'文档|.txt'</span>, <span class="hljs-string">'.pdf'</span>];</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>            <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>            <span class="hljs-keyword">const</span> documentViewPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentViewPicker</span>(context);</li><li>            <span class="hljs-keyword">await</span> documentViewPicker.<span class="hljs-title function_">save</span>(documentSaveOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">documentSaveResult: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>              uri = documentSaveResult[<span class="hljs-number">0</span>];</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'DocumentViewPicker.save to file succeed and uri is:'</span> + uri);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke documentViewPicker.save failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            })</li><li>            <span class="hljs-keyword">if</span> (uri != <span class="hljs-string">''</span>) {</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>                <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">DOWNLOAD</span>,</li><li>                <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/xxxx.txt'</span>,</li><li>                <span class="hljs-comment">// saveas字段是DocumentViewPicker保存的文件的uri</span></li><li>                <span class="hljs-attr">saveas</span>: uri,</li><li>                <span class="hljs-attr">gauge</span>: <span class="hljs-literal">true</span>,</li><li>                <span class="hljs-comment">// overwrite字段必须为true</span></li><li>                <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>                <span class="hljs-attr">network</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Network</span>.<span class="hljs-property">WIFI</span>,</li><li>                <span class="hljs-comment">// mode字段必须为request.agent.Mode.FOREGROUND</span></li><li>                <span class="hljs-attr">mode</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Mode</span>.<span class="hljs-property">FOREGROUND</span>,</li><li>              };</li><li>              <span class="hljs-keyword">try</span> {</li><li>                request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>                  task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                    <span class="hljs-keyword">if</span> (err) {</li><li>                      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the download task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                      <span class="hljs-keyword">return</span>;</li><li>                    }</li><li>                  });</li><li>                  task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Request download status <span class="hljs-subst">${progress.state}</span>, downloaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>                  })</li><li>                  task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Request download completed, '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(progress));</li><li>                    <span class="hljs-comment">// 该方法需用户管理任务生命周期，任务结束后调用remove释放task对象</span></li><li>                    request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>                  })</li><li>                }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to operate a download task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                });</li><li>              } <span class="hljs-keyword">catch</span> (err) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a download task, err: <span class="hljs-subst">${err}</span>`</span>);</li><li>              }</li><li>            }</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a documentSaveOptions, err: <span class="hljs-subst">${err}</span>`</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="下载音频类文件">下载音频类文件<i class="anchor-icon anchor-icon-link" anchorid="下载音频类文件" tips="复制节点链接"></i></h3>          <p>开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#audioviewpicker" target="_blank">AudioViewPicker</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#save-3" target="_blank">save()</a>接口保存文件并获得用户文件的uri，将此uri作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentconfig10" target="_blank">Config</a>的saveas字段值进行下载。</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { picker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载音频"</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"50%"</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> }).<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-comment">// 创建文件管理器选项实例。</span></li><li>          <span class="hljs-keyword">const</span> audioSaveOptions = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">AudioSaveOptions</span>();</li><li>          <span class="hljs-comment">// 保存文件名（可选）。 默认为空。</span></li><li>          audioSaveOptions.<span class="hljs-property">newFileNames</span> = [<span class="hljs-string">'xxxx.mp3'</span>];</li><li>
</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>          <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">const</span> audioViewPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">AudioViewPicker</span>(context);</li><li>          <span class="hljs-keyword">await</span> audioViewPicker.<span class="hljs-title function_">save</span>(audioSaveOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">audioSelectResult: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>            uri = audioSelectResult[<span class="hljs-number">0</span>];</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AudioViewPicker.save to file succeed and uri is:'</span> + uri);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke audioViewPicker.save failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          })</li><li>          <span class="hljs-keyword">if</span> (uri != <span class="hljs-string">''</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>              <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">DOWNLOAD</span>,</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/xxxx.mp3'</span>,</li><li>              <span class="hljs-comment">// saveas字段是AudioViewPicker保存的文件的uri</span></li><li>              <span class="hljs-attr">saveas</span>: uri,</li><li>              <span class="hljs-attr">gauge</span>: <span class="hljs-literal">true</span>,</li><li>              <span class="hljs-comment">// overwrite字段必须为true</span></li><li>              <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>              <span class="hljs-attr">network</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Network</span>.<span class="hljs-property">WIFI</span>,</li><li>              <span class="hljs-comment">// mode字段必须为request.agent.Mode.FOREGROUND</span></li><li>              <span class="hljs-attr">mode</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Mode</span>.<span class="hljs-property">FOREGROUND</span>,</li><li>            };</li><li>            <span class="hljs-keyword">try</span> {</li><li>              request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>                task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                  <span class="hljs-keyword">if</span> (err) {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the download task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                    <span class="hljs-keyword">return</span>;</li><li>                  }</li><li>                });</li><li>                task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Request download status <span class="hljs-subst">${progress.state}</span>, downloaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>                })</li><li>                task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Request download completed, '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(progress));</li><li>                  <span class="hljs-comment">// 该方法需用户管理任务生命周期，任务结束后调用remove释放task对象</span></li><li>                  request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>                })</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to operate a download task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>              });</li><li>            } <span class="hljs-keyword">catch</span> (err) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a download task, err: <span class="hljs-subst">${err}</span>`</span>);</li><li>            }</li><li>          }</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="下载图片或视频类文件">下载图片或视频类文件<i class="anchor-icon anchor-icon-link" anchorid="下载图片或视频类文件" tips="复制节点链接"></i></h3>          <p>开发者可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper" target="_blank">PhotoAccessHelper</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoaccesshelper#createasset-2" target="_blank">createAsset()</a>接口创建媒体文件并获取用户文件的URI，将其作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentconfig10" target="_blank">Config</a>的saveas字段值进行下载。</p>     <p>需要权限：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionwrite_imagevideo">ohos.permission.WRITE_IMAGEVIDEO</a></p>     <p>权限<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionwrite_imagevideo">ohos.permission.WRITE_IMAGEVIDEO</a>是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-permission-mgmt-overview#权限机制中的基本概念">system_basic</a>级别的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions">受限开放权限</a>，normal等级的应用需要将自身的APL等级声明为system_basic及以上。授权方式为user_grant，需要<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">import</span> { bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Context</span>, <span class="hljs-title class_">PermissionRequestResult</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载图片"</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"50%"</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> }).<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> bundleFlags = bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_WITH_APPLICATION</span> |</li><li>          bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_WITH_METADATA</span>;</li><li>          <span class="hljs-comment">// 获取应用程序的accessTokenID。</span></li><li>          <span class="hljs-keyword">let</span> tokenID = -<span class="hljs-number">1</span>;</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">await</span> bundleManager.<span class="hljs-title function_">getBundleInfoForSelf</span>(bundleFlags).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`/Request getBundleInfoForSelf successfully. Data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>              tokenID = data.<span class="hljs-property">appInfo</span>.<span class="hljs-property">accessTokenId</span>;</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`GetBundleInfoForSelf failed. Cause: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-keyword">let</span> message = (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'GetBundleInfoForSelf failed: %{public}s'</span>, message);</li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>          <span class="hljs-keyword">let</span> grant = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-comment">// 校验应用是否授予权限。使用Promise异步回调。</span></li><li>          <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">checkAccessToken</span>(tokenID, <span class="hljs-string">'ohos.permission.WRITE_IMAGEVIDEO'</span>)</li><li>            .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: abilityAccessCtrl.GrantStatus</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`/Request checkAccessToken success, data-&gt;<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>              <span class="hljs-keyword">if</span> (data != abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>) {</li><li>                grant = <span class="hljs-literal">false</span>;</li><li>              }</li><li>            })</li><li>            .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`CheckAccessToken fail, err-&gt;<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>            });</li><li>
</li><li>          <span class="hljs-keyword">if</span> (!grant) {</li><li>            <span class="hljs-comment">// 用于UIAbility拉起弹框请求用户授权。使用callback异步回调。</span></li><li>            <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.WRITE_IMAGEVIDEO'</span>])</li><li>              .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: PermissionRequestResult</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request grant:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request grant permissions:'</span> + data.<span class="hljs-property">permissions</span>);</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request grant authResults:'</span> + data.<span class="hljs-property">authResults</span>);</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request grant dialogShownResults:'</span> + data.<span class="hljs-property">dialogShownResults</span>);</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Grant error:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>              });</li><li>          }</li><li>
</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">photoType</span>: photoAccessHelper.<span class="hljs-property">PhotoType</span> = photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">extension</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'jpg'</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: photoAccessHelper.<span class="hljs-property">CreateOptions</span> = {</li><li>              <span class="hljs-attr">title</span>: <span class="hljs-string">'xxxx'</span></li><li>            }</li><li>            <span class="hljs-comment">// 获取相册管理模块的实例，用于访问和修改相册中的媒体文件。</span></li><li>            <span class="hljs-keyword">let</span> phAccessHelper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>            <span class="hljs-comment">// 指定文件类型、后缀和创建选项，创建图片或视频资源，以Promise方式返回结果。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">createAsset</span>(photoType, extension, options);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request createAsset uri'</span> + uri);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'/Request createAsset successfully'</span>);</li><li>
</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>              <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">DOWNLOAD</span>,</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/xxxx.jpg'</span>,</li><li>              <span class="hljs-comment">// saveas字段是PhotoAccessHelper保存的文件的uri</span></li><li>              <span class="hljs-attr">saveas</span>: uri,</li><li>              <span class="hljs-attr">gauge</span>: <span class="hljs-literal">true</span>,</li><li>              <span class="hljs-comment">// overwrite字段必须为true</span></li><li>              <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>              <span class="hljs-attr">network</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Network</span>.<span class="hljs-property">WIFI</span>,</li><li>              <span class="hljs-comment">// mode字段必须为request.agent.Mode.FOREGROUND</span></li><li>              <span class="hljs-attr">mode</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Mode</span>.<span class="hljs-property">FOREGROUND</span>,</li><li>            };</li><li>            request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>              task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (err) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the download task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>              });</li><li>              task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Request download status <span class="hljs-subst">${progress.state}</span>, downloaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>              })</li><li>              task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Request download completed, '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(progress));</li><li>                <span class="hljs-comment">//该方法需用户管理任务生命周期，任务结束后调用remove释放task对象</span></li><li>                request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>              })</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to operate a download task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            });</li><li>          } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a download task, err: <span class="hljs-subst">${err}</span>`</span>);</li><li>          }</li><li>        })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="添加任务速度限制与超时限制">添加任务速度限制与超时限制<i class="anchor-icon anchor-icon-link" anchorid="添加任务速度限制与超时限制" tips="复制节点链接"></i></h2>          <p>开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request" target="_blank">ohos.request (上传下载)</a>模块中的接口上传本地文件或下载网络资源文件。为方便对任务速度及时长进行限制，分别在API version 18中增加了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#setmaxspeed18" target="_blank">setMaxSpeed</a>接口，支持用户设置任务的最高速度限制；在API version 20的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentcreate10-1" target="_blank">request.agent.create</a>接口中增加了最低限速及超时参数，支持用户自定义最低速度限制以及超时时间。</p>     <p>以下是对下载任务进行速度限制与超时限制的方式的示例代码演示：</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// pages/xxx.ets</span></li><li><span class="hljs-comment">// 将网络资源文件下载到应用文件目录并读取一段内容</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>                <span class="hljs-title class_">Button</span>(<span class="hljs-string">"下载"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                    <span class="hljs-comment">// 获取应用文件路径</span></li><li>                    <span class="hljs-comment">// 请在组件内获取context，确保this.getUIContext().getHostContext()返回结果为UIAbilityContext</span></li><li>                    <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>                    <span class="hljs-keyword">let</span> filesDir = context.<span class="hljs-property">filesDir</span>;</li><li>
</li><li>                    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Config</span> = {</li><li>                        <span class="hljs-attr">action</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Action</span>.<span class="hljs-property">DOWNLOAD</span>,</li><li>                        <span class="hljs-attr">url</span>: <span class="hljs-string">'https://xxxx/test.txt'</span>,</li><li>                        <span class="hljs-attr">saveas</span>: <span class="hljs-string">'xxxx.txt'</span>,</li><li>                        <span class="hljs-attr">gauge</span>: <span class="hljs-literal">true</span>,</li><li>                        <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,</li><li>                        <span class="hljs-attr">network</span>: request.<span class="hljs-property">agent</span>.<span class="hljs-property">Network</span>.<span class="hljs-property">WIFI</span>,</li><li>                        <span class="hljs-comment">// 最低速度限制规则：</span></li><li>                        <span class="hljs-comment">// 1. 若任务速度持续低于设定值（如：16 * 1024 B/s）达到指定时长（如：10s），则任务失败</span></li><li>                        <span class="hljs-comment">// 2. 重置计时条件：</span></li><li>                        <span class="hljs-comment">//    - 任一秒速度超过最低限速</span></li><li>                        <span class="hljs-comment">//    - 任务暂停后恢复</span></li><li>                        <span class="hljs-comment">//    - 任务停止后重启</span></li><li>                        <span class="hljs-attr">minSpeed</span>: {</li><li>                            <span class="hljs-attr">speed</span>: <span class="hljs-number">16</span> * <span class="hljs-number">1024</span>,</li><li>                            <span class="hljs-attr">duration</span>: <span class="hljs-number">10</span></li><li>                        },</li><li>                        <span class="hljs-comment">// 超时控制规则：</span></li><li>                        <span class="hljs-comment">// 1. 连接超时（connectionTimeout）：</span></li><li>                        <span class="hljs-comment">//    - 单次连接建立耗时超过设定值（如：60s）则任务失败</span></li><li>                        <span class="hljs-comment">//    - 多次连接时各次独立计时（不累积）</span></li><li>                        <span class="hljs-comment">// 2. 总超时（totalTimeout）：</span></li><li>                        <span class="hljs-comment">//    - 任务总耗时（含连接+传输时间）超过设定值（如：120s）则失败</span></li><li>                        <span class="hljs-comment">//    - 暂停期间不计时，恢复后累积计时</span></li><li>                        <span class="hljs-comment">// 3. 重置计时条件：任务失败或停止时重置计时</span></li><li>                        <span class="hljs-attr">timeout</span>: {</li><li>                            <span class="hljs-attr">connectionTimeout</span>: <span class="hljs-number">60</span>,</li><li>                            <span class="hljs-attr">totalTimeout</span>: <span class="hljs-number">120</span>,</li><li>                        }</li><li>                    };</li><li>                    request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">create</span>(context, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">task: request.agent.Task</span>) =&gt;</span> {</li><li>                        <span class="hljs-comment">// 设置任务速度上限</span></li><li>                        task.<span class="hljs-title function_">setMaxSpeed</span>(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in setting the max speed of the task. result: <span class="hljs-subst">${task.tid}</span>`</span>);</li><li>                        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set the max speed of the task. result: <span class="hljs-subst">${task.tid}</span>`</span>);</li><li>                        });</li><li>                        task.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                            <span class="hljs-keyword">if</span> (err) {</li><li>                                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start the download task, Code: <span class="hljs-subst">${err.code}</span>  message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                                <span class="hljs-keyword">return</span>;</li><li>                            }</li><li>                        });</li><li>                        task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">async</span> (progress) =&gt; {</li><li>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request download status <span class="hljs-subst">${progress.state}</span>, downloaded <span class="hljs-subst">${progress.processed}</span>`</span>);</li><li>                        })</li><li>                        task.<span class="hljs-title function_">on</span>(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`/Request download completed`</span>);</li><li>                            <span class="hljs-keyword">let</span> file = fileIo.<span class="hljs-title function_">openSync</span>(filesDir + <span class="hljs-string">'/xxxx.txt'</span>, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>                            <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</li><li>                            <span class="hljs-keyword">let</span> readLen = fileIo.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, arrayBuffer);</li><li>                            <span class="hljs-keyword">let</span> buf = buffer.<span class="hljs-title function_">from</span>(arrayBuffer, <span class="hljs-number">0</span>, readLen);</li><li>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The content of file: <span class="hljs-subst">${buf.toString()}</span>`</span>);</li><li>                            fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>                            request.<span class="hljs-property">agent</span>.<span class="hljs-title function_">remove</span>(task.<span class="hljs-property">tid</span>);</li><li>                        })</li><li>                    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create a download task, Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>                    });</li><li>                })</li><li>            }</li><li>        }</li><li>    }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="添加网络配置">添加网络配置<i class="anchor-icon anchor-icon-link" anchorid="添加网络配置" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="http拦截" class="firsth2">HTTP拦截<i class="anchor-icon anchor-icon-link" anchorid="http拦截" tips="复制节点链接"></i></h3>          <p>开发者可以通过设置配置文件实现HTTP拦截功能。上传下载模块在应用配置文件中禁用HTTP后，无法创建明文HTTP传输的上传下载任务。配置文件在APP中的路径是：src/main/resources/base/profile/network_config.json。请参考网络管理模块<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-network-ca-security#section5454123841911" target="_blank">配置文件</a>，了解需要配置的具体参数。</p>     <p>参考配置文件如下所示：</p>     <div _ngcontent-csf-c106="" class="highlight-div"><div _ngcontent-csf-c106="" class="highlight-div-header"><div _ngcontent-csf-c106="" class="highlight-div-header-left"><div _ngcontent-csf-c106="" class="handle-button expand-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-csf-c106="" class="highlight-div-header-right"><div _ngcontent-csf-c106="" class="handle-button ai-button"></div><div _ngcontent-csf-c106="" class="handle-button line-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-csf-c106="" class="handle-button theme-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-csf-c106="" class="handle-button copy-button"><div _ngcontent-csf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-csf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"network-security-config"</span>: {</li><li>    <span class="hljs-string">"base-config"</span>: {</li><li>      <span class="hljs-string">"cleartextTrafficPermitted"</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-string">"trust-anchors"</span>: [</li><li>        {</li><li>          <span class="hljs-string">"certificates"</span>: <span class="hljs-string">"/etc/security/certificates"</span></li><li>        }</li><li>      ]</li><li>    },</li><li>    <span class="hljs-string">"domain-config"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"cleartextTrafficPermitted"</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-string">"domains"</span>: [</li><li>          {</li><li>            <span class="hljs-string">"include-subdomains"</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-string">"name"</span>: <span class="hljs-string">"*.example.com"</span></li><li>          }</li><li>        ],</li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>