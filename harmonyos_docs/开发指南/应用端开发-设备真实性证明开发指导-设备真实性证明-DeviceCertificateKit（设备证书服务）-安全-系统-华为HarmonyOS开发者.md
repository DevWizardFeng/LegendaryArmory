<h1 _ngcontent-byf-c119="" class="doc-title ng-star-inserted" title="应用端开发"> 应用端开发 </h1>

<div _ngcontent-byf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section97455586338">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section97455586338" tips="复制节点链接"></i></h2><p>接口能力由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-overview" target="_blank">Universal Keystore Kit</a>提供，涉及的功能指导请参考：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-overview" target="_blank">Universal Keystore Kit概述</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-check-key-arkts" target="_blank">查询密钥是否存在(ArkTS)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-check-key-ndk" target="_blank">查询密钥是否存在(C/C++)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-arkts" target="_blank">生成密钥(ArkTS)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-generation-ndk" target="_blank">生成密钥(C/C++)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-anon-attestation-arkts" target="_blank">匿名密钥证明(ArkTS)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-key-anon-attestation-ndk" target="_blank">匿名密钥证明(C/C++)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-signing-signature-verification-arkts" target="_blank">签名/验签(ArkTS)</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-signing-signature-verification-ndk" target="_blank">签名/验签(C/C++)</a></li></ul> </div> <div class="tiledSection"><h2 id="section16550423152920">查询应用公私钥对是否存在<i class="anchor-icon anchor-icon-link" anchorid="section16550423152920" tips="复制节点链接"></i></h2><p>查询用于设备真实性证明的应用公私钥对是否存在，如果应用公私钥对已存在，则不需要重复创建应用公私钥对。</p> <p><strong>样例代码：</strong></p> <div _ngcontent-byf-c106="" class="highlight-div"><div _ngcontent-byf-c106="" class="highlight-div-header"><div _ngcontent-byf-c106="" class="highlight-div-header-left"><div _ngcontent-byf-c106="" class="handle-button expand-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-byf-c106="" class="highlight-div-header-right"><div _ngcontent-byf-c106="" class="handle-button ai-button"></div><div _ngcontent-byf-c106="" class="handle-button line-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-byf-c106="" class="handle-button theme-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-byf-c106="" class="handle-button copy-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-byf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'serviceKey'</span>;  <span class="hljs-comment">//业务密钥别名</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">isKeyExist</span>: <span class="hljs-title class_">Boolean</span>;</li><li> </li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">huksOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: []</li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  huks.<span class="hljs-title function_">hasKeyItem</span>(keyAlias, huksOptions, <span class="hljs-function">(<span class="hljs-params">error, data</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`callback: hasKeyItem failed, `</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">null</span> &amp;&amp; data.<span class="hljs-title function_">valueOf</span>() !== <span class="hljs-literal">null</span>) {</li><li>        isKeyExist = data.<span class="hljs-title function_">valueOf</span>();</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`callback: hasKeyItem success, isKeyExist = <span class="hljs-subst">${isKeyExist}</span>`</span>);</li><li>      }</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`callback: hasKeyItem input arg invalid, `</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section9498174318455">创建应用公私钥对<i class="anchor-icon anchor-icon-link" anchorid="section9498174318455" tips="复制节点链接"></i></h2><p>创建一个用于证明设备真实性和应用身份的非对称算法密钥对，称为应用公私钥对（包含应用公钥和应用私钥），比如RSA、EC算法的密钥对。通过Universal Keystore Kit场景的密钥对基于硬件的安全环境进行生成和安全存储。</p> <p><strong>安全建议：对于有用户登录的应用场景，为了提高安全性，建议为终端设备中登录的每个用户生成不同的密钥对，并在应用服务器绑定用户与应用公钥之间的关系。</strong></p> <p><strong>样例代码：</strong></p> <div _ngcontent-byf-c106="" class="highlight-div"><div _ngcontent-byf-c106="" class="highlight-div-header"><div _ngcontent-byf-c106="" class="highlight-div-header-left"><div _ngcontent-byf-c106="" class="handle-button expand-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-byf-c106="" class="highlight-div-header-right"><div _ngcontent-byf-c106="" class="handle-button ai-button"></div><div _ngcontent-byf-c106="" class="handle-button line-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-byf-c106="" class="handle-button theme-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-byf-c106="" class="handle-button copy-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-byf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'serviceKey'</span>; <span class="hljs-comment">//业务密钥别名</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">GetGenerateProperties</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();</li><li>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_ECC</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_AES_KEY_SIZE_256</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_SIGN</span> |</li><li>    huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_VERIFY</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DIGEST</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyDigest</span>.<span class="hljs-property">HUKS_DIGEST_SHA256</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> properties;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GenerateKey</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> genProperties = <span class="hljs-title class_">GetGenerateProperties</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: genProperties</li><li>  }</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(keyAlias, options)</li><li>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: generate Key success.`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generate Key failed, error: `</span> + err.<span class="hljs-property">message</span>);</li><li>    })</li><li>}</li><li>
</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section0457204074616">对应用公钥进行证明<i class="anchor-icon anchor-icon-link" anchorid="section0457204074616" tips="复制节点链接"></i></h2><p>应用调用Universal Keystore Kit接口对生成的应用公钥和调用的应用身份进行证明，Universal Keystore Kit会使用基于硬件的设备证书对应用公钥进行证明，证明公钥来自真实的设备。</p> <p>Universal Keystore Kit返回密钥证明证书链，证书链采用X509标准格式。</p> <p><strong>安全建议：</strong><strong>为了在发送密钥证明证书链给应用服务器时能够防重放攻击，建议应用先从应用服务器获取一次性的挑战值Challenge。应用服务器采用安全随机数生成挑战值Challenge，并缓存到服务器中</strong>。</p> <p><strong>样例代码：</strong></p> <div _ngcontent-byf-c106="" class="highlight-div"><div _ngcontent-byf-c106="" class="highlight-div-header"><div _ngcontent-byf-c106="" class="highlight-div-header-left"><div _ngcontent-byf-c106="" class="handle-button expand-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-byf-c106="" class="highlight-div-header-right"><div _ngcontent-byf-c106="" class="handle-button ai-button"></div><div _ngcontent-byf-c106="" class="handle-button line-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-byf-c106="" class="handle-button theme-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-byf-c106="" class="handle-button copy-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-byf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">HuksProperties</span> {</li><li>  <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span> = huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>;</li><li>  <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span> | huks.<span class="hljs-property">HuksKeySize</span> | huks.<span class="hljs-property">HuksKeyPurpose</span> | huks.<span class="hljs-property">HuksKeyDigest</span> |</li><li>  huks.<span class="hljs-property">HuksKeyStorageType</span> | huks.<span class="hljs-property">HuksKeyPadding</span> | huks.<span class="hljs-property">HuksKeyGenerateType</span> |</li><li>  huks.<span class="hljs-property">HuksCipherMode</span> | <span class="hljs-title class_">Uint8Array</span> = huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_ECC</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> challenge = <span class="hljs-title function_">stringToUint8Array</span>(<span class="hljs-string">'challenge_data'</span>); <span class="hljs-comment">//从服务器获取的挑战字Challenge</span></li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'serviceKey'</span>; <span class="hljs-comment">//业务密钥别名</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">stringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">let</span> tmpUint8Array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>  <span class="hljs-keyword">return</span> tmpUint8Array;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">anonAttestKey</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> aliasString = keyAlias;</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">HuksProperties</span>[] = [</li><li>    {</li><li>      <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ATTESTATION_CHALLENGE</span>,</li><li>      <span class="hljs-attr">value</span>: challenge</li><li>    }</li><li>  ];</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: properties</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">anonAttestKeyItem</span>(aliasString, options);</li><li>    <span class="hljs-comment">//todo：把证书链信息（data变量）发送到云侧的服务器。如下示例代码把证书链打印到日志中，供调测使用，商用代码不需要打印。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`anonAttestKeyItem success`</span>);</li><li>    data.<span class="hljs-property">certChains</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cert</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(cert);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: anonAttestKeyItem fail`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section13117165144720">使用应用私钥对业务请求进行签名<i class="anchor-icon anchor-icon-link" anchorid="section13117165144720" tips="复制节点链接"></i></h2><p>在密钥证明流程处理成功后，应用在进行一些安全敏感的端云业务时，可以使用已证明的密钥对业务请求进行安全保护。</p> <p>应用可以调用Universal Keystore Kit接口使用应用私钥对业务请求数据（如HTTP请求的Body）进行签名，然后把签名数据添加到请求消息中（如HTTP的Header字段）。为了方便应用服务器查找应用公钥用于验签，可以在业务请求中携带应用公钥的密钥ID（如：通过对应用公钥计算Hash）。</p> <p><strong>安全建议：为了在发送业务请求时能够防重放攻击，建议应用先从应用服务器获取一次性的挑战值Challenge。应用服务器采用安全随机数生成挑战值Challenge，并缓存到服务器中</strong>。</p> <p><strong>样例代码：</strong></p> <div _ngcontent-byf-c106="" class="highlight-div"><div _ngcontent-byf-c106="" class="highlight-div-header"><div _ngcontent-byf-c106="" class="highlight-div-header-left"><div _ngcontent-byf-c106="" class="handle-button expand-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-byf-c106="" class="highlight-div-header-right"><div _ngcontent-byf-c106="" class="handle-button ai-button"></div><div _ngcontent-byf-c106="" class="handle-button line-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-byf-c106="" class="handle-button theme-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-byf-c106="" class="handle-button copy-button"><div _ngcontent-byf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-byf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'serviceKey'</span>; <span class="hljs-comment">//业务密钥别名</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">handle</span>: <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">let</span> plaintext = <span class="hljs-string">'123456'</span>; <span class="hljs-comment">//待签名的明文数据，建议包含服务器端返回的Challenge</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">signature</span>: <span class="hljs-title class_">Uint8Array</span>; <span class="hljs-comment">//存储签名结果数据的变量</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">StringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">String</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">GetSignProperties</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();</li><li>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_ECC</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_AES_KEY_SIZE_256</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_SIGN</span></li><li>  };</li><li>  properties[index++] = {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_DIGEST</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyDigest</span>.<span class="hljs-property">HUKS_DIGEST_SHA256</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> properties;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Sign</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, plaintext: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> signProperties = <span class="hljs-title class_">GetSignProperties</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>    <span class="hljs-attr">properties</span>: signProperties,</li><li>    <span class="hljs-attr">inData</span>: <span class="hljs-title class_">StringToUint8Array</span>(plaintext)</li><li>  }</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, options)</li><li>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      handle = data.<span class="hljs-property">handle</span>;</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: init sign failed, error: `</span> + err.<span class="hljs-property">message</span>);</li><li>    })</li><li>  <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(handle, options)</li><li>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      signature = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>
</li><li>      <span class="hljs-keyword">let</span> base64 = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">Base64Helper</span>();</li><li>      <span class="hljs-keyword">let</span> signatureBase64 = base64.<span class="hljs-title function_">encodeToStringSync</span>(signature);</li><li>      <span class="hljs-comment">//todo：把签名结果的Base64编码（signatureBase64变量）发送到云侧的服务器。如下示例代码把签名结果打印到日志中，供调测使用，商用代码不需要打印。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`sign success, result:`</span> + signatureBase64);</li><li>
</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: sign failed, error: `</span> + err.<span class="hljs-property">message</span>);</li><li>    })</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>