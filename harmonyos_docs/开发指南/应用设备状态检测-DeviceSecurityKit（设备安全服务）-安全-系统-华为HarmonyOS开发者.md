<h1 _ngcontent-umn-c119="" class="doc-title ng-star-inserted" title="应用设备状态检测"> 应用设备状态检测 </h1>

<div _ngcontent-umn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1880231055910">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1880231055910" tips="复制节点链接"></i></h2>          <p>应用通过调用Device Security Kit的getDeviceToken接口获取到DeviceToken，应用的服务器使用DeviceToken到Device Security服务器查询和管理应用在该设备的使用状态，应用在无法获取到持久化设备标识的情况下也可以对设备的应用状态进行记录和查询。</p>     <p>应用可以根据Device Security服务器返回的使用状态，判断应用是否在该设备上首次安装，或在该设备上用户是否已获取了优惠券等，以支撑业务进行新用户营销活动。</p>    </div>    <div class="tiledSection">     <h2 id="section9684181513312">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section9684181513312" tips="复制节点链接"></i></h2>          <p>应用设备状态检测（DeviceVerify）能力不支持模拟器。支持设备：Phone、Tablet、PC/2in1、Wearable，从5.1.1(19)版本开始，新增支持设备：TV。</p>    </div>    <div class="tiledSection">     <h2 id="section1818915573916">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section1818915573916" tips="复制节点链接"></i></h2>          <p><span><img height="376.8164378109452" originheight="657" originwidth="1604" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115016.58242663832348346789665498925771:50001231000000:2800:A745AFAFEC4BDCE7BD2FDD7DB6814CB4E8B8D97B7553DB152E9A0A34F52626F8.png" title="点击放大" width="920"></span></p>     <p>流程说明：</p>     <ol>      <li>开发者应用调用Device Security Kit的getDeviceToken接口获取DeviceToken。</li>      <li>Device Security Kit返回DeviceToken。</li>      <li>开发者应用在业务请求（如领取优惠券请求）中把DeviceToken发送到应用的服务器。</li>      <li>应用服务器发送DeviceVerify Rest请求到Device Security服务器，对该设备的标记状态（如是否已领取优惠券）进行查询（getDeviceStatus接口）和更新（setDeviceStatus接口）等操作。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>Device Security服务器为每个设备的每个应用提供了2个bit的状态存储和查询能力，这2个bit的具体含义由应用自行定义。</p>         <p>例如，可以使用bit 0来标识设备是否领取过新机礼包，bit0=false表示未领取，bit0=true表示已领取。用户在设备上领取新机礼包，应用服务器到Device Security服务器查询设备标记状态后，可根据bit0取值做相应处理。</p>         <ul>          <li>如果bit0=true，则表示该设备已经领取过了新机礼包，应用服务器可拒绝该设备继续领取新机礼包。</li>          <li>如果bit0=false，则表示该设备未领取过新机礼包，应用服务器可向该设备的用户颁发新机礼包，并调用Device Security服务器的更新设备标记状态接口修改bit0为true。</li>         </ul>        </div></div></div></li>      <li>Device Security服务器返回DeviceVerify响应。</li>      <li>应用服务器根据Device Security服务器返回的响应进行相应的业务处理。</li>      <li>应用服务器返回业务响应。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section5906121818412">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section5906121818412" tips="复制节点链接"></i></h2>          <p>以下是DeviceVerify相关接口，包括ArkTS API和REST API，更多接口及使用方法请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-arktsapi" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="38.92%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="61.08%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="38.92%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-deviceverify-api#section102884586336" target="_blank">getDeviceToken(): Promise&lt;string&gt;</a></p></td>         <td class="cellrowborder" valign="top" width="61.08%">          <p>获取本设备的DeviceToken</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="38.92%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-deviceverify-checkdevicetoken" target="_blank">checkDeviceToken</a></p></td>         <td class="cellrowborder" valign="top" width="61.08%">          <p>验证deviceToken</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="38.92%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-deviceverify-getdevicestatus" target="_blank">getDeviceStatus</a></p></td>         <td class="cellrowborder" valign="top" width="61.08%">          <p>查询设备标记状态</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="38.92%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-deviceverify-updatedevicestatus" target="_blank">setDeviceStatus</a></p></td>         <td class="cellrowborder" valign="top" width="61.08%">          <p>更新设备标记状态</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="38.92%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-deviceverify-deletedevicestatus" target="_blank">delDeviceStatus</a></p></td>         <td class="cellrowborder" valign="top" width="61.08%">          <p>删除设备标记状态</p></td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>当getDeviceToken接口由于网络不稳定或其他原因无法获取到DeviceToken时，应用需要考虑异常处理方案，避免出现应用依赖DeviceToken的基本功能不可用。例如应用重新调用getDeviceToken接口或采用其他风控因子进行判断。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section9187179113620">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9187179113620" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1623211911575" class="firsth2">客户端开发<i class="anchor-icon anchor-icon-link" anchorid="section1623211911575" tips="复制节点链接"></i></h3>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>请确保已打开<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/devicesecurity-deviceverify-activateservice">“应用设备状态检测”开关</a>并<a href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-debug-profile-0000002248181278" target="_blank">申请调试Profile</a>。</p>      </div></div></div>    </div>    <ol>     <li>导入Device Security Kit模块及相关公共模块。      <div _ngcontent-umn-c106="" class="highlight-div"><div _ngcontent-umn-c106="" class="highlight-div-header"><div _ngcontent-umn-c106="" class="highlight-div-header-left"><div _ngcontent-umn-c106="" class="handle-button expand-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umn-c106="" class="highlight-div-header-right"><div _ngcontent-umn-c106="" class="handle-button ai-button"></div><div _ngcontent-umn-c106="" class="handle-button line-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umn-c106="" class="handle-button theme-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umn-c106="" class="handle-button copy-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { deviceCertificate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DeviceSecurityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div></li>    </ol>    <ol start="2">     <li>获取设备deviceToken信息。      <div _ngcontent-umn-c106="" class="highlight-div"><div _ngcontent-umn-c106="" class="highlight-div-header"><div _ngcontent-umn-c106="" class="highlight-div-header-left"><div _ngcontent-umn-c106="" class="handle-button expand-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umn-c106="" class="highlight-div-header-right"><div _ngcontent-umn-c106="" class="handle-button ai-button"></div><div _ngcontent-umn-c106="" class="handle-button line-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umn-c106="" class="handle-button theme-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umn-c106="" class="handle-button copy-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">"DeviceCertificateJsTest"</span>;</li><li>
</li><li><span class="hljs-comment">// 请求deviceToken，并处理结果</span></li><li><span class="hljs-keyword">try</span> {</li><li>  deviceCertificate.<span class="hljs-title function_">getDeviceToken</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in executing getDeviceToken'</span>);</li><li>      <span class="hljs-comment">// 开发者处理deviceToken</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'getDeviceToken failed!  %{public}d %{public}s'</span>, err.<span class="hljs-property">code</span>, err.<span class="hljs-property">message</span>);</li><li>  });</li><li>} <span class="hljs-keyword">catch</span>(err) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'getDeviceToken failed!  %{public}d %{public}s'</span>, error.<span class="hljs-property">code</span>, error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>      <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">        <p>deviceToken由Device Security Kit加密生成，每次调用生成Token均不一样，有效期1小时。</p>       </div></div></div></li>    </ol>    <div class="tiledSection">     <h3 id="section17453262572">服务端开发<i class="anchor-icon anchor-icon-link" anchorid="section17453262572" tips="复制节点链接"></i></h3>         </div>    <ol>     <li>获取凭证Token，详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/devicesecurity-deviceverify-token">基于服务账号生成鉴权令牌</a>。</li>     <li>可分别调用checkDeviceToken、getDeviceStatus、setDeviceStatus、delDeviceStatus接口，实现deviceToken验证、查询设备标记状态、更新设备标记状态及删除设备标记状态功能。更多接口信息请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-restapi" target="_blank">REST API</a>。      <p>样例代码：</p>      <div _ngcontent-umn-c106="" class="highlight-div"><div _ngcontent-umn-c106="" class="highlight-div-header"><div _ngcontent-umn-c106="" class="highlight-div-header-left"><div _ngcontent-umn-c106="" class="handle-button expand-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-umn-c106="" class="highlight-div-header-right"><div _ngcontent-umn-c106="" class="handle-button ai-button"></div><div _ngcontent-umn-c106="" class="handle-button line-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-umn-c106="" class="handle-button theme-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-umn-c106="" class="handle-button copy-button"><div _ngcontent-umn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-umn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">i</span><span class=""><span class="hljs-keyword">mport</span> </span>java.<span class="hljs-property">io</span>.<span class="hljs-property">BufferedReader</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">io</span>.<span class="hljs-property">IOException</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">io</span>.<span class="hljs-property">InputStream</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">io</span>.<span class="hljs-property">InputStreamReader</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">io</span>.<span class="hljs-property">OutputStream</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">net</span>.<span class="hljs-property">HttpURLConnection</span><span class="">;</span></li><li><span class=""><span class="hljs-keyword">import</span> </span>java.<span class="hljs-property">net</span>.<span class="hljs-property">URL</span><span class="">;</span></li><li>
</li><li><span class=""><span class="hljs-keyword">import</span> </span>com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson</span>.<span class="hljs-property">JSONObject</span><span class="">;</span></li><li>
</li><li><span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> </span><span class="hljs-title class_">DeviceTokenServer</span> {</li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">使用应用设备状态检测功能获取的设备</span></span><span class=""><span class="hljs-comment">deviceToken</span></span></li><li>    <span class=""><span class="hljs-keyword">static</span> </span><span class="hljs-title class_">String</span> <span class="">deviceToken </span>= <span class=""><span class="hljs-string">"aes-gcm.gouLVEalfJxRLxt+3Gxh/orDAG9kDbkeFydkxGrDOHVJ3KEhiSDhIeW+/KH0ErqVxZ0vfkgtapaMu3yc0IND+lzC8ZH86NHxW+/GsqxYhvZ650TWUkanwdlZwYD0HPZ/KFnDPgIvGLvvWz1BdoPOOiFy5BuCQfGVNxl9OBTd7wsiJpl8kKywMRg/k1x61/8IpaH4F6tPrMV/Fv4N/WLfSHlC9AkB1ekZz4hxambDaXP8aXz59FYWItTl7tBOV09+JKnFqD0dB5ZmXjUhVLRKpYeGH8dPWG2gOmEksY6CsXvWBul+5HF76myfUeSvrWfD7Ee3+5Uuld3v+s8W+aFJkdUo8GSCF4xbiA+01BKnq0DIh0EKW/VJAQHjo/P/X/6jMwoDnbF7NWPmh827LHKQMIsN46zfke7qpdBsYpidKNxlXIb1azyAhD/izf5KQwkzwlVTctIvkUNH9XjTh1I6xb8yYb7TjZ7tnMGg2lWizNsejIcwAPqTTyXXupL5mPc8SwsZ424mDQhf1pCfacbZFaew0jWUC5ZQ2B8CiBeX"</span></span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">基于服务账号生成的鉴权令牌</span></span></li><li>    <span class=""><span class="hljs-keyword">static</span> </span><span class="hljs-title class_">String</span> <span class="">authorization </span>= <span class=""><span class="hljs-string">"Bearer eyJraWQiOiI5YTU5ZGRkZDZlYzY0MTgyYmUwMTc2MDNjZDU1YjEwNCIsInR5cCI6IkpXVCIsImFsZyI6IlBTMjU2In0.eyJhdWQiOiJodHRwczovL29hdXRoLWxvZ2luLmNsb3VkLmh1YXdlaS5jb20vb2F1dGgyL3YzL3Rva2VuIiwiaXNzIjoiMTE0MDIzMzQ1IiwiZXhwIjoxNzU0NDQ4NDU2LCJpYXQiOjE3NTQ0NDQ4NTZ9.cJEiLM53QBTSxzPjDAqK-HeteSv_qWxnAuEiwaN_udLQz78QZPcD54RFWSOqE459B0Y78hEL1-2eQlcCjbGn0OI2AQbwTwYzoRbLftAEyP5V9Juv1A-cfR8MoVapVdZ3pA9Jg6B5cBjcQLax-GTUJjevgI4PyTxQCIhLa-kaQq_h-KOnpcWlVUx2weLRAcGs4Tr3wYqdLnSPE7Hp_44C3S69dSoXoP8HL6-2L4aJzzvNn7uYoRiZAoCZoarJNHi7d8h9JEJ2K5vmaYV_lJ9l0_G4RDjpEmtCPOEkXLPIvjh5fwEBPyMZiUJqHyqTkdw8AjjgIaFe0wG9wCZk4sEo9GOruuy9tN6mEccFAEKbSf28gpUowWC23uKQPIYb9sdzrN8D3hpalrN5CDh1dv80wlhLxXeJOWWnfjCqYhA0m17UFC4xEhno-M52dEb4BODPsw-96xx02GX8_VqDDjjUmXEr6lwj4yLE_5feR1QFQS2NhC11Py4AzrsEPb9maFqR-bOUO2SfLdD1EjvMx2p-tELosFH8DmvwtbjNVYDN0zGEed150qhMtkDG9DUwT0dL3q_ikRq73syB9WbQrlpWeJAWBmazkb0EoSf24UO2rRjcZ0hGmgFIIH7AzHgw4Ok2ijCJ5uVIY59DUsXXUIBIH7tMyNUjrdZG0_ctDORrk_s"</span></span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// Hap</span></span><span class=""><span class="hljs-comment">应用的包名</span></span></li><li>    <span class=""><span class="hljs-keyword">static</span> </span><span class="hljs-title class_">String</span> <span class="">bundleName </span>= <span class=""><span class="hljs-string">"com.huawei.myapplication.shoubiao412"</span></span><span class="">;</span></li><li>
</li><li><span class="">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">main</span></span>(<span class="hljs-title class_">String</span>[] args) <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class="hljs-title function_">checkDeviceToken</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">setDeviceStatus</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">getDeviceStatus</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">delDeviceStatus</span>()<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">checkDeviceToken</span></span>() <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">请求</span></span><span class=""><span class="hljs-comment">checkDeviceToken</span></span><span class=""><span class="hljs-comment">接口的地址</span></span></li><li>        <span class="hljs-title class_">String</span> url = <span class=""><span class="hljs-string">"https://connect-api.cloud.huawei.com/api/rms/v1/deviceVerify/checkDeviceToken"</span></span><span class="">;</span></li><li>        <span class="hljs-variable constant_">URL</span> obj = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title function_">URL</span>(url)<span class="">;</span></li><li>        <span class="hljs-title class_">HttpURLConnection</span> con = (<span class="hljs-title class_">HttpURLConnection</span>) obj.<span class="hljs-title function_">openConnection</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">createRequestHeader</span>(con)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class="hljs-title function_">createRequestBody</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">sendRequestAndReadResponse</span>(con<span class="">, </span>postBody)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">getDeviceStatus</span></span>() <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">请求</span></span><span class=""><span class="hljs-comment">getDeviceStatus</span></span><span class=""><span class="hljs-comment">接口的地址</span></span></li><li>        <span class="hljs-title class_">String</span> url = <span class=""><span class="hljs-string">"https://connect-api.cloud.huawei.com/api/rms/v1/deviceVerify/getDeviceStatus"</span></span><span class="">;</span></li><li>        <span class="hljs-variable constant_">URL</span> obj = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title function_">URL</span>(url)<span class="">;</span></li><li>        <span class="hljs-title class_">HttpURLConnection</span> con = (<span class="hljs-title class_">HttpURLConnection</span>) obj.<span class="hljs-title function_">openConnection</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">createRequestHeader</span>(con)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class="hljs-title function_">createRequestBodyWithMode</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">sendRequestAndReadResponse</span>(con<span class="">, </span>postBody)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">setDeviceStatus</span></span>() <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">请求</span></span><span class=""><span class="hljs-comment">setDeviceStatus</span></span><span class=""><span class="hljs-comment">接口的地址</span></span></li><li>        <span class="hljs-title class_">String</span> url = <span class=""><span class="hljs-string">"https://connect-api.cloud.huawei.com/api/rms/v1/deviceVerify/setDeviceStatus"</span></span><span class="">;</span></li><li>        <span class="hljs-variable constant_">URL</span> obj = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title function_">URL</span>(url)<span class="">;</span></li><li>        <span class="hljs-title class_">HttpURLConnection</span> con = (<span class="hljs-title class_">HttpURLConnection</span>) obj.<span class="hljs-title function_">openConnection</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">createRequestHeader</span>(con)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class="hljs-title function_">createRequestBodyWithBit</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">sendRequestAndReadResponse</span>(con<span class="">, </span>postBody)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">delDeviceStatus</span></span>() <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">请求</span></span><span class=""><span class="hljs-comment">delDeviceStatus</span></span><span class=""><span class="hljs-comment">接口的地址</span></span></li><li>        <span class="hljs-title class_">String</span> url = <span class=""><span class="hljs-string">"https://connect-api.cloud.huawei.com/api/rms/v1/deviceVerify/delDeviceStatus"</span></span><span class="">;</span></li><li>        <span class="hljs-variable constant_">URL</span> obj = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title function_">URL</span>(url)<span class="">;</span></li><li>        <span class="hljs-title class_">HttpURLConnection</span> con = (<span class="hljs-title class_">HttpURLConnection</span>) obj.<span class="hljs-title function_">openConnection</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">createRequestHeader</span>(con)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class="hljs-title function_">createRequestBodyWithMode</span>()<span class="">;</span></li><li>        <span class="hljs-title function_">sendRequestAndReadResponse</span>(con<span class="">, </span>postBody)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class=""><span class="hljs-title function_">createRequestBody</span></span>(<span class="hljs-params"></span>) {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">创建请求体</span></span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> data = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"deviceToken"</span></span><span class="">, </span><span class="">deviceToken</span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">可选，根据需要添加</span></span></li><li>        <span class=""><span class="hljs-comment">// data.put("transactionId", "xxx");</span></span></li><li><span class="">        <span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">应用服务器上的</span></span><span class=""><span class="hljs-comment">UTC</span></span><span class=""><span class="hljs-comment">时间</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"timestamp"</span></span><span class="">, </span><span class="">1704038400000L</span>)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        postBody.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"data"</span></span><span class="">, </span>data)<span class="">;</span></li><li><span class="">        <span class="hljs-keyword">return</span> </span>postBody<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class=""><span class="hljs-title function_">createRequestBodyWithMode</span></span>(<span class="hljs-params"></span>) {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">创建请求体</span></span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> data = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设备标记状态的粒度。取值：</span></span><span class=""><span class="hljs-comment">1</span></span><span class=""><span class="hljs-comment">：应用级</span></span><span class=""><span class="hljs-comment"> 2</span></span><span class=""><span class="hljs-comment">：开发者级</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"mode"</span></span><span class="">, </span><span class=""><span class="hljs-number">1</span></span>)<span class="">;</span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"deviceToken"</span></span><span class="">, </span><span class="">deviceToken</span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">可选，根据需要添加</span></span></li><li>        <span class=""><span class="hljs-comment">// data.put("transactionId", "xxx");</span></span></li><li><span class="">        <span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">应用服务器上的</span></span><span class=""><span class="hljs-comment">UTC</span></span><span class=""><span class="hljs-comment">时间</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"timestamp"</span></span><span class="">, </span><span class="">1704038400000L</span>)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        postBody.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"data"</span></span><span class="">, </span>data)<span class="">;</span></li><li><span class="">        <span class="hljs-keyword">return</span> </span>postBody<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class=""><span class="hljs-title function_">createRequestBodyWithBit</span></span>(<span class="hljs-params"></span>) {</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">创建请求体</span></span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> data = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设备标记状态的粒度。取值：</span></span><span class=""><span class="hljs-comment">1</span></span><span class=""><span class="hljs-comment">：应用级</span></span><span class=""><span class="hljs-comment"> 2</span></span><span class=""><span class="hljs-comment">：开发者级</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"mode"</span></span><span class="">, </span><span class=""><span class="hljs-number">1</span></span>)<span class="">;</span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"deviceToken"</span></span><span class="">, </span><span class="">deviceToken</span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">可选，根据需要添加</span></span></li><li>        <span class=""><span class="hljs-comment">// data.put("transactionId", "xxx");</span></span></li><li><span class="">        <span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">应用服务器上的</span></span><span class=""><span class="hljs-comment">UTC</span></span><span class=""><span class="hljs-comment">时间</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"timestamp"</span></span><span class="">, </span><span class="">1704038400000L</span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设备标记状态的第一位数据</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"bit0"</span></span><span class="">, </span><span class=""><span class="hljs-number">1</span></span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设备标记状态的第二位数据</span></span></li><li>        data.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"bit1"</span></span><span class="">, </span><span class=""><span class="hljs-number">0</span></span>)<span class="">;</span></li><li>        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>()<span class="">;</span></li><li>        postBody.<span class="hljs-title function_">put</span>(<span class=""><span class="hljs-string">"data"</span></span><span class="">, </span>data)<span class="">;</span></li><li><span class="">        <span class="hljs-keyword">return</span> </span>postBody<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">createRequestHeader</span></span>(<span class="hljs-title class_">HttpURLConnection</span> con) <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        con.<span class="hljs-title function_">setRequestMethod</span>(<span class=""><span class="hljs-string">"POST"</span></span>)<span class="">;</span></li><li>        con.<span class="hljs-title function_">setDoOutput</span>(<span class=""><span class="hljs-literal">true</span></span>)<span class="">;</span></li><li>
</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设置请求头</span></span></li><li>        con.<span class="hljs-title function_">setRequestProperty</span>(<span class=""><span class="hljs-string">"Content-Type"</span></span><span class="">, </span><span class=""><span class="hljs-string">"application/json;charset=utf-8"</span></span>)<span class="">;</span></li><li>        con.<span class="hljs-title function_">setRequestProperty</span>(<span class=""><span class="hljs-string">"Authorization"</span></span><span class="">, </span><span class="">authorization</span>)<span class="">;</span></li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设置</span></span><span class=""><span class="hljs-comment">bundleName</span></span></li><li>        con.<span class="hljs-title function_">setRequestProperty</span>(<span class=""><span class="hljs-string">"bundleName"</span></span><span class="">, </span><span class="">bundleName</span>)<span class="">;</span></li><li>    }</li><li>    <span class=""><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> </span><span class=""><span class="hljs-title function_">sendRequestAndReadResponse</span></span>(<span class="hljs-title class_">HttpURLConnection</span> con<span class="">, </span><span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> postBody) <span class="">throws </span><span class="hljs-title class_">IOException</span> {</li><li>        <span class=""><span class="hljs-keyword">try</span> </span>(<span class="hljs-title class_">OutputStream</span> os = con.<span class="hljs-title function_">getOutputStream</span>()) {</li><li>            <span class="">byte</span>[] input = postBody.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">getBytes</span>(<span class=""><span class="hljs-string">"utf-8"</span></span>)<span class="">;</span></li><li>            os.<span class="hljs-title function_">write</span>(input<span class="">, </span><span class=""><span class="hljs-number">0</span></span><span class="">, </span>input.<span class=""><span class="hljs-property">length</span></span>)<span class="">;</span></li><li>        }</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">读取响应码</span></span></li><li>        <span class="">int </span>responseCode = con.<span class="hljs-title function_">getResponseCode</span>()<span class="">;</span></li><li>        <span class="hljs-title class_">System</span>.<span class=""><span class="hljs-property">out</span></span>.<span class="hljs-title function_">println</span>(<span class=""><span class="hljs-string">"Response Code: "</span> </span>+ responseCode)<span class="">;</span></li><li>
</li><li>        <span class="hljs-title class_">InputStream</span> stream<span class="">;</span></li><li><span class="">        <span class="hljs-keyword">if</span> </span>(responseCode &gt;= <span class=""><span class="hljs-number">200</span> </span>&amp;&amp; responseCode &lt; <span class=""><span class="hljs-number">300</span></span>) {</li><li>            stream = con.<span class="hljs-title function_">getInputStream</span>()<span class="">;</span></li><li>        } <span class=""><span class="hljs-keyword">else</span> </span>{</li><li>            <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取错误信息</span></span></li><li>            stream = con.<span class="hljs-title function_">getErrorStream</span>()<span class="">;</span></li><li>        }</li><li>        <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">读取响应内容（无论是成功还是失败）</span></span></li><li>        <span class="hljs-title class_">StringBuilder</span> response = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">StringBuilder</span>()<span class="">;</span></li><li>        <span class="hljs-title class_">String</span> line<span class="">;</span></li><li><span class="">        <span class="hljs-keyword">try</span> </span>(<span class="hljs-title class_">BufferedReader</span> br = <span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">BufferedReader</span>(<span class=""><span class="hljs-keyword">new</span> </span><span class="hljs-title class_">InputStreamReader</span>(stream<span class="">, </span><span class=""><span class="hljs-string">"utf-8"</span></span>))) {</li><li>            <span class=""><span class="hljs-keyword">while</span> </span>((line = br.<span class="hljs-title function_">readLine</span>()) != <span class=""><span class="hljs-literal">null</span></span>) {</li><li>                response.<span class="hljs-title function_">append</span>(line)<span class="">;</span></li><li>            }</li><li>        } <span class=""><span class="hljs-keyword">catch</span> </span>(<span class="hljs-title class_">Exception</span> e) {</li><li>            <span class="hljs-title class_">System</span>.<span class=""><span class="hljs-property">out</span></span>.<span class="hljs-title function_">println</span>(e)<span class="">;</span></li><li>        }</li><li>        <span class="hljs-title class_">System</span>.<span class=""><span class="hljs-property">out</span></span>.<span class="hljs-title function_">println</span>(<span class=""><span class="hljs-string">"Response Content: "</span> </span>+ response.<span class="hljs-title function_">toString</span>())<span class="">;</span></li><li>    }</li><li>}</li></ol></pre></div></div></li>    </ol>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ol>       <li>设备标记状态记录的存储期限为2年，存储期限从lastUpdateTime（最后一次更新时间）开始计算。</li>       <li>开发者可以根据getDeviceStatus响应中的lastUpdateTime字段判断设备标记状态的有效期，例如开发者在5月份和6月份分别开展2个不同的优惠活动，可以根据lastUpdateTime字段判断用户已参加的优惠活动，比如lastUpdateTime为5月份，则表示用户参加了5月份的优惠活动。</li>      </ol>     </div></div></div>   </div>   <div></div></div>