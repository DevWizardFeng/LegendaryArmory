<h1 _ngcontent-xyj-c119="" class="doc-title ng-star-inserted" title="应用间消息通信"> 应用间消息通信 </h1>

<div _ngcontent-xyj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在手机侧与穿戴设备侧构建应用到应用的通信隧道，用于收发应用自定义的报文消息以及文件。实现手机应用和穿戴设备应用间的交互，为用户提供分布式场景和体验。比如手机应用发送音频文件到穿戴设备侧应用，实现在穿戴设备侧应用上播放音乐；手机应用发送暂停指令，实现穿戴设备音乐播放暂停等。</p>    <p>收发点对点消息前，需要确保应用已在开发者联盟申请获取设备基础信息权限（参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>），否则接口将调用失败。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>使用该功能前，请确保穿戴设备支持应用安装能力（参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection#section15715111213569">目标设备选择</a>），同时穿戴设备侧已有对应的应用（参见<a href="https://developer.huawei.com/consumer/cn/doc/connectivity-Guides/watch-dev-0000001119195134" target="_blank">穿戴侧应用开发</a>）。</p>      <ul>       <li>手机App和穿戴设备App必须同时处于启动状态。</li>       <li>当手机App启动且穿戴设备App没有启动时，手机App可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section169404201361" target="_blank">startRemoteApp</a>方法拉起穿戴设备App。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="section1725941131115">手机侧应用检测穿戴设备侧应用是否安装<i class="anchor-icon anchor-icon-link" anchorid="section1725941131115" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>该接口的调用需要在开发者联盟申请设备基础信息权限（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>）。</p>      </div></div></div>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>     </ol>     <ol start="3">      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section28747514219" target="_blank">isRemoteAppInstalled</a>方法，查看是否安装指定的设备应用。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将设备侧应用包名定义为remoteBundleName</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">remoteBundleName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤3 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤4 查看是否安装指定的设备侧应用</span></li><li>p2pClient.<span class="hljs-title function_">isRemoteAppInstalled</span>(targetDevice.<span class="hljs-property">randomId</span>, remoteBundleName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">isInstall</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in checking remote app install, result is <span class="hljs-subst">${isInstall}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to check remote app install. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section112106597136">手机侧应用获取穿戴设备侧应用的版本号<i class="anchor-icon anchor-icon-link" anchorid="section112106597136" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>该接口的调用需要在开发者联盟申请设备基础信息权限（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>）。</p>      </div></div></div>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>     </ol>     <ol start="3">      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1737133513289" target="_blank">getRemoteAppVersion</a>方法，获取指定设备对应的应用版本号。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将设备侧应用包名定义为remoteBundleName</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">remoteBundleName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤3 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤4 获取指定设备对应的应用版本号</span></li><li>p2pClient.<span class="hljs-title function_">getRemoteAppVersion</span>(targetDevice.<span class="hljs-property">randomId</span>, remoteBundleName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">version</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in getting remote app version, version is <span class="hljs-subst">${version}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to check get remote app version. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section25081840087">手机侧应用拉起设备侧应用<i class="anchor-icon anchor-icon-link" anchorid="section25081840087" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>该接口的调用需要在开发者联盟申请设备基础信息权限（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>）。</p>      </div></div></div>     <p>在发送点对点消息前，可以用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section169404201361" target="_blank">startRemoteApp</a>方法拉起设备侧应用。</p>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section169404201361" target="_blank">startRemoteApp</a>方法，指定需要拉起设备侧应用包名。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section169404201361" target="_blank">transformLocalBundleName</a>默认值为false，传入为true时，wearEngine会将本地的应用包名和指纹转换为兼容应用在云侧存储的包名和指纹，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>章节。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将设备侧应用包名定义为remoteBundleName</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">remoteBundleName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤3 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>  </li><li><span class="hljs-comment">// 步骤4 拉起设备侧指定应用(transformLocalBundleName不传入参数，默认为false)</span></li><li>p2pClient.<span class="hljs-title function_">startRemoteApp</span>(targetDevice.<span class="hljs-property">randomId</span>, remoteBundleName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">p2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in starting remote app, result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to start remote app. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section13394931203213">手机侧应用发送点对点消息或文件到穿戴设备侧应用<i class="anchor-icon anchor-icon-link" anchorid="section13394931203213" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>该接口的调用需要在开发者联盟申请设备基础信息权限（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>）。</p>      </div></div></div>     <p>消息长度大小的限制为4096字节。针对消息长度超过限制的情况可以采用发送文件（文件大小不超过100MB）的方式或进行消息分包控制。</p>     <p>手机侧实现发送消息和文件功能后，穿戴设备侧应用需要对应实现接收消息和文件的功能。</p>    </div>    <div class="tiledSection">     <h3 id="section1641421982617" class="firsth2">发送点对点消息<i class="anchor-icon anchor-icon-link" anchorid="section1641421982617" tips="复制节点链接"></i></h3>          <p>为了使用工具类构造消息体，请先导入所需模块。</p>     <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>      <li><span>构造需要发送的消息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section188531948121319" target="_blank">P2pMessage</a>。</span></li>     </ol>     <ol start="5">      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10826949193413" target="_blank">sendMessage</a>方法，从手机上的应用发送简短消息到穿戴设备侧对应的应用。设备侧已注册监听消息接收后，即可收到手机发送的消息。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤3 构造设备侧应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-comment">// 设置设备侧应用的应用信息：包名与指纹</span></li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>  <span class="hljs-comment">// transformLocalAppInfo默认为false，不转换包名指纹</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置需要发送的消息内容，长度限制为4096字节</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">messageContent</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'this is message'</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造消息结构体</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">textEncoder</span>: util.<span class="hljs-property">TextEncoder</span> = <span class="hljs-keyword">new</span> util.<span class="hljs-property">TextEncoder</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">message</span>: wearEngine.<span class="hljs-property">P2pMessage</span> = {</li><li>  <span class="hljs-attr">content</span>: textEncoder.<span class="hljs-title function_">encodeInto</span>(messageContent)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤6 发送消息</span></li><li>p2pClient.<span class="hljs-title function_">sendMessage</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, message).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">p2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in sending message, result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to send message. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section17422551112517">发送文件<i class="anchor-icon anchor-icon-link" anchorid="section17422551112517" tips="复制节点链接"></i></h3>          <p>为能正确打开文件描述符，请先导入模块。</p>     <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>     </ol>     <ol start="4">      <li><span>根据文件路径filePath，构造需要发送的文件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1223384152" target="_blank">P2pFile</a>。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section16802133114448" target="_blank">transferFile</a>方法，从手机上的应用发送文件到穿戴设备侧对应的应用。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤3 构造设备侧应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-comment">// 设置设备侧应用的应用信息：包名与指纹</span></li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>  <span class="hljs-comment">// transformLocalAppInfo默认为false，不转换包名指纹</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造需要发送的文件</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pfile</span>: wearEngine.<span class="hljs-property">P2pFile</span> = {</li><li>  <span class="hljs-comment">// 设置需要发送的文件路径，其中不能包含'..'</span></li><li>  <span class="hljs-attr">file</span>: fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-string">''</span>)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤6 发送指定文件至设备</span></li><li>p2pClient.<span class="hljs-title function_">transferFile</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, p2pfile, <span class="hljs-function">(<span class="hljs-params">error: BusinessError, p2pResult: wearEngine.P2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// callback处理逻辑</span></li><li>  <span class="hljs-keyword">if</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to transfer file. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">code</span>) {</li><li>    <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">code</span> === wearEngine.<span class="hljs-property">P2pResultCode</span>.<span class="hljs-property">COMMUNICATION_SUCCESS</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in transferring file, the result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Failed to transfer file, the error code is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">progress</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in transferring file, the progress is <span class="hljs-subst">${p2pResult.progress}</span>.`</span>);</li><li>  }</li><li>});</li><li>
</li><li>fileIo.<span class="hljs-title function_">close</span>(p2pfile.<span class="hljs-property">file</span>);</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section104918211993">取消发送文件<i class="anchor-icon anchor-icon-link" anchorid="section104918211993" tips="复制节点链接"></i></h3>          <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>     </ol>     <ol start="4">      <li><span>根据文件路径filePath，构造需要取消发送的文件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1223384152" target="_blank">P2pFile</a>。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section67354131415" target="_blank">cancelFileTransfer</a>方法，取消从手机上的应用到穿戴设备侧对应的应用的文件发送。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤3 构造设备侧应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-comment">// 设置设备侧应用的应用信息：包名与指纹</span></li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>  <span class="hljs-comment">// transformLocalAppInfo默认为false，不转换包名指纹</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造需要发送的文件</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pfile</span>: wearEngine.<span class="hljs-property">P2pFile</span> = {</li><li>  <span class="hljs-comment">// 设置需要发送的文件路径，其中不能包含'..'</span></li><li>  <span class="hljs-attr">file</span>: fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-string">''</span>)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 发送指定文件至设备</span></li><li>p2pClient.<span class="hljs-title function_">transferFile</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, p2pfile, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-comment">// 回调函数执行逻辑</span></li><li>})</li><li>
</li><li><span class="hljs-comment">// 步骤6 取消发送文件</span></li><li>p2pClient.<span class="hljs-title function_">cancelFileTransfer</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, p2pfile).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">p2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">code</span> === wearEngine.<span class="hljs-property">P2pResultCode</span>.<span class="hljs-property">COMMUNICATION_SUCCESS</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in cancelling transfer file, the result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>  }</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to cancel transfer file. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li><li>
</li><li>fileIo.<span class="hljs-title function_">close</span>(p2pfile.<span class="hljs-property">file</span>);</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section11891149183312">订阅接收穿戴设备侧应用发过来的消息<i class="anchor-icon anchor-icon-link" anchorid="section11891149183312" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>该接口的调用需要在开发者联盟申请设备基础信息权限（请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_apply">申请接入Wear Engine服务</a>）。</p>      </div></div></div>     <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>      <li><span>构造接收到设备侧传来消息后的回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-base#callback" target="_blank">Callback</a>。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section893873771918" target="_blank">registerMessageReceiver</a>方法，订阅监听消息接收事件。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤3 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造设备侧应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-comment">// 将设备侧应用参数类定义为appParam</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>  <span class="hljs-comment">// transformLocalAppInfo默认为false，不转换包名指纹</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 构造回调函数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params">p2pMessage: wearEngine.P2pMessage</span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in receiving message, the message is <span class="hljs-subst">${p2pMessage.content}</span>.`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤6 订阅监听消息接收事件</span></li><li>p2pClient.<span class="hljs-title function_">registerMessageReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in registering message receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register message receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>     <ol start="7">      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section13676139154415" target="_blank">unregisterMessageReceiver</a>方法，手机应用取消接收穿戴设备侧应用发过来的消息，需要传入订阅监听时的同一个回调函数对象。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>p2pClient.<span class="hljs-title function_">unregisterMessageReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in unregistering message receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister message receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section107827437118">订阅接收穿戴设备侧发送过来的文件<i class="anchor-icon anchor-icon-link" anchorid="section107827437118" tips="复制节点链接"></i></h2>          <ol>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/query_connected_devices">已连接穿戴设备查询</a>章节，获取已连接设备列表。</span></li>      <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/we-device-selection">目标设备选择</a>章节，从已连接设备列表中选定需要通信的设备。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api" target="_blank">wearEngine</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>      <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>      <li><span>构造接收到设备侧传来文件后的回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-base#callback" target="_blank">Callback</a>。</span></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1899163313713" target="_blank">registerFileReceiver</a>方法，订阅监听文件接收事件。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤3 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造设备侧应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-comment">// 将设备侧应用参数类定义为appParam</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>  <span class="hljs-comment">// transformLocalAppInfo默认为false，不转换包名指纹</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 构造回调函数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params">p2pMessage: wearEngine.P2pFile</span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in receiving file.`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤6 订阅监听文件接收事件</span></li><li>p2pClient.<span class="hljs-title function_">registerFileReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in registering file receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register file receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>     <ol start="7">      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section146072474497" target="_blank">unregisterFileReceiver</a>方法，手机应用取消接收穿戴设备侧应用发过来的文件，需要传入订阅监听时的同一个回调函数对象。</span>       <p></p>       <div _ngcontent-xyj-c106="" class="highlight-div"><div _ngcontent-xyj-c106="" class="highlight-div-header"><div _ngcontent-xyj-c106="" class="highlight-div-header-left"><div _ngcontent-xyj-c106="" class="handle-button expand-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xyj-c106="" class="highlight-div-header-right"><div _ngcontent-xyj-c106="" class="handle-button ai-button"></div><div _ngcontent-xyj-c106="" class="handle-button line-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xyj-c106="" class="handle-button theme-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xyj-c106="" class="handle-button copy-button"><div _ngcontent-xyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>p2pClient.<span class="hljs-title function_">unregisterFileReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in unregistering file receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister file receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>