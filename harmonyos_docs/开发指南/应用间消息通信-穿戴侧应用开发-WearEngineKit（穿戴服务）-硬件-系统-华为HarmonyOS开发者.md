<h1 _ngcontent-tna-c119="" class="doc-title ng-star-inserted" title="应用间消息通信"> 应用间消息通信 </h1>

<div _ngcontent-tna-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>使用该功能前，请确保对端设备侧已有对应的应用（参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wearengine_phonedev">手机侧应用开发</a>）。</li>       <li>对端设备侧应用和穿戴设备应用必须同时处于已启动状态。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="section1071219917471">穿戴侧应用检测对端设备侧应用是否安装<i class="anchor-icon anchor-icon-link" anchorid="section1071219917471" tips="复制节点链接"></i></h2>         </div>    <ol>     <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/watch_query_connected_devices">已连接对端设备查询</a>章节，从已连接设备列表中选定需要通信的对端设备。</span></li>    </ol>    <ol start="2">     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section28747514219" target="_blank">isRemoteAppInstalled</a>方法，查看对端设备是否安装指定应用。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将对端应用包名定义为remoteBundleName</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">remoteBundleName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤2 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤3 查看是否安装指定的对端应用</span></li><li>p2pClient.<span class="hljs-title function_">isRemoteAppInstalled</span>(targetDevice.<span class="hljs-property">randomId</span>, remoteBundleName).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">isInstall</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in checking remote app install, result is <span class="hljs-subst">${isInstall}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to check remote app install. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h2 id="section166671457144719">穿戴侧应用发送点对点消息或文件到对端应用<i class="anchor-icon anchor-icon-link" anchorid="section166671457144719" tips="复制节点链接"></i></h2>         </div>    <p>消息长度大小的限制为4096字节。针对消息长度超过限制的情况可以采用发送文件（文件大小不超过100MB）的方式或进行消息分包控制。</p>    <p>穿戴侧实现发送消息和文件功能后，对端应用需要实现接收消息和文件的功能。</p>    <div class="tiledSection">     <h3 id="section312313514502" class="firsth2">发送点对点消息<i class="anchor-icon anchor-icon-link" anchorid="section312313514502" tips="复制节点链接"></i></h3>         </div>    <p>为了使用工具类构造消息体，请先导入所需模块。</p>    <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li></ol></pre></div></div>    <ol>     <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/watch_query_connected_devices">已连接对端设备查询</a>章节，从已连接设备列表中选定需要通信的对端设备。</span></li>     <li><span>构造对端应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>     <li><span>构造需要发送的消息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section188531948121319" target="_blank">P2pMessage</a>。</span></li>    </ol>    <ol start="4">     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10826949193413" target="_blank">sendMessage</a>方法，从穿戴侧应用发送简短消息到对端应用。对端应用已注册监听消息接收后，即可收到穿戴侧应用发送的消息。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤2 构造对端应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-comment">// 设置对端应用的应用信息：包名与指纹</span></li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置需要发送的消息内容，长度限制为4096字节</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">messageContent</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'this is message'</span>;</li><li>
</li><li><span class="hljs-comment">// 步骤3 构造消息结构体</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">textEncoder</span>: util.<span class="hljs-property">TextEncoder</span> = <span class="hljs-keyword">new</span> util.<span class="hljs-property">TextEncoder</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">message</span>: wearEngine.<span class="hljs-property">P2pMessage</span> = {</li><li>  <span class="hljs-attr">content</span>: textEncoder.<span class="hljs-title function_">encodeInto</span>(messageContent)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤5 发送消息</span></li><li>p2pClient.<span class="hljs-title function_">sendMessage</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, message).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">p2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in sending message, result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to send message. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h3 id="section566174154913">发送文件<i class="anchor-icon anchor-icon-link" anchorid="section566174154913" tips="复制节点链接"></i></h3>         </div>    <p>发送文件前需要打开文件描述符，请先导入模块。</p>    <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div>    <ol>     <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/watch_query_connected_devices">已连接对端设备查询</a>章节，从已连接设备列表中选定需要通信的对端设备。</span></li>     <li><span>构造对端应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>    </ol>    <ol start="3">     <li><span>根据文件路径filePath，构造需要发送的文件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1223384152" target="_blank">P2pFile</a>。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section16802133114448" target="_blank">transferFile</a>方法，从穿戴侧应用发送文件到对端应用。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤2 构造对端应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-comment">// 设置对端应用的应用信息：包名与指纹</span></li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤3 构造需要发送的文件</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pfile</span>: wearEngine.<span class="hljs-property">P2pFile</span> = {</li><li>  <span class="hljs-comment">// 设置需要发送的文件路径，其中不能包含'..'</span></li><li>  <span class="hljs-attr">file</span>: fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-string">''</span>)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤5 发送指定文件至对端</span></li><li>p2pClient.<span class="hljs-title function_">transferFile</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, p2pfile, <span class="hljs-function">(<span class="hljs-params">error: BusinessError, p2pResult: wearEngine.P2pResult</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// callback处理逻辑</span></li><li>  <span class="hljs-keyword">if</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to transfer file. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">code</span>) {</li><li>    <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">code</span> === wearEngine.<span class="hljs-property">P2pResultCode</span>.<span class="hljs-property">COMMUNICATION_SUCCESS</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in transferring file, the result is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Failed to transfer file, the error code is <span class="hljs-subst">${p2pResult.code}</span>.`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (p2pResult.<span class="hljs-property">progress</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in transfering file, the progress is <span class="hljs-subst">${p2pResult.progress}</span>.`</span>);</li><li>  }</li><li>});</li><li>
</li><li>fileIo.<span class="hljs-title function_">close</span>(p2pfile.<span class="hljs-property">file</span>);</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h2 id="section09454216506">订阅接收对端应用发来的消息<i class="anchor-icon anchor-icon-link" anchorid="section09454216506" tips="复制节点链接"></i></h2>         </div>    <ol>     <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/watch_query_connected_devices">已连接对端设备查询</a>章节，从已连接设备列表中选定需要通信的对端设备。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>     <li><span>构造对端应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>     <li><span>构造接收到对端传来消息后的回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-base#callback" target="_blank">Callback</a>。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section893873771918" target="_blank">registerMessageReceiver</a>方法，订阅监听消息接收事件。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤2 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤3 构造对端应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-comment">// 将对端应用参数类定义为appParam</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造回调函数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params">p2pMessage: wearEngine.P2pMessage</span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in receiving message, the message is <span class="hljs-subst">${p2pMessage.content}</span>.`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 订阅监听消息接收事件</span></li><li>p2pClient.<span class="hljs-title function_">registerMessageReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in registering message receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register message receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <ol start="6">     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section13676139154415" target="_blank">unregisterMessageReceiver</a>方法，穿戴侧应用取消接收对端应用发过来的消息，需要传入订阅监听时的同一个回调函数对象。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>p2pClient.<span class="hljs-title function_">unregisterMessageReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in unregistering message receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister message receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h2 id="section1416211465509">订阅接收对端应用发送来的文件<i class="anchor-icon anchor-icon-link" anchorid="section1416211465509" tips="复制节点链接"></i></h2>         </div>    <ol>     <li><span>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/watch_query_connected_devices">已连接对端设备查询</a>章节，从已连接设备列表中选定需要通信的对端设备。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section15604103515412" target="_blank">getP2pClient</a>方法，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section10175450143316" target="_blank">P2pClient</a>对象。</span></li>     <li><span>构造设备侧应用参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section7874153142020" target="_blank">P2pAppParam</a>。</span></li>     <li><span>构造接收到设备侧传来文件后的回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-base#callback" target="_blank">Callback</a>。</span></li>     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section1899163313713" target="_blank">registerFileReceiver</a>方法，订阅监听文件接收事件。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 步骤2 获取P2pClient对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">p2pClient</span>: wearEngine.<span class="hljs-property">P2pClient</span> = wearEngine.<span class="hljs-title function_">getP2pClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>());</li><li>
</li><li><span class="hljs-comment">// 步骤3 构造对端应用参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: wearEngine.<span class="hljs-property">AppInfo</span> = {</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-attr">fingerprint</span>: <span class="hljs-string">''</span></li><li>}</li><li><span class="hljs-comment">// 将对端应用参数类定义为appParam</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">appParam</span>: wearEngine.<span class="hljs-property">P2pAppParam</span> = {</li><li>  <span class="hljs-attr">remoteApp</span>: appInfo</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤4 构造回调函数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params">p2pMessage: wearEngine.P2pFile</span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in receiving file.`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 步骤5 订阅监听文件接收事件</span></li><li>p2pClient.<span class="hljs-title function_">registerFileReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in registering file receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register file receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <ol start="6">     <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wearengine_api#section146072474497" target="_blank">unregisterFileReceiver</a>方法，穿戴侧应用取消接收对端应用发过来的文件，需要传入订阅监听时的同一个回调函数对象。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>p2pClient.<span class="hljs-title function_">unregisterFileReceiver</span>(targetDevice.<span class="hljs-property">randomId</span>, appParam, callback).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in unregistering file receiver.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to unregister file receiver. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>})</li></ol></pre></div></div>      <p></p></li>    </ol>    <div class="tiledSection">     <h2 id="section1928866172518">对端应用通过startRemoteApp方法拉起穿戴侧应用<i class="anchor-icon anchor-icon-link" anchorid="section1928866172518" tips="复制节点链接"></i></h2>         </div>    <p>如果对端应用通过调用startRemoteApp方法拉起穿戴侧应用时，需要在穿戴侧配置需要拉起的页面。</p>    <ol>     <li><span>创建名为HiWearMainAbility.ets的文件，需继承UIAbility，重写onWindowStageCreate函数，配置要跳转的界面。</span>      <p></p>      <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 必须继承UIAbility</span></li><li><span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">UIAbility</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.UIAbility'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-variable language_">window</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.window'</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 对端应用通过startRemoteApp方法拉起穿戴侧应用的HiWearMainAbility</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HiWearMainAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'HiWearMainAbility'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 配置要跳转的界面为”XXXPage”</span></li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">"pages/XXXPage"</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'HiWearMainAbility'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'HiWearMainAbility'</span>, <span class="hljs-string">'Succeeded in loading the content. Data: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) ?? <span class="hljs-string">''</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div>      <p></p></li>     <li><span>在module.json5中的abilities中配置HiWearMainAbility。更多配置详情参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#abilities标签" target="_blank">abilities标签</a>。</span>      <p></p>      <ul>       <li>配置name为HiWearMainAbility。</li>       <li>配置srcEntry为HiWearMainAbility.ets文件的路径。</li>       <li>配置startWindowIcon为标识当前UIAbility组件启动页面图标资源文件的索引。</li>       <li>配置startWindowBackground为标识当前UIAbility组件启动页面背景颜色资源文件的索引。        <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"module"</span>: {</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"type"</span>: <span class="hljs-string">"entry"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"mainElement"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"deviceTypes"</span>: [],</li><li>  <span class="hljs-string">"pages"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"abilities"</span>: [</li><li>    {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"HiWearMainAbility"</span>,</li><li>    <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>    <span class="hljs-string">"startWindowIcon"</span>: <span class="hljs-string">"xxxx"</span>, <span class="hljs-comment">// 标识当前UIAbility组件启动页面图标资源文件的索引</span></li><li>    <span class="hljs-string">"startWindowBackground"</span>: <span class="hljs-string">"xxxx"</span> <span class="hljs-comment">// 标识当前UIAbility组件启动页面背景颜色资源文件的索引</span></li><li>  }],</li><li>  <span class="hljs-string">"metadata"</span>: []</li><li>  }</li></ol></pre></div></div></li>      </ul>      <p></p></li>     <li><span>在module.json5中的metadata中配置对端应用包名、待拉起的Ability名称，以及是否要等待穿戴侧完成订阅消息接收或者文件接收。</span>      <p></p>      <ul>       <li>对端应用包名配置时，name为wearEngineRemoteAppNameList，value为具体的对端应用包名，如果存在多个应用包名，使用英文逗号隔开，value值最长不超过4KB；</li>       <li>Ability名称配置时，name为wearEngineUIAbilityName，value为指定要拉起的UIAbility名称，不配置默认拉起HiWearMainAbility；</li>       <li>AwaitRegisterReceiver配置时，name为wearEngineAwaitRegisterReceiver，value取值为true、false。true表示要等待穿戴侧完成订阅消息接收或者文件接收，false则反之。        <div _ngcontent-tna-c106="" class="highlight-div"><div _ngcontent-tna-c106="" class="highlight-div-header"><div _ngcontent-tna-c106="" class="highlight-div-header-left"><div _ngcontent-tna-c106="" class="handle-button expand-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tna-c106="" class="highlight-div-header-right"><div _ngcontent-tna-c106="" class="handle-button ai-button"></div><div _ngcontent-tna-c106="" class="handle-button line-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tna-c106="" class="handle-button theme-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tna-c106="" class="handle-button copy-button"><div _ngcontent-tna-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tna-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"module"</span>: {</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"type"</span>: <span class="hljs-string">"entry"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"mainElement"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"deviceTypes"</span>: [],</li><li>  <span class="hljs-string">"pages"</span>: <span class="hljs-string">"xxxx"</span>,</li><li>  <span class="hljs-string">"abilities"</span>: [],</li><li>  <span class="hljs-string">"metadata"</span>: [ <span class="hljs-comment">// 配置如下信息</span></li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"wearEngineRemoteAppNameList"</span>,</li><li>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"xxxx1,xxxx2,xxxx3"</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"wearEngineUIAbilityName"</span>,</li><li>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"xxxx"</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"wearEngineAwaitRegisterReceiver"</span>,</li><li>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"true"</span></li><li>      }</li><li>  ]}</li></ol></pre></div></div></li>      </ul>      <p></p></li>    </ol>   </div>   <div></div></div>