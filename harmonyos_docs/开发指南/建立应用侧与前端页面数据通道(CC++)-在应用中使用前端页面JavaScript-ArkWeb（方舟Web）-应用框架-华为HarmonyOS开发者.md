<h1 _ngcontent-fxg-c119="" class="doc-title ng-star-inserted" title="建立应用侧与前端页面数据通道(C/C++)"> 建立应用侧与前端页面数据通道(C/C++) </h1>

<div _ngcontent-fxg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>前端页面和应用侧之间可以使用Native方法实现两端通信（以下简称Native PostWebMessage），可解决ArkTS环境的冗余切换，同时允许发送消息、回调在非UI线程上运行，避免造成UI阻塞。当前只支持string和buffer数据类型。</p>    <div class="tiledSection">     <h2 id="适用的应用架构">适用的应用架构<i class="anchor-icon anchor-icon-link" anchorid="适用的应用架构" tips="复制节点链接"></i></h2>          <p>应用使用ArkTS、C++语言混合开发，或本身应用架构较贴近于小程序架构，自带C++侧环境，推荐使用ArkWeb在Native侧提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-webmessageapi" target="_blank">ArkWeb_WebMessageAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-webmessageportapi" target="_blank">ArkWeb_WebMessagePortAPI</a>实现PostWebMessage功能。</p>     <p><span><img originheight="409" originwidth="576" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114741.33179398692707213622365561982830:50001231000000:2800:BED8C1F566827220D5FB8D8BABC49B7815FD1986DC2DEF9EA550B17156A02392.png" width="576" height="409"></span></p>     <p>上图展示了具有普遍适用性的小程序的通用架构。在这一架构中，逻辑层依赖于应用程序自带的JavaScript运行时，该运行时在一个已有的C++环境中运行。通过Native接口，逻辑层能够直接在C++环境中与视图层（其中ArkWeb充当渲染器）进行通信，无需回退至ArkTS环境使用ArkTS PostWebMessage接口。</p>     <p>左图是使用ArkTS PostWebMessage接口构建小程序的方案，如红框所示，应用需要先调用到ArkTS环境，再调用到C++环境。右图是使用Native PostWebMessage接口构建小程序的方案，不需要ArkTS环境和C++环境的切换，执行效率更高。</p>     <p><span><img originheight="376" originwidth="1211" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114742.87107860794811310902868879136257:50001231000000:2800:FBC084B56A006520C1D5A0545F73AC518E9C4F7F195469B16676EE5F34FAD017.png" width="920" height="285.6482246077622"></span></p>    </div>    <div class="tiledSection">     <h2 id="使用native接口实现postwebmessage通信">使用Native接口实现PostWebMessage通信<i class="anchor-icon anchor-icon-link" anchorid="使用native接口实现postwebmessage通信" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="使用native接口绑定arkweb" class="firsth2">使用Native接口绑定ArkWeb<i class="anchor-icon anchor-icon-link" anchorid="使用native接口绑定arkweb" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>ArkWeb组件声明在ArkTS侧，需要用户自定义一个标识webTag，并将webTag通过Node-API传至应用C++侧。后续ArkWeb Native接口使用时，均需webTag作为对应组件的唯一标识。</p></li>      <li>       <p>ArkTS侧</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-comment">// 自定义webTag，在WebviewController创建时作为入参传入，建立controller与webTag的映射关系</span></li><li><span class="hljs-attr">webTag</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'ArkWeb1'</span>;</li><li><span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// aboutToAppear中将webTag通过Node-API接口传入C++侧，作为C++侧ArkWeb组件的唯一标识</span></li><li><span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>)</li><li>  <span class="hljs-comment">// 初始化web ndk</span></li><li>  testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="使用native接口获取api结构体">使用Native接口获取API结构体<i class="anchor-icon anchor-icon-link" anchorid="使用native接口获取api结构体" tips="复制节点链接"></i></h3>          <p>ArkWeb Native侧需先获取API结构体，才能调用结构体里的Native API。ArkWeb Native侧API通过函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-interface-h#oh_arkweb_getnativeapi" target="_blank">OH_ArkWeb_GetNativeAPI</a>获取，根据入参type不同，可获取对应的函数指针结构体。其中本指导涉及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi" target="_blank">ArkWeb_ControllerAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-webmessageapi" target="_blank">ArkWeb_WebMessageAPI</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-webmessageportapi" target="_blank">ArkWeb_WebMessagePortAPI</a>。</p>     <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> ArkWeb_ControllerAPI *controller = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_WebMessagePortAPI *webMessagePort = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> ArkWeb_WebMessageAPI *webMessage = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// ...</span></li><li>controller = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_ControllerAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_CONTROLLER));</li><li>webMessagePort =</li><li>    <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_WebMessagePortAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_WEB_MESSAGE_PORT));</li><li>webMessage = <span class="hljs-built_in">reinterpret_cast</span>&lt;ArkWeb_WebMessageAPI *&gt;(<span class="hljs-built_in">OH_ArkWeb_GetNativeAPI</span>(ARKWEB_NATIVE_WEB_MESSAGE));</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h3>          <p>在调用API前建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-type-h#宏定义" target="_blank">ARKWEB_MEMBER_MISSING</a>校验该函数结构体是否有对应函数指针，避免SDK与设备ROM不匹配导致crash问题。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#createwebmessageports" target="_blank">createWebMessagePorts</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-controllerapi#postwebmessage" target="_blank">postWebMessage</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-web-arkweb-webmessageportapi#close" target="_blank">close</a>需运行在UI线程。</p>     <ul>      <li>       <p>前端页面代码</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- entry/src/main/resources/rawfile/index.html --&gt;</span></li><li><span class="hljs-comment">&lt;!-- index.html --&gt;</span></li><li><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en-gb"</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>etsRunJavaScriptExt测试demo<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"h1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"msg"</span>&gt;</span>Receive string:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"msg2"</span>&gt;</span>Receive arraybuffer:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></li><li>
</li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">var</span> h5Port;</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> == <span class="hljs-string">'init_web_messageport'</span>) {</span></li><li><span class="language-javascript">        <span class="hljs-keyword">const</span> port = event.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 1. 保存从应用侧发送过来的端口。</span></span></li><li><span class="language-javascript">        <span class="hljs-keyword">if</span> (port) {</span></li><li><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"hwd In html got message"</span>);</span></li><li><span class="language-javascript">            h5Port = port;</span></li><li><span class="language-javascript">            port.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {</span></li><li><span class="language-javascript">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"hwd In html got message"</span>);</span></li><li><span class="language-javascript">                <span class="hljs-comment">// 2. 接收应用侧发送过来的消息.</span></span></li><li><span class="language-javascript">                <span class="hljs-keyword">var</span> result = event.<span class="hljs-property">data</span>;</span></li><li><span class="language-javascript">                <span class="hljs-keyword">var</span> type_s = <span class="hljs-keyword">typeof</span> (result)</span></li><li><span class="language-javascript">                <span class="hljs-keyword">switch</span> (type_s) {</span></li><li><span class="language-javascript">                    <span class="hljs-keyword">case</span> <span class="hljs-string">"object"</span>:</span></li><li><span class="language-javascript">                        <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ArrayBuffer</span>) {</span></li><li><span class="language-javascript">                            type_s = <span class="hljs-string">"ArrayBuffer"</span>;</span></li><li><span class="language-javascript">                            <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(result);</span></li><li><span class="language-javascript">                            <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);</span></li><li><span class="language-javascript">                            result = decoder.<span class="hljs-title function_">decode</span>(result);</span></li><li><span class="language-javascript">                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {</span></li><li><span class="language-javascript">                            type_s = <span class="hljs-string">"Error"</span>;</span></li><li><span class="language-javascript">                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>) {</span></li><li><span class="language-javascript">                            type_s = <span class="hljs-string">"Array"</span>;</span></li><li><span class="language-javascript">                        }</span></li><li><span class="language-javascript">                        <span class="hljs-keyword">break</span>;</span></li><li><span class="language-javascript">                    <span class="hljs-attr">default</span>:</span></li><li><span class="language-javascript">                        <span class="hljs-keyword">break</span>;</span></li><li><span class="language-javascript">                }</span></li><li><span class="language-javascript">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"H5 recv type: "</span> + type_s + <span class="hljs-string">"\nH5 recv result: "</span> + result)</span></li><li><span class="language-javascript">                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"msg"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"recv type: "</span> + type_s;</span></li><li><span class="language-javascript">                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"msg2"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"recv value: "</span> + result;</span></li><li><span class="language-javascript">            }</span></li><li><span class="language-javascript">            h5Port.<span class="hljs-property">onmessageerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span></li><li><span class="language-javascript">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`hwd In html Error receiving message: <span class="hljs-subst">${event}</span>`</span>);</span></li><li><span class="language-javascript">            };</span></li><li><span class="language-javascript">        }</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">})</span></li><li><span class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">message, url, line, column, error</span>) {</span></li><li><span class="language-javascript">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"JavaScript Error: "</span> + message + <span class="hljs-string">" on line "</span> + line + <span class="hljs-string">" in "</span> + url);</span></li><li><span class="language-javascript">  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"h1"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"执行函数失败"</span></span></li><li><span class="language-javascript">};</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-comment">// 3. 使用h5Port向应用侧发送消息。</span></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postStringToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">"send string from H5"</span>);</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postBufferToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        <span class="hljs-keyword">const</span> str = <span class="hljs-string">"Hello, World!"</span>;</span></li><li><span class="language-javascript">        <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();</span></li><li><span class="language-javascript">        <span class="hljs-keyword">const</span> uint8Array = encoder.<span class="hljs-title function_">encode</span>(str);</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>(uint8Array.<span class="hljs-property">buffer</span>);</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postJsonToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        <span class="hljs-keyword">var</span> e = {<span class="hljs-string">"json"</span>: <span class="hljs-string">"json"</span>};</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>(e);</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postArrayStringToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>([<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>]);</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postNumberToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-number">123</span>);</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {</span></li><li><span class="language-javascript">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-comment">// 构造器</span></span></li><li><span class="language-javascript">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myProperty</span> = <span class="hljs-string">'Hello, World!'</span>;</span></li><li><span class="language-javascript">  }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">  <span class="hljs-title function_">myMethod</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-comment">// 实例方法</span></span></li><li><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myProperty</span>);</span></li><li><span class="language-javascript">  }</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript">  <span class="hljs-keyword">static</span> <span class="hljs-title function_">myStaticMethod</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-comment">// 静态方法</span></span></li><li><span class="language-javascript">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'This is a static method.'</span>);</span></li><li><span class="language-javascript">  }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">postObjectToApp</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-javascript">    <span class="hljs-keyword">if</span> (h5Port) {</span></li><li><span class="language-javascript">        h5Port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>());</span></li><li><span class="language-javascript">    } <span class="hljs-keyword">else</span> {</span></li><li><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"In html h5port is null, please init first"</span>);</span></li><li><span class="language-javascript">    }</span></li><li><span class="language-javascript">}</span></li><li><span class="language-javascript"></span></li><li><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div></li>      <li>       <p>ArkTS侧代码</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li><span class="hljs-keyword">import</span> web_webview <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.web.webview'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;</li><li>
</li><li>@<span class="hljs-title class_">Entry</span></li><li>@<span class="hljs-title class_">Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title class_">State</span> <span class="hljs-attr">webTag</span>: string = <span class="hljs-string">'postMessage'</span>;</li><li>  <span class="hljs-attr">controller</span>: web_webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> web_webview.<span class="hljs-title class_">WebviewController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  @<span class="hljs-title class_">State</span> <span class="hljs-attr">h5Log</span>: string = <span class="hljs-string">'Display received message send from HTML'</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    web_webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">setWebDebuggingAccess</span>(<span class="hljs-literal">true</span>);</li><li>    <span class="hljs-comment">// 初始化web ndk</span></li><li>    testNapi.<span class="hljs-title function_">nativeWebInit</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"aboutToDisappear"</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Scroll</span>() {</li><li>      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>        <span class="hljs-comment">// 展示H5接收到的内容</span></li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"H5侧接收到应用侧发送消息展示"</span>)</li><li>        <span class="hljs-title class_">TextArea</span>({<span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span>})</li><li>          .<span class="hljs-title function_">id</span>(<span class="hljs-string">"log_area"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>          .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span> })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"应用侧按钮"</span>)</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'createNoControllerTagPort'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"create_no_tag_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">createWebMessagePorts</span>(<span class="hljs-string">"noTag"</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'createPort'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"create_port_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">createWebMessagePorts</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>
</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setHandler'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"set_handler_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">setMessageEventHandler</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>
</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'setHandlerThread'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"set_handler_thread_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">setMessageEventHandlerThread</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'SendString'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"send_string_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span> = <span class="hljs-string">""</span></li><li>                testNapi.<span class="hljs-title function_">postMessage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'SendStringThread'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"send_string_thread_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span> = <span class="hljs-string">""</span></li><li>                testNapi.<span class="hljs-title function_">postMessageThread</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'SendBuffer'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"send_buffer_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span> = <span class="hljs-string">""</span></li><li>                testNapi.<span class="hljs-title function_">postBufferMessage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'SendNone'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"send_none_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span> = <span class="hljs-string">""</span></li><li>                testNapi.<span class="hljs-title function_">postNoneMessage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>
</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'closePort'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"close_port_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">closeMessagePort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'destroyNullPort'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"destroy_null_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">destroyNullMessagePort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'destroyPort'</span>)</li><li>            .<span class="hljs-title function_">id</span>(<span class="hljs-string">"destroy_port_btn"</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">try</span> {</li><li>                testNapi.<span class="hljs-title function_">destroyMessagePort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webTag</span>);</li><li>              } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>              }</li><li>            })</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span> })</li><li>
</li><li>        <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">"H5侧发送按钮"</span>)</li><li>          <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5String'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_string_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"for(var i = 0; i &lt; 2000; i++) postStringToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5Buffer'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_buffer_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"postBufferToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5Number'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_number_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"postNumberToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>          }</li><li>
</li><li>          <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5Json'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_json_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"postJsonToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5Array'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_array_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"postArrayStringToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'H5Object'</span>)</li><li>              .<span class="hljs-title function_">id</span>(<span class="hljs-string">"h5_send_object_btn"</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(<span class="hljs-string">"postObjectToApp()"</span>)</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                }</li><li>              })</li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span> })</li><li>
</li><li>        <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">onConsole</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (event) {</li><li>              <span class="hljs-keyword">let</span> msg = event.<span class="hljs-property">message</span>.<span class="hljs-title function_">getMessage</span>()</li><li>              <span class="hljs-keyword">if</span> (msg.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"H5"</span>)) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span> = event.<span class="hljs-property">message</span>.<span class="hljs-title function_">getMessage</span>() + <span class="hljs-string">"\n"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Log</span></li><li>              }</li><li>            }</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>          })</li><li>      }</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">scrollable</span>(<span class="hljs-title class_">ScrollDirection</span>.<span class="hljs-property">Vertical</span>)</li><li>    .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>    .<span class="hljs-title function_">edgeEffect</span>(<span class="hljs-title class_">EdgeEffect</span>.<span class="hljs-property">Spring</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API侧暴露ArkTS接口</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">nativeWebInit</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createWebMessagePorts</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">postMessage</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">postNoneMessage</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">setMessageEventHandler</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">closeMessagePort</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">destroyMessagePort</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">postBufferMessage</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">destroyNullMessagePort</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">setMessageEventHandlerThread</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">postMessageThread</span>: <span class="hljs-function">(<span class="hljs-params">webName: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;</li></ol></pre></div></div></li>      <li>       <p>Node-API侧编译配置</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># entry/src/main/cpp/CMakeLists.txt</span></li><li><span class="hljs-comment"># the minimum version of CMake.</span></li><li>cmake_minimum_required(VERSION 3.4.1)</li><li>project(NDKPostMessage)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH <span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span>)</li><li>
</li><li><span class="hljs-keyword">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    include(<span class="hljs-variable">${PACKAGE_FIND_FILE}</span>)</li><li>endif()</li><li>
</li><li>include_directories(<span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span></li><li>                    <span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span>/include)</li><li>
</li><li>add_library(entry SHARED hello.cpp)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># Sets the name of the path variable.</span></li><li>    hilog-lib</li><li>    <span class="hljs-comment"># Specifies the name of the NDK library that</span></li><li>    <span class="hljs-comment"># you want CMake to locate.</span></li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li>target_link_libraries(entry PUBLIC libace_napi.z.so <span class="hljs-variable">${hilog-lib}</span> libohweb.so)</li></ol></pre></div></div></li>      <li>       <p>Node-API层代码</p>       <div _ngcontent-fxg-c106="" class="highlight-div"><div _ngcontent-fxg-c106="" class="highlight-div-header"><div _ngcontent-fxg-c106="" class="highlight-div-header-left"><div _ngcontent-fxg-c106="" class="handle-button expand-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxg-c106="" class="highlight-div-header-right"><div _ngcontent-fxg-c106="" class="handle-button ai-button"></div><div _ngcontent-fxg-c106="" class="handle-button line-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxg-c106="" class="handle-button theme-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxg-c106="" class="handle-button copy-button"><div _ngcontent-fxg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/hello.cpp</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"napi/native_api.h"</span></li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">bits</span>/<span class="hljs-title class_">alltypes</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">memory</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">string</span>&gt;</li><li>#<span class="hljs-variable">include</span> &lt;<span class="hljs-title class_">sys</span>/<span class="hljs-title class_">types</span>.<span class="hljs-title class_">h</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">iostream</span>&gt;</li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">map</span>&gt;</li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"hilog/log.h"</span></li><li>#<span class="hljs-variable">include</span> <span class="hljs-string">"web/arkweb_interface.h"</span></li><li>#<span class="hljs-title class_">include</span> &lt;<span class="hljs-title class_">thread</span>&gt;</li><li>
</li><li><span class="hljs-variable">constexpr</span> <span class="hljs-variable">unsigned</span> <span class="hljs-variable">int</span> <span class="hljs-variable">LOG_PRINT_DOMAIN</span> = <span class="hljs-number">0xFF00</span>;</li><li><span class="hljs-variable">ArkWeb_ControllerAPI</span> *<span class="hljs-variable">controller</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li><span class="hljs-variable">ArkWeb_WebMessagePortAPI</span> *<span class="hljs-variable">webMessagePort</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-variable">ArkWeb_WebMessageAPI</span> *<span class="hljs-variable">webMessage</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-variable">size_t</span> <span class="hljs-variable">web_message_port_size</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">ArkWeb_WebMessagePortPtr</span> *<span class="hljs-variable">g_web_message_port_arr</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">WebMessagePortCallback</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">webTag</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">ArkWeb_WebMessagePortPtr</span> <span class="hljs-variable">port</span>,</li><li>                                  <span class="hljs-keyword">const</span> <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk WebMesagePortCallback webTag:%{public}s,messageType:%{public}d"</span>, <span class="hljs-variable">webTag</span>,</li><li>                <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">getType</span>(<span class="hljs-title class_">message</span>));</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">len</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">void</span> *<span class="hljs-variable">back</span> = <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">getData</span>(<span class="hljs-title class_">message</span>, &amp;<span class="hljs-title class_">len</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">getType</span>(<span class="hljs-title class_">message</span>) == <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_STRING</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                    <span class="hljs-string">"ndk WebMesagePortCallback message:%{public}s,messageSize:%{public}d"</span>, <span class="hljs-variable">back</span>, <span class="hljs-variable">len</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">getType</span>(<span class="hljs-title class_">message</span>) == <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_BUFFER</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                    <span class="hljs-string">"ndk WebMesagePortCallback messageSize:%{public}d"</span>, <span class="hljs-variable">len</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">NativeWebInit</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit start"</span>);</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-variable">controller</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">ArkWeb_ControllerAPI</span> *&gt;(<span class="hljs-title function_">OH_ArkWeb_GetNativeAPI</span>(<span class="hljs-variable">ARKWEB_NATIVE_CONTROLLER</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">controller</span>)</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_ControllerAPI success"</span>);</li><li>
</li><li>    <span class="hljs-variable">webMessagePort</span> =</li><li>        <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">ArkWeb_WebMessagePortAPI</span> *&gt;(<span class="hljs-title function_">OH_ArkWeb_GetNativeAPI</span>(<span class="hljs-variable">ARKWEB_NATIVE_WEB_MESSAGE_PORT</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">webMessagePort</span>)</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_WebMessagePortAPI success"</span>);</li><li>
</li><li>    <span class="hljs-variable">webMessage</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">ArkWeb_WebMessageAPI</span> *&gt;(<span class="hljs-title function_">OH_ArkWeb_GetNativeAPI</span>(<span class="hljs-variable">ARKWEB_NATIVE_WEB_MESSAGE</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">webMessage</span>)</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"get ArkWeb_WebMessageAPI success"</span>);</li><li>
</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk NativeWebInit end"</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">createWebMessagePorts</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 初始化端口</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk createWebMessagePorts begin"</span>);</li><li>    <span class="hljs-variable">g_web_message_port_arr</span> = <span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">createWebMessagePorts</span>(<span class="hljs-title class_">webTagValue</span>, &amp;<span class="hljs-title class_">web_message_port_size</span>);</li><li>    <span class="hljs-comment">// 把其中一个端口发送给HTML</span></li><li>    <span class="hljs-variable">ArkWeb_ErrorCode</span> <span class="hljs-variable">code</span> =</li><li>        <span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">postWebMessage</span>(<span class="hljs-title class_">webTagValue</span>, "<span class="hljs-title class_">init_web_messageport</span>", <span class="hljs-title class_">g_web_message_port_arr</span>, <span class="hljs-number">1</span>, "*");</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postWebMessage ArkWeb_ErrorCode:%{public}d"</span>, <span class="hljs-variable">code</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk createWebMessagePorts end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">postMessage</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 发送消息</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage begin"</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message</span> = <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">createWebMessage</span>();</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setType</span>(<span class="hljs-title class_">message</span>, <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_STRING</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">str</span> = <span class="hljs-string">"send string from native"</span>;</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setData</span>(<span class="hljs-title class_">message</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-title class_">str</span>.<span class="hljs-title class_">c_str</span>(), <span class="hljs-title class_">str</span>.<span class="hljs-title class_">length</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable">ArkWeb_ErrorCode</span> <span class="hljs-variable">code</span> = <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">postMessage</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">message</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage ArkWeb_ErrorCode:%{public}d"</span>, <span class="hljs-variable">code</span>);</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">destroyWebMessage</span>(&amp;<span class="hljs-title class_">message</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage end, web message port size:%{public}d"</span>,</li><li>                <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">// 在线程中发消息</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">webTag</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message</span>) {</li><li>    <span class="hljs-comment">// 发送1000次</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">1000</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"sendMessage in thread %{public}d"</span>, <span class="hljs-variable">i</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> &amp;&amp; <span class="hljs-variable">webTag</span> &amp;&amp; <span class="hljs-variable">message</span>) {</li><li>          <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">postMessage</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTag</span>, <span class="hljs-title class_">message</span>);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">postMessageThread</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 构造消息</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage begin"</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message</span> = <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">createWebMessage</span>();</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setType</span>(<span class="hljs-title class_">message</span>, <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_STRING</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">str</span> = <span class="hljs-string">"thread message"</span>;</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setData</span>(<span class="hljs-title class_">message</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-title class_">str</span>.<span class="hljs-title class_">c_str</span>(), <span class="hljs-title class_">str</span>.<span class="hljs-title class_">length</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">int</span> <span class="hljs-variable">numThreads</span> = <span class="hljs-number">5</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">threads</span>[<span class="hljs-title class_">numThreads</span>];</li><li>
</li><li>    <span class="hljs-comment">// 创建线程</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">numThreads</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-variable">threads</span>[<span class="hljs-variable">i</span>] = <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>(<span class="hljs-title class_">sendMessage</span>, <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">message</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 等待所有线程完成</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">numThreads</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-variable">threads</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">detach</span>();</li><li>    }</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 在线程中注册回调</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">setHandler</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">webTag</span>) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"setMessageEventHandler in thread"</span>);</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">setMessageEventHandler</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTag</span>, <span class="hljs-title class_">WebMessagePortCallback</span>, <span class="hljs-title class_">NULL</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">setMessageEventHandlerThread</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 注册回调</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk SetMessageEventHandler begin"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">thread</span>(<span class="hljs-title class_">setHandler</span>, <span class="hljs-title class_">webTagValue</span>);</li><li>    <span class="hljs-variable">thread</span>.<span class="hljs-title function_">detach</span>();</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">setMessageEventHandler</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">WebMessagePortCallback</span>, <span class="hljs-title class_">NULL</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk SetMessageEventHandler end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">postNoneMessage</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 发送消息</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage begin"</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message</span> = <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">createWebMessage</span>();</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setType</span>(<span class="hljs-title class_">message</span>, <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_NONE</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">str</span> = <span class="hljs-string">"send string from native"</span>;</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setData</span>(<span class="hljs-title class_">message</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-title class_">str</span>.<span class="hljs-title class_">c_str</span>(), <span class="hljs-title class_">str</span>.<span class="hljs-title class_">length</span>() + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">postMessage</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">message</span>);</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">destroyWebMessage</span>(&amp;<span class="hljs-title class_">message</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage end, web message port size:%{public}d"</span>,</li><li>                <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">postBufferMessage</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 发送消息</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage begin"</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">ArkWeb_WebMessagePtr</span> <span class="hljs-variable">message1</span> = <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">createWebMessage</span>();</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setType</span>(<span class="hljs-title class_">message1</span>, <span class="hljs-variable">ArkWeb_WebMessageType</span>::<span class="hljs-title class_">ARKWEB_BUFFER</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">str1</span> = <span class="hljs-string">"send buffer from native"</span>;</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">setData</span>(<span class="hljs-title class_">message1</span>, (<span class="hljs-variable">void</span> *)<span class="hljs-title class_">str1</span>.<span class="hljs-title class_">c_str</span>(), <span class="hljs-title class_">str1</span>.<span class="hljs-title class_">length</span>());</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">postMessage</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">message1</span>);</li><li>    <span class="hljs-variable">webMessage</span>-&gt;<span class="hljs-title class_">destroyWebMessage</span>(&amp;<span class="hljs-title class_">message1</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk postMessage end, web message port size:%{public}d"</span>,</li><li>                <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">setMessageEventHandler</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 注册回调</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk SetMessageEventHandler begin"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">setMessageEventHandler</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">1</span>], <span class="hljs-title class_">webTagValue</span>, <span class="hljs-title class_">WebMessagePortCallback</span>, <span class="hljs-title class_">NULL</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk SetMessageEventHandler end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">closeMessagePort</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 关闭端口，先调用close，再调用destroyWebMessagePorts</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk SetMessageEventHandler begin"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">webMessagePort</span>-&gt;<span class="hljs-title class_">close</span>(<span class="hljs-title class_">g_web_message_port_arr</span>[<span class="hljs-number">0</span>], <span class="hljs-title class_">webTagValue</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk SetMessageEventHandler end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">refresh</span>(<span class="hljs-title class_">webTagValue</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">destroyMessagePort</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 释放内存，先调用close，再调用destroyWebMessagePorts</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk SetMessageEventHandler begin"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">g_web_message_port_arr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"webMessagePort is nullptr"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">destroyWebMessagePorts</span>(&amp;<span class="hljs-title class_">g_web_message_port_arr</span>, <span class="hljs-title class_">web_message_port_size</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk SetMessageEventHandler end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">destroyNullMessagePort</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// 获取第一个参数webTag</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">webTagSize</span>);</li><li>    <span class="hljs-variable">char</span> *<span class="hljs-variable">webTagValue</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">char</span>[<span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">webTagLength</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">webTagValue</span>, <span class="hljs-variable">webTagSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">webTagLength</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk Refresh webTag:%{public}s"</span>, <span class="hljs-variable">webTagValue</span>);</li><li>
</li><li>    <span class="hljs-comment">// 释放内存，先调用close，再调用destroyWebMessagePorts</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>, <span class="hljs-string">"ndk SetMessageEventHandler begin"</span>);</li><li>
</li><li>    <span class="hljs-variable">controller</span>-&gt;<span class="hljs-title class_">destroyWebMessagePorts</span>(&amp;<span class="hljs-title class_">g_web_message_port_arr</span>, <span class="hljs-title class_">web_message_port_size</span>);</li><li>
</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"ArkWeb"</span>,</li><li>                <span class="hljs-string">"ndk SetMessageEventHandler end, web message port size:%{public}d"</span>, <span class="hljs-variable">web_message_port_size</span>);</li><li>    <span class="hljs-variable">delete</span>[] <span class="hljs-variable">webTagValue</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">EXTERN_C_START</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">Init</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_value</span> <span class="hljs-variable">exports</span>) {</li><li>    <span class="hljs-variable">napi_property_descriptor</span> <span class="hljs-variable">desc</span>[] = {</li><li>        {<span class="hljs-string">"nativeWebInit"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">NativeWebInit</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"createWebMessagePorts"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">createWebMessagePorts</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"postMessage"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">postMessage</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"postNoneMessage"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">postNoneMessage</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"postBufferMessage"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">postBufferMessage</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"setMessageEventHandler"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">setMessageEventHandler</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"closeMessagePort"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">closeMessagePort</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"destroyMessagePort"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">destroyMessagePort</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"postMessageThread"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">postMessageThread</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"setMessageEventHandlerThread"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">setMessageEventHandlerThread</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>,</li><li>        <span class="hljs-variable">nullptr</span>},</li><li>        {<span class="hljs-string">"destroyNullMessagePort"</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">destroyNullMessagePort</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">napi_default</span>, <span class="hljs-variable">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-title function_">napi_define_properties</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">exports</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>) / <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">desc</span>[<span class="hljs-number">0</span>]), <span class="hljs-variable">desc</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">exports</span>;</li><li>}</li><li><span class="hljs-variable">EXTERN_C_END</span></li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_module</span> <span class="hljs-variable">demoModule</span> = {</li><li>    .<span class="hljs-variable">nm_version</span> = <span class="hljs-number">1</span>,</li><li>    .<span class="hljs-variable">nm_flags</span> = <span class="hljs-number">0</span>,</li><li>    .<span class="hljs-variable">nm_filename</span> = <span class="hljs-variable">nullptr</span>,</li><li>    .<span class="hljs-variable">nm_register_func</span> = <span class="hljs-variable">Init</span>,</li><li>    .<span class="hljs-variable">nm_modname</span> = <span class="hljs-string">"entry"</span>,</li><li>    .<span class="hljs-variable">nm_priv</span> = ((<span class="hljs-variable">void</span> *)<span class="hljs-number">0</span>),</li><li>    .<span class="hljs-variable">reserved</span> = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-variable">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-title function_">__attribute__</span>((<span class="hljs-variable">constructor</span>)) <span class="hljs-variable">void</span> <span class="hljs-title function_">RegisterEntryModule</span>(<span class="hljs-variable">void</span>) { <span class="hljs-title function_">napi_module_register</span>(&amp;<span class="hljs-title class_">demoModule</span>); }</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>