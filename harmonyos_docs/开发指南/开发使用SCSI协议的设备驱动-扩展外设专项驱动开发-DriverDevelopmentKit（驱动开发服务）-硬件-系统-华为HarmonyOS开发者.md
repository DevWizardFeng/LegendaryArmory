<h1 _ngcontent-ddf-c119="" class="doc-title ng-star-inserted" title="开发使用SCSI协议的设备驱动"> 开发使用SCSI协议的设备驱动 </h1>

<div _ngcontent-ddf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>在企业级存储解决方案和工业应用场景中，对SCSI（Small Computer System Interface，小型计算机系统接口）设备的使用需求广泛存在，例如：磁盘阵列、磁带库以及特定类型的存储服务器等。当操作系统中缺乏针对这些设备的适配驱动时，会导致设备连接后无法被识别或正常使用。SCSI Peripheral DDK（SCSI Peripheral Driver Development Kit）是为开发者提供的专门用于开发SCSI设备驱动程序的套件，支持开发者基于用户态，在应用层进行SCSI设备驱动的开发。</p>     <p>SCSI Peripheral DDK支持SPC（SCSI Primary Commands）、SBC（SCSI Block Commands）和MMC（MultiMedia Commands）三个命令集中的七个常用命令（INQUIRY、READ CAPACITY、TEST UNIT READY、REQUEST SENSE、READ、WRITE和VERIFY），使得开发者可以使用相对熟悉的命令进行设备驱动开发。</p>    </div>    <div class="tiledSection">     <h3 id="基本概念" class="firsth2">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h3>          <p>在进行SCSI Peripheral DDK开发前，开发者应了解以下基本概念：</p>     <ul>      <li>       <p><strong>SCSI</strong></p>       <p>SCSI是一种用于计算机和外围设备如硬盘驱动器、磁带驱动器、光盘驱动器、扫描仪等之间通信的标准化协议集。</p></li>      <li>       <p><strong>AMS</strong></p>       <p>AMS（Ability Manager Service）是用于协调各Ability运行关系，以及对生命周期进行调度的系统服务。</p></li>      <li>       <p><strong>BMS</strong></p>       <p>BMS（Bundle Manager Service）在HarmonyOS上主要负责应用的安装、卸载和数据管理。</p></li>      <li>       <p><strong>DDK</strong></p>       <p>DDK（Driver Development Kit）是HarmonyOS基于扩展外设框架，为开发者提供的驱动应用开发的工具包，可针对SCSI非标外设，开发对应的驱动。</p></li>      <li>       <p><strong>非标外设</strong></p>       <p>非标外设（也称为自定义外设或专有外设）是指不遵循通用标准或专门为特定应用场景定制设计的外围设备。这类设备往往需要专门的软件支持或者特殊的接口来实现与主机系统的通信。</p></li>      <li>       <p><strong>标准外设</strong></p>       <p>标准外设指的是遵循行业广泛接受的标准规范设计的外围设备（USB键盘、鼠标）。此类设备通常具有统一的接口协议、物理尺寸和电气特性，使得其可以在不同的系统之间互换使用。</p></li>      <li>       <p><strong>逻辑块</strong></p>       <p>逻辑块（Logical Block）是一个基本的数据存储单位。它代表设备上的一块固定大小的数据区域，通常用于数据读写操作。逻辑块的大小可以是512字节、1024字节、2048字节等，具体大小取决于设备的配置和文件系统的设计。</p></li>      <li>       <p><strong>CDB</strong></p>       <p>CDB（Command Descriptor Block）即命令描述块，是 SCSI协议中用于发送命令的标准数据结构。CDB是一个固定长度的字节数组，包含了SCSI命令的操作码（Opcode）以及相关的参数，用于告诉设备执行什么操作（如读取、写入、查询等）。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h3>          <p>非标外设应用通过扩展外设管理服务获取SCSI设备的ID，通过RPC将ID和要操作的动作下发给SCSI驱动应用，SCSI驱动应用通过调用SCSI Peripheral DDK接口可获取SCSI设备基本信息，读写数据，DDK接口使用HDI服务将指令下发至内核驱动，内核驱动使用指令与设备通信。</p>     <p><strong>图1</strong> SCSI Peripheral DDK调用原理</p>     <p><span><img originheight="641" originwidth="930" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115051.60365538725613137336234342306257:50001231000000:2800:997ABB73AF01220C7F4D69602AAC97D2CD11C31CA87B64BA9E9ADE6B2C54C234.png" width="920" height="634.1075268817204"></span></p>    </div>    <div class="tiledSection">     <h3 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>SCSI Peripheral DDK开放API支持标准SCSI类外设扩展驱动开发场景。</p></li>      <li>       <p>SCSI Peripheral DDK开放API仅允许在DriverExtensionAbility生命周期内使用。</p></li>      <li>       <p>使用SCSI Peripheral DDK开放API需要在module.json5中声明对应的ACL权限：ohos.permission.ACCESS_DDK_SCSI_PERIPHERAL。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="环境搭建">环境搭建<i class="anchor-icon anchor-icon-link" anchorid="环境搭建" tips="复制节点链接"></i></h2>          <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/environmental-preparation">环境准备</a>完成开发前的准备工作。</p>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Init(void)</td>         <td class="cellrowborder" valign="top" width="50%">初始化SCSI Peripheral DDK。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Release(void)</td>         <td class="cellrowborder" valign="top" width="50%">释放SCSI Peripheral DDK。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Open(uint64_t deviceId, uint8_t interfaceIndex, ScsiPeripheral_Device **dev)</td>         <td class="cellrowborder" valign="top" width="50%">打开deviceId和interfaceIndex指定的SCSI设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Close(ScsiPeripheral_Device **dev)</td>         <td class="cellrowborder" valign="top" width="50%">关闭SCSI设备。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_TestUnitReady(ScsiPeripheral_Device *dev, ScsiPeripheral_TestUnitReadyRequest *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">检查逻辑单元是否已经准备好。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Inquiry(ScsiPeripheral_Device *dev, ScsiPeripheral_InquiryRequest *request, ScsiPeripheral_InquiryInfo *inquiryInfo, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">查询SCSI设备的基本信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_ReadCapacity10(ScsiPeripheral_Device *dev, ScsiPeripheral_ReadCapacityRequest *request, ScsiPeripheral_CapacityInfo *capacityInfo, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">获取SCSI设备的容量信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_RequestSense(ScsiPeripheral_Device *dev, ScsiPeripheral_RequestSenseRequest *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">获取sense data（SCSI设备返回给主机的信息，用于报告设备的状态、错误信息以及诊断信息）。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Read10(ScsiPeripheral_Device *dev, ScsiPeripheral_IORequest *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">从指定逻辑块读取数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Write10(ScsiPeripheral_Device *dev, ScsiPeripheral_IORequest *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">写数据到设备的指定逻辑块。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_Verify10(ScsiPeripheral_Device *dev, ScsiPeripheral_VerifyRequest *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">校验指定逻辑块。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_SendRequestByCdb(ScsiPeripheral_Device *dev, ScsiPeripheral_Request *request, ScsiPeripheral_Response *response)</td>         <td class="cellrowborder" valign="top" width="50%">以CDB方式发送SCSI命令。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_CreateDeviceMemMap(ScsiPeripheral_Device *dev, size_t size, ScsiPeripheral_DeviceMemMap **devMmap)</td>         <td class="cellrowborder" valign="top" width="50%">创建缓冲区。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_DestroyDeviceMemMap(ScsiPeripheral_DeviceMemMap *devMmap)</td>         <td class="cellrowborder" valign="top" width="50%">销毁缓冲区。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_ScsiPeripheral_ParseBasicSenseInfo(uint8_t *senseData, uint8_t senseDataLen, ScsiPeripheral_BasicSenseInfo *senseInfo)</td>         <td class="cellrowborder" valign="top" width="50%">解析基本的sense data，包括Information、Command specific information、Sense key specific字段。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-scsiperipheralddk" target="_blank">SCSI Peripheral DDK</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>以下步骤描述了如何使用SCSI Peripheral DDK开发非标SCSI外设的驱动：</p>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libscsi.z.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi_peripheral/scsi_peripheral_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi_peripheral/scsi_peripheral_types.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p>初始化DDK。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Init</strong> 初始化SCSI Peripheral DDK。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化SCSI Peripheral DDK</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_ScsiPeripheral_Init</span>();</li></ol></pre></div></div></li>      <li>       <p>打开设备。</p>       <p>初始化SCSI Peripheral DDK后，使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Open</strong> 打开SCSI设备。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint64_t</span> deviceId = <span class="hljs-number">0x100000003</span>;</li><li><span class="hljs-type">uint8_t</span> interfaceIndex = <span class="hljs-number">0</span>;</li><li>ScsiPeripheral_Device *dev = <span class="hljs-literal">NULL</span>;</li><li><span class="hljs-comment">// 打开deviceId和interfaceIndex指定的SCSI设备</span></li><li>ret = <span class="hljs-built_in">OH_ScsiPeripheral_Open</span>(deviceId, interfaceIndex, &amp;dev);</li></ol></pre></div></div></li>      <li>       <p>创建缓冲区（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_CreateDeviceMemMap</strong> 创建内存缓冲区devMmap。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> DEVICE_MEM_MAP_SIZE = <span class="hljs-number">1024</span>;</li><li>ScsiPeripheral_DeviceMemMap *g_scsiDeviceMemMap = <span class="hljs-literal">nullptr</span>;</li><li>ret = <span class="hljs-built_in">OH_ScsiPeripheral_CreateDeviceMemMap</span>(dev, DEVICE_MEM_MAP_SIZE, &amp;g_scsiDeviceMemMap);</li></ol></pre></div></div></li>      <li>       <p>检查逻辑单元是否已经准备好（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_TestUnitReady</strong> 检查逻辑单元是否已经准备好。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_TestUnitReadyRequest</span> <span class="hljs-variable">testUnitReadyRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>testUnitReadyRequest.timeout = <span class="hljs-number">5000</span>;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">testUnitReadyResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_TestUnitReady(dev, &amp;testUnitReadyRequest, &amp;testUnitReadyResponse);</li></ol></pre></div></div></li>      <li>       <p>查询SCSI设备的基本信息（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Inquiry</strong> 获取SCSI设备的基本信息。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_InquiryRequest</span> <span class="hljs-variable">inquiryRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>inquiryRequest.allocationLength = <span class="hljs-number">512</span>;</li><li>inquiryRequest.timeout = <span class="hljs-number">5000</span>;</li><li><span class="hljs-type">ScsiPeripheral_InquiryInfo</span> <span class="hljs-variable">inquiryInfo</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>inquiryInfo.data = g_scsiDeviceMemMap;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">inquiryResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_Inquiry(dev, &amp;inquiryRequest, &amp;inquiryInfo, &amp;inquiryResponse);</li></ol></pre></div></div></li>      <li>       <p>获取SCSI设备的容量信息（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_ReadCapacity10</strong> 获取SCSI设备容量信息。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_ReadCapacityRequest</span> <span class="hljs-variable">readCapacityRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>readCapacityRequest.lbAddress = <span class="hljs-number">0</span>;</li><li>readCapacityRequest.control = <span class="hljs-number">0</span>;</li><li>readCapacityRequest.byte8 = <span class="hljs-number">0</span>;</li><li>readCapacityRequest.timeout = <span class="hljs-number">5000</span>;</li><li><span class="hljs-type">ScsiPeripheral_CapacityInfo</span> <span class="hljs-variable">capacityInfo</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">readCapacityResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_ReadCapacity10(dev, &amp;readCapacityRequest, &amp;capacityInfo, &amp;readCapacityResponse);</li></ol></pre></div></div></li>      <li>       <p>获取sense data（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_RequestSense</strong> 获取sense data。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_RequestSenseRequest</span> <span class="hljs-variable">senseRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>senseRequest.allocationLength = SCSIPERIPHERAL_MAX_SENSE_DATA_LEN + <span class="hljs-number">1</span>;</li><li>senseRequest.control = <span class="hljs-number">0</span>;</li><li>senseRequest.byte1 = <span class="hljs-number">0</span>;</li><li>senseRequest.timeout = <span class="hljs-number">5000</span>;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">senseResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li><span class="hljs-comment">// SCSI设备返回给主机的信息，用于报告设备的状态、错误信息以及诊断信息</span></li><li>ret = OH_ScsiPeripheral_RequestSense(dev, &amp;senseRequest, &amp;senseResponse);</li></ol></pre></div></div></li>      <li>       <p>解析sense data（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_ParseBasicSenseInfo</strong> 解析基本的sense data，包括Information、Command specific information、Sense key specific字段。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_BasicSenseInfo</span> <span class="hljs-variable">senseInfo</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_ParseBasicSenseInfo(senseResponse.senseData, SCSIPERIPHERAL_MAX_SENSE_DATA_LEN, &amp;senseInfo);</li></ol></pre></div></div></li>      <li>       <p>读取数据（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Read10</strong> 读取指定逻辑块的数据。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_IORequest</span> <span class="hljs-variable">readRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>readRequest.lbAddress = <span class="hljs-number">1</span>;</li><li>readRequest.transferLength = <span class="hljs-number">1</span>;</li><li>readRequest.control = <span class="hljs-number">0</span>;</li><li>readRequest.byte1 = <span class="hljs-number">0</span>;</li><li>readRequest.byte6 = <span class="hljs-number">0</span>;</li><li>readRequest.timeout = <span class="hljs-number">20000</span>;</li><li>readRequest.data = g_scsiDeviceMemMap;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">readResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_Read10(dev, &amp;readRequest, &amp;readResponse);</li></ol></pre></div></div></li>      <li>       <p>写入数据（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Write10</strong> 写数据到设备指定逻辑块。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_IORequest</span> <span class="hljs-variable">writeRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>writeRequest.lbAddress = <span class="hljs-number">1</span>;</li><li>writeRequest.transferLength = <span class="hljs-number">1</span>;</li><li>writeRequest.control = <span class="hljs-number">0</span>;</li><li>writeRequest.byte1 = <span class="hljs-number">0</span>;</li><li>writeRequest.byte6 = <span class="hljs-number">0</span>;</li><li>writeRequest.timeout = <span class="hljs-number">5000</span>;</li><li>writeRequest.data = g_scsiDeviceMemMap;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">writeResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_Write10(dev, &amp;writeRequest, &amp;writeResponse);</li></ol></pre></div></div></li>      <li>       <p>校验指定逻辑块（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Verify10</strong> 校验指定逻辑块。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">ScsiPeripheral_VerifyRequest</span> <span class="hljs-variable">verifyRequest</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>verifyRequest.lbAddress = <span class="hljs-number">1</span>;</li><li>verifyRequest.verificationLength = <span class="hljs-number">1</span>;</li><li>verifyRequest.timeout = <span class="hljs-number">5000</span>;</li><li><span class="hljs-type">ScsiPeripheral_Response</span> <span class="hljs-variable">verifyResponse</span> <span class="hljs-operator">=</span> {<span class="hljs-number">0</span>};</li><li>ret = OH_ScsiPeripheral_Verify10(dev, &amp;verifyRequest, &amp;verifyResponse);</li></ol></pre></div></div></li>      <li>       <p>以CDB方式发送SCSI命令（可选）。</p>       <p>使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_SCSIPeripheral_SendRequestByCdb</strong> 发送SCSI命令。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>ScsiPeripheral_Request sendRequest = {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">uint8_t</span> cdbData[SCSIPERIPHERAL_MAX_CMD_DESC_BLOCK_LEN] = {<span class="hljs-number">0x28</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>};</li><li><span class="hljs-built_in">memcpy</span>(sendRequest.commandDescriptorBlock, cdbData, SCSIPERIPHERAL_MAX_CMD_DESC_BLOCK_LEN); <span class="hljs-comment">// 需引入头文件 #include &lt;cstring&gt;</span></li><li>sendRequest.cdbLength = <span class="hljs-number">10</span>;</li><li>sendRequest.dataTransferDirection = <span class="hljs-number">-3</span>;</li><li>sendRequest.timeout = <span class="hljs-number">5000</span>;</li><li>sendRequest.data = g_scsiDeviceMemMap;</li><li>ScsiPeripheral_Response sendResponse = {<span class="hljs-number">0</span>};</li><li>ret = <span class="hljs-built_in">OH_ScsiPeripheral_SendRequestByCdb</span>(dev, &amp;sendRequest, &amp;sendResponse);</li></ol></pre></div></div></li>      <li>       <p>销毁缓冲区（可选）。</p>       <p>在所有请求处理完毕，程序退出前，使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_DestroyDeviceMemMap</strong> 销毁缓冲区。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-ini" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">ret</span> = OH_ScsiPeripheral_DestroyDeviceMemMap(g_scsiDeviceMemMap)<span class="hljs-comment">;</span></li></ol></pre></div></div></li>      <li>       <p>关闭设备。</p>       <p>在销毁缓冲区后，使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Close</strong> 关闭设备。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 关闭SCSI设备</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_ScsiPeripheral_Close</span>(&amp;<span class="hljs-title class_">dev</span>);</li></ol></pre></div></div></li>      <li>       <p>释放DDK。</p>       <p>在关闭SCSI设备后，使用 <strong>scsi_peripheral_api.h</strong> 的 <strong>OH_ScsiPeripheral_Release</strong> 释放SCSI Peripheral DDK。</p>       <div _ngcontent-ddf-c106="" class="highlight-div"><div _ngcontent-ddf-c106="" class="highlight-div-header"><div _ngcontent-ddf-c106="" class="highlight-div-header-left"><div _ngcontent-ddf-c106="" class="handle-button expand-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ddf-c106="" class="highlight-div-header-right"><div _ngcontent-ddf-c106="" class="handle-button ai-button"></div><div _ngcontent-ddf-c106="" class="handle-button line-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ddf-c106="" class="handle-button theme-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ddf-c106="" class="handle-button copy-button"><div _ngcontent-ddf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ddf-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放SCSI Peripheral DDK</span></li><li>ret = <span class="hljs-built_in">OH_ScsiPeripheral_Release</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="调测验证">调测验证<i class="anchor-icon anchor-icon-link" anchorid="调测验证" tips="复制节点链接"></i></h3>          <p>驱动应用侧开发完成后，可在HarmonyOS设备上安装应用，测试步骤如下：</p>     <ol>      <li>在设备上点击驱动应用，应用在设备上被拉起。</li>      <li>应用可以读取到SCSI设备的基础信息。</li>      <li>选择对应的SCSI命令，输入参数，点击发送按钮，可以执行对应的SCSI命令。</li>      <li>也可以通过输入方向、CDB数据及CDB长度，点击发送按钮，执行对应的SCSI命令。</li>     </ol>    </div>   </div>   <div></div></div>