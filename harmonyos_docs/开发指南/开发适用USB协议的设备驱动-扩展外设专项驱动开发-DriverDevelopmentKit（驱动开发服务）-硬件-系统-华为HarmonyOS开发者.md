<h1 _ngcontent-loa-c119="" class="doc-title ng-star-inserted" title="开发适用USB协议的设备驱动"> 开发适用USB协议的设备驱动 </h1>

<div _ngcontent-loa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>USB DDK（USB Driver Development Kit）是为开发者提供的USB驱动程序开发套件，支持开发者基于用户态，在应用层开发USB设备驱动。提供了一系列主机侧访问设备的接口，包括主机侧打开和关闭接口、管道同步异步读写通信、控制传输、中断传输等。</p>     <p>凡是采用USB总线，通过USB协议传输数据的设备都可以使用USB DDK开发设备驱动。特别是内核标准驱动不支持的扩展外设，可以通过USB DDK开发的扩展外设驱动应用实现其独特的设备能力。</p>    </div>    <div class="tiledSection">     <h3 id="基本概念" class="firsth2">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h3>          <p>在进行USB DDK开发前，开发者应了解以下基本概念：</p>     <ul>      <li>       <p><strong>USB</strong></p>       <p>USB（Universal Serial Bus，通用串行总线）是一种广泛使用的接口技术，用于连接计算机与各种外部设备，如键盘、鼠标、打印机、存储设备、智能手机等。USB 的设计目标是提供一种标准化、高效且易于使用的连接方式，以替代传统的串行和并行接口。</p></li>      <li>       <p><strong>DDK</strong></p>       <p>DDK（Driver Development Kit）是HarmonyOS基于扩展外设框架，为开发者提供的驱动应用开发的工具包，可针对非标USB串口设备，开发对应的驱动。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h3>          <p>非标外设应用通过扩展外设管理服务获取USB设备的ID，通过RPC将ID和要操作的动作下发给USB驱动应用，USB驱动应用通过调用USB DDK接口可获取设备描述符，配置描述符，以及发送控制传输，中断传输等请求，DDK接口使用HDI服务将指令下发至内核驱动，内核驱动使用指令与设备通信。</p>     <p><strong>图1</strong> USB DDK调用原理</p>     <p><span><img originheight="641" originwidth="930" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115034.13656554502376996964970547824434:50001231000000:2800:42A482C4AEB23EB1984F3AF1D60468B3EAF2EA8DA945039148011E09D13AAEFE.png" width="920" height="634.1075268817204"></span></p>    </div>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>USB DDK开放API支持USB接口非标外设扩展驱动开发场景。</p></li>      <li>       <p>USB DDK开放API仅允许DriverExtensionAbility生命周期内使用。</p></li>      <li>       <p>使用USB DDK开放API需要在module.json5中声明匹配的ACL权限，例如ohos.permission.ACCESS_DDK_USB。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="环境搭建">环境搭建<i class="anchor-icon anchor-icon-link" anchorid="环境搭建" tips="复制节点链接"></i></h2>          <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/environmental-preparation">环境准备</a>完成开发前的准备工作。</p>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_Init(void)</td>         <td class="cellrowborder" valign="top" width="50%">初始化DDK。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_Release(void)</td>         <td class="cellrowborder" valign="top" width="50%">释放DDK。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_GetDeviceDescriptor(uint64_t deviceId, struct UsbDeviceDescriptor *desc)</td>         <td class="cellrowborder" valign="top" width="50%">获取设备描述符。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_GetConfigDescriptor(uint64_t deviceId, uint8_t configIndex, struct UsbDdkConfigDescriptor **const config)</td>         <td class="cellrowborder" valign="top" width="50%">获取配置描述符。请在描述符使用完后使用OH_Usb_FreeConfigDescriptor()释放描述符，否则会造成内存泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_FreeConfigDescriptor(const struct UsbDdkConfigDescriptor *const config)</td>         <td class="cellrowborder" valign="top" width="50%">释放配置描述符，请在描述符使用完后释放描述符，否则会造成内存泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_ClaimInterface(uint64_t deviceId, uint8_t interfaceIndex, uint64_t *interfaceHandle)</td>         <td class="cellrowborder" valign="top" width="50%">声明接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_SelectInterfaceSetting(uint64_t interfaceHandle, uint8_t settingIndex)</td>         <td class="cellrowborder" valign="top" width="50%">激活接口的备用设置。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_GetCurrentInterfaceSetting(uint64_t interfaceHandle, uint8_t *settingIndex)</td>         <td class="cellrowborder" valign="top" width="50%">获取接口当前激活的备用设置。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_SendControlReadRequest(uint64_t interfaceHandle, const struct UsbControlRequestSetup *setup, uint32_t timeout, uint8_t *data, uint32_t *dataLen)</td>         <td class="cellrowborder" valign="top" width="50%">发送控制读请求，该接口为同步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_SendControlWriteRequest(uint64_t interfaceHandle, const struct UsbControlRequestSetup *setup, uint32_t timeout, const uint8_t *data, uint32_t dataLen)</td>         <td class="cellrowborder" valign="top" width="50%">发送控制写请求，该接口为同步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_ReleaseInterface(uint64_t interfaceHandle)</td>         <td class="cellrowborder" valign="top" width="50%">释放接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_SendPipeRequest(const struct UsbRequestPipe *pipe, UsbDeviceMemMap *devMmap)</td>         <td class="cellrowborder" valign="top" width="50%">发送管道请求，该接口为同步接口。中断传输和批量传输都使用该接口发送请求。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_CreateDeviceMemMap(uint64_t deviceId, size_t size, UsbDeviceMemMap **devMmap)</td>         <td class="cellrowborder" valign="top" width="50%">创建缓冲区。请在缓冲区使用完后，调用OH_Usb_DestroyDeviceMemMap()销毁缓冲区，否则会造成资源泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_DestroyDeviceMemMap(UsbDeviceMemMap *devMmap)</td>         <td class="cellrowborder" valign="top" width="50%">销毁缓冲区。请在缓冲区使用完后及时销毁缓冲区，否则会造成资源泄露。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_Usb_GetDevices(struct Usb_DeviceArray *devices)</td>         <td class="cellrowborder" valign="top" width="50%">获取USB设备ID列表。请保证传入的指针参数是有效的，申请设备的数量不要超过128个，在使用完结构之后，释放成员内存，否则造成资源泄露。获取到的USB设备ID，已通过驱动配置信息中的vid进行筛选过滤。</td>        </tr>             </tbody></table></div>     </div>     <p>详细的接口说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-usbddk" target="_blank">USB DDK</a>。</p>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <p>以下步骤描述了如何使用 <strong>USB DDK</strong>开发USB驱动：</p>     <p><strong>添加动态链接库</strong></p>     <p>CMakeLists.txt中添加以下lib。</p>     <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libusb_ndk.z.so</li></ol></pre></div></div>     <p><strong>头文件</strong></p>     <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;usb/usb_ddk_api.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;usb/usb_ddk_types.h&gt;</span></span></li></ol></pre></div></div>     <ol>      <li>       <p>获取设备描述符。</p>       <p>使用 <strong>usb_ddk_api.h</strong> 的 <strong>OH_Usb_Init</strong> 接口初始化DDK，并使用 <strong>OH_Usb_GetDeviceDescriptor</strong>获取到设备描述符。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化USB DDK</span></li><li><span class="hljs-built_in">OH_Usb_Init</span>();</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbDeviceDescriptor</span> devDesc;</li><li><span class="hljs-type">uint64_t</span> deviceId = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 获取设备描述符</span></li><li><span class="hljs-built_in">OH_Usb_GetDeviceDescriptor</span>(deviceId, &amp;devDesc);</li></ol></pre></div></div></li>      <li>       <p>获取配置描述符及声明接口。</p>       <p>使用 <strong>usb_ddk_api.h</strong> 的 <strong>OH_Usb_GetConfigDescriptor</strong> 接口获取配置描述符 <strong>config</strong>，并使用 OH_Usb_ClaimInterface 声明"认领"接口。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbDdkConfigDescriptor</span> *config = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 获取配置描述符</span></li><li><span class="hljs-built_in">OH_Usb_GetConfigDescriptor</span>(deviceId, <span class="hljs-number">1</span>, &amp;config);</li><li><span class="hljs-comment">// 根据配置描述符,找到所需要通信的interfaceIndex</span></li><li><span class="hljs-type">uint8_t</span> interfaceIndex = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 声明接口</span></li><li><span class="hljs-type">uint64_t</span> interfaceHandle = <span class="hljs-number">0</span>;</li><li><span class="hljs-built_in">OH_Usb_ClaimInterface</span>(deviceId, interfaceIndex, &amp;interfaceHandle);</li><li><span class="hljs-comment">// 释放配置描述符</span></li><li><span class="hljs-built_in">OH_Usb_FreeConfigDescriptor</span>(config);</li></ol></pre></div></div></li>      <li>       <p>获取当前激活接口的备用设置及激活备用设置（可选）。</p>       <p>使用 <strong>usb_ddk_api.h</strong> 的 <strong>OH_Usb_GetCurrentInterfaceSetting</strong> 获取备用设置，并使用 <strong>OH_Usb_SelectInterfaceSetting</strong> 激活备用设置。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint8_t</span> settingIndex = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 接口获取备用设置</span></li><li><span class="hljs-built_in">OH_Usb_GetCurrentInterfaceSetting</span>(interfaceHandle, &amp;settingIndex);</li><li>
</li><li><span class="hljs-comment">// 激活备用设置</span></li><li><span class="hljs-built_in">OH_Usb_SelectInterfaceSetting</span>(interfaceHandle, settingIndex);</li></ol></pre></div></div></li>      <li>       <p>发送控制读请求、发送控制写请求（可选）。</p>       <p>使用 <strong>usb_ddk_api.h</strong> 的<strong>OH_Usb_SendControlReadRequest</strong>发送控制读请求，或者使用<strong>OH_Usb_SendControlWriteRequest</strong>发送控制写请求。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-comment">// 超时时间，设置为1s;</span></li><li><span class="hljs-type">uint32_t</span> timeout = <span class="hljs-number">1000</span>;</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbControlRequestSetup</span> setupRead;</li><li>setupRead.bmRequestType    = <span class="hljs-number">0x80</span>;</li><li>setupRead.bRequest = <span class="hljs-number">0x08</span>;</li><li>setupRead.wValue = <span class="hljs-number">0</span>;</li><li>setupRead.wIndex = <span class="hljs-number">0</span>;</li><li>setupRead.wLength = <span class="hljs-number">0x01</span>;</li><li><span class="hljs-type">uint8_t</span> dataRead[<span class="hljs-number">256</span>] = {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">uint32_t</span> dataReadLen = <span class="hljs-number">256</span>;</li><li><span class="hljs-comment">// 发送控制读请求</span></li><li><span class="hljs-built_in">OH_Usb_SendControlReadRequest</span>(interfaceHandle, &amp;setupRead, timeout, dataRead, &amp;dataReadLen);</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbControlRequestSetup</span> setupWrite;</li><li>setupWrite.bmRequestType = <span class="hljs-number">0</span>;</li><li>setupWrite.bRequest = <span class="hljs-number">0x09</span>;</li><li>setupWrite.wValue = <span class="hljs-number">1</span>;</li><li>setupWrite.wIndex = <span class="hljs-number">0</span>;</li><li>setupWrite.wLength = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint8_t</span> dataWrite[<span class="hljs-number">256</span>] = {<span class="hljs-number">0</span>};</li><li><span class="hljs-type">uint32_t</span> dataWriteLen = <span class="hljs-number">256</span>;</li><li><span class="hljs-comment">// 发送控制写请求</span></li><li><span class="hljs-built_in">OH_Usb_SendControlWriteRequest</span>(interfaceHandle, &amp;setupWrite, timeout, dataWrite, dataWriteLen);</li></ol></pre></div></div></li>      <li>       <p>创建内存映射缓冲区及发送请求（可选）。</p>       <p>使用 <strong>usb_ddk_api.h</strong> 的<strong>OH_Usb_CreateDeviceMemMap</strong>接口创建内存映射缓冲区<strong>devMmap</strong>，并使用<strong>OH_Usb_SendPipeRequest</strong>发送请求。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbDeviceMemMap</span> *devMmap = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 创建用于存放数据的缓冲区</span></li><li><span class="hljs-type">size_t</span> bufferLen = <span class="hljs-number">10</span>;</li><li><span class="hljs-built_in">OH_Usb_CreateDeviceMemMap</span>(deviceId, bufferLen, &amp;devMmap);</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UsbRequestPipe</span> pipe;</li><li>pipe.interfaceHandle = interfaceHandle;</li><li><span class="hljs-comment">// 根据配置描述符找到所要通信的端点</span></li><li>pipe.endpoint = <span class="hljs-number">128</span>;</li><li>pipe.timeout = UINT32_MAX;</li><li><span class="hljs-comment">// 发送请求</span></li><li><span class="hljs-built_in">OH_Usb_SendPipeRequest</span>(&amp;pipe, devMmap);</li></ol></pre></div></div></li>      <li>       <p>释放资源。</p>       <p>在所有请求处理完毕，程序退出前，使用 <strong>usb_ddk_api.h</strong> 的 <strong>OH_Usb_DestroyDeviceMemMap</strong> 接口销毁缓冲区。使用<strong>OH_Usb_ReleaseInterface</strong>释放接口。使用<strong>OH_Usb_Release</strong>释放USB DDK。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 销毁缓冲区</span></li><li><span class="hljs-built_in">OH_Usb_DestroyDeviceMemMap</span>(devMmap);</li><li><span class="hljs-comment">// 释放接口</span></li><li><span class="hljs-built_in">OH_Usb_ReleaseInterface</span>(interfaceHandle);</li><li><span class="hljs-comment">// 释放USB DDK</span></li><li><span class="hljs-built_in">OH_Usb_Release</span>();</li></ol></pre></div></div></li>      <li>       <p>获取可识别的USB设备列表（独立步骤，可选）。</p>       <p>驱动拉起后调用<strong>OH_Usb_GetDevices</strong>接口获取驱动配置信息中匹配vid（vid是设备厂商的vendor id，在驱动应用里面配置，表示驱动适配哪些设备，查询到的设备ID都需要通过vid进行过滤）的设备ID，以供后续应用开发使用。</p>       <div _ngcontent-loa-c106="" class="highlight-div"><div _ngcontent-loa-c106="" class="highlight-div-header"><div _ngcontent-loa-c106="" class="highlight-div-header-left"><div _ngcontent-loa-c106="" class="handle-button expand-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-loa-c106="" class="highlight-div-header-right"><div _ngcontent-loa-c106="" class="handle-button ai-button"></div><div _ngcontent-loa-c106="" class="handle-button line-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-loa-c106="" class="handle-button theme-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-loa-c106="" class="handle-button copy-button"><div _ngcontent-loa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-loa-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">OH_Usb_Init</span>();</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> MAX_USB_DEVICE_NUM = <span class="hljs-number">128</span>;</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Usb_DeviceArray</span> deviceArray;</li><li>deviceArray.deviceIds = <span class="hljs-keyword">new</span> <span class="hljs-type">uint64_t</span>[MAX_USB_DEVICE_NUM];</li><li><span class="hljs-comment">// 获取设备列表</span></li><li><span class="hljs-built_in">OH_Usb_GetDevices</span>(&amp;deviceArray);</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>