<h1 _ngcontent-hhy-c119="" class="doc-title ng-star-inserted" title="异构"> 异构 </h1>

<div _ngcontent-hhy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section850781511574">概述<i class="anchor-icon anchor-icon-link" anchorid="section850781511574" tips="复制节点链接"></i></h2><p>异构是CANN Kit提供的异构计算能力，能够使开发者App在华为平台上充分享受到硬件平台的计算加速性能，同时提供非华为硬件平台的模型计算兼容性和计算加速，使开发者App开发过程归一化，不再需要为不同硬件平台适配不同模型或者计算框架，减少App开发及维护的难度。</p> <p>异构的原理如下图所示，指定OP1、OP2、OP5~OPn在CPU上进行推理，OP3、OP4在NPU上进行推理。</p> <p><span><img originheight="203" originwidth="1035" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114241.57909122323480478724876972125361:50001231000000:2800:249E1E478CE32933E8CC32E0F8A27491FCF6A4A74AE8FF7DDEDD75A33910A257.png" width="920" height="180.44444444444443"></span></p> </div> <p>实现异构可以通过在线调优方式，以下为在线调优参数设置接口，接口使用见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-optimization#section79081331124811">在线调优开发步骤</a>。如要使用更丰富的设置和查询接口，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/cannkit" target="_blank">API参考</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>在线调优接口及功能介绍</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>OH_NN_ReturnCode HMS_HiAIOptions_SetTuningMode(OH_NNCompilation* compilation, HiAI_TuningMode tuningMode);</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>芯片调优模式配置。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_NN_ReturnCode HMS_HiAIOptions_SetTuningCacheDir(OH_NNCompilation* compilation, const char* cacheDir);</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>芯片调优缓存目录配置。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section79081331124811">在线调优开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section79081331124811" tips="复制节点链接"></i></h2><ol><li><span>设置芯片调优模式。</span><p></p><ul><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-neural-network-core-h#oh_nncompilation_constructwithofflinemodelfile" target="_blank">OH_NNCompilation_ConstructWithOfflineModelFile</a>，读取模型buffer，创建模型编译实例。</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/cannkit#hms_hiaioptions_settuningmode" target="_blank">HMS_HiAIOptions_SetTuningMode</a>向模型编译实例中设置芯片调优模式调优选项。</li></ul> <p></p></li></ol><ol start="2"><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/cannkit#hms_hiaioptions_settuningcachedir" target="_blank">HMS_HiAIOptions_SetTuningCacheDir</a>向模型编译实例中设置芯片调优缓存目录调优选项。</span></li><li><span>执行模型编译。</span><p></p><p>设置好所需调优选项参数后，通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-neural-network-core-h#oh_nncompilation_build" target="_blank">OH_NNCompilation_Build</a>，传入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-model-inference#li810206624">创建模型编译实例</a>，即可执行模型编译，编译成功则返回编译后的模型指针。后续流程同<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-model-inference">模型推理</a>。</p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section1986510369322">在线调优示例说明<i class="anchor-icon anchor-icon-link" anchorid="section1986510369322" tips="复制节点链接"></i></h2><p>以下示例代码设置调优参数SetTuningMode及SetTuningCacheDir，实现在线调优。</p> <div _ngcontent-hhy-c106="" class="highlight-div"><div _ngcontent-hhy-c106="" class="highlight-div-header"><div _ngcontent-hhy-c106="" class="highlight-div-header-left"><div _ngcontent-hhy-c106="" class="handle-button expand-button"><div _ngcontent-hhy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhy-c106="" class="highlight-div-header-right"><div _ngcontent-hhy-c106="" class="handle-button ai-button"></div><div _ngcontent-hhy-c106="" class="handle-button line-button"><div _ngcontent-hhy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhy-c106="" class="handle-button theme-button"><div _ngcontent-hhy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhy-c106="" class="handle-button copy-button"><div _ngcontent-hhy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhy-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"neural_network_runtime/neural_network_core.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CANNKit/hiai_options.h"</span></span></li><li><span class="hljs-comment">// 基于离线模型文件创建编译实例</span></li><li>OH_NNCompilation* compilation = <span class="hljs-built_in">OH_NNCompilation_ConstructWithOfflineModelFile</span>(<span class="hljs-string">"test.om"</span>);</li><li><span class="hljs-keyword">if</span> (compilation == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">return</span>; </li><li>}</li><li><span class="hljs-comment">// 选择辅助调优模式</span></li><li>OH_NN_ReturnCode ret = <span class="hljs-built_in">HMS_HiAIOptions_SetTuningMode</span>(compilation, HIAI_TUNING_MODE_HETER);</li><li><span class="hljs-keyword">if</span> (ret != OH_NN_SUCCESS ) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 设置辅助调优的缓存目录</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* cacheDir = <span class="hljs-string">"/data/local/tmp"</span>;</li><li>ret = <span class="hljs-built_in">HMS_HiAIOptions_SetTuningCacheDir</span>(compilation, cacheDir);</li><li><span class="hljs-keyword">if</span> (ret != OH_NN_SUCCESS ) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 编译模型</span></li><li>ret = <span class="hljs-built_in">OH_NNCompilation_Build</span>(compilation);</li><li><span class="hljs-keyword">if</span> (ret != OH_NN_SUCCESS ) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>