<h1 _ngcontent-dut-c119="" class="doc-title ng-star-inserted" title="异步并发 (Promise和async/await)"> 异步并发 (Promise和async/await) </h1>

<div _ngcontent-dut-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Promise和async/await是标准的JS异步语法，提供异步并发能力。异步代码执行时会被挂起，稍后继续执行，确保同一时间只有一段代码在运行。以下是典型的异步并发使用场景：</p>    <ul>     <li>      <p>I/O 非阻塞操作：网络请求、文件读写、定时器等。</p></li>     <li>      <p>任务轻量且无 CPU 阻塞：单次任务执行时间短。</p></li>     <li>      <p>逻辑依赖清晰：任务有明确的顺序或并行关系。</p></li>    </ul>    <p>异步并发是一种编程语言的特性，允许程序在执行某些操作时不必等待其完成，可以继续执行其他异步代码。</p>    <div class="tiledSection">     <h2 id="promise">Promise<i class="anchor-icon anchor-icon-link" anchorid="promise" tips="复制节点链接"></i></h2>          <p>Promise是一种用于处理异步操作的对象，可将异步操作转换为类似同步操作的风格，便于代码编写和维护。Promise通过状态机制管理异步操作的不同阶段，有三种状态：pending（进行中）、fulfilled（已完成，也叫resolved）和rejected（已拒绝）。创建后处于pending状态，异步操作完成后转换为fulfilled或rejected状态。</p>     <p>Promise提供了then、catch、finally方法来注册回调函数，以处理异步操作的成功或失败结果。当Promise状态改变时，回调函数会被加入微任务队列等待执行，依赖事件循环机制在宏任务执行完成后优先执行微任务，从而保证回调函数的异步调度。</p>     <p>最基本的用法是通过构造函数实例化一个Promise对象，传入一个带有两个参数的函数，称为executor函数。executor函数接收两个参数：resolve和reject，分别表示异步操作成功和失败时的回调函数。</p>     <p>例如，以下代码创建了一个Promise对象并模拟了一个异步操作：</p>     <div _ngcontent-dut-c106="" class="highlight-div"><div _ngcontent-dut-c106="" class="highlight-div-header"><div _ngcontent-dut-c106="" class="highlight-div-header-left"><div _ngcontent-dut-c106="" class="handle-button expand-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dut-c106="" class="highlight-div-header-right"><div _ngcontent-dut-c106="" class="handle-button ai-button"></div><div _ngcontent-dut-c106="" class="handle-button line-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dut-c106="" class="handle-button theme-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dut-c106="" class="handle-button copy-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dut-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span>, reject: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">randomNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</li><li>    <span class="hljs-keyword">if</span> (randomNumber &gt; <span class="hljs-number">0.5</span>) {</li><li>      <span class="hljs-title function_">resolve</span>(randomNumber);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Random number is too small'</span>));</li><li>    }</li><li>  }, <span class="hljs-number">1000</span>);</li><li>})</li></ol></pre></div></div>     <p>在上述代码中，setTimeout函数模拟了一个异步操作，1秒后生成一个随机数。如果随机数大于0.5，调用resolve回调函数并传递该随机数；否则调用reject回调函数并传递一个错误对象。</p>     <p>Promise对象创建后，可以使用then方法和catch方法指定fulfilled状态和rejected状态的回调函数。then方法可接受两个参数，一个处理fulfilled状态的函数，另一个处理rejected状态的函数。只传一个参数则表示当Promise对象状态变为fulfilled时，then方法会自动调用这个回调函数，并将Promise对象的结果作为参数传递给它。使用catch方法注册一个回调函数，用于处理“失败”的结果，即捕获Promise的状态改变为rejected状态或操作失败抛出的异常。Promise还可以使用finally注册回调函数，无论Promise最终状态如何（fulfilled或rejected），都会执行该回调函数。例如：</p>     <div _ngcontent-dut-c106="" class="highlight-div"><div _ngcontent-dut-c106="" class="highlight-div-header"><div _ngcontent-dut-c106="" class="highlight-div-header-left"><div _ngcontent-dut-c106="" class="handle-button expand-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dut-c106="" class="highlight-div-header-right"><div _ngcontent-dut-c106="" class="handle-button ai-button"></div><div _ngcontent-dut-c106="" class="handle-button line-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dut-c106="" class="handle-button theme-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dut-c106="" class="handle-button copy-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dut-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span>, reject: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">randomNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</li><li>    <span class="hljs-keyword">if</span> (randomNumber &gt; <span class="hljs-number">0.5</span>) {</li><li>      <span class="hljs-title function_">resolve</span>(randomNumber);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Random number is too small'</span>));</li><li>    }</li><li>  }, <span class="hljs-number">1000</span>);</li><li>})</li><li>
</li><li><span class="hljs-comment">// 使用 then 方法定义成功和失败的回调</span></li><li>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The number for success is <span class="hljs-subst">${result}</span>`</span>); <span class="hljs-comment">// 成功时执行</span></li><li>}, <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败时执行</span></li><li>}</li><li>);</li><li>
</li><li><span class="hljs-comment">// 使用 then 方法定义成功的回调，catch 方法定义失败的回调</span></li><li>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Random number is <span class="hljs-subst">${result}</span>`</span>); <span class="hljs-comment">// 成功时执行</span></li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败时执行</span></li><li>});</li><li>
</li><li><span class="hljs-comment">// 无论成功还是失败都会执行</span></li><li>promise.<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'finally complete'</span>);</li><li>})</li></ol></pre></div></div>     <p>在上述代码中，then方法的回调函数接收Promise对象的成功结果，并输出至控制台。如果Promise对象进入rejected状态，catch方法的回调函数接收错误对象，并输出至控制台。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>当Promise被reject且未通过catch方法处理时，会触发globalUnhandledRejectionDetected事件。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-errormanager#errormanageronglobalunhandledrejectiondetected18" target="_blank">errorManager.on('globalUnhandledRejectionDetected')</a>接口监听该事件，以全局捕获未处理的Promise reject。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="asyncawait">async/await<i class="anchor-icon anchor-icon-link" anchorid="asyncawait" tips="复制节点链接"></i></h2>          <p>async/await是用于处理异步操作的Promise语法糖，使编写异步代码更加简单和易读。使用async关键字声明异步函数，并使用await关键字等待Promise的解析（fulfilled或rejected），以同步方式编写异步操作的代码。</p>     <p>async函数返回Promise对象，实现异步操作。函数内部可包含零个或多个await关键字，await会暂停执行，直到关联的Promise完成状态转换（fulfilled或rejected）。若函数执行过程中抛出异常，该异常将直接触发返回的Promise进入rejected状态，错误对象可通过catch方法或then的第二个回调参数捕获。</p>     <p>下面是一个使用async/await的示例，模拟同步方法执行异步操作的场景，3秒后返回一个字符串。</p>     <div _ngcontent-dut-c106="" class="highlight-div"><div _ngcontent-dut-c106="" class="highlight-div-header"><div _ngcontent-dut-c106="" class="highlight-div-header-left"><div _ngcontent-dut-c106="" class="handle-button expand-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dut-c106="" class="highlight-div-header-right"><div _ngcontent-dut-c106="" class="handle-button ai-button"></div><div _ngcontent-dut-c106="" class="handle-button line-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dut-c106="" class="handle-button theme-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dut-c106="" class="handle-button copy-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dut-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myAsyncFunction</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello, world!'</span>);</li><li>    }, <span class="hljs-number">3000</span>);</li><li>  });</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(result); <span class="hljs-comment">// 输出： Hello, world!</span></li><li>  <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myAsyncFunction</span>();</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'res is: '</span> + res);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在上述示例代码中，使用await等待Promise解析，并存储在result变量中。</p>     <p>需要注意的是，等待异步操作时，需将操作包在async函数中，并搭配await使用，且await关键字只在async函数内有效。同时也可使用try/catch块来捕获异常。</p>     <div _ngcontent-dut-c106="" class="highlight-div"><div _ngcontent-dut-c106="" class="highlight-div-header"><div _ngcontent-dut-c106="" class="highlight-div-header-left"><div _ngcontent-dut-c106="" class="handle-button expand-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dut-c106="" class="highlight-div-header-right"><div _ngcontent-dut-c106="" class="handle-button ai-button"></div><div _ngcontent-dut-c106="" class="handle-button line-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dut-c106="" class="handle-button theme-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dut-c106="" class="handle-button copy-button"><div _ngcontent-dut-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dut-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myAsyncFunction</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello, world!'</span>);</li><li>    });</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(result); <span class="hljs-comment">// 输出： Hello, world!</span></li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Get exception: <span class="hljs-subst">${e}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">myAsyncFunction</span>();</li></ol></pre></div></div>    </div>   </div>   <div></div></div>