<h1 _ngcontent-ick-c119="" class="doc-title ng-star-inserted" title="异步锁"> 异步锁 </h1>

<div _ngcontent-ick-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>为了解决多线程并发实例间的数据竞争问题，ArkTS引入了异步锁能力。异步锁可能会被类对象持有，因此为了更方便地在并发实例间获取同一个异步锁对象，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-utils-locks#asynclock" target="_blank">AsyncLock对象</a>支持跨线程引用传递。</p>    <p>由于ArkTS语言支持异步操作，阻塞锁容易产生死锁问题，因此在ArkTS中仅支持异步锁（非阻塞式锁）。同时，异步锁还可以用于保证单线程内的异步任务时序一致性，防止异步任务时序不确定导致的同步问题。</p>    <p>更多异步锁相关接口，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-arkts-utils-locks" target="_blank">异步锁ArkTSUtils.locks</a>。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>使用异步锁的方法需标记为async，调用时需用await修饰，以确保时序正确。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="使用示例">使用示例<i class="anchor-icon anchor-icon-link" anchorid="使用示例" tips="复制节点链接"></i></h2>          <p>为了防止<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable">@Sendable共享对象</a>在不同线程中修改共享变量导致的竞争问题，可以使用异步锁保护数据。示例如下：</p>     <div _ngcontent-ick-c106="" class="highlight-div"><div _ngcontent-ick-c106="" class="highlight-div-header"><div _ngcontent-ick-c106="" class="highlight-div-header-left"><div _ngcontent-ick-c106="" class="handle-button expand-button"><div _ngcontent-ick-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ick-c106="" class="highlight-div-header-right"><div _ngcontent-ick-c106="" class="handle-button ai-button"></div><div _ngcontent-ick-c106="" class="handle-button line-button"><div _ngcontent-ick-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ick-c106="" class="handle-button theme-button"><div _ngcontent-ick-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ick-c106="" class="handle-button copy-button"><div _ngcontent-ick-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ick-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArkTSUtils</span>, taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">count_</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">lock_</span>: <span class="hljs-title class_">ArkTSUtils</span>.<span class="hljs-property">locks</span>.<span class="hljs-property">AsyncLock</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArkTSUtils</span>.<span class="hljs-property">locks</span>.<span class="hljs-title class_">AsyncLock</span>();</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getCount</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-comment">// 对需要保护的数据加异步锁</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lock_</span>.<span class="hljs-title function_">lockAsync</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count_</span>;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">increaseCount</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 对需要保护的数据加异步锁</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lock_</span>.<span class="hljs-title function_">lockAsync</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count_</span>++;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printCount</span>(<span class="hljs-params">a: A</span>) {</li><li>  a.<span class="hljs-title function_">increaseCount</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"InputModule: count is:"</span> + <span class="hljs-keyword">await</span> a.<span class="hljs-title function_">getCount</span>());</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-comment">// 创建sendable对象a</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">a</span>: A = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();</li><li>          <span class="hljs-comment">// 将实例a传递给子线程</span></li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(printCount, a);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>