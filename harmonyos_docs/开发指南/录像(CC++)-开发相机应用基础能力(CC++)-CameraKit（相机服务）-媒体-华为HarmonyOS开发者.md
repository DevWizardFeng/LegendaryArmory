<h1 _ngcontent-uft-c119="" class="doc-title ng-star-inserted" title="录像(C/C++)"> 录像(C/C++) </h1>

<div _ngcontent-uft-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>录像也是相机应用的最重要功能之一，录像是循环帧的捕获。对于录像的流畅度，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-shooting">拍照参考</a>中的步骤5，设置分辨率、闪光灯、焦距、照片质量及旋转角度等信息。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libohcamera.so</li><li>    libhilog_ndk.z.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>获取SurfaceId。</p>       <p>系统提供的media接口可以创建一个录像AVRecorder实例，通过该实例的getInputSurface()方法获取SurfaceId。</p></li>      <li>       <p>创建录像输出流。</p>       <p>根据传入的SurfaceId，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_getsupportedcameraoutputcapability" target="_blank">OH_CameraManager_GetSupportedCameraOutputCapability</a>接口获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera-camera-outputcapability" target="_blank">Camera_OutputCapability</a>能力，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera-camera-outputcapability" target="_blank">Camera_OutputCapability</a>中的videoProfiles，获取当前设备支持的录像输出流。然后，定义创建录像的参数，通过OH_CameraManager_CreateVideoOutput方法创建录像输出流。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_VideoOutput* <span class="hljs-title">CreateVideoOutput</span><span class="hljs-params">(Camera_Manager* cameraManager, <span class="hljs-type">char</span>* videoSurfaceIdStr,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> Camera_VideoProfile* videoProfile)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建VideoOutput对象。</span></li><li>    Camera_VideoOutput* videoOutput = <span class="hljs-literal">nullptr</span>;</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_CameraManager_CreateVideoOutput</span>(cameraManager, videoProfile, videoSurfaceIdStr,</li><li>        &amp;videoOutput);</li><li>    <span class="hljs-keyword">if</span> (videoProfile == <span class="hljs-literal">nullptr</span> || videoOutput == <span class="hljs-literal">nullptr</span> || ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateVideoOutput failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> videoOutput;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>开始录像。</p>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-video-output-h#oh_videooutput_start" target="_blank">OH_VideoOutput_Start()</a>方法启动录像输出流。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 启动录像输出流。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">VideoOutputStart</span><span class="hljs-params">(Camera_VideoOutput* videoOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoOutput_Start(videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Start failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>停止录像。</p>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-video-output-h#oh_videooutput_stop" target="_blank">OH_VideoOutput_Stop()</a>方法停止录像输出流。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 停止录像输出流。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">VideoOutputStop</span><span class="hljs-params">(Camera_VideoOutput* videoOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoOutput_Stop(videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Stop failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2>          <p>在相机应用开发过程中，可以随时监听录像输出流状态，包括录像开始、录像结束、录像流输出的错误。</p>     <ul>      <li>       <p>通过注册固定的frameStart回调函数获取监听录像开始结果，videoOutput创建成功时即可监听，录像第一次曝光时触发，当触发该事件回调时表示录像已开始。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">VideoOutputOnFrameStart</span>(Camera_VideoOutput* videoOutput)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "VideoOutputOnFrameStart");</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的frameEnd回调函数获取监听录像结束结果，videoOutput创建成功时即可监听，录像完成最后一帧时触发，有该事件返回结果则认为录像流已结束。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VideoOutputOnFrameEnd</span><span class="hljs-params">(Camera_VideoOutput* videoOutput, <span class="hljs-type">int32_t</span> frameCount)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"VideoOutput frameCount = %{public}d"</span>, frameCount);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的error回调函数获取监听录像输出错误结果，callback返回录像输出接口使用错误时对应的错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_errorcode" target="_blank">Camera_ErrorCode</a>。</p>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">VideoOutputOnError</span>(Camera_VideoOutput* videoOutput, Camera_ErrorCode errorCode)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "VideoOutput errorCode = %{public}d", errorCode);</li><li>}</li></ol></pre></div></div>       <div _ngcontent-uft-c106="" class="highlight-div"><div _ngcontent-uft-c106="" class="highlight-div-header"><div _ngcontent-uft-c106="" class="highlight-div-header-left"><div _ngcontent-uft-c106="" class="handle-button expand-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uft-c106="" class="highlight-div-header-right"><div _ngcontent-uft-c106="" class="handle-button ai-button"></div><div _ngcontent-uft-c106="" class="handle-button line-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uft-c106="" class="handle-button theme-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uft-c106="" class="handle-button copy-button"><div _ngcontent-uft-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uft-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>VideoOutput_Callbacks* GetVideoOutputListener(<span class="hljs-keyword">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">VideoOutput_Callbacks</span> <span class="hljs-variable">videoOutputListener</span> <span class="hljs-operator">=</span> {</li><li>        .onFrameStart = VideoOutputOnFrameStart,</li><li>        .onFrameEnd = VideoOutputOnFrameEnd,</li><li>        .onError = VideoOutputOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;videoOutputListener;</li><li>}</li><li>
</li><li>Camera_ErrorCode <span class="hljs-title function_">RegisterVideoOutputCallback</span><span class="hljs-params">(Camera_VideoOutput* videoOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoOutput_RegisterCallback(videoOutput, GetVideoOutputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>      OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_RegisterCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>