<h1 _ngcontent-shw-c119="" class="doc-title ng-star-inserted" title="录像实践(ArkTS)"> 录像实践(ArkTS) </h1>

<div _ngcontent-shw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p>    <p>当前示例提供完整的录像流程介绍，方便开发者了解完整的接口调用顺序。</p>    <p>在参考以下示例前，建议开发者查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-management">相机开发指导(ArkTS)</a>的具体章节，了解<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-device-input">设备输入</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-session-management">会话管理</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording">录像</a>等单个流程。</p>    <p>如需要将视频保存到媒体库中可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton">保存媒体库资源</a>。</p>    <div class="tiledSection">     <h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2>          <p>在获取到相机支持的输出流能力后，开始创建录像流，开发流程如下。</p>     <p><span><img originheight="4096" originwidth="2447" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114433.40417270237014653039634181805306:50001231000000:2800:2275A16FC4CFCB8C235E463503FF66C8634FE0EBAABAD3E709E5B5245BABF3B2.png" width="920" height="1539.975480179812"></span></p>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p>Context获取方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>     <div _ngcontent-shw-c106="" class="highlight-div"><div _ngcontent-shw-c106="" class="highlight-div-header"><div _ngcontent-shw-c106="" class="highlight-div-header-left"><div _ngcontent-shw-c106="" class="handle-button expand-button"><div _ngcontent-shw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-shw-c106="" class="highlight-div-header-right"><div _ngcontent-shw-c106="" class="handle-button ai-button"></div><div _ngcontent-shw-c106="" class="handle-button line-button"><div _ngcontent-shw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-shw-c106="" class="handle-button theme-button"><div _ngcontent-shw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-shw-c106="" class="handle-button copy-button"><div _ngcontent-shw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-shw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RecordingResources</span> {</li><li>  avRecorder?: media.<span class="hljs-property">AVRecorder</span>;</li><li>  videoOutput?: camera.<span class="hljs-property">VideoOutput</span>;</li><li>  cameraInput?: camera.<span class="hljs-property">CameraInput</span>;</li><li>  previewOutput?: camera.<span class="hljs-property">PreviewOutput</span>;</li><li>  videoSession?: camera.<span class="hljs-property">VideoSession</span>;</li><li>  file?: fs.<span class="hljs-property">File</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 全局资源跟踪。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">resources</span>: <span class="hljs-title class_">RecordingResources</span> = {};</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">releaseResources</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> releaseSteps = [</li><li>  <span class="hljs-comment">// 停止录像。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'停止录像失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 停止视频输出。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoOutput</span>?.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'停止视频输出失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 停止会话。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>?.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'停止会话失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 释放录像器。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'释放录像器失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 关闭相机输入。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">cameraInput</span>?.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'关闭相机输入失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 释放视频输出。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoOutput</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'释放视频输出失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 释放预览输出。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">previewOutput</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'释放预览输出失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'释放会话失败:'</span>, e)),</li><li>    <span class="hljs-comment">// 关闭文件。</span></li><li>    <span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-keyword">if</span> (resources.<span class="hljs-property">file</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">close</span>(resources.<span class="hljs-property">file</span>);</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failure to close file'</span>);</li><li>        }</li><li>      }</li><li>    },</li><li>  ];</li><li>
</li><li>  <span class="hljs-comment">// 按顺序执行释放步骤。</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> step <span class="hljs-keyword">of</span> releaseSteps) {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">step</span>();</li><li>  }</li><li>  <span class="hljs-comment">// 清空资源引用。</span></li><li>  resources.<span class="hljs-property">avRecorder</span> = <span class="hljs-literal">undefined</span>;</li><li>  resources.<span class="hljs-property">videoOutput</span> = <span class="hljs-literal">undefined</span>;</li><li>  resources.<span class="hljs-property">cameraInput</span> = <span class="hljs-literal">undefined</span>;</li><li>  resources.<span class="hljs-property">previewOutput</span> = <span class="hljs-literal">undefined</span>;</li><li>  resources.<span class="hljs-property">videoSession</span> = <span class="hljs-literal">undefined</span>;</li><li>  resources.<span class="hljs-property">file</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">videoRecording</span>(<span class="hljs-params">context: common.Context, surfaceId: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    cameraManager = camera.<span class="hljs-title function_">getCameraManager</span>(context);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getCameraManager call failed, error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!cameraManager) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraManager is null"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取相机列表。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    cameraArray = cameraManager.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getSupportedCameras call failed. error code: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!cameraArray || cameraArray.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraManager.getSupportedCameras error"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取支持的模式类型。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneModes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">SceneMode</span>&gt; = cameraManager.<span class="hljs-title function_">getSupportedSceneModes</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupportVideoMode</span>: <span class="hljs-built_in">boolean</span> = sceneModes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (!isSupportVideoMode) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'video mode not support'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 示例代码默认选择第一个镜头，实际开发需根据所需镜头。</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">cameraDevice</span>: camera.<span class="hljs-property">CameraDevice</span> = cameraArray[<span class="hljs-number">0</span>];</li><li>
</li><li>  <span class="hljs-comment">// 获取相机设备支持的输出流能力。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraOutputCap</span>: camera.<span class="hljs-property">CameraOutputCapability</span> = cameraManager.<span class="hljs-title function_">getSupportedOutputCapability</span>(cameraDevice,</li><li>    camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>  <span class="hljs-keyword">if</span> (!cameraOutputCap) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"cameraOutputCap is null"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"outputCapability: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cameraOutputCap));</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">VideoProfile</span>&gt; = cameraOutputCap.<span class="hljs-property">videoProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!videoProfilesArray || videoProfilesArray.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"videoProfilesArray is null or []"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// videoProfile的宽高需要与AVRecorderProfile的宽高保持一致，并且需要使用AVRecorderProfile所支持的宽高。</span></li><li>  <span class="hljs-comment">// 示例代码默认选择第一个videoProfile，实际开发需根据所需筛选videoProfile。</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">videoProfile</span>: camera.<span class="hljs-property">VideoProfile</span> = cameraOutputCap.<span class="hljs-property">videoProfiles</span>[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoUri</span>: <span class="hljs-built_in">string</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/'</span> + <span class="hljs-string">'VIDEO_'</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toString</span>()) + <span class="hljs-string">'.mp4'</span>; <span class="hljs-comment">// 本地沙箱路径。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">file</span> = fs.<span class="hljs-title function_">openSync</span>(videoUri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`openSync call failed, error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建并配置AVRecorder。</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">isHdr</span>: <span class="hljs-built_in">boolean</span> = [</li><li>    camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCBCR_P010</span>,</li><li>    camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCRCB_P010</span></li><li>  ].<span class="hljs-title function_">includes</span>(videoProfile.<span class="hljs-property">format</span>);</li><li>  <span class="hljs-comment">// 配置参数以实际硬件设备支持的范围为准。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aVRecorderProfile</span>: media.<span class="hljs-property">AVRecorderProfile</span> = {</li><li>    <span class="hljs-attr">audioBitrate</span>: <span class="hljs-number">48000</span>,</li><li>    <span class="hljs-attr">audioChannels</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-attr">audioCodec</span>: media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">AUDIO_AAC</span>,</li><li>    <span class="hljs-attr">audioSampleRate</span>: <span class="hljs-number">48000</span>,</li><li>    <span class="hljs-attr">fileFormat</span>: media.<span class="hljs-property">ContainerFormatType</span>.<span class="hljs-property">CFT_MPEG_4</span>,</li><li>    <span class="hljs-attr">videoBitrate</span>: <span class="hljs-number">2000000</span>,</li><li>    <span class="hljs-attr">videoCodec</span>: isHdr ? media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_HEVC</span> : media.<span class="hljs-property">CodecMimeType</span>.<span class="hljs-property">VIDEO_AVC</span>,</li><li>    <span class="hljs-attr">videoFrameWidth</span>: videoProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>,</li><li>    <span class="hljs-attr">videoFrameHeight</span>: videoProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>,</li><li>    <span class="hljs-attr">videoFrameRate</span>: <span class="hljs-number">30</span>,</li><li>    <span class="hljs-attr">isHdr</span>: isHdr</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">avMetadata</span>: media.<span class="hljs-property">AVMetadata</span> = {</li><li>    <span class="hljs-attr">videoOrientation</span>: <span class="hljs-string">'0'</span>, <span class="hljs-comment">// 合理值0、90、180、270，非合理值prepare接口将报错。</span></li><li>    <span class="hljs-attr">location</span>: { <span class="hljs-attr">latitude</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">longitude</span>: <span class="hljs-number">130</span> }</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">aVRecorderConfig</span>: media.<span class="hljs-property">AVRecorderConfig</span> = {</li><li>    <span class="hljs-attr">audioSourceType</span>: media.<span class="hljs-property">AudioSourceType</span>.<span class="hljs-property">AUDIO_SOURCE_TYPE_MIC</span>,</li><li>    <span class="hljs-attr">videoSourceType</span>: media.<span class="hljs-property">VideoSourceType</span>.<span class="hljs-property">VIDEO_SOURCE_TYPE_SURFACE_YUV</span>,</li><li>    <span class="hljs-attr">profile</span>: aVRecorderProfile,</li><li>    <span class="hljs-attr">url</span>: <span class="hljs-string">`fd://<span class="hljs-subst">${resources.file.fd.toString()}</span>`</span>, <span class="hljs-comment">// 文件需先由调用者创建，赋予读写权限，将文件fd传给此参数，eg.fd://45--file:///data/media/01.mp4</span></li><li>    <span class="hljs-attr">rotation</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 合理值0、90、180、270，非合理值prepare接口将报错。</span></li><li>    <span class="hljs-attr">metadata</span>: avMetadata</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">avRecorder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createAVRecorder call failed. error code: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!resources.<span class="hljs-property">avRecorder</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`avRecorder is null`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">prepare</span>(aVRecorderConfig);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`prepare call failed. error code: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取视频输入surface。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoSurfaceId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 该surfaceID用于传递给相机接口创造videoOutput。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoSurfaceId = <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">getInputSurface</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getInputSurface call failed. error code: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!videoSurfaceId) {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建VideoOutput对象。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">videoOutput</span> = cameraManager.<span class="hljs-title function_">createVideoOutput</span>(videoProfile, videoSurfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the videoOutput instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!resources.<span class="hljs-property">videoOutput</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'videoOutput is null'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">Profile</span>&gt; = cameraOutputCap.<span class="hljs-property">previewProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!previewProfilesArray || previewProfilesArray.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"previewProfilesArray is null or []"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建预览输出流，其中参数surfaceId是由XComponent组件提供的。</span></li><li>  <span class="hljs-keyword">const</span> previewProfile = previewProfilesArray.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">previewProfile: camera.Profile</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>((previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>) - (videoProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / videoProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>)) &lt; <span class="hljs-title class_">Number</span>.<span class="hljs-property">EPSILON</span>;</li><li>  }); <span class="hljs-comment">// 筛选与录像分辨率宽高比一致的预览分辨率。</span></li><li>  <span class="hljs-keyword">if</span> (!previewProfile) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'No preview resolution found that matches the aspect ratio of the video resolution'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">previewOutput</span> = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, surfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createPreviewOutput call failed. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!resources.<span class="hljs-property">previewOutput</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'previewOutput is null'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建相机输入流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">cameraInput</span> = cameraManager.<span class="hljs-title function_">createCameraInput</span>(cameraDevice);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to createCameraInput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!resources.<span class="hljs-property">cameraInput</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraInput is null'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听cameraInput错误信息。</span></li><li>  resources.<span class="hljs-property">cameraInput</span>!.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, cameraDevice, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Camera input error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 打开相机。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">cameraInput</span>!.<span class="hljs-title function_">open</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to open cameraInput. error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 创建会话。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">videoSession</span> = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!resources.<span class="hljs-property">videoSession</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'videoSession is null'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 监听session错误信息。</span></li><li>  resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Video session error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// 开始配置会话。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">beginConfig</span>();</li><li>    resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">addInput</span>(resources.<span class="hljs-property">cameraInput</span>!);</li><li>    resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">addOutput</span>(resources.<span class="hljs-property">videoOutput</span>!);</li><li>    resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">addOutput</span>(resources.<span class="hljs-property">previewOutput</span>!);</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">commitConfig</span>();</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>!.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Session Configuration Failure. error: <span class="hljs-subst">${err}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">releaseResources</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 启动录像。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoOutput</span>!.<span class="hljs-title function_">start</span>();</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>!.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`avRecorder start error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止录像。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">avRecorder</span>!.<span class="hljs-title function_">stop</span>();</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoOutput</span>!.<span class="hljs-title function_">stop</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`avRecorder stop error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>  </li><li>  <span class="hljs-comment">// 停止当前会话。</span></li><li>  <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>.<span class="hljs-title function_">stop</span>();</li><li>
</li><li>  <span class="hljs-comment">// 关闭文件。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    fs.<span class="hljs-title function_">closeSync</span>(resources.<span class="hljs-property">file</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`closeSync failed, error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// 释放相机输入流。</span></li><li>  <span class="hljs-keyword">await</span> resources.<span class="hljs-property">cameraInput</span>.<span class="hljs-title function_">close</span>();</li><li>
</li><li>  <span class="hljs-comment">// 释放预览输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">previewOutput</span>.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`release previewOutput failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// 释放录像输出流。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoOutput</span>.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`release videoOutput failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放会话。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> resources.<span class="hljs-property">videoSession</span>.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`release videoSession failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 会话置空。</span></li><li>  resources.<span class="hljs-property">videoSession</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>