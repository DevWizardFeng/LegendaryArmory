<h1 _ngcontent-lxl-c119="" class="doc-title ng-star-inserted" title="录像实践(C/C++)"> 录像实践(C/C++) </h1>

<div _ngcontent-lxl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p> <p>当前示例提供完整的录像流程及其接口调用顺序的介绍。对于单个流程（如设备输入、会话管理、录像）的介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">相机开发指导(Native)</a>的具体章节。</p>  <div class="tiledSection"><h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2><p>在获取到相机支持的输出流能力后，开始创建录像流，开发流程如下。</p> <p><span><img originheight="4096" originwidth="3683" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114433.02693135335378338853429789040767:50001231000000:2800:420D5E4A6D246B887B11B909066BFA9F714CF9AC54CB9FAE446112FCC4226493.png" width="920" height="1023.1658973662775"></span></p> </div>  <div class="tiledSection"><h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2><ol><li><p>在CMake脚本中链接相关动态库。</p>  <div _ngcontent-lxl-c106="" class="highlight-div"><div _ngcontent-lxl-c106="" class="highlight-div-header"><div _ngcontent-lxl-c106="" class="highlight-div-header-left"><div _ngcontent-lxl-c106="" class="handle-button expand-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxl-c106="" class="highlight-div-header-right"><div _ngcontent-lxl-c106="" class="handle-button ai-button"></div><div _ngcontent-lxl-c106="" class="handle-button line-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxl-c106="" class="handle-button theme-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxl-c106="" class="handle-button copy-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxl-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libohcamera.so</li><li>    libhilog_ndk.z.so</li><li>)</li></ol></pre></div></div>  </li><li><p>创建头文件ndk_camera.h。</p>  <div _ngcontent-lxl-c106="" class="highlight-div"><div _ngcontent-lxl-c106="" class="highlight-div-header"><div _ngcontent-lxl-c106="" class="highlight-div-header-left"><div _ngcontent-lxl-c106="" class="handle-button expand-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxl-c106="" class="highlight-div-header-right"><div _ngcontent-lxl-c106="" class="handle-button ai-button"></div><div _ngcontent-lxl-c106="" class="handle-button line-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxl-c106="" class="handle-button theme-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxl-c106="" class="handle-button copy-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NDKCamera</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    ~<span class="hljs-built_in">NDKCamera</span>();</li><li>    <span class="hljs-built_in">NDKCamera</span>(<span class="hljs-type">char</span>* previewId, <span class="hljs-type">char</span>* videoId);</li><li>};</li></ol></pre></div></div>  </li><li><p>cpp侧导入NDK接口，并根据传入的SurfaceId进行录像。</p>  <div _ngcontent-lxl-c106="" class="highlight-div"><div _ngcontent-lxl-c106="" class="highlight-div-header"><div _ngcontent-lxl-c106="" class="highlight-div-header-left"><div _ngcontent-lxl-c106="" class="handle-button expand-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxl-c106="" class="highlight-div-header-right"><div _ngcontent-lxl-c106="" class="handle-button ai-button"></div><div _ngcontent-lxl-c106="" class="handle-button line-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxl-c106="" class="handle-button theme-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxl-c106="" class="handle-button copy-button"><div _ngcontent-lxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span></li><li>
</li><li><span class="hljs-type">bool</span> IsAspectRatioEqual(<span class="hljs-type">float</span> videoAspectRatio, <span class="hljs-type">float</span> previewAspectRatio)</li><li>{</li><li>    <span class="hljs-type">float</span> epsilon = <span class="hljs-number">1e-6</span>f;</li><li>    <span class="hljs-keyword">return</span> fabsf(videoAspectRatio - previewAspectRatio) &lt;= epsilon;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> OnCameraInputError(<span class="hljs-keyword">const</span> Camera_Input* cameraInput, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnCameraInput errorCode = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>CameraInput_Callbacks* GetCameraInputListener(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> CameraInput_Callbacks cameraInputCallbacks = {</li><li>        .onError = OnCameraInputError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;cameraInputCallbacks;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> CaptureSessionOnFocusStateChange(Camera_CaptureSession* session, Camera_FocusState focusState)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSessionOnFocusStateChange"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> CaptureSessionOnError(Camera_CaptureSession* session, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSessionOnError = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>CaptureSession_Callbacks* GetCaptureSessionRegister(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> CaptureSession_Callbacks captureSessionCallbacks = {</li><li>        .onFocusStateChange = CaptureSessionOnFocusStateChange,</li><li>        .onError = CaptureSessionOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;captureSessionCallbacks;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> VideoOutputOnFrameStart(Camera_VideoOutput* videoOutput)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"VideoOutputOnFrameStart"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> VideoOutputOnFrameEnd(Camera_VideoOutput* videoOutput, int32_t frameCount)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"VideoOutput frameCount = %{public}d"</span>, frameCount);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> VideoOutputOnError(Camera_VideoOutput* videoOutput, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"VideoOutput errorCode = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>VideoOutput_Callbacks* GetVideoOutputListener(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> VideoOutput_Callbacks videoOutputListener = {</li><li>        .onFrameStart = VideoOutputOnFrameStart,</li><li>        .onFrameEnd = VideoOutputOnFrameEnd,</li><li>        .onError = VideoOutputOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;videoOutputListener;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> CameraManagerStatusCallback(Camera_Manager* cameraManager, Camera_StatusInfo* status)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CameraManagerStatusCallback is called"</span>);</li><li>}</li><li>
</li><li>CameraManager_Callbacks* GetCameraManagerListener()</li><li>{</li><li>    <span class="hljs-keyword">static</span> CameraManager_Callbacks cameraManagerListener = {</li><li>        .onCameraStatus = CameraManagerStatusCallback</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;cameraManagerListener;</li><li>}</li><li>
</li><li>NDKCamera::NDKCamera(<span class="hljs-type">char</span>* previewId, <span class="hljs-type">char</span>* videoId)</li><li>{</li><li>    Camera_Manager* cameraManager = nullptr;</li><li>    Camera_Device* cameras = nullptr;</li><li>    Camera_CaptureSession* captureSession = nullptr;</li><li>    Camera_OutputCapability* cameraOutputCapability = nullptr;</li><li>    Camera_VideoOutput* videoOutput = nullptr;</li><li>    <span class="hljs-keyword">const</span> Camera_Profile* previewProfile = nullptr;</li><li>    <span class="hljs-keyword">const</span> Camera_Profile* photoProfile = nullptr;</li><li>    <span class="hljs-keyword">const</span> Camera_VideoProfile* videoProfile = nullptr;</li><li>    Camera_PreviewOutput* previewOutput = nullptr;</li><li>    Camera_PhotoOutput* photoOutput = nullptr;</li><li>    Camera_Input* cameraInput = nullptr;</li><li>    uint32_t size = <span class="hljs-number">0</span>;</li><li>    uint32_t cameraDeviceIndex = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">char</span>* videoSurfaceId = videoId;</li><li>    <span class="hljs-type">char</span>* previewSurfaceId = previewId;</li><li>    <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>    Camera_ErrorCode ret = OH_Camera_GetCameraManager(&amp;cameraManager);</li><li>    <span class="hljs-keyword">if</span> (cameraManager == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_Camera_GetCameraManager failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 监听相机状态变化。</span></li><li>    ret = OH_CameraManager_RegisterCallback(cameraManager, GetCameraManagerListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_RegisterCallback failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机列表。</span></li><li>    ret = OH_CameraManager_GetSupportedCameras(cameraManager, &amp;cameras, &amp;size);</li><li>    <span class="hljs-keyword">if</span> (cameras == nullptr || size &lt;= <span class="hljs-number">0</span> || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_GetSupportedCameras failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> index = <span class="hljs-number">0</span>; index &lt; size; index++) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"cameraId  =  %{public}s "</span>, cameras[index].cameraId);              <span class="hljs-comment">// 获取相机ID。</span></li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"cameraPosition  =  %{public}d "</span>, cameras[index].cameraPosition);  <span class="hljs-comment">// 获取相机位置。</span></li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"cameraType  =  %{public}d "</span>, cameras[index].cameraType);          <span class="hljs-comment">// 获取相机类型。</span></li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"connectionType  =  %{public}d "</span>, cameras[index].connectionType);  <span class="hljs-comment">// 获取相机连接类型。</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (size &lt; cameraDeviceIndex + <span class="hljs-number">1</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"cameraDeviceIndex is invalid."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机设备支持的输出流能力。</span></li><li>    ret = OH_CameraManager_GetSupportedCameraOutputCapability(cameraManager, &amp;cameras[cameraDeviceIndex],</li><li>                                                            &amp;cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_GetSupportedCameraOutputCapability failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability-&gt;previewProfiles == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"previewProfiles == null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    previewProfile = cameraOutputCapability-&gt;previewProfiles[<span class="hljs-number">0</span>];</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"previewProfile width: %{public}d, height: %{public}d."</span>, previewProfile-&gt;size.width,</li><li>        previewProfile-&gt;size.height);</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability-&gt;photoProfiles == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"photoProfiles == null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    photoProfile = cameraOutputCapability-&gt;photoProfiles[<span class="hljs-number">0</span>];</li><li>
</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability-&gt;videoProfiles == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"videoProfiles == null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 预览流宽高比要与录像流的宽高比一致，如果录制的是hdr视频，请筛选支持hdr的Camera_VideoProfile。</span></li><li>    Camera_VideoProfile** videoProfiles = cameraOutputCapability-&gt;videoProfiles;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> index = <span class="hljs-number">0</span>; index &lt; cameraOutputCapability-&gt;videoProfilesSize; index++) {</li><li>        <span class="hljs-type">bool</span> isEqual = IsAspectRatioEqual((<span class="hljs-type">float</span>)videoProfiles[index]-&gt;size.width / videoProfiles[index]-&gt;size.height,</li><li>            (<span class="hljs-type">float</span>)previewProfile-&gt;size.width / previewProfile-&gt;size.height);</li><li>        <span class="hljs-comment">// 默认筛选CAMERA_FORMAT_YUV_420_SP的profile。</span></li><li>        <span class="hljs-keyword">if</span> (isEqual &amp;&amp; videoProfiles[index]-&gt;format == Camera_Format::<span class="hljs-built_in">CAMERA_FORMAT_YUV_420_SP</span>) {</li><li>            videoProfile = videoProfiles[index];</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"videoProfile width: %{public}d, height: %{public}d."</span>, videoProfile-&gt;size.width,</li><li>                videoProfile-&gt;size.height);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (videoProfile == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Get videoProfile failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建VideoOutput对象。</span></li><li>    ret = OH_CameraManager_CreateVideoOutput(cameraManager, videoProfile, videoSurfaceId, &amp;videoOutput);</li><li>    <span class="hljs-keyword">if</span> (videoOutput == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateVideoOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 监听视频输出错误信息。</span></li><li>    ret = OH_VideoOutput_RegisterCallback(videoOutput, GetVideoOutputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//创建会话。</span></li><li>    ret = OH_CameraManager_CreateCaptureSession(cameraManager, &amp;captureSession);</li><li>    <span class="hljs-keyword">if</span> (captureSession == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateCaptureSession failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 监听session错误信息。</span></li><li>    ret = OH_CaptureSession_RegisterCallback(captureSession, GetCaptureSessionRegister());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 开始配置会话。</span></li><li>    ret = OH_CaptureSession_BeginConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_BeginConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建相机输入流。</span></li><li>    ret = OH_CameraManager_CreateCameraInput(cameraManager, &amp;cameras[cameraDeviceIndex], &amp;cameraInput);</li><li>    <span class="hljs-keyword">if</span> (cameraInput == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateCameraInput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 监听cameraInput错误信息。</span></li><li>    ret = OH_CameraInput_RegisterCallback(cameraInput, GetCameraInputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 打开相机。</span></li><li>    ret = OH_CameraInput_Open(cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_Open failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加相机输入流。</span></li><li>    ret = OH_CaptureSession_AddInput(captureSession, cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddInput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建预览输出流,其中参数 surfaceId 参考下面 XComponent 组件，预览流为XComponent组件提供的surface。</span></li><li>    ret = OH_CameraManager_CreatePreviewOutput(cameraManager, previewProfile, previewSurfaceId, &amp;previewOutput);</li><li>    <span class="hljs-keyword">if</span> (previewProfile == nullptr || previewOutput == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreatePreviewOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加预览输出流。</span></li><li>    ret = OH_CaptureSession_AddPreviewOutput(captureSession, previewOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddPreviewOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加录像输出流。</span></li><li>    ret = OH_CaptureSession_AddVideoOutput(captureSession, videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddVideoOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 提交会话配置。</span></li><li>    ret = OH_CaptureSession_CommitConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_CommitConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动会话。</span></li><li>    ret = OH_CaptureSession_Start(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Start failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动录像输出流。</span></li><li>    ret = OH_VideoOutput_Start(videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Start failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 开始录像 ts侧调用avRecorder.start()。</span></li><li>
</li><li>    <span class="hljs-comment">// 停止录像输出流。</span></li><li>    ret = OH_VideoOutput_Stop(videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Stop failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 停止录像 ts侧调用avRecorder.stop()。</span></li><li>
</li><li>    <span class="hljs-comment">// 停止当前会话。</span></li><li>    ret = OH_CaptureSession_Stop(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop failed. %d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放相机输入流。</span></li><li>    ret = OH_CameraInput_Close(cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CameraInput_Close success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_Close failed. %d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放预览输出流。</span></li><li>    ret = OH_PreviewOutput_Release(previewOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_Release failed. %d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放录像输出流。</span></li><li>    ret = OH_VideoOutput_Release(videoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_VideoOutput_Release failed. %d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    ret = OH_CaptureSession_Release(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Release failed. %d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 资源释放。</span></li><li>    ret = OH_CameraManager_DeleteSupportedCameras(cameraManager, cameras, size);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_DeleteSupportedCameras. ok"</span>);</li><li>    }</li><li>    ret = OH_CameraManager_DeleteSupportedCameraOutputCapability(cameraManager, cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_DeleteSupportedCameraOutputCapability success"</span>);</li><li>    }</li><li>    ret = OH_Camera_DeleteCameraManager(cameraManager);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_Camera_DeleteCameraManager success"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>