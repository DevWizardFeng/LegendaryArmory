<h1 _ngcontent-dvu-c119="" class="doc-title ng-star-inserted" title="快速入门"> 快速入门 </h1>

<div _ngcontent-dvu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本节以一个简单算子为例，带开发者体验从算子工程创建、代码编写、编译部署到运行验证的开发全流程，让开发者对算子开发工程有个宏观的认识，此处我们以输入是动态shape的Add算子实现为例，为了与内置Add算子区分，定义算子类型为AddCustom。</p> <div class="tiledSection"><h2 id="section124mcpsimp">工程创建<i class="anchor-icon anchor-icon-link" anchorid="section124mcpsimp" tips="复制节点链接"></i></h2><p>DDK软件包中提供了工程创建工具msOpGen，开发者可以输入算子原型定义文件生成AscendC算子开发工程。</p> <ol><li><span>编写AddCustom算子的原型定义json文件。</span><p></p><p>假设AddCustom算子的原型定义文件命名为add_custom.json，存储路径为: $HOME/sample，文件内容如下。</p> <div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">[</span> </li><li>    <span class="hljs-punctuation">{</span> </li><li>        <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AddCustom"</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"input_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"y"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>        <span class="hljs-attr">"output_desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>            <span class="hljs-punctuation">{</span> </li><li>                <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"z"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"param_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"ND"</span> </li><li>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> </li><li>                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>                    <span class="hljs-string">"fp16"</span> </li><li>                <span class="hljs-punctuation">]</span> </li><li>            <span class="hljs-punctuation">}</span> </li><li>        <span class="hljs-punctuation">]</span> </li><li>    <span class="hljs-punctuation">}</span> </li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div> <p></p></li><li><span>注意先设置环境变量，执行<strong>source ${install_path}/ddk/</strong> <strong>tools/tools_ascendc/set_ascendc_env.sh</strong>命令，其中${install_path}为tools包的解压目录。</span></li><li><span>使用msOpGen工具生成AddCustom算子的开发工程。</span><p></p><div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>msopgen gen -i $HOME/sample/add_custom.json -c ai_core-<em>&lt;soc_version&gt;</em> -out   $HOME/sample/AddCustom</li></ol></pre></div></div> <ul><li>-i：算子原型定义文件add_custom.json所在路径。</li><li>-c：ai_core-<em>&lt;soc_version&gt;</em>代表算子在AI Core上执行，<em>&lt;soc_version&gt;</em>为Kirin AI处理器的型号，可在运行环境通过命令进行查询:<div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>hdc -t ${target} shell param get ohos.boot.chiptype</li></ol></pre></div></div> <p>target：设备的SN码，可以通过hdc list targets获取当前运行环境上所有设备的SN码。</p> </li></ul> <div class="p">样例：<div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><strong class="shell">msopgen gen -i ./add_custom.json -c ai_core-kirin9020 -out ./AddCustom</strong></li></ol></pre></div></div> </div> <div class="p">基于同系列的AI处理器型号创建的算子工程，其基础能力通用。命令执行完后，会在$HOME/sample目录下生成算子工程目录AddCustom，工程中包含算子实现的模板文件，编译脚本等，如下所示。<div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>AddCustom </li><li>├── build_devices.sh // 开发者无需关注，在线编译场景预留，编译device侧交付件脚本</li><li>├── build.sh         // 编译入口脚本 </li><li>├── cmake  </li><li>│   ├── config.cmake </li><li>│   ├── util        // 算子工程编译所需脚本及公共编译文件存放目录 </li><li>├── CMakeLists.txt   // 算子工程的CMakeLists.txt </li><li>├── <strong>CMakePresets.json</strong> // 编译配置项 </li><li>├── framework        // 算子插件实现文件目录，单算子模型文件的生成不依赖算子适配插件，无需关注 </li><li>├── op_host                      // host侧实现文件 </li><li>│   ├── <strong>add_custom_tiling.h</strong>    // 算子tiling定义文件 </li><li>│   ├── <strong>add_custom.cpp</strong>         // 算子原型注册、shape推导、信息库、tiling实现等内容文件 </li><li>│   ├── CMakeLists.txt </li><li>├── op_kernel                   // kernel侧实现文件 </li><li>│   ├── CMakeLists.txt    </li><li>│   ├── <strong>add_custom.cpp</strong><strong>        </strong>// 算子核函数实现文件  </li><li>├── scripts                     // 自定义算子工程打包相关脚本所在目录</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述目录结构中的粗体文件op_host/add_custom_tiling.h、op_host/add_custom.cpp、op_kernel/add_custom.cpp为后续算子开发过程中需要修改的文件，其他文件无需修改。</p> </div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section157mcpsimp">算子核函数实现<i class="anchor-icon anchor-icon-link" anchorid="section157mcpsimp" tips="复制节点链接"></i></h2><p>在工程存储目录的"AddCustom/op_kernel/add_custom.cpp"文件中实现算子的核函数，完整的样例代码开发者可以在<a href="https://gitcode.com/HarmonyOS_Samples/cannkit_samplecode_add_custom_cpp/blob/master/FrameworkLaunch/AddCustom/op_kernel/add_custom.cpp" target="_blank">add_custom.cpp</a>中查看，下面介绍关键实现代码。</p> <p>算子核函数实现代码的内部调用关系示意图如下。</p> <div class="fignone"><span class="figcap"><b>图1 </b>核函数调用关系图</span><br><span><img height="143.64000000000001" originheight="177" originwidth="639" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114254.86434875189254850899963919355390:50001231000000:2800:004B88118F9D38922CBED952A48B65F3E57218E72FA60DD81CCC8B2AA8DCD9D0.png" title="点击放大" width="526.6800000000001"></span></div> <p>由此可见除了Init函数完成初始化外，Process中完成了对流水任务<strong>：</strong>搬入、计算、搬出的调用，开发者可以重点关注三个流水任务的实现。</p> <ol><li><span>进行<strong>核函数的定义，</strong>并在核函数中调用算子类的Init和Process函数。</span><p></p><div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <span class="hljs-comment">// 获取Host侧传入的Tiling参数 </span></li><li>    <span class="hljs-built_in">GET_TILING_DATA</span>(tiling_data, tiling); </li><li>    <span class="hljs-comment">// 初始化算子类 </span></li><li>    KernelAdd op; </li><li>    <span class="hljs-comment">// 算子类的初始化函数，完成内存初始化相关工作 </span></li><li>    op.<span class="hljs-built_in">Init</span>(x, y, z, tiling_data.totalLength, tiling_data.tileNum); </li><li>    <span class="hljs-comment">// 完成算子实现的核心逻辑 </span></li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>}</li></ol></pre></div></div> <p></p></li><li><span>定义KernelAdd算子类，其具体成员及成员函数实现如下。</span><p></p><div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int32_t</span> BUFFER_NUM = <span class="hljs-number">2</span>; </li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAdd</span> { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelAdd</span><span class="hljs-params">()</span> </span>{} </li><li>    <span class="hljs-comment">// 初始化函数，完成内存初始化相关操作 </span></li><li>    <strong><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, <span class="hljs-type">uint32_t</span> totalLength, <span class="hljs-type">uint32_t</span> tileNum)</span></span></strong><span class="hljs-function"> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// 使用获取到的TilingData计算得到singleCoreSize(每个核上总计算数据大小)、tileNum（每个核上分块个数）、singleTileLength（每个分块大小）等变量 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;blockLength = totalLength / AscendC::<span class="hljs-built_in">GetBlockNum</span>(); </li><li>        <span class="hljs-keyword">this</span>-&gt;tileNum = tileNum; </li><li>        <span class="hljs-keyword">this</span>-&gt;tileLength = <span class="hljs-keyword">this</span>-&gt;blockLength / tileNum / BUFFER_NUM; </li><li>         </li><li>        <span class="hljs-comment">// 获取当前核的起始索引 </span></li><li>        xGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_X*)x + <span class="hljs-keyword">this</span>-&gt;blockLength * AscendC::<span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength); </li><li>        yGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_Y*)y + <span class="hljs-keyword">this</span>-&gt;blockLength * AscendC::<span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength); </li><li>        zGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_Z*)z + <span class="hljs-keyword">this</span>-&gt;blockLength * AscendC::<span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength); </li><li>        <span class="hljs-comment">// 通过Pipe内存管理对象为输入输出Queue分配内存 </span></li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueX, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_X)); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueY, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_Y)); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(outQueueZ, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_Z)); </li><li>    } </li><li>    <span class="hljs-comment">// 核心处理函数，实现算子逻辑，调用私有成员函数CopyIn、Compute、CopyOut完成矢量算子的三级流水操作 </span></li><li>    <strong><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span></span></strong><span class="hljs-function"> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-type">int32_t</span> loopCount = <span class="hljs-keyword">this</span>-&gt;tileNum * BUFFER_NUM; </li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; loopCount; i++) { </li><li>            <span class="hljs-built_in">CopyIn</span>(i); </li><li>            <span class="hljs-built_in">Compute</span>(i); </li><li>            <span class="hljs-built_in">CopyOut</span>(i); </li><li>        } </li><li>    } </li><li> </li><li> </li><li><span class="hljs-keyword">private</span>: </li><li>    <span class="hljs-comment">// 搬入函数，完成CopyIn阶段的处理，被核心Process函数调用 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> progress)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// 从Queue中分配输入Tensor </span></li><li>        AscendC::LocalTensor&lt;DTYPE_X&gt; xLocal = inQueueX.<span class="hljs-built_in">AllocTensor</span>&lt;DTYPE_X&gt;(); </li><li>        AscendC::LocalTensor&lt;DTYPE_Y&gt; yLocal = inQueueY.<span class="hljs-built_in">AllocTensor</span>&lt;DTYPE_Y&gt;(); </li><li>         <span class="hljs-comment">// 将GlobalTensor数据拷贝到LocalTensor </span></li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(xLocal, xGm[progress * <span class="hljs-keyword">this</span>-&gt;tileLength], <span class="hljs-keyword">this</span>-&gt;tileLength); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(yLocal, yGm[progress * <span class="hljs-keyword">this</span>-&gt;tileLength], <span class="hljs-keyword">this</span>-&gt;tileLength); </li><li>        <span class="hljs-comment">// 将LocalTensor放入VECIN（代表矢量编程中搬入数据的逻辑存放位置）的Queue中 </span></li><li>        inQueueX.<span class="hljs-built_in">EnQue</span>(xLocal); </li><li>        inQueueY.<span class="hljs-built_in">EnQue</span>(yLocal); </li><li>    } </li><li>    <span class="hljs-comment">// 计算函数，完成Compute阶段的处理，被核心Process函数调用 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> progress)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// 将Tensor从队列中取出，用于后续计算 </span></li><li>        AscendC::LocalTensor&lt;DTYPE_X&gt; xLocal = inQueueX.<span class="hljs-built_in">DeQue</span>&lt;DTYPE_X&gt;(); </li><li>        AscendC::LocalTensor&lt;DTYPE_Y&gt; yLocal = inQueueY.<span class="hljs-built_in">DeQue</span>&lt;DTYPE_Y&gt;(); </li><li>        <span class="hljs-comment">// 从Queue中分配输出Tensor </span></li><li>        AscendC::LocalTensor&lt;DTYPE_Z&gt; zLocal = outQueueZ.<span class="hljs-built_in">AllocTensor</span>&lt;DTYPE_Z&gt;(); </li><li>        <span class="hljs-comment">// 调用Add接口进行计算 </span></li><li>        AscendC::<span class="hljs-built_in">Add</span>(zLocal, xLocal, yLocal, <span class="hljs-keyword">this</span>-&gt;tileLength); </li><li>        <span class="hljs-comment">// 将计算结果LocalTensor放入到VecOut的Queue中 </span></li><li>        outQueueZ.<span class="hljs-built_in">EnQue</span>&lt;DTYPE_Z&gt;(zLocal); </li><li>        <span class="hljs-comment">// 释放输入Tensor </span></li><li>        inQueueX.<span class="hljs-built_in">FreeTensor</span>(xLocal); </li><li>        inQueueY.<span class="hljs-built_in">FreeTensor</span>(yLocal); </li><li>    } </li><li>    <span class="hljs-comment">// 搬出函数，完成CopyOut阶段的处理，被核心Process函数调用 </span></li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> progress)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// 从VecOut的Queue中取出输出Tensor </span></li><li>        AscendC::LocalTensor&lt;DTYPE_Z&gt; zLocal = outQueueZ.<span class="hljs-built_in">DeQue</span>&lt;DTYPE_Z&gt;(); </li><li>        <span class="hljs-comment">// 将输出Tensor拷贝到GlobalTensor中 </span></li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(zGm[progress * <span class="hljs-keyword">this</span>-&gt;tileLength], zLocal, <span class="hljs-keyword">this</span>-&gt;tileLength); </li><li>        <span class="hljs-comment">// 将不再使用的LocalTensor释放 </span></li><li>        outQueueZ.<span class="hljs-built_in">FreeTensor</span>(zLocal); </li><li>    } </li><li> </li><li> </li><li><span class="hljs-keyword">private</span>: </li><li>    <span class="hljs-comment">// Pipe内存管理对象 </span></li><li>    AscendC::TPipe pipe; </li><li>    <span class="hljs-comment">// 输入数据Queue队列管理对象，QuePosition为VECIN </span></li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; inQueueX, inQueueY;  </li><li>    <span class="hljs-comment">// 输出数据Queue队列管理对象，QuePosition为VECOUT </span></li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; outQueueZ; </li><li>    <span class="hljs-comment">// 管理输入输出Global Memory内存地址的对象，其中xGm, yGm为输入，zGm为输出 </span></li><li>    AscendC::GlobalTensor&lt;DTYPE_X&gt; xGm; </li><li>    AscendC::GlobalTensor&lt;DTYPE_Y&gt; yGm; </li><li>    AscendC::GlobalTensor&lt;DTYPE_Z&gt; zGm; </li><li>    <span class="hljs-comment">// 每个核上总计算数据大小 </span></li><li>    <span class="hljs-type">uint32_t</span> blockLength; </li><li>    <span class="hljs-comment">// 每个核上总计算数据分块个数 </span></li><li>    <span class="hljs-type">uint32_t</span> tileNum; </li><li>    <span class="hljs-comment">// 每个分块大小 </span></li><li>    <span class="hljs-type">uint32_t</span> tileLength; </li><li>};</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section177mcpsimp">Host侧算子实现<i class="anchor-icon anchor-icon-link" anchorid="section177mcpsimp" tips="复制节点链接"></i></h2><p>核函数开发并验证完成后，下一步就是进行Host侧的实现，对应“AddCustom/op_host”目录下的add_custom_tiling.h文件与add_custom.cpp文件。下面简要介绍下两个文件的关键实现，完整的样例代码可参见<a href="https://gitcode.com/HarmonyOS_Samples/cannkit_samplecode_add_custom_cpp/blob/master/FrameworkLaunch/AddCustom/op_host/add_custom_tiling.h" target="_blank">add_custom_tiling.h</a>与<a href="https://gitcode.com/HarmonyOS_Samples/cannkit_samplecode_add_custom_cpp/blob/master/FrameworkLaunch/AddCustom/op_host/add_custom.cpp" target="_blank">add_custom.cpp</a>。</p> <ol><li><span>修改“add_custom_tiling.h”文件，在此文件中增加粗体部分的代码，进行Tiling参数的定义。</span><p></p><div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_CUSTOM_TILING_H </span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"register/tilingdata_base.h"</span> </span></li><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-built_in">BEGIN_TILING_DATA_DEF</span>(AddCustomTilingData) </li><li>  <span class="hljs-comment">// AddCustom算子使用了2个tiling参数：totalLength与tileNum </span></li><li>  <strong><span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, totalLength);     <span class="hljs-comment">// 总计算数据量 </span></strong></li><li><strong>  <span class="hljs-built_in">TILING_DATA_FIELD_DEF</span>(<span class="hljs-type">uint32_t</span>, tileNum);         <span class="hljs-comment">// 每个核上总计算数据分块个数</span></strong><span class="hljs-comment"> </span></li><li>END_TILING_DATA_DEF; </li><li> </li><li><span class="hljs-comment">// 注册tiling数据到对应的算子 </span></li><li><span class="hljs-built_in">REGISTER_TILING_DATA_CLASS</span>(AddCustom, AddCustomTilingData) </li><li>} </li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// ADD_CUSTOM_TILING_H</span></span></li></ol></pre></div></div> <p></p></li><li><span>修改“add_custom.cpp”文件，进行Tiling的实现。</span><p></p><p>修改“TilingFunc”函数，实现Tiling上下文的获取，并通过上下文获取输入输出shape信息，并根据shape信息设置TilingData，序列化保存TilingData，并设置TilingKey。</p> <div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> optiling { </li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> BLOCK_DIM = <span class="hljs-number">1</span>; </li><li><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> TILE_NUM = <span class="hljs-number">8</span>; </li><li><span class="hljs-function"><span class="hljs-type">static</span> ge::graphStatus <span class="hljs-title">TilingFunc</span><span class="hljs-params">(gert::TilingContext* context)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    AddCustomTilingData tiling; </li><li>    <span class="hljs-type">uint32_t</span> totalLength = context-&gt;<span class="hljs-built_in">GetInputShape</span>(<span class="hljs-number">0</span>)-&gt;<span class="hljs-built_in">GetOriginShape</span>().<span class="hljs-built_in">GetShapeSize</span>(); </li><li>    context-&gt;<span class="hljs-built_in">SetBlockDim</span>(BLOCK_DIM); </li><li>    tiling.<span class="hljs-built_in">set_totalLength</span>(totalLength); </li><li>    tiling.<span class="hljs-built_in">set_tileNum</span>(TILE_NUM); </li><li>    tiling.<span class="hljs-built_in">SaveToBuffer</span>(context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetData</span>(), context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetCapacity</span>()); </li><li>    context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">SetDataSize</span>(tiling.<span class="hljs-built_in">GetDataSize</span>()); </li><li>    <span class="hljs-type">size_t</span> *currentWorkspace = context-&gt;<span class="hljs-built_in">GetWorkspaceSizes</span>(<span class="hljs-number">1</span>); </li><li>    currentWorkspace[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; </li><li>    <span class="hljs-keyword">return</span> ge::GRAPH_SUCCESS; </li><li>} </li><li>} <span class="hljs-comment">// namespace optiling</span></li></ol></pre></div></div> <p></p></li><li><span>在“add_custom.cpp”文件中实现AddCustom算子的shape推导。</span><p></p><p>Add算子的输出shape等于输入shape，所以直接将输入shape赋给输出shape，当前msOpGen工具生成的代码“InferShape”函数无需修改。</p> <p></p></li><li><span>修改“add_custom.cpp”文件中的算子原型注册，此函数为入口函数。</span><p></p><div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> ops { </li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">AddCustom</span> : <span class="hljs-keyword">public</span> OpDef { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">AddCustom</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> : OpDef(name) </span></li><li><span class="hljs-function">    {</span>  </li><li>        <span class="hljs-comment">// Add算子的第一个输入 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">Input</span>(<span class="hljs-string">"x"</span>) </li><li>            .<span class="hljs-built_in">ParamType</span>(REQUIRED)    <span class="hljs-comment">// 代表输入必选 </span></li><li>            .<span class="hljs-built_in">DataType</span>({ ge::DT_FLOAT16, ge::DT_FLOAT, ge::DT_INT32 })   <span class="hljs-comment">// 输入支持的数据类型 </span></li><li>            .<span class="hljs-built_in">Format</span>({ ge::FORMAT_ND, ge::FORMAT_ND, ge::FORMAT_ND });   <span class="hljs-comment">// 输入支持的数据格式 </span></li><li>        <span class="hljs-comment">// Add算子的第二个输入 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">Input</span>(<span class="hljs-string">"y"</span>) </li><li>            .<span class="hljs-built_in">ParamType</span>(REQUIRED) </li><li>            .<span class="hljs-built_in">DataType</span>({ ge::DT_FLOAT16, ge::DT_FLOAT, ge::DT_INT32 }) </li><li>            .<span class="hljs-built_in">Format</span>({ ge::FORMAT_ND, ge::FORMAT_ND, ge::FORMAT_ND }); </li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">Output</span>(<span class="hljs-string">"z"</span>) </li><li>            .<span class="hljs-built_in">ParamType</span>(REQUIRED) </li><li>            .<span class="hljs-built_in">DataType</span>({ ge::DT_FLOAT16, ge::DT_FLOAT, ge::DT_INT32 }) </li><li>            .<span class="hljs-built_in">Format</span>({ ge::FORMAT_ND, ge::FORMAT_ND, ge::FORMAT_ND }); </li><li>        <span class="hljs-comment">// 关联InferShape函数 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">SetInferShape</span>(ge::InferShape); </li><li>        <span class="hljs-comment">// 关联Tiling函数 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">AICore</span>() </li><li>            .<span class="hljs-built_in">SetTiling</span>(optiling::TilingFunc); </li><li>     <strong>   </strong><span class="hljs-comment">// 注册算子支持的AI处理器型号，请替换为实际支持的AI处理器型号,如kirin9020 </span></li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">AICore</span>().<span class="hljs-built_in">AddConfig</span>(<span class="hljs-string">"kirin</span><em><span class="hljs-string">xxx</span></em><span class="hljs-string">"</span>); </li><li>    } </li><li>}; </li><li><span class="hljs-comment">// 结束算子注册 </span></li><li><span class="hljs-built_in">OP_ADD</span>(AddCustom); </li><li>} <span class="hljs-comment">// namespace ops</span></li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section222mcpsimp">算子工程编译部署<i class="anchor-icon anchor-icon-link" anchorid="section222mcpsimp" tips="复制节点链接"></i></h2><p>编译AddCustom工程，生成自定义算子安装包，并将其安装到算子库中。</p> <ol><li><span>编译自定义算子工程，构建生成自定义算子包。</span><p></p><div class="p">在算子工程AddCustom目录下执行如下命令，进行算子工程编译。<div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>./build.sh</li></ol></pre></div></div> </div> <p>编译成功后，会在当前目录下创建build_out目录，在build_out/autogen目录下生成自定义算子交付件。</p> <p></p></li><li><span>自定义算子安装包部署。</span><p></p><p>在执行编译的同时，会将交付件安装到DDK安装目录${DDK_INSTALL_PATH}下的指定目录。</p> <div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_">$</span><span class="language-bash">{DDK_INSTALL_PATH}/tools/platform</span></li></ol></pre></div></div> <p>查看部署后的目录结构，如下所示：</p> <div _ngcontent-dvu-c106="" class="highlight-div"><div _ngcontent-dvu-c106="" class="highlight-div-header"><div _ngcontent-dvu-c106="" class="highlight-div-header-left"><div _ngcontent-dvu-c106="" class="handle-button expand-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dvu-c106="" class="highlight-div-header-right"><div _ngcontent-dvu-c106="" class="handle-button ai-button"></div><div _ngcontent-dvu-c106="" class="handle-button line-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dvu-c106="" class="handle-button theme-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dvu-c106="" class="handle-button copy-button"><div _ngcontent-dvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dvu-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>platform                            // 平台插件目录</li><li>├── kirin9020                       // Kirin AI处理器类型</li><li>│   ├── config</li><li>│   │   └── npu_custom_opinfo.json  // 算子信息库</li><li>│   ├── lib64</li><li>│   │   └── libcustom_op.so         // host侧二进制文件</li><li>│   ├── ops</li><li>│   │   └── impl</li><li>│   │       ├── custom              // kernel交付件</li><li>│   │       │   ├── add_custom.cpp</li><li>│   │       │   ├── add_custom.py</li><li>│   │       │   └── op_proto.h</li><li>│   │       └── impl</li><li>│   └── simulator</li><li>└── README.md</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>