<h1 _ngcontent-isj-c119="" class="doc-title ng-star-inserted" title="快速实现上传下载"> 快速实现上传下载 </h1>

<div _ngcontent-isj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Remote Communication Kit 结合 Core File Kit 可以实现基于文件、目录、对象的快速上传和下载功能。 Remote Communication Kit 提供了远程通信的功能，包括远程连接、数据传输等 API 接口。而 Core File Kit 则提供了文件管理的功能，包括文件读取、写入等 API 接口。结合起来使用，可以通过 Remote Communication Kit 实现文件、目录、对象的远程传输，并且由于 Core File Kit 的高效文件处理能力，可以实现快速的上传和下载功能。</p> <div class="tiledSection"><h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2><p>文件上传下载能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p> </div> <div class="tiledSection"><h2 id="section6242316201311">下载功能实现<i class="anchor-icon anchor-icon-link" anchorid="section6242316201311" tips="复制节点链接"></i></h2><ol><li><span>导入需要的模块，示例中除去发起请求以及响应错误处理，还需用到CoreFileKit中的fileIo，所以需导入以下模块。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>定义下载路径，并创建相关配置。如还需访问应用文件，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file" target="_blank">应用文件</a>。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//下载文件保存的文件夹路径，仅为示例，请按需求进行替换。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOWNLOAD_TO_PATH</span> = <span class="hljs-string">`/data/storage/el2/base/haps/entry/files`</span>;</li><li><span class="hljs-comment">// 创建了一个安全配置对象，其中remoteValidation设置为'skip'，表示将跳过远程验证。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">securityConfig</span>: rcp.<span class="hljs-property">SecurityConfiguration</span> = {</li><li>  <span class="hljs-attr">remoteValidation</span>: <span class="hljs-string">'skip'</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建了一个下载配置对象，其中kind设置为'folder'，表示下载的目标是文件夹，path设置为之前定义的DOWNLOAD_TO_PATH。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">downloadToFile</span>: rcp.<span class="hljs-property">DownloadToFile</span> = {</li><li>  <span class="hljs-attr">kind</span>: <span class="hljs-string">'folder'</span>,</li><li>  <span class="hljs-attr">path</span>: <span class="hljs-variable constant_">DOWNLOAD_TO_PATH</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建一个HTTP会话，其中请求配置包括传输超时设置和安全配置（配置可自定义）</span></li><li><span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>({</li><li>  <span class="hljs-attr">requestConfiguration</span>: {</li><li>    <span class="hljs-attr">transfer</span>: { <span class="hljs-attr">timeout</span>: { <span class="hljs-attr">connectMs</span>: <span class="hljs-number">6000</span>, <span class="hljs-attr">transferMs</span>: <span class="hljs-number">6000</span>, <span class="hljs-attr">inactivityMs</span>: <span class="hljs-number">6000</span> } },</li><li>    <span class="hljs-attr">security</span>: securityConfig</li><li>  }</li><li>})</li></ol></pre></div></div> <p></p></li><li><span>检查目标路径是否存在，如果存在，则先删除该路径，以确保下载的文件不会覆盖已存在的文件；最后发起请求，使用创建的会话执行下载操作，将https://example.com.png这个URL的内容下载到指定的本地路径。如果下载成功，会输出成功信息；如果失败，会输出错误信息。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 检查目标路径是否存在</span></li><li><span class="hljs-keyword">if</span> (fileIo.<span class="hljs-title function_">accessSync</span>(<span class="hljs-variable constant_">DOWNLOAD_TO_PATH</span>)) {</li><li>  fileIo.<span class="hljs-title function_">rmdirSync</span>(<span class="hljs-variable constant_">DOWNLOAD_TO_PATH</span>);</li><li>}</li><li><span class="hljs-comment">// 发起请求，执行下载操作，这里的https://example.com.png网址为示例图片网址，模拟下载图片场景</span></li><li>session.<span class="hljs-title function_">downloadToFile</span>(<span class="hljs-string">'https://example.com.png'</span>, downloadToFile)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: rcp.Response</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Successfully received the response, statusCode: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(response.statusCode)}</span>`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed, the error message is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>)</li><li>})</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section10114164401311">上传功能实现<i class="anchor-icon anchor-icon-link" anchorid="section10114164401311" tips="复制节点链接"></i></h2><ol><li><span>导入需要的模块，示例中除去发起请求以及响应错误处理，还需用到CoreFileKit中的fileIo，需导入以下模块。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>定义Session配置，定义一个名为SESSION_CONFIG的对象，用于配置请求会话。配置包括传输超时和安全设置，如远程验证和TLS版本。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">SESSION_CONFIG</span>: rcp.<span class="hljs-property">SessionConfiguration</span> = {</li><li>  <span class="hljs-attr">requestConfiguration</span>: {</li><li>    <span class="hljs-attr">transfer</span>: {</li><li>      <span class="hljs-attr">timeout</span>: {</li><li>        <span class="hljs-attr">connectMs</span>: <span class="hljs-number">6000</span></li><li>      }</li><li>    },</li><li>    <span class="hljs-attr">security</span>: {</li><li>      <span class="hljs-attr">remoteValidation</span>: <span class="hljs-string">'skip'</span>,</li><li>      <span class="hljs-attr">tlsOptions</span>: {</li><li>        <span class="hljs-attr">tlsVersion</span>: <span class="hljs-string">'TlsV1.3'</span></li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>定义FdReadFile类，用于读取文件描述符（File Descriptor）指向的文件。read方法异步读取指定的ArrayBuffer缓冲区，并返回实际读取的字节数。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FdReadFile</span> {</li><li>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fd: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span> = fd;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">read</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> fileIo.<span class="hljs-title function_">read</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span>, buffer);</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>创建会话并打开文件，以只读模式打开一个文件。fileIo.openSync方法返回一个文件描述符，如果打开失败，程序会打印错误信息并返回。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>(<span class="hljs-variable constant_">SESSION_CONFIG</span>);</li><li><span class="hljs-keyword">const</span> file = fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-string">'/data/storage/el1/bundle/entry_test/resources/resfile/upload_file.txt'</span>,</li><li>  fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li><span class="hljs-keyword">if</span> (!file) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fileIo.openSync failed'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>读取文件，创建一个FdReadFile实例，并分配一个缓冲区来读取文件。read方法异步执行，等待文件读取完成。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> fdReadFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FdReadFile</span>(file.<span class="hljs-property">fd</span>);</li><li><span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>); <span class="hljs-comment">// 假设文件大小为1MB</span></li><li><span class="hljs-keyword">await</span> fdReadFile.<span class="hljs-title function_">read</span>(buffer);</li></ol></pre></div></div> <p></p></li><li><span>上传文件，使用会话的uploadFromFile方法将文件上传到指定的URL。UploadFromFile构造函数接受一个文件描述符读取文件。上传成功或失败时，会分别打印相应的信息。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> session.<span class="hljs-title function_">uploadFromFile</span>(<span class="hljs-string">'https://httpbin.org/anything'</span>, <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">UploadFromFile</span>(fdReadFile))</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: rcp.Response</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Upload succeeded: <span class="hljs-subst">${response}</span>`</span>)</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Upload failed: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>)</li><li>  });</li></ol></pre></div></div> <p></p></li><li><span>关闭文件和会话，释放资源。</span><p></p><div _ngcontent-isj-c106="" class="highlight-div"><div _ngcontent-isj-c106="" class="highlight-div-header"><div _ngcontent-isj-c106="" class="highlight-div-header-left"><div _ngcontent-isj-c106="" class="handle-button expand-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-isj-c106="" class="highlight-div-header-right"><div _ngcontent-isj-c106="" class="handle-button ai-button"></div><div _ngcontent-isj-c106="" class="handle-button line-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-isj-c106="" class="handle-button theme-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-isj-c106="" class="handle-button copy-button"><div _ngcontent-isj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-isj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>fileIo.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>session.<span class="hljs-title function_">close</span>();</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>