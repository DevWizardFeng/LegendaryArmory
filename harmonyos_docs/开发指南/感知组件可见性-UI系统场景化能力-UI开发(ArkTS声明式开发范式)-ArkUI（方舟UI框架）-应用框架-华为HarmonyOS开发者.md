<h1 _ngcontent-mym-c119="" class="doc-title ng-star-inserted" title="感知组件可见性"> 感知组件可见性 </h1>

<div _ngcontent-mym-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>组件可见性是指组件在屏幕上的显示状态，通过感知可见性，应用能够实现以下典型场景：</p>     <ul>      <li>组件曝光统计与分析（例如，统计广告组件在屏幕上的显示时长）；</li>      <li>资源按需加载与释放（例如，组件不可见时，释放组件使用的图片、视频等资源）；</li>      <li>感知复杂视图切换（例如，在多层视图嵌套情况下，依据组件的显示状态，处理相关逻辑）。</li>     </ul>     <p>针对上述场景，建议按照以下策略进行选择：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.1" valign="top" width="33.33333333333333%">场景描述</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.2" valign="top" width="33.33333333333333%">推荐接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/arkts-manage-components-visibility#组件曝光统计与分析">组件曝光统计与分析</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">onVisibleAreaApproximateChange</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">要监控的组件数量多，需要低频计算降低开销。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/arkts-manage-components-visibility#资源按需加载与释放">资源按需加载与释放</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">onVisibleAreaChange</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">要监控的组件数量少，希望每帧检测确保状态及时更新。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/arkts-manage-components-visibility#感知复杂视图切换">感知复杂视图切换</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">nodeRenderState监听</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">适合感知页面或页切换导致的可见性变化。</td>        </tr>             </tbody></table></div>     </div>     <p>应用也可自行遍历计算组件可见性，但由于组件存在复杂的层次关系，自行计算涉及大量运算，通常不被推荐。</p>    </div>    <div class="tiledSection">     <h2 id="组件曝光统计与分析">组件曝光统计与分析<i class="anchor-icon anchor-icon-link" anchorid="组件曝光统计与分析" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-component-visible-area-change-event#onvisibleareaapproximatechange17" target="_blank">onVisibleAreaApproximateChange</a>监控关键组件（如广告、商品卡片）的曝光时长，用于用户行为分析和运营统计。</p>     <p>该接口比onVisibleAreaChange性能更优，支持通过设置计算周期减少检测频率，适用于组件数量多、层级深的场景，可显著降低性能消耗。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>该能力从API version 17开始支持。</p>      </div></div></div>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IDataSource</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">list</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">DataChangeListener</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">list: <span class="hljs-built_in">number</span>[]</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = list;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getData</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[index];</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener) &lt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(listener);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unregisterDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> pos = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener);</li><li>    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataDelete</span>(index);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyDataAdd</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataAdd</span>(index);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">deleteItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(index);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">insertItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, data);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataAdd</span>(index);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExposureTrackingData</span> {</li><li>  <span class="hljs-comment">// 使用一个map记录当前正在展示的广告位，以及它开始被展示的时间戳，以便在它不可见时可以计算在屏幕上的展示时长</span></li><li>  <span class="hljs-keyword">private</span> visibleAdvertisingInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();</li><li>  <span class="hljs-comment">// 使用一个map记录每个广告位的展示总时长</span></li><li>  <span class="hljs-keyword">private</span> exposureData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyAdvertisingSlotIsAppearing</span>(<span class="hljs-attr">slot</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 广告位开始展示，记录起始时间戳</span></li><li>    <span class="hljs-keyword">let</span> startTimestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleAdvertisingInfos</span>.<span class="hljs-title function_">set</span>(slot, startTimestamp)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyAdvertisingSlotIsDisappearing</span>(<span class="hljs-attr">slot</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 广告位开始消失，计算本次展示时长，并累加到总时长数据中</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">endTimestamp</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()</li><li>    <span class="hljs-keyword">let</span> advertisingInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleAdvertisingInfos</span>.<span class="hljs-title function_">get</span>(slot)</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></li><li>    <span class="hljs-keyword">if</span> (advertisingInfo) {</li><li>      duration = endTimestamp - advertisingInfo.<span class="hljs-title function_">valueOf</span>()</li><li>    }</li><li>    <span class="hljs-comment">// 刷新展示总时长</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateExposureData</span>(slot, duration)</li><li>    <span class="hljs-comment">// 从当前可见的map中删除这个广告位信息</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleAdvertisingInfos</span>.<span class="hljs-title function_">delete</span>(slot)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyPageHiding</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 页面正在退出，上报统计数据</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportData</span>()</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateExposureData</span>(<span class="hljs-params">slot: <span class="hljs-built_in">string</span>, duration: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (duration &lt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">let</span> oldDuration = <span class="hljs-number">0</span></li><li>    <span class="hljs-keyword">let</span> dataItem = <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">get</span>(slot)</li><li>    <span class="hljs-keyword">if</span> (dataItem) {</li><li>      oldDuration = dataItem.<span class="hljs-title function_">valueOf</span>()</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">set</span>(slot, oldDuration + duration)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">consumeAllCurrentVisibleSlots</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleAdvertisingInfos</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span>, key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyAdvertisingSlotIsDisappearing</span>(key)</li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleAdvertisingInfos</span>.<span class="hljs-title function_">clear</span>()</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">reportData</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 上报之前先将当前正在展示的广告位统计信息刷新到总时长</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">consumeAllCurrentVisibleSlots</span>()</li><li>    <span class="hljs-comment">// 发送数据到分析平台</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`曝光数据上报: `</span> + <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>))</li><li>    <span class="hljs-comment">// 上报后清空</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">clear</span>()</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">ExposureTrackingPage</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ListDataSource</span> =</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListDataSource</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>]);</li><li>  <span class="hljs-keyword">private</span> exposureData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExposureTrackingData</span>()</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 在页面退出时，上报统计数据到分析平台</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">notifyPageHiding</span>()</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAdvertisingSlotInfo</span>(item))</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>              .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateItemBackgroundColor</span>(item))</li><li>          }</li><li>          <span class="hljs-comment">// 为每一个列表条目都增加一个可见性监听回调，给定阈值0.5，即如果广告位在屏幕上显示超过自身一半，就认为已经曝光；</span></li><li>          <span class="hljs-comment">// 尽管这里代码只写了一行，但实际会为每个显示出来的列表项都绑定一个回调，因此这里我们使用可控制计算频率的回调接口。</span></li><li>          .<span class="hljs-title function_">onVisibleAreaApproximateChange</span>({ <span class="hljs-attr">ratios</span>: [<span class="hljs-number">0.5</span>], <span class="hljs-attr">expectedUpdateInterval</span>: <span class="hljs-number">500</span> },</li><li>            <span class="hljs-function">(<span class="hljs-params">isExpanding: <span class="hljs-built_in">boolean</span>, currentRatio: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleExposureTracking</span>(item, isExpanding, currentRatio)</li><li>            })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">listDirection</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Vertical</span>)</li><li>      .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>      .<span class="hljs-title function_">edgeEffect</span>(<span class="hljs-title class_">EdgeEffect</span>.<span class="hljs-property">Spring</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xDCDCDC</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">5</span> })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isAdvertisingSlot</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-comment">// 假设每隔5个组件就是一个广告位</span></li><li>    <span class="hljs-keyword">return</span> (index % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculateAdvertisingSlot</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isAdvertisingSlot</span>(index)) {</li><li>      <span class="hljs-keyword">return</span> (index / <span class="hljs-number">5</span>)</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculateItemBackgroundColor</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Color</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isAdvertisingSlot</span>(index)) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Green</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getAdvertisingSlotInfo</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> advertisingSlot = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateAdvertisingSlot</span>(index)</li><li>    <span class="hljs-keyword">if</span> (advertisingSlot) {</li><li>      <span class="hljs-keyword">return</span> advertisingSlot + <span class="hljs-string">" 号广告位"</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'普通内容 '</span> + index</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleExposureTracking</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">isExpanding</span>: <span class="hljs-built_in">boolean</span>, <span class="hljs-attr">currentRatio</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isAdvertisingSlot</span>(index)) {</li><li>      <span class="hljs-comment">// 不处理非广告位</span></li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">let</span> slot = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAdvertisingSlotInfo</span>(index)</li><li>    <span class="hljs-keyword">if</span> (isExpanding) {</li><li>      <span class="hljs-comment">// 可见比例正在增大，说明组件正在出现</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">notifyAdvertisingSlotIsAppearing</span>(slot)</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-comment">// 可见比例正在减小，说明组件正在消失</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposureData</span>.<span class="hljs-title function_">notifyAdvertisingSlotIsDisappearing</span>(slot)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="资源按需加载与释放">资源按需加载与释放<i class="anchor-icon anchor-icon-link" anchorid="资源按需加载与释放" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-component-visible-area-change-event#onvisibleareachange" target="_blank">onVisibleAreaChange</a>监听组件可见面积占比的精细变化，当可见比例接近预设阈值时触发回调，根据可见比例的变化加载或释放资源。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>该能力从API version 9开始支持。</p>       <ul>        <li>可见面积以父组件边界为限，超出父组件的部分不会被计入可见面积比值计算;</li>        <li>由于存在浮点数比较，系统会在计算结果接近所设置的阈值时触发回调；</li>        <li>为确保可见性变化通知的及时性，系统在每帧进行计算可见比例的变化检测，为了减小系统负载，应尽可能少的使用这个接口。</li>       </ul>      </div></div></div>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IDataSource</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">list</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">DataChangeListener</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">list: <span class="hljs-built_in">number</span>[]</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = list;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getData</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>[index];</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener) &lt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(listener);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unregisterDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> pos = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener);</li><li>    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyDataDelete</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataDelete</span>(index);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">notifyDataAdd</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {</li><li>      listener.<span class="hljs-title function_">onDataAdd</span>(index);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">deleteItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataDelete</span>(index);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">insertItem</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, data);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataAdd</span>(index);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">headerImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ListDataSource</span> =</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListDataSource</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>]);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">headerImage</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>            <span class="hljs-comment">// 整个页面上只有这一个组件需要监听可见性，并且需要及时感知状态进行资源的及时加载</span></li><li>            .<span class="hljs-title function_">onVisibleAreaChange</span>([<span class="hljs-number">0.1</span>], <span class="hljs-function">(<span class="hljs-params">isExpanding: <span class="hljs-built_in">boolean</span>, currentRatio: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadOrReleaseHeaderImage</span>(isExpanding)</li><li>            })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">''</span> + item)</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>              .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Grey</span>)</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">listDirection</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Vertical</span>)</li><li>      .<span class="hljs-title function_">scrollBar</span>(<span class="hljs-title class_">BarState</span>.<span class="hljs-property">Off</span>)</li><li>      .<span class="hljs-title function_">edgeEffect</span>(<span class="hljs-title class_">EdgeEffect</span>.<span class="hljs-property">Spring</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xDCDCDC</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">5</span> })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">loadOrReleaseHeaderImage</span>(<span class="hljs-attr">isExpanding</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!isExpanding) {</li><li>      <span class="hljs-comment">// 马上就不可见了，释放掉图片</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">headerImage</span> = <span class="hljs-literal">null</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'图片释放完成'</span>)</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getMediaContent</span>($r(<span class="hljs-string">'app.media.startIcon'</span>).<span class="hljs-property">id</span>,</li><li>        <span class="hljs-function">(<span class="hljs-params">error, value: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">opts</span>: image.<span class="hljs-property">InitializationOptions</span> = {</li><li>            <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-attr">pixelFormat</span>: <span class="hljs-number">3</span>,</li><li>            <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">6</span> }</li><li>          };</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">uint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(value);</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = uint8Array.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);</li><li>
</li><li>          image.<span class="hljs-title function_">createPixelMap</span>(buffer, opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pixelMap</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">headerImage</span> = pixelMap</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'图片加载完成'</span>)</li><li>          })</li><li>        });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`callback getMediaContent failed, error code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>.`</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="感知复杂视图切换">感知复杂视图切换<i class="anchor-icon anchor-icon-link" anchorid="感知复杂视图切换" tips="复制节点链接"></i></h2>          <p>通过UIObserver提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onnoderenderstate20" target="_blank">on('nodeRenderState')</a>方法，可以监听指定组件的渲染状态。此接口需要传入一个组件标识，以指定需要观察的组件，因此不适用于组件频繁创建和销毁的场景，适用于因页面变化导致的组件显隐变化，例如页面跳转、组件所在页面被压栈，如Swiper/Tabs组件当前显示页被划出的场景。</p>     <p>渲染状态有两种：</p>     <ul>      <li>ABOUT_TO_RENDER_IN：组件已挂载到渲染树，下一帧将被渲染；</li>      <li>ABOUT_TO_RENDER_OUT：组件已从渲染树移除，下一帧不再渲染。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>该能力从API version 20开始支持。</p>      </div></div></div>     <p>需要注意的是，ABOUT_TO_RENDER_IN仅表示组件进入渲染流程，下一帧将由系统送显到屏幕上，但组件可能因被其他组件遮挡而无法被看到，因此渲染状态并不完全等同于可见性。</p>     <p>以下示例将一个被观测的Column组件置于Tabs、Navigation和Swiper的嵌套布局中，无论切换Tab页、页面跳转或Swiper页，均能准确感知组件是否显示于屏幕上。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>鉴于on('nodeRenderState')接口的特点，不建议将其用于列表项这种划出屏幕区域外节点就会被回收下树的场景。</p>      </div></div></div>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeRenderState</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">childNavStack</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">tabController</span>: <span class="hljs-title class_">TabsController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TabsController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Tabs</span>({ <span class="hljs-attr">barPosition</span>: <span class="hljs-title class_">BarPosition</span>.<span class="hljs-property">End</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabController</span> }) {</li><li>      <span class="hljs-title class_">TabContent</span>() {</li><li>        <span class="hljs-title class_">Navigation</span>() {</li><li>          <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Center</span> }) {</li><li>            <span class="hljs-title class_">Swiper</span>() {</li><li>              <span class="hljs-comment">// swiper 第一页为一个子navigation</span></li><li>              <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">childNavStack</span>) {</li><li>                <span class="hljs-title class_">Column</span>() {</li><li>                  <span class="hljs-title class_">Text</span>(<span class="hljs-string">'被监听的组件'</span>)</li><li>                    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">26</span>)</li><li>                    .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>                    .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>                }</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>                .<span class="hljs-title function_">id</span>(<span class="hljs-string">'component_to_be_monitor'</span>)</li><li>                .<span class="hljs-title function_">onAttach</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-comment">// 10ms后再注册监听回调，避免挂载还未完全完成</span></li><li>                  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{</li><li>                    <span class="hljs-comment">// 在被监听的组件挂载的时候开启对该组件的状态监听</span></li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()</li><li>                      .<span class="hljs-title function_">getUIObserver</span>()</li><li>                      .<span class="hljs-title function_">on</span>(<span class="hljs-string">'nodeRenderState'</span>, <span class="hljs-string">'component_to_be_monitor'</span>, <span class="hljs-function">(<span class="hljs-params">state: NodeRenderState, node?: FrameNode</span>) =&gt;</span> {</li><li>                        <span class="hljs-keyword">if</span> (state == <span class="hljs-title class_">NodeRenderState</span>.<span class="hljs-property">ABOUT_TO_RENDER_IN</span>) {</li><li>                          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'组件将显示'</span>)</li><li>                        } <span class="hljs-keyword">else</span> {</li><li>                          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'组件将消失'</span>)</li><li>                        }</li><li>                      })</li><li>                  }, <span class="hljs-number">10</span>)</li><li>                })</li><li>                .<span class="hljs-title function_">onDetach</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-comment">// 在被监听的组件从组件树上下树时取消监听</span></li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">off</span>(<span class="hljs-string">'nodeRenderState'</span>, <span class="hljs-string">'component_to_be_monitor'</span>)</li><li>                })</li><li>
</li><li>                <span class="hljs-title class_">Button</span>(<span class="hljs-string">'跳转下一页'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>                  .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>                  .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>                  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                    <span class="hljs-keyword">let</span> parentStack = <span class="hljs-variable language_">this</span>.<span class="hljs-property">childNavStack</span>.<span class="hljs-title function_">getParent</span>();</li><li>                    parentStack?.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"pageTwo"</span> });</li><li>                  })</li><li>              }</li><li>              .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>              .<span class="hljs-title function_">title</span>(<span class="hljs-string">'ChildNavigation'</span>)</li><li>
</li><li>              <span class="hljs-comment">// swiper 第二页</span></li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">'swiper 第二页'</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)</li><li>                .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>              <span class="hljs-comment">// swiper 第三页</span></li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">'swiper 第三页'</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)</li><li>                .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>            }</li><li>            .<span class="hljs-title function_">itemSpace</span>(<span class="hljs-number">10</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Green</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">title</span>(<span class="hljs-string">'ParentNavigation'</span>)</li><li>      }.<span class="hljs-title function_">tabBar</span>(<span class="hljs-string">'首页'</span>)</li><li>
</li><li>      <span class="hljs-title class_">TabContent</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'推荐'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)</li><li>          .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }.<span class="hljs-title function_">tabBar</span>(<span class="hljs-string">'推荐'</span>)</li><li>
</li><li>      <span class="hljs-title class_">TabContent</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'我的'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>)</li><li>          .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }.<span class="hljs-title function_">tabBar</span>(<span class="hljs-string">'我的'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PageTwo.ets</span></li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PageTwoBuilder</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-title class_">NavDestination</span>() {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">"this is "</span> + name)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">title</span>(name)</li><li>}</li></ol></pre></div></div>     <p>在resources/base/profile中创建route_map.json文件，并添加以下配置信息。</p>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"routerMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pageTwo"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"pageSourceFile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/ets/pages/PageTwo.ets"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"buildFunction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"PageTwoBuilder"</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"this is pageTwo"</span></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>     <p>在module.json5配置文件的module标签中定义routerMap字段，指向路由表配置文件route_map.json。</p>     <div _ngcontent-mym-c106="" class="highlight-div"><div _ngcontent-mym-c106="" class="highlight-div-header"><div _ngcontent-mym-c106="" class="highlight-div-header-left"><div _ngcontent-mym-c106="" class="handle-button expand-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mym-c106="" class="highlight-div-header-right"><div _ngcontent-mym-c106="" class="handle-button ai-button"></div><div _ngcontent-mym-c106="" class="handle-button line-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mym-c106="" class="handle-button theme-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mym-c106="" class="handle-button copy-button"><div _ngcontent-mym-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mym-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"routerMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$profile:route_map"</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="常见问题">常见问题<i class="anchor-icon anchor-icon-link" anchorid="常见问题" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="可见性计算与实际视觉不符" class="firsth2">可见性计算与实际视觉不符<i class="anchor-icon anchor-icon-link" anchorid="可见性计算与实际视觉不符" tips="复制节点链接"></i></h3>          <p><strong>问题现象</strong></p>     <p>组件已进入屏幕但回调未触发，或可见比例与视觉感知不一致。</p>     <p><strong>解决措施</strong></p>     <ul>      <li>检查父组件是否设置clip属性，裁剪可能导致可见面积计算偏差。</li>      <li>考虑组件透明度影响，即使 opacity为0也会被计入可见面积。</li>      <li>结合nodeRenderState监听交叉验证。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="高频回调导致性能下降">高频回调导致性能下降<i class="anchor-icon anchor-icon-link" anchorid="高频回调导致性能下降" tips="复制节点链接"></i></h3>          <p><strong>问题现象</strong></p>     <p>滚动时界面卡顿，日志显示可见性回调频繁执行。</p>     <p><strong>解决措施</strong></p>     <ul>      <li>切换到onVisibleAreaApproximateChange并将expectedUpdateInterval设置为一个更大的值。</li>      <li>减少注册可见性回调的组件数量。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="renderstate监听数量超限">RenderState监听数量超限<i class="anchor-icon anchor-icon-link" anchorid="renderstate监听数量超限" tips="复制节点链接"></i></h3>          <p><strong>问题现象</strong></p>     <p>nodeRenderState监听失败，日志提示超出最大监听数量。</p>     <p><strong>解决措施</strong></p>     <ul>      <li>替换为使用局部监听接口onVisibleAreaApproximateChange。</li>      <li>替换为对显示范围较大的父容器组件进行监听。</li>      <li>及时移除不再需要的监听off方法。</li>     </ul>    </div>   </div>   <div></div></div>