<h1 _ngcontent-oaq-c119="" class="doc-title ng-star-inserted" title="托管网页中的媒体播放"> 托管网页中的媒体播放 </h1>

<div _ngcontent-oaq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>Web组件提供了应用接管网页中媒体播放的能力，用来支持应用增强网页的媒体播放，如画质增强等。</p>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>          <p>网页播放媒体时，存在以下问题：网页清晰度低、网页播放器播放控件功能有限、某些视频无法播放。</p>     <p>应用开发者可以使用该功能，通过自己或者第三方播放器接管网页媒体播放，从而改善播放体验。</p>    </div>    <div class="tiledSection">     <h2 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="arkweb内核播放媒体的框架" class="firsth2">ArkWeb内核播放媒体的框架<i class="anchor-icon anchor-icon-link" anchorid="arkweb内核播放媒体的框架" tips="复制节点链接"></i></h3>          <p>不开启该功能时，ArkWeb内核的播放架构如下所示：</p>     <p><span><img originheight="567" originwidth="466" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114730.31655151407496806416329989146400:50001231000000:2800:2CD698F7C6C32C10B64A94F2E1260601EB13F94DF91FC9E8372768B2B6956F54.png" width="466" height="567"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>上图中1表示ArkWeb内核创建WebMediaPlayer来播放网页中的媒体资源。</li>        <li>上图中2表示WebMediaPlayer使用系统解码器来渲染媒体数据。</li>       </ul>      </div></div></div>     <p>开启该功能后，ArkWeb内核的播放架构如下：</p>     <p><span><img originheight="567" originwidth="669" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114730.17338061020752485832274022586610:50001231000000:2800:DCA8116B7669699546E524BB67F0E155F84693F3495B54C9E43EBAAC144215B9.png" width="669" height="567"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>上图中1表示ArkWeb内核创建WebMediaPlayer来播放网页中的媒体资源。</li>        <li>上图中2表示WebMediaPlayer使用应用提供的本地播放器（NativeMediaPlayer）来渲染媒体数据。</li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="arkweb内核与应用的交互">ArkWeb内核与应用的交互<i class="anchor-icon anchor-icon-link" anchorid="arkweb内核与应用的交互" tips="复制节点链接"></i></h3>          <p><span><img originheight="812" originwidth="762" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114730.53126373829891336143438226498471:50001231000000:2800:7CC52B973633A475802428372D35FFF4901C4342B7C08C343592B6CE10A9A952.png" width="762" height="812"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>上图中1的详细说明见<a href="/consumer/cn/doc/harmonyos-guides/app-takeovers-web-media#开启接管网页媒体播放">开启接管网页媒体播放</a>。</li>        <li>上图中2的详细说明见<a href="/consumer/cn/doc/harmonyos-guides/app-takeovers-web-media#创建本地播放器nativemediaplayer">创建本地播放器</a>。</li>        <li>上图中3的详细说明见<a href="/consumer/cn/doc/harmonyos-guides/app-takeovers-web-media#绘制本地播放器组件">绘制本地播放器组件</a>。</li>        <li>上图中4的详细说明见<a href="/consumer/cn/doc/harmonyos-guides/app-takeovers-web-media#执行arkweb内核发送给本地播放器的播控指令">执行 ArkWeb 内核发送给本地播放器的播控指令</a>。</li>        <li>上图中5的详细说明见<a href="/consumer/cn/doc/harmonyos-guides/app-takeovers-web-media#将本地播放器的状态信息通知给arkweb内核">将本地播放器的状态信息通知给 ArkWeb 内核</a>。</li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="开启接管网页媒体播放" class="firsth2">开启接管网页媒体播放<i class="anchor-icon anchor-icon-link" anchorid="开启接管网页媒体播放" tips="复制节点链接"></i></h3>          <p>需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-attributes#enablenativemediaplayer12" target="_blank">enableNativeMediaPlayer</a>接口开启接管网页媒体播放的功能。</p>     <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">enableNativeMediaPlayer</span>({ <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">shouldOverlay</span>: <span class="hljs-literal">false</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="创建本地播放器nativemediaplayer">创建本地播放器(NativeMediaPlayer)<i class="anchor-icon anchor-icon-link" anchorid="创建本地播放器nativemediaplayer" tips="复制节点链接"></i></h3>          <p>该功能开启后，网页中有媒体需要播放时，ArkWeb内核会触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#oncreatenativemediaplayer12" target="_blank">onCreateNativeMediaPlayer</a>注册的回调函数。</p>     <p>应用则需要调用 onCreateNativeMediaPlayer 来注册一个创建本地播放器的回调函数。</p>     <p>该回调函数需要根据媒体信息来判断是否要创建一个本地播放器来接管当前的网页媒体资源。</p>     <ul>      <li>如果应用不接管当前的网页媒体资源， 需在回调函数里返回 null 。</li>      <li>如果应用接管当前的网页媒体资源， 需在回调函数里返回一个本地播放器实例。</li>     </ul>     <p>本地播放器需要实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-nativemediaplayerbridge" target="_blank">NativeMediaPlayerBridge</a>接口，以便ArkWeb内核对本地播放器进行播控操作。</p>     <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-comment">// 实现 webview.NativeMediaPlayerBridge 接口。</span></li><li><span class="hljs-comment">// ArkWeb 内核调用该类的方法来对 NativeMediaPlayer 进行播控。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span> <span class="hljs-keyword">implements</span> webview.<span class="hljs-property">NativeMediaPlayerBridge</span> {</li><li>  <span class="hljs-comment">// ... 实现 NativeMediaPlayerBridge 里的接口方法 ...</span></li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) {}</li><li>  <span class="hljs-title function_">updateRect</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span>, width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {}</li><li>  <span class="hljs-title function_">play</span>(<span class="hljs-params"></span>) {}</li><li>  <span class="hljs-title function_">pause</span>(<span class="hljs-params"></span>) {}</li><li>  <span class="hljs-title function_">seek</span>(<span class="hljs-params">targetTime: <span class="hljs-built_in">number</span></span>) {}</li><li>  <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {}</li><li>  <span class="hljs-title function_">setVolume</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {}</li><li>  <span class="hljs-title function_">setMuted</span>(<span class="hljs-params">muted: <span class="hljs-built_in">boolean</span></span>) {}</li><li>  <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">playbackRate: <span class="hljs-built_in">number</span></span>) {}</li><li>  <span class="hljs-title function_">enterFullscreen</span>(<span class="hljs-params"></span>) {}</li><li>  <span class="hljs-title function_">exitFullscreen</span>(<span class="hljs-params"></span>) {}</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">enableNativeMediaPlayer</span>({ <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">shouldOverlay</span>: <span class="hljs-literal">false</span> })</li><li>        .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onCreateNativeMediaPlayer</span>(<span class="hljs-function">(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// 判断需不需要接管当前的媒体。</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">shouldHandle</span>(mediaInfo)) {</li><li>              <span class="hljs-comment">// 本地播放器不接管该媒体。</span></li><li>              <span class="hljs-comment">// 返回 null 。ArkWeb 内核将用自己的播放器来播放该媒体。</span></li><li>              <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 接管当前的媒体。</span></li><li>            <span class="hljs-comment">// 返回一个本地播放器实例给 ArkWeb 内核。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">nativePlayer</span>: webview.<span class="hljs-property">NativeMediaPlayerBridge</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span>(handler, mediaInfo);</li><li>            <span class="hljs-keyword">return</span> nativePlayer;</li><li>          });</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// stub</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldHandle</span>(<span class="hljs-params">mediaInfo: webview.MediaInfo</span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="绘制本地播放器组件">绘制本地播放器组件<i class="anchor-icon anchor-icon-link" anchorid="绘制本地播放器组件" tips="复制节点链接"></i></h3>          <p>应用接管网页媒体后，应用需要将本地播放器组件及视频画面绘制到ArkWeb内核提供的Surface上。ArkWeb内核再将Surface与网页进行合成并显示。</p>     <p>该流程与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-same-layer">同层渲染</a>绘制一致。</p>     <ol>      <li>       <p>在应用启动阶段，应用应保存UIContext，以便后续的同层渲染绘制流程能够使用该UIContext。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxxAbility.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">let</span> mainWindow = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>      <span class="hljs-keyword">if</span> (mainWindow) {</li><li>        <span class="hljs-comment">// 保存UIContext， 在后续的同层渲染绘制中使用。</span></li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"UIContext"</span>, mainWindow.<span class="hljs-title function_">getUIContext</span>());</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to get the main window"</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ... 其他需要重写的方法 ...</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>应用使用ArkWeb内核创建的Surface进行同层渲染绘制。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">NodeRenderType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentParams</span> {}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">ComponentParams</span>]&gt; | <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">surfaceId: <span class="hljs-built_in">string</span>, renderType: NodeRenderType</span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>
</li><li>    <span class="hljs-comment">// 获取之前保存的 UIContext 。</span></li><li>    <span class="hljs-keyword">let</span> uiContext = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"UIContext"</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIContext</span>, { <span class="hljs-attr">surfaceId</span>: surfaceId, <span class="hljs-attr">type</span>: renderType });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">FrameNode</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 构造本地播放器组件</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  node_controller?: <span class="hljs-title class_">MyNodeController</span>;</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">show_native_media_player</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span> }) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">show_native_media_player</span>) {</li><li>          <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">node_controller</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">150</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)</li><li>            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span> })</li><li>        }</li><li>        <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">enableNativeMediaPlayer</span>({ <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">shouldOverlay</span>: <span class="hljs-literal">false</span> })</li><li>          .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onCreateNativeMediaPlayer</span>(<span class="hljs-function">(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 接管当前的媒体。</span></li><li>              <span class="hljs-comment">// 使用同层渲染流程提供的 surface 来构造一个本地播放器组件。</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_controller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(mediaInfo.<span class="hljs-property">surfaceInfo</span>.<span class="hljs-property">id</span>, <span class="hljs-title class_">NodeRenderType</span>.<span class="hljs-property">RENDER_TYPE_TEXTURE</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_controller</span>.<span class="hljs-title function_">build</span>();</li><li>
</li><li>              <span class="hljs-comment">// 展示本地播放器组件。</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">show_native_media_player</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>              <span class="hljs-comment">// 返回一个本地播放器实例给 ArkWeb 内核。</span></li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">nativePlayer</span>: webview.<span class="hljs-property">NativeMediaPlayerBridge</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span>(handler, mediaInfo);</li><li>              <span class="hljs-keyword">return</span> nativePlayer;</li><li>            });</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>     <p>动态创建组件并绘制到Surface上的详细介绍见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-same-layer">同层渲染</a>。</p>    </div>    <div class="tiledSection">     <h3 id="执行arkweb内核发送给本地播放器的播控指令">执行ArkWeb内核发送给本地播放器的播控指令<i class="anchor-icon anchor-icon-link" anchorid="执行arkweb内核发送给本地播放器的播控指令" tips="复制节点链接"></i></h3>          <p>为了方便ArkWeb内核对本地播放器进行播控操作，应用需要令本地播放器实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-nativemediaplayerbridge" target="_blank">NativeMediaPlayerBridge</a>接口，并根据每个接口方法的功能对本地播放器进行相应操作。</p>     <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ActualNativeMediaPlayerListener</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler</span>) {}</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span> <span class="hljs-keyword">implements</span> webview.<span class="hljs-property">NativeMediaPlayerBridge</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) {</li><li>    <span class="hljs-comment">// 1. 创建一个本地播放器的状态监听。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">listener</span>: <span class="hljs-title class_">ActualNativeMediaPlayerListener</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActualNativeMediaPlayerListener</span>(handler);</li><li>    <span class="hljs-comment">// 2. 创建一个本地播放器。</span></li><li>    <span class="hljs-comment">// 3. 监听该本地播放器。</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateRect</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span>, width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// &lt;video&gt; 标签的位置和大小发生了变化。</span></li><li>    <span class="hljs-comment">// 根据该信息变化，作出相应的改变。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">play</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 启动本地播放器播放。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">pause</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 暂停本地播放器播放。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">seek</span>(<span class="hljs-params">targetTime: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 本地播放器跳转到指定的时间点。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 销毁本地播放器。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setVolume</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// ArkWeb 内核要求调整本地播放器的音量。</span></li><li>    <span class="hljs-comment">// 设置本地播放器的音量。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setMuted</span>(<span class="hljs-params">muted: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-comment">// 将本地播放器静音或取消静音。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">playbackRate: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 调整本地播放器的播放速度。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">enterFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 将本地播放器设置为全屏播放。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">exitFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 将本地播放器退出全屏播放。</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="将本地播放器的状态信息通知给arkweb内核">将本地播放器的状态信息通知给ArkWeb内核<i class="anchor-icon anchor-icon-link" anchorid="将本地播放器的状态信息通知给arkweb内核" tips="复制节点链接"></i></h3>          <p>ArkWeb内核需要本地播放器的状态信息来更新到网页（例如：视频的宽高、播放时间、缓存时间等），因此，应用需要将本地播放器的状态信息通知给ArkWeb内核。</p>     <p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#oncreatenativemediaplayer12" target="_blank">onCreateNativeMediaPlayer</a>接口中， ArkWeb内核传递一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-nativemediaplayerhandler" target="_blank">NativeMediaPlayerHandler</a>对象给应用。应用需要通过该对象，将本地播放器的最新状态信息通知给ArkWeb内核。</p>     <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ActualNativeMediaPlayerListener</span> {</li><li>  <span class="hljs-attr">handler</span>: webview.<span class="hljs-property">NativeMediaPlayerHandler</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span> = handler;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPlaying</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器开始播放。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleStatusChanged</span>(webview.<span class="hljs-property">PlaybackStatus</span>.<span class="hljs-property">PLAYING</span>);</li><li>  }</li><li>  <span class="hljs-title function_">onPaused</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器暂停播放。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleStatusChanged</span>(webview.<span class="hljs-property">PlaybackStatus</span>.<span class="hljs-property">PAUSED</span>);</li><li>  }</li><li>  <span class="hljs-title function_">onSeeking</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器开始执行跳转到目标时间点。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleSeeking</span>();</li><li>  }</li><li>  <span class="hljs-title function_">onSeekDone</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器 seek 完成。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleSeekFinished</span>();</li><li>  }</li><li>  <span class="hljs-title function_">onEnded</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器播放完成。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleEnded</span>();</li><li>  }</li><li>  <span class="hljs-title function_">onVolumeChanged</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 获取本地播放器的音量。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">volume</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title function_">getVolume</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleVolumeChanged</span>(volume);</li><li>  }</li><li>  <span class="hljs-title function_">onCurrentPlayingTimeUpdate</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 更新播放时间。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">currentTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title function_">getCurrentPlayingTime</span>();</li><li>    <span class="hljs-comment">// 将时间单位换算成秒。</span></li><li>    <span class="hljs-keyword">let</span> currentTimeInSeconds = <span class="hljs-title function_">convertToSeconds</span>(currentTime);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleTimeUpdate</span>(currentTimeInSeconds);</li><li>  }</li><li>  <span class="hljs-title function_">onBufferedChanged</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 缓存发生了变化。</span></li><li>    <span class="hljs-comment">// 获取本地播放器的缓存时长。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">bufferedEndTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title function_">getCurrentBufferedTime</span>();</li><li>    <span class="hljs-comment">// 将时间单位换算成秒。</span></li><li>    <span class="hljs-keyword">let</span> bufferedEndTimeInSeconds = <span class="hljs-title function_">convertToSeconds</span>(bufferedEndTime);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleBufferedEndTimeChanged</span>(bufferedEndTimeInSeconds);</li><li>
</li><li>    <span class="hljs-comment">// 检查缓存状态。</span></li><li>    <span class="hljs-comment">// 如果缓存状态发生了变化，则向 ArkWeb 内核通知缓存状态。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">lastReadyState</span>: webview.<span class="hljs-property">ReadyState</span> = <span class="hljs-title function_">getLastReadyState</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">currentReadyState</span>: webview.<span class="hljs-property">ReadyState</span> = <span class="hljs-title function_">getCurrentReadyState</span>();</li><li>    <span class="hljs-keyword">if</span> (lastReadyState != currentReadyState) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleReadyStateChanged</span>(currentReadyState);</li><li>    }</li><li>  }</li><li>  <span class="hljs-title function_">onEnterFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器进入了全屏状态。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isFullscreen</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleFullscreenChanged</span>(isFullscreen);</li><li>  }</li><li>  <span class="hljs-title function_">onExitFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 本地播放器退出了全屏状态。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isFullscreen</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleFullscreenChanged</span>(isFullscreen);</li><li>  }</li><li>  <span class="hljs-title function_">onUpdateVideoSize</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 当本地播放器解析出视频宽高时， 通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleVideoSizeChanged</span>(width, height);</li><li>  }</li><li>  <span class="hljs-title function_">onDurationChanged</span>(<span class="hljs-params">duration: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 本地播放器解析到了新的媒体时长， 通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleDurationChanged</span>(duration);</li><li>  }</li><li>  <span class="hljs-title function_">onError</span>(<span class="hljs-params">error: webview.MediaError, errorMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// 本地播放器出错了，通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleError</span>(error, errorMessage);</li><li>  }</li><li>  <span class="hljs-title function_">onNetworkStateChanged</span>(<span class="hljs-params">state: webview.NetworkState</span>) {</li><li>    <span class="hljs-comment">// 本地播放器的网络状态发生了变化， 通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleNetworkStateChanged</span>(state);</li><li>  }</li><li>  <span class="hljs-title function_">onPlaybackRateChanged</span>(<span class="hljs-params">playbackRate: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 本地播放器的播放速率发生了变化， 通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handlePlaybackRateChanged</span>(playbackRate);</li><li>  }</li><li>  <span class="hljs-title function_">onMutedChanged</span>(<span class="hljs-params">muted: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-comment">// 本地播放器的静音状态发生了变化， 通知 ArkWeb 内核。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleMutedChanged</span>(muted);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ... 监听本地播放器其他的状态 ...</span></li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">show_native_media_player</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">enableNativeMediaPlayer</span>({<span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">shouldOverlay</span>: <span class="hljs-literal">false</span>})</li><li>        .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onCreateNativeMediaPlayer</span>(<span class="hljs-function">(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// 接管当前的媒体。</span></li><li>
</li><li>            <span class="hljs-comment">// 创建一个本地播放器实例。</span></li><li>            <span class="hljs-comment">// let nativePlayer: NativeMediaPlayerImpl = new NativeMediaPlayerImpl(handler, mediaInfo);</span></li><li>
</li><li>            <span class="hljs-comment">// 创建一个本地播放器状态监听对象。</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">nativeMediaPlayerListener</span>: <span class="hljs-title class_">ActualNativeMediaPlayerListener</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActualNativeMediaPlayerListener</span>(handler);</li><li>            <span class="hljs-comment">// 监听本地播放器状态。</span></li><li>            <span class="hljs-comment">// nativePlayer.setListener(nativeMediaPlayerListener);</span></li><li>
</li><li>            <span class="hljs-comment">// 返回这个本地播放器实例给 ArkWeb 内核。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>          });</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// stub</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getVolume</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentPlayingTime</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentBufferedTime</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">convertToSeconds</span>(<span class="hljs-params">input: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">return</span> input;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getLastReadyState</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> webview.<span class="hljs-property">ReadyState</span>.<span class="hljs-property">HAVE_NOTHING</span>;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentReadyState</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> webview.<span class="hljs-property">ReadyState</span>.<span class="hljs-property">HAVE_NOTHING</span>;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>涉及网页媒体播放，需在配置文件中配置网络访问权限。添加方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions#在配置文件中声明权限">在配置文件中声明权限</a>。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/module.json5</span></li><li><span class="hljs-string">"requestPermissions"</span>:[</li><li>    {</li><li>      <span class="hljs-string">"name"</span> : <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>    }</li><li>  ]</li></ol></pre></div></div></li>      <li>       <p>在应用启动阶段保存UIContext。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxxAbility.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err &amp;&amp; err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      </li><li>      <span class="hljs-keyword">let</span> mainWindow = windowStage.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>      <span class="hljs-keyword">if</span> (mainWindow) {</li><li>        <span class="hljs-comment">// 保存UIContext， 在后续的同层渲染绘制中使用。</span></li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"UIContext"</span>, mainWindow.<span class="hljs-title function_">getUIContext</span>());</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to get the main window"</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ... 其他需要重写的方法 ...</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>应用侧代码，视频托管使用示例。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avplayer">AVPlayer</a>托管Web媒体的播放。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">NodeRenderType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVPlayerDemo</span>, <span class="hljs-title class_">AVPlayerListener</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./PlayerDemo'</span>;</li><li>
</li><li><span class="hljs-comment">// 实现 webview.NativeMediaPlayerBridge 接口。</span></li><li><span class="hljs-comment">// ArkWeb 内核调用该类的方法来对 NativeMediaPlayer 进行播控。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span> <span class="hljs-keyword">implements</span> webview.<span class="hljs-property">NativeMediaPlayerBridge</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">mediaSource</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mediaHandler</span>: webview.<span class="hljs-property">NativeMediaPlayerHandler</span>;</li><li>  <span class="hljs-attr">nativePlayerInfo</span>: <span class="hljs-title class_">NativePlayerInfo</span>;</li><li>  <span class="hljs-attr">nativePlayer</span>: <span class="hljs-title class_">AVPlayerDemo</span>;</li><li>  <span class="hljs-attr">httpHeaders</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;</li><li>  uiContext?: <span class="hljs-title class_">UIContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">nativePlayerInfo: NativePlayerInfo, handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo, uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span> = uiContext;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.constructor, surface_id[<span class="hljs-subst">${mediaInfo.surfaceInfo.id}</span>]`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span> = nativePlayerInfo;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediaHandler</span> = handler;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = mediaInfo.<span class="hljs-property">surfaceInfo</span>.<span class="hljs-property">id</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediaSource</span> = mediaInfo.<span class="hljs-property">mediaSrcList</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">source</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'.mp4'</span>) &gt; <span class="hljs-number">0</span>)?.<span class="hljs-property">source</span></li><li>      || mediaInfo.<span class="hljs-property">mediaSrcList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">source</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpHeaders</span> = mediaInfo.<span class="hljs-property">headers</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayerDemo</span>();</li><li>
</li><li>    <span class="hljs-comment">// 使用同层渲染功能，将视频及其播控组件绘制到网页中</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">node_controller</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediaHandler</span>, <span class="hljs-variable language_">this</span>, <span class="hljs-title class_">NodeRenderType</span>.<span class="hljs-property">RENDER_TYPE_TEXTURE</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">node_controller</span>.<span class="hljs-title function_">build</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">show_native_media_player</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.mediaSource: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.mediaSource}</span>, headers: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">this</span>.httpHeaders)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateRect</span>(<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> width_in_vp = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>!.<span class="hljs-title function_">px2vp</span>(width);</li><li>    <span class="hljs-keyword">let</span> height_in_vp = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>!.<span class="hljs-title function_">px2vp</span>(height);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`updateRect(<span class="hljs-subst">${x}</span>, <span class="hljs-subst">${y}</span>, <span class="hljs-subst">${width}</span>, <span class="hljs-subst">${height}</span>), vp:{<span class="hljs-subst">${width_in_vp}</span>, <span class="hljs-subst">${height_in_vp}</span>}`</span>);</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-title function_">updateNativePlayerRect</span>(x, y, width, height);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">play</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMediaPlayerImpl.play'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">play</span>();</li><li>  }</li><li>  <span class="hljs-title function_">pause</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMediaPlayerImpl.pause'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">pause</span>();</li><li>  }</li><li>  <span class="hljs-title function_">seek</span>(<span class="hljs-params">targetTime: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.seek(<span class="hljs-subst">${targetTime}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">seek</span>(targetTime);</li><li>  }</li><li>  <span class="hljs-title function_">setVolume</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.setVolume(<span class="hljs-subst">${volume}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">setVolume</span>(volume);</li><li>  }</li><li>  <span class="hljs-title function_">setMuted</span>(<span class="hljs-params">muted: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.setMuted(<span class="hljs-subst">${muted}</span>)`</span>);</li><li>  }</li><li>  <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">playbackRate: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativeMediaPlayerImpl.setPlaybackRate(<span class="hljs-subst">${playbackRate}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">setPlaybackRate</span>(playbackRate);</li><li>  }</li><li>  <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMediaPlayerImpl.release'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayer</span>?.<span class="hljs-title function_">release</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">show_native_media_player</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">node_width</span> = <span class="hljs-number">300</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-property">node_height</span> = <span class="hljs-number">150</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nativePlayerInfo</span>.<span class="hljs-title function_">destroyed</span>();</li><li>  }</li><li>  <span class="hljs-title function_">enterFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMediaPlayerImpl.enterFullscreen'</span>);</li><li>  }</li><li>  <span class="hljs-title function_">exitFullscreen</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativeMediaPlayerImpl.exitFullscreen'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 监听NativeMediaPlayer的状态，然后通过 webview.NativeMediaPlayerHandler 将状态上报给 ArkWeb 内核。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayerListenerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AVPlayerListener</span> {</li><li>  <span class="hljs-attr">handler</span>: webview.<span class="hljs-property">NativeMediaPlayerHandler</span>;</li><li>  <span class="hljs-attr">component</span>: <span class="hljs-title class_">NativePlayerComponent</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, component: NativePlayerComponent</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span> = handler;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span> = component;</li><li>  }</li><li>  <span class="hljs-title function_">onPlaying</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayerListenerImpl.onPlaying'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleStatusChanged</span>(webview.<span class="hljs-property">PlaybackStatus</span>.<span class="hljs-property">PLAYING</span>);</li><li>  }</li><li>  <span class="hljs-title function_">onPaused</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayerListenerImpl.onPaused'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleStatusChanged</span>(webview.<span class="hljs-property">PlaybackStatus</span>.<span class="hljs-property">PAUSED</span>);</li><li>  }</li><li>  <span class="hljs-title function_">onDurationChanged</span>(<span class="hljs-params">duration: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayerListenerImpl.onDurationChanged(<span class="hljs-subst">${duration}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleDurationChanged</span>(duration);</li><li>  }</li><li>  <span class="hljs-title function_">onBufferedTimeChanged</span>(<span class="hljs-params">buffered: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayerListenerImpl.onBufferedTimeChanged(<span class="hljs-subst">${buffered}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleBufferedEndTimeChanged</span>(buffered);</li><li>  }</li><li>  <span class="hljs-title function_">onTimeUpdate</span>(<span class="hljs-params">time: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleTimeUpdate</span>(time);</li><li>  }</li><li>  <span class="hljs-title function_">onEnded</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayerListenerImpl.onEnded'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleEnded</span>();</li><li>  }</li><li>  <span class="hljs-title function_">onError</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayerListenerImpl.onError'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span>.<span class="hljs-property">has_error</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleError</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"Oops!"</span>);</li><li>    }, <span class="hljs-number">200</span>);</li><li>  }</li><li>  <span class="hljs-title function_">onVideoSizeChanged</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayerListenerImpl.onVideoSizeChanged(<span class="hljs-subst">${width}</span>, <span class="hljs-subst">${height}</span>)`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handler</span>.<span class="hljs-title function_">handleVideoSizeChanged</span>(width, height);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">component</span>.<span class="hljs-title function_">onSizeChanged</span>(width, height);</li><li>  }</li><li>  <span class="hljs-title function_">onDestroyed</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayerListenerImpl.onDestroyed'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentParams</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">text2</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">playerInfo</span>: <span class="hljs-title class_">NativePlayerInfo</span>;</li><li>  <span class="hljs-attr">handler</span>: webview.<span class="hljs-property">NativeMediaPlayerHandler</span>;</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">NativeMediaPlayerImpl</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义的播放器组件</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">NativePlayerComponent</span> {</li><li>  params?: <span class="hljs-title class_">ComponentParams</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">bgColor</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>;</li><li>  <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>
</li><li>  <span class="hljs-attr">videoController</span>: <span class="hljs-title class_">VideoController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoController</span>();</li><li>  <span class="hljs-attr">offset_x</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">offset_y</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">video_width_percent</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">video_height_percent</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>  <span class="hljs-attr">view_width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">view_height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">video_width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">video_height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-attr">fullscreen</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">has_error</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">onSizeChanged</span>(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">video_width</span> = width;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">video_height</span> = height;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">view_width</span> / width;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">scaled_video_height</span>: <span class="hljs-built_in">number</span> = scale * height;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">video_height_percent</span> = scaled_video_height / <span class="hljs-variable language_">this</span>.<span class="hljs-property">view_height</span> * <span class="hljs-number">100</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerComponent.onSizeChanged(<span class="hljs-subst">${width}</span>,<span class="hljs-subst">${height}</span>), video_height_percent[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.video_height_percent }</span>]`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Stack</span>() {</li><li>        <span class="hljs-title class_">XComponent</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'video_player_id'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">video_width_percent</span> + <span class="hljs-string">'%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">video_height_percent</span> + <span class="hljs-string">'%'</span>)</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-function">()=&gt;</span>{</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'this.params is null'</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'NativePlayerComponent.onLoad, params['</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span></li><li>              + <span class="hljs-string">'], text['</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">text</span> + <span class="hljs-string">'], text2['</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">text2</span></li><li>              + <span class="hljs-string">'], web_tab['</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">playerInfo</span> + <span class="hljs-string">'], handler['</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">handler</span> + <span class="hljs-string">']'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">player</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">setSurfaceID</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>());</li><li>
</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">player</span>.<span class="hljs-property">nativePlayer</span>.<span class="hljs-title function_">avPlayerLiveDemo</span>({</li><li>              <span class="hljs-attr">url</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">player</span>.<span class="hljs-property">mediaSource</span>,</li><li>              <span class="hljs-attr">listener</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AVPlayerListenerImpl</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">handler</span>, <span class="hljs-variable language_">this</span>),</li><li>              <span class="hljs-attr">httpHeaders</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">player</span>.<span class="hljs-property">httpHeaders</span>,</li><li>            });</li><li>          })</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>?.<span class="hljs-property">text</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>              .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerComponent.Button[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.params?.text}</span>] is clicked`</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>?.<span class="hljs-property">player</span>.<span class="hljs-property">nativePlayer</span>?.<span class="hljs-title function_">play</span>();</li><li>              })</li><li>              .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>                event.<span class="hljs-title function_">stopPropagation</span>();</li><li>              })</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>?.<span class="hljs-property">text2</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>              .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerComponent.Button[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.params?.text2}</span>] is clicked`</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>?.<span class="hljs-property">player</span>.<span class="hljs-property">nativePlayer</span>?.<span class="hljs-title function_">pause</span>();</li><li>              })</li><li>              .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>                event.<span class="hljs-title function_">stopPropagation</span>();</li><li>              })</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceEvenly</span>)</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">has_error</span>) {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Error'</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#eb5555'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        }</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">onAreaChange</span>(<span class="hljs-function">(<span class="hljs-params">oldValue: Area, newValue: Area</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerComponent.onAreaChange(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(oldValue)}</span>, <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(newValue)}</span>)`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">view_width</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(newValue.<span class="hljs-property">width</span>).<span class="hljs-title function_">valueOf</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">view_height</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(newValue.<span class="hljs-property">height</span>).<span class="hljs-title function_">valueOf</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onSizeChanged</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">video_width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">video_height</span>);</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">NativePlayerComponentBuilder</span>(<span class="hljs-params">params: ComponentParams</span>) {</li><li>  <span class="hljs-title class_">NativePlayerComponent</span>({ <span class="hljs-attr">params</span>: params })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Green</span>)</li><li>    .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Brown</span> })</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>}</li><li>
</li><li><span class="hljs-comment">// 通过 NodeController 动态创建自定义的播放器组件， 并将组件内容绘制到 surface 上。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">ComponentParams</span>]&gt; | <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">playerInfo</span>: <span class="hljs-title class_">NativePlayerInfo</span>;</li><li>  <span class="hljs-attr">listener</span>: webview.<span class="hljs-property">NativeMediaPlayerHandler</span>;</li><li>  <span class="hljs-attr">player</span>: <span class="hljs-title class_">NativeMediaPlayerImpl</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">playerInfo: NativePlayerInfo,</span></li><li><span class="hljs-params">              surfaceId: <span class="hljs-built_in">string</span>,</span></li><li><span class="hljs-params">              listener: webview.NativeMediaPlayerHandler,</span></li><li><span class="hljs-params">              player: NativeMediaPlayerImpl,</span></li><li><span class="hljs-params">              renderType: NodeRenderType</span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span> = playerInfo;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span> = listener;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = player;</li><li>    <span class="hljs-keyword">let</span> uiContext = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">UIContext</span>&gt;(<span class="hljs-string">"UIContext"</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIContext</span>, { <span class="hljs-attr">surfaceId</span>: surfaceId, <span class="hljs-attr">type</span>: renderType });</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`MyNodeController, rootNode[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.rootNode}</span>], playerInfo[<span class="hljs-subst">${playerInfo}</span>], listener[<span class="hljs-subst">${listener}</span>], surfaceId[<span class="hljs-subst">${surfaceId}</span>]`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">FrameNode</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">ComponentParams</span> = {</li><li>      <span class="hljs-string">"text"</span>: <span class="hljs-string">"play"</span>,</li><li>      <span class="hljs-string">"text2"</span>: <span class="hljs-string">"pause"</span>,</li><li>      <span class="hljs-attr">playerInfo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>,</li><li>      <span class="hljs-attr">handler</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span>,</li><li>      <span class="hljs-attr">player</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span></li><li>    };</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">NativePlayerComponentBuilder</span>), params);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">postTouchEvent</span>(<span class="hljs-params">event: TouchEvent</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>?.<span class="hljs-title function_">postTouchEvent</span>(event);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rect</span> {</li><li>  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">toNodeRect</span>(<span class="hljs-attr">rectInPx</span>: webview.<span class="hljs-property">RectEvent</span>, <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>) : <span class="hljs-title class_">Rect</span> {</li><li>    <span class="hljs-keyword">let</span> rect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rect</span>();</li><li>    rect.<span class="hljs-property">x</span> = uiContext.<span class="hljs-title function_">px2vp</span>(rectInPx.<span class="hljs-property">x</span>);</li><li>    rect.<span class="hljs-property">y</span> = uiContext.<span class="hljs-title function_">px2vp</span>(rectInPx.<span class="hljs-property">y</span>);</li><li>    rect.<span class="hljs-property">width</span> = uiContext.<span class="hljs-title function_">px2vp</span>(rectInPx.<span class="hljs-property">width</span>);</li><li>    rect.<span class="hljs-property">height</span> = uiContext.<span class="hljs-title function_">px2vp</span>(rectInPx.<span class="hljs-property">height</span>);</li><li>    <span class="hljs-keyword">return</span> rect;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativePlayerInfo</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">web</span>: <span class="hljs-title class_">WebComponent</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">embed_id</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">player</span>: webview.<span class="hljs-property">NativeMediaPlayerBridge</span>;</li><li>  <span class="hljs-keyword">public</span> node_controller?: <span class="hljs-title class_">MyNodeController</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">show_native_media_player</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">node_pos_x</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">node_pos_y</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">node_width</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">node_height</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  playerComponent?: <span class="hljs-title class_">NativeMediaPlayerComponent</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">web: WebComponent, handler: webview.NativeMediaPlayerHandler, videoInfo: webview.MediaInfo, uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">web</span> = web;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">embed_id</span> = videoInfo.<span class="hljs-property">embedID</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> node_rect = <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">toNodeRect</span>(videoInfo.<span class="hljs-property">surfaceInfo</span>.<span class="hljs-property">rect</span>, uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_pos_x</span> = node_rect.<span class="hljs-property">x</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_pos_y</span> = node_rect.<span class="hljs-property">y</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_width</span> = node_rect.<span class="hljs-property">width</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node_height</span> = node_rect.<span class="hljs-property">height</span>;</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">player</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeMediaPlayerImpl</span>(<span class="hljs-variable language_">this</span>, handler, videoInfo, uiContext);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateNativePlayerRect</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span>, width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerComponent</span>?.<span class="hljs-title function_">updateNativePlayerRect</span>(x, y, width, height);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">destroyed</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> info_list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">web</span>.<span class="hljs-property">native_player_info_list</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerInfo[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.embed_id}</span>] destroyed, list.size[<span class="hljs-subst">${info_list.length}</span>]`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">web</span>.<span class="hljs-property">native_player_info_list</span> = info_list.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">embed_id</span> != <span class="hljs-variable language_">this</span>.<span class="hljs-property">embed_id</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NativePlayerInfo after destroyed, new_list.size[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.web.native_player_info_list.length}</span>]`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">NativeMediaPlayerComponent</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">playerInfo</span>: <span class="hljs-title class_">NativePlayerInfo</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">playerComponent</span> = <span class="hljs-variable language_">this</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_controller</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_width</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_height</span>)</li><li>      .<span class="hljs-title function_">offset</span>({<span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_pos_x</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_pos_y</span>})</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)</li><li>      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span> })</li><li>      .<span class="hljs-title function_">onAreaChange</span>(<span class="hljs-function">(<span class="hljs-params">oldValue, newValue</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`NodeContainer[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.playerInfo.embed_id}</span>].onAreaChange([<span class="hljs-subst">${oldValue.width}</span> x <span class="hljs-subst">${oldValue.height}</span>]-&gt;[<span class="hljs-subst">${newValue.width}</span> x <span class="hljs-subst">${newValue.height}</span>]`</span>);</li><li>      })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateNativePlayerRect</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span>, width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> node_rect = <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">toNodeRect</span>({x, y, width, height}, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_pos_x</span> = node_rect.<span class="hljs-property">x</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_pos_y</span> = node_rect.<span class="hljs-property">y</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_width</span> = node_rect.<span class="hljs-property">width</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerInfo</span>.<span class="hljs-property">node_height</span> = node_rect.<span class="hljs-property">height</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: <span class="hljs-title class_">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">page_url</span>: <span class="hljs-title class_">Resource</span> = $rawfile(<span class="hljs-string">'main.html'</span>);</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">native_player_info_list</span>: <span class="hljs-title class_">NativePlayerInfo</span>[] = [];</li><li>
</li><li>  area?: <span class="hljs-title class_">Area</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Stack</span>({<span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span>}) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">native_player_info_list</span>, <span class="hljs-function">(<span class="hljs-params">item: NativePlayerInfo</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">show_native_media_player</span>) {</li><li>            <span class="hljs-title class_">NativeMediaPlayerComponent</span>({ <span class="hljs-attr">playerInfo</span>: item })</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: NativePlayerInfo</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">return</span> item.<span class="hljs-property">embed_id</span>;</li><li>        })</li><li>        <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">page_url</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">enableNativeMediaPlayer</span>({ <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">shouldOverlay</span>: <span class="hljs-literal">true</span> })</li><li>          .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onCreateNativeMediaPlayer</span>(<span class="hljs-function">(<span class="hljs-params">handler: webview.NativeMediaPlayerHandler, mediaInfo: webview.MediaInfo</span>) =&gt;</span> {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onCreateNativeMediaPlayer('</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(mediaInfo) + <span class="hljs-string">')'</span>);</li><li>              <span class="hljs-keyword">let</span> nativePlayerInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativePlayerInfo</span>(<span class="hljs-variable language_">this</span>, handler, mediaInfo, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">native_player_info_list</span>.<span class="hljs-title function_">push</span>(nativePlayerInfo);</li><li>              <span class="hljs-keyword">return</span> nativePlayerInfo.<span class="hljs-property">player</span>;</li><li>            });</li><li>          })</li><li>          .<span class="hljs-title function_">onNativeEmbedGestureEvent</span>(<span class="hljs-function">(<span class="hljs-params">event</span>)=&gt;</span>{</li><li>            <span class="hljs-keyword">if</span> (!event.<span class="hljs-property">touchEvent</span> || !event.<span class="hljs-property">embedId</span>) {</li><li>              event.<span class="hljs-property">result</span>?.<span class="hljs-title function_">setGestureEventResult</span>(<span class="hljs-literal">false</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`WebComponent.onNativeEmbedGestureEvent, embedId[<span class="hljs-subst">${event.embedId}</span>]`</span>);</li><li>            <span class="hljs-keyword">let</span> native_player_info = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNativePlayerInfoByEmbedId</span>(event.<span class="hljs-property">embedId</span>);</li><li>            <span class="hljs-keyword">if</span> (!native_player_info) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`WebComponent.onNativeEmbedGestureEvent, embedId[<span class="hljs-subst">${event.embedId}</span>], no native_player_info`</span>);</li><li>              event.<span class="hljs-property">result</span>?.<span class="hljs-title function_">setGestureEventResult</span>(<span class="hljs-literal">false</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (!native_player_info.<span class="hljs-property">node_controller</span>) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`WebComponent.onNativeEmbedGestureEvent, embedId[<span class="hljs-subst">${event.embedId}</span>], no node_controller`</span>);</li><li>              event.<span class="hljs-property">result</span>?.<span class="hljs-title function_">setGestureEventResult</span>(<span class="hljs-literal">false</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">let</span> ret = native_player_info.<span class="hljs-property">node_controller</span>.<span class="hljs-title function_">postTouchEvent</span>(event.<span class="hljs-property">touchEvent</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`WebComponent.postTouchEvent, ret[<span class="hljs-subst">${ret}</span>], touchEvent[<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(event.touchEvent)}</span>]`</span>);</li><li>            event.<span class="hljs-property">result</span>?.<span class="hljs-title function_">setGestureEventResult</span>(ret);</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">onAreaChange</span>(<span class="hljs-function">(<span class="hljs-params">oldValue: Area, newValue: Area</span>) =&gt;</span> {</li><li>            oldValue;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">area</span> = newValue;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getNativePlayerInfoByEmbedId</span>(<span class="hljs-attr">embedId</span>: <span class="hljs-built_in">string</span>) : <span class="hljs-title class_">NativePlayerInfo</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">native_player_info_list</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>)=&gt;</span> item.<span class="hljs-property">embed_id</span> == embedId);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>应用侧代码，视频播放示例, ./PlayerDemo.ets。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AVPlayerListener</span> {</li><li>  <span class="hljs-title function_">onPlaying</span>() : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onPaused</span>() : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onDurationChanged</span>(<span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onBufferedTimeChanged</span>(<span class="hljs-attr">buffered</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onTimeUpdate</span>(<span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span>) : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onEnded</span>() : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onError</span>() : <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onVideoSizeChanged</span>(<span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span>;</li><li>  <span class="hljs-title function_">onDestroyed</span>(): <span class="hljs-built_in">void</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PlayerParam</span> {</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;</li><li>  listener?: <span class="hljs-title class_">AVPlayerListener</span>;</li><li>  httpHeaders?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;</li><li>}</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PlayCommand</span> {</li><li>  <span class="hljs-attr">func</span>: <span class="hljs-title class_">Function</span>;</li><li>  name?: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CheckPlayCommandResult</span> {</li><li>  <span class="hljs-attr">ignore</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-attr">index_to_remove</span>: <span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayerDemo</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">surfaceID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// surfaceID用于播放画面显示，具体的值需要通过Xcomponent接口获取，相关文档链接见上面Xcomponent创建方法</span></li><li>
</li><li>  avPlayer?: media.<span class="hljs-property">AVPlayer</span>;</li><li>  <span class="hljs-attr">prepared</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-attr">commands</span>: <span class="hljs-title class_">PlayCommand</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">setSurfaceID</span>(<span class="hljs-params">surface_id: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayerDemo.setSurfaceID : <span class="hljs-subst">${surface_id}</span>`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceID</span> = surface_id;</li><li>  }</li><li>  <span class="hljs-comment">// 注册avplayer回调函数</span></li><li>  <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-params">avPlayer: media.AVPlayer, listener?: AVPlayerListener</span>) {</li><li>    <span class="hljs-comment">// seek操作结果回调函数</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seekDone'</span>, <span class="hljs-function">(<span class="hljs-params">seekDoneTime: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer seek succeeded, seek time is <span class="hljs-subst">${seekDoneTime}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-comment">// error回调监听函数,当avPlayer在操作过程中出现错误时调用reset接口触发重置流程</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke avPlayer failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      listener?.<span class="hljs-title function_">onError</span>();</li><li>      avPlayer.<span class="hljs-title function_">reset</span>(); <span class="hljs-comment">// 调用reset重置资源，触发idle状态</span></li><li>    });</li><li>    <span class="hljs-comment">// 状态机变化回调函数</span></li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">state</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">reason</span>: media.<span class="hljs-property">StateChangeReason</span>) =&gt; {</li><li>      <span class="hljs-keyword">switch</span> (state) {</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'idle'</span>: <span class="hljs-comment">// 成功调用reset接口后触发该状态机上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state idle called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">release</span>(); <span class="hljs-comment">// 调用release接口销毁实例对象</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// avplayer 设置播放源后触发该状态上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state initialized called.'</span>);</li><li>          avPlayer.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceID</span>; <span class="hljs-comment">// 设置显示画面，当播放的资源为纯音频时无需设置</span></li><li>          avPlayer.<span class="hljs-title function_">prepare</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>: <span class="hljs-comment">// prepare调用成功后上报该状态机</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state prepared called.'</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">prepared</span> = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'playing'</span>: <span class="hljs-comment">// play成功调用后触发该状态机上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state playing called.'</span>);</li><li>          listener?.<span class="hljs-title function_">onPlaying</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'paused'</span>: <span class="hljs-comment">// pause成功调用后触发该状态机上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state paused called.'</span>);</li><li>          listener?.<span class="hljs-title function_">onPaused</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>: <span class="hljs-comment">// 播放结束后触发该状态机上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state completed called.'</span>);</li><li>          avPlayer.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">//调用播放结束接口</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'stopped'</span>: <span class="hljs-comment">// stop接口成功调用后触发该状态机上报</span></li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state stopped called.'</span>);</li><li>          listener?.<span class="hljs-title function_">onEnded</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-string">'released'</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">prepared</span> = <span class="hljs-literal">false</span>;</li><li>          listener?.<span class="hljs-title function_">onDestroyed</span>();</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state released called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer state unknown called.'</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    });</li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'durationUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">duration: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer state durationUpdate success,new duration is :<span class="hljs-subst">${duration}</span>`</span>);</li><li>      listener?.<span class="hljs-title function_">onDurationChanged</span>(duration/<span class="hljs-number">1000</span>);</li><li>    });</li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'timeUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">time:<span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      listener?.<span class="hljs-title function_">onTimeUpdate</span>(time/<span class="hljs-number">1000</span>);</li><li>    });</li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bufferingUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">infoType: media.BufferingInfoType, value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer state bufferingUpdate success,and infoType value is:<span class="hljs-subst">${infoType}</span>, value is : <span class="hljs-subst">${value}</span>`</span>);</li><li>      listener?.<span class="hljs-title function_">onBufferedTimeChanged</span>(value);</li><li>    })</li><li>    avPlayer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'videoSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">width: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer state videoSizeChange success,and width is:<span class="hljs-subst">${width}</span>, height is : <span class="hljs-subst">${height}</span>`</span>);</li><li>      listener?.<span class="hljs-title function_">onVideoSizeChanged</span>(width, height);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 以下示例通过URL设置网络地址来播放直播码流</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">avPlayerLiveDemo</span>(<span class="hljs-params">playerParam: PlayerParam</span>) {</li><li>    <span class="hljs-comment">// 创建avPlayer实例对象</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// 创建状态机变化回调函数</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>, playerParam.<span class="hljs-property">listener</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">mediaSource</span>: media.<span class="hljs-property">MediaSource</span> = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(playerParam.<span class="hljs-property">url</span>, playerParam.<span class="hljs-property">httpHeaders</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">strategy</span>: media.<span class="hljs-property">PlaybackStrategy</span> = {</li><li>      <span class="hljs-attr">preferredWidth</span>: <span class="hljs-number">100</span>,</li><li>      <span class="hljs-attr">preferredHeight</span>: <span class="hljs-number">100</span>,</li><li>      <span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">100</span>,</li><li>      <span class="hljs-attr">preferredHdr</span>: <span class="hljs-literal">false</span></li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, strategy);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer url:[<span class="hljs-subst">${playerParam.url}</span>]`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">schedule</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">prepared</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> command = <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">shift</span>();</li><li>      <span class="hljs-keyword">if</span> (command) {</li><li>        command.<span class="hljs-title function_">func</span>();</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>        });</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkCommand</span>(<span class="hljs-params">selfName: <span class="hljs-built_in">string</span>, oppositeName: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> index_to_remove = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> ignore_this_action = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">let</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">while</span> (index &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>[index].<span class="hljs-property">name</span> == selfName) {</li><li>        ignore_this_action = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>[index].<span class="hljs-property">name</span> == oppositeName) {</li><li>        index_to_remove = index;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      index--;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> result : <span class="hljs-title class_">CheckPlayCommandResult</span> = {</li><li>      <span class="hljs-attr">ignore</span>: ignore_this_action,</li><li>      <span class="hljs-attr">index_to_remove</span>: index_to_remove,</li><li>    };</li><li>    <span class="hljs-keyword">return</span> result;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">play</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> commandName = <span class="hljs-string">'play'</span>;</li><li>    <span class="hljs-keyword">let</span> checkResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkCommand</span>(commandName, <span class="hljs-string">'pause'</span>);</li><li>    <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">ignore</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer <span class="hljs-subst">${commandName}</span> ignored.`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">index_to_remove</span> &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> removedCommand = <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">splice</span>(checkResult.<span class="hljs-property">index_to_remove</span>, <span class="hljs-number">1</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(removedCommand)}</span> removed.`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer.play()'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">play</span>();</li><li>    }, <span class="hljs-attr">name</span>: commandName});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>  <span class="hljs-title function_">pause</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> commandName = <span class="hljs-string">'pause'</span>;</li><li>    <span class="hljs-keyword">let</span> checkResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkCommand</span>(commandName, <span class="hljs-string">'play'</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`checkResult:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(checkResult)}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">ignore</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer <span class="hljs-subst">${commandName}</span> ignored.`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">index_to_remove</span> &gt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> removedCommand = <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">splice</span>(checkResult.<span class="hljs-property">index_to_remove</span>, <span class="hljs-number">1</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(removedCommand)}</span> removed.`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer.pause()'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">pause</span>();</li><li>    }, <span class="hljs-attr">name</span>: commandName});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>  <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'AVPlayer.release()'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">release</span>();</li><li>    }});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>  <span class="hljs-title function_">seek</span>(<span class="hljs-params">time: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer.seek(<span class="hljs-subst">${time}</span>)`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">seek</span>(time * <span class="hljs-number">1000</span>);</li><li>    }});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>  <span class="hljs-title function_">setVolume</span>(<span class="hljs-params">volume: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer.setVolume(<span class="hljs-subst">${volume}</span>)`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">setVolume</span>(volume);</li><li>    }});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>  <span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-params">playbackRate: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">let</span> speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_00_X</span>;</li><li>    <span class="hljs-keyword">let</span> delta = <span class="hljs-number">0.05</span>;</li><li>    playbackRate += delta;</li><li>    <span class="hljs-keyword">if</span> (playbackRate &lt; <span class="hljs-number">1</span>) {</li><li>      speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_0_75_X</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (playbackRate &lt; <span class="hljs-number">1.25</span>) {</li><li>      speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_00_X</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (playbackRate &lt; <span class="hljs-number">1.5</span>) {</li><li>      speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_25_X</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (playbackRate &lt; <span class="hljs-number">2</span>) {</li><li>      speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_75_X</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      speed = media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_2_00_X</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">func</span>: <span class="hljs-function">()=&gt;</span>{</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`AVPlayer.setSpeed(<span class="hljs-subst">${speed}</span>)`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">setSpeed</span>(speed);</li><li>    }});</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">schedule</span>();</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>前端页面示例。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avplayer">AVPlayer</a>托管Web媒体的播放，支持的媒体资源可以参考AVPlayer<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#支持的格式与协议">支持的格式与协议</a>。</p>       <div _ngcontent-oaq-c106="" class="highlight-div"><div _ngcontent-oaq-c106="" class="highlight-div-header"><div _ngcontent-oaq-c106="" class="highlight-div-header-left"><div _ngcontent-oaq-c106="" class="handle-button expand-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oaq-c106="" class="highlight-div-header-right"><div _ngcontent-oaq-c106="" class="handle-button ai-button"></div><div _ngcontent-oaq-c106="" class="handle-button line-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oaq-c106="" class="handle-button theme-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oaq-c106="" class="handle-button copy-button"><div _ngcontent-oaq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oaq-c106="" class="highlight-scroll-div"><pre class="html prettyprint linenums hljs language-xml" hw-language="html" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">&lt;!-- main.html --&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>视频托管测试html<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width"</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></li><li>    <span class="hljs-comment">&lt;!-- 使用时需要自行替换视频链接 --&gt;</span></li><li>    <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://xxx.xxx/demo.mp4'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width: 100%'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></li><li><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>