<h1 _ngcontent-jwn-c119="" class="doc-title ng-star-inserted" title="批量数据写数据库场景"> 批量数据写数据库场景 </h1>

<div _ngcontent-jwn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="使用taskpool进行频繁数据库操作">使用TaskPool进行频繁数据库操作<i class="anchor-icon anchor-icon-link" anchorid="使用taskpool进行频繁数据库操作" tips="复制节点链接"></i></h2><p>对于需要频繁数据库操作的场景，由于读写数据库存在耗时，因此推荐在子线程中操作，避免阻塞UI线程。</p> <p>通过ArkTS提供的TaskPool能力，可以将数据库操作任务移到子线程中，实现如下。</p> <ol><li><p>创建多个子任务，支持数据库的创建、插入、查询和清除等操作。</p>  </li><li><p>UI主线程发起数据库操作请求，在子线程中完成数据库的增删改查等操作。</p>  </li></ol> <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { relationalStore, <span class="hljs-title class_">ValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 创建表</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CREATE_TABLE_SQL</span> = <span class="hljs-string">"CREATE TABLE IF NOT EXISTS test ("</span> +</li><li>      <span class="hljs-string">"id INTEGER PRIMARY KEY AUTOINCREMENT, "</span> +</li><li>      <span class="hljs-string">"name TEXT NOT NULL, "</span> +</li><li>      <span class="hljs-string">"age INTEGER, "</span> +</li><li>      <span class="hljs-string">"salary REAL, "</span> +</li><li>      <span class="hljs-string">"blobType BLOB)"</span>;</li><li>    <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">executeSql</span>(<span class="hljs-variable constant_">CREATE_TABLE_SQL</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create table test successfully!'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err)  {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Create db failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">context: Context, valueBucketArray: <span class="hljs-built_in">Array</span>&lt;relationalStore.ValuesBucket&gt;</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 数据插入</span></li><li>  <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">batchInsert</span>(<span class="hljs-string">"test"</span>, valueBucketArray <span class="hljs-keyword">as</span> <span class="hljs-title class_">Object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;relationalStore.<span class="hljs-property">ValuesBucket</span>&gt;);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;relationalStore.<span class="hljs-property">ValuesBucket</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 获取用于查询的谓词</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">predicates</span>: relationalStore.<span class="hljs-property">RdbPredicates</span> = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">"test"</span>);</li><li>  <span class="hljs-comment">// 查询所有数据</span></li><li>  <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">query</span>(predicates);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Query data successfully! row count:<span class="hljs-subst">${resultSet.rowCount}</span>`</span>);</li><li>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>&lt;relationalStore.<span class="hljs-property">ValuesBucket</span>&gt;(resultSet.<span class="hljs-property">rowCount</span>);</li><li>  resultSet.<span class="hljs-title function_">goToFirstRow</span>();</li><li>  <span class="hljs-keyword">do</span> {</li><li>    result[index++] = resultSet.<span class="hljs-title function_">getRow</span>();</li><li>  } <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>());</li><li>  resultSet.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteStore</span>(<span class="hljs-params">context: Context</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Delete Store.db successfully!'</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context : <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>
</li><li>          <span class="hljs-comment">// 数据准备</span></li><li>          <span class="hljs-keyword">const</span> count = <span class="hljs-number">5</span>;</li><li>          <span class="hljs-keyword">let</span> valueBucketArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>&lt;relationalStore.<span class="hljs-property">ValuesBucket</span>&gt;(count);</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: relationalStore.<span class="hljs-property">ValuesBucket</span> = {</li><li>              <span class="hljs-attr">id</span>: i,</li><li>              <span class="hljs-attr">name</span>: <span class="hljs-string">"zhangsan"</span> + i,</li><li>              <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,</li><li>              <span class="hljs-attr">salary</span>: <span class="hljs-number">5000</span> + <span class="hljs-number">50</span> * i</li><li>            };</li><li>            valueBucketArray[i] = value;</li><li>          }</li><li>          <span class="hljs-keyword">let</span> ret = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(create, context);</li><li>          <span class="hljs-keyword">if</span> (!ret) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Create db failed."</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(insert, context, valueBucketArray);</li><li>          <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>          <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(query, context) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;relationalStore.<span class="hljs-property">ValuesBucket</span>&gt;;</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> resultSet) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].id = <span class="hljs-subst">${value.id}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].name = <span class="hljs-subst">${value.name}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].age = <span class="hljs-subst">${value.age}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].salary = <span class="hljs-subst">${value.salary}</span>`</span>);</li><li>            index++;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(deleteStore, context);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="使用sendable进行大容量数据库操作">使用Sendable进行大容量数据库操作<i class="anchor-icon anchor-icon-link" anchorid="使用sendable进行大容量数据库操作" tips="复制节点链接"></i></h2><p>由于数据库数据跨线程传递存在耗时，数据量较大时会占用UI主线程。推荐使用Sendable封装数据库数据，以降低跨线程开销。</p> <ol><li><p>定义数据库中的数据格式，可以使用Sendable，以减少跨线程操作的耗时。</p>  <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SharedValuesBucket.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IValueBucket</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">salary</span>: <span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedValuesBucket</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IValueBucket</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span></li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></li><li>  <span class="hljs-attr">salary</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: IValueBucket</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = value.<span class="hljs-property">id</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = value.<span class="hljs-property">name</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = value.<span class="hljs-property">age</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = value.<span class="hljs-property">salary</span></li><li>  }</li><li>}</li></ol></pre></div></div>   </li><li><p>UI主线程发起数据库操作请求，在子线程完成数据的增删改查等操作。</p>  <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { relationalStore, <span class="hljs-title class_">ValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { collections, taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IValueBucket</span>, <span class="hljs-title class_">SharedValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SharedValuesBucket'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 创建表</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CREATE_TABLE_SQL</span> = <span class="hljs-string">"CREATE TABLE IF NOT EXISTS test ("</span> +</li><li>      <span class="hljs-string">"id INTEGER PRIMARY KEY AUTOINCREMENT, "</span> +</li><li>      <span class="hljs-string">"name TEXT NOT NULL, "</span> +</li><li>      <span class="hljs-string">"age INTEGER, "</span> +</li><li>      <span class="hljs-string">"salary REAL, "</span> +</li><li>      <span class="hljs-string">"blobType BLOB)"</span>;</li><li>    <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">executeSql</span>(<span class="hljs-variable constant_">CREATE_TABLE_SQL</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create table test successfully!'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Create db failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">context: Context, valueBucketArray: collections.<span class="hljs-built_in">Array</span>&lt;SharedValuesBucket | <span class="hljs-literal">undefined</span>&gt;</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 数据插入</span></li><li>  <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">batchInsert</span>(<span class="hljs-string">"test"</span>, valueBucketArray <span class="hljs-keyword">as</span> <span class="hljs-title class_">Object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ValuesBucket</span>&gt;);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 获取用于查询的谓词</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">predicates</span>: relationalStore.<span class="hljs-property">RdbPredicates</span> = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">"test"</span>);</li><li>  <span class="hljs-comment">// 查询所有数据</span></li><li>  <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">query</span>(predicates);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Query data successfully! row count:<span class="hljs-subst">${resultSet.rowCount}</span>`</span>);</li><li>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> result = collections.<span class="hljs-property">Array</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;(resultSet.<span class="hljs-property">rowCount</span>, <span class="hljs-literal">undefined</span>);</li><li>  resultSet.<span class="hljs-title function_">goToFirstRow</span>();</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">IValueBucket</span> = {</li><li>      <span class="hljs-attr">id</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"id"</span>)),</li><li>      <span class="hljs-attr">name</span>: resultSet.<span class="hljs-title function_">getString</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"name"</span>)),</li><li>      <span class="hljs-attr">age</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"age"</span>)),</li><li>      <span class="hljs-attr">salary</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"salary"</span>))</li><li>    };</li><li>    result[index++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedValuesBucket</span>(value);</li><li>  } <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>());</li><li>  resultSet.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteStore</span>(<span class="hljs-params">context: Context</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Delete Store.db successfully!'</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context : <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>
</li><li>          <span class="hljs-comment">// 数据准备</span></li><li>          <span class="hljs-keyword">const</span> count = <span class="hljs-number">5</span>;</li><li>          <span class="hljs-keyword">let</span> valueBucketArray = collections.<span class="hljs-property">Array</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;(count, <span class="hljs-literal">undefined</span>);</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">IValueBucket</span> = {</li><li>              <span class="hljs-attr">id</span>: i,</li><li>              <span class="hljs-attr">name</span>: <span class="hljs-string">"zhangsan"</span> + i,</li><li>              <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,</li><li>              <span class="hljs-attr">salary</span>: <span class="hljs-number">5000</span> + <span class="hljs-number">50</span> * i</li><li>            };</li><li>            valueBucketArray[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedValuesBucket</span>(value);</li><li>          }</li><li>          <span class="hljs-keyword">let</span> ret = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(create, context);</li><li>          <span class="hljs-keyword">if</span> (!ret) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Create db failed."</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(insert, context, valueBucketArray);</li><li>          <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">resultSet</span>: collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span>&gt; =</li><li>            <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(query, context) <span class="hljs-keyword">as</span> collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span>&gt;;</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> resultSet.<span class="hljs-title function_">values</span>()) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].id = <span class="hljs-subst">${value.id}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].name = <span class="hljs-subst">${value.name}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].age = <span class="hljs-subst">${value.age}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].salary = <span class="hljs-subst">${value.salary}</span>`</span>);</li><li>            index++;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(deleteStore, context);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div>  <div class="tiledSection"><h2 id="复杂类实例对象使用sendable进行大容量数据库操作">复杂类实例对象使用Sendable进行大容量数据库操作<i class="anchor-icon anchor-icon-link" anchorid="复杂类实例对象使用sendable进行大容量数据库操作" tips="复制节点链接"></i></h2><p>普通类实例对象的属性可持有Sendable类实例对象。</p> <p>对于复杂的普通类实例对象，可以先将相应数据库数据字段封装为Sendable类实例对象，再由普通类实例对象持有，从而降低跨线程开销。</p> <ol><li><p>定义数据库中的数据格式，采用Sendable，减少跨线程耗时。</p>  <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SharedValuesBucket.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IValueBucket</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">salary</span>: <span class="hljs-built_in">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedValuesBucket</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IValueBucket</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">salary</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value: IValueBucket</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = value.<span class="hljs-property">id</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = value.<span class="hljs-property">name</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = value.<span class="hljs-property">age</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = value.<span class="hljs-property">salary</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>  </li><li><p>定义普通类实例对象，持有Sendable类实例对象。</p>  <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Material.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SharedValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SharedValuesBucket'</span>;</li><li><span class="hljs-keyword">import</span> { collections } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Material</span> {</li><li>  <span class="hljs-attr">seq</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-attr">materialName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-comment">// ... 省略其他属性</span></li><li>  <span class="hljs-attr">buckets</span>: collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">seq: <span class="hljs-built_in">number</span>, materialName: <span class="hljs-built_in">string</span>, buckets: collections.<span class="hljs-built_in">Array</span>&lt;SharedValuesBucket | <span class="hljs-literal">undefined</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">seq</span> = seq;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">materialName</span> = materialName;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span> = buckets;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getBuckets</span>() : collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;{</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setBuckets</span>(<span class="hljs-params">buckets: collections.<span class="hljs-built_in">Array</span>&lt;SharedValuesBucket | <span class="hljs-literal">undefined</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buckets</span> = buckets;</li><li>  }</li><li>}</li></ol></pre></div></div>  </li><li><p>UI主线程发起数据库操作请求，在子线程进行数据的增删改查等操作。</p>  <div _ngcontent-jwn-c106="" class="highlight-div"><div _ngcontent-jwn-c106="" class="highlight-div-header"><div _ngcontent-jwn-c106="" class="highlight-div-header-left"><div _ngcontent-jwn-c106="" class="handle-button expand-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwn-c106="" class="highlight-div-header-right"><div _ngcontent-jwn-c106="" class="handle-button ai-button"></div><div _ngcontent-jwn-c106="" class="handle-button line-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwn-c106="" class="handle-button theme-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwn-c106="" class="handle-button copy-button"><div _ngcontent-jwn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwn-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { relationalStore, <span class="hljs-title class_">ValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { collections, taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IValueBucket</span>, <span class="hljs-title class_">SharedValuesBucket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SharedValuesBucket'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Material</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Material'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 创建表</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CREATE_TABLE_SQL</span> = <span class="hljs-string">"CREATE TABLE IF NOT EXISTS test ("</span> +</li><li>      <span class="hljs-string">"id INTEGER PRIMARY KEY AUTOINCREMENT, "</span> +</li><li>      <span class="hljs-string">"name TEXT NOT NULL, "</span> +</li><li>      <span class="hljs-string">"age INTEGER, "</span> +</li><li>      <span class="hljs-string">"salary REAL, "</span> +</li><li>      <span class="hljs-string">"blobType BLOB)"</span>;</li><li>    <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">executeSql</span>(<span class="hljs-variable constant_">CREATE_TABLE_SQL</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create table test successfully!'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Create db failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">context: Context, valueBucketArray: collections.<span class="hljs-built_in">Array</span>&lt;SharedValuesBucket | <span class="hljs-literal">undefined</span>&gt;</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 数据插入</span></li><li>  <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">batchInsert</span>(<span class="hljs-string">"test"</span>, valueBucketArray <span class="hljs-keyword">as</span> <span class="hljs-title class_">Object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ValuesBucket</span>&gt;);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Create Store.db successfully!'</span>);</li><li>
</li><li>  <span class="hljs-comment">// 获取用于查询的谓词</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">predicates</span>: relationalStore.<span class="hljs-property">RdbPredicates</span> = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">"test"</span>);</li><li>  <span class="hljs-comment">// 查询所有数据</span></li><li>  <span class="hljs-keyword">let</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">query</span>(predicates);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Query data successfully! row count:<span class="hljs-subst">${resultSet.rowCount}</span>`</span>);</li><li>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> result = collections.<span class="hljs-property">Array</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;(resultSet.<span class="hljs-property">rowCount</span>, <span class="hljs-literal">undefined</span>);</li><li>  resultSet.<span class="hljs-title function_">goToFirstRow</span>();</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">IValueBucket</span> = {</li><li>      <span class="hljs-attr">id</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"id"</span>)),</li><li>      <span class="hljs-attr">name</span>: resultSet.<span class="hljs-title function_">getString</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"name"</span>)),</li><li>      <span class="hljs-attr">age</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"age"</span>)),</li><li>      <span class="hljs-attr">salary</span>: resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">"salary"</span>))</li><li>    };</li><li>    result[index++] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedValuesBucket</span>(value);</li><li>  } <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>());</li><li>  resultSet.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteStore</span>(<span class="hljs-params">context: Context</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>    <span class="hljs-attr">name</span>: <span class="hljs-string">"Store.db"</span>,</li><li>    <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>,</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 默认数据库文件路径为 context.databaseDir + "/rdb/" + StoreConfig.name</span></li><li>  <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(context, <span class="hljs-variable constant_">CONFIG</span>);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Delete Store.db successfully!'</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">initMaterial</span>(<span class="hljs-params"></span>) : <span class="hljs-title class_">Material</span> {</li><li>  <span class="hljs-comment">// 数据准备</span></li><li>  <span class="hljs-keyword">const</span> count = <span class="hljs-number">5</span>;</li><li>  <span class="hljs-keyword">let</span> valueBucketArray = collections.<span class="hljs-property">Array</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span> | <span class="hljs-literal">undefined</span>&gt;(count, <span class="hljs-literal">undefined</span>);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">IValueBucket</span> = {</li><li>      <span class="hljs-attr">id</span>: i,</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">"zhangsan"</span> + i,</li><li>      <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,</li><li>      <span class="hljs-attr">salary</span>: <span class="hljs-number">5000</span> + <span class="hljs-number">50</span> * i</li><li>    };</li><li>    valueBucketArray[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedValuesBucket</span>(value);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> material = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Material</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"test"</span>, valueBucketArray);</li><li>  <span class="hljs-keyword">return</span> material;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },</li><li>          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }</li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">let</span> context : <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>          <span class="hljs-keyword">let</span> material = <span class="hljs-title function_">initMaterial</span>();</li><li>          <span class="hljs-keyword">let</span> ret = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(create, context);</li><li>          <span class="hljs-keyword">if</span> (!ret) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Create db failed."</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(insert, context, material.<span class="hljs-title function_">getBuckets</span>());</li><li>          <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">resultSet</span>: collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span>&gt; =</li><li>            <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(query, context) <span class="hljs-keyword">as</span> collections.<span class="hljs-property">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span>&gt;;</li><li>          material.<span class="hljs-title function_">setBuckets</span>(resultSet);</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> resultSet.<span class="hljs-title function_">values</span>()) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].id = <span class="hljs-subst">${value.id}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].name = <span class="hljs-subst">${value.name}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].age = <span class="hljs-subst">${value.age}</span>`</span>);</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Row[<span class="hljs-subst">${index}</span>].salary = <span class="hljs-subst">${value.salary}</span>`</span>);</li><li>            index++;</li><li>          }</li><li>          <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(deleteStore, context);</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>