<h1 _ngcontent-wex-c119="" class="doc-title ng-star-inserted" title="投播组件开发指导"> 投播组件开发指导 </h1>

<div _ngcontent-wex-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>系统提供了音视频发声设备统一投播组件AVCastPicker，作为播控中心系统级设备切换、投播能力选择入口。应用通过接入统一投播组件，可以实现在应用内及系统播控中心，将音视频资源通过Cast+协议/DLNA协议投播到远端设备。</p> <p>通过本开发指导，完成一次音视频跨设备投播。</p> <div class="tiledSection"><h2 id="section1557419538816">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section1557419538816" tips="复制节点链接"></i></h2><p>需同时满足以下条件，才能使用该功能：</p> <ul><li><strong>设备限制</strong><p>本端设备：HarmonyOS 5.0.0及以上版本的手机、平板设备</p> <p>远端设备：HarmonyOS 5.0.0及以上版本的2in1设备、HarmonyOS 3.1及以上版本的华为智慧屏、支持标准DLNA协议的设备</p> </li></ul> <ul><li><strong>使用限制</strong><ul><li>双端设备打开蓝牙和WIFI，并可访问网络。</li></ul> </li></ul> </div> <div class="tiledSection"><h2 id="section1388918616125">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1388918616125" tips="复制节点链接"></i></h2><p>在开发具体功能前，请先查阅参考文档，获取详细的接口说明。</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avcastpicker" target="_blank">AVCastPicker</a>：投播组件，提供设备发现认证连接的统一入口。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avcastcontroller" target="_blank">AVCastController</a>：投播控制器，用于投播场景下，完成播放控制、远端播放状态监听等操作。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>AVCastController由系统获取并返回，在设备连接成功后获取，在设备断开后不能继续使用，否则会抛出异常。</p> <p>支持在线DRM视频资源投播能力，需注册DRM许可证请求回调函数，获取许可证后，调用处理许可证响应函数。</p> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.2.3.1.4.1.1" valign="top" width="13.59%"><p>接口类</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.3.1.4.1.2" valign="top" width="38.64%"><p>接口</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.3.1.4.1.3" valign="top" width="47.77%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="3" valign="top" width="13.59%"><p>AVSession</p> </td> <td class="cellrowborder" valign="top" width="38.64%"><p>setAVMetadata(data: AVMetadata, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="47.77%"><p>配置媒体信息，包括ID、标题、作者以及DRM类型等。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>on(type: 'outputDeviceChange', callback: (state: ConnectionState, device: OutputDeviceInfo) =&gt; void): void</p> </td> <td class="cellrowborder" valign="top"><p>注册设备变化的回调，同时包含了设备的连接状态。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>getAVCastController(callback: AsyncCallback&lt;AVCastController&gt;): void</p> </td> <td class="cellrowborder" valign="top"><p>获取远端投播时的控制接口。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="7" valign="top" width="13.59%"><p>AVCastController</p> </td> <td class="cellrowborder" valign="top" width="38.64%"><p>sendControlCommand(command: AVCastControlCommand, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="47.77%"><p>投播会话的控制接口，用于进行投播中的各种播控指令。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>prepare(item: AVQueueItem, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top"><p>准备播放，进行资源加载和缓冲，不会触发真正的播放。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>start(item: AVQueueItem, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top"><p>开始播放媒体资源。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>processMediaKeyResponse(assetId: string, response: Uint8Array): Promise&lt;void&gt;</p> </td> <td class="cellrowborder" valign="top"><p>提供DRM资源所需的秘钥。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>on(type: 'keyRequest', callback: KeyRequestCallback): void</p> </td> <td class="cellrowborder" valign="top"><p>注册DRM秘钥请求的回调。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>on(type: 'playbackStateChange', filter: Array&lt;string&gt; | 'all', callback: (state: AVPlaybackState) =&gt; void): void</p> </td> <td class="cellrowborder" valign="top"><p>注册播放状态变化的回调。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>on(type: 'mediaItemChange', callback: Callback&lt;AVQueueItem&gt;): void</p> </td> <td class="cellrowborder" valign="top"><p>注册当前播放内容更新的回调，返回当前播放的内容的信息。</p> </td> </tr>  </tbody></table></div> </div> </li></ul> </div> <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><ol><li>创建播放器，并创建AVSession。<p>通过AVSessionManager创建并激活媒体会话。</p> <p>示例中的context的获取方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息" target="_blank">获取UIAbility的上下文信息</a>。</p> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span>  { avSession }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>; <span class="hljs-comment">// 导入AVSession模块</span></li><li>
</li><li><span class="hljs-comment">// 声明全局的session对象，此写法是加在class类外的声明，如果需要在class类内申明全局变量，需要去掉 export let</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: avSession.<span class="hljs-property">AVSession</span>;</li><li><span class="hljs-comment">// 创建session</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">createSession</span>(<span class="hljs-params">context: Context</span>) {</li><li>  <span class="hljs-comment">// 创建的AVSession在基础播控与投播场景可以共用</span></li><li>  session = <span class="hljs-keyword">await</span> avSession.<span class="hljs-title function_">createAVSession</span>(context, <span class="hljs-string">'video_test'</span>, <span class="hljs-string">'video'</span>); <span class="hljs-comment">// 'audio'代表音频应用，'video'代表视频应用</span></li><li>  <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">activate</span>();</li><li>  <span class="hljs-comment">// 请按照如下参数设置，告知系统应用当前支持投播，才能成功投播。</span></li><li>  session.<span class="hljs-title function_">setExtras</span>({</li><li>    <span class="hljs-attr">requireAbilityList</span>: [<span class="hljs-string">'url-cast'</span>],</li><li>  }); </li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Session created. sessionId: <span class="hljs-subst">${session.sessionId}</span>`</span>);</li><li>}</li></ol></pre></div></div> </li><li>设置媒体资源信息，注册基础播控回调，接入系统播控中心的基础播控。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>接入投播组件前需要先适配媒体播控中心的基础播控业务，具体需要接入的内容请按照应用类型参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/playback-control-access-checklist" target="_blank">应用接入自检表</a>。</li><li>应用可以通过filter字段设置需要发现和过滤的协议类型，来匹配应用期望的投播设备。<p>注意，投播后，应用播放器切换上下集时，也可以通过filter参数控制系统播控中心是否显示可投播设备列表，filter参数设置为0，播控会识别为不支持投播，隐藏可投播设备显示。避免用户从播控中心投播，应用资源不可用。</p> </li><li>需要在AVCastPicker中仅显示支持DRM资源投播的设备时，应在AVMetadata设置明确的drmSchemes。</li></ul> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 与session声明不在同一文件时，需要import</span></li><li><span class="hljs-keyword">import</span>  { avSession }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>; <span class="hljs-comment">// 导入AVSession模块</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: avSession.<span class="hljs-property">AVSession</span>;</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span>{</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setAVMetadata</span>(<span class="hljs-attr">playInfo</span>: avSession.<span class="hljs-property">AVMediaDescription</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">metadata</span>: avSession.<span class="hljs-property">AVMetadata</span> = {</li><li>        <span class="hljs-attr">assetId</span>: playInfo.<span class="hljs-property">assetId</span>, <span class="hljs-comment">// 需要配置实际id</span></li><li>        <span class="hljs-attr">title</span>: playInfo.<span class="hljs-property">title</span>, <span class="hljs-comment">// 播放媒体资源的标题</span></li><li>        <span class="hljs-attr">subtitle</span>: playInfo.<span class="hljs-property">subtitle</span>,<span class="hljs-comment">// 播放媒体资源的副标题</span></li><li>        <span class="hljs-comment">// 发现Cast+ Stream 和 DLNA协议设备，TYPE_CAST_PLUS_STREAM为默认必选。</span></li><li>        <span class="hljs-attr">filter</span>: avSession.<span class="hljs-property">ProtocolType</span>.<span class="hljs-property">TYPE_CAST_PLUS_STREAM</span>|avSession.<span class="hljs-property">ProtocolType</span>.<span class="hljs-property">TYPE_DLNA</span>,</li><li>        <span class="hljs-attr">mediaImage</span>: playInfo.<span class="hljs-property">mediaImage</span>,</li><li>        <span class="hljs-attr">artist</span>: playInfo.<span class="hljs-property">artist</span>,</li><li>        <span class="hljs-comment">// 如果是DRM资源，配置支持的DRM uuid 用于设备过滤。非DRM资源不配置。</span></li><li>        <span class="hljs-attr">drmSchemes</span>: [<span class="hljs-string">'3d5e6d35-9b9a-41e8-b843-dd3c6e72c42c'</span>]</li><li>      };</li><li>    <span class="hljs-keyword">return</span> session.<span class="hljs-title function_">setAVMetadata</span>(metadata);</li><li>  }</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setSessionListener</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-comment">// 请按照自检接入表按需注册并实现基础播控的控制指令，以下为举例</span></li><li>    session?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'play'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    });</li><li>    session?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'pause'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    });</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>){</li><li>    <span class="hljs-title class_">Column</span>()</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li>在需要投播的播放界面创建投播组件AVCastPicker。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>若创建AVCastPicker后应用界面未显示，或点开Picker显示空白，请排查是否按步骤1、2接入了系统播控中心的基础播控，且正确设置了AVMetadata与Extras参数。</li><li>系统AVCastPicker提供CustomerPicker参数，应用可以通过该参数自定义Picker按钮的显示，具体开发请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-switch-call-devices#自定义样式实现" target="_blank">自定义样式</a>。</li></ul> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AVCastPicker</span>, <span class="hljs-title class_">AVCastPickerState</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 应用可以通过onStateChange接口监听组件显示/消失状态，当组件显示时建议不要销毁AVCastPicker的显示；当组件消失时，再根据业务隐藏AVCastPicker。</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">state: AVCastPickerState</span>) {</li><li>  <span class="hljs-keyword">if</span> (state == <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_APPEARING</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'The picker starts showing.'</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state == <span class="hljs-title class_">AVCastPickerState</span>.<span class="hljs-property">STATE_DISAPPEARING</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'The picker finishes presenting.'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建组件，并设置大小</span></li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">AVCastPicker</span>({</li><li>        <span class="hljs-attr">normalColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>,</li><li>        <span class="hljs-attr">onStateChange</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">onStateChange</span></li><li>      })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'40vp'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40vp'</span>)</li><li>        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'50%'</span>)</li><li>  }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>}</li><li>
</li></ol></pre></div></div> </li><li>注册AVSession投播控制回调。用于感知投播设备连接。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>下面代码展示设备连接成功后的相应的处理</p> <ul><li>连接成功后通过session获取AVCastController，用于后期的投播控制；</li><li>应用监听on('outputDeviceChange')回调，在收到设备切换到对端的信息时，就可以刷新应用内的播放界面为“投播页面或遥控器页面”，并暂停本机播放。在收到切换设备到本机的信息时，可以刷新应用内的播放界面为“本地播放页面”，并开始在本机播放。</li><li>如需要推送DRM在线资源，根据远端设备支持的DRM能力，从服务端获取对应的资源；</li><li>推送DRM资源后，应注册监听许可证请求事件，从服务器端获取许可证后，通过处理许可证响应函数提供给远端。</li></ul> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { avSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { session } <span class="hljs-keyword">from</span> <span class="hljs-string">'./xxx'</span>; <span class="hljs-comment">// session声明的文件</span></li><li>
</li><li>  <span class="hljs-attr">castController</span>: avSession.<span class="hljs-property">AVCastController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-title function_">getAVCastController</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 如支持投播，可使用下面接口监听设备连接状态的变化</span></li><li>    session.<span class="hljs-title function_">on</span>(<span class="hljs-string">'outputDeviceChange'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">connectState</span>: avSession.<span class="hljs-property">ConnectionState</span>,</li><li>                                                 <span class="hljs-attr">device</span>: avSession.<span class="hljs-property">OutputDeviceInfo</span>) =&gt; {</li><li>      <span class="hljs-comment">// 可以通过当前设备及设备连接状态来更新应用内播放界面的显示</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">currentDevice</span>: avSession.<span class="hljs-property">DeviceInfo</span> = device?.<span class="hljs-property">devices</span>?.[<span class="hljs-number">0</span>];</li><li>      <span class="hljs-keyword">if</span> (currentDevice.<span class="hljs-property">castCategory</span> === avSession.<span class="hljs-property">AVCastCategory</span>.<span class="hljs-property">CATEGORY_REMOTE</span> &amp;&amp; connectState === avSession.<span class="hljs-property">ConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) { <span class="hljs-comment">// 设备连接成功</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Device connected: <span class="hljs-subst">${device}</span>`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span> = <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">getAVCastController</span>();</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting a cast controller'</span>);</li><li>        <span class="hljs-comment">// 查询当前播放的状态</span></li><li>        <span class="hljs-keyword">let</span> avPlaybackState = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">getAVPlaybackState</span>();</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in AVPlaybackState resource obtained: <span class="hljs-subst">${avPlaybackState}</span>`</span>);</li><li>        <span class="hljs-comment">// 监听播放状态的变化</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-function">(<span class="hljs-params">state: avSession.AVPlaybackState</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in Playback state changed: <span class="hljs-subst">${state}</span>`</span>);</li><li>        });</li><li>        <span class="hljs-keyword">if</span> (currentDevice.<span class="hljs-property">supportedProtocols</span> === avSession.<span class="hljs-property">ProtocolType</span>.<span class="hljs-property">TYPE_CAST_PLUS_STREAM</span>) {</li><li>          <span class="hljs-comment">// 此设备支持cast+投播协议</span></li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentDevice.<span class="hljs-property">supportedProtocols</span> === avSession.<span class="hljs-property">ProtocolType</span>.<span class="hljs-property">TYPE_DLNA</span>) {</li><li>          <span class="hljs-comment">// 此设备支持DLNA投播协议</span></li><li>        }</li><li>        <span class="hljs-comment">// 此设备支持chinaDRM，监听许可证请求事件，也可在发起DRM资源投播前监听。</span></li><li>        <span class="hljs-keyword">if</span> (currentDevice.<span class="hljs-property">supportedDrmCapabilities</span>?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'3d5e6d35-9b9a-41e8-b843-dd3c6e72c42c'</span>)) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'keyRequest'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyRequestCallback</span>);</li><li>        }</li><li>      }</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 处理DRM许可证请求事件</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">keyRequestCallback</span>: avSession.<span class="hljs-property">KeyRequestCallback</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">assetId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">requestData</span>: <span class="hljs-title class_">Uint8Array</span>) =&gt; {</li><li>    <span class="hljs-comment">// 根据assetId获取对应的DRM url</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">drmUrl</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'http://license.xxx.xxx.com:8080/drmproxy/getLicense'</span>;</li><li>    <span class="hljs-comment">// 从服务器获取许可证，具体实现可参考附录。</span></li><li>    <span class="hljs-keyword">let</span> licenseResponseData = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLicense</span>(drmUrl, requestData); </li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 处理DRM许可证响应</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">processMediaKeyResponse</span>(assetId, licenseResponseData);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to process the response corresponding to the media key. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>    }</li><li>  }</li></ol></pre></div></div> </li><li>使用AVCastController进行资源播放。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>下面代码示例中的url仅作示意使用，开发者需根据实际情况，确认资源有效性并设置：</p> <ul><li>如果使用本地资源播放，必须确认资源文件可用，并使用应用沙箱路径访问对应资源，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径" target="_blank">获取应用文件路径</a>。应用沙箱的介绍及如何向应用沙箱推送文件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory" target="_blank">文件管理</a>。</li><li>如果通过FilePicker使用用户文件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/select-user-file" target="_blank">选择用户文件</a>。</li><li>如果使用网络播放路径，需<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">申请相关权限</a>：ohos.permission.INTERNET。</li><li>如果是DRM资源，需配置drmSchemes字段。</li></ul> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">playItem</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 设置播放参数，开始播放</span></li><li>    <span class="hljs-keyword">let</span> playItem : avSession.<span class="hljs-property">AVQueueItem</span> = {</li><li>      <span class="hljs-attr">itemId</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">description</span>: {</li><li>        <span class="hljs-attr">assetId</span>: <span class="hljs-string">'VIDEO-1'</span>,</li><li>        <span class="hljs-attr">title</span>: <span class="hljs-string">'ExampleTitle'</span>,</li><li>        <span class="hljs-attr">artist</span>: <span class="hljs-string">'ExampleArtist'</span>,</li><li>        <span class="hljs-comment">// 网络资源投播，设置mediaUri; 本地资源投播，将本地文件打开后，相关的文件描述符设置到fdSrc</span></li><li>        <span class="hljs-attr">mediaUri</span>: <span class="hljs-string">'https://xxx.xxx.com/example.mp4'</span>,</li><li>        <span class="hljs-comment">// 该字段大写，音频'AUDIO'，视频'VIDEO'</span></li><li>        <span class="hljs-attr">mediaType</span>: <span class="hljs-string">'VIDEO'</span>,</li><li>        <span class="hljs-attr">mediaSize</span>: <span class="hljs-number">1000</span>,</li><li>        <span class="hljs-comment">//startPosition为投播当前进度，设置该字段可将本机播放进度同步到远端</span></li><li>        <span class="hljs-attr">startPosition</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-comment">// 投播资源播放时长，设置该字段可将本机播放时长同步到远端显示</span></li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">100000</span>,</li><li>        <span class="hljs-attr">albumCoverUri</span>: <span class="hljs-string">'https://www.example.jpeg'</span>,</li><li>        <span class="hljs-attr">albumTitle</span>: <span class="hljs-string">'《ExampleAlbum》'</span>,</li><li>        <span class="hljs-attr">appName</span>: <span class="hljs-string">'ExampleApp'</span>,</li><li>        <span class="hljs-comment">// DRM资源，需要配置支持的DRM类型, 以chinaDRM为例。</span></li><li>        <span class="hljs-attr">drmScheme</span>: <span class="hljs-string">'3d5e6d35-9b9a-41e8-b843-dd3c6e72c42c'</span>,</li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// 准备播放，这个不会触发真正的播放，会进行加载和缓冲</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">prepare</span>(playItem, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Preparation done'</span>);</li><li>      <span class="hljs-comment">// 启动播放，真正触发对端播放。请在Prepare成功后再调用start。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">start</span>(playItem, <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Playback started'</span>);</li><li>      });</li><li>    });</li><li>  }</li></ol></pre></div></div> </li><li>使用AVCastController，监听控制命令和进行播放控制。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>应用可以通过如下监听与控制指令，实现从应用内控制投播设备，及响应来自对端设备或者系统播控中心的控制。</li><li>系统播控中心会按照应用的注册监听，来动态置灰和点亮控制卡片的按钮。</li><li>当前系统暂不支持清晰度调节，应用如需向用户提供清晰度调节入口，需要在用户选定不同清晰度时按照新的清晰度重新下发资源。</li></ul> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-title function_">playControl</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 记录从avsession获取的远端控制器this.castController</span></li><li>    <span class="hljs-comment">// 应用向对端设备下发播放命令</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avCommand</span>: avSession.<span class="hljs-property">AVCastControlCommand</span> = {<span class="hljs-attr">command</span>:<span class="hljs-string">'play'</span>};</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">sendControlCommand</span>(avCommand);</li><li>
</li><li>    <span class="hljs-comment">// 应用向对端设备下发暂停命令</span></li><li>    avCommand = {<span class="hljs-attr">command</span>:<span class="hljs-string">'pause'</span>};</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">sendControlCommand</span>(avCommand);</li><li>
</li><li>    <span class="hljs-comment">// 应用调节对端设备音量</span></li><li>    avCommand = {</li><li>      <span class="hljs-attr">command</span>: <span class="hljs-string">'setVolume'</span>,</li><li>      <span class="hljs-attr">parameter</span>: <span class="hljs-number">1</span></li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">sendControlCommand</span>(avCommand);</li><li>    </li><li>    <span class="hljs-comment">// 应用调节对端设备进度</span></li><li>    avCommand = {</li><li>      <span class="hljs-attr">command</span>: <span class="hljs-string">'seek'</span>,</li><li>      <span class="hljs-attr">parameter</span>: <span class="hljs-number">1</span></li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">sendControlCommand</span>(avCommand);</li><li>   <span class="hljs-comment">// 更多控制指令请参考</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-i#avcastcontrolcommand10" target="_blank"><span class="hljs-comment">AVCastControlCommand</span></a></li><li>  }</li><li>  <span class="hljs-title function_">controlListener</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 应用监听对端或播控中心上下一首/上下一集切换</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playPrevious'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'PlayPrevious done'</span>);</li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playNext'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'PlayNext done'</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 应用监听对端或播控中心播放状态、实时进度和音量变化事件</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-function">(<span class="hljs-params">playbackState: avSession.AVPlaybackState</span>)=&gt;</span>{</li><li>      <span class="hljs-keyword">if</span> (playbackState?.<span class="hljs-property">state</span>) {</li><li>        <span class="hljs-comment">// 播放状态变化</span></li><li>      }</li><li>      <span class="hljs-keyword">if</span> (playbackState?.<span class="hljs-property">position</span>) {</li><li>         <span class="hljs-comment">// 进度变化，可以根据position来获取对端播放的进度</span></li><li>      }</li><li>      <span class="hljs-keyword">if</span> (playbackState?.<span class="hljs-property">volume</span>) {</li><li>        <span class="hljs-comment">// 音量变化</span></li><li>      }</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 应用监听对端投播内容播放完毕事件。应用监听到此回调，可以按照业务在以下三种选其一实现，否则无内容播放，对端出现黑屏。</span></li><li>    <span class="hljs-comment">// 1. 有下一集时，自动切换下一集投播，此时需要调用Prepare和start重新设置新的url，参考步骤5</span></li><li>    <span class="hljs-comment">// 2. 无下一集时，建议循环播放同一集，重新调用prepare和start来设置当前新的url，参考步骤5</span></li><li>    <span class="hljs-comment">// 3. 业务不再支持投播，可以主动断开投播，参考步骤9。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'endOfStream'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 按业务处理</span></li><li>    });</li><li>    </li><li>    <span class="hljs-comment">// 应用监听对端或播控中心的进度调节完成事件，包括快进、快退、进度条拖拽完毕</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'seekDone'</span>, <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// seekDone表示用户在对端或是播控内进度调节完毕，可以在收到该回调后，根据'playbackStateChange'回调的position刷新绘制应用内进度条</span></li><li>      <span class="hljs-comment">// 应用主动调用seek调节对端进度后，也请等待seekDone回调再根据'playbackStateChange'中的position来刷新，更精准</span></li><li>     });</li><li>  }</li></ol></pre></div></div> </li><li>申请投播长时任务，避免应用在投播时进入后台时被系统冻结，导致无法持续投播。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在申请长时任务时，需要在module.json5文件中：</p> <ol><li>配置长时任务权限ohos.permission.KEEP_BACKGROUND_RUNNING。</li><li>为需要使用长时任务的UIAbility声明相应的后台模式类型：AUDIO_PLAYBACK。选其一申请即可，都可保证音频在应用后台、锁屏、熄屏投播时不会被中断。</li></ol> </div></div></div> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { backgroundTaskManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BackgroundTasksKit'</span>;</li><li><span class="hljs-keyword">import</span> { wantAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>);</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">startContinuousTask</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">wantAgentInfo</span>: wantAgent.<span class="hljs-property">WantAgentInfo</span> = {</li><li>        <span class="hljs-comment">// 点击通知后，将要执行的动作列表</span></li><li>        <span class="hljs-attr">wants</span>: [</li><li>          {</li><li>            <span class="hljs-attr">bundleName</span>: <span class="hljs-string">"com.example.myapplication"</span>,</li><li>            <span class="hljs-attr">abilityName</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>          }</li><li>        ],</li><li>        <span class="hljs-comment">// 点击通知后，动作类型</span></li><li>        <span class="hljs-attr">operationType</span>: wantAgent.<span class="hljs-property">OperationType</span>.<span class="hljs-property">START_ABILITY</span>,</li><li>        <span class="hljs-comment">// 使用者自定义的一个私有值</span></li><li>        <span class="hljs-attr">requestCode</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-comment">// 点击通知后，动作执行属性</span></li><li>        <span class="hljs-attr">wantAgentFlags</span>: [wantAgent.<span class="hljs-property">WantAgentFlags</span>.<span class="hljs-property">UPDATE_PRESENT_FLAG</span>]</li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 通过wantAgent模块的getWantAgent方法获取WantAgent对象</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>        wantAgent.<span class="hljs-title function_">getWantAgent</span>(wantAgentInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">wantAgentObj</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">try</span> {</li><li>                backgroundTaskManager.<span class="hljs-title function_">startBackgroundRunning</span>(context,</li><li>                    backgroundTaskManager.<span class="hljs-property">BackgroundMode</span>.<span class="hljs-property">AUDIO_PLAYBACK</span>, wantAgentObj).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in requesting to start running in background'</span>);</li><li>                }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to request to start running in background. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                });</li><li>            } <span class="hljs-keyword">catch</span> (error) {</li><li>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to request to start running in background. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>            }</li><li>        });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get WantAgent. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>    }</li><li>}</li></ol></pre></div></div> </li><li>投播后资源切换。<ul><li>应用已开始投播，再次进入播放详情页时可以通过getOutputDevice()接口获取当前播放设备，来判断此时是否正在投播中。<div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span>  { avSession }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>; <span class="hljs-comment">// 导入AVSession模块</span></li><li><span class="hljs-comment">// 与session声明不在同一文件时，需要import</span></li><li><span class="hljs-keyword">import</span> { session } <span class="hljs-keyword">from</span> <span class="hljs-string">'./xxx'</span>; <span class="hljs-comment">// session声明的文件</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">getOutputDevice</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">outputDeviceInfo: avSession.OutputDeviceInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 当前设备的castCategory为Remote，则表示正在投播中</span></li><li>  <span class="hljs-keyword">let</span> isCasting = outputDeviceInfo.<span class="hljs-property">devices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">castCategory</span> === avSession.<span class="hljs-property">AVCastCategory</span>.<span class="hljs-property">CATEGORY_REMOTE</span>;</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`GetOutputDevice BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre></div></div> </li><li>应用已开始投播，从播放详情页退出到应用首页时，建议不要断开投播即调用stopCasting，可以给用户留一个回到“投播的界面”的入口。</li><li>投播时用户在应用侧退出详情页，如果点击了其他视频播放，应用识别新的资源是否可以投播，可以根据以下两种情况处理：<ul><li>情况一：如新的视频资源可以投播，有以下两种方式可处理：<p>方式一：直接调用prepare和start更换投播资源，参考步骤5。对端播放新的视频资源，本地显示切换为“正在投播的界面”，不需要断开投播重新投播。</p> <p>方式二：不主动切换投播资源，正常绘制应用投播业务的按钮但不要创建AVCastPicker，用户点击后直接调用prepare和start更换投播资源，本地显示切换为“正在投播的界面”，不需要断开投播重新投播。</p> </li><li>情况二：如此时不可以投播，当前视频就在本地播放，隐藏投播业务的按钮显示即可。</li></ul> </li></ul> </li><li>处理音频焦点。请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency" target="_blank">多音频并发处理</a>。<p>在应用进入投播后，当前应用需要取消注册焦点处理事件，以免被其他应用的焦点申请而影响。</p> </li><li>结束投播。<ul><li>当远端设备断开的时候，应用会收到事件，系统会自动断开连接。</li><li>应用也可以使用断开投播的接口，主动进行投播连接的断开。<div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 一般来说，应用退出时，而不希望继续投播，可以主动结束</span></li><li>  <span class="hljs-keyword">await</span> session.<span class="hljs-title function_">stopCasting</span>();</li><li>}</li></ol></pre></div></div> </li></ul> <ul><li>建议应用监听并保存AVCastController.on('playbackStateChange')回调中的position，当投播断开时，可以刷新为“本地播放详情页”在本端继续播放，并根据这个position来调整本地播放的进度。</li></ul> </li></ol> </div> <div class="tiledSection"><h2 id="section15717184018447">镜像投屏自动切换资源投播<i class="anchor-icon anchor-icon-link" anchorid="section15717184018447" tips="复制节点链接"></i></h2><p>适用场景：用户通过“无线投屏”功能实现手机等设备和大屏等的镜像投屏，然后打开视频应用进入视频播放，此时会自动切换为资源投播。要达到上述目标体验，还需要做一些额外的适配工作。</p> <ol><li>应用进入播放页后，需要判断当前是否存在投屏的设备，避免和其他应用冲突：<div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span>  { avSession }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>; <span class="hljs-comment">//导入AVSession模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>  </li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: avSession.<span class="hljs-property">AVSession</span>; <span class="hljs-comment">//声明全局的session对象，此写法是加在class类外的声明，如果需要在class类内申明全局变量，需要去掉 let。</span></li><li><strong><span class="hljs-keyword">let</span></strong> <span class="hljs-attr">currentAVSession</span>: avSession.<span class="hljs-property">AVSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">checkOtherCast</span>(<span class="hljs-params"></span>) { </li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">currentOutputDevice</span>: avSession.<span class="hljs-property">OutputDeviceInfo</span> = currentAVSession.<span class="hljs-title function_">getOutputDeviceSync</span>(); </li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>; </li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getOutputDeviceSync error, error code: <span class="hljs-subst">${error.code}</span>, error message: <span class="hljs-subst">${error.message}</span>`</span>); </li><li>  } </li><li>}</li></ol></pre></div></div> <ol><li>如果设备返回为空，表示没有可以投屏的设备；或者系统当前虽然在镜像投屏，此时有别的APP在投播，此时应用应在本地播放；</li><li>如果设备返回不为空，则根据返回的OutputDeviceInfo，遍历找castCategory = “CATEGORY_REMOTE” &amp;&amp; supportedProtocols等属性支持的设备（与前述的投播流程相同判断逻辑），如果存在这样的设备，就表示此时可以进行资源投播；</li></ol> </li><li>应用正常投播后，仍然监听设备状态断开等场景，流程同<a href="/consumer/cn/doc/harmonyos-guides/distributed-playback-guide#开发步骤">投播组件开发步骤</a>中的内容描述。</li></ol> </div> <div class="tiledSection"><h3 id="section17411224012" class="firsth2">附录<i class="anchor-icon anchor-icon-link" anchorid="section17411224012" tips="复制节点链接"></i></h3><p><strong>从服务器获取许可证</strong></p> <p>开发者需要根据实际的资源和服务地址获取DRM许可证，以下示例代码仅作为参考。</p> <div _ngcontent-wex-c106="" class="highlight-div"><div _ngcontent-wex-c106="" class="highlight-div-header"><div _ngcontent-wex-c106="" class="highlight-div-header-left"><div _ngcontent-wex-c106="" class="handle-button expand-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wex-c106="" class="highlight-div-header-right"><div _ngcontent-wex-c106="" class="handle-button ai-button"></div><div _ngcontent-wex-c106="" class="handle-button line-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wex-c106="" class="handle-button theme-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wex-c106="" class="handle-button copy-button"><div _ngcontent-wex-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wex-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li> <span class="hljs-comment">// 获取DRM许可证, 仅做参考，需要结合实际资源和服务地址进行获取。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getLicense</span>(<span class="hljs-attr">drmUrl</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">requestData</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">licenseRequestStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">byteToString</span>(requestData);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">licenseResponseStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'defaultStr'</span>;</li><li>    <span class="hljs-keyword">let</span> httpRequest = http.<span class="hljs-title function_">createHttp</span>();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">response</span>: http.<span class="hljs-property">HttpResponse</span> = <span class="hljs-keyword">await</span> httpRequest.<span class="hljs-title function_">request</span>(drmUrl, {</li><li>        <span class="hljs-attr">method</span>: http.<span class="hljs-property">RequestMethod</span>.<span class="hljs-property">POST</span>,</li><li>        <span class="hljs-attr">header</span>: {</li><li>          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,</li><li>          <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip, deflate'</span>,</li><li>        },</li><li>        <span class="hljs-attr">extraData</span>: licenseRequestStr,</li><li>        <span class="hljs-attr">expectDataType</span>: http.<span class="hljs-property">HttpDataType</span>.<span class="hljs-property">STRING</span>,</li><li>      });</li><li>      <span class="hljs-keyword">if</span> (response?.<span class="hljs-property">responseCode</span> == http.<span class="hljs-property">ResponseCode</span>.<span class="hljs-property">OK</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> response.<span class="hljs-property">result</span> == <span class="hljs-string">'string'</span>) {</li><li>          licenseResponseStr = response.<span class="hljs-property">result</span>;</li><li>        }</li><li>      }</li><li>      httpRequest.<span class="hljs-title function_">destroy</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to request Http. Error: <span class="hljs-subst">${error}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stringToByte</span>(licenseResponseStr);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Uint8Array to string</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> arr Uint8Array</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">string</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">byteToString</span>(<span class="hljs-attr">arr</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">_arr</span>: <span class="hljs-title class_">Uint8Array</span> = arr</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; _arr.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-comment">// 将数值转为二进制字符串</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">binaryStr</span>: <span class="hljs-built_in">string</span> = _arr[i].<span class="hljs-title function_">toString</span>(<span class="hljs-number">2</span>)</li><li>      <span class="hljs-keyword">let</span> matchArray = binaryStr.<span class="hljs-title function_">match</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">'/^1+?(?=0)/'</span>))</li><li>      <span class="hljs-keyword">if</span> (matchArray &amp;&amp; binaryStr.<span class="hljs-property">length</span> == <span class="hljs-number">8</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">bytesLength</span>: <span class="hljs-built_in">number</span> = matchArray[<span class="hljs-number">0</span>].<span class="hljs-property">length</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: <span class="hljs-built_in">string</span> = _arr[i].<span class="hljs-title function_">toString</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">7</span> - bytesLength)</li><li>
</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt; bytesLength; j++) {</li><li>          store += _arr[j + i].<span class="hljs-title function_">toString</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)</li><li>        }</li><li>        str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">parseInt</span>(store, <span class="hljs-number">2</span>))</li><li>        i += bytesLength - <span class="hljs-number">1</span></li><li>      } <span class="hljs-keyword">else</span> {</li><li>        str += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(_arr[i])</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> str</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * string 转 Uint8Array</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> str string</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">Uint8Array</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">stringToByte</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">bytes</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>()</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">unicode</span>: <span class="hljs-built_in">number</span></li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {</li><li>      unicode = str.<span class="hljs-title function_">charCodeAt</span>(i)</li><li>      <span class="hljs-keyword">if</span> (unicode &gt;= <span class="hljs-number">0x010000</span> &amp;&amp; unicode &lt;= <span class="hljs-number">0x10FFFF</span>) {</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">18</span>) &amp; <span class="hljs-number">0x07</span>) | <span class="hljs-number">0xf0</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>((unicode &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unicode &gt;= <span class="hljs-number">0x000800</span> &amp;&amp; unicode &lt;= <span class="hljs-number">0x00FFF</span>) {</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0x07</span>) | <span class="hljs-number">0xf0</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>((unicode &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unicode &gt;= <span class="hljs-number">0x000800</span> &amp;&amp; unicode &lt;= <span class="hljs-number">0x0007FF</span>) {</li><li>        bytes.<span class="hljs-title function_">push</span>(((unicode &gt;&gt; <span class="hljs-number">6</span>) &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>        bytes.<span class="hljs-title function_">push</span>((unicode &amp; <span class="hljs-number">0x3F</span>) | <span class="hljs-number">0x80</span>)</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        bytes.<span class="hljs-title function_">push</span>(unicode &amp; <span class="hljs-number">0xFF</span>)</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bytes);</li><li>  }</li></ol></pre></div></div> </div> </div> <div></div></div>