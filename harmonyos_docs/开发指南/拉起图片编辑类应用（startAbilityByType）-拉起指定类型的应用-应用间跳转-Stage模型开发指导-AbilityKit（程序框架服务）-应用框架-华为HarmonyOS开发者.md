<h1 _ngcontent-exa-c119="" class="doc-title ng-star-inserted" title="拉起图片编辑类应用（startAbilityByType）"> 拉起图片编辑类应用（startAbilityByType） </h1>

<div _ngcontent-exa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="使用场景">使用场景<i class="anchor-icon anchor-icon-link" anchorid="使用场景" tips="复制节点链接"></i></h2>          <p>当应用自身不具备图片编辑能力、但存在图片编辑的场景时，可以通过startAbilityByType拉起图片编辑类应用扩展面板，由对应的应用完成图片编辑操作。图片编辑类应用可以通过PhotoEditorExtensionAbility实现图片编辑页面，并将该页面注册到图片编辑面板，从而将图片编辑能力开放给其他应用。</p>     <p>流程示意图如下：</p>     <p><span><img originheight="224" originwidth="1045" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114947.02560844361980466602195663677955:50001231000000:2800:9EDCA4417E677AF5357874D99C9BEB04CF858B1085CBA472940B84C351D6042F.png" width="920" height="197.20574162679426"></span></p>     <p>例如：用户在图库App中选择编辑图片时，图库App可以通过startAbilityByType拉起图片编辑类应用扩展面板。用户可以从已实现PhotoEditorExtensionAbility应用中选择一款，并进行图片编辑。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>接口详情参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-photoeditorextensionability" target="_blank">PhotoEditorExtensionAbility</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-photoeditorextensioncontext" target="_blank">PhotoEditorExtensionContext</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%"><strong>接口名</strong></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%"><strong>描述</strong></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">onStartContentEditing(uri: string, want:Want, session: UIExtensionContentSession):void</td>         <td class="cellrowborder" valign="top" width="50%">可以执行读取原始图片、加载页面等操作。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">saveEditedContentWithImage(pixeMap: image.PixelMap, option: image.PackingOption): Promise&lt;AbilityResult&gt;</td>         <td class="cellrowborder" valign="top" width="50%">传入编辑过的图片的PixelMap对象并保存。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="图片编辑类应用实现图片编辑页面">图片编辑类应用实现图片编辑页面<i class="anchor-icon anchor-icon-link" anchorid="图片编辑类应用实现图片编辑页面" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>在DevEco Studio工程中手动新建一个PhotoEditorExtensionAbility。</p>       <ol>        <li>在工程Module对应的ets目录下，右键选择“New &gt; Directory”，新建一个目录，如PhotoEditorExtensionAbility。</li>        <li>在PhotoEditorExtensionAbility目录中，右键选择“New &gt; File”，新建一个.ets文件，如ExamplePhotoEditorAbility.ets。</li>       </ol></li>      <li>       <p>在ExamplePhotoEditorAbility.ets中重写onCreate、onForeground、onBackground、onDestroy和onStartContentEditing的生命周期回调。</p>       <p>其中，需要在onStartContentEditing中加载入口页面文件pages/Index.ets，并将session、uri、实例对象等保存在LocalStorage中传递给页面。</p>       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PhotoEditorExtensionAbility</span>,<span class="hljs-title class_">UIExtensionContentSession</span>,<span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'[ExamplePhotoEditorAbility]'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExamplePhotoEditorAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PhotoEditorExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取图片，加载页面并将需要的参数传递给页面</span></li><li>  <span class="hljs-title function_">onStartContentEditing</span>(<span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">session</span>: <span class="hljs-title class_">UIExtensionContentSession</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onStartContentEditing want: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(want)}</span>, uri: <span class="hljs-subst">${uri}</span>`</span>);</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>({</li><li>      <span class="hljs-string">"session"</span>: session,</li><li>      <span class="hljs-string">"uri"</span>: uri</li><li>    } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;);</li><li>
</li><li>    session.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, storage);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onBackground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onDestroy'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在page中实现图片编辑功能。</p>       <p>图片编辑完成后调用saveEditedContentWithImage保存图片，并将回调结果通过terminateSelfWithResult返回给调用方。</p>       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIExtensionContentSession</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'[ExamplePhotoEditorAbility]'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'editImg'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">originalImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">editedImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> newWant ?: <span class="hljs-title class_">Want</span>;</li><li>  <span class="hljs-keyword">private</span> storage = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getSharedLocalStorage</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> originalImageUri = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>?.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"uri"</span>) ?? <span class="hljs-string">""</span>;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`OriginalImageUri: <span class="hljs-subst">${originalImageUri}</span>.`</span>);</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readImageByUri</span>(originalImageUri).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">imagePixMap</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span> = imagePixMap;</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 根据uri读取图片内容</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">readImageByUri</span>(<span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span> &lt; <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> &gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"uri: "</span> + uri);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      file = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"Original image file id: "</span> + file.<span class="hljs-property">fd</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSourceApi</span>: image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(file.<span class="hljs-property">fd</span>);</li><li>      <span class="hljs-keyword">if</span>(!imageSourceApi) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"ImageSourceApi failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">pixmap</span>: image.<span class="hljs-property">PixelMap</span> = <span class="hljs-keyword">await</span> imageSourceApi.<span class="hljs-title function_">createPixelMap</span>();</li><li>      <span class="hljs-keyword">if</span>(!pixmap) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"createPixelMap failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span> = pixmap;</li><li>      <span class="hljs-keyword">return</span> pixmap;</li><li>    } <span class="hljs-keyword">catch</span>(e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ReadImage failed:<span class="hljs-subst">${e}</span>`</span>);</li><li>    } <span class="hljs-keyword">finally</span> {</li><li>      fileIo.<span class="hljs-title function_">close</span>(file);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"RotateAndSaveImg"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Start to edit image and save.`</span>);</li><li>          <span class="hljs-comment">// 编辑图片功能实现</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span>?.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">90</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">packOpts</span>: image.<span class="hljs-property">PackingOption</span> = { <span class="hljs-attr">format</span>: <span class="hljs-string">"image/jpeg"</span>, <span class="hljs-attr">quality</span>: <span class="hljs-number">98</span> };</li><li>            <span class="hljs-keyword">try</span> {</li><li>              <span class="hljs-comment">// 调用saveEditedContentWithImage保存图片</span></li><li>              (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">PhotoEditorExtensionContext</span>).<span class="hljs-title function_">saveEditedContentWithImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span> <span class="hljs-keyword">as</span> image.<span class="hljs-property">PixelMap</span>,</li><li>                packOpts).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">resultCode</span> == <span class="hljs-number">0</span>) {</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Save succeed.`</span>);</li><li>                }</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                    <span class="hljs-string">`saveContentEditingWithImage result: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">newWant</span> = data.<span class="hljs-property">want</span>;</li><li>                <span class="hljs-comment">// data.want.uri存有编辑过图片的uri</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readImageByUri</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">newWant</span>?.<span class="hljs-property">uri</span> ?? <span class="hljs-string">""</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">imagePixMap</span> =&gt;</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span> = imagePixMap;</li><li>                })</li><li>              })</li><li>            } <span class="hljs-keyword">catch</span> (e) {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`saveContentEditingWithImage failed:<span class="hljs-subst">${e}</span>`</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>          })</li><li>        }).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"terminateSelfWithResult"</span>).<span class="hljs-title function_">onClick</span>((<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Finish the current editing.`</span>);</li><li>
</li><li>          <span class="hljs-keyword">let</span> session = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>?.<span class="hljs-title function_">get</span>(<span class="hljs-string">'session'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">UIExtensionContentSession</span>;</li><li>          <span class="hljs-comment">// 关闭并回传修改结果给调用方</span></li><li>          session?.<span class="hljs-title function_">terminateSelfWithResult</span>({ <span class="hljs-attr">resultCode</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">want</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">newWant</span> });</li><li>
</li><li>        })).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>
</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> }).<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Contain</span>)</li><li>
</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> }).<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Contain</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)</li><li>    .<span class="hljs-title function_">expandSafeArea</span>([<span class="hljs-title class_">SafeAreaType</span>.<span class="hljs-property">SYSTEM</span>], [<span class="hljs-title class_">SafeAreaEdge</span>.<span class="hljs-property">BOTTOM</span>])</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在工程Module对应的module.json5配置文件中注册PhotoEditorExtensionAbility。</p>       <p>type标签需要配置为"photoEditor"，srcEntry需要配置为PhotoEditorExtensionAbility组件所对应的代码路径。</p>       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"extensionAbilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ExamplePhotoEditorAbility"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$media:icon"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ExamplePhotoEditorAbility"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"photoEditor"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"exported"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/PhotoEditorExtensionAbility/ExamplePhotoEditorAbility.ets"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$string:EntryAbility_label"</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"extensionProcessMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundle"</span></li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="调用方拉起图片编辑类应用编辑图片">调用方拉起图片编辑类应用编辑图片<i class="anchor-icon anchor-icon-link" anchorid="调用方拉起图片编辑类应用编辑图片" tips="复制节点链接"></i></h2>          <p>开发者可以在UIAbility或者UIExtensionAbility的页面中通过接口startAbilityByType拉起图片编辑类应用扩展面板，系统将自动查找并在面板上展示基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-photoeditorextensionability" target="_blank">PhotoEditorExtensionAbility</a>实现的图片编辑应用，由用户选择某个应用来完成图片编辑的功能，最终将编辑的结果返回给到调用方，具体步骤如下：</p>     <ol>      <li>导入模块。       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileUri, picker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div></li>      <li>（可选）实现从图库中选取图片。       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">photoPickerGetUri</span>(): <span class="hljs-title class_">Promise</span> &lt; <span class="hljs-built_in">string</span> &gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-title class_">PhotoSelectOptions</span> = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">PhotoSelectOptions</span>();</li><li>    <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">MIMEType</span> = picker.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>;</li><li>    <span class="hljs-title class_">PhotoSelectOptions</span>.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> photoPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">photoSelectResult</span>: picker.<span class="hljs-property">PhotoSelectResult</span> = <span class="hljs-keyword">await</span> photoPicker.<span class="hljs-title function_">select</span>(<span class="hljs-title class_">PhotoSelectOptions</span>);</li><li>    <span class="hljs-keyword">return</span> photoSelectResult.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>];</li><li>  } <span class="hljs-keyword">catch</span>(error) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'PhotoViewPicker failed with err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>}</li></ol></pre></div></div></li>      <li>将图片拷贝到本地沙箱路径。       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span>;</li><li> <span class="hljs-keyword">try</span> {</li><li>   file = fileIo.<span class="hljs-title function_">openSync</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>   hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"file: "</span> + file.<span class="hljs-property">fd</span>);</li><li>
</li><li>   <span class="hljs-keyword">let</span> timeStamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>   <span class="hljs-comment">// 将用户图片拷贝到应用沙箱路径</span></li><li>   fileIo.<span class="hljs-title function_">copyFileSync</span>(file.<span class="hljs-property">fd</span>, context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">`/original-<span class="hljs-subst">${timeStamp}</span>.jpg`</span>);</li><li>
</li><li>   <span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">`/original-<span class="hljs-subst">${timeStamp}</span>.jpg`</span>;</li><li>   <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span> = fileUri.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);</li><li> } <span class="hljs-keyword">catch</span> (e) {</li><li>   hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`readImage failed:<span class="hljs-subst">${e}</span>`</span>);</li><li> } <span class="hljs-keyword">finally</span> {</li><li>   fileIo.<span class="hljs-title function_">close</span>(file);</li><li> }</li></ol></pre></div></div></li>      <li>在startAbilityByType回调函数中，通过want.uri获取编辑后的图片uri，并做对应的处理。       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">abilityStartCallback</span>: common.<span class="hljs-property">AbilityStartCallback</span> = {</li><li>    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">code, name, message</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">tip</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`code:`</span> + code + <span class="hljs-string">` name:`</span> + name + <span class="hljs-string">` message:`</span> + message;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"startAbilityByType:"</span>, tip);</li><li>    },</li><li>    <span class="hljs-attr">onResult</span>: <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 获取到回调结果中编辑后的图片uri并做对应的处理</span></li><li>      <span class="hljs-keyword">let</span> uri = result.<span class="hljs-property">want</span>?.<span class="hljs-property">uri</span> ?? <span class="hljs-string">""</span>;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"PhotoEditorCaller result: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readImage</span>(uri).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">imagePixMap</span> =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span> = imagePixMap;</li><li>      });</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>将图片转换为图片uri，并调用startAbilityByType拉起图片编辑应用面板。       <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">let</span> uri = fileUri.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);</li><li> context.<span class="hljs-title function_">startAbilityByType</span>(<span class="hljs-string">"photoEditor"</span>, {</li><li>   <span class="hljs-string">"ability.params.stream"</span>: [uri], <span class="hljs-comment">// 原始图片的uri,只支持传入一个uri</span></li><li>   <span class="hljs-string">"ability.want.params.uriPermissionFlag"</span>: wantConstant.<span class="hljs-property">Flags</span>.<span class="hljs-property">FLAG_AUTH_READ_URI_PERMISSION</span> <span class="hljs-comment">// 至少需要分享读权限给到图片编辑面板</span></li><li> } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;, abilityStartCallback, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">tip</span>: <span class="hljs-built_in">string</span>;</li><li>   <span class="hljs-keyword">if</span> (err) {</li><li>     tip = <span class="hljs-string">`Start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>;</li><li>     hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`startAbilityByType: fail, err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>   } <span class="hljs-keyword">else</span> {</li><li>     tip = <span class="hljs-string">`Start success`</span>;</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"startAbilityByType: "</span>, <span class="hljs-string">`success`</span>);</li><li>   }</li><li> });</li></ol></pre></div></div></li>     </ol>     <p>示例：</p>     <div _ngcontent-exa-c106="" class="highlight-div"><div _ngcontent-exa-c106="" class="highlight-div-header"><div _ngcontent-exa-c106="" class="highlight-div-header-left"><div _ngcontent-exa-c106="" class="handle-button expand-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-exa-c106="" class="highlight-div-header-right"><div _ngcontent-exa-c106="" class="handle-button ai-button"></div><div _ngcontent-exa-c106="" class="handle-button line-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-exa-c106="" class="handle-button theme-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-exa-c106="" class="handle-button copy-button"><div _ngcontent-exa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-exa-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common, wantConstant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileUri, picker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PhotoEditorCaller'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'selectImg'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">originalImage</span>: <span class="hljs-title class_">ResourceStr</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">editedImage</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-comment">// 根据uri读取图片内容</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">readImage</span>(<span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span> &lt; <span class="hljs-title class_">PixelMap</span> | <span class="hljs-literal">null</span> &gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"image uri: "</span> + uri);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      file = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"file: "</span> + file.<span class="hljs-property">fd</span>);</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSourceApi</span>: image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(file.<span class="hljs-property">fd</span>);</li><li>      <span class="hljs-keyword">if</span>(!imageSourceApi) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"imageSourceApi failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">pixmap</span>: image.<span class="hljs-property">PixelMap</span> = <span class="hljs-keyword">await</span> imageSourceApi.<span class="hljs-title function_">createPixelMap</span>();</li><li>      <span class="hljs-keyword">if</span>(!pixmap) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"createPixelMap failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span> = pixmap;</li><li>      <span class="hljs-keyword">return</span> pixmap;</li><li>    } <span class="hljs-keyword">catch</span>(e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`readImage failed:<span class="hljs-subst">${e}</span>`</span>);</li><li>    } <span class="hljs-keyword">finally</span> {</li><li>      fileIo.<span class="hljs-title function_">close</span>(file);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 图库中选取图片</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">photoPickerGetUri</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">textInfo</span>: photoAccessHelper.<span class="hljs-property">TextContextInfo</span> = {</li><li>            <span class="hljs-attr">text</span>: <span class="hljs-string">'photo'</span></li><li>        }</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">recommendOptions</span>: photoAccessHelper.<span class="hljs-property">RecommendationOptions</span> = {</li><li>            <span class="hljs-attr">textContextInfo</span>: textInfo</li><li>        }</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: photoAccessHelper.<span class="hljs-property">PhotoSelectOptions</span> = {</li><li>            <span class="hljs-title class_">MIMEType</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>,</li><li>            <span class="hljs-attr">maxSelectNumber</span>: <span class="hljs-number">1</span>,</li><li>            <span class="hljs-attr">recommendationOptions</span>: recommendOptions</li><li>        }</li><li>        <span class="hljs-keyword">let</span> photoPicker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">photoSelectResult</span>: photoAccessHelper.<span class="hljs-property">PhotoSelectResult</span> = <span class="hljs-keyword">await</span> photoPicker.<span class="hljs-title function_">select</span>(options);</li><li>        <span class="hljs-keyword">return</span> photoSelectResult.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>];</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'PhotoViewPicker failed with err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"selectImg"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>          <span class="hljs-comment">// 图库中选取图片</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">photoPickerGetUri</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">uri</span> =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"uri: "</span> + uri);</li><li>
</li><li>            <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fileIo.<span class="hljs-property">File</span> | <span class="hljs-literal">undefined</span>;</li><li>            <span class="hljs-keyword">try</span> {</li><li>              file = fileIo.<span class="hljs-title function_">openSync</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"file: "</span> + file.<span class="hljs-property">fd</span>);</li><li>
</li><li>              <span class="hljs-keyword">let</span> timeStamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>              <span class="hljs-comment">// 将用户图片拷贝到应用沙箱路径</span></li><li>              fileIo.<span class="hljs-title function_">copyFileSync</span>(file.<span class="hljs-property">fd</span>, context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">`/original-<span class="hljs-subst">${timeStamp}</span>.jpg`</span>);</li><li>
</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span> = context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">`/original-<span class="hljs-subst">${timeStamp}</span>.jpg`</span>;</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span> = fileUri.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);</li><li>            } <span class="hljs-keyword">catch</span> (e) {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`readImage failed:<span class="hljs-subst">${e}</span>`</span>);</li><li>            } <span class="hljs-keyword">finally</span> {</li><li>              fileIo.<span class="hljs-title function_">close</span>(file);</li><li>            }</li><li>          })</li><li>
</li><li>        }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'200'</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"editImg"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">abilityStartCallback</span>: common.<span class="hljs-property">AbilityStartCallback</span> = {</li><li>            <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">code, name, message</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">tip</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`code:`</span> + code + <span class="hljs-string">` name:`</span> + name + <span class="hljs-string">` message:`</span> + message;</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"startAbilityByType:"</span>, tip);</li><li>            },</li><li>            <span class="hljs-attr">onResult</span>: <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>              <span class="hljs-comment">// 获取到回调结果中编辑后的图片uri并做对应的处理</span></li><li>              <span class="hljs-keyword">let</span> uri = result.<span class="hljs-property">want</span>?.<span class="hljs-property">uri</span> ?? <span class="hljs-string">""</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"PhotoEditorCaller result: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readImage</span>(uri).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">imagePixMap</span> =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span> = imagePixMap;</li><li>              });</li><li>            }</li><li>          }</li><li>          <span class="hljs-comment">// 将图片转换为图片uri，并调用startAbilityByType拉起图片编辑应用面板</span></li><li>          <span class="hljs-keyword">let</span> uri = fileUri.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);</li><li>          context.<span class="hljs-title function_">startAbilityByType</span>(<span class="hljs-string">"photoEditor"</span>, {</li><li>            <span class="hljs-string">"ability.params.stream"</span>: [uri], <span class="hljs-comment">// 原始图片的uri,只支持传入一个uri</span></li><li>            <span class="hljs-string">"ability.want.params.uriPermissionFlag"</span>: wantConstant.<span class="hljs-property">Flags</span>.<span class="hljs-property">FLAG_AUTH_READ_URI_PERMISSION</span> <span class="hljs-comment">// 至少需要分享读权限给到图片编辑面板</span></li><li>          } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;, abilityStartCallback, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">tip</span>: <span class="hljs-built_in">string</span>;</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              tip = <span class="hljs-string">`Start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>;</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`startAbilityByType: fail, err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              tip = <span class="hljs-string">`Start success`</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"startAbilityByType: "</span>, <span class="hljs-string">`success`</span>);</li><li>            }</li><li>          });</li><li>
</li><li>        }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'200'</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">originalImage</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> }).<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Contain</span>)</li><li>
</li><li>        <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editedImage</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> }).<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Contain</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)</li><li>    .<span class="hljs-title function_">expandSafeArea</span>([<span class="hljs-title class_">SafeAreaType</span>.<span class="hljs-property">SYSTEM</span>], [<span class="hljs-title class_">SafeAreaEdge</span>.<span class="hljs-property">BOTTOM</span>])</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>