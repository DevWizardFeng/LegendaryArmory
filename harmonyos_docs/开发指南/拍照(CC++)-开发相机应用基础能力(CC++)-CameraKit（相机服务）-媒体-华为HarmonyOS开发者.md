<h1 _ngcontent-qsh-c119="" class="doc-title ng-star-inserted" title="拍照(C/C++)"> 拍照(C/C++) </h1>

<div _ngcontent-qsh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>拍照是相机的最重要功能之一，拍照模块基于相机复杂的逻辑，为了保证用户拍出的照片质量，在中间步骤可以设置分辨率、闪光灯、焦距、照片质量及旋转角度等信息。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdint&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_native.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libhilog_ndk.z.so</li><li>    libnative_buffer.so</li><li>    libohcamera.so</li><li>    libohimage.so</li><li>    libohfileuri.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>创建并打开相机设备，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-device-input"> 设备输入(C/C++)</a>步骤3-5。</p></li>      <li>       <p>选择设备支持的输出流能力，创建拍照输出流。</p>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_createphotooutputwithoutsurface" target="_blank">OH_CameraManager_CreatePhotoOutputWithoutSurface()</a>方法创建拍照输出流。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_PhotoOutput* <span class="hljs-title">CreatePhotoOutput</span><span class="hljs-params">(Camera_Manager* cameraManager, <span class="hljs-type">const</span> Camera_Profile* photoProfile)</span> </span>{</li><li>    Camera_PhotoOutput* photoOutput = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 无需传入surfaceId，直接创建拍照流。</span></li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_CameraManager_CreatePhotoOutputWithoutSurface</span>(cameraManager, photoProfile, &amp;photoOutput);</li><li>    <span class="hljs-keyword">if</span> (photoOutput == <span class="hljs-literal">nullptr</span> || ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreatePhotoOutputWithoutSurface failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> photoOutput;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>注册单段式(PhotoAvailable)拍照回调，若应用希望快速得到回图，推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-deferred-capture">分段式拍照回调(PhotoAssetAvailable)</a>。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>如果已经注册了PhotoAssetAvailable回调，并且在Session开始之后又注册了PhotoAvailable回调，PhotoAssetAvailable和PhotoAvailable同时注册，会导致流被重启，仅PhotoAssetAvailable生效。</p>         <p>不建议开发者同时注册PhotoAssetAvailable和PhotoAvailable。</p>        </div></div></div>       <p><strong>单段式拍照开发流程（PhotoAssetAvailable）</strong>：</p>       <ul>        <li>         <p>在会话commitConfig前注册单段式拍照回调。</p></li>        <li>         <p>在单段式拍照回调函数中获取图片信息，解析出buffer数据，做自定义业务处理。</p></li>        <li>         <p>将处理完的buffer通过回调传给ArkTS侧，做图片显示或通过安全控件写文件保存图片。</p></li>        <li>         <p>使用完后解注册单段式拍照回调函数。</p>         <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 保存NAPI侧注册的buffer处理回调函数。</span></li><li><span class="hljs-type">static</span> <span class="hljs-type">void</span>* bufferCb = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">RegisterBufferCb</span><span class="hljs-params">(<span class="hljs-type">void</span>* cb)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">" RegisterBufferCb start"</span>);</li><li>    <span class="hljs-keyword">if</span> (cb == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">" RegisterBufferCb invalid error"</span>);</li><li>        <span class="hljs-keyword">return</span> CAMERA_INVALID_ARGUMENT;</li><li>    }</li><li>    bufferCb = cb;</li><li>    <span class="hljs-keyword">return</span> CAMERA_OK;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 单段式拍照回调函数。</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnPhotoAvailable</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput, OH_PhotoNative* photo)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable start!"</span>);</li><li>    OH_ImageNative* imageNative;</li><li>    Camera_ErrorCode errCode = <span class="hljs-built_in">OH_PhotoNative_GetMainImage</span>(photo, &amp;imageNative);</li><li>    <span class="hljs-keyword">if</span> (errCode != CAMERA_OK || imageNative == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_PhotoNative_GetMainImage call failed, errorCode: %{public}d"</span>, errCode);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable errCode:%{public}d imageNative:%{public}p"</span>, errCode, imageNative);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的size属性。</span></li><li>    Image_Size size;</li><li>    Image_ErrorCode imageErr = <span class="hljs-built_in">OH_ImageNative_GetImageSize</span>(imageNative, &amp;size);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>         <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetImageSize call failed, errorCode: %{public}d"</span>, imageErr);</li><li>         <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>         <span class="hljs-keyword">return</span>;</li><li>     }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d width:%{public}d height:%{public}d"</span>, imageErr,</li><li>       size.width, size.height);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的组件列表的元素个数。</span></li><li>    <span class="hljs-type">size_t</span> componentTypeSize = <span class="hljs-number">0</span>;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetComponentTypes</span>(imageNative, <span class="hljs-literal">nullptr</span>, &amp;componentTypeSize);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS || componentTypeSize == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"cOH_ImageNative_GetComponentTypes call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d componentTypeSize:%{public}zu"</span>, imageErr,</li><li>       componentTypeSize);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的组件列表。</span></li><li>    <span class="hljs-type">uint32_t</span>* components = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">uint32_t</span>[componentTypeSize];</li><li>    <span class="hljs-keyword">if</span> (!components) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Failed to allocate memory"</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetComponentTypes</span>(imageNative, &amp;components, &amp;componentTypeSize);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetComponentTypes call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_ImageNative_GetComponentTypes imageErr:%{public}d"</span>, imageErr);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的第一个组件所对应的缓冲区对象。</span></li><li>    OH_NativeBuffer* nativeBuffer = <span class="hljs-literal">nullptr</span>;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetByteBuffer</span>(imageNative, components[<span class="hljs-number">0</span>], &amp;nativeBuffer);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetByteBuffer call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_ImageNative_GetByteBuffer imageErr:%{public}d"</span>, imageErr);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的第一个组件所对应的缓冲区大小。</span></li><li>    <span class="hljs-type">size_t</span> nativeBufferSize = <span class="hljs-number">0</span>;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetBufferSize</span>(imageNative, components[<span class="hljs-number">0</span>], &amp;nativeBufferSize);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetBufferSize call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d nativeBufferSize:%{public}zu"</span>, imageErr,</li><li>       nativeBufferSize);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的第一个组件所对应的像素行宽。</span></li><li>    <span class="hljs-type">int32_t</span> rowStride = <span class="hljs-number">0</span>;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetRowStride</span>(imageNative, components[<span class="hljs-number">0</span>], &amp;rowStride);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetRowStride call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d rowStride:%{public}d"</span>, imageErr, rowStride);</li><li>    <span class="hljs-comment">// 读取OH_ImageNative的第一个组件所对应的像素大小。</span></li><li>    <span class="hljs-type">int32_t</span> pixelStride = <span class="hljs-number">0</span>;</li><li>    imageErr = <span class="hljs-built_in">OH_ImageNative_GetPixelStride</span>(imageNative, components[<span class="hljs-number">0</span>], &amp;pixelStride);</li><li>    <span class="hljs-keyword">if</span> (imageErr != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetPixelStride call failed, errorCode: %{public}d"</span>, imageErr);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d pixelStride:%{public}d"</span>, imageErr, pixelStride);</li><li>    <span class="hljs-comment">// 将ION内存映射到进程空间。</span></li><li>    <span class="hljs-type">void</span>* virAddr = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 指向映射内存的虚拟地址，解除映射后这个指针将不再有效。</span></li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeBuffer_Map</span>(nativeBuffer, &amp;virAddr); <span class="hljs-comment">// 映射后通过第二个参数virAddr返回内存的首地址。</span></li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_NativeBuffer_Map call failed, errorCode: %{public}d"</span>, ret);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>        <span class="hljs-keyword">delete</span>[] components;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_NativeBuffer_Map err:%{public}d"</span>, ret);</li><li>    <span class="hljs-comment">// 调用NAPI层buffer回调。</span></li><li>    <span class="hljs-keyword">auto</span> cb = (<span class="hljs-built_in">void</span> (*)(<span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>))(bufferCb);</li><li>    <span class="hljs-keyword">if</span> (!virAddr || nativeBufferSize &lt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"On buffer callback failed"</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">cb</span>(virAddr, nativeBufferSize);</li><li>    <span class="hljs-comment">// 释放资源。</span></li><li>    <span class="hljs-keyword">delete</span>[] components;</li><li>    ret = <span class="hljs-built_in">OH_ImageNative_Release</span>(imageNative);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_Release call failed., errorCode: %{public}d"</span>, ret);</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_NativeBuffer_Unmap</span>(nativeBuffer); <span class="hljs-comment">// 在处理完之后，解除映射并释放缓冲区。</span></li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_NativeBuffer_Unmap call failed, errorCode: %{public}d"</span>, ret);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OnPhotoAvailable end"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 注册单段式拍照回调。</span></li><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">PhotoOutputRegisterPhotoAvailableCallback</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PhotoOutputRegisterPhotoAvailableCallback start!"</span>);</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_PhotoOutput_RegisterPhotoAvailableCallback</span>(photoOutput, OnPhotoAvailable);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"PhotoOutputRegisterPhotoAvailableCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PhotoOutputRegisterPhotoAvailableCallback return with ret code: %{public}d!"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解注册单段式拍照回调。</span></li><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">PhotoOutputUnRegisterPhotoAvailableCallback</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PhotoOutputUnRegisterPhotoAvailableCallback start!"</span>);</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_PhotoOutput_UnregisterPhotoAvailableCallback</span>(photoOutput, OnPhotoAvailable);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"PhotoOutputUnRegisterPhotoAvailableCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PhotoOutputUnRegisterPhotoAvailableCallback return with ret code: %{public}d!"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>         <p>NAPI层buffer回处理参考示例代码：</p>         <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">static</span> napi_ref bufferCbRef_ = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">static</span> napi_env env_;</li><li><span class="hljs-type">size_t</span> g_size = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// NAPI层buffer回调方法。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">BufferCb</span><span class="hljs-params">(<span class="hljs-type">void</span>* buffer, <span class="hljs-type">size_t</span> size)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"BufferCb size:%{public}zu"</span>, size);</li><li>    g_size = size;</li><li>    napi_value asyncResource = <span class="hljs-literal">nullptr</span>;</li><li>    napi_value asyncResourceName = <span class="hljs-literal">nullptr</span>;</li><li>    napi_async_work work;</li><li>
</li><li>    <span class="hljs-type">void</span>* copyBuffer = <span class="hljs-built_in">malloc</span>(size);</li><li>    <span class="hljs-keyword">if</span> (copyBuffer == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"BufferCb copyBuffer:%{public}p"</span>, copyBuffer);</li><li>    <span class="hljs-comment">// 使用std::memcpy复制buffer的内容到copyBuffer。</span></li><li>    std::<span class="hljs-built_in">memcpy</span>(copyBuffer, buffer, size);</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env_, <span class="hljs-string">"BufferCb"</span>, NAPI_AUTO_LENGTH, &amp;asyncResourceName);</li><li>    napi_status status = <span class="hljs-built_in">napi_create_async_work</span>(</li><li>        env_, asyncResource, asyncResourceName, [](napi_env env, <span class="hljs-type">void</span>* copyBuffer) {},</li><li>        [](napi_env env, napi_status status, <span class="hljs-type">void</span>* copyBuffer) {</li><li>            napi_value retVal;</li><li>            napi_value callback = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-type">void</span>* data = <span class="hljs-literal">nullptr</span>;</li><li>            napi_value arrayBuffer = <span class="hljs-literal">nullptr</span>;</li><li>            <span class="hljs-type">size_t</span> bufferSize = g_size;</li><li>            <span class="hljs-built_in">napi_create_arraybuffer</span>(env, bufferSize, &amp;data, &amp;arrayBuffer);</li><li>            std::<span class="hljs-built_in">memcpy</span>(data, copyBuffer, bufferSize);</li><li>            <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"BufferCb g_size: %{public}zu"</span>, g_size);</li><li>            <span class="hljs-built_in">napi_get_reference_value</span>(env, bufferCbRef_, &amp;callback);</li><li>            <span class="hljs-keyword">if</span> (callback) {</li><li>                <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"BufferCb callback is full"</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"BufferCb callback is null"</span>);</li><li>            }</li><li>            <span class="hljs-comment">// 调用ArkTS的buffer处理回调函数，将图片arrayBuffer传给页面做显示或保存。</span></li><li>            <span class="hljs-built_in">napi_call_function</span>(env, <span class="hljs-literal">nullptr</span>, callback, <span class="hljs-number">1</span>, &amp;arrayBuffer, &amp;retVal);</li><li>            <span class="hljs-comment">// 清理内存。</span></li><li>            <span class="hljs-built_in">free</span>(data); <span class="hljs-comment">// 释放在异步工作中分配的内存。</span></li><li>            <span class="hljs-built_in">free</span>(copyBuffer);</li><li>        },</li><li>        copyBuffer, &amp;work);</li><li>
</li><li>    <span class="hljs-comment">// 错误检查：创建异步工作失败时释放内存。</span></li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Failed to create async work"</span>);</li><li>        <span class="hljs-built_in">free</span>(copyBuffer); <span class="hljs-comment">// 释放分配的内存。</span></li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">napi_queue_async_work_with_qos</span>(env_, work, napi_qos_user_initiated);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 保存ArkTS侧传入的buffer处理回调函数。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetBufferCb</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"SetBufferCb start"</span>);</li><li>    napi_value result;</li><li>    <span class="hljs-built_in">napi_get_undefined</span>(env, &amp;result);</li><li>
</li><li>    napi_value argValue[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-type">size_t</span> argCount = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argCount, argValue, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    env_ = env;</li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, argValue[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, &amp;bufferCbRef_);</li><li>    <span class="hljs-keyword">if</span> (bufferCbRef_) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"SetBufferCb callbackRef is full"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"SetBufferCb callbackRef is null"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 注册ArkTS侧buffer回调到NAPI层。</span></li><li>    <span class="hljs-built_in">RegisterBufferCb</span>((<span class="hljs-type">void</span> *)BufferCb);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>创建拍照类型会话，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-session-management">会话管理(C/C++)</a>，开启会话，准备拍照。</p></li>      <li>       <p>配置拍照参数（可选）。</p>       <p>配置相机的参数可以调整拍照的一些功能，包括闪光灯、变焦、焦距等。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 判断设备是否支持闪光灯。</span></li><li>bool <span class="hljs-title function_">HasFlash</span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">bool</span> <span class="hljs-variable">hasFlash</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_HasFlash(captureSession, &amp;hasFlash);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_HasFlash failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (hasFlash) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"hasFlash success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"hasFlash fail"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> hasFlash;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 检测闪光灯模式是否支持。</span></li><li>bool <span class="hljs-title function_">IsFlashModeSupported</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_FlashMode flashMode)</span></li><li>{</li><li>    <span class="hljs-type">bool</span> <span class="hljs-variable">isSupported</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_IsFlashModeSupported(captureSession, flashMode, &amp;isSupported);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_IsFlashModeSupported failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> isSupported;</li><li>}</li><li><span class="hljs-comment">// 在支持flashMode的情况下进行调用OH_CaptureSession_SetFlashMode。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">SetFlashMode</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_FlashMode flashMode)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_SetFlashMode(captureSession, flashMode);</li><li>    <span class="hljs-keyword">if</span> (ret == CAMERA_OK) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFlashMode success."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFlashMode failed. %{public}d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 判断是否支持连续自动变焦模式。</span></li><li>bool <span class="hljs-title function_">IsFocusModeSupported</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_FocusMode focusMode)</span></li><li>{</li><li>    <span class="hljs-type">bool</span> <span class="hljs-variable">isFocusModeSupported</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_IsFocusModeSupported(captureSession, focusMode, &amp;isFocusModeSupported);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_IsFocusModeSupported failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> isFocusModeSupported;</li><li>}</li><li><span class="hljs-comment">// 在支持focusMode的情况下进行OH_CaptureSession_SetFocusMode。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">SetFocusMode</span><span class="hljs-params">(Camera_CaptureSession* captureSession, Camera_FocusMode focusMode)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_SetFocusMode(captureSession, focusMode);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFocusMode failed. %{public}d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取相机支持的可变焦距比范围。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">GetZoomRatioRange</span><span class="hljs-params">(Camera_CaptureSession* captureSession, <span class="hljs-type">float</span>* minZoom, <span class="hljs-type">float</span>* maxZoom)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_GetZoomRatioRange(captureSession, minZoom, maxZoom);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatioRange failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatioRange success. minZoom: %{public}f, maxZoom:%{public}f"</span>,</li><li>            *minZoom, *maxZoom);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置变焦，zoom需要在可变焦距比范围内。</span></li><li>Camera_ErrorCode <span class="hljs-title function_">SetZoomRatio</span><span class="hljs-params">(Camera_CaptureSession* captureSession, <span class="hljs-type">float</span> zoom)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_SetZoomRatio(captureSession, zoom);</li><li>    <span class="hljs-keyword">if</span> (ret == CAMERA_OK) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetZoomRatio success."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetZoomRatio failed. %{public}d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>触发拍照。</p>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-photo-output-h#oh_photooutput_capture" target="_blank">OH_PhotoOutput_Capture()</a>方法，执行拍照任务。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">Capture</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_PhotoOutput_Capture(photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == CAMERA_OK) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Capture success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Capture failed. %d "</span>, ret);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2>          <p>在相机应用开发过程中，可以随时监听拍照输出流状态，包括拍照流开始、拍照帧的开始与结束、拍照输出流的错误。</p>     <ul>      <li>       <p>通过注册固定的onFrameStart回调函数获取监听拍照开始结果，photoOutput创建成功时即可监听，拍照第一次曝光时触发。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">PhotoOutputOnFrameStart</span>(Camera_PhotoOutput* photoOutput)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "PhotoOutputOnFrameStart");</li><li>}</li><li>void <span class="hljs-built_in">PhotoOutputOnFrameShutter</span>(Camera_PhotoOutput* photoOutput, Camera_FrameShutterInfo* info)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "PhotoOutputOnFrameShutter");</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的onFrameEnd回调函数获取监听拍照结束结果，photoOutput创建成功时即可监听。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PhotoOutputOnFrameEnd</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput, <span class="hljs-type">int32_t</span> frameCount)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PhotoOutput frameCount = %{public}d"</span>, frameCount);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的onError回调函数获取监听拍照输出流的错误结果。callback返回拍照输出接口使用错误时的对应错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_errorcode" target="_blank">Camera_ErrorCode</a>。</p>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">PhotoOutputOnError</span>(Camera_PhotoOutput* photoOutput, Camera_ErrorCode errorCode)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "PhotoOutput errorCode = %{public}d", errorCode);</li><li>}</li></ol></pre></div></div>       <div _ngcontent-qsh-c106="" class="highlight-div"><div _ngcontent-qsh-c106="" class="highlight-div-header"><div _ngcontent-qsh-c106="" class="highlight-div-header-left"><div _ngcontent-qsh-c106="" class="handle-button expand-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qsh-c106="" class="highlight-div-header-right"><div _ngcontent-qsh-c106="" class="handle-button ai-button"></div><div _ngcontent-qsh-c106="" class="handle-button line-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qsh-c106="" class="handle-button theme-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qsh-c106="" class="handle-button copy-button"><div _ngcontent-qsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>PhotoOutput_Callbacks* GetPhotoOutputListener()</li><li>{</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">PhotoOutput_Callbacks</span> <span class="hljs-variable">photoOutputListener</span> <span class="hljs-operator">=</span> {</li><li>        .onFrameStart = PhotoOutputOnFrameStart,</li><li>        .onFrameShutter = PhotoOutputOnFrameShutter,</li><li>        .onFrameEnd = PhotoOutputOnFrameEnd,</li><li>        .onError = PhotoOutputOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;photoOutputListener;</li><li>}</li><li>Camera_ErrorCode <span class="hljs-title function_">RegisterPhotoOutputCallback</span><span class="hljs-params">(Camera_PhotoOutput* photoOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_PhotoOutput_RegisterCallback(photoOutput, GetPhotoOutputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_RegisterCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>