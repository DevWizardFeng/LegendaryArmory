<h1 _ngcontent-kku-c119="" class="doc-title ng-star-inserted" title="拍照实践(C/C++)"> 拍照实践(C/C++) </h1>

<div _ngcontent-kku-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p> <p>当前示例提供完整的拍照流程及其接口调用顺序的介绍。对于单个流程（如设备输入、会话管理、拍照）的介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-device-management">相机开发指导(Native)</a>的具体章节。</p>  <div class="tiledSection"><h2 id="开发流程">开发流程<i class="anchor-icon anchor-icon-link" anchorid="开发流程" tips="复制节点链接"></i></h2><p>在获取到相机支持的输出流能力后，开始创建拍照流，开发流程如下。</p> <p><span><img originheight="4096" originwidth="3588" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114429.04372422849201517735362180457818:50001231000000:2800:6B9738CD0B1DBBF53BC17F0C43B5474A14C870853F91D2269AA28E70F2B01A66.png" width="920" height="1050.2564102564102"></span></p> </div>  <div class="tiledSection"><h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2><ol><li><p>在CMake脚本中链接相关动态库。</p>  <div _ngcontent-kku-c106="" class="highlight-div"><div _ngcontent-kku-c106="" class="highlight-div-header"><div _ngcontent-kku-c106="" class="highlight-div-header-left"><div _ngcontent-kku-c106="" class="handle-button expand-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kku-c106="" class="highlight-div-header-right"><div _ngcontent-kku-c106="" class="handle-button ai-button"></div><div _ngcontent-kku-c106="" class="handle-button line-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kku-c106="" class="handle-button theme-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kku-c106="" class="handle-button copy-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kku-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libhilog_ndk.z.so</li><li>    libnative_buffer.so</li><li>    libohcamera.so</li><li>    libohimage.so</li><li>    libohfileuri.so</li><li>)</li></ol></pre></div></div>  </li><li><p>创建头文件ndk_camera.h。</p>  <div _ngcontent-kku-c106="" class="highlight-div"><div _ngcontent-kku-c106="" class="highlight-div-header"><div _ngcontent-kku-c106="" class="highlight-div-header-left"><div _ngcontent-kku-c106="" class="handle-button expand-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kku-c106="" class="highlight-div-header-right"><div _ngcontent-kku-c106="" class="handle-button ai-button"></div><div _ngcontent-kku-c106="" class="handle-button line-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kku-c106="" class="handle-button theme-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kku-c106="" class="handle-button copy-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kku-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NDKCamera</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    ~<span class="hljs-built_in">NDKCamera</span>();</li><li>    <span class="hljs-built_in">NDKCamera</span>(<span class="hljs-type">char</span>* previewId);</li><li>    <span class="hljs-function">Camera_ErrorCode <span class="hljs-title">RegisterBufferCb</span><span class="hljs-params">(<span class="hljs-type">void</span>* cb)</span></span>;</li><li>};</li></ol></pre></div></div>  </li><li><p>cpp侧导入NDK接口，并根据传入的SurfaceId进行拍照。</p>  <div _ngcontent-kku-c106="" class="highlight-div"><div _ngcontent-kku-c106="" class="highlight-div-header"><div _ngcontent-kku-c106="" class="highlight-div-header-left"><div _ngcontent-kku-c106="" class="handle-button expand-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kku-c106="" class="highlight-div-header-right"><div _ngcontent-kku-c106="" class="handle-button ai-button"></div><div _ngcontent-kku-c106="" class="handle-button line-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kku-c106="" class="handle-button theme-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kku-c106="" class="handle-button copy-button"><div _ngcontent-kku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kku-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li>
</li><li><span class="hljs-type">void</span> CaptureSessionOnFocusStateChange(Camera_CaptureSession* session, Camera_FocusState focusState)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSessionOnFocusStateChange"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> CaptureSessionOnError(Camera_CaptureSession* session, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CaptureSessionOnError = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>CaptureSession_Callbacks* GetCaptureSessionRegister(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> CaptureSession_Callbacks captureSessionCallbacks = {</li><li>        .onFocusStateChange = CaptureSessionOnFocusStateChange,</li><li>        .onError = CaptureSessionOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;captureSessionCallbacks;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> PreviewOutputOnFrameStart(Camera_PreviewOutput* previewOutput)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"PreviewOutputOnFrameStart"</span>);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> PreviewOutputOnFrameEnd(Camera_PreviewOutput* previewOutput, int32_t frameCount)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"PreviewOutputOnFrameEnd = %{public}d"</span>, frameCount);</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> PreviewOutputOnError(Camera_PreviewOutput* previewOutput, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"PreviewOutputOnError = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>PreviewOutput_Callbacks* GetPreviewOutputListener(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> PreviewOutput_Callbacks previewOutputListener = {</li><li>        .onFrameStart = PreviewOutputOnFrameStart,</li><li>        .onFrameEnd = PreviewOutputOnFrameEnd,</li><li>        .onError = PreviewOutputOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;previewOutputListener;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> OnCameraInputError(<span class="hljs-keyword">const</span> Camera_Input* cameraInput, Camera_ErrorCode errorCode)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnCameraInput errorCode = %{public}d"</span>, errorCode);</li><li>}</li><li>
</li><li>CameraInput_Callbacks* GetCameraInputListener(<span class="hljs-type">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> CameraInput_Callbacks cameraInputCallbacks = {</li><li>        .onError = OnCameraInputError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;cameraInputCallbacks;</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> CameraManagerStatusCallback(Camera_Manager* cameraManager, Camera_StatusInfo* status)</li><li>{</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"CameraManagerStatusCallback is called"</span>);</li><li>}</li><li>
</li><li>CameraManager_Callbacks* GetCameraManagerListener()</li><li>{</li><li>    <span class="hljs-keyword">static</span> CameraManager_Callbacks cameraManagerListener = {</li><li>        .onCameraStatus = CameraManagerStatusCallback</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;cameraManagerListener;</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-type">void</span>* bufferCb = nullptr;</li><li>Camera_ErrorCode NDKCamera::RegisterBufferCb(<span class="hljs-type">void</span>* cb) {</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">" RegisterBufferCb start"</span>);</li><li>    <span class="hljs-keyword">if</span> (cb == nullptr) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">" RegisterBufferCb invalid error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">CAMERA_INVALID_ARGUMENT</span>;</li><li>    }</li><li>    bufferCb = cb;</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">CAMERA_OK</span>;</li><li>}</li><li><span class="hljs-type">void</span> OnPhotoAvailable(Camera_PhotoOutput* photoOutput, OH_PhotoNative* photo) {</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable start!"</span>);</li><li>    OH_ImageNative* imageNative;</li><li>    Camera_ErrorCode errCode = OH_PhotoNative_GetMainImage(photo, &amp;imageNative);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable errCode:%{public}d imageNative:%{public}p"</span>, errCode, imageNative);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的 size 属性。</span></li><li>    Image_Size size;</li><li>    Image_ErrorCode imageErr = OH_ImageNative_GetImageSize(imageNative, &amp;size);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d width:%{public}d height:%{public}d"</span>, imageErr,</li><li>        size.width, size.height);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的组件列表的元素个数。</span></li><li>    size_t componentTypeSize = <span class="hljs-number">0</span>;</li><li>    imageErr = OH_ImageNative_GetComponentTypes(imageNative, nullptr, &amp;componentTypeSize);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d componentTypeSize:%{public}zu"</span>, imageErr,</li><li>        componentTypeSize);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的组件列表。</span></li><li>    uint32_t* components = new uint32_t[componentTypeSize];</li><li>    imageErr = OH_ImageNative_GetComponentTypes(imageNative, &amp;components, &amp;componentTypeSize);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_ImageNative_GetComponentTypes imageErr:%{public}d"</span>, imageErr);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的缓冲区对象。</span></li><li>    OH_NativeBuffer* nativeBuffer = nullptr;</li><li>    imageErr = OH_ImageNative_GetByteBuffer(imageNative, components[<span class="hljs-number">0</span>], &amp;nativeBuffer);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_ImageNative_GetByteBuffer imageErr:%{public}d"</span>, imageErr);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的缓冲区大小。</span></li><li>    size_t nativeBufferSize = <span class="hljs-number">0</span>;</li><li>    imageErr = OH_ImageNative_GetBufferSize(imageNative, components[<span class="hljs-number">0</span>], &amp;nativeBufferSize);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d nativeBufferSize:%{public}zu"</span>, imageErr,</li><li>         nativeBufferSize);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的像素行宽。</span></li><li>    int32_t rowStride = <span class="hljs-number">0</span>;</li><li>    imageErr = OH_ImageNative_GetRowStride(imageNative, components[<span class="hljs-number">0</span>], &amp;rowStride);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d rowStride:%{public}d"</span>, imageErr, rowStride);</li><li>    <span class="hljs-comment">// 读取 OH_ImageNative 的第一个组件所对应的像素大小。</span></li><li>    int32_t pixelStride = <span class="hljs-number">0</span>;</li><li>    imageErr = OH_ImageNative_GetPixelStride(imageNative, components[<span class="hljs-number">0</span>], &amp;pixelStride);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable imageErr:%{public}d pixelStride:%{public}d"</span>, imageErr, pixelStride);</li><li>    <span class="hljs-comment">// 将ION内存映射到进程空间。</span></li><li>    <span class="hljs-type">void</span>* virAddr = nullptr; <span class="hljs-comment">// 指向映射内存的虚拟地址，解除映射后这个指针将不再有效。</span></li><li>    int32_t ret = OH_NativeBuffer_Map(nativeBuffer, &amp;virAddr); <span class="hljs-comment">// 映射后通过第二个参数virAddr返回内存的首地址。</span></li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_NativeBuffer_Map err:%{public}d"</span>, ret);</li><li>    <span class="hljs-comment">// 通过回调函数，将处理完的buffer传给ArkTS侧做显示或通过安全控件写文件保存，参考拍照(C/C++)开发指导。</span></li><li>    <span class="hljs-keyword">if</span> (bufferCb == nullptr) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"Current buffercb invalid error"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    auto cb = (<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span> *, size_t))(bufferCb);</li><li>    cb(virAddr, nativeBufferSize);</li><li>    <span class="hljs-comment">// 在处理完之后，解除映射并释放缓冲区。</span></li><li>    ret = OH_NativeBuffer_Unmap(nativeBuffer);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OnPhotoAvailable OH_NativeBuffer_Unmap error:%{public}d"</span>, ret);</li><li>    }</li><li>}</li><li>
</li><li>NDKCamera::NDKCamera(<span class="hljs-type">char</span>* previewId)</li><li>{</li><li>    Camera_Manager* cameraManager = nullptr;</li><li>    Camera_Device* cameras = nullptr;</li><li>    Camera_CaptureSession* captureSession = nullptr;</li><li>    Camera_OutputCapability* cameraOutputCapability = nullptr;</li><li>    <span class="hljs-keyword">const</span> Camera_Profile* previewProfile = nullptr;</li><li>    <span class="hljs-keyword">const</span> Camera_Profile* photoProfile = nullptr;</li><li>    Camera_PreviewOutput* previewOutput = nullptr;</li><li>    Camera_PhotoOutput* photoOutput = nullptr;</li><li>    Camera_Input* cameraInput = nullptr;</li><li>    uint32_t size = <span class="hljs-number">0</span>;</li><li>    uint32_t cameraDeviceIndex = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">char</span>* previewSurfaceId = previewId;</li><li>    <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>    Camera_ErrorCode ret = OH_Camera_GetCameraManager(&amp;cameraManager);</li><li>    <span class="hljs-keyword">if</span> (cameraManager == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_Camera_GetCameraMananger failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 监听相机状态变化。</span></li><li>    ret = OH_CameraManager_RegisterCallback(cameraManager, GetCameraManagerListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机列表。</span></li><li>    ret = OH_CameraManager_GetSupportedCameras(cameraManager, &amp;cameras, &amp;size);</li><li>    <span class="hljs-keyword">if</span> (cameras == nullptr || size &lt;= <span class="hljs-number">0</span> || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_GetSupportedCameras failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (size &lt; cameraDeviceIndex + <span class="hljs-number">1</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"cameraDeviceIndex is invalid."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建相机输入流。</span></li><li>    ret = OH_CameraManager_CreateCameraInput(cameraManager, &amp;cameras[cameraDeviceIndex], &amp;cameraInput);</li><li>    <span class="hljs-keyword">if</span> (cameraInput == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateCameraInput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 监听cameraInput错误信息。</span></li><li>    ret = OH_CameraInput_RegisterCallback(cameraInput, GetCameraInputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_RegisterCallback failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 打开相机。</span></li><li>    ret = OH_CameraInput_Open(cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_Open failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机设备支持的输出流能力。</span></li><li>    ret = OH_CameraManager_GetSupportedCameraOutputCapability(cameraManager, &amp;cameras[cameraDeviceIndex],</li><li>                                                              &amp;cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_GetSupportedCameraOutputCapability failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability-&gt;previewProfiles == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"previewProfiles == null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 根据所需从cameraOutputCapability-&gt;previewProfiles中选择合适的预览分辨率</span></li><li>    previewProfile = cameraOutputCapability-&gt;previewProfiles[<span class="hljs-number">0</span>];</li><li>
</li><li>    <span class="hljs-keyword">if</span> (cameraOutputCapability-&gt;photoProfiles == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"photoProfiles == null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 根据所需从cameraOutputCapability-&gt;photoProfiles中选择合适的拍照分辨率</span></li><li>    photoProfile = cameraOutputCapability-&gt;photoProfiles[<span class="hljs-number">0</span>];</li><li>
</li><li>    <span class="hljs-comment">// 创建预览输出流,其中参数 previewSurfaceId 参考上文 XComponent 组件，预览流为XComponent组件提供的surface。</span></li><li>    ret = OH_CameraManager_CreatePreviewOutput(cameraManager, previewProfile, previewSurfaceId, &amp;previewOutput);</li><li>    <span class="hljs-keyword">if</span> (previewProfile == nullptr || previewOutput == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreatePreviewOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 监听预览输出错误信息。</span></li><li>    ret = OH_PreviewOutput_RegisterCallback(previewOutput, GetPreviewOutputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建拍照输出流。</span></li><li>    ret = OH_CameraManager_CreatePhotoOutputWithoutSurface(cameraManager, photoProfile, &amp;photoOutput);</li><li>
</li><li>    <span class="hljs-comment">// 监听单端式拍照回调。</span></li><li>    ret = OH_PhotoOutput_RegisterPhotoAvailableCallback(photoOutput, OnPhotoAvailable);</li><li>
</li><li>    <span class="hljs-comment">//创建会话。</span></li><li>    ret = OH_CameraManager_CreateCaptureSession(cameraManager, &amp;captureSession);</li><li>    <span class="hljs-keyword">if</span> (captureSession == nullptr || ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreateCaptureSession failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 监听session错误信息。</span></li><li>    ret = OH_CaptureSession_RegisterCallback(captureSession, GetCaptureSessionRegister());</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_RegisterCallback failed."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 开始配置会话。</span></li><li>    ret = OH_CaptureSession_BeginConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_BeginConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加相机输入流。</span></li><li>    ret = OH_CaptureSession_AddInput(captureSession, cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddInput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加预览输出流。</span></li><li>    ret = OH_CaptureSession_AddPreviewOutput(captureSession, previewOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddPreviewOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加拍照输出流。</span></li><li>    ret = OH_CaptureSession_AddPhotoOutput(captureSession, photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_AddPhotoOutput failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 提交会话配置。</span></li><li>    ret = OH_CaptureSession_CommitConfig(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_CommitConfig failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动会话。</span></li><li>    ret = OH_CaptureSession_Start(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Start failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 判断设备是否支持闪光灯。</span></li><li>    Camera_FlashMode flashMode = FLASH_MODE_AUTO;</li><li>    <span class="hljs-type">bool</span> hasFlash = <span class="hljs-literal">false</span>;</li><li>    ret = OH_CaptureSession_HasFlash(captureSession, &amp;hasFlash);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_HasFlash failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (hasFlash) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"hasFlash success"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"hasFlash fail"</span>);</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 检测闪光灯模式是否支持。</span></li><li>    <span class="hljs-type">bool</span> isSupported = <span class="hljs-literal">false</span>;</li><li>    ret = OH_CaptureSession_IsFlashModeSupported(captureSession, flashMode, &amp;isSupported);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_IsFlashModeSupported failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (isSupported) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"isFlashModeSupported success"</span>);</li><li>
</li><li>        <span class="hljs-comment">// 设置闪光灯模式。</span></li><li>        ret = OH_CaptureSession_SetFlashMode(captureSession, flashMode);</li><li>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFlashMode success."</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFlashMode failed. ret : %{public}d "</span>, ret);</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 获取当前设备的闪光灯模式。</span></li><li>        ret = OH_CaptureSession_GetFlashMode(captureSession, &amp;flashMode);</li><li>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetFlashMode success. flashMode：%{public}d "</span>, flashMode);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetFlashMode failed. ret : %{public}d "</span>, ret);</li><li>        }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"isFlashModeSupported fail"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 判断是否支持连续自动变焦模式。</span></li><li>    Camera_FocusMode focusMode = FOCUS_MODE_CONTINUOUS_AUTO;</li><li>    <span class="hljs-type">bool</span> isFocusModeSupported = <span class="hljs-literal">false</span>;</li><li>    ret = OH_CaptureSession_IsFocusModeSupported(captureSession, focusMode, &amp;isFocusModeSupported);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_IsFocusModeSupported failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (isFocusModeSupported) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"isFocusModeSupported success"</span>);</li><li>        ret = OH_CaptureSession_SetFocusMode(captureSession, focusMode);</li><li>        <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetFocusMode failed. ret : %{public}d "</span>, ret);</li><li>        }</li><li>        ret = OH_CaptureSession_GetFocusMode(captureSession, &amp;focusMode);</li><li>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>            OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetFocusMode success. focusMode%{public}d "</span>, focusMode);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetFocusMode failed. ret : %{public}d "</span>, ret);</li><li>        }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"isFocusModeSupported fail"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机支持的可变焦距比范围。</span></li><li>    <span class="hljs-type">float</span> minZoom;</li><li>    <span class="hljs-type">float</span> maxZoom;</li><li>    ret = OH_CaptureSession_GetZoomRatioRange(captureSession, &amp;minZoom, &amp;maxZoom);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatioRange failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatioRange success. minZoom: %{public}f, maxZoom:%{public}f"</span>,</li><li>            minZoom, maxZoom);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置变焦。</span></li><li>    ret = OH_CaptureSession_SetZoomRatio(captureSession, maxZoom);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetZoomRatio success."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_SetZoomRatio failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取当前设备的变焦值。</span></li><li>    ret = OH_CaptureSession_GetZoomRatio(captureSession, &amp;maxZoom);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatio success. zoom：%{public}f "</span>, maxZoom);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_GetZoomRatio failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 无拍照设置进行拍照。</span></li><li>    ret = OH_PhotoOutput_Capture(photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Capture success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Capture failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 停止当前会话。</span></li><li>    ret = OH_CaptureSession_Stop(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放相机输入流。</span></li><li>    ret = OH_CameraInput_Close(cameraInput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CameraInput_Close success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraInput_Close failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放预览输出流。</span></li><li>    ret = OH_PreviewOutput_Release(previewOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_Release failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放拍照输出流。</span></li><li>    ret = OH_PhotoOutput_Release(photoOutput);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>      OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PhotoOutput_Release failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    ret = OH_CaptureSession_Release(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Release success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Release failed. ret : %{public}d "</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 资源释放。</span></li><li>    ret = OH_CameraManager_DeleteSupportedCameras(cameraManager, cameras, size);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_DeleteSupportedCameras. ok"</span>);</li><li>    }</li><li>    ret = OH_CameraManager_DeleteSupportedCameraOutputCapability(cameraManager, cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_DeleteSupportedCameraOutputCapability. ok"</span>);</li><li>    }</li><li>    ret = OH_Camera_DeleteCameraManager(cameraManager);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">CAMERA_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Delete Cameras failed."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_Camera_DeleteCameraManager. ok"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>