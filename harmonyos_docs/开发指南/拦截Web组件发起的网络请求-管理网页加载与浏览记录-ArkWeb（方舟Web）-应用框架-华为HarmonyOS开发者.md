<h1 _ngcontent-pxl-c119="" class="doc-title ng-star-inserted" title="拦截Web组件发起的网络请求"> 拦截Web组件发起的网络请求 </h1>

<div _ngcontent-pxl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest</a>拦截Web组件发起的网络请求，也可以通过SchemeHandler来拦截Web组件发起的网络请求。SchemeHandler提供了ArkTS与NDK两套接口。</p>    <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">      <ul>       <li>onInterceptRequest接口中无法获取Post Data，如果想要获取Post Data需使用SchemeHandler机制来进行拦截。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="网络请求拦截处理-oninterceptrequest接口">网络请求拦截处理 (onInterceptRequest接口)<i class="anchor-icon anchor-icon-link" anchorid="网络请求拦截处理-oninterceptrequest接口" tips="复制节点链接"></i></h2>          <p>通过onInterceptRequest接口拦截Web组件发起的网络请求可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-resource-interception-request-mgmt">自定义页面请求响应</a>。</p>    </div>    <div class="tiledSection">     <h2 id="网络请求拦截处理-schemehandler机制">网络请求拦截处理 (SchemeHandler机制)<i class="anchor-icon anchor-icon-link" anchorid="网络请求拦截处理-schemehandler机制" tips="复制节点链接"></i></h2>          <p>通过SchemeHandler机制来拦截Web组件发起的网络请求。</p>    </div>    <div class="tiledSection">     <h3 id="为web组件设置schemehandler" class="firsth2">为Web组件设置SchemeHandler<i class="anchor-icon anchor-icon-link" anchorid="为web组件设置schemehandler" tips="复制节点链接"></i></h3>          <p>ArkWeb支持通过SchemeHandler拦截Web组件或者ServiceWorker发出的HTTP(s)及自定义协议的请求。</p>     <p>当Web内核发出相应scheme请求时，会触发为该scheme设置的SchemeHandler的回调。SchemeHandler包含请求开始与请求结束两个回调，应用需要在请求开始的回调中告知Web内核是否进行拦截，在请求结束后清理相关的资源，避免内存泄漏。</p>     <p>请求开始的回调：</p>     <p>NDK：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#arkweb_onrequeststart" target="_blank">ArkWeb_OnRequestStart</a></p>     <p>ArkTS：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler#onrequeststart12" target="_blank">onRequestStart</a></p>     <p>请求结束的回调：</p>     <p>NDK：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#arkweb_onrequeststop" target="_blank">ArkWeb_OnRequestStop</a></p>     <p>ArkTS：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler#onrequeststop12" target="_blank">onRequestStop</a></p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>需要在Web组件初始化之后设置SchemeHandler，否则会设置失败。</li>        <li>若想要拦截Web组件发出的第一个请求，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#initializewebengine" target="_blank">initializeWebEngine</a>方法提前进行Web组件初始化，再设置SchemeHandler实现拦截。详细代码请参考<a href="/consumer/cn/doc/harmonyos-guides/web-scheme-handler#完整示例">完整示例</a>。</li>       </ul>      </div></div></div>     <p>在C++中，通过NDK接口为Web组件设置SchemeHandler：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// 创建一个ArkWeb_SchemeHandler对象。</span></li><li>  ArkWeb_SchemeHandler *schemeHandler;</li><li>  <span class="hljs-built_in">OH_ArkWeb_CreateSchemeHandler</span>(&amp;schemeHandler);</li><li>
</li><li>  <span class="hljs-comment">// 为ArkWeb_SchemeHandler设置ArkWeb_OnRequestStart与ArkWeb_OnRequestStop回调。</span></li><li>  <span class="hljs-built_in">OH_ArkWebSchemeHandler_SetOnRequestStart</span>(schemeHandler, OnURLRequestStart);</li><li>  <span class="hljs-built_in">OH_ArkWebSchemeHandler_SetOnRequestStop</span>(schemeHandler, OnURLRequestStop);</li><li>
</li><li>  <span class="hljs-comment">// 拦截webTag为“scheme-handler”的Web组件发出的scheme为“https”的请求。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_SetSchemeHandler</span>("https", "scheme-handler", schemeHandler);</li><li>  <span class="hljs-built_in">OH_ArkWebServiceWorker_SetSchemeHandler</span>("https", schemeHandler);</li><li>
</li><li>  <span class="hljs-comment">// 拦截webTag为“scheme-handler”的Web组件发出的scheme为“custom”的请求。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_SetSchemeHandler</span>("custom", "scheme-handler", schemeHandler);</li><li>  <span class="hljs-built_in">OH_ArkWebServiceWorker_SetSchemeHandler</span>("custom", schemeHandler);</li></ol></pre></div></div>     <p>在ArkTS中，为Web组件设置SchemeHandler：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// 初始化WebView控制器和Scheme处理器。</span></li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">schemeHandler</span>: webview.<span class="hljs-property">WebSchemeHandler</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebSchemeHandler</span>();</li><li>  <span class="hljs-comment">// 为当前Web组件设置SchemeHandler。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setWebSchemeHandler</span>(<span class="hljs-string">'https'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeHandler</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置自定义scheme需要遵循的规则">设置自定义scheme需要遵循的规则<i class="anchor-icon anchor-icon-link" anchorid="设置自定义scheme需要遵循的规则" tips="复制节点链接"></i></h3>          <p>如果要拦截自定义scheme的请求，需要在Web组件初始化之前将自定义scheme注册到Web内核，初始化后再注册会失败。</p>     <p>Web组件的创建会触发Web内核的初始化。另外ArkWeb还提供了initializeWebEngine接口，用于单独进行Web初始化。</p>     <p>在NDK中可以在ets侧先调用testNapi.registerCustomSchemes注册自定义协议，然后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#initializewebengine" target="_blank">initializeWebEngine</a>初始化Web内核，示例如下：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>      <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>          <span class="hljs-comment">// 注册scheme的配置。</span></li><li>          testNapi.<span class="hljs-title function_">registerCustomSchemes</span>();</li><li>          <span class="hljs-comment">// 初始化Web组件内核，该操作会初始化Browser进程以及创建BrowserContext。</span></li><li>          webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">initializeWebEngine</span>();</li><li>          <span class="hljs-comment">// 创建并设置ArkWeb_SchemeHandler。</span></li><li>          testNapi.<span class="hljs-title function_">setSchemeHandler</span>();</li><li>      }</li><li>      ...</li><li>  };</li></ol></pre></div></div>     <p>testNapi.registerCustomSchemes的C++实现：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// 注册“custom“ scheme到Web组件，并指定该scheme需要遵循标准的scheme规则，允许该scheme发出跨域请求。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_RegisterCustomSchemes</span>("custom", ARKWEB_SCHEME_OPTION_STANDARD | ARKWEB_SCHEME_OPTION_CORS_ENABLED);</li><li>  <span class="hljs-comment">// 注册“custom-local” scheme到Web组件，并指定该scheme需要遵循与“file” scheme一样的规则。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_RegisterCustomSchemes</span>("custom-local", ARKWEB_SCHEME_OPTION_LOCAL);</li><li>  <span class="hljs-comment">// 注册“custom-csp-bypassing”到Web组件，并指定该scheme需要遵循标准的scheme规则，允许忽略CSP检查。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_RegisterCustomSchemes</span>("custom-csp-bypassing", ARKWEB_SCHEME_OPTION_CSP_BYPASSING | ARKWEB_SCHEME_OPTION_STANDARD);</li><li>  <span class="hljs-comment">// 注册“custom-isolated”到Web组件，并指定该scheme的请求必须从相同scheme加载的网页中发起。</span></li><li>  <span class="hljs-built_in">OH_ArkWeb_RegisterCustomSchemes</span>("custom-isolated", ARKWEB_SCHEME_OPTION_DISPLAY_ISOLATED);</li></ol></pre></div></div>     <p>在ArkTS中可以通过customizeSchemes注册自定义协议，示例如下：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// xxx.ets</span></li><li>  <span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>  <span class="hljs-meta">@Entry</span></li><li>  <span class="hljs-meta">@Component</span></li><li>  struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">responseWeb</span>: <span class="hljs-title class_">WebResourceResponse</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebResourceResponse</span>();</li><li>  <span class="hljs-attr">scheme1</span>: webview.<span class="hljs-property">WebCustomScheme</span> = { <span class="hljs-attr">schemeName</span>: <span class="hljs-string">"name1"</span>, <span class="hljs-attr">isSupportCORS</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">isSupportFetch</span>: <span class="hljs-literal">true</span> };</li><li>  <span class="hljs-attr">scheme2</span>: webview.<span class="hljs-property">WebCustomScheme</span> = { <span class="hljs-attr">schemeName</span>: <span class="hljs-string">"name2"</span>, <span class="hljs-attr">isSupportCORS</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">isSupportFetch</span>: <span class="hljs-literal">true</span> };</li><li>  <span class="hljs-attr">scheme3</span>: webview.<span class="hljs-property">WebCustomScheme</span> = { <span class="hljs-attr">schemeName</span>: <span class="hljs-string">"name3"</span>, <span class="hljs-attr">isSupportCORS</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">isSupportFetch</span>: <span class="hljs-literal">true</span> };</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>      <span class="hljs-keyword">try</span> {</li><li>      webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">customizeSchemes</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">scheme1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheme2</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheme3</span>]);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>      }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>          .<span class="hljs-title function_">onInterceptRequest</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (event) {</li><li>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'url:'</span> + event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getRequestUrl</span>());</li><li>          }</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>;</li><li>          })</li><li>      }</li><li>    }</li><li>  }</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="获取被拦截请求的信息">获取被拦截请求的信息<i class="anchor-icon anchor-icon-link" anchorid="获取被拦截请求的信息" tips="复制节点链接"></i></h3>          <p>在请求开始的回调中，应用可以获取请求的基本信息包括url、method、referrer、request headers、resource type、post data等。支持获取PUT/POST类请求的上传数据，数据类型支持BYTES、FILE、BLOB和CHUNKED。</p>     <p>在NDK中，获取被拦截请求的信息：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-type">char</span>* url;</li><li>  <span class="hljs-built_in">OH_ArkWebResourceRequest_GetUrl</span>(resourceRequest_, &amp;url);</li><li>  <span class="hljs-built_in">OH_ArkWeb_ReleaseString</span>(url);</li><li>
</li><li>  <span class="hljs-type">char</span>* method;</li><li>  <span class="hljs-built_in">OH_ArkWebResourceRequest_GetMethod</span>(resourceRequest_, &amp;method);</li><li>  <span class="hljs-built_in">OH_ArkWeb_ReleaseString</span>(method);</li><li>
</li><li>  <span class="hljs-type">int32_t</span> resourceType = <span class="hljs-built_in">OH_ArkWebResourceRequest_GetResourceType</span>(resourceRequest_);</li><li>
</li><li>  <span class="hljs-type">char</span>* frameUrl;</li><li>  <span class="hljs-built_in">OH_ArkWebResourceRequest_GetFrameUrl</span>(resourceRequest_, &amp;frameUrl);</li><li>  <span class="hljs-built_in">OH_ArkWeb_ReleaseString</span>(frameUrl);</li><li>
</li><li>  <span class="hljs-comment">// 获取被拦截请求的上传数据。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResourceRequest_GetHttpBodyStream</span>(<span class="hljs-built_in">resourceRequest</span>(), &amp;stream_);</li><li>  <span class="hljs-comment">// 设置读取上传数据的读回调。</span></li><li>  <span class="hljs-built_in">OH_ArkWebHttpBodyStream_SetReadCallback</span>(stream_, ReadCallback);</li><li>  <span class="hljs-comment">// 初始化ArkWeb_HttpBodyStream，其它OH_ArkWebHttpBodyStream*函数需要在初始化进行调用。</span></li><li>  <span class="hljs-built_in">OH_ArkWebHttpBodyStream_Init</span>(stream_, InitCallback);</li></ol></pre></div></div>     <p>在ArkTS中，获取被拦截请求的信息：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeHandler</span>.<span class="hljs-title function_">onRequestStart</span>(<span class="hljs-function">(<span class="hljs-params">request: webview.WebSchemeHandlerRequest, resourceHandler: webview.WebResourceHandler</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart url:"</span> + request.<span class="hljs-title function_">getRequestUrl</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart method:"</span> + request.<span class="hljs-title function_">getRequestMethod</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart referrer:"</span> + request.<span class="hljs-title function_">getReferrer</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart isMainFrame:"</span> + request.<span class="hljs-title function_">isMainFrame</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart hasGesture:"</span> + request.<span class="hljs-title function_">hasGesture</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart header size:"</span> + request.<span class="hljs-title function_">getHeader</span>().<span class="hljs-property">length</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart resource type:"</span> + request.<span class="hljs-title function_">getRequestResourceType</span>());</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart frame url:"</span> + request.<span class="hljs-title function_">getFrameUrl</span>());</li><li>    <span class="hljs-keyword">let</span> header = request.<span class="hljs-title function_">getHeader</span>();</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; header.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart header:"</span> + header[i].<span class="hljs-property">headerKey</span> + <span class="hljs-string">" "</span> + header[i].<span class="hljs-property">headerValue</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> stream = request.<span class="hljs-title function_">getHttpBodyStream</span>();</li><li>    <span class="hljs-keyword">if</span> (stream) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart has http body stream"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[schemeHandler] onRequestStart has no http body stream"</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>})</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="拦截web内核的请求并为被拦截的请求提供自定义的响应信息">拦截Web内核的请求，并为被拦截的请求提供自定义的响应信息<i class="anchor-icon anchor-icon-link" anchorid="拦截web内核的请求并为被拦截的请求提供自定义的响应信息" tips="复制节点链接"></i></h3>          <p>网络拦截支持在worker线程以流方式为被拦截的请求提供自定义的响应信息。也可用特定的网络错误码结束当前被拦截的请求。</p>     <p>错误码定义：</p>     <p>NDK：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-net-error-list-h" target="_blank">网络错误码(arkweb_net_error_list.h)</a>。</p>     <p>ArkTS：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-neterrorlist" target="_blank">网络错误码(@ohos.web.netErrorList.d.ts)</a>。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <ul>        <li>ArkWeb不支持自定义错误码，请使用ArkWeb提供的错误码来结束请求。</li>       </ul>      </div></div></div>     <p>在NDK中，为被拦截的请求提供自定义的响应信息：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// 为被拦截的请求创建一个响应头。</span></li><li>  ArkWeb_Response *response;</li><li>  <span class="hljs-built_in">OH_ArkWeb_CreateResponse</span>(&amp;response);</li><li>
</li><li>  <span class="hljs-comment">// 设置HTTP状态码为200。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResponse_SetStatus</span>(response, <span class="hljs-number">200</span>);</li><li>  <span class="hljs-comment">// 设置响应头中的字符集，指明内容使用UTF-8编码。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResponse_SetCharset</span>(response, "UTF-<span class="hljs-number">8</span>");</li><li>  <span class="hljs-comment">// 设置响应头中的"content-length"，指明响应体的大小。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResponse_SetHeaderByName</span>(response, "content-length", "<span class="hljs-number">1024</span>", false);</li><li>  <span class="hljs-comment">// 将为被拦截的请求创建的响应头传递给Web组件。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResourceHandler_DidReceiveResponse</span>(resourceHandler, response);</li><li>
</li><li>  <span class="hljs-comment">// 该函数可以调用多次，数据可以分多份来传递给Web组件。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResourceHandler_DidReceiveData</span>(resourceHandler, buffer, bufLen);</li><li>
</li><li>  <span class="hljs-comment">// 读取响应体结束，当然如果希望该请求失败的话也可以通过调用OH_ArkWebResourceHandler_DidFailWithError(resourceHandler_, errorCode);</span></li><li>  <span class="hljs-comment">// 传递给Web组件一个错误码并结束该请求。</span></li><li>  <span class="hljs-built_in">OH_ArkWebResourceHandler_DidFinish</span>(resourceHandler);</li></ol></pre></div></div>     <p>在ArkTS中，为被拦截的请求提供自定义的响应信息：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeHandler</span>.<span class="hljs-title function_">onRequestStart</span>(<span class="hljs-function">(<span class="hljs-params">request: webview.WebSchemeHandlerRequest, resourceHandler: webview.WebResourceHandler</span>) =&gt;</span> {</li><li> <span class="hljs-keyword">let</span> response = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebSchemeHandlerResponse</span>();</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-comment">// 设置网络错误代码为OK，表示请求成功。</span></li><li>   response.<span class="hljs-title function_">setNetErrorCode</span>(<span class="hljs-title class_">WebNetErrorList</span>.<span class="hljs-property">NET_OK</span>);</li><li>
</li><li>   <span class="hljs-comment">// 设置HTTP状态码为200，表示请求处理成功。</span></li><li>   response.<span class="hljs-title function_">setStatus</span>(<span class="hljs-number">200</span>);</li><li>
</li><li>   <span class="hljs-comment">// 设置状态文本为"OK"，用于描述状态码。</span></li><li>   response.<span class="hljs-title function_">setStatusText</span>(<span class="hljs-string">"OK"</span>);</li><li>
</li><li>   <span class="hljs-comment">// 设置MIME类型为"text/html"，指明返回数据的类型为HTML文档。</span></li><li>   response.<span class="hljs-title function_">setMimeType</span>(<span class="hljs-string">"text/html"</span>);</li><li>
</li><li>   <span class="hljs-comment">// 设置编码方式为"utf-8"，指明内容使用UTF-8编码。</span></li><li>   response.<span class="hljs-title function_">setEncoding</span>(<span class="hljs-string">"utf-8"</span>);</li><li>
</li><li>   <span class="hljs-comment">// 设置自定义响应头"header1"的值为"value1"，false表示不覆盖已经存在的同名头部。</span></li><li>   response.<span class="hljs-title function_">setHeaderByName</span>(<span class="hljs-string">"header1"</span>, <span class="hljs-string">"value1"</span>, <span class="hljs-literal">false</span>);</li><li>
</li><li>   <span class="hljs-comment">// 调用didReceiveResponse将构造的响应头传递给被拦截的请求。</span></li><li>   resourceHandler.<span class="hljs-title function_">didReceiveResponse</span>(response);</li><li>
</li><li>   <span class="hljs-comment">// 调用didReceiveResponseBody将构造的响应体传递给被拦截的请求。</span></li><li>   resourceHandler.<span class="hljs-title function_">didReceiveResponseBody</span>(buf.<span class="hljs-property">buffer</span>);</li><li>
</li><li>   <span class="hljs-comment">// 调用didFinish通知Web组件被拦截的请求已经完成。</span></li><li>   resourceHandler.<span class="hljs-title function_">didFinish</span>();</li><li> } <span class="hljs-keyword">catch</span> (error) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[schemeHandler] ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li> }</li><li> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  })</li></ol></pre></div></div>     <p>当希望通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#oh_arkwebresourcehandler_didfailwitherror" target="_blank">OH_ArkWebResourceHandler_DidFailWithError</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didfail12" target="_blank">didFail(code: WebNetErrorList)</a>结束当前请求时，需要在调用该接口之前通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#oh_arkwebresourcehandler_didreceiveresponse" target="_blank">OH_ArkWebResourceHandler_DidReceiveResponse</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didreceiveresponse12" target="_blank">didReceiveResponse</a>返回给Web内核一个响应头，否则无法结束请求。</p>     <p>从API version 20开始，可以直接通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#oh_arkwebresourcehandler_didfailwitherrorv2" target="_blank">OH_ArkWebResourceHandler_DidFailWithErrorV2</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didfail20" target="_blank">didFail(code: WebNetErrorList, completeIfNoResponse: boolean)</a>结束网络请求，不再依赖必须通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkweb-scheme-handler-h#oh_arkwebresourcehandler_didreceiveresponse" target="_blank">OH_ArkWebResourceHandler_DidReceiveResponse</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didreceiveresponse12" target="_blank">didReceiveResponse</a>返回给Web内核一个响应头。</p>     <p>NDK示例：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnRequestStart</span>()</span>{</li><li>  <span class="hljs-comment">// 直接返回网络错误码ARKWEB_ERR_CONNECTION_FAILED结束该请求。</span></li><li>  OH_ArkWebResourceHandler_DidFailWithErrorV2(resourceHandler_, ARKWEB_ERR_CONNECTION_FAILED, <span class="hljs-literal">true</span>);</li><li>}</li></ol></pre></div></div>     <p>ArkTS示例：</p>     <div _ngcontent-pxl-c106="" class="highlight-div"><div _ngcontent-pxl-c106="" class="highlight-div-header"><div _ngcontent-pxl-c106="" class="highlight-div-header-left"><div _ngcontent-pxl-c106="" class="handle-button expand-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pxl-c106="" class="highlight-div-header-right"><div _ngcontent-pxl-c106="" class="handle-button ai-button"></div><div _ngcontent-pxl-c106="" class="handle-button line-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pxl-c106="" class="handle-button theme-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pxl-c106="" class="handle-button copy-button"><div _ngcontent-pxl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pxl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeHandler</span>.<span class="hljs-title function_">onRequestStart</span>(<span class="hljs-function">(<span class="hljs-params">request: webview.WebSchemeHandlerRequest, resourceHandler: webview.WebResourceHandler</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 直接调用didFail(WebNetErrorList.ERR_CONNECTION_FAILED, true)，自动构造一个网络请求错误ERR_CONNECTION_FAILED。</span></li><li>  resourceHandler.<span class="hljs-title function_">didFail</span>(<span class="hljs-title class_">WebNetErrorList</span>.<span class="hljs-property">ERR_CONNECTION_FAILED</span>, <span class="hljs-literal">true</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>})</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <p><a href="https://gitcode.com/harmonyos_samples/guide-snippets/tree/master/ArkWebKit/ArkWebSchemeHandler" target="_blank">拦截Web组件发起的网络请求</a></p>    </div>   </div>   <div></div></div>