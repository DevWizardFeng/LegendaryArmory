<h1 _ngcontent-xet-c119="" class="doc-title ng-star-inserted" title="拦截器：更丰富、更高阶的定制能力"> 拦截器：更丰富、更高阶的定制能力 </h1>

<div _ngcontent-xet-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>使用拦截器可以便捷地对HTTP的请求与响应进行修改，您可以创建拦截器链，按需定制一组拦截器对网络请求/响应进行修改。Remote Communication Kit模块提供了拦截器能力，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section18613443123412" target="_blank">SessionConfiguration</a>中添加interceptors参数，传入自定义的拦截器，即可在HTTP请求和响应的过程中添加拦截器功能。</p>    <div class="tiledSection">     <h2 id="section1768133361915">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section1768133361915" tips="复制节点链接"></i></h2>          <p>拦截器：更丰富、更高阶的定制能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section646117618125">拦截器工作原理<i class="anchor-icon anchor-icon-link" anchorid="section646117618125" tips="复制节点链接"></i></h2>          <p>在客户端发送HTTP请求到达目标服务器之前，可以使用拦截器对请求进行修改。如下图，定义了链式拦截器，RequestUrlChangeInterceptor拦截器（下文以拦截器1代替）和ResponseHeaderRemoveInterceptor拦截器（下文以拦截器2代替）。拦截器1会将请求先拦截，该拦截器可以实现当网络质量差时，通过修改HTTP请求中的URL，来调整请求资源的大小。然后经过拦截器2，最后到达Internet。当请求到达目标服务器，服务器返回请求响应的结果给客户端之前，可以使用拦截器对HTTP的响应进行修改。响应先被拦截器2拦截，在响应返回给应用前检查和修改服务器的请求头。然后经过拦截器1，最后客户端接收响应结果。</p>    </div>    <p><span><img height="320.56165400000003" originheight="1136" originwidth="2750" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115104.43262312555407831143992048679302:50001231000000:2800:C4F561FEC3EF5BBA073DD97DB0C2D99C059CB238DEFB7D547762700F5D0287E4.png" title="点击放大" width="776.0550000000001"></span></p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>RequestUrlChangeInterceptor拦截器和ResponseHeaderRemoveInterceptor拦截器都是自定义拦截器，需要开发者通过代码去实现内部逻辑。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="section1141723712126">拦截器的定义和使用<i class="anchor-icon anchor-icon-link" anchorid="section1141723712126" tips="复制节点链接"></i></h2>          <p>本节介绍如何自定义拦截器，定义RequestUrlChangeInterceptor拦截器和ResponseHeaderRemoveInterceptor拦截器实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section1385412349596" target="_blank">Interceptor</a>，可在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section527252111410" target="_blank">intercept()</a>方法中根据业务需求自定义处理逻辑，实现对请求/响应的修改。以下示例模拟网络质量不佳的情况。</p>    </div>    <ol>     <li><span>导入需要的模块，示例中包含了利用远场通信框架发起网络请求以及请求后的响应和错误处理，所以需导入以下模块。</span>      <p></p>      <div _ngcontent-xet-c106="" class="highlight-div"><div _ngcontent-xet-c106="" class="highlight-div-header"><div _ngcontent-xet-c106="" class="highlight-div-header-left"><div _ngcontent-xet-c106="" class="handle-button expand-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xet-c106="" class="highlight-div-header-right"><div _ngcontent-xet-c106="" class="handle-button ai-button"></div><div _ngcontent-xet-c106="" class="handle-button line-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xet-c106="" class="handle-button theme-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xet-c106="" class="handle-button copy-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xet-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> { url } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>      <p></p></li>     <li><span>定义两种拦截器，RequestUrlChangeInterceptor拦截器中，当网络质量较差的时候，修改请求中的URL路径，请求获取分辨率较小的图片，可提升用户体验；NetworkQualityProvider中的isNetWorkFast用于在示例代码中模拟网络质量的好坏，这里仅作为场景模拟，需要开发者自行评估实现。</span>      <p></p>      <div _ngcontent-xet-c106="" class="highlight-div"><div _ngcontent-xet-c106="" class="highlight-div-header"><div _ngcontent-xet-c106="" class="highlight-div-header-left"><div _ngcontent-xet-c106="" class="handle-button expand-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xet-c106="" class="highlight-div-header-right"><div _ngcontent-xet-c106="" class="handle-button ai-button"></div><div _ngcontent-xet-c106="" class="handle-button line-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xet-c106="" class="handle-button theme-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xet-c106="" class="handle-button copy-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xet-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 模拟网络质量不佳的情况</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkQualityProvider</span> {</li><li>  <span class="hljs-attr">isNetworkFast</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params">isNetworkFast: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isNetworkFast</span> = isNetworkFast</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义RequestUrlChangeInterceptor拦截器</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestUrlChangeInterceptor</span> <span class="hljs-keyword">implements</span> rcp.<span class="hljs-property">Interceptor</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">networkQualityProvider</span>: <span class="hljs-title class_">NetworkQualityProvider</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">networkQualityProvider: NetworkQualityProvider</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">networkQualityProvider</span> = networkQualityProvider;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 自定义请求处理逻辑</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: rcp.<span class="hljs-property">RequestContext</span>, <span class="hljs-attr">next</span>: rcp.<span class="hljs-property">RequestHandler</span>): <span class="hljs-title class_">Promise</span>&lt;rcp.<span class="hljs-property">Response</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (context.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">networkQualityProvider</span>.<span class="hljs-property">isNetworkFast</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[RequestUrlChangeInterceptor]: Slow network is detected'</span>);</li><li>      <span class="hljs-keyword">const</span> parts = context.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);</li><li>      <span class="hljs-keyword">if</span> (parts.<span class="hljs-property">length</span> === <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-keyword">const</span> changed = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(context.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>.<span class="hljs-property">href</span>);</li><li>        changed.<span class="hljs-property">pathname</span> = parts[<span class="hljs-number">0</span>] + <span class="hljs-string">'_small.'</span> + parts[<span class="hljs-number">1</span>];</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[RequestUrlChangeInterceptor]: Replace URL from "<span class="hljs-subst">${context.request.url.href}</span>" to "<span class="hljs-subst">${changed}</span>"`</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'ReplacedInfo'</span>,</li><li>          <span class="hljs-string">`[RequestUrlChangeInterceptor]: Replace URL from "<span class="hljs-subst">${context.request.url.href}</span>" to "<span class="hljs-subst">${changed}</span>"`</span>);</li><li>        context.<span class="hljs-property">request</span>.<span class="hljs-property">url</span> = changed;</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[RequestUrlChangeInterceptor]: Network is fast'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>(context);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义ResponseHeaderRemoveInterceptor拦截器</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseHeaderRemoveInterceptor</span> <span class="hljs-keyword">implements</span> rcp.<span class="hljs-property">Interceptor</span> {</li><li>  <span class="hljs-comment">// 自定义响应处理逻辑</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: rcp.<span class="hljs-property">RequestContext</span>, <span class="hljs-attr">next</span>: rcp.<span class="hljs-property">RequestHandler</span>): <span class="hljs-title class_">Promise</span>&lt;rcp.<span class="hljs-property">Response</span>&gt; {</li><li>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> next.<span class="hljs-title function_">handle</span>(context);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">toReturn</span>: rcp.<span class="hljs-property">Response</span> = {</li><li>      <span class="hljs-attr">request</span>: response.<span class="hljs-property">request</span>,</li><li>      <span class="hljs-attr">statusCode</span>: response.<span class="hljs-property">statusCode</span>,</li><li>      <span class="hljs-attr">httpVersion</span>: response.<span class="hljs-property">httpVersion</span>,</li><li>      <span class="hljs-attr">headers</span>: {</li><li>        <span class="hljs-string">'content-range'</span>: response.<span class="hljs-property">headers</span>[<span class="hljs-string">'content-range'</span>]</li><li>      },</li><li>      <span class="hljs-attr">effectiveUrl</span>: response.<span class="hljs-property">effectiveUrl</span>,</li><li>      <span class="hljs-attr">timeInfo</span>: response.<span class="hljs-property">timeInfo</span>,</li><li>      <span class="hljs-attr">toJSON</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span></li><li>    };</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[ResponseHeaderRemoveInterceptor]: Response was modified'</span>);</li><li>    <span class="hljs-keyword">return</span> toReturn;</li><li>  }</li><li>}</li></ol></pre></div></div>      <p></p></li>     <li><span>使用拦截器，通过Remote Communication Kit模块中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section18613443123412" target="_blank">SessionConfiguration</a>对象来设置interceptors，即可在请求/响应中添加拦截器。</span>      <p></p>      <div _ngcontent-xet-c106="" class="highlight-div"><div _ngcontent-xet-c106="" class="highlight-div-header"><div _ngcontent-xet-c106="" class="highlight-div-header-left"><div _ngcontent-xet-c106="" class="handle-button expand-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xet-c106="" class="highlight-div-header-right"><div _ngcontent-xet-c106="" class="handle-button ai-button"></div><div _ngcontent-xet-c106="" class="handle-button line-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xet-c106="" class="handle-button theme-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xet-c106="" class="handle-button copy-button"><div _ngcontent-xet-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xet-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">httpRequest</span>(<span class="hljs-params">networkStateSimulator: NetworkQualityProvider</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">sessionConfig</span>: rcp.<span class="hljs-property">SessionConfiguration</span> = {</li><li>    <span class="hljs-attr">interceptors</span>: [</li><li>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestUrlChangeInterceptor</span>(networkStateSimulator),</li><li>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseHeaderRemoveInterceptor</span>()</li><li>    ],</li><li>    <span class="hljs-attr">requestConfiguration</span>: {</li><li>      <span class="hljs-attr">security</span>: {</li><li>        <span class="hljs-attr">tlsOptions</span>: {</li><li>          <span class="hljs-attr">tlsVersion</span>: <span class="hljs-string">'TlsV1.3'</span></li><li>        }</li><li>      }</li><li>    }</li><li>  };</li><li>  <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>(sessionConfig);</li><li>}</li></ol></pre></div></div>      <p></p></li>    </ol>   </div>   <div></div></div>