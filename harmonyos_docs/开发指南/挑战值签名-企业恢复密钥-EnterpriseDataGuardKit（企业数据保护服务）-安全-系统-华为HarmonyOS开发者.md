<h1 _ngcontent-ntg-c119="" class="doc-title ng-star-inserted" title="挑战值签名"> 挑战值签名 </h1>

<div _ngcontent-ntg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section92614549615">背景<i class="anchor-icon anchor-icon-link" anchorid="section92614549615" tips="复制节点链接"></i></h2>          <p>挑战值是一个32字节的随机数，用于防止签名重放攻击。在企业恢复密钥提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/recoverykey-update">更新企业公钥证书</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/recoverykey-delete">删除企业恢复密钥</a>场景下，均会使用挑战值来确保签名是企业对当前操作进行授权。签名使用ECC算法，是企业利用企业证书对应的私钥，对挑战值进行签名的。接口传入的挑战值签名必须是只包含原始ECDSA签名值的64字节内容，不能包含任何格式前缀。</p>    </div>    <div class="tiledSection">     <h2 id="section58141539014">自定义签名工具类SignUtil生成挑战值的签名<i class="anchor-icon anchor-icon-link" anchorid="section58141539014" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataguard-recoverykey#section1483871653813" target="_blank">updateEnterpriseCertificate</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataguard-recoverykey#section1927015514386" target="_blank">deleteEnterpriseRecoveryKey</a>在生成挑战值的签名时可使用自定义签名工具类。使用时，请将SignUtil里的privateKey、publicKey，替换为企业的公私钥对。</p>    </div>    <div _ngcontent-ntg-c106="" class="highlight-div"><div _ngcontent-ntg-c106="" class="highlight-div-header"><div _ngcontent-ntg-c106="" class="highlight-div-header-left"><div _ngcontent-ntg-c106="" class="handle-button expand-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ntg-c106="" class="highlight-div-header-right"><div _ngcontent-ntg-c106="" class="handle-button ai-button"></div><div _ngcontent-ntg-c106="" class="handle-button line-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ntg-c106="" class="handle-button theme-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ntg-c106="" class="handle-button copy-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ntg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">cryptoFramework</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.CryptoArchitectureKit"</span>;</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignUtil</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">signInner</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">Uint8Array</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Uint8Array</span>&gt; {</li><li>    <span class="hljs-comment">// 替换成企业的私钥</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">privateKey</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"-----BEGIN EC PARAMETERS-----\n"</span> +</li><li>      <span class="hljs-string">"************\n"</span> +</li><li>      <span class="hljs-string">"-----END EC PARAMETERS-----\n"</span> +</li><li>      <span class="hljs-string">"-----BEGIN EC PRIVATE KEY-----\n"</span> +</li><li>      <span class="hljs-string">"**********************************************************************"</span>  +</li><li>      <span class="hljs-string">"-----END EC PRIVATE KEY-----"</span>;</li><li>    <span class="hljs-comment">// 替换成企业的公钥</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">publicKey</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"-----BEGIN PUBLIC KEY-----\n"</span> +</li><li>      <span class="hljs-string">"****************************************************************\n"</span> +</li><li>      <span class="hljs-string">"************************************************************\n"</span> +</li><li>      <span class="hljs-string">"-----END PUBLIC KEY-----\n"</span> +</li><li>      <span class="hljs-string">"-----BEGIN CERTIFICATE-----\n"</span> +</li><li>      <span class="hljs-string">"****************************************************************\n"</span> +</li><li>      <span class="hljs-string">"*******\n"</span> +</li><li>      <span class="hljs-string">"-----END CERTIFICATE-----\n"</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">input1</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">DataBlob</span> = { <span class="hljs-variable">data</span> };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">signAlg</span> = <span class="hljs-string">"ECC_BrainPoolP256r1|SHA256"</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">signer</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-title function_">createSign</span>(<span class="hljs-variable">signAlg</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">asyKeyGenerator</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-title function_">createAsyKeyGenerator</span>(<span class="hljs-string">"ECC_BrainPoolP256r1"</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">keyPair</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">asyKeyGenerator</span>.<span class="hljs-title function_">convertPemKey</span>(<span class="hljs-variable">publicKey</span>, <span class="hljs-variable">privateKey</span>);</li><li>    <span class="hljs-variable">await</span> <span class="hljs-variable">signer</span>.<span class="hljs-keyword">init</span>(<span class="hljs-variable">keyPair</span>.<span class="hljs-variable">priKey</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">signData</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">signer</span>.<span class="hljs-title function_">sign</span>(<span class="hljs-variable">input1</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">verifier</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-title function_">createVerify</span>(<span class="hljs-variable">signAlg</span>);</li><li>    <span class="hljs-variable">verifier</span>.<span class="hljs-title function_">initSync</span>(<span class="hljs-variable">keyPair</span>.<span class="hljs-variable">pubKey</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">res</span> = <span class="hljs-variable">verifier</span>.<span class="hljs-title function_">verifySync</span>(<span class="hljs-variable">input1</span>, <span class="hljs-variable">signData</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">signData</span>.<span class="hljs-variable">data</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">sign</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">Uint8Array</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Uint8Array</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">signInnerResult</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">SignUtil</span>.<span class="hljs-title function_">signInner</span>(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-number">64</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">length</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">index</span> &lt; <span class="hljs-title class_">signInnerResult</span>.<span class="hljs-title class_">length</span>) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">signInnerResult</span>[<span class="hljs-variable">index</span>] === <span class="hljs-number">0x02</span>) {</li><li>        <span class="hljs-variable">length</span> = <span class="hljs-variable">index</span> + <span class="hljs-number">1</span> &lt; <span class="hljs-title class_">signInnerResult</span>.<span class="hljs-title class_">length</span> ? <span class="hljs-title class_">signInnerResult</span>[<span class="hljs-title class_">index</span> + <span class="hljs-number">1</span>] : <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">end</span> = <span class="hljs-variable">index</span> + <span class="hljs-number">2</span> + <span class="hljs-variable">length</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">end</span> &lt;= <span class="hljs-title class_">signInnerResult</span>.<span class="hljs-title class_">length</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">copyArr</span> = <span class="hljs-variable">signInnerResult</span>.<span class="hljs-title function_">subarray</span>(<span class="hljs-variable">end</span> - <span class="hljs-number">32</span>, <span class="hljs-variable">end</span>);</li><li>          <span class="hljs-variable">result</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">copyArr</span>, <span class="hljs-variable">offset</span>);</li><li>          <span class="hljs-variable">offset</span> += <span class="hljs-number">32</span>;</li><li>        }</li><li>        <span class="hljs-variable">index</span> += <span class="hljs-number">34</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">index</span>++;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>  }</li><li>}</li></ol></pre></div></div>    <div class="tiledSection">     <h2 id="section138921742154112">生成挑战值的签名（更新企业公钥）<i class="anchor-icon anchor-icon-link" anchorid="section138921742154112" tips="复制节点链接"></i></h2>          <div class="p">      在更新企业公钥证书场景下，先获取挑战值，将下面方法中的certificate和ecPubNewStrBase64替换为企业的新证书和新公钥，然后调用自定义工具类SignUtil的sign签名方法生成挑战值的签名。      <div _ngcontent-ntg-c106="" class="highlight-div"><div _ngcontent-ntg-c106="" class="highlight-div-header"><div _ngcontent-ntg-c106="" class="highlight-div-header-left"><div _ngcontent-ntg-c106="" class="handle-button expand-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ntg-c106="" class="highlight-div-header-right"><div _ngcontent-ntg-c106="" class="handle-button ai-button"></div><div _ngcontent-ntg-c106="" class="handle-button line-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ntg-c106="" class="handle-button theme-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ntg-c106="" class="handle-button copy-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ntg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { recoveryKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.EnterpriseDataGuardKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SignUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SignUtil'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateEnterpriseCertificate</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 替换成企业的新证书</span></li><li>  <span class="hljs-keyword">const</span> certificate =</li><li>    <span class="hljs-string">"-----BEGIN CERTIFICATE-----\n"</span> +</li><li>      <span class="hljs-string">"****************************************************************\n"</span> +</li><li>      <span class="hljs-string">"*******\n"</span> +</li><li>      <span class="hljs-string">"-----END CERTIFICATE-----\n"</span>;</li><li>
</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">challenge</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">await</span> recoveryKey.<span class="hljs-title function_">getAuthChallenge</span>();</li><li>  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">4</span>);</li><li>  <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);</li><li>  view.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x98010000</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">command</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);</li><li>  <span class="hljs-comment">// 替换成企业的新公钥</span></li><li>  <span class="hljs-keyword">const</span> ecPubNewStrBase64 =</li><li>    <span class="hljs-string">"****************************************************************\n"</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">publicKey</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-title function_">base64ToStringUint8Array</span>(ecPubNewStrBase64);</li><li>  publicKey = publicKey.<span class="hljs-title function_">subarray</span>(publicKey.<span class="hljs-property">length</span> - <span class="hljs-number">65</span>, publicKey.<span class="hljs-property">length</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">signData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(challenge.<span class="hljs-property">length</span> + command.<span class="hljs-property">length</span> + publicKey.<span class="hljs-property">length</span>);</li><li>  signData.<span class="hljs-title function_">set</span>(challenge, <span class="hljs-number">0</span>);</li><li>  signData.<span class="hljs-title function_">set</span>(command, challenge.<span class="hljs-property">length</span>);</li><li>  signData.<span class="hljs-title function_">set</span>(publicKey, challenge.<span class="hljs-property">length</span> + command.<span class="hljs-property">length</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">signature</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignUtil</span>.<span class="hljs-title function_">sign</span>(signData);</li><li>
</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">cert</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-title function_">stringToUint8</span>(certificate!);</li><li>  recoveryKey.<span class="hljs-title function_">updateEnterpriseCertificate</span>(signature, cert).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: number</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in updating certificate.`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to update certificate. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>.`</span>);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">stringToUint8</span>(<span class="hljs-params">str: string</span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([]);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    result = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">TextEncoder</span>(<span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">encodeInto</span>(str);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to encode to uint8. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">base64ToStringUint8Array</span>(<span class="hljs-params">base64String: string</span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>  <span class="hljs-keyword">let</span> base64 = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">Base64Helper</span>();</li><li>  <span class="hljs-keyword">let</span> uint8Array = base64.<span class="hljs-title function_">decodeSync</span>(base64String, util.<span class="hljs-property">Type</span>.<span class="hljs-property">BASIC</span>);</li><li>  <span class="hljs-keyword">return</span> uint8Array;</li><li>}</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section1641111819424">生成挑战值的签名（删除企业恢复密钥）<i class="anchor-icon anchor-icon-link" anchorid="section1641111819424" tips="复制节点链接"></i></h2>          <p>在删除企业恢复密钥场景下，先获取挑战，然后调用自定义工具类SignUtil的sign签名方法生成挑战值的签名。</p>     <div _ngcontent-ntg-c106="" class="highlight-div"><div _ngcontent-ntg-c106="" class="highlight-div-header"><div _ngcontent-ntg-c106="" class="highlight-div-header-left"><div _ngcontent-ntg-c106="" class="handle-button expand-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ntg-c106="" class="highlight-div-header-right"><div _ngcontent-ntg-c106="" class="handle-button ai-button"></div><div _ngcontent-ntg-c106="" class="handle-button line-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ntg-c106="" class="handle-button theme-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ntg-c106="" class="handle-button copy-button"><div _ngcontent-ntg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ntg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, osAccount } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { recoveryKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.EnterpriseDataGuardKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SignUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./SignUtil'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteEnterpriseRecoveryKey</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">challenge</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">await</span> recoveryKey.<span class="hljs-title function_">getAuthChallenge</span>();</li><li>  <span class="hljs-keyword">let</span> signResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignUtil</span>.<span class="hljs-title function_">sign</span>(challenge);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">accountManager</span>: osAccount.<span class="hljs-property">AccountManager</span> = osAccount.<span class="hljs-title function_">getAccountManager</span>();</li><li>  <span class="hljs-keyword">let</span> userId = <span class="hljs-keyword">await</span> accountManager.<span class="hljs-title function_">getOsAccountLocalId</span>();</li><li>  recoveryKey.<span class="hljs-title function_">deleteEnterpriseRecoveryKey</span>(userId, signResult).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: number</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in deleting enterprise recovery key.`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete enterprise recovery key. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>  });</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>