<h1 _ngcontent-eyj-c119="" class="doc-title ng-star-inserted" title="接入自动续期订阅"> 接入自动续期订阅 </h1>

<div _ngcontent-eyj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section089611563716">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section089611563716" tips="复制节点链接"></i></h2>          <p>自动续期订阅能力支持Phone、Tablet、PC/2in1设备，并且从5.1.1(19）版本开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section1818915573916">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section1818915573916" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>如下业务流程对于单机应用同样适用。在单机应用中，应用服务器和应用客户端的交互放在应用客户端完成，应用服务器和IAP服务器交互的部分可不处理。</p>      </div></div></div>     <p><span><img height="1109.6988000000001" originheight="1392" originwidth="1001" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114656.28843702119000633439964394041945:50001231000000:2800:039827396A88FDAF520F97376F683B7484913A506B420CF05EFC3C19362C99A2.png" title="点击放大" width="798"></span></p>     <div class="p">      <strong>展示商品</strong>      <ol>       <li id="zh-cn_topic_0000002413014308_li1166317231586">应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section192192415554" target="_blank">queryEnvironmentStatus</a>请求，检查当前用户登录的华为账号所在的服务地是否在IAP Kit支持结算的国家/地区中。        <p id="ZH-CN_TOPIC_0000002446733329__zh-cn_topic_0000002413014308_p214385761310">如请求失败，应用需隐藏相关IAP功能入口。</p></li>       <li id="zh-cn_topic_0000002413014308_li9863132216595">应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section55531442102518" target="_blank">queryProducts</a>请求来获取在<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>上配置的商品信息。</li>       <li id="zh-cn_topic_0000002413014308_li734535418">应用客户端根据返回的商品信息展示可供购买的商品列表，包含商品名称、价格等信息。</li>      </ol>     </div>     <div class="p">      <strong>检查权益发放状态</strong>      <ol>       <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，获取当前生效中的订阅列表。IAP Kit返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>为JWS格式的字符串，承载了相关的订阅信息。</li>       <li>应用客户端展示商品的订阅状态，需要屏蔽处于自动续期状态的商品的购买入口。同时处理商品的权益发放。</li>       <li>若商品未确认发货，需要在权益发放后，向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求，以此通知IAP服务器更新商品的发货状态，完成购买流程。应用成功执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>之后，IAP服务器会将相应商品标记为已发货状态。        <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p></li>      </ol>     </div>     <p>具体请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-delivering-subscriptions#section1369619716116">对生效中的订阅发放权益</a>。</p>     <div class="p">      <strong>购买及结果确认</strong>      <ol>       <li>用户发起购买后，应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section18798154545516" target="_blank">createPurchase</a>购买请求，请求中携带商品ID、商品类型等信息。IAP Kit创建订单并展示收银台。</li>       <li>购买结果确认。如购买成功，可通过应用客户端或应用服务器接收购买结果，建议通过应用服务器接收购买结果。        <p><strong>方式一：通过客户端接收购买结果</strong></p>        <ol>         <li>用户购买成功时，IAP Kit返回包含订阅状态信息的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>数据。</li>         <li>应用客户端向应用服务器上报<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>数据。</li>         <li>应用服务器<span style="color: rgb(48,48,48);">对</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData.jwsSubscriptionStatus</a><span style="color: rgb(48,48,48);">进行</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a><span style="color: rgb(48,48,48);">，</span>成功后可得到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。</li>        </ol>        <div class="p">         <strong>（建议）方式二：通过服务器接收购买结果</strong>         <ol>          <li>为了提高安全性，开发者可以接入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-key-event-notifications" target="_blank">服务端关键事件通知</a>，在用户购买成功时，IAP服务器将发送订单关键事件通知。</li>          <li>应用服务器可从NotificationPayload.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-key-event-notifications#section526717832913" target="_blank">NotificationMetaData</a>中解析出purchaseToken和purchaseOrderId信息，并通过服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-query-subscription-status" target="_blank">订阅状态查询</a>接口向IAP服务器查询最新的订阅状态信息，进一步确认订阅信息的准确性。</li>          <li>IAP服务器返回订阅组相关订阅状态数据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-query-subscription-status#section96323317194" target="_blank">jwsSubGroupStatus</a>。</li>          <li>应用服务器<span style="color: rgb(48,48,48);">对</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-query-subscription-status#section96323317194" target="_blank">jwsSubGroupStatus</a><span style="color: rgb(48,48,48);">进行</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a><span style="color: rgb(48,48,48);">，成功后可得到</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a><span style="color: rgb(48,48,48);">的JSON字符串。</span></li>         </ol>        </div></li>      </ol>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>如果购买失败，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-delivering-subscriptions#section1880231055910">确保权益发放</a>处理，及时发放权益。</p>      </div></div></div>     <p><strong>发放权益</strong></p>     <ol>      <li>确认购买成功后，需要处理权益发放。检查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder是否已发放权益，未发放则需发放相关权益，并记录对应的订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>），用于后续检查权益发放状态。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p>        </div></div></div></li>      <li>应用客户端向应用服务器查询订单的发货状态。</li>      <li>应用服务器返回对应的发货状态以及订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。</li>      <li>发货成功后应用客户端向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求，以此通知IAP服务器更新商品的发货状态，完成购买流程。应用成功执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>之后，IAP服务器会将相应商品标记为已发货状态，后续该商品即可正常续期。       <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section9187179113620">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9187179113620" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section16327184719313" class="firsth2">展示商品<i class="anchor-icon anchor-icon-link" anchorid="section16327184719313" tips="复制节点链接"></i></h3>          <ol>      <li>检查应用引入IAP Kit的可用性。       <p id="ZH-CN_TOPIC_0000002446733329__zh-cn_topic_0000002413014308_p151551747192517">在使用应用内支付之前，应用客户端需要向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section192192415554" target="_blank">queryEnvironmentStatus</a>请求，以此判断用户当前登录的华为账号所在的服务地是否在IAP Kit支持结算的国家/地区中。如请求失败，则隐藏相关IAP功能入口。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p id="ZH-CN_TOPIC_0000002446733329__zh-cn_topic_0000002413014308_p4155154782514">当前IAP Kit支持结算的国家/地区仅有中国大陆。</p>        </div></div></div>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" id="ZH-CN_TOPIC_0000002446733329__zh-cn_topic_0000002413014308_screen181555474258" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">queryEnvironmentStatus</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    iap.<span class="hljs-title function_">queryEnvironmentStatus</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying environment status.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query environment status. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div></li>     </ol>     <ol start="2">      <li>展示商品列表。       <p>应用客户端通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section55531442102518" target="_blank">queryProducts</a>来获取在<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>上配置的商品信息。发起请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1033653365917" target="_blank">QueryProductsParameter</a>中携带相关的商品ID，并指定其productType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section59035422210" target="_blank">iap.ProductType.AUTORENEWABLE</a>。</p>       <div class="p">        当接口请求成功时，IAP Kit将返回商品信息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section346874219313" target="_blank">Product</a>的列表。 应用可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section346874219313" target="_blank">Product</a>包含的商品价格、名称和描述等信息，向用户展示可供购买的商品列表。        <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">          <p id="ZH-CN_TOPIC_0000002446733329__zh-cn_topic_0000002413014308_p1415611475258"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section55531442102518" target="_blank">queryProducts</a>每次只能查询一种商品类型的商品，每次最多查询200个商品，否则请求将报错。</p>         </div></div></div>       </div>       <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-title function_">queryProducts</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryProductParam</span>: iap.<span class="hljs-property">QueryProductsParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: iap.<span class="hljs-property">ProductType</span>.<span class="hljs-property">AUTORENEWABLE</span>,</li><li>      <span class="hljs-comment">// productIds中的商品需要替换成开发者在AppGallery Connect网站配置的商品</span></li><li>      <span class="hljs-attr">productIds</span>: [<span class="hljs-string">'product1'</span>, <span class="hljs-string">'product2'</span>, <span class="hljs-string">'product3'</span>]</li><li>    };</li><li>    iap.<span class="hljs-title function_">queryProducts</span>(context, queryProductParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying products.'</span>);</li><li>      <span class="hljs-comment">// 展示商品信息</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query products. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section2034121123211">展示订阅状态、发放权益<i class="anchor-icon anchor-icon-link" anchorid="section2034121123211" tips="复制节点链接"></i></h3>          <ol>      <li>应用获取用户当前生效中的订阅列表。</li>      <li>应用客户端展示对应商品的订阅状态。此处需要屏蔽处于自动续期状态的商品的购买入口。</li>      <li>处理生效中的订阅的权益发放。</li>     </ol>     <p>具体可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-delivering-subscriptions#section1369619716116">对生效中的订阅发放权益</a>。</p>    </div>    <div class="tiledSection">     <h3 id="section962215253217">发起购买<i class="anchor-icon anchor-icon-link" anchorid="section962215253217" tips="复制节点链接"></i></h3>          <p>用户发起购买时，应用可通过向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section18798154545516" target="_blank">createPurchase</a>请求来拉起IAP Kit收银台。发起请求时，应用需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1340120344598" target="_blank">PurchaseParameter</a>中携带此前已在华为<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>网站上配置并生效的自动续期订阅的商品ID，并指定其productType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section59035422210" target="_blank">iap.ProductType.AUTORENEWABLE</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>开发过程中易出现频繁调用接口的现象，建议控制接口调用频度，具体可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-error-code#section10919174355114" target="_blank">1001860004 接口访问过频</a>。</p>      </div></div></div>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">createPurchaseParam</span>: iap.<span class="hljs-property">PurchaseParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: iap.<span class="hljs-property">ProductType</span>.<span class="hljs-property">AUTORENEWABLE</span>,</li><li>      <span class="hljs-comment">// productId需要替换成开发者在AppGallery Connect网站配置商品信息时设置的“商品ID”</span></li><li>      <span class="hljs-attr">productId</span>: <span class="hljs-string">'test001'</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">createPurchase</span>(context, createPurchaseParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in creating purchase.'</span>);</li><li>      <span class="hljs-comment">// 购买成功，处理购买结果</span></li><li>      <span class="hljs-comment">// dealPurchaseResult实现请参见下一步</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealPurchaseResult</span>(result);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 购买失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create purchase. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-comment">// dealPurchaseError实现请参见下一步</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealPurchaseError</span>(err);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section2012918318325">购买结果处理<i class="anchor-icon anchor-icon-link" anchorid="section2012918318325" tips="复制节点链接"></i></h3>          <p><strong>【结果1：购买成功】</strong></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>为了提高安全性，建议应用服务器接入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-key-event-notifications" target="_blank">服务端关键事件通知</a>以接收购买成功结果并通过应用服务器来处理<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>、完成购买等操作。</li>        <li>请务必确保发货成功后再执行完成购买步骤，本步骤可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</li>       </ol>      </div></div></div>     <p>以下内容为<strong>通过客户端接收购买结果</strong>及处理的步骤说明。</p>     <ol>      <li>当用户购买成功时，应用将接收到一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section193852021105111" target="_blank">CreatePurchaseResult</a>对象，其<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>字段包括了此次购买的结果信息。</li>      <li>对<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>.jwsSubscriptionStatus进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>，验证成功可得到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。建议应用客户端将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>发送至应用服务器，在应用服务器执行此操作。</li>      <li>验签成功后，检查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.status是否为1（生效中），是则发放相关权益。       <p>建议先检查此笔订单权益的发放状态，未发放则发放权益，成功后记录<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder等信息，用于后续检查权益发放状态。</p></li>      <li>完成购买。       <p>发放权益后，应用需发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求确认发货，以此通知IAP服务器更新商品的发货状态，完成购买流程。发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section103714142118" target="_blank">FinishPurchaseParameter</a>中携带<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>中的productType、purchaseToken、purchaseOrderId，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder。请求成功后，IAP服务器会将相应商品标记为已发货。</p></li>     </ol>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// JWSUtil为自定义类，可参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-dev-guide#section698882222912"><span class="hljs-comment">示例代码</span></a></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JWSUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/JWSUtil'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 购买结果处理</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> result 商品购买结果</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">dealPurchaseResult</span>(<span class="hljs-params">context: common.UIAbilityContext, result: iap.CreatePurchaseResult</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">jwsSubscriptionStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result.<span class="hljs-property">purchaseData</span>).<span class="hljs-property">jwsSubscriptionStatus</span>;</li><li>    <span class="hljs-keyword">if</span> (!jwsSubscriptionStatus) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">subscriptionStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JWSUtil</span>.<span class="hljs-title function_">decodeJwsObj</span>(jwsSubscriptionStatus);</li><li>    <span class="hljs-keyword">if</span> (!subscriptionStatus) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 需自定义SubGroupStatusPayload类，包含的信息请参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank"><span class="hljs-comment">SubGroupStatusPayload</span></a></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">subGroupStatusPayload</span>: <span class="hljs-title class_">SubGroupStatusPayload</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(subscriptionStatus);</li><li>    <span class="hljs-keyword">const</span> lastSubscriptionStatus = subGroupStatusPayload.<span class="hljs-property">lastSubscriptionStatus</span>;</li><li>    <span class="hljs-keyword">if</span> (!lastSubscriptionStatus || lastSubscriptionStatus.<span class="hljs-property">status</span> !== <span class="hljs-string">'1'</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> purchaseOrderPayload = lastSubscriptionStatus.<span class="hljs-property">lastPurchaseOrder</span>;</li><li>    <span class="hljs-keyword">if</span> (purchaseOrderPayload === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 处理发货</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 发货成功后向IAP Kit发送finishPurchase请求，确认发货，完成购买</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishPurchase</span>(context, purchaseOrderPayload);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 确认发货，完成购买</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> purchaseOrder 订单信息，来源于购买请求</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">finishPurchase</span>(<span class="hljs-params">context: common.UIAbilityContext, purchaseOrder: PurchaseOrderPayload</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">finishPurchaseParam</span>: iap.<span class="hljs-property">FinishPurchaseParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: <span class="hljs-title class_">Number</span>(purchaseOrder.<span class="hljs-property">productType</span>),</li><li>      <span class="hljs-attr">purchaseToken</span>: purchaseOrder.<span class="hljs-property">purchaseToken</span>,</li><li>      <span class="hljs-attr">purchaseOrderId</span>: purchaseOrder.<span class="hljs-property">purchaseOrderId</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">finishPurchase</span>(context, finishPurchaseParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in finishing purchase.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finish purchase. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div>     <p><strong>【结果2：购买失败】</strong></p>     <p>当用户购买失败时，需要针对code为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.PRODUCT_OWNED</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.SYSTEM_ERROR</a>的场景，检查是否需要补发货，确保权益发放，具体请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-delivering-subscriptions#section1880231055910">确保权益发放</a>。</p>     <div _ngcontent-eyj-c106="" class="highlight-div"><div _ngcontent-eyj-c106="" class="highlight-div-header"><div _ngcontent-eyj-c106="" class="highlight-div-header-left"><div _ngcontent-eyj-c106="" class="handle-button expand-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eyj-c106="" class="highlight-div-header-right"><div _ngcontent-eyj-c106="" class="handle-button ai-button"></div><div _ngcontent-eyj-c106="" class="handle-button line-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eyj-c106="" class="handle-button theme-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eyj-c106="" class="handle-button copy-button"><div _ngcontent-eyj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eyj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-title function_">dealPurchaseError</span>(<span class="hljs-params">err: BusinessError</span>) {</li><li>  <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span> === iap.<span class="hljs-property">IAPErrorCode</span>.<span class="hljs-property">PRODUCT_OWNED</span> || err.<span class="hljs-property">code</span> === iap.<span class="hljs-property">IAPErrorCode</span>.<span class="hljs-property">SYSTEM_ERROR</span>) {</li><li>    <span class="hljs-comment">// 参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-delivering-subscriptions#section1880231055910"><span class="hljs-comment">确保权益发放</span></a><span class="hljs-comment">检查是否需要补发货，确保权益发放</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>