<h1 _ngcontent-wjv-c119="" class="doc-title ng-star-inserted" title="推送应用内通话消息"> 推送应用内通话消息 </h1>

<div _ngcontent-wjv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section9444545151713">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section9444545151713" tips="复制节点链接"></i></h2>          <p>应用内通话消息，支持应用实现网络音视频通话的能力。当终端处于锁屏或解锁两种不同状态时，Push Kit将分别进行以下处理：</p>     <ul>      <li>终端处于锁屏状态时，可在锁屏上点击接听或拒绝按钮。锁屏状态下<strong>只支持接听语音</strong>。</li>      <li>终端处于解锁状态时，网络音视频通话呼叫消息显性展示于横幅，支持用户接听视频或语音。</li>     </ul>     <p>接听视频时会拉起应用内的接听界面。接通后，可以正常挂断（主动挂断/被动挂断）应用内通话消息。</p>     <p>应用内通话消息样式可参考如下示例，真实样式请以实际效果为准：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.6.1.3.1.1" valign="top" width="50.06%">          <p>锁屏</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.1.6.1.3.1.2" valign="top" width="49.94%">          <p>来电横幅</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50.06%">          <p><span><img height="631.5904" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114635.27370282490035551051618842137667:50001231000000:2800:5F71F3E51DD82F44E67621CD061BECD71668A55971EE310D79C8D3D5D3730CAE.png" title="点击放大" width="307.23"></span></p></td>         <td class="cellrowborder" valign="top" width="49.94%">          <p><span><img height="631.5904" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114635.59451702461683542635058679510484:50001231000000:2800:D1419ED2DBD6049C9D28BAA49D3E26AA9F98B2879BA788A3CFA0B07D1BC623ED.png" title="点击放大" width="307.23"></span></p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>应用内通话消息的问题场景请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-faq-7">指导</a>。</li>       <li>应用内通话消息的pushOptions.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section418321011212" target="_blank">ttl</a>建议设置为<strong>30~60秒</strong>。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="section842412232016">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section842412232016" tips="复制节点链接"></i></h2>          <p>应用内通话消息当前仅支持Phone、Tablet机型。</p>    </div>    <div class="tiledSection">     <h2 id="section182930791813">开通权益<i class="anchor-icon anchor-icon-link" anchorid="section182930791813" tips="复制节点链接"></i></h2>          <p>推送应用内通话消息需要申请场景化消息权益，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-apply-right#section7291115452410">申请推送应用内通话消息权益</a>。</p>    </div>    <div class="tiledSection">     <h2 id="section814745817198">频控规则<i class="anchor-icon anchor-icon-link" anchorid="section814745817198" tips="复制节点链接"></i></h2>          <p><strong>调测阶段</strong>，每个项目每日全网最多可推送<span id="ZH-CN_TOPIC_0000002402305705__zh-cn_topic_0000002368705820_text54316313257">1000</span>条测试消息。发送测试消息需设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section418321011212" target="_blank">testMessage</a>为true。</p>     <p><strong>正式发布阶段</strong>，单设备单应用下每日推送消息总条数受<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-msg-freq-control#section993063213715" target="_blank">设备消息频控</a>限制，系统会根据现网使用场景和流量进行管控，不合理的使用场景系统会进行频控。</p>    </div>    <div class="tiledSection">     <h2 id="section41452724812">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section41452724812" tips="复制节点链接"></i></h2>          <ol>      <li><span>参见指导<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-get-token">获取Push Token</a>。</span></li>      <li><span>在您的工程内创建一个UIAbility类型的组件，如VoIPUIAbility.ets（在项目工程的<strong>src/main/ets/entryability</strong>目录下），负责处理应用内通话消息的主流程，并完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#oncreate" target="_blank">onCreate</a>()、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onwindowstagecreate" target="_blank">onWindowStageCreate</a>()、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#ondestroy" target="_blank">onDestroy</a>()方法的覆写，代码示例如下：</span>       <p></p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 文件路径: src/main/ets/entryability/VoIPUIAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { pushService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PushKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">VoipCallService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../service/VoipCallService'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoIPUIAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`VoIPUIAbility onCreate`</span>);</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      pushService.<span class="hljs-title function_">receiveMessage</span>(<span class="hljs-string">'VoIP'</span>, <span class="hljs-variable language_">this</span>, <span class="hljs-keyword">async</span> (data) =&gt; {</li><li>        <span class="hljs-comment">// process message，并建议对Callback进行try-catch</span></li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">await</span> <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-title function_">processVoIPMainMsg</span>(data.<span class="hljs-property">data</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to process VoIP message: %{public}d %{public}s'</span>,</li><li>            error.<span class="hljs-property">code</span>,</li><li>            error.<span class="hljs-property">message</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to register VOIP, error: <span class="hljs-subst">${e.code}</span>, <span class="hljs-subst">${e.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`VoIPUIAbility onWindowStageCreate`</span>);</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/CalleePage'</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load content, error: <span class="hljs-subst">${err.code}</span>, <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'VoIPUIAbility onDestroy'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p>       <p>VoipCallService.ets（在项目工程的<strong>src/main/ets/service</strong>目录下），处理应用内通话消息，代码示例如下：</p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 文件路径: src/main/ets/service/VoipCallService.ets</span></li><li><span class="hljs-keyword">import</span> { voipCall } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CallServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { resourceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocalizationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">VoipScene</span> {</li><li>  <span class="hljs-attr">scene</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Content</span> {</li><li>  <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">header</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">callId</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoipCallService</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">callId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">processVoIPMainMsg</span>(<span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>,</li><li>    <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Process VoIP message: <span class="hljs-subst">${data}</span>`</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">content</span>: <span class="hljs-title class_">Content</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">scene</span>: <span class="hljs-title class_">VoipScene</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(content.<span class="hljs-property">data</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">callId</span>: <span class="hljs-built_in">string</span> = content.<span class="hljs-property">callId</span>;</li><li>    <span class="hljs-keyword">if</span> (!callId) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`CallId is null`</span>);</li><li>    }</li><li>    <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-property">callId</span> = callId;</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 注册voipCallUiEvent事件</span></li><li>      voipCall.<span class="hljs-title function_">on</span>(<span class="hljs-string">'voipCallUiEvent'</span>, <span class="hljs-keyword">async</span> (event) =&gt; {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Process voip call ui event: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(event)}</span>.`</span>);</li><li>
</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-title function_">processVoipCallEvent</span>(event.<span class="hljs-property">voipCallUiEvent</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to register event: %{public}d %{public}s'</span>, e.<span class="hljs-property">code</span>, e.<span class="hljs-property">message</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">resourceMgr</span>: resourceManager.<span class="hljs-property">ResourceManager</span> = context.<span class="hljs-property">resourceManager</span>;</li><li>    <span class="hljs-comment">// example.png表示用户头像，取值为“/resources/rawfile”路径下的文件名</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">fileData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      fileData = <span class="hljs-keyword">await</span> resourceMgr.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'example.png'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to get raw file: %{public}d %{public}s'</span>, e.<span class="hljs-property">code</span>, e.<span class="hljs-property">message</span>);</li><li>    }</li><li>    <span class="hljs-keyword">const</span> buffer = fileData.<span class="hljs-property">buffer</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(buffer);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMap</span>();</li><li>    <span class="hljs-keyword">if</span> (pixelMap) {</li><li>      pixelMap.<span class="hljs-title function_">getImageInfo</span>(<span class="hljs-function">(<span class="hljs-params">err, imageInfo</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (imageInfo) {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>,</li><li>            <span class="hljs-string">`User profile imageInfo: <span class="hljs-subst">${imageInfo.size.width}</span> * <span class="hljs-subst">${imageInfo.size.height}</span>.`</span>);</li><li>        }</li><li>      });</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 构造上报来电的参数。注意，voipCallType.scene为您自定义的场景类型字段，从云侧推送消息时，请注意与端侧取值保持一致</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">call</span>: voipCall.<span class="hljs-property">VoipCallAttribute</span> = {</li><li>      <span class="hljs-attr">callId</span>: callId,</li><li>      <span class="hljs-attr">voipCallType</span>: scene?.<span class="hljs-property">scene</span> === <span class="hljs-string">'video'</span> ? voipCall.<span class="hljs-property">VoipCallType</span>.<span class="hljs-property">VOIP_CALL_VIDEO</span> :</li><li>      voipCall.<span class="hljs-property">VoipCallType</span>.<span class="hljs-property">VOIP_CALL_VOICE</span>,</li><li>      <span class="hljs-attr">userName</span>: <span class="hljs-string">'push'</span>,</li><li>      <span class="hljs-attr">userProfile</span>: pixelMap,</li><li>      <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'VoIPUIAbility'</span>,</li><li>      <span class="hljs-attr">voipCallState</span>: voipCall.<span class="hljs-property">VoipCallState</span>.<span class="hljs-property">VOIP_CALL_STATE_RINGING</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 上报来电</span></li><li>      <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">await</span> voipCall.<span class="hljs-title function_">reportIncomingCall</span>(call);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`ReportIncomingCall result: <span class="hljs-subst">${error}</span>.`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to report incoming call: %{public}d %{public}s'</span>, e.<span class="hljs-property">code</span>, e.<span class="hljs-property">message</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// ...应用播放振动和铃声</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">processVoipCallEvent</span>(<span class="hljs-params">event: voipCall.VoipCallUiEvent</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">switch</span> (event) {</li><li>        <span class="hljs-keyword">case</span> voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_VOICE_ANSWER</span>:</li><li>        <span class="hljs-keyword">case</span> voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_VIDEO_ANSWER</span>:</li><li>          <span class="hljs-comment">// 立即向Call Service Kit上报answered状态</span></li><li>          <span class="hljs-keyword">await</span> voipCall.<span class="hljs-title function_">reportCallStateChange</span>(<span class="hljs-title class_">VoipCallService</span>.<span class="hljs-property">callId</span>,</li><li>            voipCall.<span class="hljs-property">VoipCallState</span>.<span class="hljs-property">VOIP_CALL_STATE_ANSWERED</span>);</li><li>
</li><li>          <span class="hljs-comment">// ...在应用内完成接听</span></li><li>
</li><li>          <span class="hljs-comment">// 应用内接听后，向Call Service Kit上报active状态</span></li><li>          <span class="hljs-keyword">await</span> voipCall.<span class="hljs-title function_">reportCallStateChange</span>(<span class="hljs-title class_">VoipCallService</span>.<span class="hljs-property">callId</span>,</li><li>            voipCall.<span class="hljs-property">VoipCallState</span>.<span class="hljs-property">VOIP_CALL_STATE_ACTIVE</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_REJECT</span>:</li><li>        <span class="hljs-keyword">case</span> voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_HANGUP</span>:</li><li>          <span class="hljs-comment">// ...应用内完成挂断</span></li><li>
</li><li>          <span class="hljs-comment">// 向Call Service Kit上报通话状态</span></li><li>          <span class="hljs-keyword">await</span> voipCall.<span class="hljs-title function_">reportCallStateChange</span>(<span class="hljs-title class_">VoipCallService</span>.<span class="hljs-property">callId</span>,</li><li>            voipCall.<span class="hljs-property">VoipCallState</span>.<span class="hljs-property">VOIP_CALL_STATE_DISCONNECTED</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>: {</li><li>          <span class="hljs-keyword">break</span>;</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to report call state change: %{public}d %{public}s'</span>, e.<span class="hljs-property">code</span>, e.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">close</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Close VoIP`</span>);</li><li>
</li><li>    <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-title function_">processVoipCallEvent</span>(voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_HANGUP</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      voipCall.<span class="hljs-title function_">off</span>(<span class="hljs-string">'voipCallUiEvent'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to unregister event: %{public}d %{public}s'</span>, e.<span class="hljs-property">code</span>, e.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>需要在项目工程的src/main/resources/rawfile目录下添加example.png，表示来电时的用户头像。</p>        </div></div></div>       <ul>        <li>UIAbility.onCreate是同步接口，不支持异步回调，需要在onCreate生命周期的入口，完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-pushservice#section125883044911" target="_blank">pushService.receiveMessage</a>()注册，并且保证在注册前没有等待异步方法执行的调用。</li>        <li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-pushservice#section125883044911" target="_blank">receiveMessage</a>()回调中接收应用内通话消息，建议应用提前和服务器建连，用户点击接听后可以立即进行通话，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section7587131203319" target="_blank">voipCall.on</a>()接口注册监听通话状态回调。用户点击接听或者拒绝接听之后，系统会通过应用注册的事件监听通话状态回调结果。</li>        <li>应用需要在10秒内调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section13177019143216" target="_blank">voipCall.reportIncomingCall</a>()接口上报通话来电状态，调用完成之后，系统会弹出应用内通话横幅通知。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section13177019143216" target="_blank">voipCall.reportIncomingCall</a>()<strong>接口入参中的callId需要使用receiveMessage()回调中的callId</strong>。</li>        <li>如果应用来电消息建立失败，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section155796451716" target="_blank">voipCall.reportIncomingCallError</a>()通知来电消息建立失败。如果应用在前台，通过自己的网络连接接收到来电消息，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section13177019143216" target="_blank">voipCall.reportIncomingCall</a>()接口上报了通话来电状态，后面才收到Push推送的应用内通话消息，在该消息处理中需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section155796451716" target="_blank">voipCall.reportIncomingCallError</a>()上报<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section157617591167" target="_blank">应用线路忙</a>。</li>        <li>应用内通话主要有三种回调状态，分别为：接听状态、拒绝状态和挂断状态。         <ul>          <li>在接听状态回调中，应用在建立连接成功之后，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section491515915329" target="_blank">voipCall.reportCallStateChange</a>()接口上报通话激活状态。</li>          <li>在拒绝接听状态回调中，应用断开和服务器的连接之后，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section491515915329" target="_blank">voipCall.reportCallStateChange</a>()接口上报通话断开状态。</li>          <li>在应用进行应用内通话的同时，若运营商来电，会弹出运营商来电接听界面，用户点击接听运营商来电之后，会回调应用内通话挂断状态，在回调方法中应用需要自行断开和服务器的连接，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/call-voipcall#section491515915329" target="_blank">voipCall.reportCallStateChange</a>()接口上报通话断开状态。</li>         </ul></li>        <li>有关应用内通话回调状态的更多信息，详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/call-introduction" target="_blank">Call Service Kit简介</a>。</li>        <li>应用上报通话来电状态之后，可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-vibrator#vibratorstartvibration9-1" target="_blank">vibrator.startVibration</a>触发振动，有关振动的更多详情，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/sensorservice-kit-intro" target="_blank">Sensor Service Kit简介</a>。可以使用AVPlayer播放应用铃声，音频流建议设置为铃声，usage设置为STREAM_USAGE_RINGTONE，效果为开始响铃，播放的音乐会暂停播放。同时推荐使用AudioSession管理音频焦点，可以保证接听过程中、通话过程中都保持音频焦点，详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-kit-intro" target="_blank">Audio Kit简介</a>。</li>        <li>进行音视频通话时，若您的应用处于Overhead场景（设备发热严重或负载较重，Level=4），请降低码率和帧率，或关闭视频流降级为音频。相关说明请参见Basic Services Kit（基础服务）提供的接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resourceschedule-systemload#systemloadgetlevel" target="_blank">getLevel</a>()。</li>       </ul>       <p></p></li>      <li><span>在项目工程的 <strong>src/main/ets/pages</strong>目录添加：视频接听页面CalleePage.ets，代码示例如下：</span>       <p></p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 文件路径: src/main/ets/pages/CalleePage.ets</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">CallComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../component/CallComponent'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CalleePage</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'close'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'close'</span>) <span class="hljs-attr">end</span>: <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`CalleePage aboutToAppear`</span>);</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`CalleePage close`</span>);</li><li>
</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>(); <span class="hljs-comment">// 此处仅为示例（跳转返回），请根据实际情况设定路由</span></li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`CalleePage aboutToDisappear`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">CallComponent</span>({})</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>CallComponent.ets（在项目工程的<strong>src/main/ets/component</strong>目录下），代码示例如下：</p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 文件路径: src/main/ets/component/CallComponent.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">VoipCallService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../service/VoipCallService'</span>;</li><li><span class="hljs-keyword">import</span> { voipCall } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CallServiceKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">CallComponent</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'close'</span>) <span class="hljs-attr">end</span>: <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Flex</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-property">Column</span>, <span class="hljs-attr">justifyContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span> }) {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">30</span> }) {</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Button</span>()</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Green</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-title function_">processVoipCallEvent</span>(voipCall.<span class="hljs-property">VoipCallUiEvent</span>.<span class="hljs-property">VOIP_CALL_EVENT_VIDEO_ANSWER</span>);</li><li>            })</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Answer'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>).<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">5</span> })</li><li>        }</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Button</span>()</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-literal">true</span>;</li><li>              <span class="hljs-title class_">VoipCallService</span>.<span class="hljs-title function_">close</span>();</li><li>            })</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Hang Up'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>).<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">5</span> })</li><li>        }</li><li>
</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-string">'30 10'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>在项目工程的 src/main/resources/base/profile/main_pages.json添加page目录，示例如下：</p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>  <span class="hljs-attr">"src"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>    <span class="hljs-string">"pages/Index"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-string">"pages/CalleePage"</span></li><li>  <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>示例代码提供的页面效果仅供开发参考，不代表最终效果。</p>        </div></div></div>       <p></p></li>      <li><span>在项目工程的 <strong>src/main/module.json5</strong> 文件的 <strong>abilities </strong>模块中配置VoIPUIAbility的<strong>actions</strong>信息。</span>       <p></p>       <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>  <span class="hljs-punctuation">{</span> </li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"VoIPUIAbility"</span><span class="hljs-punctuation">,</span> </li><li>    <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/entryability/VoIPUIAbility.ets"</span><span class="hljs-punctuation">,</span> </li><li>    <span class="hljs-attr">"launchType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"singleton"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"VoIPUIAbility test"</span><span class="hljs-punctuation">,</span> </li><li>    <span class="hljs-attr">"startWindowIcon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$media:startIcon"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"startWindowBackground"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$color:start_window_background"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"exported"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> </li><li>    <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> </li><li>      <span class="hljs-comment">// 保持现有skill对象不变</span></li><li>      <span class="hljs-comment">// 新增一个独立的skill对象，配置actions参数</span></li><li>      <span class="hljs-punctuation">{</span> </li><li>        <strong><span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"action.ohos.push.listener"</span><span class="hljs-punctuation">]</span></strong></li><li>      <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li>  <span class="hljs-punctuation">}</span> </li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div>       <ul>        <li>actions：内容为<strong>action.ohos.push.listener</strong>，有且只能有一个ability定义该action，<strong>若同时添加uris参数，则uris内容需为空</strong>。</li>       </ul>       <p></p></li>      <li><span>应用服务端调用REST API推送消息，消息详情可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-intro" target="_blank">场景化消息API接口功能介绍</a>。</span></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section1759914419456" class="firsth2">应用内通话消息<i class="anchor-icon anchor-icon-link" anchorid="section1759914419456" tips="复制节点链接"></i></h3>         </div>    <ol>     <li><span>如果您需要呼叫，应用服务器可以调用REST API推送应用内通话消息，请求示例如下：</span>      <p></p>      <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Request URL    </span></li><li>POST <span class="hljs-string">"https://push-api.cloud.huawei.com/v3/[projectId]/messages:send"</span></li><li>
</li><li><span class="hljs-comment">// Request Header   </span></li><li>Content-Type<span class="hljs-punctuation">:</span> application/json   </li><li>Authorization<span class="hljs-punctuation">:</span> Bearer eyJr*****OiIx---****.eyJh*****iJodHR--***.QRod*****<span class="hljs-number">4</span>Gp---****   </li><li>push-type<span class="hljs-punctuation">:</span> <span class="hljs-number">10</span> </li><li>
</li><li><span class="hljs-comment">// Request Body</span></li><li><span class="hljs-punctuation">{</span>   </li><li>  <span class="hljs-attr">"pushOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> </li><li>    <span class="hljs-attr">"ttl"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span> </li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>  <span class="hljs-attr">"payload"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   </li><li>    <span class="hljs-attr">"extraData"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"scene\": \"voice\"}"</span> </li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   </li><li>  <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   </li><li>    <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MAMzLg**********aZW"</span><span class="hljs-punctuation">]</span>   </li><li>  <span class="hljs-punctuation">}</span> </li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div>      <ul>       <li>[projectId]：项目ID，登录<a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>网站，选择“开发与服务”，在项目列表中选择对应的项目，左侧导航栏选择“项目设置”，在该页面获取。</li>       <li>Authorization：JWT格式字符串，可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-jwt-token">基于服务账号生成鉴权令牌</a>进行获取。</li>       <li>push-type：10表示应用内通话消息场景。</li>       <li>token：Push Token，可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-get-token">获取Push Token</a>章节获取。</li>       <li>extraData：携带的额外数据，字符串类型。详情参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section146341550144011" target="_blank">VoIPCallPayload 应用内通话消息</a>中extraData参数用法。extraData数据获取请参考<a href="https://gitcode.com/harmonyos_samples/push-kit-sample-code-clientdemo-arkts/blob/master/entry/src/main/ets/service/VoipCallService.ets" target="_blank">示例代码</a>。</li>       <li>ttl：消息缓存时间，建议设置为30~60秒，详见pushOptions.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section418321011212" target="_blank">ttl</a>。</li>      </ul>      <p></p></li>    </ol>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>应用内通话消息只能用于音视频通话场景唤醒应用，完成呼叫，不要通过此种类型消息来挂断来电或者和应用通信，应用应该使用自己建立的网络连接和应用通信。相比应用服务器推送Push消息，使用现有的网络连接和应用通信通常会更快，在网络不佳的情况下，推送的Push消息可能无法到达应用。</li>       <li>应用无论是否在前台，自己的网络连接存在时，建议您通过Push推送应用内通话消息，再通过自己的网络连接发送通话消息，保证该呼叫能够到达应用。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h3 id="section3891827204616">未接来电通知<i class="anchor-icon anchor-icon-link" anchorid="section3891827204616" tips="复制节点链接"></i></h3>         </div>    <ol>     <li><span>如果您需要给被叫方发送未接来电通知，应用服务器可以调用REST API推送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-send-alert">通知消息</a>。以通知消息为例，请求示例如下：</span>      <p></p>      <div _ngcontent-wjv-c106="" class="highlight-div"><div _ngcontent-wjv-c106="" class="highlight-div-header"><div _ngcontent-wjv-c106="" class="highlight-div-header-left"><div _ngcontent-wjv-c106="" class="handle-button expand-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wjv-c106="" class="highlight-div-header-right"><div _ngcontent-wjv-c106="" class="handle-button ai-button"></div><div _ngcontent-wjv-c106="" class="handle-button line-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wjv-c106="" class="handle-button theme-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wjv-c106="" class="handle-button copy-button"><div _ngcontent-wjv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wjv-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Request URL    </span></li><li>POST <span class="hljs-string">"https://push-api.cloud.huawei.com/v3/</span><strong><span class="hljs-string">[projectId]</span></strong><span class="hljs-string">/messages:send"</span></li><li>   </li><li><span class="hljs-comment">// Request Header   </span></li><li>Content-Type<span class="hljs-punctuation">:</span> application/json   </li><li>Authorization<span class="hljs-punctuation">:</span> Bearer eyJr*****OiIx---****.eyJh*****iJodHR--***.QRod*****<span class="hljs-number">4</span>Gp---****   </li><li><strong>push-type<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span></strong> </li><li>   </li><li><span class="hljs-comment">// Request Body</span></li><li><span class="hljs-punctuation">{</span>   </li><li>  <span class="hljs-attr">"pushOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> </li><li>    <strong><span class="hljs-attr">"ttl"</span><span class="hljs-punctuation">:</span></strong><span class="hljs-number">86400</span></li><li>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> </li><li>  <span class="hljs-attr">"payload"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   </li><li>    <span class="hljs-attr">"notification"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> </li><li>      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MISS_CALL"</span><span class="hljs-punctuation">,</span>  </li><li>      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通知标题"</span><span class="hljs-punctuation">,</span> </li><li>      <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通知内容"</span><span class="hljs-punctuation">,</span> </li><li>      <span class="hljs-attr">"clickAction"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> </li><li>        <span class="hljs-attr">"actionType"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> </li><li>      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"appMessageId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12345"</span></li><li>    <span class="hljs-punctuation">}</span></li><li>   <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   </li><li>   <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>   </li><li>     <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MAMzLg**********aZW"</span><span class="hljs-punctuation">]</span>   </li><li>   <span class="hljs-punctuation">}</span> </li><li> <span class="hljs-punctuation">}</span></li></ol></pre></div></div>      <ul>       <li>push-type：0表示通知消息场景。</li>       <li>category：消息自分类类别，设置为MISS_CALL，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section17371529101117" target="_blank">参数说明</a>，发送消息前请确保您已<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-apply-right#section16708911111611">申请通知消息自分类权益</a>。</li>       <li>appMessageId：应用消息的唯一标识。被叫挂断，被叫方VoIP应用在前台时应用可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/notification-overview" target="_blank">Notification Kit（用户通知服务）</a>发送未接来电通知。被叫方VoIP应用在后台时，可以通过Push推送未接来电通知。应用可能存在前后台状态判断不准确，同一电话会产生两条未接来电，建议您通过Notification Kit和Push Kit推送的未接来电通知使用相同的appMessageId，系统会进行通知去重。</li>       <li>其他参数说明可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/push-scenariozed-api-request-param#section1152516418157" target="_blank">通知消息请求体参数说明</a>。</li>      </ul>      <p></p></li>    </ol>   </div>   <div></div></div>