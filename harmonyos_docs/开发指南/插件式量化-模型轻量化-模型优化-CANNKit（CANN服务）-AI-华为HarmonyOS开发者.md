<h1 _ngcontent-yun-c119="" class="doc-title ng-star-inserted" title="插件式量化"> 插件式量化 </h1>

<div _ngcontent-yun-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1866117442377">依赖环境准备<i class="anchor-icon anchor-icon-link" anchorid="section1866117442377" tips="复制节点链接"></i></h2><p>插件式量化运行环境依赖开发者本身的训练工程环境，目前轻量化工具支持TensorFlow和PyTorch两种框架的插件式量化。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>插件式量化环境配置完成后，可同时支持无训练和重训练量化。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section16110815547">TensorFlow插件式量化<i class="anchor-icon anchor-icon-link" anchorid="section16110815547" tips="复制节点链接"></i></h2><p class="msonormal">TensorFlow模型优化训练如下步骤：</p> <p>前提条件：准备模型训练数据集、全精度的基线ckpt文件。</p> <ol><li><span>准备TensorFlow环境（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section103814481178">准备TensorFlow环境</a>）。</span></li><li><span>调用API生成模型优化策略模板（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section7308624487">获取量化配置模板</a>）。</span></li><li><span>优化策略文件配置（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section1035414781018">优化策略配置</a>）。</span></li><li><span>训练模型（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section184938114114">训练或校准模型</a>）。（重训练模式对量化模型训练，无训练模式对量化模型进行校准）</span></li><li><span>提取模型及量化参数（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section11929116113114">转换模型</a>）。</span></li></ol> </div> <div class="tiledSection"><h3 id="section103814481178" class="firsth2">准备TensorFlow环境<i class="anchor-icon anchor-icon-link" anchorid="section103814481178" tips="复制节点链接"></i></h3><div class="p">准备Linux环境，使用轻量化工具插件式量化功能，开发者需要准备如下依赖。<ul><li>python 3.10版本</li><li>依赖python库说明：<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install ruamel_yaml</li><li>pip3 install pathlib</li><li>pip3 install protobuf==3.20.0</li><li>pip3 install opencv-python</li></ol></pre></div></div> </li><li>轻量化工具当前支持tensorflow-gpu 2.8.0版本，使用如下的命令安装：<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install tensorflow-gpu==2.8.0</li></ol></pre></div></div> </li></ul> </div> </div> <div class="tiledSection"><h3 id="section7308624487">获取量化配置模板<i class="anchor-icon anchor-icon-link" anchorid="section7308624487" tips="复制节点链接"></i></h3><p>将解压出的DDK中的dopt_tf_py3添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_tf_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li></ol></pre></div></div> <p>对需要进行量化的PyTorch模型，调用API生成量化配置json文件。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">from</span> dopt.dopt_tf.opt_main <span class="hljs-keyword">import</span> generate_config_file</li><li>generate_config_file(sess, dst_path=<span class="hljs-string">"./config_gen.json"</span>)</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.6.1.4.1.1" valign="top" width="17.73%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.6.1.4.1.2" valign="top" width="18.709999999999997%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.6.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.73%"><p>sess</p> </td> <td class="cellrowborder" valign="top" width="18.709999999999997%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>sess中加载原始的TensorFlow浮点模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.73%"><p>dst_path</p> </td> <td class="cellrowborder" valign="top" width="18.709999999999997%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>dst_path为生成配置json文件路径。</p> </td> </tr>  </tbody></table></div> </div> <div class="p">生成的配置样式如下。<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"quant_strategy_for op 'Conv2D'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"quant_strategy_for op 'MatMul'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"layer_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"model/resnet_model/conv2d/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Conv2D"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"float"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"model/resnet_model/conv2d_1/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Conv2D"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"float"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h3 id="section1035414781018">优化策略配置<i class="anchor-icon anchor-icon-link" anchorid="section1035414781018" tips="复制节点链接"></i></h3><p>基于上述生成的配置文件，确定要量化的层，并将对应的quant_strategy由float调整为对应的量化策略，例如Quant_INT8-8。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"quant_strategy_for op 'Conv2D'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"quant_strategy_for op 'MatMul'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"layer_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"model/resnet_model/conv2d/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Conv2D"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Quant_INT8-8"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"model/resnet_model/conv2d_1/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Conv2D"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Quant_INT8-8"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li><i><span class="varname">layer_strategy</span></i>中包含的为当前版本所支持的所有可量化层，开发者不应额外添加层。</li><li>开发者需要根据<i><span class="varname">op_type</span></i>选择支持的量化策略，若配置<i><span class="varname">op_type</span></i>为不支持的量化策略，那么在后续量化环节会报错。</li></ul> </div></div></div> </div> <div class="tiledSection"><h3 id="section184938114114">训练模型<i class="anchor-icon anchor-icon-link" anchorid="section184938114114" tips="复制节点链接"></i></h3><p>开发者需要进行插件式量化时，将解压出的DDK中的dopt_tf_py3文件路径添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_tf_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li><li>
</li><li><span class="hljs-keyword">from</span> dopt.dopt_tf.opt_main <span class="hljs-keyword">import</span> optimize_model</li></ol></pre></div></div> </div> <p>optimize_model接口在<i><span class="varname">session</span></i>中构造模型，并根据配置的量化策略json文件将模型进行量化。</p> <ul><li>配置标志位<i><span class="varname">is_train_flag</span></i>，表示模型当前的量化参数是否随训练更新。</li><li>配置标志位<i><span class="varname">quant_flag</span></i>，表示模型是否走量化通路。<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">with</span> tf.Session(config=config) <span class="hljs-keyword">as</span> sess:</li><li>    <span class="hljs-comment">## 待量化的tf模型graph，仅构建拓扑图，不可加载权重</span></li><li>    build_tf_model()</li><li>    quant_flag = tf.placeholder(tf.int32)</li><li>    is_train_flag = tf.placeholder(tf.<span class="hljs-built_in">bool</span>, name=<span class="hljs-string">'is_train'</span>)</li><li>    <span class="hljs-comment">## 模型量化，自动在 tf.get_default_graph()上进行改图操作</span></li><li>    optimize_model( </li><li>        sess,</li><li>        config_file,</li><li>        is_train_flag,</li><li>        quant_flag</li><li>    )</li><li>
</li><li>    <span class="hljs-comment">## 调用完optimize_model之后，加载模型权重</span></li><li>    saver = tf.Saver()</li><li>    saver.restore(ckpt)</li><li>    tf.global_variables_initializer().run()</li></ol></pre></div></div> </li></ul> <ul><li>build_tf_model：由开发者定义，在session中创建要量化的模型图。</li><li>quant_flag：tf.int32类型，其中为0表示走浮点通路（不做量化），为1（或其他正值）表示走量化通路，与is_train_flag共同作用。</li><li>is_train_flag：在quant_flag &gt; 0时，表示量化参数是否随训练更新。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.3.1.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>sess</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p><i><span class="varname">sess</span></i>中加载原始的TensorFlow浮点模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>config_file</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>开发者手动配置完成量化层的json文件路径。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>is_train_flag</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>模型当前的量化参数是否随训练更新。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>quant_flag</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>模型是否走量化通路。</p> </td> </tr>  </tbody></table></div> </div> </li></ul> <p>正常训练模型，检查损失函数loss，效果达标后，可停止训练，需保存对应的ckpt数据。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">## ckpt save </span></li><li>saver = tf.train.Saver() </li><li>saver.save(sess, train_ckpt_path)</li></ol></pre></div></div> <p>开发者需要进行无训练量化时，可以使用set_calibrate_state API设置为无训练模式。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">from</span> dopt.dopt_tf.opt_main <span class="hljs-keyword">import</span> set_calibrate_state </li><li>
</li><li>calibration_mode = <span class="hljs-literal">True</span></li><li>set_calibrate_state(sess, calibration_mode ) </li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.14.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.14.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.14.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>sess</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>量化后的TensorFlow Session。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>calibration_mode</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>bool变量，开发者是否开启无训练（校准）模式。</p> <ul><li>True：开启无训练（校准）模式</li><li>False：关闭无训练（校准）模式</li></ul> </td> </tr>  </tbody></table></div> </div> <p>完成无训练模式的设置之后，使用量化后的<span class="parmvalue">“sess”</span>对校准集进行前向推理就可进行无训练量化。</p> <div class="tiledSection"><h3 id="section11929116113114">转换模型<i class="anchor-icon anchor-icon-link" anchorid="section11929116113114" tips="复制节点链接"></i></h3><p>完成模型量化以及重训练或者校准集前向推理后即可对量化参数进行收集，将session中的量化参数提取至量化文件中并生成对应的PB文件。</p> </div> <p>将解压出的DDK中的dopt_tf_py3文件路径添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_tf_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li><li>
</li><li><span class="hljs-keyword">from</span> dopt.dopt_tf.opt_main <span class="hljs-keyword">import</span> generate_final_model</li></ol></pre></div></div> <p>初始化原始浮点模型，加载量化训练的ckpt，利用提供的接口提取参数。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">with</span> tf.Session(config=config) <span class="hljs-keyword">as</span> sess:</li><li>    build_tf_model()</li><li>        generate_final_model(</li><li>        sess,</li><li>        config_file         = FLAGS.config_file,</li><li>        output_name_list    = output_name_list,</li><li>        ckpt_file           = train_ckpt_path,</li><li>        output_dir          = output_dir</li><li>    )</li></ol></pre></div></div> <div class="p">build_tf_model：由开发者定义，在session中创建要量化的模型图。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.1.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>sess</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p><i><span class="varname">sess</span></i>中加载原始的TensorFlow浮点模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>config_file</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>开发者手动配置完成量化层的json文件路径与optimize_model处理时的配置保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>output_name_list</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>pb模型的最后一层输出节点名，数据类型为list。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>ckpt_file</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>量化重训练或校准保存的ckpt数据。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>output_dir</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>提取的pb和量化参数保存路径，需确保该路径存在，如果不填写模型在当前路径下保存。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section162431930104618">PyTorch插件式量化<i class="anchor-icon anchor-icon-link" anchorid="section162431930104618" tips="复制节点链接"></i></h2><p class="msonormal">PyTorch模型优化训练如下步骤：</p> <p>前提条件：准备模型训练数据集、全精度的基线参数pth文件。</p> <ol><li><span>准备PyTorch环境（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section461318612307">准备PyTorch环境</a>）。</span></li><li><span>调用API生成量化配置json文件（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section1374313714435">生成量化配置json文件</a>）。</span></li><li><span>修改策略文件配置（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section16522384430">优化策略配置</a>）。</span></li><li><span>调用API训练量化模型（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section767733515413">训练或校准模型</a>）。</span></li><li><span>调用API生成量化ONNX模型及量化参数文件（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-plugin-based-quantization#section1567210444438">生成量化模型</a>）。</span></li></ol> </div> <div class="tiledSection"><h3 id="section461318612307" class="firsth2">准备PyTorch环境<i class="anchor-icon anchor-icon-link" anchorid="section461318612307" tips="复制节点链接"></i></h3><p>使用轻量化工具插件式量化功能，开发者需要准备如下依赖。</p> <ul><li>python 3.10版本</li><li>依赖python库说明：<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install ruamel_yaml</li><li>pip3 install pathlib</li><li>pip3 install protobuf&gt;=3.20.0</li><li>pip3 install onnx==1.14.0</li></ol></pre></div></div> </li><li class="MsoNormal">轻量化工具当前仅支持PyTorch 1.11版本。使用如下的命令安装：<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install torch==1.11.0</li></ol></pre></div></div> </li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>路径：支持大小写字母、数字、下划线。</li><li>文件名：支持大小写字母、数字、下划线和点(.)。</li></ul> </div></div></div> </div> <div class="tiledSection"><h3 id="section1374313714435">生成量化配置json文件<i class="anchor-icon anchor-icon-link" anchorid="section1374313714435" tips="复制节点链接"></i></h3><p>将解压出的DDK中的dopt_pytorch_py3文件路径添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_pytorch_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li><li>
</li><li><span class="hljs-keyword">from</span> dopt.dopt_torch.opt_main <span class="hljs-keyword">import</span> generate_config_file</li></ol></pre></div></div> <p>对需要进行量化的PyTorch模型，调用API生成量化配置json文件。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>generate_config_file(model, input_shape, dst_path=<span class="hljs-string">"./config_gen.json"</span>) <span class="hljs-comment"># model：torch.nn.Module， input_shape : "input1:input1.shape;input2:input2.shape"</span></li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.24.6.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.24.6.1.4.1.2" valign="top" width="18.87%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.24.6.1.4.1.3" valign="top" width="63.39%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>model</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>torch.nn.Module，未经过torch.nn.parallel.DistributedDataParallel等分布式API封装的模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>input_shape</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>最终部署模型的shape，而非训练阶段的训练数据shape。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>dst_path</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>生成配置json文件路径。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section16522384430">优化策略配置<i class="anchor-icon anchor-icon-link" anchorid="section16522384430" tips="复制节点链接"></i></h3><div class="p">生成的配置文件如下：<div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"quant_strategy_for op '&lt;class 'torch.nn.modules.conv.Conv2d'&gt;'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"quant_strategy_for op '&lt;class 'torch.nn.modules.linear.Linear'&gt;'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"input_shape"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x:1,3,224,224"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"layer_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"conv1/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;class 'torch.nn.modules.conv.Conv2d'&gt;"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"float"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"conv2/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;class 'torch.nn.modules.conv.Conv2d'&gt;"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"float"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> </div> </div> <p>开发者可根据需要的量化修改配置。</p> <ul><li>支持逐层配置量化策略，默认为"float"。</li><li>支持的量化策略Quant_INT8-8为8a8w。</li></ul> <p>以上述json为例，开发者可修改成：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"quant_strategy_for op '&lt;class 'torch.nn.modules.conv.Conv2d'&gt;'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"quant_strategy_for op '&lt;class 'torch.nn.modules.linear.Linear'&gt;'"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-string">"Quant_INT8-8"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"input_shape"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x:1,3,224,224"</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"layer_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>        <span class="hljs-attr">"conv1/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;class 'torch.nn.modules.conv.Conv2d'&gt;"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Quant_INT8-8"</span>，</li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-attr">"conv2/Conv2D"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"op_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;class 'torch.nn.modules.conv.Conv2d'&gt;"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"//"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可以逐层配置量化，不量化的层保持浮点"</span><span class="hljs-punctuation">,</span></li><li>            <span class="hljs-attr">"quant_strategy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"float"</span></li><li>        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <ul><li>layer_strategy中包含的为当前版本所支持的所有可量化层，开发者不应额外添加层。</li><li>开发者需要根据<i><span class="varname">op_type</span></i>选择支持的量化策略，若配置<i><span class="varname">op_type</span></i>为不支持的量化策略，那么在后续量化环节会报错。</li><li>json文件中，除了input_shape和layer_strategy两个key之外，其余内容为提示作用，不会进行解析。</li></ul> <div class="tiledSection"><h3 id="section767733515413">训练模型<i class="anchor-icon anchor-icon-link" anchorid="section767733515413" tips="复制节点链接"></i></h3><p>将解压出的DDK中的dopt_pytorch_py3文件路径添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_pytorch_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li><li><span class="hljs-keyword">from</span> dopt.dopt_torch.opt_main <span class="hljs-keyword">import</span> optimize_model</li></ol></pre></div></div> </div> <p>开发者需在PyTorch模型定义阶段调用API进行模型的量化操作。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>quant_model = optimize_model(model, config_path) <span class="hljs-comment">## config_path为上一步中修改后的json文件绝对路径</span></li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.34.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.34.1.4.1.2" valign="top" width="18.87%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.34.1.4.1.3" valign="top" width="63.39%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>model</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>torch.nn.Module，未经过torch.nn.parallel.DistributedDataParallel等分布式API封装的模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>config_path</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>最终部署模型的shape，而非训练阶段的训练数据shape。</p> </td> </tr>  </tbody></table></div> </div> <p>开发者可根据需要调用API，获取量化相关的损失函数，加入到优化训练中（可选项，简单任务不推荐使用）。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">from</span> dopt.dopt_torch.opt_main <span class="hljs-keyword">import</span> get_quant_loss</li><li>quant_loss = get_quant_loss(quant_model)</li><li>total_loss = loss + quant_weight * quant_loss <span class="hljs-comment">## quant_weight为量化损失的超参数</span></li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.37.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.37.1.4.1.2" valign="top" width="18.87%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.37.1.4.1.3" valign="top" width="63.39%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>quant_model</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>经过optimize_model API处理后量化模型。</p> </td> </tr>  </tbody></table></div> </div> <p>对量化训练完成的模型需要保存其对应的checkpoint。</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>torch.save(quant_model.state_dict(),<span class="hljs-string">"quant.pth"</span>)</li></ol></pre></div></div> <p>如果开发者无需进行重训练量化可以只进行无训练量化，开启无训练只需调用set_calibrate_state API</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">from</span> dopt.dopt_torch.opt_main <span class="hljs-keyword">import</span> set_calibrate_state </li><li>calibrate_mode = <span class="hljs-literal">True</span></li><li>set_calibrate_state(quant_model, calibrate_mode)</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.42.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.42.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.42.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>quant_model</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>量化后的PyTorch模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>calibration_mode</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>bool变量，开发者是否开启无训练（校准）模式。</p> <ul><li>True：开启无训练（校准）模式</li><li>False：关闭无训练（校准）模式</li></ul> </td> </tr>  </tbody></table></div> </div> <p>完成无训练模式的设置之后，使用量化后的quant_model对校准集进行前向推理就可进行无训练量化。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>调用optimize_model函数的入参model需要是未经过torch.nn.parallel.DistributedDataParallel等分布式API封装的模型，且优化器optimizer需要针对quant_model而非原始浮点模型。</li><li>量化损失非必须添加，quant_loss需要根据实际量化损失的大小和原始损失的大小进行超参数的调节，一般量化损失函数与原始损失函数比例为1:20，如对优化方向产生较大影响，建议减少量化损失的占比。</li></ul> </div></div></div> <div class="tiledSection"><h3 id="section1567210444438">生成量化模型<i class="anchor-icon anchor-icon-link" anchorid="section1567210444438" tips="复制节点链接"></i></h3><p>将解压出的DDK中的dopt_pytorch_py3文件路径添加到python环境变量中：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys</li><li>sys.path.append(<span class="hljs-string">".../dopt_pytorch_py3"</span>) <span class="hljs-comment">## 其中路径为绝对路径</span></li><li>
</li><li><span class="hljs-keyword">from</span> dopt.dopt_torch.opt_main <span class="hljs-keyword">import</span> generate_final_model</li></ol></pre></div></div> <p>训练完成后，使用对应API生成最终模型：</p> <div _ngcontent-yun-c106="" class="highlight-div"><div _ngcontent-yun-c106="" class="highlight-div-header"><div _ngcontent-yun-c106="" class="highlight-div-header-left"><div _ngcontent-yun-c106="" class="handle-button expand-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yun-c106="" class="highlight-div-header-right"><div _ngcontent-yun-c106="" class="handle-button ai-button"></div><div _ngcontent-yun-c106="" class="handle-button line-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yun-c106="" class="handle-button theme-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yun-c106="" class="handle-button copy-button"><div _ngcontent-yun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yun-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>generate_final_model(</li><li>    model,              <span class="hljs-comment">## 浮点模型</span></li><li>    config_file,         <span class="hljs-comment">## 量化配置json文件</span></li><li>    pth_file = <span class="hljs-string">"quant.pth"</span>,    <span class="hljs-comment">## 量化后 pth 文件</span></li><li>    output_dir = <span class="hljs-string">"./"</span>   <span class="hljs-comment">## 量化para与PyTorch的生成文件夹</span></li><li>)</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.45.6.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.45.6.1.4.1.2" valign="top" width="18.87%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.45.6.1.4.1.3" valign="top" width="63.39%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>model</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>浮点模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>config_file</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>量化配置json文件路径，与optimize_model api的处理的config_path保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>pth_file</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>量化训练的权重文件。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>output_dir</p> </td> <td class="cellrowborder" valign="top" width="18.87%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.39%"><p>PyTorch和量化参数保存路径。请确保该路径存在，如果不填写，模型将默认保存到当前路径下。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>调用generate_final_model函数的入参model须为重新构建的浮点模型。</li><li>生成的PyTorch模型中不带有量化参数，但是会做部分图融合以及伪量化处理。</li></ul> </div></div></div> </div> </div> <div></div></div>