<h1 _ngcontent-rvu-c119="" class="doc-title ng-star-inserted" title="插屏广告"> 插屏广告 </h1>

<div _ngcontent-rvu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section14127192712199">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section14127192712199" tips="复制节点链接"></i></h2><p>插屏广告是一种在应用开启、暂停或退出时以全屏或半屏的形式弹出的广告形式，展示时机巧妙避开用户对应用的正常体验，尺寸大，曝光效果好。</p> </div> <p><span><img height="659.6800000000001" originheight="2040" originwidth="987" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114627.66159083222109264000849671591038:50001231000000:2800:3F7A9797A26D1DEB97C1ED978781B7AE17AE18F1EEFE17322AA1D84D9A614452.png" title="点击放大" width="319.20000000000005"></span></p> <div class="tiledSection"><h2 id="section9903185632617">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section9903185632617" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#loadad" target="_blank">loadAd</a>(adParam: AdRequestParams, adOptions: AdOptions, listener: AdLoadListener): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>请求单广告位广告，通过AdRequestParams、AdOptions进行广告请求参数设置，通过AdLoadListener监听广告请求回调。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#showad" target="_blank">showAd</a>(ad: Advertisement, options: AdDisplayOptions, context?: common.UIAbilityContext): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>展示广告，通过AdDisplayOptions进行广告展示参数设置。</p> <p><strong>说明：</strong>为了保证广告能正确展示，该接口必须和请求广告接口配套使用。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section03887483515">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section03887483515" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0237145185117" class="firsth2">请求广告<i class="anchor-icon anchor-icon-link" anchorid="section0237145185117" tips="复制节点链接"></i></h3></div> <ol><li><span>导入相关模块。</span><p></p><div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, common, <span class="hljs-title class_">PermissionRequestResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { advertising, identifier } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AdsKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>获取OAID。</span><p></p><p>若需提升广告推送精准度，可以在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#adrequestparams" target="_blank">AdRequestParams</a>中添加oaid属性。</p> <p>如何获取OAID参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/oaid-service" target="_blank">获取OAID信息</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用以下示例中提供的测试广告位时，必须先获取OAID信息。</p> </div></div></div> <p></p></li><li><span>请求单广告位广告。</span><p></p><p>需要先创建一个AdLoader对象，通过AdLoader的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#loadad" target="_blank">loadAd</a>方法请求广告，最后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#adloadlistener" target="_blank">AdLoadListener</a>来监听广告的加载状态。</p> <p>请求广告关键参数如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.5.1.1" valign="top" width="16.85%"><p>请求广告参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.5.1.2" valign="top" width="11.26%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.5.1.3" valign="top" width="9.9%"><p>必填</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.2.3.1.5.1.4" valign="top" width="61.99%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.85%"><p>adType</p> </td> <td class="cellrowborder" valign="top" width="11.26%"><p>number</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>请求广告类型，插屏广告类型为12。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.85%"><p>adId</p> </td> <td class="cellrowborder" valign="top" width="11.26%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>广告位ID。</p> <ul><li>如果仅调测广告，可使用测试广告位ID：testb4znbuh3n2。</li><li>如果要接入正式广告，则需要申请正式的广告位ID。可在应用发布前进入<a href="https://developer.huawei.com/consumer/cn/monetize" target="_blank">流量变现官网</a>，点击“开始变现”，登录<a href="https://developer.huawei.com/consumer/cn/service/ads/publisher/html/index.html?lang=zh" target="_blank">鲸鸿动能媒体服务平台</a>进行申请，具体操作详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/monetize/zhanshiweichuangjian-0000001132700049" target="_blank">展示位创建</a>。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.85%"><p>oaid</p> </td> <td class="cellrowborder" valign="top" width="11.26%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>开放匿名设备标识符，用于精准推送广告。不填无法获取到个性化广告。</p> </td> </tr>  </tbody></table></div> </div> <p>示例代码如下所示：</p> <div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'LoadAd'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadAd</span>();</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadAd</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// 广告请求回调监听</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoadListener</span>: advertising.<span class="hljs-property">AdLoadListener</span> = {</li><li>      <span class="hljs-attr">onAdLoadFailure</span>: <span class="hljs-function">(<span class="hljs-params">errorCode: <span class="hljs-built_in">number</span>, errorMsg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${errorCode}</span>, message is <span class="hljs-subst">${errorMsg}</span>`</span>);</li><li>      },</li><li>      <span class="hljs-attr">onAdLoadSuccess</span>: <span class="hljs-function">(<span class="hljs-params">ads: <span class="hljs-built_in">Array</span>&lt;advertising.Advertisement&gt;</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading ad'</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// 广告请求参数</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adRequestParams</span>: advertising.<span class="hljs-property">AdRequestParams</span> = {</li><li>      <span class="hljs-comment">// 'testb4znbuh3n2'为测试专用的广告位ID，App正式发布时需要改为正式的广告位ID</span></li><li>      <span class="hljs-attr">adId</span>: <span class="hljs-string">'testb4znbuh3n2'</span>,</li><li>      <span class="hljs-comment">// 插屏广告类型</span></li><li>      <span class="hljs-attr">adType</span>: <span class="hljs-number">12</span>,</li><li>      <span class="hljs-comment">// 开放匿名设备标识符</span></li><li>      <span class="hljs-attr">oaid</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestOAID</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>)</li><li>    };</li><li>    <span class="hljs-comment">// 广告配置参数，开发者可根据项目实际情况设置</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adOptions</span>: advertising.<span class="hljs-property">AdOptions</span> = {};</li><li>    <span class="hljs-comment">// 创建AdLoader广告对象</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoader</span>: advertising.<span class="hljs-property">AdLoader</span> = <span class="hljs-keyword">new</span> advertising.<span class="hljs-title class_">AdLoader</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 调用广告请求接口</span></li><li>      adLoader.<span class="hljs-title function_">loadAd</span>(adRequestParams, adOptions, adLoadListener);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestOAID</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-comment">// 向用户请求授权广告跨应用关联访问权限</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isPermissionGranted</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionRequestResult</span> =</li><li>      <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.APP_TRACKING_CONSENT'</span>]);</li><li>    isPermissionGranted = result.<span class="hljs-property">authResults</span>[<span class="hljs-number">0</span>] === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to request permission. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (isPermissionGranted) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in requesting permission'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> oaid = <span class="hljs-keyword">await</span> identifier.<span class="hljs-title function_">getOAID</span>();</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in getting OAID'</span>);</li><li>      <span class="hljs-keyword">return</span> oaid;</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to get OAID. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to request permission. User rejected'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre></div></div> <p></p></li></ol> <div class="tiledSection"><h3 id="section14755121210539">事件订阅<i class="anchor-icon anchor-icon-link" anchorid="section14755121210539" tips="复制节点链接"></i></h3><ol><li><span>导入相关模块。</span><p></p><div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, commonEventManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div> <p></p></li><li class="continue"><span>事件订阅。</span><p></p><p>开发者需要在应用中订阅com.huawei.hms.pps.action.PPS_INTERSTITIAL_STATUS_CHANGED事件来监听插屏广告页面变化。</p> <p>在订阅到公共事件后，可以从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-commonevent-commoneventdata" target="_blank">CommonEventData</a>的parameters参数中使用interstitial_ad_status作为key值获取插屏广告页面变化状态。</p> <p>涉及的页面变化状态如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.2.2.2.4.1.3.1.1" valign="top" width="44.26%"><p>页面变化状态</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.2.2.2.4.1.3.1.2" valign="top" width="55.74%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdOpen</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>打开广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdClick</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>点击广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdClose</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>关闭广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onVideoPlayBegin</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>广告视频开始播放。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onVideoPlayEnd</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>广告视频播放结束。</p> </td> </tr>  </tbody></table></div> </div> <p>示例代码如下所示：</p> <div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEY_INTERSTITIAL_STATUS</span> = <span class="hljs-string">'interstitial_ad_status'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterstitialAdStatusHandler</span> {</li><li>  <span class="hljs-comment">// 用于保存创建成功的订阅者对象，后续使用其完成订阅及退订的动作</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">subscriber</span>: commonEventManager.<span class="hljs-property">CommonEventSubscriber</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-comment">// 订阅方法，需要在每次展示广告前调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerPPSReceiver</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unRegisterPPSReceiver</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 订阅者信息</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">subscribeInfo</span>: commonEventManager.<span class="hljs-property">CommonEventSubscribeInfo</span> = {</li><li>      <span class="hljs-attr">events</span>: [<span class="hljs-string">'com.huawei.hms.pps.action.PPS_INTERSTITIAL_STATUS_CHANGED'</span>],</li><li>      <span class="hljs-comment">// publisherBundleName被设置为"com.huawei.hms.adsservice",这意味着只有来自该包名的事件才会被订阅者接受和处理。</span></li><li>      <span class="hljs-comment">// 如果没有明确声明publisherBundleName，那么订阅者可能会收到来自其它包名的伪造事件，从而导致安全性问题或误导。</span></li><li>      <span class="hljs-attr">publisherBundleName</span>: <span class="hljs-string">'com.huawei.hms.adsservice'</span></li><li>    };</li><li>    <span class="hljs-comment">// 创建订阅者回调</span></li><li>    commonEventManager.<span class="hljs-title function_">createSubscriber</span>(subscribeInfo,</li><li>      <span class="hljs-function">(<span class="hljs-params">err: BusinessError, commonEventSubscriber: commonEventManager.CommonEventSubscriber</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to create subscriber. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in creating subscriber'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span> = commonEventSubscriber;</li><li>        <span class="hljs-comment">// 订阅公共事件回调</span></li><li>        commonEventManager.<span class="hljs-title function_">subscribe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>,</li><li>          <span class="hljs-function">(<span class="hljs-params">err: BusinessError, commonEventData: commonEventManager.CommonEventData</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to subscribe. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// 订阅者成功接收到公共事件</span></li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in subscribing data'</span>);</li><li>              <span class="hljs-comment">// 获取插屏广告页面变化状态</span></li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">status</span>: <span class="hljs-built_in">string</span> = commonEventData?.<span class="hljs-property">parameters</span>?.[<span class="hljs-variable constant_">KEY_INTERSTITIAL_STATUS</span>];</li><li>              <span class="hljs-keyword">switch</span> (status) {</li><li>                <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdOpen'</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdOpen'</span>);</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdClick'</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdClick'</span>);</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdClose'</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdClose'</span>);</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unRegisterPPSReceiver</span>();</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> <span class="hljs-string">'onVideoPlayBegin'</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onVideoPlayBegin'</span>);</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-keyword">case</span> <span class="hljs-string">'onVideoPlayEnd'</span>:</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onVideoPlayEnd'</span>);</li><li>                  <span class="hljs-keyword">break</span>;</li><li>                <span class="hljs-attr">default</span>:</li><li>                  <span class="hljs-keyword">break</span>;</li><li>              }</li><li>            }</li><li>          });</li><li>      });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 取消订阅</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterPPSReceiver</span>(): <span class="hljs-built_in">void</span> {</li><li>    commonEventManager.<span class="hljs-title function_">unsubscribe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to unsubscribe. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in unsubscribing'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span> = <span class="hljs-literal">null</span>;</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section10729748635">展示广告<i class="anchor-icon anchor-icon-link" anchorid="section10729748635" tips="复制节点链接"></i></h3><ol><li><span>导入相关模块。</span><p></p><div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { advertising } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AdsKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// 事件订阅步骤中创建的文件</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">InterstitialAdStatusHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./InterstitialAdStatusHandler'</span>;</li></ol></pre></div></div> <p></p></li><li><span>展示广告。</span><p></p><p class="continue">开发者需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#showad" target="_blank">showAd</a>方法来展示广告，ads为<a href="/consumer/cn/doc/harmonyos-guides/ads-publisher-service-interstitial#section0237145185117">请求广告</a>返回的广告信息，在每次展示广告前需要注册<a href="/consumer/cn/doc/harmonyos-guides/ads-publisher-service-interstitial#section14755121210539">事件订阅</a>中定义的监听器。</p> <p class="continue">示例代码如下所示：</p> <div _ngcontent-rvu-c106="" class="highlight-div"><div _ngcontent-rvu-c106="" class="highlight-div-header"><div _ngcontent-rvu-c106="" class="highlight-div-header-left"><div _ngcontent-rvu-c106="" class="handle-button expand-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rvu-c106="" class="highlight-div-header-right"><div _ngcontent-rvu-c106="" class="handle-button ai-button"></div><div _ngcontent-rvu-c106="" class="handle-button line-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rvu-c106="" class="handle-button theme-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rvu-c106="" class="handle-button copy-button"><div _ngcontent-rvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rvu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadAd</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// 广告请求回调监听</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoadListener</span>: advertising.<span class="hljs-property">AdLoadListener</span> = {</li><li>      <span class="hljs-attr">onAdLoadFailure</span>: <span class="hljs-function">(<span class="hljs-params">errorCode: <span class="hljs-built_in">number</span>, errorMsg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${errorCode}</span>, message is <span class="hljs-subst">${errorMsg}</span>`</span>);</li><li>      },</li><li>      <span class="hljs-attr">onAdLoadSuccess</span>: <span class="hljs-function">(<span class="hljs-params">ads: <span class="hljs-built_in">Array</span>&lt;advertising.Advertisement&gt;</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading ad'</span>);</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-comment">// 注册插屏广告状态监听器</span></li><li>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterstitialAdStatusHandler</span>().<span class="hljs-title function_">registerPPSReceiver</span>();</li><li>          <span class="hljs-comment">// 广告展示参数，开发者可根据项目实际情况设置</span></li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">adDisplayOptions</span>: advertising.<span class="hljs-property">AdDisplayOptions</span> = {</li><li>            <span class="hljs-comment">// 是否静音</span></li><li>            <span class="hljs-attr">mute</span>: <span class="hljs-literal">true</span></li><li>          };</li><li>          <span class="hljs-comment">// 此处ads[0]表示请求到的第一个广告，开发者可根据项目实际情况选择</span></li><li>          advertising.<span class="hljs-title function_">showAd</span>(ads[<span class="hljs-number">0</span>], adDisplayOptions, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to show ad. Code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>        }</li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>