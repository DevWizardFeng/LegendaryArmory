<h1 _ngcontent-srv-c119="" class="doc-title ng-star-inserted" title="数字版权保护(C/C++)"> 数字版权保护(C/C++) </h1>

<div _ngcontent-srv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="功能介绍">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="功能介绍" tips="复制节点链接"></i></h2>          <p>开发者可以调用DRM Kit的C/C++接口实现DRM证书管理、DRM许可证管理、DRM节目授权、DRM节目解密等数字版权保护功能。</p>     <p>DRM Kit提供MediaKeySystem实现DRM证书管理、DRM许可证管理功能，并管理MediaKeySession实例；MediaKeySession实现DRM节目授权，并可支持Media Kit或AVCodec Kit实现DRM节目解密以实现DRM节目播放。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-drm" target="_blank">DRM API</a>。</p>     <ol>      <li>       <p>导入DRM Kit接口。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/drm_framework/native_drm_common.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/drm_framework/native_drm_err.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/drm_framework/native_mediakeysession.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"multimedia/drm_framework/native_mediakeysystem.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接动态库。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(PUBLIC libnative_drm.so)</li></ol></pre></div></div></li>      <li>       <p>获取设备支持的DRM解决方案名称和唯一标识的列表。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint32_t</span> count = <span class="hljs-number">3</span>; <span class="hljs-comment">// count是当前设备实际支持的DRM插件的个数，用户根据实际情况设置。</span></li><li>DRM_MediaKeySystemDescription descriptions[<span class="hljs-number">3</span>];</li><li><span class="hljs-built_in">memset</span>(descriptions, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(descriptions));</li><li>Drm_ErrCode ret = <span class="hljs-built_in">OH_MediaKeySystem_GetMediaKeySystems</span>(descriptions, &amp;count);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_GetMediaKeySystems failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）查询设备是否支持对应DRM解决方案名称、媒体类型、安全保护级别的DRM解决方案。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_MediaKeySystem_IsSupported3</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, <span class="hljs-string">"video/mp4"</span>, CONTENT_PROTECTION_LEVEL_SW_CRYPTO);</li><li><span class="hljs-keyword">if</span> (isSupported != <span class="hljs-literal">true</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The device does not support the content protection level."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建MediaKeySystem实例。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>MediaKeySystem *mediaKeySystem = <span class="hljs-literal">nullptr</span>;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;mediaKeySystem);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK || mediaKeySystem == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_Create failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）设置MediaKeySystem事件监听回调。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> Drm_ErrCode <span class="hljs-title">SystemCallBackWithObj</span><span class="hljs-params">(MediaKeySystem *mediaKeySystem, DRM_EventType eventType,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">uint8_t</span> *info, <span class="hljs-type">int32_t</span> infoLen, <span class="hljs-type">char</span> *extra)</span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"SystemCallBackWithObj enter"</span>);</li><li>    <span class="hljs-keyword">if</span> (eventType == EVENT_PROVISION_REQUIRED) {</li><li>        <span class="hljs-comment">// 设备DRM证书请求和处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> DRM_ERR_OK;</li><li>}</li><li>
</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_SetCallback</span>(mediaKeySystem, SystemCallBackWithObj);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_SetCallback failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）获取设备DRM证书状态。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">DRM_CertificateStatus</span> <span class="hljs-variable">certStatus</span> <span class="hljs-operator">=</span> CERT_STATUS_INVALID;</li><li><span class="hljs-comment">// 检查设备DRM证书状态。</span></li><li>ret = OH_MediaKeySystem_GetCertificateStatus(mediaKeySystem, &amp;certStatus);</li><li><span class="hljs-keyword">if</span> (ret == DRM_ERR_OK &amp;&amp; certStatus != CERT_STATUS_PROVISIONED) {</li><li>    <span class="hljs-comment">// 设备DRM证书请求和处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）生成设备DRM证书请求与处理设备DRM证书响应。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_DRM_PROVISION_BUF_SIZE 24576 <span class="hljs-comment">// 24576: (2 * 12 * 1024)</span></span></li><li><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> request[MAX_DRM_PROVISION_BUF_SIZE] = { <span class="hljs-number">0x00</span> };  <span class="hljs-comment">// 设备DRM证书request最大长度为MAX_DRM_PROVISION_BUF_SIZE，按实际大小申请。</span></li><li><span class="hljs-type">int32_t</span> requestLen = MAX_DRM_PROVISION_BUF_SIZE;</li><li><span class="hljs-comment">// DRM服务URL的最大长度为2048。</span></li><li><span class="hljs-type">char</span> defaultUrl[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0x00</span> };</li><li><span class="hljs-type">int32_t</span> defaultUrlLen = <span class="hljs-number">2048</span>;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_GenerateKeySystemRequest</span>(mediaKeySystem, request, &amp;requestLen, defaultUrl,</li><li>    defaultUrlLen);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_GenerateKeySystemRequest failed."</span>);</li><li>}</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  应用通过网络请求，将设备DRM证书请求信息传到DRM服务获取设备DRM证书请求响应keySystemResponse，</span></li><li><span class="hljs-comment">  再将设备DRM证书请求响应设置到设备上，请根据实际的数据和长度传入。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> keySystemResponse[MAX_DRM_PROVISION_BUF_SIZE] = {<span class="hljs-number">0x00</span>};</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_ProcessKeySystemResponse</span>(mediaKeySystem, keySystemResponse, <span class="hljs-built_in">sizeof</span>(keySystemResponse));</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_ProcessKeySystemResponse failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）获取设备支持的最大内容保护级别。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>DRM_ContentProtectionLevel maxContentProtectionLevel = CONTENT_PROTECTION_LEVEL_UNKNOWN;</li><li>ret = OH_MediaKeySystem_GetMaxContentProtectionLevel(mediaKeySystem, &amp;maxContentProtectionLevel);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_GetMaxContentProtectionLevel failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建MediaKeySession实例。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>MediaKeySession *mediaKeySession = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_SW_CRYPTO; <span class="hljs-comment">// 依据设备支持的内容保护级别设置。</span></li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(mediaKeySystem, &amp;contentProtectionLevel, &amp;mediaKeySession);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK || mediaKeySession == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_CreateMediaKeySession failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）设置MediaKeySession事件监听回调。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> Drm_ErrCode <span class="hljs-title">SessionEventCallBackWithObj</span><span class="hljs-params">(MediaKeySession *mediaKeySession, DRM_EventType eventType, <span class="hljs-type">uint8_t</span> *info, <span class="hljs-type">int32_t</span> infoLen, <span class="hljs-type">char</span> *extra)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (eventType == EVENT_KEY_REQUIRED) {</li><li>        <span class="hljs-comment">// 媒体密钥请求与处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> DRM_ERR_OK;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> Drm_ErrCode <span class="hljs-title">SessionKeyChangeCallBackWithObj</span><span class="hljs-params">(MediaKeySession *mediaKeySession, DRM_KeysInfo *keysInfo, <span class="hljs-type">bool</span> hasNewGoodKeys)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span> DRM_ERR_OK;</li><li>}</li><li>
</li><li>OH_MediaKeySession_Callback sessionCallback = { SessionEventCallBackWithObj, SessionKeyChangeCallBackWithObj };</li><li>ret = <span class="hljs-built_in">OH_MediaKeySession_SetCallback</span>(mediaKeySession, &amp;sessionCallback);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_SetCallback failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）查询是否需要安全解码。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> requireSecureDecoder;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySession_RequireSecureDecoderModule</span>(mediaKeySession, <span class="hljs-string">"video/avc"</span>, &amp;requireSecureDecoder);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_RequireSecureDecoderModule failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>生成媒体密钥请求与处理媒体密钥响应，以请求许可证完成DRM节目授权。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_DRM_MEDIA_KEY_RESPONSE_BUF_SIZE 24576 <span class="hljs-comment">// 24576: (2 * 12 * 1024)</span></span></li><li>DRM_MediaKeyRequest mediaKeyRequest;</li><li>DRM_MediaKeyRequestInfo info;</li><li><span class="hljs-comment">// initData对应码流中的pssh数据，请按实际数据填入。</span></li><li><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> initData[<span class="hljs-number">512</span>] = {<span class="hljs-number">0x00</span>};</li><li><span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(DRM_MediaKeyRequestInfo));</li><li>info.initDataLen = <span class="hljs-built_in">sizeof</span>(initData);</li><li>info.type = MEDIA_KEY_TYPE_ONLINE; <span class="hljs-comment">// MEDIA_KEY_TYPE_ONLINE: 在线媒体密钥请求类型; MEDIA_KEY_TYPE_OFFLINE: 离线媒体密钥请求类型。</span></li><li><span class="hljs-built_in">memcpy</span>(info.mimeType, (<span class="hljs-type">char</span> *)<span class="hljs-string">"video/mp4"</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-string">"video/mp4"</span>));</li><li><span class="hljs-built_in">memcpy</span>(info.initData, initData, <span class="hljs-built_in">sizeof</span>(initData));</li><li><span class="hljs-built_in">memcpy</span>(info.optionName[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *)<span class="hljs-string">"optionalDataName"</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-string">"optionalDataName"</span>));</li><li><span class="hljs-built_in">memcpy</span>(info.optionData[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *)<span class="hljs-string">"optionalDataValue"</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-string">"optionalDataValue"</span>));</li><li>info.optionsCount = <span class="hljs-number">1</span>;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySession_GenerateMediaKeyRequest</span>(mediaKeySession, &amp;info, &amp;mediaKeyRequest);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_GenerateMediaKeyRequest failed."</span>);</li><li>}</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment">  应用通过网络请求DRM服务，获取媒体密钥响应mediaKeyResponse，将响应传到OH_MediaKeySession_ProcessMediaKeyResponse，</span></li><li><span class="hljs-comment">  若是离线媒体密钥响应处理，则返回离线媒体密钥标识mediaKeyId，请根据实际的数据和长度传入。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> mediaKeyId[<span class="hljs-number">128</span>] = {<span class="hljs-number">0x00</span>};</li><li><span class="hljs-type">int32_t</span> mediaKeyIdLen = <span class="hljs-number">128</span>;</li><li><span class="hljs-comment">// 媒体密钥响应长度最大为MAX_DRM_MEDIA_KEY_RESPONSE_BUF_SIZE，请按实际数据输入。</span></li><li><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> mediaKeyResponse[MAX_DRM_MEDIA_KEY_RESPONSE_BUF_SIZE] = {<span class="hljs-number">0x00</span>};</li><li><span class="hljs-type">int32_t</span> mediaKeyResponseLen = MAX_DRM_MEDIA_KEY_RESPONSE_BUF_SIZE;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySession_ProcessMediaKeyResponse</span>(mediaKeySession, mediaKeyResponse,</li><li>    mediaKeyResponseLen, mediaKeyId, &amp;mediaKeyIdLen);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_ProcessMediaKeyResponse failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）恢复离线媒体密钥。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 将指定媒体密钥标识的媒体密钥加载到当前会话。</span></li><li>ret = <span class="hljs-built_in">OH_MediaKeySession_RestoreOfflineMediaKeys</span>(mediaKeySession, mediaKeyId, mediaKeyIdLen);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_RestoreOfflineMediaKeys failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）检查媒体密钥状态。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>DRM_MediaKeyStatus mediaKeyStatus;</li><li>ret = OH_MediaKeySession_CheckMediaKeyStatus(mediaKeySession, &amp;mediaKeyStatus);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_CheckMediaKeyStatus failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）获取离线媒体密钥标识列表、获取离线媒体密钥状态与清除离线媒体密钥。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>DRM_OfflineMediakeyIdArray offlineMediaKeyIds;</li><li>ret = OH_MediaKeySystem_GetOfflineMediaKeyIds(mediaKeySystem, &amp;offlineMediaKeyIds);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_GetOfflineMediaKeyIds failed."</span>);</li><li>}</li><li>DRM_OfflineMediaKeyStatus OfflineMediaKeyStatus = OFFLINE_MEDIA_KEY_STATUS_UNKNOWN;</li><li>ret = OH_MediaKeySystem_GetOfflineMediaKeyStatus(mediaKeySystem, offlineMediaKeyIds.ids[0], offlineMediaKeyIds.idsLen[0], &amp;OfflineMediaKeyStatus);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_GetOfflineMediaKeyStatus failed."</span>);</li><li>}</li><li>ret = OH_MediaKeySystem_ClearOfflineMediaKeys(mediaKeySystem, offlineMediaKeyIds.ids[0], offlineMediaKeyIds.idsLen[0]);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_ClearOfflineMediaKeys failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁MediaKeySession实例。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>ret = OH_MediaKeySession_Destroy(mediaKeySession);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySession_Destroy failed."</span>);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁MediaKeySystem实例。</p>       <div _ngcontent-srv-c106="" class="highlight-div"><div _ngcontent-srv-c106="" class="highlight-div-header"><div _ngcontent-srv-c106="" class="highlight-div-header-left"><div _ngcontent-srv-c106="" class="handle-button expand-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-srv-c106="" class="highlight-div-header-right"><div _ngcontent-srv-c106="" class="handle-button ai-button"></div><div _ngcontent-srv-c106="" class="handle-button line-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-srv-c106="" class="handle-button theme-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-srv-c106="" class="handle-button copy-button"><div _ngcontent-srv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-srv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>ret = OH_MediaKeySystem_Destroy(mediaKeySystem);</li><li><span class="hljs-keyword">if</span> (ret != DRM_ERR_OK) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"OH_MediaKeySystem_Destroy failed."</span>);</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>