<h1 _ngcontent-tyo-c119="" class="doc-title ng-star-inserted" title="数据分散/数据收集"> 数据分散/数据收集 </h1>

<div _ngcontent-tyo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7147194795310">Gather<i class="anchor-icon anchor-icon-link" anchorid="section7147194795310" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section23289mcpsimp" class="firsth2">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section23289mcpsimp" tips="复制节点链接"></i></h3><p>给定输入的张量和一个地址偏移张量，Gather指令根据偏移地址将输入张量按元素收集到结果张量中。</p> </div> <div class="tiledSection"><h3 id="section23292mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section23292mcpsimp" tips="复制节点链接"></i></h3><div class="p">tensor前n个数据计算：<div _ngcontent-tyo-c106="" class="highlight-div"><div _ngcontent-tyo-c106="" class="highlight-div-header"><div _ngcontent-tyo-c106="" class="highlight-div-header-left"><div _ngcontent-tyo-c106="" class="handle-button expand-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tyo-c106="" class="highlight-div-header-right"><div _ngcontent-tyo-c106="" class="handle-button ai-button"></div><div _ngcontent-tyo-c106="" class="handle-button line-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tyo-c106="" class="handle-button theme-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tyo-c106="" class="handle-button copy-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tyo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Gather</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; dstLocal, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; srcLocal, <span class="hljs-type">const</span> LocalTensor&lt;<span class="hljs-type">uint32_t</span>&gt;&amp; srcOffsetLocal, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> srcBaseAddr, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> count)</span></span></li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h3 id="section23306mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section23306mcpsimp" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.1" valign="top" width="15%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.2" valign="top" width="10%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.3" valign="top" width="75%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="15%"><p>dstLocal</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> <p>Kirin9020系列处理器，支持的数据类型为：</p> <p>前n个tensor：uint16_t、int16_t、uint32_t、int32_t、half、float32_t</p> <p>KirinX90系列处理器，支持的数据类型为：</p> <p>前n个tensor：uint16_t、int16_t、uint32_t、int32_t、half、float32_t</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>srcLocal</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> <p>数据类型和dstLocal保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>srcOffsetLocal</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>每个元素在src中对应的地址偏移。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> <p>该偏移量相对于src的起始基地址而言。单位为Bytes。地址偏移要大于等于0，取值应保证src元素类型位宽对齐，否则会导致非预期行为，同时需要保证偏移地址后不能超出UB大小数据的范围。</p> <p>每个元素在src中对应的地址偏移，地址偏移要大于等于0。该偏移量是相对于src的基地址而言，每个数值的单位为Bytes，数据类型根据srcLocal数据类型决定，支持情况如下。</p> <p>srcOffsetLocal支持数据类型：u32。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>srcBaseAddr</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>srcLocal的起始基地址，单位为Bytes。取值应保证src元素类型位宽对齐，否则会导致非预期行为。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>count</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>执行处理的数据个数，不得超过srcLocal和srcOffsetLocal的元素个数。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section23414mcpsimp">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section23414mcpsimp" tips="复制节点链接"></i></h3><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> <div class="tiledSection"><h3 id="section23420mcpsimp">约束说明<i class="anchor-icon anchor-icon-link" anchorid="section23420mcpsimp" tips="复制节点链接"></i></h3><p>操作数地址偏移对齐要求请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-general-constraints">通用约束</a>。</p> </div> <div class="tiledSection"><h3 id="section23426mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section23426mcpsimp" tips="复制节点链接"></i></h3><div _ngcontent-tyo-c106="" class="highlight-div"><div _ngcontent-tyo-c106="" class="highlight-div-header"><div _ngcontent-tyo-c106="" class="highlight-div-header-left"><div _ngcontent-tyo-c106="" class="handle-button expand-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tyo-c106="" class="highlight-div-header-right"><div _ngcontent-tyo-c106="" class="handle-button ai-button"></div><div _ngcontent-tyo-c106="" class="handle-button line-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tyo-c106="" class="handle-button theme-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tyo-c106="" class="handle-button copy-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tyo-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span></span></li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">GatherTest</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">GatherTest</span><span class="hljs-params">()</span> </span>{}</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* dstGm, __gm__ <span class="hljs-type">uint8_t</span>* srcGm,</span></span></li><li><span class="hljs-function">        __gm__ <span class="hljs-type">uint8_t</span>* srcOffsetGm, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> count)</span></li><li><span class="hljs-function">    </span>{</li><li>        m_elementCount = count;</li><li>        m_dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ T*)dstGm);</li><li>        m_srcGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ T*)srcGm);</li><li>        m_srcOffsetGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ <span class="hljs-type">uint32_t</span>*)srcOffsetGm);</li><li>        m_pipe.<span class="hljs-built_in">InitBuffer</span>(m_queIn, <span class="hljs-number">2</span>, m_elementCount * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));</li><li>        m_pipe.<span class="hljs-built_in">InitBuffer</span>(m_queOut, <span class="hljs-number">2</span>, m_elementCount * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));</li><li>    }</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-built_in">CopyIn</span>();</li><li>        <span class="hljs-built_in">Compute</span>();</li><li>        <span class="hljs-built_in">CopyOut</span>();</li><li>    }</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        AscendC::LocalTensor&lt;T&gt; srcLocal = m_queIn.<span class="hljs-built_in">AllocTensor</span>&lt;T&gt;();</li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(srcLocal, m_srcGlobal, m_elementCount);</li><li>        m_queIn.<span class="hljs-built_in">EnQue</span>(srcLocal);</li><li>        AscendC::LocalTensor&lt;<span class="hljs-type">uint32_t</span>&gt; srcOffsetLocal = m_queIn.<span class="hljs-built_in">AllocTensor</span>&lt;<span class="hljs-type">uint32_t</span>&gt;();</li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(srcOffsetLocal, m_srcOffsetGlobal, m_elementCount);</li><li>        m_queIn.<span class="hljs-built_in">EnQue</span>(srcOffsetLocal);</li><li>    }</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        AscendC::LocalTensor&lt;T&gt; srcLocal = m_queIn.<span class="hljs-built_in">DeQue</span>&lt;T&gt;();</li><li>        AscendC::LocalTensor&lt;<span class="hljs-type">uint32_t</span>&gt; srcOffsetLocal = m_queIn.<span class="hljs-built_in">DeQue</span>&lt;<span class="hljs-type">uint32_t</span>&gt;();</li><li>        AscendC::LocalTensor&lt;T&gt; dstLocal = m_queOut.<span class="hljs-built_in">AllocTensor</span>&lt;T&gt;();</li><li>        srcLocal.<span class="hljs-built_in">SetSize</span>(m_elementCount);</li><li>        AscendC::<span class="hljs-built_in">Gather</span>(dstLocal, srcLocal, srcOffsetLocal, (<span class="hljs-type">uint32_t</span>)<span class="hljs-number">0</span>, m_elementCount);</li><li>        m_queIn.<span class="hljs-built_in">FreeTensor</span>(srcLocal);</li><li>        m_queIn.<span class="hljs-built_in">FreeTensor</span>(srcOffsetLocal);</li><li>        m_queOut.<span class="hljs-built_in">EnQue</span>(dstLocal);</li><li>    }</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        AscendC::LocalTensor&lt;T&gt; dstLocal = m_queOut.<span class="hljs-built_in">DeQue</span>&lt;T&gt;();</li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(m_dstGlobal, dstLocal, m_elementCount);</li><li>        m_queOut.<span class="hljs-built_in">FreeTensor</span>(dstLocal);</li><li>    }</li><li><span class="hljs-keyword">private</span>:</li><li>    AscendC::TPipe m_pipe;</li><li>    AscendC::TQue&lt;AscendC::TPosition::VECIN, <span class="hljs-number">1</span>&gt; m_queCalc;</li><li>    AscendC::GlobalTensor&lt;T&gt; m_valueGlobal;</li><li>    <span class="hljs-type">uint32_t</span> m_concatRepeatTimes;</li><li>    <span class="hljs-type">uint32_t</span> m_sortRepeatTimes;</li><li>    <span class="hljs-type">uint32_t</span> m_extractRepeatTimes;</li><li>    <span class="hljs-type">uint32_t</span> m_elementCount;</li><li>    AscendC::GlobalTensor&lt;<span class="hljs-type">uint32_t</span>&gt; m_srcOffsetGlobal;</li><li>    AscendC::GlobalTensor&lt;T&gt; m_srcGlobal;</li><li>    AscendC::GlobalTensor&lt;T&gt; m_dstGlobal;</li><li>    AscendC::TQue&lt;AscendC::TPosition::VECIN, <span class="hljs-number">2</span>&gt; m_queIn;</li><li>    AscendC::TQue&lt;AscendC::TPosition::VECOUT, <span class="hljs-number">2</span>&gt; m_queOut;</li><li>}; <span class="hljs-comment">// class GatherTest</span></li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">kernel_gather</span><span class="hljs-params">(GM_ADDR dstGm, GM_ADDR srcGm, GM_ADDR srcOffsetGm)</span></span></li><li><span class="hljs-function"></span>{</li><li>    GatherTest&lt;half&gt; op; </li><li>    op.<span class="hljs-built_in">Init</span>(dstGm, srcGm, srcOffsetGm, <span class="hljs-number">128</span>);</li><li>    op.<span class="hljs-built_in">Process</span>();</li><li>}</li></ol></pre></div></div> <p>结果示例：</p> <div _ngcontent-tyo-c106="" class="highlight-div"><div _ngcontent-tyo-c106="" class="highlight-div-header"><div _ngcontent-tyo-c106="" class="highlight-div-header-left"><div _ngcontent-tyo-c106="" class="handle-button expand-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tyo-c106="" class="highlight-div-header-right"><div _ngcontent-tyo-c106="" class="handle-button ai-button"></div><div _ngcontent-tyo-c106="" class="handle-button line-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tyo-c106="" class="handle-button theme-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tyo-c106="" class="handle-button copy-button"><div _ngcontent-tyo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tyo-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>输入数据srcOffsetLocal: </li><li>[254 252 250 ... 4 2 0] </li><li>输入数据srcLocal（128个half类型数据）:  </li><li>[0 1 2 ... 125 126 127] </li><li>输出数据dstGlobal: </li><li>[127 126 125 ... 2 1 0]</li></ol></pre></div></div> </div> </div> <div></div></div>