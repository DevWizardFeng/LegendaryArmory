<h1 _ngcontent-qic-c119="" class="doc-title ng-star-inserted" title="数据对象状态变量的迁移指导"> 数据对象状态变量的迁移指导 </h1>

<div _ngcontent-qic-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文档主要介绍数据对象内的状态变量的迁移场景，包含以下场景。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.1.3.1.1" valign="top" width="50%">V1装饰器名</th> <th align="left" class="cellrowborder" id="mcps1.3.2.1.3.1.2" valign="top" width="50%">V2装饰器名</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@ObjectLink</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@Observed</a> /<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-track">@Track</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@ObservedV2</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace">@Trace</a></td> </tr>  </tbody></table></div> </div>  <div class="tiledSection"><h2 id="各装饰器迁移示例">各装饰器迁移示例<i class="anchor-icon anchor-icon-link" anchorid="各装饰器迁移示例" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="objectlinkobservedtrack---observedv2trace" class="firsth2">@ObjectLink/@Observed/@Track -&gt; @ObservedV2/@Trace<i class="anchor-icon anchor-icon-link" anchorid="objectlinkobservedtrack---observedv2trace" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>在V1中，@Observed与@ObjectLink装饰器用于观察类对象及其嵌套属性的变化，但V1只能观察对象的第一层属性。嵌套对象的属性需要通过自定义组件和@ObjectLink观察。此外，V1中提供了@Track装饰器实现对属性级别变化的精确控制。</p> <p>在V2中，结合使用@ObservedV2和@Trace，可以高效实现类对象及其嵌套属性的深度观察，省去对自定义组件的依赖，简化开发流程。同时，@Trace装饰器具备精确更新能力，替代V1中的@Track，实现更高效的UI刷新控制。根据不同场景，有以下迁移策略：</p> <ul><li>嵌套对象的属性观察：V1中需要通过自定义组件和@ObjectLink观察嵌套属性，V2中则可以使用@ObservedV2和@Trace直接观察嵌套对象，简化了代码结构。</li><li>类属性的精确更新：V1中的@Track可以用V2中的@Trace取代，@Trace可以同时观察和精确更新属性变化，使代码更简洁高效。</li></ul> <p><strong>示例</strong></p> <p><strong>嵌套对象属性观察方法</strong></p> <p>在V1中，无法直接观察嵌套对象的属性变化，只能观察到第一层属性的变化。必须通过创建自定义组件并使用@ObjectLink来实现对嵌套属性的观察。V2中使用@ObservedV2和@Trace，可以直接对嵌套对象的属性进行深度观察，减少复杂度。</p> <p>V1实现：</p> <div _ngcontent-qic-c106="" class="highlight-div"><div _ngcontent-qic-c106="" class="highlight-div-header"><div _ngcontent-qic-c106="" class="highlight-div-header-left"><div _ngcontent-qic-c106="" class="handle-button expand-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qic-c106="" class="highlight-div-header-right"><div _ngcontent-qic-c106="" class="handle-button ai-button"></div><div _ngcontent-qic-c106="" class="handle-button line-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qic-c106="" class="handle-button theme-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qic-c106="" class="handle-button copy-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qic-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {</li><li>  <span class="hljs-attr">city</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">city: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">city</span> = city;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">address</span>: <span class="hljs-title class_">Address</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, address: Address</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = address;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">AddressView</span> {</li><li>  <span class="hljs-comment">// 子组件中@ObjectLink装饰的address从父组件初始化，接收被@Observed装饰的Address实例</span></li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">address</span>: <span class="hljs-title class_">Address</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`City: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.address.city}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"city +a"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span>.<span class="hljs-property">city</span> += <span class="hljs-string">"a"</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UserProfile</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">"New York"</span>));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.name}</span>`</span>)</li><li>      <span class="hljs-comment">// 无法直接观察嵌套对象的属性变化，例如this.user.address.city</span></li><li>      <span class="hljs-comment">// 只能观察到对象第一层属性变化，所以需要将嵌套的对象Address抽取到自定义组件AddressView</span></li><li>      <span class="hljs-title class_">AddressView</span>({ <span class="hljs-attr">address</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">address</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@ObservedV2和@Trace。</p> <div _ngcontent-qic-c106="" class="highlight-div"><div _ngcontent-qic-c106="" class="highlight-div-header"><div _ngcontent-qic-c106="" class="highlight-div-header-left"><div _ngcontent-qic-c106="" class="handle-button expand-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qic-c106="" class="highlight-div-header-right"><div _ngcontent-qic-c106="" class="handle-button ai-button"></div><div _ngcontent-qic-c106="" class="handle-button line-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qic-c106="" class="handle-button theme-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qic-c106="" class="handle-button copy-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qic-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">city</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">city: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">city</span> = city;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">address</span>: <span class="hljs-title class_">Address</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, address: Address</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = address;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">UserProfile</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">"New York"</span>));</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.name}</span>`</span>)</li><li>      <span class="hljs-comment">// 通过@ObservedV2和@Trace可以直接观察嵌套属性</span></li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`City: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.address.city}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"city +a"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">address</span>.<span class="hljs-property">city</span> += <span class="hljs-string">"a"</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>类属性变化观测</strong></p> <p>在V1中，@Observed用于观察类实例及其属性的变化，@Track用于类对象的属性级的观察。在V2中，@Trace实现了观察和更新属性级别变化的能力，搭配@ObservedV2实现高效的UI更新。</p> <p>V1实现：</p> <div _ngcontent-qic-c106="" class="highlight-div"><div _ngcontent-qic-c106="" class="highlight-div-header"><div _ngcontent-qic-c106="" class="highlight-div-header-left"><div _ngcontent-qic-c106="" class="handle-button expand-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qic-c106="" class="highlight-div-header-right"><div _ngcontent-qic-c106="" class="handle-button ai-button"></div><div _ngcontent-qic-c106="" class="handle-button line-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qic-c106="" class="handle-button theme-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qic-c106="" class="handle-button copy-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qic-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-meta">@Track</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Track</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UserProfile</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">30</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.name}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Age: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.age}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"increase age"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@ObservedV2和@Trace。</p> <div _ngcontent-qic-c106="" class="highlight-div"><div _ngcontent-qic-c106="" class="highlight-div-header"><div _ngcontent-qic-c106="" class="highlight-div-header-left"><div _ngcontent-qic-c106="" class="handle-button expand-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qic-c106="" class="highlight-div-header-right"><div _ngcontent-qic-c106="" class="handle-button ai-button"></div><div _ngcontent-qic-c106="" class="handle-button line-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qic-c106="" class="handle-button theme-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qic-c106="" class="handle-button copy-button"><div _ngcontent-qic-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qic-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">UserProfile</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">30</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.name}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Age: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.user.age}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"Increase age"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>