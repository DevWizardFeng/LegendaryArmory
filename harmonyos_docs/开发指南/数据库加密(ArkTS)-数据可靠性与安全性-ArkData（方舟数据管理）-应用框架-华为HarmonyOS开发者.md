<h1 _ngcontent-yge-c119="" class="doc-title ng-star-inserted" title="数据库加密 (ArkTS)"> 数据库加密 (ArkTS) </h1>

<div _ngcontent-yge-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>为了增强数据库的安全性，数据库提供了一个安全适用的数据库加密能力，从而对数据库存储的内容实施有效保护。通过数据库加密等安全方法实现了数据库数据存储的保密性和完整性要求，使得数据库以密文方式存储并在密态方式下工作，确保了数据安全。</p>     <p>加密后的数据库只能通过接口进行访问，无法通过其它方式打开数据库文件。数据库的加密属性在创建数据库时确认，无法变更。</p>     <p>键值型数据库和关系型数据库均支持数据库加密操作，其中关系型数据库支持自定义加密/解密的密钥和其他参数。</p>    </div>    <div class="tiledSection">     <h2 id="键值型数据库加密">键值型数据库加密<i class="anchor-icon anchor-icon-link" anchorid="键值型数据库加密" tips="复制节点链接"></i></h2>          <p>键值型数据库，通过options中encrypt参数来设置是否加密，默认为false，表示不加密。encrypt参数为true时表示加密。</p>     <p>具体接口及功能，可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-distributedkvstore" target="_blank">分布式键值数据库</a>。</p>     <div _ngcontent-yge-c106="" class="highlight-div"><div _ngcontent-yge-c106="" class="highlight-div-header"><div _ngcontent-yge-c106="" class="highlight-div-header-left"><div _ngcontent-yge-c106="" class="handle-button expand-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yge-c106="" class="highlight-div-header-right"><div _ngcontent-yge-c106="" class="handle-button ai-button"></div><div _ngcontent-yge-c106="" class="handle-button line-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yge-c106="" class="handle-button theme-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yge-c106="" class="handle-button copy-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yge-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">ConfigurationConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { distributedKVStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-title function_">setColorMode</span>(<span class="hljs-title class_">ConfigurationConstant</span>.<span class="hljs-property">ColorMode</span>.<span class="hljs-property">COLOR_MODE_NOT_SET</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">kvManager</span>: distributedKVStore.<span class="hljs-property">KVManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">kvStore</span>: distributedKVStore.<span class="hljs-property">SingleKVStore</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">kvManagerConfig</span>: distributedKVStore.<span class="hljs-property">KVManagerConfig</span> = {</li><li>      <span class="hljs-attr">context</span>: context,</li><li>      <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.datamanagertest'</span>,</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      kvManager = distributedKVStore.<span class="hljs-title function_">createKVManager</span>(kvManagerConfig);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in creating KVManager.'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create KVManager. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (kvManager !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: distributedKVStore.<span class="hljs-property">Options</span> = {</li><li>          <span class="hljs-attr">createIfMissing</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-comment">// 设置数据库加密</span></li><li>          <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">true</span>,</li><li>          <span class="hljs-attr">backup</span>: <span class="hljs-literal">false</span>,</li><li>          <span class="hljs-attr">autoSync</span>: <span class="hljs-literal">false</span>,</li><li>          <span class="hljs-attr">kvStoreType</span>: distributedKVStore.<span class="hljs-property">KVStoreType</span>.<span class="hljs-property">SINGLE_VERSION</span>,</li><li>          <span class="hljs-attr">securityLevel</span>: distributedKVStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span></li><li>        };</li><li>        kvManager.<span class="hljs-property">getKVStore</span>&lt;distributedKVStore.<span class="hljs-property">SingleKVStore</span>&gt;(<span class="hljs-string">'storeId'</span>, options, <span class="hljs-function">(<span class="hljs-params">err, store: distributedKVStore.SingleKVStore</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (err) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Fail to get KVStore. Code:<span class="hljs-subst">${err.code}</span>,message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting KVStore.'</span>);</li><li>          kvStore = store;</li><li>          <span class="hljs-keyword">if</span> (kvStore !== <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-comment">//进行后续操作</span></li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>        });</li><li>      } <span class="hljs-keyword">catch</span> (e) {</li><li>        <span class="hljs-keyword">let</span> error = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`An unexpected error occurred. Code:<span class="hljs-subst">${error.code}</span>,message:<span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="关系型数据库加密">关系型数据库加密<i class="anchor-icon anchor-icon-link" anchorid="关系型数据库加密" tips="复制节点链接"></i></h2>          <p>关系型数据库，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-i#storeconfig" target="_blank">StoreConfig</a>中encrypt属性来设置是否加密。encrypt参数为true时表示加密；为false时表示不加密；默认值为false。</p>     <p>当encrypt为true时，支持开发者通过ArkTS API中的可选属性cryptoParam设置自定义的加密/解密密钥和算法等参数。</p>     <p>针对cryptoParam的配置与否，有如下两种场景：</p>     <p>场景1：不配置cryptoParam属性，此时会使用默认的加密配置进行数据库的加密/解密。</p>     <div _ngcontent-yge-c106="" class="highlight-div"><div _ngcontent-yge-c106="" class="highlight-div-header"><div _ngcontent-yge-c106="" class="highlight-div-header-left"><div _ngcontent-yge-c106="" class="handle-button expand-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yge-c106="" class="highlight-div-header-right"><div _ngcontent-yge-c106="" class="handle-button ai-button"></div><div _ngcontent-yge-c106="" class="handle-button line-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yge-c106="" class="handle-button theme-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yge-c106="" class="handle-button copy-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yge-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onCreate</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>        <span class="hljs-attr">name</span>: <span class="hljs-string">'RdbTest.db'</span>,</li><li>        <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>        <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">true</span></li><li>      };</li><li>      store = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">STORE_CONFIG</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting RdbStore.'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>场景2：配置cryptoParam属性，此时会使用开发者自定义的密钥和算法参数进行数据库的加密/解密。</p>     <div _ngcontent-yge-c106="" class="highlight-div"><div _ngcontent-yge-c106="" class="highlight-div-header"><div _ngcontent-yge-c106="" class="highlight-div-header-left"><div _ngcontent-yge-c106="" class="handle-button expand-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yge-c106="" class="highlight-div-header-right"><div _ngcontent-yge-c106="" class="handle-button ai-button"></div><div _ngcontent-yge-c106="" class="handle-button line-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yge-c106="" class="handle-button theme-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yge-c106="" class="handle-button copy-button"><div _ngcontent-yge-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yge-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onCreate</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;</li><li>    <span class="hljs-comment">// 初始化需要使用的密钥</span></li><li>    <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">32</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {</li><li>      key[i] = i;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 初始化加密算法</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">CRYPTO_PARAM</span>: relationalStore.<span class="hljs-property">CryptoParam</span> = {</li><li>      <span class="hljs-attr">encryptionKey</span>: key, <span class="hljs-comment">// 必选参数，使用指定的密钥打开加密数据库。为空则由数据库负责生成并保存密钥，并使用生成的密钥打开数据库文件。</span></li><li>      <span class="hljs-attr">iterationCount</span>: <span class="hljs-number">25000</span>, <span class="hljs-comment">// 可选参数，迭代次数。迭代次数必须大于零。不指定或等于零则使用默认值10000和默认加密算法。</span></li><li>      <span class="hljs-attr">encryptionAlgo</span>: relationalStore.<span class="hljs-property">EncryptionAlgo</span>.<span class="hljs-property">AES_256_CBC</span>, <span class="hljs-comment">// 可选参数，加密/解密算法。如不指定，默认算法为AES_256_GCM。</span></li><li>      <span class="hljs-attr">hmacAlgo</span>: relationalStore.<span class="hljs-property">HmacAlgo</span>.<span class="hljs-property">SHA256</span>, <span class="hljs-comment">// 可选参数，HMAC算法。如不指定，默认值为SHA256。</span></li><li>      <span class="hljs-attr">kdfAlgo</span>: relationalStore.<span class="hljs-property">KdfAlgo</span>.<span class="hljs-property">KDF_SHA512</span>, <span class="hljs-comment">// 可选参数，KDF算法。如不指定，默认值和HMAC算法相等。</span></li><li>      <span class="hljs-attr">cryptoPageSize</span>: <span class="hljs-number">2048</span> <span class="hljs-comment">// 可选参数，加密/解密时使用的页大小。必须为1024到65536范围内的整数并且为2的幂。如不指定，默认值为1024。</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">"encrypted.db"</span>,</li><li>      <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-attr">cryptoParam</span>: <span class="hljs-variable constant_">CRYPTO_PARAM</span></li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      store = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">STORE_CONFIG</span>);</li><li>      <span class="hljs-keyword">if</span> (store == <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to get RdbStore.'</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting RdbStore.'</span>);</li><li>      }</li><li>      <span class="hljs-comment">// 调用完后需要将密钥清零</span></li><li>      <span class="hljs-variable constant_">CRYPTO_PARAM</span>.<span class="hljs-property">encryptionKey</span>.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>如果开发者不关心加密使用的算法及参数，则无需配置cryptoParam属性，使用默认加密配置即可。当开发者需要自定义加密配置，或需要打开非默认配置的加密数据库时，则需要配置cryptoParam属性。</p>    </div>   </div>   <div></div></div>