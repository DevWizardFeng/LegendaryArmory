<h1 _ngcontent-xqd-c119="" class="doc-title ng-star-inserted" title="数据库加密 (C/C++)"> 数据库加密 (C/C++) </h1>

<div _ngcontent-xqd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>为了增强数据库的安全性，数据库提供了安全的加密功能，以有效保护存储的内容。</p> <p>通过数据库加密，实现了数据库数据存储的保密性和完整性要求，使得数据库以密文方式存储并在密态方式下工作，确保了数据安全。</p> <p>加密后的数据库只能通过接口进行访问，无法通过其它方式打开数据库文件。数据库的加密属性在创建数据库时确认，无法变更。</p> <p>当前仅支持使用关系型数据库（C/C++）进行数据库加密。</p> </div>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p>关系型数据库通过调用OH_Rdb_SetEncrypted方法来设置是否加密。isEncrypted参数为true时表示加密，为false时表示不加密，默认不加密。</p> <p>当isEncrypted为true时，可调用OH_Rdb_SetCryptoParam方法设置自定义的加密/解密密钥和算法等参数。</p> <ol><li><p>CMakeLists.txt中添加以下lib。</p>  <div _ngcontent-xqd-c106="" class="highlight-div"><div _ngcontent-xqd-c106="" class="highlight-div-header"><div _ngcontent-xqd-c106="" class="highlight-div-header-left"><div _ngcontent-xqd-c106="" class="handle-button expand-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqd-c106="" class="highlight-div-header-right"><div _ngcontent-xqd-c106="" class="handle-button ai-button"></div><div _ngcontent-xqd-c106="" class="handle-button line-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqd-c106="" class="handle-button theme-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqd-c106="" class="handle-button copy-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqd-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>libnative_rdb_ndk.z.so</li></ol></pre></div></div>  </li><li><p>导入头文件。</p>  <div _ngcontent-xqd-c106="" class="highlight-div"><div _ngcontent-xqd-c106="" class="highlight-div-header"><div _ngcontent-xqd-c106="" class="highlight-div-header-left"><div _ngcontent-xqd-c106="" class="handle-button expand-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqd-c106="" class="highlight-div-header-right"><div _ngcontent-xqd-c106="" class="handle-button ai-button"></div><div _ngcontent-xqd-c106="" class="handle-button line-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqd-c106="" class="handle-button theme-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqd-c106="" class="handle-button copy-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"database/rdb/relational_store.h"</span></span></li></ol></pre></div></div>  </li><li><p>针对是否配置自定义加密/解密参数，有如下两种场景：</p>  <ul><li><p>场景1：不配置自定义加密/解密参数，此时会使用默认的配置进行数据库的加密/解密。</p>  <div _ngcontent-xqd-c106="" class="highlight-div"><div _ngcontent-xqd-c106="" class="highlight-div-header"><div _ngcontent-xqd-c106="" class="highlight-div-header-left"><div _ngcontent-xqd-c106="" class="handle-button expand-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqd-c106="" class="highlight-div-header-right"><div _ngcontent-xqd-c106="" class="handle-button ai-button"></div><div _ngcontent-xqd-c106="" class="handle-button line-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqd-c106="" class="handle-button theme-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqd-c106="" class="handle-button copy-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>OH_Rdb_ConfigV2* config = OH_Rdb_CreateConfig();</li><li>OH_Rdb_SetDatabaseDir(config, <span class="hljs-string">"/data/storage/el2/database"</span>);</li><li>OH_Rdb_SetArea(config, RDB_SECURITY_AREA_EL2);</li><li>OH_Rdb_SetBundleName(config, <span class="hljs-string">"com.example.nativedemo"</span>);</li><li>OH_Rdb_SetStoreName(config, <span class="hljs-string">"RdbTest.db"</span>);</li><li>OH_Rdb_SetSecurityLevel(config, OH_Rdb_SecurityLevel::S3);</li><li><span class="hljs-comment">// 设置为使用加密方式创建或打开数据库</span></li><li>OH_Rdb_SetEncrypted(config, <span class="hljs-literal">true</span>);</li><li>
</li><li><span class="hljs-type">int</span> errCode = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// 获取OH_Rdb_Store实例</span></li><li>OH_Rdb_Store *store = OH_Rdb_CreateOrOpen(config, &amp;errCode);</li></ol></pre></div></div>  </li><li><p>场景2：使用OH_Rdb_SetCryptoParam接口配置加密参数，此时会使用开发者自定义的密钥和算法参数进行数据库的加密/解密。</p>  <p>如果开发者不关心加密算法及参数，使用默认加密配置即可，无需创建和配置自定义加密参数。</p>  <div _ngcontent-xqd-c106="" class="highlight-div"><div _ngcontent-xqd-c106="" class="highlight-div-header"><div _ngcontent-xqd-c106="" class="highlight-div-header-left"><div _ngcontent-xqd-c106="" class="handle-button expand-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqd-c106="" class="highlight-div-header-right"><div _ngcontent-xqd-c106="" class="handle-button ai-button"></div><div _ngcontent-xqd-c106="" class="handle-button line-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqd-c106="" class="handle-button theme-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqd-c106="" class="handle-button copy-button"><div _ngcontent-xqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqd-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>OH_Rdb_ConfigV2* config = OH_Rdb_CreateConfig();</li><li>OH_Rdb_SetDatabaseDir(config, <span class="hljs-string">"/data/storage/el2/database"</span>);</li><li>OH_Rdb_SetArea(config, RDB_SECURITY_AREA_EL2);</li><li>OH_Rdb_SetStoreName(config, <span class="hljs-string">"RdbTestConfigEncryptParam.db"</span>);</li><li>OH_Rdb_SetSecurityLevel(config, OH_Rdb_SecurityLevel::S3);</li><li>OH_Rdb_SetBundleName(config, <span class="hljs-string">"com.example.nativedemo"</span>);</li><li><span class="hljs-comment">// 设置为使用加密方式创建或打开数据库</span></li><li>OH_Rdb_SetEncrypted(config, <span class="hljs-literal">true</span>);</li><li><span class="hljs-comment">// 创建自定义加密参数对象</span></li><li>OH_Rdb_CryptoParam *cryptoParam = OH_Rdb_CreateCryptoParam();</li><li>
</li><li><span class="hljs-type">uint8_t</span> key[<span class="hljs-number">6</span>] = { <span class="hljs-number">0x31</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x36</span> };</li><li><span class="hljs-comment">// 使用指定的密钥打开加密数据库。不指定则由数据库负责生成并保存密钥，并使用生成的密钥。</span></li><li>OH_Crypto_SetEncryptionKey(cryptoParam, key, <span class="hljs-number">6</span>);</li><li><span class="hljs-comment">// 设置KDF算法迭代次数。迭代次数必须大于零。不指定或等于零则使用默认值10000和默认加密算法。</span></li><li>OH_Crypto_SetIteration(cryptoParam, <span class="hljs-number">64000</span>);</li><li><span class="hljs-comment">// 设置加密算法，如不设置默认为AES_256_GCM</span></li><li>OH_Crypto_SetEncryptionAlgo(cryptoParam, Rdb_EncryptionAlgo::RDB_AES_256_CBC);</li><li><span class="hljs-comment">// 设置HMAC算法，如不设置默认为SHA256</span></li><li>OH_Crypto_SetHmacAlgo(cryptoParam, RDB_HMAC_SHA512);</li><li><span class="hljs-comment">// 设置KDF算法，如不设置默认为SHA256</span></li><li>OH_Crypto_SetKdfAlgo(cryptoParam, RDB_KDF_SHA512);</li><li><span class="hljs-comment">// 设置打开加密数据库时使用的页大小，须为1024到65536之间的整数且为2的幂，如不设置默认为1024</span></li><li>OH_Crypto_SetCryptoPageSize(cryptoParam, <span class="hljs-number">4096</span>);</li><li><span class="hljs-comment">// 设置自定义加密参数</span></li><li>OH_Rdb_SetCryptoParam(config, cryptoParam);</li><li>   </li><li><span class="hljs-type">int</span> errCode = <span class="hljs-number">0</span>;</li><li>OH_Rdb_Store *store = OH_Rdb_CreateOrOpen(config, &amp;errCode);</li><li><span class="hljs-comment">// 销毁自定义加密参数对象</span></li><li>OH_Rdb_DestroyCryptoParam(cryptoParam);</li><li>OH_Rdb_CloseStore(store);</li></ol></pre></div></div>  </li></ul>  </li></ol> </div> </div> <div></div></div>