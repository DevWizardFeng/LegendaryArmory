<h1 _ngcontent-kva-c119="" class="doc-title ng-star-inserted" title="数据排布格式"> 数据排布格式 </h1>

<div _ngcontent-kva-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>Format为数据的物理排布格式，定义了解读数据的维度，比如1D，2D，3D，4D，5D等。</p> <div class="tiledSection"><h2 id="section5914mcpsimp">NCHW和NHWC<i class="anchor-icon anchor-icon-link" anchorid="section5914mcpsimp" tips="复制节点链接"></i></h2><p>在深度学习领域，多维数据通过多维数组存储，比如卷积神经网络的特征图(Feature Map)通常用四维数组保存，即4D，4D格式解释如下。</p> <ul><li>N：Batch数量，例如图像的数目。</li><li>H：Height，特征图高度，即垂直高度方向的像素个数。</li><li>W：Width，特征图宽度，即水平宽度方向的像素个数。</li><li>C：Channels，特征图通道，例如彩色RGB图像的Channels为3。</li></ul> <p>由于数据只能线性存储，因此这四个维度有对应的顺序。不同深度学习框架会按照不同的顺序存储特征图数据，比如Caffe，排列顺序为[Batch, Channels, Height, Width]，即NCHW。TensorFlow中，排列顺序为[Batch, Height, Width, Channels]，即NHWC。</p> <p>如下图所示，以一张格式为RGB的图片为例，NCHW中，C排列在外层，实际存储的是“RRRRRRGGGGGGBBBBBB”，即同一通道的所有像素值顺序存储在一起；而NHWC中C排列在最内层，实际存储的则是“RGBRGBRGBRGBRGBRGB”，即多个通道的同一位置的像素值顺序存储在一起。</p> <p><span><img height="66.5" originheight="65" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114305.11281739891028748607682838920975:50001231000000:2800:393E2A23F1F84F2FB36F0817679151055C0ED142812701F00E742D73A6987545.png" title="点击放大" width="353.78000000000003"></span></p> <p>尽管存储的数据相同，但不同的存储顺序会导致数据的访问特性不一致，因此即便进行同样的运算，相应的计算性能也会不同。</p> </div> <div class="tiledSection"><h2 id="section5927mcpsimp">NC1HWC0<i class="anchor-icon anchor-icon-link" anchorid="section5927mcpsimp" tips="复制节点链接"></i></h2><p>Kirin AI处理器中，为了提高通用矩阵乘法(GEMM)运算数据块的访问效率，所有张量数据统一采用NC1HWC0的五维数据格式。其中C0与微架构强相关，等于AI Core中矩阵计算单元的大小。</p> <p>C1=(C+C0-1)/C0。如果结果不整除，向上取整。</p> <p>NHWC/NCHW -&gt; NC1HWC0的转换过程为：将数据在C维度进行分割，变成C1份NHWC0/NC0HW，再将C1份NHWC0/NC0HW在内存中连续排列成NC1HWC0，其格式转换示意图如下图所示。</p> <p class="msonormal"><span><img height="335.16" originheight="429" originwidth="678" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114305.41848173482797004215592093912155:50001231000000:2800:21AEC193499C784F8920DF9C1BAF77A3C7504A8C8CC81FBC6F2C17AC80E5B0EB.png" title="点击放大" width="526.6800000000001"></span></p> <ul><li>NHWC -&gt; NC1HWC0的转换公式如下。<div _ngcontent-kva-c106="" class="highlight-div"><div _ngcontent-kva-c106="" class="highlight-div-header"><div _ngcontent-kva-c106="" class="highlight-div-header-left"><div _ngcontent-kva-c106="" class="handle-button expand-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kva-c106="" class="highlight-div-header-right"><div _ngcontent-kva-c106="" class="handle-button ai-button"></div><div _ngcontent-kva-c106="" class="handle-button line-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kva-c106="" class="handle-button theme-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kva-c106="" class="handle-button copy-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kva-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Tensor.<span class="hljs-built_in">reshape</span>([N, H, W, C1, C0]).<span class="hljs-built_in">transpose</span>([<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>])</li></ol></pre></div></div> </li><li>NCHW -&gt; NC1HWC0的转换公式如下。<div _ngcontent-kva-c106="" class="highlight-div"><div _ngcontent-kva-c106="" class="highlight-div-header"><div _ngcontent-kva-c106="" class="highlight-div-header-left"><div _ngcontent-kva-c106="" class="handle-button expand-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kva-c106="" class="highlight-div-header-right"><div _ngcontent-kva-c106="" class="handle-button ai-button"></div><div _ngcontent-kva-c106="" class="handle-button line-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kva-c106="" class="handle-button theme-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kva-c106="" class="handle-button copy-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kva-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Tensor.<span class="hljs-built_in">reshape</span>([N, C1, C0, H, W]).<span class="hljs-built_in">transpose</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>])</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section5938mcpsimp">FRACTAL_NZ<i class="anchor-icon anchor-icon-link" anchorid="section5938mcpsimp" tips="复制节点链接"></i></h2><p>FRACTAL_NZ是分形格式，如Feature Map的数据存储，在cube单元计算时，输出矩阵的数据格式为NW1H1H0W0。整个矩阵被分为（H1*W1）个分形，按照column major排布，形状如N字形；每个分形内部有（H0*W0）个元素，按照row major排布，形状如z字形。考虑到数据排布格式，将NW1H1H0W0数据格式称为Nz（大N小z）格式。其中，H0,W0表示一个分形的大小，示意图如下所示：</p> <p class="msonormal"><span><img height="383.04" originheight="380" originwidth="325" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114305.73435408127430847503995851576406:50001231000000:2800:B2A0F27B71A869125824FFFA2B8D865A9ABCEA95F29B4148F5E99C49557B4FB3.png" title="点击放大" width="324.52000000000004"></span></p> <p>ND –&gt; FRACTAL_NZ的变换过程为：</p> <div _ngcontent-kva-c106="" class="highlight-div"><div _ngcontent-kva-c106="" class="highlight-div-header"><div _ngcontent-kva-c106="" class="highlight-div-header-left"><div _ngcontent-kva-c106="" class="handle-button expand-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kva-c106="" class="highlight-div-header-right"><div _ngcontent-kva-c106="" class="handle-button ai-button"></div><div _ngcontent-kva-c106="" class="handle-button line-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kva-c106="" class="handle-button theme-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kva-c106="" class="handle-button copy-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kva-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>(..., N，H, W )-&gt;pad-&gt;(..., N, H1*H0, W1*W0)-&gt;reshape-&gt;(..., N, H1, H0, W1, W0)-&gt;transpose-&gt;(..., N, W1, H1, H0, W0)</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section5944mcpsimp">FRACTAL_Z<i class="anchor-icon anchor-icon-link" anchorid="section5944mcpsimp" tips="复制节点链接"></i></h2><p>FRACTAL_Z是用于定义卷积权重的数据格式，由FT Matrix（FT：Filter，卷积核）变换得到。FRACTAL_Z是送往Cube的最终数据格式，采用“C1HW,N1,N0,C0”的4维数据排布。</p> <p>数据有两层Tiling，如下图所示：</p> <p class="msonormal"><span><img height="335.16" originheight="517" originwidth="766" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114305.05978319750457076333077127971054:50001231000000:2800:51F3D34432039D09E9733598EFA0211DF915E48AB30830F87B842AB4DF41A1E4.png" title="点击放大" width="498.75"></span></p> <p>第一层与Cube的Size相关，数据按照列的方向连续（小n）；第二层与矩阵的Size相关，数据按照行的方向连续（大Z）。</p> <p>例如：HWCN = (2, 2, 32, 32)，将其变成FRACTAL_Z( C1HW, N1, N0, C0 ) = (8, 2, 16, 16)。</p> <p>HWCN变换FRACTAL_Z的过程为：</p> <div _ngcontent-kva-c106="" class="highlight-div"><div _ngcontent-kva-c106="" class="highlight-div-header"><div _ngcontent-kva-c106="" class="highlight-div-header-left"><div _ngcontent-kva-c106="" class="handle-button expand-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kva-c106="" class="highlight-div-header-right"><div _ngcontent-kva-c106="" class="handle-button ai-button"></div><div _ngcontent-kva-c106="" class="handle-button line-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kva-c106="" class="handle-button theme-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kva-c106="" class="handle-button copy-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kva-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Tensor.<span class="hljs-built_in">padding</span>([ [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], [<span class="hljs-number">0</span>,(C0–C%C0)%C0], [<span class="hljs-number">0</span>,(N0–N%N0)%N0] ]).<span class="hljs-built_in">reshape</span>( [H, W, C1, C0, N1, N0]).<span class="hljs-built_in">transpose</span>( [<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>] ).<span class="hljs-built_in">reshape</span>( [C1*H*W, N1, N0, C0])</li></ol></pre></div></div> <p>NCHW变换FRACTAL_Z的过程为：</p> <div _ngcontent-kva-c106="" class="highlight-div"><div _ngcontent-kva-c106="" class="highlight-div-header"><div _ngcontent-kva-c106="" class="highlight-div-header-left"><div _ngcontent-kva-c106="" class="handle-button expand-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kva-c106="" class="highlight-div-header-right"><div _ngcontent-kva-c106="" class="handle-button ai-button"></div><div _ngcontent-kva-c106="" class="handle-button line-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kva-c106="" class="handle-button theme-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kva-c106="" class="handle-button copy-button"><div _ngcontent-kva-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kva-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>Tensor.<span class="hljs-built_in">padding</span>([ [<span class="hljs-number">0</span>,(N0–N%N0)%N0], [<span class="hljs-number">0</span>,(C0–C%C0)%C0], [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>] ]).<span class="hljs-built_in">reshape</span>( [N1, N0, C1, C0, H, W]).<span class="hljs-built_in">transpose</span>( [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>] ).<span class="hljs-built_in">reshape</span>( [C1*H*W, N1, N0, C0])</li></ol></pre></div></div> </div> </div> <div></div></div>