<h1 _ngcontent-osx-c119="" class="doc-title ng-star-inserted" title="数据生成脚本适配样例"> 数据生成脚本适配样例 </h1>

<div _ngcontent-osx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div _ngcontent-osx-c106="" class="highlight-div"><div _ngcontent-osx-c106="" class="highlight-div-header"><div _ngcontent-osx-c106="" class="highlight-div-header-left"><div _ngcontent-osx-c106="" class="handle-button expand-button"><div _ngcontent-osx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osx-c106="" class="highlight-div-header-right"><div _ngcontent-osx-c106="" class="handle-button ai-button"></div><div _ngcontent-osx-c106="" class="handle-button line-button"><div _ngcontent-osx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osx-c106="" class="handle-button theme-button"><div _ngcontent-osx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osx-c106="" class="handle-button copy-button"><div _ngcontent-osx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osx-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> sys </li><li><span class="hljs-keyword">import</span> os </li><li><span class="hljs-keyword">import</span> json </li><li><span class="hljs-keyword">import</span> logging </li><li><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce </li><li><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass </li><li><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np </li><li><span class="hljs-keyword">from</span> numpy <span class="hljs-keyword">import</span> array </li><li>DTYPE = { </li><li>    <span class="hljs-string">"float16"</span>: np.float16 </li><li>} </li><li>atol, rtol = <span class="hljs-number">0.005</span>, <span class="hljs-number">0.005</span> </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">byte_2_bit</span>(<span class="hljs-params">drop_mask, size</span>): </li><li>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(drop_mask)) </li><li>    drop_mask_bit = np.zeros((<span class="hljs-built_in">int</span>(size / <span class="hljs-number">8</span>),), dtype=np.uint8) </li><li>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">int</span>(size / <span class="hljs-number">8</span>)): </li><li>        tmp = <span class="hljs-number">0</span> </li><li>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>): </li><li>            tmp += drop_mask[i * <span class="hljs-number">8</span> + j] * (<span class="hljs-number">2</span> ** j) </li><li>        drop_mask_bit[i] = tmp </li><li>    <span class="hljs-keyword">return</span> drop_mask_bit </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_input_attrs_content</span>(<span class="hljs-params">input_json: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>: </li><li>    content = {} </li><li>    input_json = os.path.realpath(input_json) </li><li>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(input_json, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">as</span> in_hadle: </li><li>        <span class="hljs-keyword">try</span>: </li><li>            content = json.load(in_hadle) </li><li>        <span class="hljs-keyword">except</span> json.decoder.JSONDecodeError: </li><li>            logging.error(<span class="hljs-string">"json.decoder.JSONDecodeError"</span>) </li><li>        <span class="hljs-keyword">finally</span>: </li><li>            <span class="hljs-keyword">pass</span> </li><li>    <span class="hljs-keyword">return</span> content </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">softmax</span>(<span class="hljs-params">x, axis=<span class="hljs-literal">None</span></span>): </li><li>    x = x.astype(np.float32) </li><li>    x_max = x.<span class="hljs-built_in">max</span>(axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>) </li><li>    x_sub = x - x_max </li><li>    y = np.exp(x_sub) </li><li>    x_sum = y.<span class="hljs-built_in">sum</span>(axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>) </li><li>    ans = y / x_sum </li><li>    ans = ans.astype(np.float16) </li><li>    x_max = x_max.astype(np.float16) </li><li>    x_sum = x_sum.astype(np.float16) </li><li>    <span class="hljs-keyword">return</span> ans, x_max, x_sum </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">attention_score</span>(<span class="hljs-params">shape_info_tuple, </span></li><li><span class="hljs-params">                    input_path, </span></li><li><span class="hljs-params">                    output_path, </span></li><li><span class="hljs-params">                    need_new</span>): </li><li>    qkv_shape, drop_mask_shape, keep_prob, input_dtype, output_dtype = shape_info_tuple </li><li>    <span class="hljs-keyword">if</span> need_new: </li><li>        q = np.random.uniform(-<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, qkv_shape).astype(input_dtype) </li><li>        q_trans = q.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) </li><li>        q_trans.tofile(input_path[<span class="hljs-string">"query"</span>]) </li><li>        k = np.random.uniform(-<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, qkv_shape).astype(input_dtype) </li><li>        k_trans = k.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) </li><li>        k_trans.tofile(input_path[<span class="hljs-string">"key"</span>]) </li><li>        v = np.random.uniform(-<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, qkv_shape).astype(input_dtype) </li><li>        v_trans = v.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) </li><li>        v_trans.tofile(input_path[<span class="hljs-string">"value"</span>]) </li><li>        <span class="hljs-keyword">if</span> drop_mask_shape <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>: </li><li>            drop_mask = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, drop_mask_shape).astype(np.uint8) </li><li>            size = reduce(<span class="hljs-keyword">lambda</span> x, y: x * y, drop_mask_shape) </li><li>            drop_mask_bit = byte_2_bit( </li><li>                drop_mask, <span class="hljs-built_in">int</span>(size)).reshape(qkv_shape[<span class="hljs-number">0</span>], qkv_shape[<span class="hljs-number">1</span>], qkv_shape[<span class="hljs-number">2</span>], <span class="hljs-built_in">int</span>(qkv_shape[<span class="hljs-number">2</span>] / <span class="hljs-number">8</span>)) </li><li>            drop_mask_bit.tofile(input_path[<span class="hljs-string">"drop_mask"</span>]) </li><li>    <span class="hljs-keyword">else</span>: </li><li>        q = np.fromfile(input_path[<span class="hljs-string">"query"</span>], input_dtype).reshape(qkv_shape).astype(input_dtype) </li><li>        k = np.fromfile(input_path[<span class="hljs-string">"key"</span>], input_dtype).reshape(qkv_shape).astype(input_dtype) </li><li>        v = np.fromfile(input_path[<span class="hljs-string">"value"</span>], input_dtype).reshape(qkv_shape).astype(input_dtype) </li><li>        drop_mask = np.fromfile( </li><li>            input_path[<span class="hljs-string">"drop_mask"</span>], </li><li>            dtype=np.uint8).reshape(qkv_shape[<span class="hljs-number">0</span>], qkv_shape[<span class="hljs-number">1</span>], qkv_shape[<span class="hljs-number">2</span>], <span class="hljs-built_in">int</span>(qkv_shape[<span class="hljs-number">2</span>] / <span class="hljs-number">8</span>)) </li><li>    qk = np.matmul(q, k.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)) </li><li>    softmax_res, x_max, x_sum = softmax(qk) </li><li>    drop_res = <span class="hljs-number">1</span> / keep_prob * np.multiply( </li><li>        softmax_res, drop_mask.reshape(qkv_shape[<span class="hljs-number">0</span>], qkv_shape[<span class="hljs-number">1</span>], qkv_shape[<span class="hljs-number">2</span>], qkv_shape[<span class="hljs-number">2</span>])) </li><li>    y = np.matmul(drop_res, v) </li><li>    y = y.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) </li><li>    y.astype(output_dtype).tofile(output_path[<span class="hljs-string">"attention_out"</span>]) </li><li>    <span class="hljs-keyword">return</span> </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_total_golden_output</span>(<span class="hljs-params">shape_info, input_path, golden_path, need_new</span>): </li><li>    b_value, head_num, s_value, h_value = shape_info.shape_info </li><li>    qkv_shape = [b_value, head_num, s_value, h_value // head_num] </li><li>    drop_shape = [b_value * head_num * s_value * s_value] </li><li>    attention_score((qkv_shape, </li><li>                     drop_shape, </li><li>                     shape_info.keep_prob, </li><li>                     shape_info.input_dtype, </li><li>                     shape_info.output_dtype), </li><li>                    input_path, </li><li>                    golden_path, </li><li>                    need_new) </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data_file</span>(<span class="hljs-params">res_path, contents</span>): </li><li>    data_files = {} </li><li>    <span class="hljs-keyword">for</span> content <span class="hljs-keyword">in</span> contents: </li><li>        <span class="hljs-keyword">if</span> content[<span class="hljs-string">"data_file"</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>: </li><li>            <span class="hljs-keyword">continue</span> </li><li>        data_files[content[<span class="hljs-string">"name"</span>]] = os.path.join(res_path, content[<span class="hljs-string">"data_file"</span>]) </li><li>    <span class="hljs-keyword">return</span> data_files </li><li><span class="hljs-meta">@dataclass </span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">InputOutputShapeInfo</span>: </li><li>    shape_info: <span class="hljs-built_in">tuple</span> </li><li>    keep_prob: <span class="hljs-built_in">int</span> </li><li>    input_dtype: np.dtype </li><li>    output_dtype: np.dtype </li><li><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_args</span>(): </li><li>    <span class="hljs-string">""" </span></li><li><span class="hljs-string">    需要开发者按需配置 </span></li><li><span class="hljs-string">    sys.argv[1]: input json file path </span></li><li><span class="hljs-string">    sys.argv[2]: output file path </span></li><li><span class="hljs-string">    sys.argv[3]: gen data type: input/output/all </span></li><li><span class="hljs-string">    """</span> </li><li>    logging.info(<span class="hljs-string">f"数据保存路径为: <span class="hljs-subst">{sys.argv[<span class="hljs-number">2</span>]}</span>"</span>) </li><li>    input_file = sys.argv[<span class="hljs-number">1</span>] </li><li>    res_path = sys.argv[<span class="hljs-number">2</span>] </li><li>    content = get_input_attrs_content(input_file) </li><li>    input_files = get_data_file(res_path, content.get(<span class="hljs-string">"inputs"</span>)) </li><li>    output_files = get_data_file(res_path, content.get(<span class="hljs-string">"outputs"</span>)) </li><li>    attrs = content.get(<span class="hljs-string">"attrs"</span>) </li><li>    cmp_idx = <span class="hljs-number">0</span> </li><li>    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> attrs: </li><li>        <span class="hljs-keyword">if</span> attr[<span class="hljs-string">"name"</span>] == <span class="hljs-string">"input_layout"</span>: </li><li>            input_layout = attr[<span class="hljs-string">"value"</span>] </li><li>            logging.info(<span class="hljs-string">f"get input_layout:<span class="hljs-subst">{input_layout}</span>"</span>) </li><li>        <span class="hljs-keyword">if</span> attr[<span class="hljs-string">"name"</span>] == <span class="hljs-string">"keep_prob"</span>: </li><li>            keep_prob = attr[<span class="hljs-string">"value"</span>] </li><li>            logging.info(<span class="hljs-string">f"get keep_prob:<span class="hljs-subst">{keep_prob}</span>"</span>) </li><li>        <span class="hljs-keyword">if</span> attr[<span class="hljs-string">"name"</span>] == <span class="hljs-string">"head_num"</span>: </li><li>            head_num = attr[<span class="hljs-string">"value"</span>] </li><li>            logging.info(<span class="hljs-string">f"get head_num:<span class="hljs-subst">{head_num}</span>"</span>) </li><li>    shape = content.get(<span class="hljs-string">"inputs"</span>)[cmp_idx].get(<span class="hljs-string">"shape"</span>) </li><li>    b_value = shape[input_layout.find(<span class="hljs-string">"B"</span>)] </li><li>    s_value = shape[input_layout.find(<span class="hljs-string">"S"</span>)] </li><li>    h_value = shape[input_layout.find(<span class="hljs-string">"H"</span>)] </li><li>    input_dtype = DTYPE.get(content.get(<span class="hljs-string">"inputs"</span>)[cmp_idx].get(<span class="hljs-string">"dtype"</span>), np.float16) </li><li>    output_dtype = DTYPE.get(content.get(<span class="hljs-string">"outputs"</span>)[cmp_idx].get(<span class="hljs-string">"dtype"</span>), np.float16) </li><li>    shape_info = InputOutputShapeInfo(shape_info=(b_value, head_num, s_value, h_value), </li><li>                                      keep_prob=keep_prob, </li><li>                                      input_dtype=input_dtype, </li><li>                                      output_dtype=output_dtype) </li><li>    <span class="hljs-keyword">return</span> shape_info, input_files, output_files </li><li><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>: </li><li>    <span class="hljs-string">""" </span></li><li><span class="hljs-string">    sys.argv[1]: input data file path </span></li><li><span class="hljs-string">    sys.argv[2]: output file path </span></li><li><span class="hljs-string">    sys.argv[3]: gen data type: input/output/all </span></li><li><span class="hljs-string">    """</span> </li><li>    tensor_shape_info, input_file_list, output_file_list = get_args() </li><li>    gen_total_golden_output(tensor_shape_info, input_file_list, output_file_list, need_new=<span class="hljs-literal">True</span>)</li></ol></pre></div></div> </div> <div></div></div>