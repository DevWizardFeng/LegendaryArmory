<h1 _ngcontent-bck-c119="" class="doc-title ng-star-inserted" title="数据防泄漏服务开发指导"> 数据防泄漏服务开发指导 </h1>

<div _ngcontent-bck-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>DLP是系统提供的系统级的数据防泄漏解决方案，提供一种称为DLP的文件格式。后缀格式为“原始文件名（包含原始文件后缀）.dlp”，例如“test.docx.dlp”，文件由授权凭证和原始文件密文组成。</p> <p>通过端云协同认证（需要联网）来获取文件的访问授权，授权类型包含只读、编辑、文件拥有者三种。</p> <ul><li>只读：能读取文件内容但不能修改。</li><li>编辑：能够读写文件内容，但不能修改文件权限配置。</li><li>文件拥有者：可读写文件、修改权限配置、恢复原始文件等。</li></ul> <p>应用需要访问DLP文件时，系统会自动安装应用的DLP沙箱分身应用，相当于完全独立的应用，数据和配置会继承原应用，但相互之间并不共享。分身应用在运行时会处于DLP沙箱环境中，访问外部的权限会被限制，以防止数据的泄漏。每当打开一个新的DLP文件会生成一个应用沙箱分身，沙箱应用之间也是相互隔离的，当应用关闭后应用分身会自动卸载，沙箱期间产生的临时数据也会丢弃。</p> <p>正常情况下，应用不会感知到沙箱的存在，访问的也是解密后的明文，和访问普通文件没有区别，但由于DLP沙箱会限制其访问外部的权限（例如网络、剪切板、截屏、录屏、蓝牙等）。为了更好的用户体验，需要应用进行适配，例如文件只读的情况下，不应显示“保存”按钮，不应主动联网等。</p> <div class="tiledSection"><h2 id="沙箱限制">沙箱限制<i class="anchor-icon anchor-icon-link" anchorid="沙箱限制" tips="复制节点链接"></i></h2><p>当应用进入DLP沙箱状态时，可以申请的权限将受到限制，根据DLP文件授权类型不同，限制也不相同，如下表：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.3.1.5.1.1" valign="top" width="25%"><p>权限名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.5.1.2" valign="top" width="37.11%"><p>说明</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.5.1.3" valign="top" width="16.28%"><p>授权类型：只读</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.5.1.4" valign="top" width="21.61%"><p>授权类型：编辑/文件拥有者</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>ohos.permission.USE_BLUETOOTH</p> </td> <td class="cellrowborder" valign="top" width="37.11%"><p>允许应用使用蓝牙。</p> </td> <td class="cellrowborder" valign="top" width="16.28%"><p>禁止</p> </td> <td class="cellrowborder" valign="top" width="21.61%"><p>禁止</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>ohos.permission.INTERNET</p> </td> <td class="cellrowborder" valign="top" width="37.11%"><p>允许应用访问网络。</p> </td> <td class="cellrowborder" valign="top" width="16.28%"><p>禁止</p> </td> <td class="cellrowborder" valign="top" width="21.61%"><p>禁止</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>ohos.permission.DISTRIBUTED_DATASYNC</p> </td> <td class="cellrowborder" valign="top" width="37.11%"><p>允许应用与远程设备交换用户数据（如图片、音乐、视频、及应用数据等）。</p> </td> <td class="cellrowborder" valign="top" width="16.28%"><p>禁止</p> </td> <td class="cellrowborder" valign="top" width="21.61%"><p>禁止</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>ohos.permission.WRITE_MEDIA</p> </td> <td class="cellrowborder" valign="top" width="37.11%"><p>应用读写用户媒体文件，如视频、音频、图片等，需要申请此权限。</p> </td> <td class="cellrowborder" valign="top" width="16.28%"><p>禁止</p> </td> <td class="cellrowborder" valign="top" width="21.61%"><p>允许</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>ohos.permission.NFC_TAG</p> </td> <td class="cellrowborder" valign="top" width="37.11%"><p>允许应用使用NFC。</p> </td> <td class="cellrowborder" valign="top" width="16.28%"><p>禁止</p> </td> <td class="cellrowborder" valign="top" width="21.61%"><p>允许</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="69.81%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="30.19%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="69.81%"><p>isDLPFile(fd: number): Promise&lt;boolean&gt;</p> <p>isDLPFile(fd: number, callback: AsyncCallback&lt;boolean&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>判断是否是dlp文件。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getDLPPermissionInfo(): Promise&lt;DLPPermissionInfo&gt;</p> <p>getDLPPermissionInfo(callback: AsyncCallback&lt;DLPPermissionInfo&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取当前沙箱应用的权限类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getOriginalFileName(fileName: string): string</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取dlp文件原始文件名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getDLPSuffix(): string</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取dlp文件dlp后缀名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>on(type: 'openDLPFile', listener: Callback&lt;AccessedDLPFileInfo&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>注册dlp文件打开事件监听，用于原始应用获取dlp文件打开事件。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>off(type: 'openDLPFile', listener?: Callback&lt;AccessedDLPFileInfo&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>取消dlp文件打开事件监听。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>isInSandbox(): Promise&lt;boolean&gt;</p> <p>isInSandbox(callback: AsyncCallback&lt;boolean&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>判断当前是否是dlp沙箱应用。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getDLPSupportedFileTypes(): Promise&lt;Array&lt;string&gt;&gt;</p> <p>getDLPSupportedFileTypes(callback: AsyncCallback&lt;Array&lt;string&gt;&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取当前系统支持添加权限保护的文件格式类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>setRetentionState(docUris: Array&lt;string&gt;): Promise&lt;void&gt;</p> <p>setRetentionState(docUris: Array&lt;string&gt;, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>设置dlp分身应用保留状态。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>cancelRetentionState(docUris: Array&lt;string&gt;): Promise&lt;void&gt;</p> <p>cancelRetentionState(docUris: Array&lt;string&gt;, callback: AsyncCallback&lt;void&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>取消dlp分身应用保留状态。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getRetentionSandboxList(bundleName?: string): Promise&lt;Array&lt;RetentionSandboxInfo&gt;&gt;</p> <p>getRetentionSandboxList(bundleName: string, callback: AsyncCallback&lt;Array&lt;RetentionSandboxInfo&gt;&gt;): void</p> <p>getRetentionSandboxList(callback: AsyncCallback&lt;Array&lt;RetentionSandboxInfo&gt;&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取当前保留沙箱列表。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getDLPFileAccessRecords(): Promise&lt;Array&lt;AccessedDLPFileInfo&gt;&gt;</p> <p>getDLPFileAccessRecords(callback: AsyncCallback&lt;Array&lt;AccessedDLPFileInfo&gt;&gt;): void</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>获取dlp文件访问记录。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>setSandboxAppConfig(configInfo: string): Promise&lt;void&gt;</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>设置沙箱应用配置信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>getSandboxAppConfig(): Promise&lt;string&gt;</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>查询沙箱应用配置信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>cleanSandboxAppConfig(): Promise&lt;void&gt;</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>清理沙箱应用配置信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="69.81%"><p>startDLPManagerForResult(context: common.UIAbilityContext, want: Want): Promise&lt;DLPManagerResult&gt;</p> </td> <td class="cellrowborder" valign="top" width="30.19%"><p>在当前UIAbility界面以无边框形式打开DLP权限管理应用（只支持Stage模型）。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><p>DLP作为HarmonyOS系统级数据防泄漏方案，可以让应用在零适配或低代码适配的情况下接入DLP能力，打开DLP文件。</p> <p>当用户使用默认应用或指定应用打开DLP文件时，DLP框架将会完成：</p> <ol><li>安装此应用的DLP沙箱分身应用。</li><li>为这个DLP文件绑定一个FUSE文件。</li><li>将FUSE文件分享给DLP沙箱分身应用。</li></ol> <p>实现DLP沙箱分身在无感加解密流程下访问DLP文件解密后的内容。</p> <p>当三方应用接入DLP（支持打开DLP文件）时，为了更优的体验，可从以下方面完成适配。</p> </div> <div class="tiledSection"><h3 id="预置操作" class="firsth2">预置操作<i class="anchor-icon anchor-icon-link" anchorid="预置操作" tips="复制节点链接"></i></h3><p>本文档提供接口示例代码，如需要了解工程项目创建方式，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-project" target="_blank">工程创建</a>。</p> <p>应用接入DLP能力，支持被安装为DLP沙箱分身应用，打开DLP文件，需要具备以下条件：</p> <ul><li>应用需要支持打开以下文件类型中的其中一种或几种，也就是当前DLP支持的文件类型。包括：<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-string">".doc"</span>, <span class="hljs-string">".docm"</span>, <span class="hljs-string">".docx"</span>, <span class="hljs-string">".dot"</span>, <span class="hljs-string">".dotm"</span>, <span class="hljs-string">".dotx"</span>, <span class="hljs-string">".odp"</span>, <span class="hljs-string">".odt"</span>, <span class="hljs-string">".pdf"</span>, <span class="hljs-string">".pot"</span>, <span class="hljs-string">".potm"</span>, <span class="hljs-string">".potx"</span>, <span class="hljs-string">".ppa"</span>,</li><li>  <span class="hljs-string">".ppam"</span>, <span class="hljs-string">".pps"</span>, <span class="hljs-string">".ppsm"</span>, <span class="hljs-string">".ppsx"</span>, <span class="hljs-string">".ppt"</span>, <span class="hljs-string">".pptm"</span>, <span class="hljs-string">".pptx"</span>, <span class="hljs-string">".rtf"</span>, <span class="hljs-string">".txt"</span>, <span class="hljs-string">".wps"</span>, <span class="hljs-string">".xla"</span>, <span class="hljs-string">".xlam"</span>, <span class="hljs-string">".xls"</span>,</li><li>  <span class="hljs-string">".xlsb"</span>, <span class="hljs-string">".xlsm"</span>, <span class="hljs-string">".xlsx"</span>, <span class="hljs-string">".xlt"</span>, <span class="hljs-string">".xltm"</span>, <span class="hljs-string">".xltx"</span>, <span class="hljs-string">".xlw"</span>, <span class="hljs-string">".xml"</span>, <span class="hljs-string">".xps"</span></li></ol></pre></div></div> </li></ul> <ul><li>应用需要具备ohos.want.action.viewData或ohos.want.action.editData的skills，可在module.json5文件中增加相应配置：<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span></li><li>    <span class="hljs-punctuation">{</span></li><li>      <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span></li><li>        ...</li><li>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>      <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span></li><li>        ...</li><li>        <span class="hljs-string">"ohos.want.action.viewData"</span></li><li>      <span class="hljs-punctuation">]</span></li><li>    <span class="hljs-punctuation">}</span></li><li>  <span class="hljs-punctuation">]</span></li></ol></pre></div></div> </li></ul> <ul><li><p>使用的设备需要具备域账号环境。</p> </li></ul> </div> <div class="tiledSection"><h3 id="导入模块">导入模块<i class="anchor-icon anchor-icon-link" anchorid="导入模块" tips="复制节点链接"></i></h3><p>引入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission" target="_blank">dlpPermission</a>模块。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="应用支持打开dlp文件绑定的fuse文件">应用支持打开DLP文件绑定的FUSE文件<i class="anchor-icon anchor-icon-link" anchorid="应用支持打开dlp文件绑定的fuse文件" tips="复制节点链接"></i></h3><p>一般情况下，应用如果支持打开<a href="/consumer/cn/doc/harmonyos-guides/dlp-guidelines#预置操作">预置操作</a>中指定文件类型的文件，没有对传入的Want做特定限制的情况下，不需要适配即可打开FUSE文件。</p> <p>打开DLP文件时，应用被安装为DLP沙箱分身应用（后续简称为分身），分身会收到want请求，分身可以对其中一些字段进行解析：</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Want</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.Want'</span>;</li><li>
</li><li> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DLPUriObj</span> {</li><li>   <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></li><li> };</li><li>
</li><li> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DLPWriteable</span> {</li><li>   <span class="hljs-attr">name</span>:<span class="hljs-built_in">boolean</span></li><li> };</li><li>
</li><li> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DLPNameObj</span> {</li><li>   <span class="hljs-attr">dateModified</span>: <span class="hljs-built_in">string</span>,</li><li>   <span class="hljs-attr">displayName</span>: <span class="hljs-built_in">string</span>,</li><li>   <span class="hljs-attr">relativePath</span>: <span class="hljs-built_in">string</span>,</li><li> };</li><li>
</li><li> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DLPLinkNameObj</span> {</li><li>   <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></li><li> };</li><li>
</li><li> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParams</span>(<span class="hljs-params">want: Want</span>) {</li><li>   <span class="hljs-comment">// 接收打开DLP文件传过来的参数</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">dlpFuseUri</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">uri</span>? want.<span class="hljs-property">uri</span> : <span class="hljs-string">''</span>;  <span class="hljs-comment">// FUSE文件的uri, 存放解密后的明文</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">dlpFuseWriteable</span>: <span class="hljs-built_in">boolean</span> = (want.<span class="hljs-property">parameters</span>?.<span class="hljs-property">linkFileWriteable</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">DLPWriteable</span>).<span class="hljs-property">name</span>; <span class="hljs-comment">// 对FUSE文件是否有写权限</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">dlpUri</span>: <span class="hljs-built_in">string</span> = (want.<span class="hljs-property">parameters</span>?.<span class="hljs-property">dlpUri</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">DLPUriObj</span>).<span class="hljs-property">name</span>; <span class="hljs-comment">// DLP文件的uri</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">dlpName</span>: <span class="hljs-built_in">string</span> = (want.<span class="hljs-property">parameters</span>?.<span class="hljs-property">fileAsset</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">DLPNameObj</span>).<span class="hljs-property">displayName</span>; <span class="hljs-comment">// DLP文件的文件名</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">dlpFuseName</span>: <span class="hljs-built_in">string</span> = (want.<span class="hljs-property">parameters</span>?.<span class="hljs-property">linkFileName</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">DLPLinkNameObj</span>).<span class="hljs-property">name</span>; <span class="hljs-comment">// FUSE文件的文件名</span></li><li> }</li></ol></pre></div></div> <p>分身可以通过把want.uri打开为fd，获取FUSE文件的内容：</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> fileIo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.fileio'</span>;</li><li> <span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li> <span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.util'</span>;</li><li>
</li><li> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFileContent</span>(<span class="hljs-params">dlpFuseUri:<span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span>;</li><li>   <span class="hljs-keyword">try</span> {</li><li>     file = fs.<span class="hljs-title function_">openSync</span>(dlpFuseUri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>); <span class="hljs-comment">// 打开FUSE文件获取fd</span></li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">commonFd</span> = file.<span class="hljs-property">fd</span>;</li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'openSync failed. '</span> + err);</li><li>     <span class="hljs-keyword">return</span> content;</li><li>   }</li><li>
</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">let</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">4096</span>);</li><li>     <span class="hljs-keyword">let</span> readOut = fs.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commonFd</span>, buffer, { <span class="hljs-comment">// 读取文件内容</span></li><li>       <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span></li><li>     });</li><li>     content = <span class="hljs-title function_">bufferToString</span>(buffer); <span class="hljs-comment">// 文件内容转换成string类型</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readSync failed. '</span> + err);</li><li>   }</li><li>   fileIo.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commonFd</span>); <span class="hljs-comment">// 关闭文件</span></li><li>   <span class="hljs-keyword">return</span> content;</li><li> }</li><li>
</li><li> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bufferToString</span>(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-built_in">string</span> {</li><li>   <span class="hljs-keyword">let</span> textDecoder = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>, {</li><li>     <span class="hljs-attr">ignoreBOM</span>: <span class="hljs-literal">true</span></li><li>   });</li><li>   <span class="hljs-keyword">let</span> resultPut = textDecoder.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer), {</li><li>     <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span></li><li>   });</li><li>   <span class="hljs-keyword">return</span> resultPut;</li><li> }</li></ol></pre></div></div> <p>如果有FUSE文件的读写权限，也可以更新FUSE文件内容：</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeFileContent</span>(<span class="hljs-params">dlpFuseUri: <span class="hljs-built_in">string</span>, content: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">file</span>: fs.<span class="hljs-property">File</span> = fs.<span class="hljs-title function_">openSync</span>(dlpFuseUri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>); <span class="hljs-comment">// 以读写权限打开FUSE文件获取fd</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">writeLen</span>: <span class="hljs-built_in">number</span> = fs.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, content);  <span class="hljs-comment">// 把内容写回FUSE文件中</span></li><li>  fs.<span class="hljs-title function_">closeSync</span>(file); <span class="hljs-comment">// 关闭文件</span></li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="应用根据dlp文件的权限对界面进行适配">应用根据DLP文件的权限对界面进行适配<i class="anchor-icon anchor-icon-link" anchorid="应用根据dlp文件的权限对界面进行适配" tips="复制节点链接"></i></h3><p>DLP沙箱分身中可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissiongetdlppermissioninfo" target="_blank">getDLPPermissionInfo</a>方法查询当前系统登陆的域账号用户对本DLP文件的用户权限和操作权限，不同用户权限可以对应不同的对文档的操作权限。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> dlpPermission.<span class="hljs-title function_">getDLPPermissionInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: dlpPermission.DLPPermissionInfo</span>)=&gt;</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">userAccess</span>: dlpPermission.<span class="hljs-property">DLPPermissionInfo</span>.<span class="hljs-property">DLPFileAccess</span> = data.<span class="hljs-property">dlpFileAccess</span>; <span class="hljs-comment">// 用户对本DLP文件的用户权限</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">isEditable</span>: <span class="hljs-built_in">number</span> = data.<span class="hljs-property">flags</span> &amp; dlpPermission.<span class="hljs-property">DLPPermissionInfo</span>.<span class="hljs-property">ACTION_EDIT</span>; <span class="hljs-comment">// 用户对本DLP文件的操作权限</span></li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getDLPPermissionInfo: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li> });</li></ol></pre></div></div> <p>getDLPPermissionInfo返回的data为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissioninfo" target="_blank">DLPPermissionInfo</a>类型，其中dlpFileAccess表示用户权限，flags表示操作权限的按位组合的结果。可以根据返回的flags字段对照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#actionflagtype" target="_blank">ActionFlagType</a>判断DLP沙箱分身是否具有对应的操作权限，可以用于界面按钮置灰操作等。</p> </div> <div class="tiledSection"><h3 id="应用与dlp沙箱分身数据共享">应用与DLP沙箱分身数据共享<i class="anchor-icon anchor-icon-link" anchorid="应用与dlp沙箱分身数据共享" tips="复制节点链接"></i></h3><p>DLP沙箱分身是普通应用的分身，所有数据都是全新的，如果二者之间有些数据需要实现共享，可以通过DLP框架提供的应用与DLP沙箱分身数据共享机制实现。一种典型的使用场景是原应用与DLP沙箱分身之间共用是否已经弹出过隐私声明弹框的配置信息。</p> <p>一般包括下面四种读写配置信息前后顺序组合：</p> <ul><li>原应用写配置，原应用读配置。</li><li>原应用写配置，DLP沙箱分身读配置。</li><li>DLP沙箱分身写配置，DLP沙箱分身读配置。</li><li>DLP沙箱分身写配置，原应用读配置。</li></ul> </div> <p><strong>约束与限制</strong></p> <ul><li>每次调用设置配置信息接口会覆盖上次调用的设置内容。</li><li>出于数据防泄漏考虑，DLP沙箱分身写配置需要在读取FUSE文件内容之前完成。</li></ul> <p><strong>具体步骤</strong></p> <ol><li>设置配置信息。<p>把需要保存的配置信息转成string类型，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissionsetsandboxappconfig11" target="_blank">setSandboxAppConfig</a>接口设置配置信息。</p> <p>普通应用和DLP沙箱分身都可以调用该接口，但DLP沙箱分身必须在读取DLP文件内容之前才允许调用。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setSandboxAppConfig</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">setSandboxAppConfig</span>(<span class="hljs-string">'configInfo'</span>); <span class="hljs-comment">// 设置配置信息</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'setSandboxAppConfig error, '</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li><li>清理配置信息。<p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissioncleansandboxappconfig11" target="_blank">cleanSandboxAppConfig</a>接口清理该应用的所有配置信息。</p> <p>该接口只允许普通应用中调用。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanSandboxAppConfig</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">cleanSandboxAppConfig</span>(); <span class="hljs-comment">// 清理配置信息</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cleanSandboxAppConfig error, '</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li><li>获取配置信息。<p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissiongetsandboxappconfig11" target="_blank">getSandboxAppConfig</a>查询该应用的所有配置信息。</p> <p>普通应用和DLP沙箱分身都可以调用。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getSandboxAppConfig</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>:<span class="hljs-built_in">string</span> = <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">getSandboxAppConfig</span>(); <span class="hljs-comment">// 查询配置信息</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getSandboxAppConfig error, '</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li></ol> <div class="tiledSection"><h3 id="应用支持更新最近打开记录">应用支持更新最近打开记录<i class="anchor-icon anchor-icon-link" anchorid="应用支持更新最近打开记录" tips="复制节点链接"></i></h3><p>当应用有最近打开记录场景时，可以使用DLP框架提供的接口适配最近打开记录。可从以下场景适配：</p> </div> <ul><li><strong>普通应用未启动，无法感知到DLP沙箱分身打开的DLP文件</strong>。<p>仅有DLP沙箱分身有打开DLP文件场景：普通应用启动时，可以通过接口获取到历史通过本应用的DLP沙箱分身打开的DLP文件。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li>    <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDLPFileAccessRecords</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>:<span class="hljs-title class_">Array</span>&lt;dlpPermission.<span class="hljs-property">AccessedDLPFileInfo</span>&gt; = <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">getDLPFileAccessRecords</span>(); <span class="hljs-comment">// 获取DLP访问列表</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'res'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res))</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>      }</li><li>    }</li></ol></pre></div></div> </li><li><strong>普通应用已启动，可以感知到DLP沙箱分身打开的DLP文件</strong>。<p>DLP沙箱分身有打开DLP文件场景：普通应用可以订阅本应用的DLP沙箱分身打开DLP文件的事件。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>   <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">subscribe</span>();</li><li>   }</li><li>
</li><li>   <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unSubscribe</span>();</li><li>   }</li><li>
</li><li>   <span class="hljs-title function_">event</span>(<span class="hljs-params">info: dlpPermission.AccessedDLPFileInfo</span>) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'openDlpFile event'</span>, info.<span class="hljs-property">uri</span>, info.<span class="hljs-property">lastOpenTime</span>)</li><li>   }</li><li>
</li><li>   <span class="hljs-title function_">unSubscribe</span>(<span class="hljs-params"></span>) {</li><li>     <span class="hljs-keyword">try</span> {</li><li>       dlpPermission.<span class="hljs-title function_">off</span>(<span class="hljs-string">'openDLPFile'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">event</span>); <span class="hljs-comment">// 取消订阅</span></li><li>     } <span class="hljs-keyword">catch</span> (err) {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>     }</li><li>   }</li><li>
</li><li>   <span class="hljs-title function_">subscribe</span>(<span class="hljs-params"></span>) {</li><li>     <span class="hljs-keyword">try</span> {</li><li>       dlpPermission.<span class="hljs-title function_">on</span>(<span class="hljs-string">'openDLPFile'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">event</span>); <span class="hljs-comment">// 订阅</span></li><li>     } <span class="hljs-keyword">catch</span> (err) {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>     }</li><li>   }</li><li> }</li></ol></pre></div></div> </li></ul> <div class="tiledSection"><h3 id="应用内支持打开选定的dlp文件">应用内支持打开选定的DLP文件<i class="anchor-icon anchor-icon-link" anchorid="应用内支持打开选定的dlp文件" tips="复制节点链接"></i></h3><p>应用可以支持从最近打开列表、文件选择器中选择DLP文件，打开DLP文件的场景，按如下流程适配：</p> <ol><li><p>设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-want" target="_blank">Want</a>参数，指定action为"ohos.want.action.viewData"，bundleName、abilityName分别为选择打开DLP文件的应用的bundleName、abilityName，uri为需要打开的DLP文件的uri，在parameters中设置fileName的name值为DLP文件的文件名。</p> </li><li><p>获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-common" target="_blank">UIAbilityContext</a>的context。</p> </li><li><p>调用context的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#startability" target="_blank">startAbility</a>方法传入want参数，打开dlp文件。</p> </li></ol> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li> <span class="hljs-keyword">function</span> <span class="hljs-title function_">openDlpFile</span>(<span class="hljs-params">dlpUri: <span class="hljs-built_in">string</span>, fileName: <span class="hljs-built_in">string</span></span>) {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>     <span class="hljs-string">"action"</span>: <span class="hljs-string">"ohos.want.action.viewData"</span>,</li><li>     <span class="hljs-string">"bundleName"</span>: <span class="hljs-string">"com.example.example_bundle_name"</span>,</li><li>     <span class="hljs-string">"abilityName"</span>: <span class="hljs-string">"exampleAbility"</span>,</li><li>     <span class="hljs-string">"uri"</span>: dlpUri,</li><li>     <span class="hljs-string">"parameters"</span>: {</li><li>       <span class="hljs-string">"fileName"</span>: {</li><li>         <span class="hljs-string">"name"</span>: fileName</li><li>       }</li><li>     }</li><li>   }</li><li>   <span class="hljs-keyword">let</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// 获取当前UIAbilityContext</span></li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'openDLPFile:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(want));</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'openDLPFile: delegator:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(context));</li><li>     context.<span class="hljs-title function_">startAbility</span>(want);</li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'openDLPFile startAbility failed'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>     <span class="hljs-keyword">return</span>;</li><li>   }</li><li> }</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="应用内支持对dlp文件权限设置">应用内支持对DLP文件权限设置<i class="anchor-icon anchor-icon-link" anchorid="应用内支持对dlp文件权限设置" tips="复制节点链接"></i></h3><p>应用内可以集成权限设置按钮，当已打开一个普通文件后，点击权限设置按钮，拉起DLP管理应用的模态设置权限页面，生成DLP文件。也可以在DLP沙箱分身中查看当前正在打开的DLP文件的操作权限。</p> </div> <ul><li><strong>普通应用内权限设置</strong><p>以无边框形式打开DLP权限管理应用。</p> <ul><li><p>此方法只能在UIAbility上下文中调用，只支持Stage模式。</p> </li><li><p>want参数中uri的值为普通文件uri，parameters.displayName为文件名，这两个值为必传参数。</p> </li><li><p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissionstartdlpmanagerforresult11" target="_blank">dlpPermission.startDLPManagerForResult</a>拉起DLP管理应用的设置权限页面，输入相关的域账号信息，点击保存，在拉起的filepicker中选择DLP文件的保存路径，保存DLP文件。</p> </li></ul> <p>调用以下代码：</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataLossPreventionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">fileUri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"file://docs/storage/Users/currentUser/test.txt"</span>;</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"test.txt"</span>;</li><li>   <span class="hljs-keyword">let</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// 获取当前UIAbilityContext</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>     <span class="hljs-string">'uri'</span>: fileUri,</li><li>     <span class="hljs-string">'parameters'</span>: {</li><li>       <span class="hljs-string">'displayName'</span>: fileName</li><li>     }</li><li>   }; <span class="hljs-comment">// 请求参数</span></li><li>   dlpPermission.<span class="hljs-title function_">startDLPManagerForResult</span>(context, want).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: dlpPermission.DLPManagerResult</span>) =&gt;</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startDLPManagerForResult res.resultCode:'</span> + res.<span class="hljs-property">resultCode</span>);</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startDLPManagerForResult res.want:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res.<span class="hljs-property">want</span>));</li><li>   }); <span class="hljs-comment">// 拉起DLP权限管理应用 设置权限</span></li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startDLPManagerForResult error:'</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li> }</li></ol></pre></div></div> </li><li><strong>DLP沙箱分身内权限修改，查看和解除</strong><ul><li>如果当前的账号是DLP文档的创建者，则该用户拥有修改这个DLP文件权限或者解除这个DLP文档权限还原为普通文件的能力，调用以下代码，拉起DLP管理应用的设置权限页面，在该页面中选择更改加密进行权限修改或者解除加密；如果当前账号拥有DLP文档只读或者编辑权限，调用以下代码则可以查看当前用户权限内容。<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataLossPreventionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">fileUri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"file://docs/storage/Users/currentUser/test.txt.dlp"</span>;<span class="hljs-comment">// DLP文件的uri</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"test.txt.dlp"</span>;</li><li>   <span class="hljs-keyword">let</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>; <span class="hljs-comment">// 获取当前UIAbilityContext</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>     <span class="hljs-string">'uri'</span>: fileUri,</li><li>     <span class="hljs-string">'parameters'</span>: {</li><li>       <span class="hljs-string">'displayName'</span>: fileName</li><li>     }</li><li>   }; <span class="hljs-comment">// 请求参数</span></li><li>   dlpPermission.<span class="hljs-title function_">startDLPManagerForResult</span>(context, want).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: dlpPermission.DLPManagerResult</span>) =&gt;</span> {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startDLPManagerForResult res.resultCode:'</span> + res.<span class="hljs-property">resultCode</span>);</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startDLPManagerForResult res.want:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res.<span class="hljs-property">want</span>));</li><li>   }); <span class="hljs-comment">// 拉起DLP权限管理应用 设置权限</span></li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startDLPManagerForResult error:'</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li> }</li></ol></pre></div></div> </li></ul> <ul><li>DLP沙箱分身中可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissiongetdlppermissioninfo" target="_blank">getDLPPermissionInfo</a>方法查询当前用户DLP文件权限，DLP沙箱分身的权限限制，参考<a href="/consumer/cn/doc/harmonyos-guides/dlp-guidelines#沙箱限制">沙箱限制</a>。<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> dlpPermission.<span class="hljs-title function_">getDLPPermissionInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data:dlpPermission.DLPPermissionInfo</span>)=&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getDLPPermissionInfo, result: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getDLPPermissionInfo: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li> });</li></ol></pre></div></div> </li></ul> </li></ul> <div class="tiledSection"><h3 id="其他dlp能力增强">其他DLP能力增强<i class="anchor-icon anchor-icon-link" anchorid="其他dlp能力增强" tips="复制节点链接"></i></h3></div> <ul><li><strong>判断一个文件是否是DLP文件</strong><p>传入文件的fd查询对应文件是否是DLP文件，是DLP文件则按<a href="/consumer/cn/doc/harmonyos-guides/dlp-guidelines#应用内支持打开选定的dlp文件">文档指导</a>打开该文件。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">let</span> uri = <span class="hljs-string">"file://docs/storage/Users/currentUser/Desktop/test.txt.dlp"</span>;</li><li> <span class="hljs-keyword">let</span> file = fileIo.<span class="hljs-title function_">openSync</span>(uri);</li><li> <span class="hljs-keyword">try</span> {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>: <span class="hljs-built_in">boolean</span> = dlpPermission.<span class="hljs-title function_">isDLPFile</span>(file.<span class="hljs-property">fd</span>); <span class="hljs-comment">// 是否加密DLP文件</span></li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'res'</span>, res);</li><li> } <span class="hljs-keyword">catch</span> (err) {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li> }</li><li> fileIo.<span class="hljs-title function_">closeSync</span>(file);</li></ol></pre></div></div> </li><li><strong>判断当前所在应用是否是DLP沙箱分身</strong><p>在应用中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissionisinsandbox" target="_blank">isInSandbox</a>接口判断当前是否是DLP沙箱分身，如果是DLP沙箱分身则可以结合<a href="/consumer/cn/doc/harmonyos-guides/dlp-guidelines#应用根据dlp文件的权限对界面进行适配">调用接口查询权限</a>的结果进行对应功能按钮的置灰或屏蔽。比如：如果只有只读权限，则编辑保存入口可以置灰，如果是只读或者编辑权限，则修改权限入口可以置灰。</p> <div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> dlpPermission.<span class="hljs-title function_">isInSandbox</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">boolean</span></span>)=&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'isInSandbox, result: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'isInSandbox: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));</li><li> });</li></ol></pre></div></div> </li><li><strong>保留沙箱</strong>。<p>DLP沙箱分身关闭后会进行沙箱卸载，如果不希望DLP沙箱分身关闭时卸载该沙箱可以在沙箱中调用设置保留沙箱接口，只有当再次调用取消保留沙箱接口并关闭DLP沙箱分身才会触发沙箱的卸载。</p> <ul><li>调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissionsetretentionstate" target="_blank">setRetentionState</a>设置保留沙箱，传入参数为本沙箱内打开的dlp文件的uri列表，该接口只允许在沙箱中调用。<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRetentionSandboxList</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">docUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;=[<span class="hljs-string">"file://docs/storage/Users/currentUser/Desktop/test.txt.dlp"</span>]</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">setRetentionState</span>(docUris); <span class="hljs-comment">// 设置沙箱保留</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li><li>调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissioncancelretentionstate" target="_blank">cancelRetentionState</a>取消保留沙箱，该接口只允许沙箱中调用。<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRetentionSandboxList</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">docUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;=[<span class="hljs-string">"file://docs/storage/Users/currentUser/Desktop/test.txt.dlp"</span>]</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">cancelRetentionState</span>(docUris); <span class="hljs-comment">// 取消保留沙箱</span></li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li><li>调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-dlppermission#dlppermissiongetretentionsandboxlist" target="_blank">getRetentionSandboxList</a>获取保留沙箱记录，该接口允许原应用和DLP沙箱分身中调用。<div _ngcontent-bck-c106="" class="highlight-div"><div _ngcontent-bck-c106="" class="highlight-div-header"><div _ngcontent-bck-c106="" class="highlight-div-header-left"><div _ngcontent-bck-c106="" class="handle-button expand-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bck-c106="" class="highlight-div-header-right"><div _ngcontent-bck-c106="" class="handle-button ai-button"></div><div _ngcontent-bck-c106="" class="handle-button line-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bck-c106="" class="handle-button theme-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bck-c106="" class="handle-button copy-button"><div _ngcontent-bck-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bck-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { dlpPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataProtectionKit'</span>;</li><li> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getRetentionSandboxList</span>(<span class="hljs-params"></span>) {</li><li>   <span class="hljs-keyword">try</span> {</li><li>     <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>:<span class="hljs-title class_">Array</span>&lt;dlpPermission.<span class="hljs-property">RetentionSandboxInfo</span>&gt; = <span class="hljs-keyword">await</span> dlpPermission.<span class="hljs-title function_">getRetentionSandboxList</span>(); <span class="hljs-comment">// 获取保留沙箱记录</span></li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'res'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res))</li><li>   } <span class="hljs-keyword">catch</span> (err) {</li><li>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'error'</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>, (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>); <span class="hljs-comment">// 失败报错</span></li><li>   }</li><li> }</li></ol></pre></div></div> </li></ul> </li></ul> <div class="tiledSection"><h2 id="典型问题自排查">典型问题自排查<i class="anchor-icon anchor-icon-link" anchorid="典型问题自排查" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="应用可以打开正常文件无法打开fuse文件" class="firsth2">应用可以打开正常文件，无法打开FUSE文件<i class="anchor-icon anchor-icon-link" anchorid="应用可以打开正常文件无法打开fuse文件" tips="复制节点链接"></i></h3><ul><li>排查是否对want做了特定限制，导致DLP沙箱分身无法获取到FUSE文件。</li><li>排查是否以读写权限打开了只读的FUSE文件。</li></ul> </div> </div> <div></div></div>