<h1 _ngcontent-oss-c119="" class="doc-title ng-star-inserted" title="文件打开加速状态感知"> 文件打开加速状态感知 </h1>

<div _ngcontent-oss-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从5.0.5(17)版本开始，如浏览器等支持下载文件的应用，可以接入文件预加载状态感知接口，动态感知文件预加载状态，通过UI（user interface）标识对加速文件进行显性化提示，进一步提升用户体验。</p>    <div class="tiledSection">     <h2 id="section1079912211528">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1079912211528" tips="复制节点链接"></i></h2>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/preview-arkts-openfileboost-api" target="_blank">预加载状态感知接口文档</a>。</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <caption>       <b>表1 </b>文件预加载状态感知接口介绍（ArkTS API）      </caption>      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.3.2.3.1.1" valign="top" width="50%">         <p>接口名</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.3.2.3.1.2" valign="top" width="50%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">         <p>on(type: 'filePreloadStateChanged', callback: Callback&lt;FilePreloadStatusInfo&gt;): void</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>文件预加载状态回调，应用通过注册回调函数获取文件预加载的状态变化。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">         <p>off(type: 'filePreloadStateChanged', callback?: Callback&lt;FilePreloadStatusInfo&gt;): void</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>文件预加载状态注销回调，通过注销回调函数取消获取文件预加载的状态变化。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">         <p>addFile(file: string): void</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>监听一个文件的预加载状态，传入文件路径开始监听该文件的预加载状态。后续该文件状态有变化通过'filePreloadStateChanged'事件回调应用。</p>         <p>注意需要先调用openFileBoost.on('filePreloadStateChanged')接口后再调用该接口添加文件。</p>         <p>当前支持加速的文件类型见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/preview-introduction#section7910758192912">文件打开加速支持的文件类型</a>， 不支持的文件类型默认为未预加载状态，不需要调用该接口监听文件预加载状态变更。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">         <p>removeFile(file: string): void</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>取消监听一个文件的预加载状态，取消后文件的预加载状态变化不会通过回调再通知业务。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">         <p>queryFilePreloadStatusInfo(file: string): FilePreloadStatusInfo</p></td>        <td class="cellrowborder" valign="top" width="50%">         <p>查询文件预加载状态，传入文件路径，通过返回值返回该文件当前的预加载状态。</p></td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="section17364453377">开发准备<i class="anchor-icon anchor-icon-link" anchorid="section17364453377" tips="复制节点链接"></i></h2>          <p>需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.PCService.OpenFileBoost系统能力，当前仅在2in1设备上支持该能力。</p>    </div>    <div class="tiledSection">     <h2 id="section4785101310532">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section4785101310532" tips="复制节点链接"></i></h2>          <ol>      <li><span>导入相关模块。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { openFileBoost } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PreviewKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li id="zh-cn_topic_0000002232379348_li13424101995516"><span>注册文件预加载状态感知回调函数。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 文件预加载状态变更的回调函数定义，若有文件预加载状态变更，则通过该回调函数通知</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">filePreloadStatusInfo: openFileBoost.FilePreloadStatusInfo</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">if</span> (filePreloadStatusInfo.<span class="hljs-property">state</span> === openFileBoost.<span class="hljs-property">FilePreloadState</span>.<span class="hljs-property">PRELOADING</span>) {</li><li>    <span class="hljs-comment">// 预加载过程中，应用可以根据自己设计对应UX</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`file is PRELOADING, suggest to show loading animation`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (filePreloadStatusInfo.<span class="hljs-property">state</span> === openFileBoost.<span class="hljs-property">FilePreloadState</span>.<span class="hljs-property">PRELOADED</span>) {</li><li>    <span class="hljs-comment">// 预加载完成，应用可以通过UX显示提示用户加速完成</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`file is PRELOADED, suggest to show loaded animation`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (filePreloadStatusInfo.<span class="hljs-property">state</span> === openFileBoost.<span class="hljs-property">FilePreloadState</span>.<span class="hljs-property">NOT_PRELOADED</span>) {</li><li>    <span class="hljs-comment">// 没有预加载，应用可以不显示任何额外UX</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`file is UNPRELOADED, suggest do not show animation `</span>);</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 调用register函数可以注册预加载状态感知回调</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    openFileBoost.<span class="hljs-title function_">on</span>(<span class="hljs-string">'filePreloadStateChanged'</span>, callback);</li><li>  } <span class="hljs-keyword">catch</span>(error) {</li><li>    <span class="hljs-keyword">let</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>;</li><li>    <span class="hljs-keyword">let</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`register filePreloadStateChanged failed, error code: <span class="hljs-subst">${code}</span>, message: <span class="hljs-subst">${message}</span>.`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>调用addFile接口传入想要监听的文件的沙箱路径。典型场景比如应用下载某个文件完成，可将该文件路径注册进来，若文件后续状态变更，系统会通过<a href="/consumer/cn/doc/harmonyos-guides/preview-openfileboost-stateawareness#zh-cn_topic_0000002232379348_li13424101995516">2</a>中的回调函数通知应用。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 为10MB_file.docx文件添加文件预加载状态监听</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testAddFile</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">file</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">"/storage/Users/currentUser/Desktop/10MB_file.docx"</span>;</li><li>    openFileBoost.<span class="hljs-title function_">addFile</span>(file);</li><li>  } <span class="hljs-keyword">catch</span>(error) {</li><li>    <span class="hljs-keyword">let</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>;</li><li>    <span class="hljs-keyword">let</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`addFile failed, error code: <span class="hljs-subst">${code}</span>, message: <span class="hljs-subst">${message}</span>.`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>通过addFile接口监听的文件个数有上限（50个文件），不再需要监听的文件可以通过removeFile接口取消监听。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">file</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">"/storage/Users/currentUser/Desktop/10MB_file.docx"</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  openFileBoost.<span class="hljs-title function_">removeFile</span>(file);</li><li>} <span class="hljs-keyword">catch</span>(error) {</li><li>  <span class="hljs-keyword">let</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>;</li><li>  <span class="hljs-keyword">let</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`removeFile failed, error code: <span class="hljs-subst">${code}</span>, message: <span class="hljs-subst">${message}</span>.`</span>);</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>如果不需要再监听任何文件的预加载状态变更，可注销预加载状态感知回调函数。如果传入具体的回调函数，则只取消该函数； 如果不传入具体的回调函数，则取消该进程的所有回调。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 假设之前在进程的不同业务逻辑中已经注册了callback1、callback2、callback3总共3个回调函数</span></li><li>openFileBoost.<span class="hljs-title function_">on</span>(<span class="hljs-string">'filePreloadStateChanged'</span>, callback1);</li><li>openFileBoost.<span class="hljs-title function_">on</span>(<span class="hljs-string">'filePreloadStateChanged'</span>, callback2);</li><li>openFileBoost.<span class="hljs-title function_">on</span>(<span class="hljs-string">'filePreloadStateChanged'</span>, callback3);</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testUnregister</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 单独取消callback1的监听，传入callback1作为参数，后续不会再调用callback1的回调做通知</span></li><li>    openFileBoost.<span class="hljs-title function_">off</span>(<span class="hljs-string">'filePreloadStateChanged'</span>, callback1);</li><li>    <span class="hljs-comment">// 取消所有callback的监听，不传第二个可选参数，后续不会再调用callback2和callback3做通知</span></li><li>    openFileBoost.<span class="hljs-title function_">off</span>(<span class="hljs-string">'filePreloadStateChanged'</span>);</li><li>  } <span class="hljs-keyword">catch</span>(error) {</li><li>    <span class="hljs-keyword">let</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>;</li><li>    <span class="hljs-keyword">let</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`off filePreloadStateChanged failed, error code: <span class="hljs-subst">${code}</span>, message: <span class="hljs-subst">${message}</span>.`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>应用还可通过查询接口查询某个文件的实时的预加载状态，一般在应用刚启动时可以查询一遍相关文件的预加载状态。每次调用接口传入一个文件的沙箱路径。</span>       <p></p>       <div _ngcontent-oss-c106="" class="highlight-div"><div _ngcontent-oss-c106="" class="highlight-div-header"><div _ngcontent-oss-c106="" class="highlight-div-header-left"><div _ngcontent-oss-c106="" class="handle-button expand-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oss-c106="" class="highlight-div-header-right"><div _ngcontent-oss-c106="" class="handle-button ai-button"></div><div _ngcontent-oss-c106="" class="handle-button line-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oss-c106="" class="handle-button theme-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oss-c106="" class="handle-button copy-button"><div _ngcontent-oss-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oss-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testQuery</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">file</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">"/storage/Users/currentUser/Desktop/10MB_file.docx"</span>;</li><li>  <span class="hljs-keyword">let</span> statusInfo : openFileBoost.<span class="hljs-property">FilePreloadStatusInfo</span> = openFileBoost.<span class="hljs-title function_">queryFilePreloadStatusInfo</span>(file);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'file, %{public}s, progress:%{public}d  preloadState:%{public}d'</span>,</li><li>    statusInfo.<span class="hljs-property">sandboxPath</span>, statusInfo.<span class="hljs-property">progress</span>, statusInfo.<span class="hljs-property">state</span>);</li><li>} <span class="hljs-keyword">catch</span>(error) {</li><li>  <span class="hljs-keyword">let</span> code = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span>;</li><li>  <span class="hljs-keyword">let</span> message = (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>;</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`query failed, error code: <span class="hljs-subst">${code}</span>, message: <span class="hljs-subst">${message}</span>.`</span>);</li><li>}</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>