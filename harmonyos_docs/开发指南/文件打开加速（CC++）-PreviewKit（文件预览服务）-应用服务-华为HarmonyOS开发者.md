<h1 _ngcontent-bji-c119="" class="doc-title ng-star-inserted" title="文件打开加速（C/C++）"> 文件打开加速（C/C++） </h1>

<div _ngcontent-bji-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从5.0.3(15)版本开始，新增文件打开加速功能。提供注册和取消注册接口，应用可以注册一系列回调，文件打开加速服务通过调用回调接口向应用推荐文件进行预加载动作。</p>    <div class="tiledSection">     <h2 id="section1064231523817">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1064231523817" tips="复制节点链接"></i></h2>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/openfileboost-index" target="_blank">文件打开加速接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <caption>        <b>表1 </b>文件预加载接口介绍（C API）       </caption>       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.3.1.1" valign="top" width="50%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.3.1.2" valign="top" width="50%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OpenFileBoost_ErrCode HMS_OpenFileBoost_RegisterFilePreload(</p>          <p>HMS_OpenFileBoost_QueryAppState queryAppState,</p>          <p>HMS_OpenFileBoost_OnFilePreload filePreload,</p>          <p>HMS_OpenFileBoost_OnFilePreload cancelFilePreload);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>向系统注册文件预加载回调，后续系统预测用户可能打开的文件，在通知预加载之前先调用queryAppState向应用查询当前是否允许推荐预加载文件，如果应用返回允许推荐，通过调用filePreload向应用推荐一个文件供应用进行文件预加载。在某些场景下,比如当前系统可用内存不足,或者有其他文件更有可能被用户打开,则系统会通过调用cancelFilePreload取消某些文件的预加载。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>typedef OpenFileBoost_AppState (*HMS_OpenFileBoost_QueryAppState)(void);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>系统查询APP状态的回调函数定义。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>typedef OpenFileBoost_CbErrCode (*HMS_OpenFileBoost_OnFilePreload)(void* fileInfo);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>系统向应用推荐或取消推荐预加载文件的回调函数定义。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OpenFileBoost_ErrCode HMS_OpenFileBoost_GetFdFromPreloadFileInfo(</p>          <p>void* fileInfo, int32_t* fd);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>在向应用推荐文件进行预加载或取消预加载的回调上下文中，应用通过调用该接口获取文件描述符信息。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OpenFileBoost_ErrCode HMS_OpenFileBoost_GetSandboxPathFromPreloadFileInfo(</p>          <p>void* fileInfo, char* sandboxPath, int32_t pathLen);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>在向应用推荐文件进行预加载或取消预加载的回调上下文中，应用通过调用该接口获取文件沙箱路径信息。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OpenFileBoost_ErrCode HMS_OpenFileBoost_UnregisterFilePreload(void);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>取消注册预加载回调。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">          <p>OpenFileBoost_ErrCode HMS_OpenFileBoost_NotifyPreloadHit(</p>          <p>int32_t fd, char* sandboxPath, int32_t pathLen);</p></td>         <td class="cellrowborder" valign="top" width="50%">          <p>当用户打开预加载文件时, 应用调用该接口通知系统预加载命中, 这将有助于提高预加载文件预测的准确性。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section17364453377">开发准备<i class="anchor-icon anchor-icon-link" anchorid="section17364453377" tips="复制节点链接"></i></h2>          <p>需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.PCService.OpenFileBoost系统能力，当前仅在2in1设备上支持该能力。</p>    </div>    <div class="tiledSection">     <h2 id="section1418318341804">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1418318341804" tips="复制节点链接"></i></h2>          <ol>      <li><span>申请文件打开加速服务的对应权限，在module.json5文件中添加文件预加载权限。注意ohos.permission.PRELOAD_FILE为受限权限，具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions-in-acl" target="_blank">申请使用受限权限</a></span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>:[</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.PRELOAD_FILE"</span></li><li>  }</li><li>]</li></ol></pre></div></div>       <p></p></li>      <li><span>添加对应的头文件。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"PreviewKit/open_file_boost.h"</span></span></li></ol></pre></div></div>       <p></p></li>      <li><span>编写CMakeLists.txt，新增对文件打开加速功能的依赖。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC</li><li>    libopen_file_boost.so</li><li>)</li></ol></pre></div></div>       <p></p></li>      <li><span>注册文件预加载回调，注册后系统在条件符合时调用回调向应用推荐文件。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>OpenFileBoost_ErrCode ret = <span class="hljs-built_in">HMS_OpenFileBoost_RegisterFilePreload</span>(AppQueryAppStateCb,</li><li>    AppOnFilePreload, AppCancelFilePreload);</li><li><span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS){</li><li>    <span class="hljs-comment">// 注册失败，用户可自定义错误处理</span></li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>应用应该在当前回调上下文中同步解析预加载文件, 或同步阻塞等待解析完毕后再返回，以便系统可以评估本次预加载文件的资源消耗.。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 查询应用当前状态的回调函数，系统在向应用推荐文件前会先调用状态查询回调函数向应用查询当前是否适合推荐</span></li><li><span class="hljs-function">OpenFileBoost_AppState <span class="hljs-title">AppQueryAppStateCb</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 如果当前状态允许进行文件预加载则返回OPEN_FILE_BOOST_APP_STATE_ALLOW_PRELOAD，这里的CanPreload函数为代码示例，表示应用根据实际业务判断是否允许预加载</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CanPreload</span>()) {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_APP_STATE_ALLOW_PRELOAD;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_APP_STATE_REJECT_PRELOAD;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 文件预加载回调</span></li><li><span class="hljs-function">OpenFileBoost_CbErrCode <span class="hljs-title">AppOnFilePreload</span><span class="hljs-params">(<span class="hljs-type">void</span>* fileInfo)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int32_t</span> fileDescriptor = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 指针fileInfo仅在当前回调上下文有效，在回调中调用HMS_OpenFileBoost_GetFdFromPreloadFileInfo获取文件描述符</span></li><li>    OpenFileBoost_ErrCode ret = <span class="hljs-built_in">HMS_OpenFileBoost_GetFdFromPreloadFileInfo</span>(fileInfo, &amp;fileDescriptor);</li><li>    <span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_FAILURE;</li><li>    }</li><li>    <span class="hljs-type">char</span> sandboxPath[MAX_BUFFER_LENGTH] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-comment">// 指针fileInfo仅在当前回调上下文有效，在回调中调用HMS_OpenFileBoost_GetSandboxPathFromPreloadFileInfo获取文件路径</span></li><li>    ret = <span class="hljs-built_in">HMS_OpenFileBoost_GetSandboxPathFromPreloadFileInfo</span>(fileInfo, sandboxPath, MAX_BUFFER_LENGTH);</li><li>    <span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_FAILURE;</li><li>    }</li><li>    <span class="hljs-comment">// 用户可保存文件描述符和文件路径，方便后续通知取消预加载时对文件取消预加载</span></li><li>    <span class="hljs-comment">// 用户自定义具体的文件预加载逻辑</span></li><li>    <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_SUCCESS;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 取消预加载回调</span></li><li><span class="hljs-function">OpenFileBoost_CbErrCode <span class="hljs-title">AppCancelFilePreload</span><span class="hljs-params">(<span class="hljs-type">void</span>* fileInfo)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 同样的方法获取文件描述符和沙箱路径</span></li><li>    <span class="hljs-type">int32_t</span> fileDescriptor = <span class="hljs-number">0</span>;</li><li>    OpenFileBoost_ErrCode ret = <span class="hljs-built_in">HMS_OpenFileBoost_GetFdFromPreloadFileInfo</span>(fileInfo, &amp;fileDescriptor);</li><li>    <span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_FAILURE;</li><li>    }</li><li>    <span class="hljs-type">char</span> sandboxPath[MAX_BUFFER_LENGTH] = {<span class="hljs-number">0</span>};</li><li>    ret = <span class="hljs-built_in">HMS_OpenFileBoost_GetSandboxPathFromPreloadFileInfo</span>(fileInfo, sandboxPath, MAX_BUFFER_LENGTH);</li><li>    <span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_FAILURE;</li><li>    }</li><li>    <span class="hljs-comment">// 用户自定义具体的取消文件预加载逻辑</span></li><li>    <span class="hljs-keyword">return</span> OPEN_FILE_BOOST_CALLBACK_SUCCESS;</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>如果用户打开了已经预加载的文件，应用需要调用HMS_OpenFileBoost_NotifyPreloadHit通知系统，系统会更改文件的预加载状态。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 传入用户打开的已经预加载的文件描述符、文件路径和长度</span></li><li>OpenFileBoost_ErrCode ret = <span class="hljs-built_in">HMS_OpenFileBoost_NotifyPreloadHit</span>(fileDescriptor, sandboxPath, pathLen);</li><li><span class="hljs-keyword">if</span> (ret != OPEN_FILE_BOOST_SUCCESS){</li><li>    <span class="hljs-comment">// 通知失败，用户可自定义错误处理</span></li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>应用不想再收到回调，或者在退出流程中时，调用取消预加载接口。</span>       <p></p>       <div _ngcontent-bji-c106="" class="highlight-div"><div _ngcontent-bji-c106="" class="highlight-div-header"><div _ngcontent-bji-c106="" class="highlight-div-header-left"><div _ngcontent-bji-c106="" class="handle-button expand-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bji-c106="" class="highlight-div-header-right"><div _ngcontent-bji-c106="" class="handle-button ai-button"></div><div _ngcontent-bji-c106="" class="handle-button line-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bji-c106="" class="handle-button theme-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bji-c106="" class="handle-button copy-button"><div _ngcontent-bji-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bji-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">OpenFileBoost</span>_ErrCode ret = <span class=""><span class="hljs-title function_">HMS_OpenFileBoost_UnregisterFilePreload</span></span>();</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-variable constant_">OPEN_FILE_BOOST_SUCCESS</span>){</li><li>    <span class="hljs-comment">// 取消注册失败，用户可自定义错误处理</span></li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>