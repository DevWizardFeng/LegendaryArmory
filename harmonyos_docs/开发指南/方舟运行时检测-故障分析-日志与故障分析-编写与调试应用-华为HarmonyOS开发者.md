<h1 _ngcontent-oqw-c119="" class="doc-title ng-star-inserted" title="方舟运行时检测"> 方舟运行时检测 </h1>

<div _ngcontent-oqw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001919872114"><div class="tiledSection"><h2 id="section194401404228">方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section194401404228" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510174543__p631264114580">在JS运行时环境中，多线程的安全问题是一个重要的考虑因素。由于JavaScript主线程是单线程的，在主线程中创建的JS对象（尤其是DOM相关对象）只能在主线程上进行操作。如果违反了这一规则，就会导致多线程安全问题。以下是关于如何判断和处理这些问题的一些详细说明。</p> </div> <div class="tiledSection"><h3 id="section10509844182316" class="firsth2">原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section10509844182316" tips="复制节点链接"></i></h3><ul id="ZH-CN_TOPIC_0000002510174543__ul636519217248"><li id="li15365202142413">单线程执行<p id="ZH-CN_TOPIC_0000002510174543__p14365721243">JavaScript是单线程执行的语言，这意味着它一次只能在一个线程上执行代码。任何JavaScript对象都只能在创建它们的线程上进行操作。</p> </li><li id="li1365152122415">N-API（Node-API）接口<p id="ZH-CN_TOPIC_0000002510174543__p173651822249">N-API接口直接涉及到JavaScript对象的操作。绝大多数N-API接口（约95%）只能在创建这些对象的JavaScript线程上调用。</p> </li></ul> <ul id="ZH-CN_TOPIC_0000002510174543__ul136514292411"><li id="li1736542112411">多线程检测机制<p id="ZH-CN_TOPIC_0000002510174543__p1336592202416">多线程检测机制会检测当前线程和正在使用的JS虚拟机环境（vm/env）中的JS线程ID是否一致。如果不一致，就表明虚拟机环境被跨线程使用，存在多线程安全问题。</p> </li></ul> </div> <div class="tiledSection"><h3 id="section1424719158246">常见多线程安全问题<i class="anchor-icon anchor-icon-link" anchorid="section1424719158246" tips="复制节点链接"></i></h3><ul id="ZH-CN_TOPIC_0000002510174543__ul1069623232415"><li id="li1469643218245">非JS线程使用N-API接口<p id="ZH-CN_TOPIC_0000002510174543__p369611327241">非JavaScript线程尝试调用N-API接口，可能会导致未定义的行为或崩溃。</p> </li></ul> <ul id="ZH-CN_TOPIC_0000002510174543__ul196961432102412"><li id="li1869633210247">N-API接口使用其他线程的env<p id="ZH-CN_TOPIC_0000002510174543__p176979322245">一个线程尝试使用另一个线程创建的env（JavaScript环境），这也会导致多线程安全问题。</p> <p id="ZH-CN_TOPIC_0000002510174543__p1069743292419"></p> </li></ul> <p id="ZH-CN_TOPIC_0000002510174543__p491345612245"><strong>如何判断是否发生了多线程安全问题</strong></p> <div class="p" id="ZH-CN_TOPIC_0000002510174543__p691312564249">如果在运行时遇到以下致命错误信息，这意味着已经发生了多线程安全问题：<div _ngcontent-oqw-c106="" class="highlight-div"><div _ngcontent-oqw-c106="" class="highlight-div-header"><div _ngcontent-oqw-c106="" class="highlight-div-header-left"><div _ngcontent-oqw-c106="" class="handle-button expand-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oqw-c106="" class="highlight-div-header-right"><div _ngcontent-oqw-c106="" class="handle-button ai-button"></div><div _ngcontent-oqw-c106="" class="handle-button line-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oqw-c106="" class="handle-button theme-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oqw-c106="" class="handle-button copy-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oqw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002510174543__screen2913165612419" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Fatal</span>: <span class="hljs-title class_">ecma_vm</span> <span class="hljs-title class_">cannot</span> <span class="hljs-title class_">run</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">multi</span>-<span class="hljs-title class_">thread</span>! <span class="hljs-title class_">thread</span>:<span class="hljs-number">3096</span> <span class="hljs-title class_">currentThread</span>:<span class="hljs-number">3550</span></li></ol></pre></div></div> </div> <p id="ZH-CN_TOPIC_0000002510174543__p991315622411">其中，thread:3096 表示创建并拥有这个JavaScript环境的线程ID。currentThread:3550 表示当前正在尝试操作这个JavaScript环境的线程ID。</p> <p id="ZH-CN_TOPIC_0000002510174543__p491318564246">当前线程号为3550，而使用的JavaScript线程是由3096线程创建的，这表明虚拟机环境（vm/env）被跨线程使用，从而导致了多线程安全问题。</p> </div> <div class="tiledSection"><h3 id="section19920336172519">使能方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section19920336172519" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002510174543__p1462311433259">可通过以下两种方式使能方舟多线程检测。</p> <ul id="ZH-CN_TOPIC_0000002510174543__ul16443185010269"><li id="li1695915617277"><strong>方式一</strong><p id="ZH-CN_TOPIC_0000002510174543__p188890992715">点击<strong>Run &gt; Edit Configurations &gt;</strong> <strong>Diagnostics</strong>，勾选<strong>Multi Thread Check</strong>。</p> <p id="ZH-CN_TOPIC_0000002510174543__p84441535192011"><span><img originheight="289" originwidth="705" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104844.61083683893204217046410592307311:50001231000000:2800:920E7F84ED5A5DC4F4188896F5617B04268FFE4DCAE427C05A5725CA3DC6B3F1.png" width="705" height="289"></span></p> </li></ul> <ul id="ZH-CN_TOPIC_0000002510174543__ul13438185242615"><li id="li1638071717274"><strong>方式二</strong><p id="ZH-CN_TOPIC_0000002510174543__p45451718112710">通过命令行开启。</p> <div _ngcontent-oqw-c106="" class="highlight-div"><div _ngcontent-oqw-c106="" class="highlight-div-header"><div _ngcontent-oqw-c106="" class="highlight-div-header-left"><div _ngcontent-oqw-c106="" class="handle-button expand-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oqw-c106="" class="highlight-div-header-right"><div _ngcontent-oqw-c106="" class="handle-button ai-button"></div><div _ngcontent-oqw-c106="" class="handle-button line-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oqw-c106="" class="handle-button theme-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oqw-c106="" class="handle-button copy-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oqw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" id="ZH-CN_TOPIC_0000002510174543__screen20987812611" data-highlighted="yes"><ol class="linenums"><li>aa start -<span class="hljs-selector-tag">a</span> {abilityName} -<span class="hljs-selector-tag">b</span> {bundleName} -R</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section5652133862715">启用方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section5652133862715" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002510174543__ol941711551271"><li id="li144171955152711"><span>运行或调试当前应用。</span></li><li id="li1441725518274"><span>当程序出现多线程安全问题时，会弹出Crash log信息，点击信息中的链接即可跳转至引起多线程安全问题的代码处。关于多线程安全问题的分析方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-about-crash" target="_blank">使用Node-API接口产生的异常日志/崩溃分析</a>。</span><p></p><p id="ZH-CN_TOPIC_0000002510174543__p541795542717"><span><img originheight="407" originwidth="1451" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104845.18547672949956894578070228578442:50001231000000:2800:C62A3E31D7FBC7B5F40A7D69A7BCEB52F021A7241F9D208A5EEB4484716B61F2.png" width="920" height="258.0565127498277"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section1615914212317">方舟native模块加载异常信息增强<i class="anchor-icon anchor-icon-link" anchorid="section1615914212317" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510174543__p1963812249173">在进行ArkTs项目开发中可能存在需要加载native模块的场景，开启方舟native模块加载异常信息增强功能后，可以丰富ArkTs项目中因加载native模块导致的报错信息，以便更准确地进行native问题定位。</p> </div> <div class="tiledSection"><h3 id="section12424161546" class="firsth2">使能方舟native模块加载异常信息增强<i class="anchor-icon anchor-icon-link" anchorid="section12424161546" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002510174543__p181029308416">可以通过以下两种方式使能方舟native模块加载异常信息增强。</p> <ul id="ZH-CN_TOPIC_0000002510174543__ul1428551052"><li id="li2185412552">方式一<p id="ZH-CN_TOPIC_0000002510174543__p1362191315513">点击<strong>Run &gt; Edit Configurations &gt;</strong> <strong>Diagnostics</strong>，勾选<strong>Enhanced Error Info</strong>。</p> <p id="ZH-CN_TOPIC_0000002510174543__p37344251252"><span><img originheight="290" originwidth="704" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104845.77553573699149902210428784432248:50001231000000:2800:4A722E2750058B9D80E797814470677BBBFA99D664DA8B2A1C64AE5A33E7C662.png" width="704" height="290"></span></p> </li></ul> <ul id="ZH-CN_TOPIC_0000002510174543__ul71468471758"><li id="li148113525513">方式二<p id="ZH-CN_TOPIC_0000002510174543__p01293541051">通过命令行开启。</p> <div _ngcontent-oqw-c106="" class="highlight-div"><div _ngcontent-oqw-c106="" class="highlight-div-header"><div _ngcontent-oqw-c106="" class="highlight-div-header-left"><div _ngcontent-oqw-c106="" class="handle-button expand-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oqw-c106="" class="highlight-div-header-right"><div _ngcontent-oqw-c106="" class="handle-button ai-button"></div><div _ngcontent-oqw-c106="" class="handle-button line-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oqw-c106="" class="handle-button theme-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oqw-c106="" class="handle-button copy-button"><div _ngcontent-oqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oqw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-wasm" id="ZH-CN_TOPIC_0000002510174543__screen168651055182918" data-highlighted="yes"><ol class="linenums"><li>aa <span class="hljs-keyword">start</span> {abilityName} {bundleName} -E</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section7699389151">启用方舟native模块加载异常信息增强<i class="anchor-icon anchor-icon-link" anchorid="section7699389151" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002510174543__ol5832182114343"><li id="li183212215345">运行或调试当前应用。</li><li id="li16743530173417">当程序出现因native模块加载导致的报错信息时，会显示更详细准确的错误信息。</li></ol> <p id="ZH-CN_TOPIC_0000002510174543__p9174145872711"><span><img originheight="351" originwidth="1123" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104845.47717788769525701655020375895209:50001231000000:2800:873EC26C784141F0356461DA4302134932081F26B7FAEAAAD59793381A6C6DA2.png" width="920" height="287.5512021371327"></span></p> </div> </div> <div></div></div>