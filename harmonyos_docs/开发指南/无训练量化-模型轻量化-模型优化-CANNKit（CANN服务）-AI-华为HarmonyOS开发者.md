<h1 _ngcontent-bjt-c119="" class="doc-title ng-star-inserted" title="无训练量化"> 无训练量化 </h1>

<div _ngcontent-bjt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section162056391291">输入准备<i class="anchor-icon anchor-icon-link" anchorid="section162056391291" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section3589155618913" class="firsth2">准备模型<i class="anchor-icon anchor-icon-link" anchorid="section3589155618913" tips="复制节点链接"></i></h3><ul><li>TensorFlow开发者<p>开发者需提供需要量化的pb模型。</p> </li><li>PyTorch开发者<p>开发者需提供需要量化的模型定义py文件以及模型参数pth文件。</p> </li><li>ONNX开发者<p>开发者需提供需要量化的ONNX模型。</p> </li></ul> </div> <div class="tiledSection"><h3 id="section447042511104">准备校准集<i class="anchor-icon anchor-icon-link" anchorid="section447042511104" tips="复制节点链接"></i></h3><p>开发者需提供bin格式或图片格式的校准集。bin格式的输入数据需按照以下方式存储，如<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#table1397054115616">任意维度二进制校准集说明</a>。图片格式的数据为存放测试图片的文件夹，图片格式的输入默认以BGR的三通道彩图读取，读出的数据格式为NCHW，其中N为提供图片的数量。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>轻量化工具支持的图片格式包括 ".bmp"，".dib"，".jpeg"，".jpg"，".jpe"，".png"，".webp"，".pbm"，".pgm"，".ppm"，".tiff"，".tif"，".BMP"，".DIB"，".JPEG"，".JPG"，".JPE"，".PNG"，".WEBP"，".PBM"，".PGM"，".PPM"，".TIFF"，".TIF"。</p> </div></div></div> <p>bin格式的输入数据支持两种定义方式，分别适用于任意维度的输入数据和4维的输入数据（推荐开发者使用任意维度的定义方式）。</p> <p>对于任意维度的输入数据，bin文件需按照以下方式定义，以维度（50, 100, 300）的3维数据为例，读出的数据形状为（50, 100, 300）。</p>  <div class="tablenoborder"><div class="tbBox"><table id="table1397054115616" class="layoutFixed idpTab"><caption><b>表1 </b>任意维度二进制校准集说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.6.2.6.1.1" valign="top" width="16.31%"><p><strong>文件头/数据</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.6.2.6.1.2" valign="top" width="16.470000000000002%"><p><strong>地址偏移</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.6.2.6.1.3" valign="top" width="16.64%"><p><strong>Type</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.6.2.6.1.4" valign="top" width="15.61%"><p><strong>Value</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.6.2.6.1.5" valign="top" width="34.97%"><p><strong>Description</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="5" valign="top" width="16.31%"><p>文件头（共20字节）</p> </td> <td class="cellrowborder" valign="top" width="16.470000000000002%"><p>0000</p> </td> <td class="cellrowborder" valign="top" width="16.64%"><p>32bit int</p> </td> <td class="cellrowborder" valign="top" width="15.61%"><p>610</p> </td> <td class="cellrowborder" valign="top" width="34.97%"><p>Magic number</p> <p>当magic number = 610，用来校验文件的合法性。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0004</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>3</p> </td> <td class="cellrowborder" valign="top"><p>Input data rank</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0008</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>50</p> </td> <td class="cellrowborder" valign="top"><p>Input dimension 1</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0012</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>100</p> </td> <td class="cellrowborder" valign="top"><p>Input dimension 2</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0016</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>300</p> </td> <td class="cellrowborder" valign="top"><p>Input dimension 3</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.31%"><p>数据</p> </td> <td class="cellrowborder" valign="top" width="16.470000000000002%"><p>…</p> </td> <td class="cellrowborder" valign="top" width="16.64%"><p>Float32</p> </td> <td class="cellrowborder" valign="top" width="15.61%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="34.97%"><p>数据数量等于50*100*300</p> </td> </tr>  </tbody></table></div> </div> <p>对于4维的输入数据，bin文件可以按照<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#table1397054115616">任意维度二进制校准集说明</a>定义，也可以按照<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#table1960771718465">4维二进制校准集说明</a>， 以维度（50, 3, 28, 28）的4维数据为例，读出的数据形状为（50, 3, 28, 28）。</p>  <div class="tablenoborder"><div class="tbBox"><table id="table1960771718465" class="layoutFixed idpTab"><caption><b>表2 </b>4维二进制校准集说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.8.2.6.1.1" valign="top" width="15.528447155284471%"><p><strong>文件头</strong><strong>/数据</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.8.2.6.1.2" valign="top" width="17.028297170282972%"><p><strong>地址偏移</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.8.2.6.1.3" valign="top" width="16.67833216678332%"><p><strong>Type</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.8.2.6.1.4" valign="top" width="16.068393160683932%"><p><strong>Value</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.8.2.6.1.5" valign="top" width="34.696530346965304%"><p><strong>Description</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="5" valign="top" width="15.528447155284471%"><p>文件头（共20字节）</p> </td> <td class="cellrowborder" valign="top" width="17.028297170282972%"><p>0000</p> </td> <td class="cellrowborder" valign="top" width="16.67833216678332%"><p>32bit int</p> </td> <td class="cellrowborder" valign="top" width="16.068393160683932%"><p>510</p> </td> <td class="cellrowborder" valign="top" width="34.696530346965304%"><p>Magic number</p> <p>当magic number = 510，用来校验文件的合法性</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0004</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>50</p> </td> <td class="cellrowborder" valign="top"><p>Input num</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0008</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>3</p> </td> <td class="cellrowborder" valign="top"><p>Input channels</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0012</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>28</p> </td> <td class="cellrowborder" valign="top"><p>Input height</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>0016</p> </td> <td class="cellrowborder" valign="top"><p>32bit int</p> </td> <td class="cellrowborder" valign="top"><p>28</p> </td> <td class="cellrowborder" valign="top"><p>Input width</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.528447155284471%"><p>数据</p> </td> <td class="cellrowborder" valign="top" width="17.028297170282972%"><p>…</p> </td> <td class="cellrowborder" valign="top" width="16.67833216678332%"><p>Float32</p> </td> <td class="cellrowborder" valign="top" width="16.068393160683932%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="34.696530346965304%"><p>数据数量等于50*3*28*28</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>轻量化工具已提供脚本支撑bin格式文件的转换，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-preparations#section152959341125">Tools下载</a>的tools_dopt/dopt_tf_py3/demo/quant8-8/notrain/bin_data_preprocessing.py。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section2065711363111">填写config.prototxt文件<i class="anchor-icon anchor-icon-link" anchorid="section2065711363111" tips="复制节点链接"></i></h3><p>config.prototxt参数说明如下表所示。其中BINARY模式不进行预处理，IMAGE模式根据开发者给出的均值方差进行预处理。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.1" valign="top" width="19.011901190119012%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.2" valign="top" width="56.28562856285628%"><p>参数描述</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.4.1.3" valign="top" width="24.702470247024706%"><p>是否必填</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="19.011901190119012%"><p>strategy</p> </td> <td class="cellrowborder" valign="top" width="56.28562856285628%"><p>优化策略，当前对所有框架都只支持Quant_INT8-8。</p> </td> <td class="cellrowborder" valign="top" width="24.702470247024706%"><p>否，默认策略为Quant_INT8-8</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.011901190119012%"><p>device</p> </td> <td class="cellrowborder" valign="top" width="56.28562856285628%"><p>使用GPU还是CPU进行量化。</p> <ul><li>USE_GPU：GPU模式</li><li>USE_CPU：CPU模式</li></ul> </td> <td class="cellrowborder" valign="top" width="24.702470247024706%"><p>否，默认CPU模式</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.011901190119012%"><p>exclude_op</p> </td> <td class="cellrowborder" valign="top" width="56.28562856285628%"><p>支持两种方式。</p> <ul><li>使用一个exclude_op，exclude_op包含多个op_name，用分号隔开。</li><li>使用多个exclude_op，每个exclude_op包含一个op_name 。</li></ul> <p>两种方式可混合使用，当所给op_name不在模型内时，会报错。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>ONNX的exclude_op应该为weight name。</p> </div></div></div> </td> <td class="cellrowborder" valign="top" width="24.702470247024706%"><p>否</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="19.011901190119012%"><p>preprocess_parameter</p> </td> <td class="cellrowborder" valign="top" width="56.28562856285628%"><p>校准数据配置文件路径。</p> </td> <td class="cellrowborder" valign="top" width="24.702470247024706%"><p>是</p> </td> </tr>  </tbody></table></div> </div> <p>preprocess_parameter包含的子参数说明如下表所示，对于模型有多输入的情况，每一个输入都需要配置一份preprocess_parameter。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.5.1.4.1.1" valign="top" width="18.05%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.5.1.4.1.2" valign="top" width="57.19%"><p>参数描述</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.5.1.4.1.3" valign="top" width="24.759999999999998%"><p>是否必填</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18.05%"><p>input_type</p> </td> <td class="cellrowborder" valign="top" width="57.19%"><p>使用二进制文件输入还是图片格式输入。</p> <ul><li>BINARY：使用二进制输入</li><li>IMAGE：使用图片格式输入</li></ul> </td> <td class="cellrowborder" valign="top" width="24.759999999999998%"><p>否，默认IMAGE格式</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.05%"><p>image_format</p> </td> <td class="cellrowborder" valign="top" width="57.19%"><p>图片格式，仅在<span class="parmvalue">“IMAGE”</span>模式下生效。</p> <ul><li>BGR：使用BGR图片格式输入</li><li>RGB：使用RGB图片格式输入</li></ul> </td> <td class="cellrowborder" valign="top" width="24.759999999999998%"><p>否，默认采用BGR</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.05%"><p>mean_value</p> </td> <td class="cellrowborder" valign="top" width="57.19%"><p>图片预处理的均值参数，仅<span class="parmvalue">“IMAGE”</span>模式下生效。</p> <p>类型为float的数值，范围为0.0-255.0。</p> <p>mean_value个数必须和输入的C维度相等。</p> </td> <td class="cellrowborder" valign="top" width="24.759999999999998%"><p>否，默认输入C维度为0.0</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.05%"><p>standard_deviation</p> </td> <td class="cellrowborder" valign="top" width="57.19%"><p>图片预处理使用的标准差，仅<span class="parmvalue">“IMAGE”</span>模式下生效。</p> <p>类型为float的数值，需要&gt;=0.0。</p> </td> <td class="cellrowborder" valign="top" width="24.759999999999998%"><p>否，默认为0.0</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.05%"><p>input_file_path</p> </td> <td class="cellrowborder" valign="top" width="57.19%"><p>输入校准集的绝对路径，bin文件路径或存有图片的文件夹。</p> <p>例如：<span class="filepath">“/path/to/user/data”</span>。</p> </td> <td class="cellrowborder" valign="top" width="24.759999999999998%"><p>是</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>当使用<span class="parmvalue">“IMAGE”</span>模式输入时，工具链会对图片做如下处理：image = (image - mean_value) / standard_deviation。</li><li>当使用<span class="parmvalue">“BINARY”</span>模式时，工具链不会对输入数据做任何处理，即image_format、mean_value、standard_deviation三个参数无效。</li></ul> </div></div></div> <p>配置文件的配置示例如下所示。</p> <ul><li>BINARY模式输入<div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>strategy: <span class="hljs-string">"Quant_INT8-8"</span></li><li>device: USE_GPU</li><li>// 多输入场景提供不同的<span class="hljs-built_in">bin</span>文件</li><li>preprocess_parameter:</li><li>{  </li><li>    input_type: BINARY</li><li>    input_file_path: <span class="hljs-string">"path/to/user/bin/caffe_inception_calibrationset1.bin"</span></li><li>}</li><li>preprocess_parameter:</li><li>{  </li><li>    input_type: BINARY</li><li>    input_file_path: <span class="hljs-string">"path/to/user/bin/caffe_inception_calibrationset2.bin"</span></li><li>}</li><li>// ...</li><li>exclude_op:  <span class="hljs-string">"conv1"</span></li><li>exclude_op:  <span class="hljs-string">"conv2;conv3"</span></li></ol></pre></div></div> </li></ul> <ul><li>IMAGE模式输入<div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li>strategy: <span class="hljs-string">"Quant_INT8-8"</span></li><li>device: USE_GPU</li><li>// 多输入场景提供不同的图片路径</li><li>preprocess_parameter:</li><li>{</li><li>    input_type: IMAGE</li><li>    image_format: BGR</li><li>    mean_value: <span class="hljs-number">104.0</span></li><li>    mean_value: <span class="hljs-number">113.0</span></li><li>    mean_value: <span class="hljs-number">123.0</span></li><li>    standard_deviation: <span class="hljs-number">0.5</span></li><li>    input_file_path: <span class="hljs-string">"path/to/user/images1/"</span></li><li>}</li><li>preprocess_parameter:</li><li>{</li><li>    input_type: IMAGE</li><li>    image_format: BGR</li><li>    mean_value: <span class="hljs-number">104.0</span></li><li>    mean_value: <span class="hljs-number">113.0</span></li><li>    mean_value: <span class="hljs-number">123.0</span></li><li>    standard_deviation: <span class="hljs-number">0.5</span></li><li>    input_file_path: <span class="hljs-string">"path/to/user/images2/"</span></li><li>}</li><li>// ...</li><li>exclude_op:  <span class="hljs-string">"conv1"</span></li><li>exclude_op:  <span class="hljs-string">"conv2;conv3"</span></li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section293645783311">TensorFlow模型无训练量化<i class="anchor-icon anchor-icon-link" anchorid="section293645783311" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section025882820347" class="firsth2">环境准备<i class="anchor-icon anchor-icon-link" anchorid="section025882820347" tips="复制节点链接"></i></h3><p>该功能支持TensorFlow 2.8 CPU或GPU版本。如没有该版本环境，需要自行安装；如已有，则不需要配置环境。</p> <p>TensorFlow2.8安装方法如下:</p> <div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install tensorflow-gpu==2.8</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section977955263419">模型量化<i class="anchor-icon anchor-icon-link" anchorid="section977955263419" tips="复制节点链接"></i></h3><p>运行<span class="filepath">“python3 tools_dopt/dopt_tf_py3/dopt_so.py”</span>。请在python3环境下运行该命令。</p> <p>运行该脚本对TensorFlow模型进行无训练量化的参数如下所示。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>路径：支持大小写字母、数字、下划线。</li><li>文件名：支持大小写字母、数字、下划线和点(.)。</li></ul> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.5.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.5.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.5.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>-m, --mode</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>运行模式。</p> <ul><li>0：无训练模式。（当前只支持0）</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--framework</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>深度学习框架类型。</p> <ul><li>3：TensorFlow</li><li>5：PyTorch或ONNX</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--model</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>原始模型文件路径，支持pb模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--cal_conf</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>校准方式量化配置文件路径。</p> <p>量化配置文件说明请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#section2065711363111">填写config.prototxt文件</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--output</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>存放量化完成后的模型文件绝对路径，例如<span class="filepath">“/path/to/out/resnet18.pb”</span>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--input_format</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>输入格式数据， NHWC或NCHW。</p> <p>当开发者选择IMAGE格式或文件头为510的bin文件作为输入数据，并选择输入格式数据为NHWC时，工具会自动调整通道顺序；当选择文件头为610的bin文件作为输入数据时不会调整通道顺序。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--input_shape</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>输入数据的shape。</p> <p>例如：“input_name1: n1, c1，h1, w1; input_name2: n2, c2, h2,w2”。input_name必须是转换前的网络模型中的节点名称。多输入input_shape之间由';'进行分割。input_shape中指定各维度输入数据值需与网络模型中指定的输入节点所需形状保持一致。例如：假设转换前网络模型指定输入节点为input_shape_network: none, 224, 224, 3; input_shape第2、3、4维度输入数值必须为224,224,3，否则尺寸不匹配。假设转换前网络模型指定输入节点为input_shape_network: 1, 224, 224, 3；则input_shape各维度输入数据均不可变。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--out_nodes</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>指定输出节点。</p> <p>例如：“node_name1; node_name2; node_name3”。node_name必须是模型转换前的网络模型中的节点名称。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--compress_conf</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>模型文件转为二进制格式文件的路径。</p> <p>例如：“param_file”。该文件为轻量化配置，在使用OMG离线模型转换时将被作为参数compress_conf的输入。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--device_idx</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>GPU或CPU的设备号，默认为0。</p> </td> </tr>  </tbody></table></div> </div> <p>运行量化脚本后，会输出开发者--output传入同名的pb，以及--compress_conf传入同名的量化配置文件。例如：开发者--output输入quantmodel.pb，--compress_conf输入param，最终会输出quantmodel.pb和param。</p> </div> <div class="tiledSection"><h2 id="section18483131873820">PyTorch模型无训练量化<i class="anchor-icon anchor-icon-link" anchorid="section18483131873820" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section8715155563919" class="firsth2">环境准备<i class="anchor-icon anchor-icon-link" anchorid="section8715155563919" tips="复制节点链接"></i></h3><p>该功能现仅支持PyTorch1.11版本。使用如下命令安装依赖：</p> <div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install torch==1.11</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section793161024016">模型量化<i class="anchor-icon anchor-icon-link" anchorid="section793161024016" tips="复制节点链接"></i></h3><p>运行<span class="filepath">“python3 tools_dopt/dopt_pytorch_py3/dopt_so.py”</span>。运行该脚本对PyTorch模型进行无训练量化的参数如下所示。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>路径：支持大小写字母、数字、下划线。</p> <p>文件名：支持大小写字母、数字、下划线和点(.)。</p> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.4.1.4.1.1" valign="top" width="18.12181218121812%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.4.1.4.1.2" valign="top" width="19.7019701970197%"><p>是否必填</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.4.1.4.1.3" valign="top" width="62.17621762176218%"><p>参数描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>-m, --mode</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>运行模式。</p> <ul><li>0：无训练模式。（当前只支持0）</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--framework</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>深度学习框架类型。</p> <ul><li>3：TensorFlow</li><li>5：PyTorch或ONNX</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--model</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>PyTorch模型定义文件路径。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--weight</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>PyTorch模型参数pth文件路径。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--cal_conf</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>校准方式量化配置文件路径。</p> <p>量化配置文件说明请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#section2065711363111">填写config.prototxt文件</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--output</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>存放量化完成后的模型文件绝对路径，例如<span class="filepath">“/path_to_out/resnet.pt”</span>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--input_shape</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>输入数据的shape。例如：“input_name1: n1, c1, h1, w1; input_name2: n2, c2, h2, w2”。input_name是模型定义中，forward()函数的入参名称。input_shape中指定的各输入数据的维度信息，用于转换PyTorch模型，需与实际模型的输入节点形状保持一致。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--compress_conf</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>模型文件转为二进制格式文件的路径。</p> <p>例如：“param_file”。该文件为轻量化配置，在使用OMG离线模型转换时将被作为参数compress_conf的输入。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--device_idx</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>GPU或CPU的设备号，默认为0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--input_format</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>PyTorch框架无需配置该参数</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>输入格式数据，NHWC或NCHW。</p> <p>当开发者选择IMAGE格式或文件头为510的bin文件作为输入数据，并选择输入格式数据为NHWC时，工具会自动调整通道顺序；当选择文件头为610的bin文件作为输入数据时不会调整通道顺序。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.12181218121812%"><p>--out_nodes</p> </td> <td class="cellrowborder" valign="top" width="19.7019701970197%"><p>PyTorch框架无需配置该参数</p> </td> <td class="cellrowborder" valign="top" width="62.17621762176218%"><p>指定输出节点。</p> <p>例如：“node_name1; node_name2; node_name3”。node_name必须是模型转换前的网络模型中的节点名称。</p> </td> </tr>  </tbody></table></div> </div> <p>运行量化脚本后，会输出开发者--output传入同名的pt，以及--compress_conf传入同名的量化配置文件。例如：开发者--output输入quantmodel.pt，--compress_conf输入param，最终会输出quantmodel.pt和param。</p> </div> <div class="tiledSection"><h2 id="section1262217244312">ONNX模型无训练量化<i class="anchor-icon anchor-icon-link" anchorid="section1262217244312" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2399333123120" class="firsth2">环境准备<i class="anchor-icon anchor-icon-link" anchorid="section2399333123120" tips="复制节点链接"></i></h3><p>该功能支持ONNX Runtime 1.15 CPU版本和ONNX环境。如没有该版本环境，需要自行安装；如已有，则不需要配置环境。</p> <p>ONNX安装方法如下:</p> <div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install onnx==1.14</li></ol></pre></div></div> <p>其他依赖：</p> <div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install protobuf==3.20.0</li></ol></pre></div></div> <p>ONNX Runtime CPU版本安装方法如下:</p> <div _ngcontent-bjt-c106="" class="highlight-div"><div _ngcontent-bjt-c106="" class="highlight-div-header"><div _ngcontent-bjt-c106="" class="highlight-div-header-left"><div _ngcontent-bjt-c106="" class="handle-button expand-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bjt-c106="" class="highlight-div-header-right"><div _ngcontent-bjt-c106="" class="handle-button ai-button"></div><div _ngcontent-bjt-c106="" class="handle-button line-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bjt-c106="" class="handle-button theme-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bjt-c106="" class="handle-button copy-button"><div _ngcontent-bjt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bjt-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install onnxruntime==1.15</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section1639913353120">模型量化<i class="anchor-icon anchor-icon-link" anchorid="section1639913353120" tips="复制节点链接"></i></h3><p>运行<span class="filepath">“python3 tools_dopt/dopt_onnx_py3/dopt_so.py”</span>。请在python3环境下运行该命令。</p> <p>运行该脚本对ONNX模型进行无训练量化的参数如下所示。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>路径：支持大小写字母、数字、下划线。</li><li>文件名：支持大小写字母、数字、下划线和点(.)。</li></ul> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.13.5.1.4.1.1" valign="top" width="17.740000000000002%"><p><strong>参数名称</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.5.1.4.1.2" valign="top" width="18.7%"><p><strong>是否必填</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.5.1.4.1.3" valign="top" width="63.56%"><p><strong>参数描述</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>-m, --mode</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>运行模式。</p> <ul><li>0：无训练模式。（当前只支持0）</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--framework</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>深度学习框架类型。</p> <ul><li>3：TensorFlow</li><li>5：PyTorch或ONNX</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--weight</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>ONNX框架无需配置该参数</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>权值文件路径。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--model</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>原始模型文件路径，支持ONNX模型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--cal_conf</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>校准方式量化配置文件路径。</p> <p>量化配置文件说明请参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-no-training-and-quantization#section2065711363111">填写config.prototxt文件</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--output</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>存放量化完成后的模型文件绝对路径，例如<span class="filepath">“/path_to_out/resnet.onnx”</span>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--input_format</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>输入格式数据， NHWC或NCHW。</p> <p>当开发者选择IMAGE格式或文件头为510的bin文件作为输入数据，并选择输入格式数据为NHWC时，工具会自动调整通道顺序；当选择文件头为610的bin文件作为输入数据时不会调整通道顺序。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--input_shape</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>输入数据的shape。</p> <p>例如：“input_name1: n1, c1，h1, w1; input_name2: n2, c2, h2,w2”。input_name必须是转换前的网络模型中的节点名称。多输入input_shape之间由';'进行分割。input_shape中指定各维度输入数据值需与网络模型中指定的输入节点所需形状保持一致。例如：假设转换前网络模型指定输入节点为input_shape_network: none, 224, 224, 3; input_shape第2、3、4维度输入数值必须为224,224,3，否则尺寸不匹配。假设转换前网络模型指定输入节点为input_shape_network: 1, 224, 224, 3；则input_shape各维度输入数据均不可变。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--out_nodes</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>指定输出节点。</p> <p>例如：“node_name1; node_name2; node_name3”。node_name必须是模型转换前的网络模型中的节点名称。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--compress_conf</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>模型文件转为二进制格式文件的路径。</p> <p>例如：“param_file”。该文件为轻量化配置，在使用OMG离线模型转换时将被作为参数compress_conf的输入。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="17.740000000000002%"><p>--device_idx</p> </td> <td class="cellrowborder" valign="top" width="18.7%"><p>ONNX框架无需配置该参数</p> </td> <td class="cellrowborder" valign="top" width="63.56%"><p>GPU或CPU的设备号，默认为0。</p> </td> </tr>  </tbody></table></div> </div> <p>运行量化脚本后，会输出开发者--output传入同名的ONNX，以及--compress_conf传入同名的量化配置文件。例如：开发者--output输入quantmodel.onnx，--compress_conf输入param，最终会输出quantmodel.onnx和param。</p> </div> </div> <div></div></div>