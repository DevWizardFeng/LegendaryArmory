<h1 _ngcontent-xeg-c119="" class="doc-title ng-star-inserted" title="服务器端开发"> 服务器端开发 </h1>

<div _ngcontent-xeg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section8815174119330">对密钥证明证书链进行校验<i class="anchor-icon anchor-icon-link" anchorid="section8815174119330" tips="复制节点链接"></i></h2><p>密钥证明证书链采用X509标准格式，证书链（证书数组）中的第一本证书为<strong>密钥证明证书</strong>，最后一本证书为根CA证书，中间的为子CA证书。</p> <p>应用服务器对密钥证明证书链的校验处理过程：</p> <ol><li>使用Universal Keystore Kit官网提供的根CA证书对证书链合法性进行校验。（<a href="https://pki.consumer.huawei.com/ca/cer/Huawei_CBG_ECC_Device_Attestation_Root_CA.cer" target="_blank">根CA证书下载地址</a>）<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>请勿在应用服务器中使用子CA证书对密钥证明证书链进行校验，子CA证书可能会因为有效期结束、证书被吊销等发生变化。</p> </div></div></div> </li><li>解析<strong>密钥证明证书</strong>获取应用公钥、挑战值Challenge、应用ID、密钥管理部件ID。<p>其中应用公钥直接从密钥证明证书的subjectPublicKeyInfo字段获取；</p> <p>其他字段从密钥证明证书的扩展域段（Extensions）中获取，扩展域段的OID为1.3.6.1.4.1.2011.2.376.1.3（密钥证明扩展域段）。</p> </li><li>校验挑战值Challenge是否有效。</li><li>校验应用ID是否与预期的取值一致。根据应用ID判断请求是否来自预期的HarmonyOS应用。</li><li>校验密钥来源是否与预期的取值一致。</li></ol> <p><strong>密钥证明证书格式说明：</strong></p> <p><span><img originheight="660" originwidth="470" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115102.49808293771285772205006177381026:50001231000000:2800:68748172E6AD5FC42066174DF3F4FC763909979887237B59C3C46DC36E9D0DF2.png" width="470" height="660"></span></p> <p><span><img height="474.86187" originheight="775" originwidth="1030" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115102.58586131604811559618375972768011:50001231000000:2800:30E1CA883CEF18C93606B490D167082CE519CD3D918349DF5B86D72F5BDBDEAF.png" title="点击放大" width="625.326765"></span></p> <p>密钥证明扩展域段为Asn.1 DER标准编码格式，数据结构定义如下：</p> <div _ngcontent-xeg-c106="" class="highlight-div"><div _ngcontent-xeg-c106="" class="highlight-div-header"><div _ngcontent-xeg-c106="" class="highlight-div-header-left"><div _ngcontent-xeg-c106="" class="handle-button expand-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xeg-c106="" class="highlight-div-header-right"><div _ngcontent-xeg-c106="" class="handle-button ai-button"></div><div _ngcontent-xeg-c106="" class="handle-button line-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xeg-c106="" class="handle-button theme-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xeg-c106="" class="handle-button copy-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xeg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-go" data-highlighted="yes"><ol class="linenums"><li>HuaweiAttestation ::= SEQUENCE {</li><li> version             AttestationVersion DEFAULT v1,</li><li> claim1             AttestationClaim,</li><li> claim2             AttestationClaim,</li><li> claim3             AttestationClaim,</li><li> ... ...</li><li>}</li><li>
</li><li>AttestationVersion ::= INTEGER { v1(<span class="hljs-number">0</span>) }</li><li>
</li><li>AttestationClaim ::= SEQUENCE {</li><li>   securityLevel       SecurityLevel,</li><li>   <span class="hljs-keyword">type</span>             AttestationType,</li><li>   value            AttestationValue</li><li>}</li><li>
</li><li>SecurityLevel ::= INTEGER</li><li>AttestationType ::= OBJECT IDENTIFIER</li><li>AttestationValue ::= ANY -- DEFINED BY AttestationType</li><li>
</li><li>ApplicationIDType ::= SEQUENCE {</li><li>   <span class="hljs-keyword">type</span>                         OBJECT IDENTIFIER,</li><li>   value                        OCT_STR</li><li>}</li></ol></pre></div></div> <p><strong>AttestationClaim类型取值说明：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.11.1.6.1.1" valign="top" width="20%"><p><strong>序号</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.11.1.6.1.2" valign="top" width="20%"><p>type（<strong>OID</strong>）取值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.11.1.6.1.3" valign="top" width="20%"><p>value的数据类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.11.1.6.1.4" valign="top" width="16.45%"><p>securityLevel</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.11.1.6.1.5" valign="top" width="23.549999999999997%"><p><strong>Claim说明</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20%"><p>1</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>1.3.6.1.4.1.2011.2.376.2.1.4</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>OCT_STR</p> </td> <td class="cellrowborder" valign="top" width="16.45%"><p>保留字段，暂不使用</p> </td> <td class="cellrowborder" valign="top" width="23.549999999999997%"><p>应用输入的挑战值Challenge。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20%"><p>2</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>1.3.6.1.4.1.2011.2.376.2.1.3</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>ApplicationIDType</p> </td> <td class="cellrowborder" valign="top" width="16.45%"><p>保留字段，暂不使用</p> </td> <td class="cellrowborder" valign="top" width="23.549999999999997%"><p>应用ID。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20%"><p>3</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>1.3.6.1.4.1.2011.2.376.2.2.2.6</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>OCT_STR</p> </td> <td class="cellrowborder" valign="top" width="16.45%"><p>保留字段，暂不使用</p> </td> <td class="cellrowborder" valign="top" width="23.549999999999997%"><p>密钥管理部件ID。取值固定为：0x28c4fb4944afec11b9090242ac120002</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20%"><p>4</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>1.3.6.1.4.1.2011.2.376.2.2.4.8</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>UTF8String</p> </td> <td class="cellrowborder" valign="top" width="16.45%"><p>2</p> </td> <td class="cellrowborder" valign="top" width="23.549999999999997%"><p>设备产品型号，从API 20开始支持。设备产品型号一般应用在设备风控场景，识别黑灰产设备的行为，请勿使用该字段对设备身份进行认证。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>securityLevel类型取值说明：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.13.1.3.1.1" valign="top" width="49.94%"><p><strong>securityLevel</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.13.1.3.1.2" valign="top" width="50.06%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="49.94%"><p>2</p> </td> <td class="cellrowborder" valign="top" width="50.06%"><p>REE（框架层），数据来源于HarmonyOS系统层。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="49.94%"><p>3</p> </td> <td class="cellrowborder" valign="top" width="50.06%"><p>TEE，数据通过TEE进行保护。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>ApplicationIDType类型取值说明：</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.15.1.3.1.1" valign="top" width="28.610000000000003%"><p>type（OID）取值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.15.1.3.1.2" valign="top" width="71.39%"><p>value取值说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="28.610000000000003%"><p>1.3.6.1.4.1.2011.2.376.2.1.3.1</p> </td> <td class="cellrowborder" valign="top" width="71.39%"><p>HarmonyOS Hap应用信息，包含如下字段：</p> <ol><li>appId：包含Hap应用的bundleName和签名证书公钥的hash；</li><li>bundleName：Hap应用的包名；</li><li>appIdentifier：AppGallery Connect网站上为Hap应用分配的统一APP ID字段，从API 20开始支持；</li><li>appMode：Hap应用的状态，取值：debug或release，从API 20开始支持。<div class="p">value为json字符串，样例如下：<div _ngcontent-xeg-c106="" class="highlight-div"><div _ngcontent-xeg-c106="" class="highlight-div-header"><div _ngcontent-xeg-c106="" class="highlight-div-header-left"><div _ngcontent-xeg-c106="" class="handle-button expand-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xeg-c106="" class="highlight-div-header-right"><div _ngcontent-xeg-c106="" class="handle-button ai-button"></div><div _ngcontent-xeg-c106="" class="handle-button line-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xeg-c106="" class="handle-button theme-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xeg-c106="" class="handle-button copy-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xeg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"appId"</span>:<span class="hljs-string">"com.example.attesthcts_BDmjsOezxRmguzlYRVhQavW22Eswi5sX61wOAysWPOGS8TZ5tY1u1A9EcvarzyrfOEj5zT8BCGkfFkVjn0m5wzo="</span>,  </li><li>  <span class="hljs-string">"bundleName"</span>:<span class="hljs-string">"com.example.attesthcts"</span>,</li><li>  <span class="hljs-string">"appIdentifier"</span>:<span class="hljs-string">"5765880207853009781"</span>,</li><li>  <span class="hljs-string">"appMode"</span>:<span class="hljs-string">"release"</span></li><li>}</li></ol></pre></div></div> </div> </li></ol> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.610000000000003%"><p>1.3.6.1.4.1.2011.2.376.2.1.3.2</p> </td> <td class="cellrowborder" valign="top" width="71.39%"><p>系统服务（Service Ability）的ID，样例：</p> <p>{processName: "huawei_share"}</p> </td> </tr>  </tbody></table></div> </div> <div class="p"><strong>样例代码：</strong><div _ngcontent-xeg-c106="" class="highlight-div"><div _ngcontent-xeg-c106="" class="highlight-div-header"><div _ngcontent-xeg-c106="" class="highlight-div-header-left"><div _ngcontent-xeg-c106="" class="handle-button expand-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xeg-c106="" class="highlight-div-header-right"><div _ngcontent-xeg-c106="" class="handle-button ai-button"></div><div _ngcontent-xeg-c106="" class="handle-button line-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xeg-c106="" class="handle-button theme-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xeg-c106="" class="handle-button copy-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xeg-c106="" class="highlight-scroll-div"><pre class="java prettyprint linenums hljs language-java" hw-language="java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> org.bouncycastle.asn1.*;</li><li><span class="hljs-keyword">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</li><li>
</li><li><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;</li><li><span class="hljs-keyword">import</span> java.io.FileOutputStream;</li><li><span class="hljs-keyword">import</span> java.security.PublicKey;</li><li><span class="hljs-keyword">import</span> java.security.Security;</li><li><span class="hljs-keyword">import</span> java.security.cert.CertPath;</li><li><span class="hljs-keyword">import</span> java.security.cert.CertPathValidator;</li><li><span class="hljs-keyword">import</span> java.security.cert.CertificateFactory;</li><li><span class="hljs-keyword">import</span> java.security.cert.PKIXCertPathValidatorResult;</li><li><span class="hljs-keyword">import</span> java.security.cert.PKIXParameters;</li><li><span class="hljs-keyword">import</span> java.security.cert.TrustAnchor;</li><li><span class="hljs-keyword">import</span> java.security.cert.X509Certificate;</li><li><span class="hljs-keyword">import</span> java.util.ArrayList;</li><li><span class="hljs-keyword">import</span> java.util.Date;</li><li><span class="hljs-keyword">import</span> java.util.HashSet;</li><li><span class="hljs-keyword">import</span> java.util.List;</li><li>
</li><li><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParseAttestation</span> {</li><li>    <span class="hljs-keyword">static</span> {</li><li>        Security.addProvider(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BouncyCastleProvider</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//HarmonyOS Hap应用通过anonAttestKeyItem接口获取到的 “密钥证明证书链”数据</span></li><li>    <span class="hljs-keyword">static</span> String[] g_attestCertStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"-----BEGIN CERTIFICATE-----\nMIIEUDCCA/WgAwIBAgIOCfv5Xf9hjA2u32gjpG8wCgYIKoZIzj0EAwIwXTE5MDcGA1UEAwwwSHVhd2VpIENCRyBFQ0MgRGV2aWNlIEFub255bW91cyBBdHRlc3RhdGlvbiBDQSAxMRMwEQYDVQQKDApIdWF3ZWkgQ0JHMQswCQYDVQQGEwJDTjAeFw0yNTA1MTMwNjI3NDlaFw0yNTA1MjAwNjI3NDlaMCwxKjAoBgNVBAMMIURldmljZSBDZXJ0aWZpY2F0ZSBNYW5hZ2VtZW50IEtleTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALd0wgFgvDF5uPq2hh69LdRHnIX3+mzdAzf10L9Jk6bWPZqqTvz88ZX7e12Su1Myf5iyT3TMKjZ+Y2SnsWpHG/7Dpx990u7/CxeeRY0qziIqMTEbrLFaSHY++///9SxmEiM7a3z2Ged2FzDSvOTj1JVmm2hk+bUcceTVuHAmRwidFIQrL5h/lxaO3uPFqbTdiW6ocz06pEbi8mg6LAafik1pfsO30a3yIGiH1f4uZhCEFjHQxQdSFsRPh04Ehclx6lQ196tO0d3RHR8dxL7ghGNxs9rB1Sq/0TH2mK1vKAY/YgvBs5nypOnDY+0MXN7j5NucvJ32wssGI7CbmMxVeZMCAwEAAaOCAf0wggH5MB0GA1UdDgQWBBQA6HLpfdJvtiqPqQXenry8b6qjYzAMBgNVHRMBAf8EAjAAMAkGA1UdOAQCBQAwHwYDVR0jBBgwFoAU4yzL/3aHOxL7QyI/P/sCBoHfJ6cwggGcBgwrBgEEAY9bAoJ4AQMEggGKMIIBhgIBADCB/AIBAgYNKwYBBAGPWwKCeAIBAzCB5wYOKwYBBAGPWwKCeAIBAwEEgdR7ImFwcElkIjoiY29tLmV4YW1wbGUubXlhcHBsaWNhdGlvbl9CS3BOWWR2UU0yYkNLYklwRERuWmdkdGNYdEtnZUg5M2FwVm1aOWdpcTFoeUt2elNzVVNFZTFsT3VsK3N2bXhZS2ltb0dNWnF0U0o3eGxpRkVZd2NRK0E9IiwiYnVuZGxlTmFtZSI6ImNvbS5leGFtcGxlLm15YXBwbGljYXRpb24iLCJhcHBJZGVudGlmaWVyIjoiMTU3MzU0NjgiLCJhcHBNb2RlIjoiZGVidWcifTAiAgEABg0rBgEEAY9bAoJ4AgEEBA5jaGFsbGVuZ2VfZGF0YTAYAgEDBg0rBgEEAY9bAoJ4AgEFBAQCAAAAMB0CAQIGDisGAQQBj1sCgngCAgQIDAhDTFMtQUwwMDAlAgEDBg4rBgEEAY9bAoJ4AgICBgQQKMT7SUSv7BG5CQJCrBIAAjAKBggqhkjOPQQDAgNJADBGAiEAko1y6sf7Fg48oWZC8FoP5WtmzKiVk5AOOvuhwaK0CQcCIQD8HymOzkzmOOjUuz/rdVrTM4191dpGr3jfU1u5rBpNIw==\n-----END CERTIFICATE-----"</span>, <span class="hljs-string">"-----BEGIN CERTIFICATE-----\nMIICyjCCAlCgAwIBAgIREj5jzbLehL8yzkDm5uwcSJUwCgYIKoZIzj0EAwMwSzETMBEGA1UEChMKSHVhd2VpIENCRzE0MDIGA1UEAxMrSHVhd2VpIENCRyBFQ0MgRGV2aWNlIEF0dGVzdGF0aW9uIFJvb3QgQ0EgMTAeFw0yMzEyMDUwMzE4MDRaFw0zMzEyMDUwMzE4MDRaMF0xOTA3BgNVBAMMMEh1YXdlaSBDQkcgRUNDIERldmljZSBBbm9ueW1vdXMgQXR0ZXN0YXRpb24gQ0EgMTETMBEGA1UECgwKSHVhd2VpIENCRzELMAkGA1UEBhMCQ04wWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAATYjeQrfijuZ/9HJPLlsfJ4/wnXbQXaxy5f5fEcMN+pTZ5RekpY7PnDp2zEdibvkSzjv1MuRs8JzORyGatSOrYFo4IBATCB/jAfBgNVHSMEGDAWgBTaRGLD5yvof1E6XEuPQ3w5JMPOrDAdBgNVHQ4EFgQU4yzL/3aHOxL7QyI/P/sCBoHfJ6cwRgYDVR0gBD8wPTA7BgRVHSAAMDMwMQYIKwYBBQUHAgEWJWh0dHA6Ly9wa2kuY29uc3VtZXIuaHVhd2VpLmNvbS9jYS9jcHMwEgYDVR0TAQH/BAgwBgEB/wIBATAOBgNVHQ8BAf8EBAMCAQYwUAYDVR0fBEkwRzBFoEOgQYY/aHR0cDovL3BraS5jb25zdW1lci5odWF3ZWkuY29tL2NhL2NybC9yb290X2RldmljZUF0dGVzdF9jcmwuY3JsMAoGCCqGSM49BAMDA2gAMGUCMQCE9qqNREq3AvCuznKeBl8biwC5GpV/Z1B0rsU4RqeTqNJ0Gvyz3g8Noaf4SpWzsLUCMBm5nr39UEOq89kx7QQjgYWLEWKcuSsgw2/6MckKP/6zrxjVld2SMtqiphKnrv1EkA==\n-----END CERTIFICATE-----"</span>,<span class="hljs-string">"-----BEGIN CERTIFICATE-----\nMIICCTCCAY6gAwIBAgIDVxAsMAoGCCqGSM49BAMDMEsxEzARBgNVBAoTCkh1YXdlaSBDQkcxNDAyBgNVBAMTK0h1YXdlaSBDQkcgRUNDIERldmljZSBBdHRlc3RhdGlvbiBSb290IENBIDEwIBcNMjMxMTMwMDIwNjU1WhgPMjA3MzExMzAwMjA2NTVaMEsxEzARBgNVBAoTCkh1YXdlaSBDQkcxNDAyBgNVBAMTK0h1YXdlaSBDQkcgRUNDIERldmljZSBBdHRlc3RhdGlvbiBSb290IENBIDEwdjAQBgcqhkjOPQIBBgUrgQQAIgNiAATDJzRdruaBeMoQBbdqCe51ezvkQn3OPYBoRmpL5KPktdFtD0b97FRp8jGLiUhPKyo8M15fxW5Ams4s80E8I1BSXoovDnkKllFfUadD8URgwEfOk5qttYNKzJcULavOhbijQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTaRGLD5yvof1E6XEuPQ3w5JMPOrDAKBggqhkjOPQQDAwNpADBmAjEA2zDQREvORPqcZyjwKDltu0T9zN8Cd3/hi4DQZvuRJdJOY57yIIO/LKxezzEcGiMMAjEAkX7r0U4Mcaw4uURMh+7tLMyvyxnlW8yJqBEOnZfqS8I8t0bQIY2r/5TQAPC0JhBm\n-----END CERTIFICATE-----"</span>};</li><li>
</li><li>    <span class="hljs-comment">//从HarmonyOS官网下载的根CA证书</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_rootCertStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"-----BEGIN CERTIFICATE-----\n"</span> +</li><li>            <span class="hljs-string">"MIICCTCCAY6gAwIBAgIDVxAsMAoGCCqGSM49BAMDMEsxEzARBgNVBAoTCkh1YXdl\n"</span> +</li><li>            <span class="hljs-string">"aSBDQkcxNDAyBgNVBAMTK0h1YXdlaSBDQkcgRUNDIERldmljZSBBdHRlc3RhdGlv\n"</span> +</li><li>            <span class="hljs-string">"biBSb290IENBIDEwIBcNMjMxMTMwMDIwNjU1WhgPMjA3MzExMzAwMjA2NTVaMEsx\n"</span> +</li><li>            <span class="hljs-string">"EzARBgNVBAoTCkh1YXdlaSBDQkcxNDAyBgNVBAMTK0h1YXdlaSBDQkcgRUNDIERl\n"</span> +</li><li>            <span class="hljs-string">"dmljZSBBdHRlc3RhdGlvbiBSb290IENBIDEwdjAQBgcqhkjOPQIBBgUrgQQAIgNi\n"</span> +</li><li>            <span class="hljs-string">"AATDJzRdruaBeMoQBbdqCe51ezvkQn3OPYBoRmpL5KPktdFtD0b97FRp8jGLiUhP\n"</span> +</li><li>            <span class="hljs-string">"Kyo8M15fxW5Ams4s80E8I1BSXoovDnkKllFfUadD8URgwEfOk5qttYNKzJcULavO\n"</span> +</li><li>            <span class="hljs-string">"hbijQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQW\n"</span> +</li><li>            <span class="hljs-string">"BBTaRGLD5yvof1E6XEuPQ3w5JMPOrDAKBggqhkjOPQQDAwNpADBmAjEA2zDQREvO\n"</span> +</li><li>            <span class="hljs-string">"RPqcZyjwKDltu0T9zN8Cd3/hi4DQZvuRJdJOY57yIIO/LKxezzEcGiMMAjEAkX7r\n"</span> +</li><li>            <span class="hljs-string">"0U4Mcaw4uURMh+7tLMyvyxnlW8yJqBEOnZfqS8I8t0bQIY2r/5TQAPC0JhBm\n"</span> +</li><li>            <span class="hljs-string">"-----END CERTIFICATE-----\n"</span>;</li><li>
</li><li>    <span class="hljs-comment">//保存HarmonyOS Hap应用生成的证书公钥的文件名</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_publicKeyFileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"d:\\attestPublicKey.pem"</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {</li><li>        <span class="hljs-type">ParseAttestation</span> <span class="hljs-variable">parseAttestation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseAttestation</span>();</li><li>        parseAttestation.parseAndValidateAttestCertChain(g_attestCertStr, g_rootCertStr, g_publicKeyFileName);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseAndValidateAttestCertChain</span><span class="hljs-params">(String[] attestCertStr, String rootCertStr, String publicKeyFileName)</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">//解析密钥证明证书链</span></li><li>            List&lt;X509Certificate&gt; attestCerts = parseAttestationCerts(attestCertStr);</li><li>            <span class="hljs-comment">//校验密钥证明证书链</span></li><li>            <span class="hljs-type">Date</span> <span class="hljs-variable">curDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();</li><li>            validateAttestationCertChain(attestCerts, rootCertStr, curDate);</li><li>            <span class="hljs-comment">//解析密钥证明证书</span></li><li>            <span class="hljs-type">AttestationInfo</span> <span class="hljs-variable">attestInfo</span> <span class="hljs-operator">=</span> extractAttestaionField(attestCerts.get(<span class="hljs-number">0</span>));</li><li>            <span class="hljs-comment">//校验密钥证明信息是否正确</span></li><li>            <span class="hljs-keyword">if</span> (!checkAttestInfo(attestInfo)) {</li><li>                <span class="hljs-comment">//todo： 进行异常处理</span></li><li>            }</li><li>            <span class="hljs-comment">//保存HarmonyOS Hap应用生成的公钥</span></li><li>            saveAttestPublicKey(attestInfo.publicKey, publicKeyFileName);</li><li>        } <span class="hljs-keyword">catch</span> (Exception e) {</li><li>            System.out.println(e);</li><li>        }</li><li>    }</li><li>
</li><li>    List&lt;X509Certificate&gt; <span class="hljs-title function_">parseAttestationCerts</span><span class="hljs-params">(String[] certStr)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        List&lt;X509Certificate&gt; certificateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(certStr.length);</li><li>        <span class="hljs-type">CertificateFactory</span> <span class="hljs-variable">certificateFactory</span> <span class="hljs-operator">=</span> CertificateFactory.getInstance(<span class="hljs-string">"X.509"</span>, <span class="hljs-string">"BC"</span>);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; certStr.length; i++) {</li><li>            certificateList.add((X509Certificate) certificateFactory.generateCertificate(</li><li>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(certStr[i].getBytes())));</li><li>        }</li><li>        <span class="hljs-keyword">return</span> certificateList;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateAttestationCertChain</span><span class="hljs-params">(List&lt;X509Certificate&gt; certs, String trustCAStr, Date date)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-comment">//构造证书链</span></li><li>        <span class="hljs-type">CertificateFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> CertificateFactory.getInstance(<span class="hljs-string">"X.509"</span>, <span class="hljs-string">"BC"</span>);</li><li>        <span class="hljs-type">CertPath</span> <span class="hljs-variable">certPath</span> <span class="hljs-operator">=</span> factory.generateCertPath(certs);</li><li>
</li><li>        <span class="hljs-comment">//读取信任根证书和构建trustAnchor对象</span></li><li>        <span class="hljs-type">X509Certificate</span> <span class="hljs-variable">trustCA</span> <span class="hljs-operator">=</span> (X509Certificate) factory.generateCertificate(</li><li>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(trustCAStr.getBytes()));</li><li>
</li><li>        <span class="hljs-type">TrustAnchor</span> <span class="hljs-variable">trustAnchor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrustAnchor</span>(trustCA, <span class="hljs-literal">null</span>);</li><li>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">trustAnchorSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;TrustAnchor&gt;();</li><li>        trustAnchorSet.add(trustAnchor);</li><li>
</li><li>        <span class="hljs-comment">//构建validator和对应的参数</span></li><li>        <span class="hljs-type">PKIXParameters</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PKIXParameters</span>(trustAnchorSet);</li><li>        params.setDate(date);</li><li>        <span class="hljs-comment">//密钥证明证书有效期比较短，不需要进行证书的吊销验证</span></li><li>        params.setRevocationEnabled(<span class="hljs-literal">false</span>);</li><li>
</li><li>        <span class="hljs-type">CertPathValidator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> CertPathValidator.getInstance(<span class="hljs-string">"PKIX"</span>, <span class="hljs-string">"BC"</span>);</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-type">PKIXCertPathValidatorResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (PKIXCertPathValidatorResult) validator.validate(certPath, params);</li><li>            System.out.println(<span class="hljs-string">"Cert Chain validate success!"</span>);</li><li>        } <span class="hljs-keyword">catch</span> (Exception e) {</li><li>            System.out.println(<span class="hljs-string">"Cert Chain validate fail!"</span> + e.getMessage());</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-type">int</span> <span class="hljs-title function_">getInteger</span><span class="hljs-params">(ASN1Encodable value)</span> {</li><li>        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> ASN1Integer) {</li><li>            <span class="hljs-keyword">return</span> ((ASN1Integer) value).getValue().intValue();</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> ASN1Enumerated) {</li><li>            <span class="hljs-keyword">return</span> ((ASN1Enumerated) value).getValue().intValue();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(</li><li>                    <span class="hljs-string">"expected Integer value ; found "</span> + value.getClass().getName() + <span class="hljs-string">" instead."</span>);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-type">byte</span>[] getOctetString(ASN1Encodable value) {</li><li>        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> ASN1OctetString) {</li><li>            <span class="hljs-keyword">return</span> ((ASN1OctetString) value).getOctets();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(</li><li>                    <span class="hljs-string">"expected OctetString value ; found "</span> + value.getClass().getName() + <span class="hljs-string">" instead."</span>);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">printBytes</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] byteArray)</span> {</li><li>    <span class="hljs-keyword">if</span> (byteArray == <span class="hljs-literal">null</span>) {</li><li>        System.out.println(<span class="hljs-string">"null"</span>);</li><li>        }</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; byteArray.length; i++) {</li><li>            System.out.printf(<span class="hljs-string">"%02X "</span>, byteArray[i]);</li><li>        }</li><li>        System.out.println();</li><li>    }</li><li>
</li><li>    AttestationInfo <span class="hljs-title function_">extractAttestaionField</span><span class="hljs-params">(X509Certificate certificate)</span> {</li><li>        <span class="hljs-type">AttestationInfo</span> <span class="hljs-variable">attestInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttestationInfo</span>();</li><li>        <span class="hljs-comment">//获取应用公钥</span></li><li>        attestInfo.publicKey = certificate.getPublicKey();</li><li>        <span class="hljs-comment">//从密钥证明证书中获取 “密钥证明扩展域段”</span></li><li>        <span class="hljs-type">byte</span>[] attestationValue = certificate.getExtensionValue(<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.1.3"</span>);</li><li>        <span class="hljs-keyword">if</span> (attestationValue == <span class="hljs-literal">null</span> || attestationValue.length == <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cann't found the attestation extension!"</span>);</li><li>        }</li><li>        <span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">attestSequence</span> <span class="hljs-operator">=</span> ASN1Sequence.getInstance(</li><li>                ASN1OctetString.getInstance(attestationValue).getOctets());</li><li>
</li><li>        <span class="hljs-comment">//获取Attestation Version</span></li><li>        attestInfo.version = getInteger(attestSequence.getObjectAt(<span class="hljs-number">0</span>));</li><li>
</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; attestSequence.size(); i++) {</li><li>            <span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">attestClaim</span> <span class="hljs-operator">=</span> ASN1Sequence.getInstance(attestSequence.getObjectAt(i));</li><li>            <span class="hljs-comment">//获取Claim的oid</span></li><li>            <span class="hljs-type">ASN1ObjectIdentifier</span> <span class="hljs-variable">attestClaimOid</span> <span class="hljs-operator">=</span> (ASN1ObjectIdentifier) attestClaim.getObjectAt(<span class="hljs-number">1</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.2.1.4"</span>.equalsIgnoreCase(attestClaimOid.getId())) {</li><li>                <span class="hljs-comment">//读取Challenge</span></li><li>                attestInfo.challenge = getOctetString(attestClaim.getObjectAt(<span class="hljs-number">2</span>));</li><li>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.2.1.3"</span>.equalsIgnoreCase(attestClaimOid.getId())) {</li><li>                <span class="hljs-comment">//读取appInfo</span></li><li>                <span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">appInfoAsn1</span> <span class="hljs-operator">=</span> (ASN1Sequence) attestClaim.getObjectAt(<span class="hljs-number">2</span>);</li><li>                <span class="hljs-comment">//获取appInfo的oid</span></li><li>                <span class="hljs-type">ASN1ObjectIdentifier</span> <span class="hljs-variable">appidOid</span> <span class="hljs-operator">=</span> (ASN1ObjectIdentifier) appInfoAsn1.getObjectAt(<span class="hljs-number">0</span>);</li><li>                <span class="hljs-keyword">if</span> (!<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.2.1.3.1"</span>.equalsIgnoreCase(appidOid.getId())) {</li><li>                    <span class="hljs-keyword">continue</span>;</li><li>                }</li><li>                <span class="hljs-comment">//读取hap应用信息</span></li><li>                <span class="hljs-type">String</span> <span class="hljs-variable">appInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(getOctetString(appInfoAsn1.getObjectAt(<span class="hljs-number">1</span>)));</li><li>                System.out.println(<span class="hljs-string">"appInfo is:\n"</span> + appInfo);</li><li>                attestInfo.appInfo = JSON.parseObject(appInfo, AppInfo.class);</li><li>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.2.2.2.6"</span>.equalsIgnoreCase(attestClaimOid.getId())) {</li><li>                <span class="hljs-comment">//读取密钥管理部件id，应该取值为0x28c4fb4944afec11b9090242ac120002</span></li><li>                attestInfo.keyManagerId = getOctetString(attestClaim.getObjectAt(<span class="hljs-number">2</span>));</li><li>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"1.3.6.1.4.1.2011.2.376.2.2.4.8"</span>.equalsIgnoreCase(attestClaimOid.getId())) {</li><li>                <span class="hljs-comment">//读取设备产品型号</span></li><li>                attestInfo.model = attestClaim.getObjectAt(<span class="hljs-number">2</span>).toString();</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">return</span> attestInfo;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAttestInfo</span><span class="hljs-params">(AttestationInfo attestInfo)</span> {</li><li>        <span class="hljs-comment">//todo: 校验Challenge</span></li><li>        System.out.println(<span class="hljs-string">"challenge is:"</span>);</li><li>        printBytes(attestInfo.challenge);</li><li>
</li><li>        <span class="hljs-comment">//todo: 校验appInfo中的字段信息</span></li><li>        System.out.println(<span class="hljs-string">"appInfo.appId is:\n"</span> + attestInfo.appInfo.appId);</li><li>        System.out.println(<span class="hljs-string">"appInfo.bundleName is:\n"</span> + attestInfo.appInfo.bundleName);</li><li>        System.out.println(<span class="hljs-string">"appInfo.appIdentifier is:\n"</span> + attestInfo.appInfo.appIdentifier);</li><li>        System.out.println(<span class="hljs-string">"appInfo.appMode is:\n"</span> + attestInfo.appInfo.appMode);</li><li>
</li><li>        <span class="hljs-comment">//todo: 校验keyManagerId，固定为：0x28c4fb4944afec11b9090242ac120002</span></li><li>        System.out.println(<span class="hljs-string">"key manager id is:"</span>);</li><li>        printBytes(attestInfo.keyManagerId);</li><li>
</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveAttestPublicKey</span><span class="hljs-params">(PublicKey publicKey, String publicKeyFileName)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-comment">//todo: 把attestInfo.publicKey.getEncoded()保存到数据库</span></li><li>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(publicKeyFileName);</li><li>        file.write(publicKey.getEncoded());</li><li>        file.close();</li><li>        System.out.println(<span class="hljs-string">"the app public key: \n"</span> + publicKey);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttestationInfo</span> {</li><li>        <span class="hljs-keyword">public</span> PublicKey publicKey;</li><li>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> version;</li><li>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] challenge;</li><li>        <span class="hljs-keyword">public</span> AppInfo appInfo;</li><li>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] keyManagerId;</li><li>        <span class="hljs-keyword">public</span> String model;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppInfo</span> {</li><li>        <span class="hljs-keyword">public</span> String appId;</li><li>        <span class="hljs-keyword">public</span> String bundleName;</li><li>        <span class="hljs-keyword">public</span> String appIdentifier;</li><li>        <span class="hljs-keyword">public</span> String appMode;</li><li>    }</li><li>}</li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h2 id="section02121859163315">保存应用公钥到数据库<i class="anchor-icon anchor-icon-link" anchorid="section02121859163315" tips="复制节点链接"></i></h2><p>应用服务器对密钥证明证书链校验通过后，把密钥证明证书中的应用公钥保存到服务器的数据库中（“对密钥证明证书链进行校验”的样例代码中已包含公钥保存的示例代码），以便对后续的业务请求进行验证。在保存应用公钥前应确保公钥的唯一性，系统中不应该存在多个相同的公钥。</p> <p><strong>安全建议：对于有用户登录的应用场景，为了提高安全性，建议为终端设备中登录的每个用户生成不同的密钥对，并在应用服务器绑定用户与应用公钥之间的关系</strong></p> <p><strong>实现提示：</strong> 对业务请求进行验签时需要先查找到应用公钥，建议对应用公钥计算密钥ID（如：对应用公钥计算Hash）并存储密钥ID与应用公钥的关系，通过密钥ID来查找应用公钥。</p> </div> <div class="tiledSection"><h2 id="section20873262344">使用应用公钥对业务请求进行验签<i class="anchor-icon anchor-icon-link" anchorid="section20873262344" tips="复制节点链接"></i></h2><p>应用服务器首先校验挑战值Challenge，然后根据应用公钥的密钥ID到数据库查找应用公钥。</p> <p><strong>安全建议：</strong><strong>对于有用户登录且应用公钥绑定用户ID的应用场景，应该根据应用公钥的密钥ID+当前登录的用户ID查找应用公钥。</strong></p> <p>应用服务器再使用应用公钥对请求中的签名进行验签。</p> <p><strong>样例代码：</strong></p> <div _ngcontent-xeg-c106="" class="highlight-div"><div _ngcontent-xeg-c106="" class="highlight-div-header"><div _ngcontent-xeg-c106="" class="highlight-div-header-left"><div _ngcontent-xeg-c106="" class="handle-button expand-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xeg-c106="" class="highlight-div-header-right"><div _ngcontent-xeg-c106="" class="handle-button ai-button"></div><div _ngcontent-xeg-c106="" class="handle-button line-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xeg-c106="" class="handle-button theme-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xeg-c106="" class="handle-button copy-button"><div _ngcontent-xeg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xeg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</li><li>
</li><li><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;</li><li><span class="hljs-keyword">import</span> java.io.FileInputStream;</li><li><span class="hljs-keyword">import</span> java.io.FileOutputStream;</li><li><span class="hljs-keyword">import</span> java.security.InvalidKeyException;</li><li><span class="hljs-keyword">import</span> java.security.KeyFactory;</li><li><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;</li><li><span class="hljs-keyword">import</span> java.security.NoSuchProviderException;</li><li><span class="hljs-keyword">import</span> java.security.PublicKey;</li><li><span class="hljs-keyword">import</span> java.security.Security;</li><li><span class="hljs-keyword">import</span> java.security.Signature;</li><li><span class="hljs-keyword">import</span> java.security.SignatureException;</li><li><span class="hljs-keyword">import</span> java.security.spec.X509EncodedKeySpec;</li><li><span class="hljs-keyword">import</span> java.util.Base64;</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VerifySignature</span> {</li><li>    <span class="hljs-keyword">static</span> {</li><li>        Security.addProvider(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BouncyCastleProvider</span>());</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//保存HarmonyOS Hap应用生成的证书公钥的文件名</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_publicKeyFileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"d:\\attestPublicKey.pem"</span>;</li><li>    <span class="hljs-comment">//HarmonyOS Hap应用使用私钥生成的签名数据，base64编码</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_signedData</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MEUCIQDtlrQa7HQccprCkR0nWTL7N6HEKY9PKN3DTk3aeN0/fQIgeqTrQ+7exiJhwTY3LwT7XhRHV1emOfTYho5qxyektho="</span>;</li><li>    <span class="hljs-comment">//待签名的数据</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_plaintext</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>;</li><li>    <span class="hljs-comment">//签名算法，与应用端采用的算法保持一致，取值样例：SM3WITHSM2，SHA256withECDSA</span></li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">g_signAlg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SHA256withECDSA"</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {</li><li>        <span class="hljs-type">VerifySignature</span> <span class="hljs-variable">verifySignature</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VerifySignature</span>();</li><li>        verifySignature.verifySignature(g_publicKeyFileName, g_plaintext, g_signedData, g_signAlg);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">verifySignature</span><span class="hljs-params">(String publicKeyFile, String plainText, String signedData, String signAlg)</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-type">PublicKey</span> <span class="hljs-variable">publicKey</span> <span class="hljs-operator">=</span> readAttestPublicKey(publicKeyFile);</li><li>            <span class="hljs-type">byte</span>[] signedDataByte = Base64.getDecoder().decode(signedData);</li><li>            System.out.println(<span class="hljs-string">"signedDataByte len="</span> + signedDataByte.length);</li><li>            printBytes(signedDataByte);</li><li>            <span class="hljs-type">byte</span>[] plainTextBytes = plainText.getBytes();</li><li>            System.out.println(<span class="hljs-string">"plainTextBytes len="</span> + plainTextBytes.length);</li><li>            printBytes(plainTextBytes);</li><li>            <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doVerify(publicKey, plainTextBytes, signedDataByte, signAlg);</li><li>            System.out.println(<span class="hljs-string">"Verify signature result: "</span> + result);</li><li>        } <span class="hljs-keyword">catch</span> (Exception e) {</li><li>            System.out.println(e);</li><li>        }</li><li>    }</li><li>
</li><li>    PublicKey <span class="hljs-title function_">readAttestPublicKey</span><span class="hljs-params">(String publicKeyFileName)</span> <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-comment">//todo: 从数据库中读取证明公钥</span></li><li>        <span class="hljs-type">KeyFactory</span> <span class="hljs-variable">keyFactory</span> <span class="hljs-operator">=</span> KeyFactory.getInstance(<span class="hljs-string">"EC"</span>, <span class="hljs-string">"BC"</span>);</li><li>        <span class="hljs-type">X509EncodedKeySpec</span> <span class="hljs-variable">spec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">X509EncodedKeySpec</span>(readFromFile(publicKeyFileName));</li><li>        <span class="hljs-type">PublicKey</span> <span class="hljs-variable">publicKey</span> <span class="hljs-operator">=</span> keyFactory.generatePublic(spec);</li><li>        System.out.println(<span class="hljs-string">"the app public key: \n"</span> + publicKey);</li><li>        <span class="hljs-keyword">return</span> publicKey;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">byte</span>[] readFromFile(String fn) <span class="hljs-keyword">throws</span> Exception {</li><li>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(fn);</li><li>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();</li><li>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];</li><li>        <span class="hljs-type">int</span> len;</li><li>        <span class="hljs-keyword">do</span> {</li><li>            len = inputStream.read(bytes);</li><li>            outputStream.write(bytes, <span class="hljs-number">0</span>, len);</li><li>        } <span class="hljs-keyword">while</span> (bytes.length == len);</li><li>        inputStream.close();</li><li>        <span class="hljs-keyword">return</span> outputStream.toByteArray();</li><li>    }</li><li>
</li><li>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">doVerify</span><span class="hljs-params">(PublicKey publickey, <span class="hljs-type">byte</span>[] unsignedData, <span class="hljs-type">byte</span>[] signedData, String signAlg)</span> {</li><li>        <span class="hljs-type">boolean</span> <span class="hljs-variable">verifyResult</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-type">Signature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> Signature.getInstance(signAlg, <span class="hljs-string">"BC"</span>);</li><li>            signature.initVerify(publickey);</li><li>            signature.update(unsignedData);</li><li>            verifyResult = signature.verify(signedData);</li><li>            <span class="hljs-keyword">return</span> verifyResult;</li><li>        } <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException | NoSuchProviderException | InvalidKeyException | SignatureException e) {</li><li>            e.printStackTrace();</li><li>        }</li><li>        <span class="hljs-keyword">return</span> verifyResult;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">printBytes</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] byteArray)</span> {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; byteArray.length; i++) {</li><li>            System.out.printf(<span class="hljs-string">"%02X "</span>, byteArray[i]);</li><li>        }</li><li>        System.out.println();</li><li>    }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>