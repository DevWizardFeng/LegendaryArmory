<h1 _ngcontent-gys-c119="" class="doc-title ng-star-inserted" title="权益发放"> 权益发放 </h1>

<div _ngcontent-gys-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1880231055910">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1880231055910" tips="复制节点链接"></i></h2>          <p>应用在收到用户购买消耗型/非消耗型商品成功的结果后，需要发放相关权益，并在权益发放后，向IAP Kit确认发货，完成购买流程，具体实现请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-integrate-purchase">接入购买</a>。此外，还需要补充如下处理，确保权益发放：</p>     <ul>      <li>若应用提供消耗型商品，需要按照<a href="/consumer/cn/doc/harmonyos-guides/iap-delivering-products#section39601828172114">确保权益发放</a>处理消耗型商品的权益发放。</li>      <li>若应用提供非消耗型商品，且为单机应用，则需要按照<a href="/consumer/cn/doc/harmonyos-guides/iap-delivering-products#section12848165791915">单机应用权益发放（非消耗型商品）</a>处理非消耗型商品的权益发放。其他场景需要按照<a href="/consumer/cn/doc/harmonyos-guides/iap-delivering-products#section39601828172114">确保权益发放</a>处理非消耗型商品的权益发放。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section39601828172114">确保权益发放<i class="anchor-icon anchor-icon-link" anchorid="section39601828172114" tips="复制节点链接"></i></h2>          <p>用户购买商品后，开发者需要及时发放相关权益。但实际应用场景中，若出现异常（网络错误、进程被中止等）将导致应用无法知道用户实际是否支付成功，从而无法及时发放权益，即出现掉单情况。为了确保权益发放，需要在以下场景检查用户是否存在已购未发货的商品：</p>     <ol>      <li>应用启动时。</li>      <li>购买请求（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section18798154545516" target="_blank">createPurchase</a>）返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.PRODUCT_OWNED</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.SYSTEM_ERROR</a>时。</li>     </ol>     <p>如果存在已购未发货商品，则发放相关权益，然后向IAP Kit确认发货，完成购买。</p>    </div>    <div class="tiledSection">     <h3 id="section686532553013" class="firsth2">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section686532553013" tips="复制节点链接"></i></h3>          <p><span><img height="566.4736" originheight="619" originwidth="654" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114656.36575919118662366924614122177403:50001231000000:2800:3B1FA921A9BBE19B8E993E061042F8F9432B254E980100FA8F17EF1F8C4DB960.png" title="点击放大" width="598.5"></span></p>     <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，查询用户已购买但未确认发货的订单信息。</li>      <li>IAP Kit返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>为JWS格式的字符串，承载了相关的订单信息。</li>      <li>应用客户端向应用服务器上报<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。</li>      <li>应用服务器需<span style="color: rgb(48,48,48);">对每个</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a><span style="color: rgb(48,48,48);">.jwsPurchaseOrder进行</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a><span style="color: rgb(48,48,48);">，验证成功可得到对应的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>的JSON字符串。</li>      <li>处理权益发放。检查<span style="color: rgb(48,48,48);">当前</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>是否已发放权益，未发放则发放相关权益，并记录对应的订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。</li>      <li>应用客户端向应用服务器查询订单的发货状态。</li>      <li>应用服务器返回对应的发货状态以及订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。</li>      <li>发货成功后应用客户端向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求，以此通知IAP服务器更新商品的发货状态，完成购买流程。应用成功执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>之后，IAP服务器会将相应商品标记为已发货状态。对于消耗型商品，IAP服务器会将相应商品重新设置为可购买状态，用户即可再次购买该商品。       <div class="p">        此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-order" target="_blank">订单确认发货</a>接口来确认发货，完成购买流程。        <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">          <p>确保在发货成功之后再执行此步骤，否则可能导致IAP服务器已经确认发货但是应用没有发货的问题。</p>         </div></div></div>       </div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section5216205492915">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5216205492915" tips="复制节点链接"></i></h3>          <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，获取用户已购买但未确认发货的订单信息。       <p>在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section555872993213" target="_blank">QueryPurchasesParameter</a>中指定对应的productType，同时指定queryType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1389262216514" target="_blank">iap.PurchaseQueryType.UNFINISHED</a>。当接口请求成功时，IAP Kit将返回一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section820381425513" target="_blank">QueryPurchaseResult</a>对象，该对象包含承载了订单信息的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>的列表。</p></li>      <li>对<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>.jwsPurchaseOrder进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>。建议应用客户端将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>发送至应用服务器，在应用服务器执行此操作。</li>      <li><span style="color: rgb(48,48,48);">验证成功可得到对应的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>的JSON字符串，如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>.purchaseOrderRevocationReasonCode为空，则代表购买成功，需要进行补发货处理。       <p><span style="color: rgb(48,48,48);">建议先检查此笔订单权益的发放状态，未发放则发放权益，成功后记录</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>等信息，用于后续检查权益发放状态。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>如果开发者在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-integrate-purchase#section1019127147">发起购买</a>时支持消耗型商品的批量购买，则需要在发货时校验下单的商品数量和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>.quantity是否一致，避免造成漏发、多发的情况。</p>        </div></div></div></li>      <li>发货成功后，应用需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>接口确认发货，以此通知IAP服务器更新商品的发货状态，完成购买流程。       <p>发起请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section103714142118" target="_blank">FinishPurchaseParameter</a>中携带<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>中的productType、purchaseToken、purchaseOrderId。</p>       <p>请求成功后，IAP服务器会将相应商品标记为已发货状态。对于消耗型商品，IAP服务器会将相应商品重新设置为可购买状态，用户即可再次购买该商品。对于非消耗型商品，用户购买后永久拥有，无法再次购买该商品。</p>       <div _ngcontent-gys-c106="" class="highlight-div"><div _ngcontent-gys-c106="" class="highlight-div-header"><div _ngcontent-gys-c106="" class="highlight-div-header-left"><div _ngcontent-gys-c106="" class="handle-button expand-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gys-c106="" class="highlight-div-header-right"><div _ngcontent-gys-c106="" class="handle-button ai-button"></div><div _ngcontent-gys-c106="" class="handle-button line-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gys-c106="" class="handle-button theme-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gys-c106="" class="handle-button copy-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gys-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// JWSUtil为自定义类，可参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-dev-guide#section698882222912"><span class="hljs-comment">示例代码</span></a></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JWSUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/JWSUtil'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">queryPurchases</span>(<span class="hljs-params">context: common.UIAbilityContext,</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">param</span>: iap.<span class="hljs-property">QueryPurchasesParameter</span> = {</li><li>      <span class="hljs-comment">// iap.ProductType.CONSUMABLE：消耗型商品</span></li><li>      <span class="hljs-comment">// iap.ProductType.NONCONSUMABLE：非消耗型商品</span></li><li>      <span class="hljs-attr">productType</span>: iap.<span class="hljs-property">ProductType</span>.<span class="hljs-property">CONSUMABLE</span>,</li><li>      <span class="hljs-attr">queryType</span>: iap.<span class="hljs-property">PurchaseQueryType</span>.<span class="hljs-property">UNFINISHED</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">queryPurchases</span>(context, param).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: iap.QueryPurchaseResult</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying purchases.'</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">purchaseDataList</span>: <span class="hljs-built_in">string</span>[] = res.<span class="hljs-property">purchaseDataList</span>;</li><li>      <span class="hljs-keyword">if</span> (purchaseDataList === <span class="hljs-literal">undefined</span> || purchaseDataList.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; purchaseDataList.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">jwsPurchaseOrder</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(purchaseDataList[i]).<span class="hljs-property">jwsPurchaseOrder</span>;</li><li>        <span class="hljs-keyword">if</span> (!jwsPurchaseOrder) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-keyword">const</span> purchaseStr = <span class="hljs-title class_">JWSUtil</span>.<span class="hljs-title function_">decodeJwsObj</span>(jwsPurchaseOrder);</li><li>        <span class="hljs-comment">// 需自定义PurchaseOrderPayload类，包含的信息请参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank"><span class="hljs-comment">PurchaseOrderPayload</span></a></li><li>        <span class="hljs-keyword">const</span> purchaseOrderPayload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(purchaseStr) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PurchaseOrderPayload</span>;</li><li>        <span class="hljs-comment">// 处理发货</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// 发货成功后向IAP Kit发送finishPurchase请求，确认发货，完成购买</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishPurchase</span>(context, purchaseOrderPayload);</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query purchases. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishPurchase</span>(<span class="hljs-params">context: common.UIAbilityContext, purchaseOrder: PurchaseOrderPayload</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">finishPurchaseParam</span>: iap.<span class="hljs-property">FinishPurchaseParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: <span class="hljs-title class_">Number</span>(purchaseOrder.<span class="hljs-property">productType</span>),</li><li>      <span class="hljs-attr">purchaseToken</span>: purchaseOrder.<span class="hljs-property">purchaseToken</span>,</li><li>      <span class="hljs-attr">purchaseOrderId</span>: purchaseOrder.<span class="hljs-property">purchaseOrderId</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">finishPurchase</span>(context, finishPurchaseParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in finishing purchase.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finish purchase. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section12848165791915">单机应用权益发放（非消耗型商品）<i class="anchor-icon anchor-icon-link" anchorid="section12848165791915" tips="复制节点链接"></i></h2>          <p>用户在购买非消耗型商品后，将永久拥有该商品的权益。应用需要在用户购买非消耗型商品后，始终为其发放相关权益。</p>     <p>请在以下场景获取用户已购非消耗型商品的信息，并发放相关权益。</p>     <ol>      <li>应用启动时。</li>      <li>购买请求（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section18798154545516" target="_blank">createPurchase</a>）返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.PRODUCT_OWNED</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.SYSTEM_ERROR</a>时。</li>     </ol>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>为了在卸载重装、更换设备安装等场景下保障用户权益，需要在应用首次打开时，应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，查询用户已购非消耗型商品，完成权益恢复。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="section18214541125" class="firsth2">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section18214541125" tips="复制节点链接"></i></h3>          <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，获取用户已购非消耗型商品的订单状态信息。       <p>在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section555872993213" target="_blank">QueryPurchasesParameter</a>中指定productType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section59035422210" target="_blank">iap.ProductType.NONCONSUMABLE</a>，同时指定queryType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1389262216514" target="_blank">iap.PurchaseQueryType.CURRENT_ENTITLEMENT</a>。当接口请求成功时，IAP Kit将返回一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section820381425513" target="_blank">QueryPurchaseResult</a>对象，该对象包含承载了订单信息的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>的列表。</p></li>      <li>对每个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>.jwsPurchaseOrder进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>。</li>      <li>验证成功可得到对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>的JSON字符串，此时需要发放相关权益。</li>      <li>发放权益后，应用需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>接口确认发货，以此通知IAP服务器更新商品的发货状态，完成购买流程。       <p>发起请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section103714142118" target="_blank">FinishPurchaseParameter</a>中携带<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>中的productType、purchaseToken、purchaseOrderId。</p>       <p>请求成功后，IAP服务器会将相应商品标记为已发货。对于非消耗型商品，用户购买后永久拥有，无法再次购买该商品。</p></li>     </ol>     <div _ngcontent-gys-c106="" class="highlight-div"><div _ngcontent-gys-c106="" class="highlight-div-header"><div _ngcontent-gys-c106="" class="highlight-div-header-left"><div _ngcontent-gys-c106="" class="handle-button expand-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gys-c106="" class="highlight-div-header-right"><div _ngcontent-gys-c106="" class="handle-button ai-button"></div><div _ngcontent-gys-c106="" class="handle-button line-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gys-c106="" class="handle-button theme-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gys-c106="" class="handle-button copy-button"><div _ngcontent-gys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gys-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// JWSUtil为自定义类，可参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-dev-guide#section698882222912"><span class="hljs-comment">示例代码</span></a></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JWSUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/JWSUtil'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">queryPurchases</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">param</span>: iap.<span class="hljs-property">QueryPurchasesParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: iap.<span class="hljs-property">ProductType</span>.<span class="hljs-property">NONCONSUMABLE</span>,</li><li>      <span class="hljs-attr">queryType</span>: iap.<span class="hljs-property">PurchaseQueryType</span>.<span class="hljs-property">CURRENT_ENTITLEMENT</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">queryPurchases</span>(context, param).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: iap.QueryPurchaseResult</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying purchases.'</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">purchaseDataList</span>: <span class="hljs-built_in">string</span>[] = res.<span class="hljs-property">purchaseDataList</span>;</li><li>      <span class="hljs-keyword">if</span> (purchaseDataList === <span class="hljs-literal">undefined</span> || purchaseDataList.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; purchaseDataList.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">jwsPurchaseOrder</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(purchaseDataList[i]).<span class="hljs-property">jwsPurchaseOrder</span>;</li><li>        <span class="hljs-keyword">if</span> (!jwsPurchaseOrder) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 对jwsPurchaseOrder进行解码验签</span></li><li>        <span class="hljs-keyword">const</span> purchaseStr = <span class="hljs-title class_">JWSUtil</span>.<span class="hljs-title function_">decodeJwsObj</span>(jwsPurchaseOrder);</li><li>        <span class="hljs-comment">// 需自定义PurchaseOrderPayload类，包含的信息请参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank"><span class="hljs-comment">PurchaseOrderPayload</span></a></li><li>        <span class="hljs-keyword">const</span> purchaseOrderPayload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(purchaseStr) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PurchaseOrderPayload</span>;</li><li>        <span class="hljs-comment">// 处理权益发放</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// 发放权益后向IAP Kit发送finishPurchase请求，确认发货，完成购买</span></li><li>        <span class="hljs-keyword">if</span> (purchaseOrderPayload &amp;&amp; purchaseOrderPayload.<span class="hljs-property">finishStatus</span> !== <span class="hljs-string">'1'</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishPurchase</span>(context, purchaseOrderPayload);</li><li>        }</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query purchases. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishPurchase</span>(<span class="hljs-params">context: common.UIAbilityContext, purchaseOrder: PurchaseOrderPayload</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">finishPurchaseParam</span>: iap.<span class="hljs-property">FinishPurchaseParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: <span class="hljs-title class_">Number</span>(purchaseOrder.<span class="hljs-property">productType</span>),</li><li>      <span class="hljs-attr">purchaseToken</span>: purchaseOrder.<span class="hljs-property">purchaseToken</span>,</li><li>      <span class="hljs-attr">purchaseOrderId</span>: purchaseOrder.<span class="hljs-property">purchaseOrderId</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">finishPurchase</span>(context, finishPurchaseParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in finishing purchase.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finish purchase. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>