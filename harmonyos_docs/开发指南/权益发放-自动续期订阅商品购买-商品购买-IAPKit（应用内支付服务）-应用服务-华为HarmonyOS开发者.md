<h1 _ngcontent-ruu-c119="" class="doc-title ng-star-inserted" title="权益发放"> 权益发放 </h1>

<div _ngcontent-ruu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1369619716116">对生效中的订阅发放权益<i class="anchor-icon anchor-icon-link" anchorid="section1369619716116" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1441525310106" class="firsth2">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1441525310106" tips="复制节点链接"></i></h3>          <p>用户购买自动续期订阅商品后，若订阅处于生效状态，开发者需要及时给用户发放对应权益。</p>     <p>在应用启动时，获取用户当前处于生效状态的订阅列表，处理此部分订阅的权益发放。建议先检查当前订阅对应权益的发放状态，未发放再补充发放权益。在权益发放成功后，向IAP确认发货，完成购买。</p>     <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p>    </div>    <div class="tiledSection">     <h3 id="section12467740151011">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section12467740151011" tips="复制节点链接"></i></h3>          <p><span><img height="553.8386" originheight="620" originwidth="670" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114702.93064188054087312328064764095210:50001231000000:2800:A85DE82F0B869990996EBFA569847B5142B8628B23A7899B72969B33CB995281.png" title="点击放大" width="598.5"></span></p>     <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，查询用户生效中的订阅列表。</li>      <li>IAP Kit返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>为JWS格式的字符串，承载了相关的订阅信息。</li>      <li>应用客户端向应用服务器上报<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。</li>      <li>应用服务器需<span style="color: rgb(48,48,48);">对每个</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a><span style="color: rgb(48,48,48);">.jwsSubscriptionStatus进行</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a><span style="color: rgb(48,48,48);">，验证成功可得到对应的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。</li>      <li>处理权益发放。检查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder是否已发放权益，未发放则需发放相关权益，并记录对应的订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p>        </div></div></div></li>      <li>应用客户端向应用服务器查询订单的发货状态。</li>      <li>应用服务器返回对应的发货状态以及订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。</li>      <li>发放权益后应用客户端向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求，以此通知IAP服务器更新商品的发货状态，完成购买流程。应用成功执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>之后，IAP服务器会将相应商品标记为已发货状态。       <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section10327232151013">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section10327232151013" tips="复制节点链接"></i></h3>          <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，获取生效中的订阅列表。       <p>在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section555872993213" target="_blank">QueryPurchasesParameter</a>中指定productType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section59035422210" target="_blank">iap.ProductType.AUTORENEWABLE</a>，同时指定queryType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1389262216514" target="_blank">iap.PurchaseQueryType.CURRENT_ENTITLEMENT</a>。当接口请求成功时，IAP Kit将返回一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section820381425513" target="_blank">QueryPurchaseResult</a>对象，该对象包含承载了订阅信息的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>的列表。</p></li>      <li>验证订单信息。对每个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>.jwsSubscriptionStatus进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>，验证成功可得到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。建议应用客户端将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>发送至应用服务器，在应用服务器执行此操作。       <p>为了提高安全性，可从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder中解析出purchaseToken和purchaseOrderId信息，并通过服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-query-subscription-status" target="_blank">订阅状态查询</a>接口向IAP服务器查询最新的订阅状态信息，进一步确认订阅信息的准确性。</p></li>      <li>展示订阅状态。       <ul>        <li>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.status=1，表示订阅处于生效状态。</li>        <li>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.status=1且<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.renewalInfo.autoRenewStatusCode值为1时，表示订阅处于自动续期状态。此状态的商品无法再次购买，需要屏蔽相关的购买入口。</li>       </ul></li>      <li>权益发放。获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder（下文标记为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>），处理权益发放。       <p>可先检查此笔订单权益的发放状态，未发放则补充发放权益，成功后记录<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>等信息，用于后续检查权益发放状态。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p>        </div></div></div></li>      <li>在发放权益后，如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a><span style="color: rgb(48,48,48);">.</span>finishStatus不为1，应用需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>接口确认发货，完成购买流程。       <p>发起请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section103714142118" target="_blank">FinishPurchaseParameter</a>中携带<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>中的productType、purchaseToken、purchaseOrderId。请求成功后，IAP服务器会将相应商品标记为已发货。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p>        </div></div></div></li>     </ol>    </div>    <div _ngcontent-ruu-c106="" class="highlight-div"><div _ngcontent-ruu-c106="" class="highlight-div-header"><div _ngcontent-ruu-c106="" class="highlight-div-header-left"><div _ngcontent-ruu-c106="" class="handle-button expand-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruu-c106="" class="highlight-div-header-right"><div _ngcontent-ruu-c106="" class="handle-button ai-button"></div><div _ngcontent-ruu-c106="" class="handle-button line-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruu-c106="" class="handle-button theme-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruu-c106="" class="handle-button copy-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruu-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { iap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// JWSUtil为自定义类，可参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-dev-guide#section698882222912"><span class="hljs-comment">示例代码</span></a></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JWSUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/JWSUtil'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-title function_">queryPurchases</span>(<span class="hljs-params">context: common.UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">param</span>: iap.<span class="hljs-property">QueryPurchasesParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: iap.<span class="hljs-property">ProductType</span>.<span class="hljs-property">AUTORENEWABLE</span>,</li><li>      <span class="hljs-attr">queryType</span>: iap.<span class="hljs-property">PurchaseQueryType</span>.<span class="hljs-property">CURRENT_ENTITLEMENT</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">queryPurchases</span>(context, param).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: iap.QueryPurchaseResult</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying purchases.'</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">purchaseDataList</span>: <span class="hljs-built_in">string</span>[] = res.<span class="hljs-property">purchaseDataList</span>;</li><li>      <span class="hljs-keyword">if</span> (purchaseDataList === <span class="hljs-literal">undefined</span> || purchaseDataList.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; purchaseDataList.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">jwsSubscriptionStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(purchaseDataList[i]).<span class="hljs-property">jwsSubscriptionStatus</span>;</li><li>        <span class="hljs-keyword">if</span> (!jwsSubscriptionStatus) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 对jwsSubscriptionStatus进行解码验签</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">subscriptionStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JWSUtil</span>.<span class="hljs-title function_">decodeJwsObj</span>(jwsSubscriptionStatus);</li><li>        <span class="hljs-comment">// 需自定义SubGroupStatusPayload类，包含的信息请参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank"><span class="hljs-comment">SubGroupStatusPayload</span></a></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">subGroupStatusPayload</span>: <span class="hljs-title class_">SubGroupStatusPayload</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(subscriptionStatus);</li><li>        <span class="hljs-keyword">const</span> lastSubscriptionStatus = subGroupStatusPayload.<span class="hljs-property">lastSubscriptionStatus</span>;</li><li>        <span class="hljs-keyword">if</span> (!lastSubscriptionStatus) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 根据status判断订阅的状态</span></li><li>        <span class="hljs-keyword">const</span> status = lastSubscriptionStatus.<span class="hljs-property">status</span>;</li><li>        <span class="hljs-comment">// 更新商品的订阅状态</span></li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 处理权益发放</span></li><li>        <span class="hljs-keyword">const</span> purchaseOrderPayload = lastSubscriptionStatus.<span class="hljs-property">lastPurchaseOrder</span>;</li><li>        <span class="hljs-keyword">if</span> (purchaseOrderPayload === <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'1'</span>) {</li><li>          <span class="hljs-comment">// 订阅处于生效状态</span></li><li>          <span class="hljs-comment">// 处理权益发放。检查此笔订单权益的发放状态，未发放则补充发放权益</span></li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        <span class="hljs-comment">// 发放权益后向IAP Kit发送finishPurchase请求，确认发货，完成购买</span></li><li>        <span class="hljs-keyword">if</span> (purchaseOrderPayload &amp;&amp; purchaseOrderPayload.<span class="hljs-property">finishStatus</span> !== <span class="hljs-string">'1'</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishPurchase</span>(context, purchaseOrderPayload);</li><li>        }</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query purchases. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishPurchase</span>(<span class="hljs-params">context: common.UIAbilityContext, purchaseOrder: PurchaseOrderPayload</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">finishPurchaseParam</span>: iap.<span class="hljs-property">FinishPurchaseParameter</span> = {</li><li>      <span class="hljs-attr">productType</span>: <span class="hljs-title class_">Number</span>(purchaseOrder.<span class="hljs-property">productType</span>),</li><li>      <span class="hljs-attr">purchaseToken</span>: purchaseOrder.<span class="hljs-property">purchaseToken</span>,</li><li>      <span class="hljs-attr">purchaseOrderId</span>: purchaseOrder.<span class="hljs-property">purchaseOrderId</span></li><li>    };</li><li>    iap.<span class="hljs-title function_">finishPurchase</span>(context, finishPurchaseParam).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in finishing purchase.'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to finish purchase. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {}</li><li>}</li></ol></pre></div></div>    <div class="tiledSection">     <h2 id="section1880231055910">确保权益发放<i class="anchor-icon anchor-icon-link" anchorid="section1880231055910" tips="复制节点链接"></i></h2>          <p>用户购买自动续期订阅成功或者自动续期成功后，开发者需要及时给用户发放相关权益。但实际应用场景中，若出现异常（网络错误等）将导致应用无法知道用户实际是否支付成功，从而无法及时发放权益，即出现掉单情况。</p>     <p>为了确保权益发放，需要在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section18798154545516" target="_blank">createPurchase</a>请求返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.PRODUCT_OWNED</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1834394718429" target="_blank">iap.IAPErrorCode.SYSTEM_ERROR</a>时检查用户是否存在已购但未确认发货的商品，如果存在则发放相关权益，然后向IAP Kit确认发货，完成购买。</p>    </div>    <div class="tiledSection">     <h3 id="section26351191461" class="firsth2">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section26351191461" tips="复制节点链接"></i></h3>          <p><span><img height="553.8386" originheight="620" originwidth="670" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114702.70156560288192983567597818385085:50001231000000:2800:5950D928D471EDDF377F9FB4CB09B79B6153AB1093CD0A6AEA0A74ED8C91EE2F.png" title="点击放大" width="598.5"></span></p>     <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，查询用户已购买但未确认发货的订阅列表。</li>      <li>IAP Kit返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>为JWS格式的字符串，承载了相关的订阅信息。</li>      <li>应用客户端向应用服务器上报<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>列表。</li>      <li>应用服务器需<span style="color: rgb(48,48,48);">对每个</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a><span style="color: rgb(48,48,48);">.jwsSubscriptionStatus进行</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a><span style="color: rgb(48,48,48);">，验证成功可得到对应的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。</li>      <li>处理权益发放。检查<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder是否已发放权益，未发放则需发放相关权益，并记录对应的订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p>        </div></div></div></li>      <li>应用客户端向应用服务器查询订单的发货状态。</li>      <li>应用服务器返回对应的发货状态以及订单信息（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>）。</li>      <li>发放权益后应用客户端向IAP Kit发送<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>请求，以此通知IAP服务器更新商品的发货状态，完成购买流程。应用成功执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>之后，IAP服务器会将相应商品标记为已发货状态。       <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="section197962715619">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section197962715619" tips="复制节点链接"></i></h3>          <ol>      <li>应用客户端向IAP Kit发起<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1147122418532" target="_blank">queryPurchases</a>请求，获取用户已购但未确认发货的订阅列表。       <p>在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section555872993213" target="_blank">QueryPurchasesParameter</a>中指定productType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section59035422210" target="_blank">iap.ProductType.AUTORENEWABLE</a>，同时指定queryType为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section1389262216514" target="_blank">iap.PurchaseQueryType.UNFINISHED</a>。当接口请求成功时，IAP Kit将返回一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section820381425513" target="_blank">QueryPurchaseResult</a>对象，该对象包含承载了订阅信息的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">PurchaseData</a>的列表。</p></li>      <li>验证订单信息。对每个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>.jwsSubscriptionStatus进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-verifying-signature" target="_blank">解码验签</a>，验证成功可得到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>的JSON字符串。建议应用客户端将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section650794012482" target="_blank">purchaseData</a>发送至应用服务器，在应用服务器执行此操作。       <p>为了提高安全性，可从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank">SubGroupStatusPayload</a>.lastSubscriptionStatus.lastPurchaseOrder中解析出purchaseToken和purchaseOrderId信息，并通过服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-query-subscription-status" target="_blank">订阅状态查询</a>接口向IAP服务器查询最新的订阅状态信息，进一步确认订阅信息的准确性。</p></li>      <li>处理权益发放。       <p>如果SubGroupStatusPayload.lastSubscriptionStatus.status=1，表示订阅处于生效状态。需要对生效状态的订阅处理权益发放。建议先检查此笔订单权益的发放状态，未发放则补充发放权益，成功后记录<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>等信息，用于后续检查权益发放状态。</p>       <p>建议单机应用将用户权益和订阅状态关联。如果订阅处于生效状态，始终为用户发放权益。</p></li>      <li>在发放权益后，如果PurchaseOrderPayload.finishStatus不为1，应用需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section124751324135814" target="_blank">finishPurchase</a>接口确认发货，完成购买流程。       <p>发起请求时，需在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-iap#section103714142118" target="_blank">FinishPurchaseParameter</a>中携带<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section260562820380" target="_blank">PurchaseOrderPayload</a>中的productType、purchaseToken、purchaseOrderId。请求成功后，IAP服务器会将相应商品标记为已发货。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>此步骤也可放到应用服务器处理。应用服务器可通过请求服务端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-confirm-purchase-for-sub" target="_blank">订阅确认发货</a>接口来确认发货，完成购买流程。</p>        </div></div></div></li>     </ol>    </div>    <div _ngcontent-ruu-c106="" class="highlight-div"><div _ngcontent-ruu-c106="" class="highlight-div-header"><div _ngcontent-ruu-c106="" class="highlight-div-header-left"><div _ngcontent-ruu-c106="" class="handle-button expand-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruu-c106="" class="highlight-div-header-right"><div _ngcontent-ruu-c106="" class="handle-button ai-button"></div><div _ngcontent-ruu-c106="" class="handle-button line-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruu-c106="" class="handle-button theme-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruu-c106="" class="handle-button copy-button"><div _ngcontent-ruu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">iap</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IAPKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">common</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// JWSUtil为自定义类，可参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/iap-dev-guide#section698882222912"><span class="hljs-comment">示例代码</span></a></li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">JWSUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/JWSUtil'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>
</li><li>  <span class="hljs-title function_">queryPurchases</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">param</span>: <span class="hljs-title class_">iap</span>.<span class="hljs-title class_">QueryPurchasesParameter</span> = {</li><li>      <span class="hljs-variable">productType</span>: <span class="hljs-title class_">iap</span>.<span class="hljs-title class_">ProductType</span>.<span class="hljs-title class_">AUTORENEWABLE</span>,</li><li>      <span class="hljs-variable">queryType</span>: <span class="hljs-title class_">iap</span>.<span class="hljs-title class_">PurchaseQueryType</span>.<span class="hljs-title class_">UNFINISHED</span></li><li>    };</li><li>    <span class="hljs-variable">iap</span>.<span class="hljs-title function_">queryPurchases</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">param</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">res</span>: <span class="hljs-title class_">iap</span>.<span class="hljs-title class_">QueryPurchaseResult</span>) =&gt; {</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in querying purchases.'</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">purchaseDataList</span>: <span class="hljs-title class_">string</span>[] = <span class="hljs-variable">res</span>.<span class="hljs-variable">purchaseDataList</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">purchaseDataList</span> === <span class="hljs-variable">undefined</span> || <span class="hljs-variable">purchaseDataList</span>.<span class="hljs-variable">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">purchaseDataList</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">jwsSubscriptionStatus</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">purchaseDataList</span>[<span class="hljs-variable">i</span>]).<span class="hljs-variable">jwsSubscriptionStatus</span>;</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">jwsSubscriptionStatus</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 对jwsSubscriptionStatus进行解码验签</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">subscriptionStatus</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">JWSUtil</span>.<span class="hljs-title function_">decodeJwsObj</span>(<span class="hljs-variable">jwsSubscriptionStatus</span>);</li><li>        <span class="hljs-comment">// 需自定义SubGroupStatusPayload类，包含的信息请参见</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/iap-data-model#section1311343185318" target="_blank"><span class="hljs-comment">SubGroupStatusPayload</span></a></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">subGroupStatusPayload</span>: <span class="hljs-title class_">SubGroupStatusPayload</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">subscriptionStatus</span>);</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">lastSubscriptionStatus</span> = <span class="hljs-variable">subGroupStatusPayload</span>.<span class="hljs-variable">lastSubscriptionStatus</span>;</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">lastSubscriptionStatus</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// 根据status判断订阅的状态</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">status</span> = <span class="hljs-variable">lastSubscriptionStatus</span>.<span class="hljs-variable">status</span>;</li><li>        <span class="hljs-comment">// 更新商品的订阅状态</span></li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 处理权益发放</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">purchaseOrderPayload</span> = <span class="hljs-variable">lastSubscriptionStatus</span>.<span class="hljs-variable">lastPurchaseOrder</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">purchaseOrderPayload</span> === <span class="hljs-variable">undefined</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> === <span class="hljs-string">'1'</span>) {</li><li>          <span class="hljs-comment">// 订阅处于生效状态</span></li><li>          <span class="hljs-comment">// 处理权益发放。检查此笔订单权益的发放状态，未发放则补充发放权益</span></li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        <span class="hljs-comment">// 发放权益后向IAP Kit发送finishPurchase请求，确认发货，完成购买</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">purchaseOrderPayload</span> &amp;&amp; <span class="hljs-variable">purchaseOrderPayload</span>.<span class="hljs-variable">finishStatus</span> !== <span class="hljs-string">'1'</span>) {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">finishPurchase</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">purchaseOrderPayload</span>);</li><li>        }</li><li>      }</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">query</span> <span class="hljs-variable">purchases</span>. <span class="hljs-variable">Code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">finishPurchase</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>, <span class="hljs-variable">purchaseOrder</span>: <span class="hljs-title class_">PurchaseOrderPayload</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">finishPurchaseParam</span>: <span class="hljs-title class_">iap</span>.<span class="hljs-title class_">FinishPurchaseParameter</span> = {</li><li>      <span class="hljs-variable">productType</span>: <span class="hljs-title class_">Number</span>(<span class="hljs-title class_">purchaseOrder</span>.<span class="hljs-title class_">productType</span>),</li><li>      <span class="hljs-variable">purchaseToken</span>: <span class="hljs-title class_">purchaseOrder</span>.<span class="hljs-title class_">purchaseToken</span>,</li><li>      <span class="hljs-variable">purchaseOrderId</span>: <span class="hljs-title class_">purchaseOrder</span>.<span class="hljs-title class_">purchaseOrderId</span></li><li>    };</li><li>    <span class="hljs-variable">iap</span>.<span class="hljs-title function_">finishPurchase</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">finishPurchaseParam</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>      <span class="hljs-comment">// 请求成功</span></li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in finishing purchase.'</span>);</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-comment">// 请求失败</span></li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">finish</span> <span class="hljs-variable">purchase</span>. <span class="hljs-variable">Code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {}</li><li>}</li></ol></pre></div></div>   </div>   <div></div></div>