<h1 _ngcontent-dyi-c119="" class="doc-title ng-star-inserted" title="构建系统生命周期"> 构建系统生命周期 </h1>

<div _ngcontent-dyi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001778674569"><p id="ZH-CN_TOPIC_0000002510294309__p8060118">本文档对Hvigor编译构建系统结构及生命周期进行简要讲解，首先介绍Hvigor对工程结构模型的定义，随后介绍什么是任务（Task），最后会介绍Hvigor的构建生命周期以及它是如何依赖hvigor-ohos-plugin一起完成自动化编译构建流程的。</p> <div class="tiledSection"><h2 id="section9545559114020">工程结构定义<i class="anchor-icon anchor-icon-link" anchorid="section9545559114020" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510294309__p15480121014114">Hvigor将工程解析为一个树形结构，项目为树的根节点，项目中的每个模块为树的叶子节点，树最多为两层，模块中不能包含其他模块，在Hvigor的定义中统称项目或模块为一个node(节点)。</p> <p id="ZH-CN_TOPIC_0000002510294309__p157011619103718"><span><img originheight="286" originwidth="834" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104905.56611790154471730955900972640816:50001231000000:2800:1A2753A95223893216CB2BAD2508BFBEFBDA3FE3CC229DBC0B08F509C322ECEA.png" width="834" height="286"></span></p> <p id="ZH-CN_TOPIC_0000002510294309__p58181566438">在构建最开始的<a href="/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section19246144681710">初始化阶段</a>，会通过<a href="/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section810245135914">hvigorconfig.ts文件</a>以及工程级build-profile.json5文件中的配置来构造出一个树形结构存储项目的工程结构，工程级build-profile.json5文件和hvigorconfig.ts文件均可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-multi-module#section99251918477">配置多模块</a>。</p> </div> <div class="tiledSection"><h2 id="section810245135914">Hvigor脚本文件<i class="anchor-icon anchor-icon-link" anchorid="section810245135914" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510294309__p1415031017011">构建的<a href="/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section8207184919159">生命周期</a>中Hvigor使用两个脚本文件来完成插件、任务以及生命周期hook的注册：</p> <ul id="ZH-CN_TOPIC_0000002510294309__ul443542119314"><li id="li194356217319"><strong>hvigorconfig.ts</strong>：此文件在整个项目中只有根目录下存在一份，不是构建必须的文件并且默认不存在，如有需要可自行创建，此文件被解析执行的时间较早，可用于在Hvigor生命周期刚开始时操作某些数据。</li><li id="li1922315431332"><strong>hvigorfile.ts</strong>：此文件在每个node下都有一份，是构建的必须文件，在此文件中可以注册插件、任务以及生命周期hook等操作。</li></ul> </div> <div class="tiledSection"><h2 id="section194191858161220">任务与任务依赖图<i class="anchor-icon anchor-icon-link" anchorid="section194191858161220" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510294309__p9996153416618">Hvigor是基于任务对您的项目进行自动化构建的，任务（Task）是Hvigor构建过程中的基本工作单元，它定义了构建项目时需要执行的具体工作。任务可以完成多种操作，比如源码编译任务，打包任务或签名任务等。每一种任务的执行逻辑由插件（plugin）提供，插件可以是由<a href="/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section199818016213">hvigor-ohos-plugin</a>提供的默认任务逻辑，也可由您个性化定制。</p> <p id="ZH-CN_TOPIC_0000002510294309__p1264913131319">需要注意的一点是，任务是存在依赖关系的，Hvigor在执行任何任务之前会构建任务依赖图，所有任务会形成一个有向无环图（DAG），如下示例图，任务之间的依赖关系用箭头进行表示：</p> <p id="ZH-CN_TOPIC_0000002510294309__p17471141814360"><span><img originheight="716" originwidth="509" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104905.06233272970938173710262116515756:50001231000000:2800:B1D037190552DEAD214CFD3601E2A4EA7CE80C78CCD7C287596C36BA56E5EA37.png" width="509" height="716"></span></p> <p id="ZH-CN_TOPIC_0000002510294309__p185181369159">hvigor插件（hvigor-ohos-plugin）和hvigorfile.ts文件中的构建脚本都将通过任务依赖机制对任务依赖图做出影响。</p> </div> <div class="tiledSection"><h2 id="section199818016213">hvigor-ohos-plugin<i class="anchor-icon anchor-icon-link" anchorid="section199818016213" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510294309__p162061851162210">hvigor-ohos-plugin是默认的构建插件，为任务（Task）的完成提供业务逻辑支持，比如为Hvigor提供Hap、Har和Hsp打包服务等任务，每一种任务的具体执行逻辑由本模块中不同的插件来提供。</p> </div> <div class="tiledSection"><h3 id="section197018231279" class="firsth2">Hvigor与hvigor-ohos-plugin的关系<i class="anchor-icon anchor-icon-link" anchorid="section197018231279" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002510294309__p647451113493"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor">概述</a>部分提到了Hvigor提供任务注册编排以及配置管理等任务管理机制，它负责控制任务的执行流程，但是并不包含每一个任务的具体业务逻辑，具体逻辑是由hvigor-ohos-plugin提供的。</p> <p id="ZH-CN_TOPIC_0000002510294309__p495318358212">Hvigor和hvigor-ohos-plugin的关系可以通过下图来说明，Hvigor接受任务的注册并编排任务执行顺序，并按照顺序依次调用hvigor-ohos-plugin中的插件来执行任务。如果您定制了自己的任务逻辑插件并将其注册，Hvigor也会调用您的个性化插件来完成编译构建流程。</p> <p id="ZH-CN_TOPIC_0000002510294309__p38951344184410">在Hvigor执行构建的过程中，hvigor-ohos-plugin会向Hvigor进行任务的注册，Hvigor会根据构建的<a href="/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section194191858161220">任务依赖图</a>依次调用对应的插件来执行相应任务，在完成编译、打包、签名等一系列任务后，Hvigor也就正式完成了构建。</p> <p id="ZH-CN_TOPIC_0000002510294309__p11705141973717"><span><img originheight="576" originwidth="327" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104906.16721088770725436498919688794524:50001231000000:2800:961AFF8175F456C7CCAE4CC992203C6F8FB57323DACAA5A617D17CD1D4B8A7BF.png" width="327" height="576"></span></p> </div> <div class="tiledSection"><h2 id="section8207184919159">Hvigor生命周期<i class="anchor-icon anchor-icon-link" anchorid="section8207184919159" tips="复制节点链接"></i></h2><p id="ZH-CN_TOPIC_0000002510294309__p58331715808">生命周期展示了Hvigor编译构建系统如何进行一次完整的编译构建流程。Hvigor的编译构建过程有三个不同的阶段，分为初始化、配置和执行，Hvigor会按顺序运行这些阶段。</p> </div> <div class="tiledSection"><h3 id="section19246144681710" class="firsth2">初始化<i class="anchor-icon anchor-icon-link" anchorid="section19246144681710" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002510294309__p1155384911209">此阶段主要目的为初始化项目的编译参数，构造出项目结构的树形数据模型，每个node为一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-api#section14832104719474">HvigorNode</a>对象。</p> </div></div></div> <ol id="ZH-CN_TOPIC_0000002510294309__ol366961513147"><li id="li784217401531">根据命令参数和hvigor-config.json5文件中的配置，设置Hvigor的构建参数，并构造出hvigor对象和hvigorConfig对象：<ul id="ZH-CN_TOPIC_0000002510294309__ul15998445533"><li id="li4351134985317">hvigor对象贯穿整个hvigor生命周期，从最开始创建出来一直到此次构建结束才被销毁；</li><li id="li17599124435314">hvigorConfig对象用于表示hvigor对项目结构的抽象，是hvigor的简单配置对象，用于动态添加或删除节点，它也会保存对每个节点的描述对象（nodeDescriptor对象）。</li></ul> </li><li id="li1578152071416">通过项目根目录下的build-profile.json5文件，创建出<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-api#section1914012226435">rootNodeDescriptor</a>实例，并通过其中的modules字段，来初始化出工程中所有模块的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-api#section1914012226435">NodeDescriptor</a>对象实例。</li><li id="li121851752111616">执行项目根目录下的hvigorconfig.ts文件，可以在此文件中通过hvigor的相关API来为生命周期注册hook或在构建开始时进行其他处理。</li><li id="li2688185491816">根据节点描述对象构造出每个节点的HvigorNode对象实例。</li></ol> </div> <div class="tiledSection"><h3 id="section56629116280">配置<i class="anchor-icon anchor-icon-link" anchorid="section56629116280" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002510294309__p39611724112811">此阶段开始时，所有的node都已经加载完毕，但每个node中还没有加载插件（plugin）、任务（task）和DAG图，此阶段的主要目的就是加载出这些内容。</p> </div></div></div> <ol id="ZH-CN_TOPIC_0000002510294309__ol1096152452813"><li id="li1396142432811">执行每个node中的hvigorfile.ts文件，为每个node添加插件（向Hvigor注册任务），执行插件的apply方法，并添加插件的上下文。</li><li id="li1796111247285">基于上一步加载的插件和任务，根据任务执行的依赖关系构造出DAG图。</li></ol> </div> <div class="tiledSection"><h3 id="section831740152812">执行<i class="anchor-icon anchor-icon-link" anchorid="section831740152812" tips="复制节点链接"></i></h3><ul id="ZH-CN_TOPIC_0000002510294309__ul7327101712381"><li id="li2327117173815">执行选定的任务。</li><li id="li53279171380">任务之间的依赖关系决定了任务执行顺序。</li><li id="li133271217133815">任务可以并行执行。</li></ul> </div> <div class="tiledSection"><h3 id="section746253616316">生命周期及hook点<i class="anchor-icon anchor-icon-link" anchorid="section746253616316" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002510294309__p392115542315">在Hvigor的生命周期中，以下多个hook点可供您使用，便于您在对应的时机调用某些逻辑。</p> <p id="ZH-CN_TOPIC_0000002510294309__p1892214546317">在下图中所有绿色标记的线框为可以使用的hook点。每个hook点的使用方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-api">基础构建能力</a>。</p> <p id="ZH-CN_TOPIC_0000002510294309__p118412136523"><span><img originheight="641" originwidth="800" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104906.67310237078504067872710156785142:50001231000000:2800:80A944D54620A129E68C4925E6DB39F4EB78EFB5B95C12DF5801E739EDFA2333.png" width="800" height="641"></span></p> </div> </div> <div></div></div>