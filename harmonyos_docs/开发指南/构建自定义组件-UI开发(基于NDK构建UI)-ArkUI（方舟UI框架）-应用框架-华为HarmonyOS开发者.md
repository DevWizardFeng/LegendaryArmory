<h1 _ngcontent-hxp-c119="" class="doc-title ng-star-inserted" title="构建自定义组件"> 构建自定义组件 </h1>

<div _ngcontent-hxp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>ArkUI开发框架在NDK接口提供了自定义UI组件的能力，这些能力包括自定义测算，自定义布局和自定义绘制。开发者通过注册相关自定义回调事件接入ArkUI开发框架的布局渲染流程，这些事件需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#registernodecustomevent" target="_blank">registerNodeCustomEvent</a>来进行声明，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#addnodecustomeventreceiver" target="_blank">addNodeCustomEventReceiver</a>函数添加组件自定义事件的监听器，在该监听器的回调函数中处理相关自定义测算，自定义布局和自定义绘制逻辑。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>        <p>自定义组件事件注册需要<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#addnodecustomeventreceiver" target="_blank">addNodeCustomEventReceiver</a>声明监听器注册和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#registernodecustomevent" target="_blank">registerNodeCustomEvent</a>声明需要的自定义事件类型，监听器只能监听已声明的事件。</p></li>       <li>        <p>需要关注事件的反注册逻辑，如在组件销毁前调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#removenodecustomeventreceiver" target="_blank">removeNodeCustomEventReceiver</a>移除事件监听器，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#unregisternodecustomevent" target="_blank">unregisterNodeCustomEvent</a>通知ArkUI框架已监听的自定义组件事件不再需要监听。</p></li>       <li>        <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#addnodecustomeventreceiver" target="_blank">addNodeCustomEventReceiver</a>可以添加多个函数指针，每个函数指针都会在对应事件触发时触发，对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#removenodecustomeventreceiver" target="_blank">removeNodeCustomEventReceiver</a>需要传递对应的函数指针用于移除监听。</p></li>       <li>        <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#registernodecustomeventreceiver" target="_blank">registerNodeCustomEventReceiver</a>是全局监听函数，不同于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#addnodecustomeventreceiver" target="_blank">addNodeCustomEventReceiver</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#registernodecustomeventreceiver" target="_blank">registerNodeCustomEventReceiver</a>能够监听所有Native组件的自定义事件触发，但只能传递一个函数指针，多次调用使用最后一次的函数指针进行回调，释放时使用unregisterNodeCustomEventReceiver进行反注册。</p></li>       <li>        <p>自定义组件相关接口（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#measurenode" target="_blank">measureNode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#layoutnode" target="_blank">layoutNode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#setmeasuredsize" target="_blank">setMeasuredSize</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#setlayoutposition" target="_blank">setLayoutPosition</a>）仅允许在对应的自定义事件（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#arkui_nodecustomeventtype" target="_blank">ARKUI_NODE_CUSTOM_EVENT_ON_MEASURE、ARKUI_NODE_CUSTOM_EVENT_ON_LAYOUT</a>）回调中使用。</p></li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="自定义布局容器">自定义布局容器<i class="anchor-icon anchor-icon-link" anchorid="自定义布局容器" tips="复制节点链接"></i></h2>          <p>以下示例创建了一个自定义容器，该容器将子组件最大值加上额外边距作为自身大小，同时对子组件进行居中排布。</p>     <p><strong>图1</strong> 自定义容器组件</p>     <p><span><img originheight="671" originwidth="347" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114746.82944546759701373016080985875891:50001231000000:2800:6D3F056CEC429D7A40A1AED4D610285E40356745AC9ADBB1FA0437B9982B26B3.png" width="347" height="671"></span></p>     <ol>      <li>       <p>按照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-access-the-arkts-page">接入ArkTS页面</a>创建前置工程。</p></li>      <li>       <p>创建自定义容器组件封装对象。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUICustomContainerNode.h</span></li><li><span class="hljs-comment">// 自定义容器组件示例</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUICUSTOMCONTAINERNODE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUICUSTOMCONTAINERNODE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUINode.h"</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUICustomContainerNode</span> :</span> public ArkUINode {</li><li>public:</li><li>    <span class="hljs-comment">// 使用自定义组件类型ARKUI_NODE_CUSTOM创建组件。</span></li><li>    ArkUICustomContainerNode()</li><li>        : ArkUINode((NativeModuleInstance::GetInstance()-&gt;GetNativeNodeAPI())-&gt;createNode(ARKUI_NODE_CUSTOM)) {</li><li>        <span class="hljs-comment">// 注册自定义事件监听器。</span></li><li>        nativeModule_-&gt;addNodeCustomEventReceiver(handle_, OnStaticCustomEvent);</li><li>        <span class="hljs-comment">// 声明自定义事件并传递自身作为自定义数据。</span></li><li>        nativeModule_-&gt;registerNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_MEASURE, <span class="hljs-number">0</span>, this);</li><li>        nativeModule_-&gt;registerNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_LAYOUT, <span class="hljs-number">0</span>, this);</li><li>    }</li><li>
</li><li>    ~ArkUICustomContainerNode() override {</li><li>        <span class="hljs-comment">// 反注册自定义事件监听器。</span></li><li>        nativeModule_-&gt;removeNodeCustomEventReceiver(handle_, OnStaticCustomEvent);</li><li>        <span class="hljs-comment">// 取消声明自定义事件。</span></li><li>        nativeModule_-&gt;unregisterNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_MEASURE);</li><li>        nativeModule_-&gt;unregisterNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_LAYOUT);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetPadding</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> padding)</span> {</li><li>        padding_ = padding;</li><li>        <span class="hljs-comment">// 自定义属性事件更新需要主动调用标记脏区接口。</span></li><li>        nativeModule_-&gt;markDirty(handle_, NODE_NEED_MEASURE);</li><li>    }</li><li>
</li><li>private:</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">OnStaticCustomEvent</span><span class="hljs-params">(ArkUI_NodeCustomEvent *event)</span> {</li><li>        <span class="hljs-comment">// 获取组件实例对象，调用相关实例方法。</span></li><li>        <span class="hljs-keyword">auto</span> customNode = reinterpret_cast&lt;ArkUICustomContainerNode *&gt;(OH_ArkUI_NodeCustomEvent_GetUserData(event));</li><li>        <span class="hljs-keyword">auto</span> type = OH_ArkUI_NodeCustomEvent_GetEventType(event);</li><li>        <span class="hljs-keyword">switch</span> (type) {</li><li>        <span class="hljs-keyword">case</span> ARKUI_NODE_CUSTOM_EVENT_ON_MEASURE:</li><li>            customNode-&gt;OnMeasure(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> ARKUI_NODE_CUSTOM_EVENT_ON_LAYOUT:</li><li>            customNode-&gt;OnLayout(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">default</span>:</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 自定义测算逻辑。</span></li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnMeasure</span><span class="hljs-params">(ArkUI_NodeCustomEvent *event)</span> {</li><li>        <span class="hljs-keyword">auto</span> layoutConstrain = OH_ArkUI_NodeCustomEvent_GetLayoutConstraintInMeasure(event);</li><li>        <span class="hljs-comment">// 创建子节点布局限制，复用父组件布局中的百分比参考值。</span></li><li>        <span class="hljs-keyword">auto</span> childLayoutConstrain = OH_ArkUI_LayoutConstraint_Copy(layoutConstrain);</li><li>        OH_ArkUI_LayoutConstraint_SetMaxHeight(childLayoutConstrain, <span class="hljs-number">1000</span>);</li><li>        OH_ArkUI_LayoutConstraint_SetMaxWidth(childLayoutConstrain, <span class="hljs-number">1000</span>);</li><li>        OH_ArkUI_LayoutConstraint_SetMinHeight(childLayoutConstrain, <span class="hljs-number">0</span>);</li><li>        OH_ArkUI_LayoutConstraint_SetMinWidth(childLayoutConstrain, <span class="hljs-number">0</span>);</li><li>
</li><li>        <span class="hljs-comment">// 测算子节点获取子节点最大值。</span></li><li>        <span class="hljs-keyword">auto</span> totalSize = nativeModule_-&gt;getTotalChildCount(handle_);</li><li>        <span class="hljs-type">int32_t</span> maxWidth = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-type">int32_t</span> maxHeight = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; totalSize; i++) {</li><li>            <span class="hljs-keyword">auto</span> child = nativeModule_-&gt;getChildAt(handle_, i);</li><li>            <span class="hljs-comment">// 调用测算接口测算Native组件。</span></li><li>            nativeModule_-&gt;measureNode(child, childLayoutConstrain);</li><li>            <span class="hljs-keyword">auto</span> size = nativeModule_-&gt;getMeasuredSize(child);</li><li>            <span class="hljs-keyword">if</span> (size.width &gt; maxWidth) {</li><li>                maxWidth = size.width;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (size.height &gt; maxHeight) {</li><li>                maxHeight = size.height;</li><li>            }</li><li>        }</li><li>        <span class="hljs-comment">// 自定义测算为所有子节点大小加固定边距。该自定义节点最终的尺寸以此处设置的值为准。</span></li><li>        nativeModule_-&gt;setMeasuredSize(handle_, maxWidth + <span class="hljs-number">2</span> * padding_, maxHeight + <span class="hljs-number">2</span> * padding_);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnLayout</span><span class="hljs-params">(ArkUI_NodeCustomEvent *event)</span> {</li><li>        <span class="hljs-comment">// 获取父组件期望位置并设置。</span></li><li>        <span class="hljs-keyword">auto</span> position = OH_ArkUI_NodeCustomEvent_GetPositionInLayout(event);</li><li>        nativeModule_-&gt;setLayoutPosition(handle_, position.x, position.y);</li><li>
</li><li>        <span class="hljs-comment">// 设置子组件居中对齐。</span></li><li>        <span class="hljs-keyword">auto</span> totalSize = nativeModule_-&gt;getTotalChildCount(handle_);</li><li>        <span class="hljs-keyword">auto</span> selfSize = nativeModule_-&gt;getMeasuredSize(handle_);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; totalSize; i++) {</li><li>            <span class="hljs-keyword">auto</span> child = nativeModule_-&gt;getChildAt(handle_, i);</li><li>            <span class="hljs-comment">// 获取子组件大小。</span></li><li>            <span class="hljs-keyword">auto</span> childSize = nativeModule_-&gt;getMeasuredSize(child);</li><li>            <span class="hljs-comment">// 布局子组件位置。</span></li><li>            nativeModule_-&gt;layoutNode(child, (selfSize.width - childSize.width) / <span class="hljs-number">2</span>,</li><li>                                      (selfSize.height - childSize.height) / <span class="hljs-number">2</span>);</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-type">int32_t</span> padding_ = <span class="hljs-number">100</span>;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUICUSTOMCONTAINERNODE_H</span></span></li></ol></pre></div></div></li>      <li>       <p>使用自定义容器创建带文本的示例界面，并沿用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-embed-arkts-components">定时器模块相关简单实现</a>。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// NativeEntry.cpp</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NativeEntry.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUICustomContainerNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUITextNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"UITimer.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node_napi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_type.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>namespace {</li><li>napi_env g_env;</li><li>} <span class="hljs-comment">// namespace</span></li><li>
</li><li>napi_value <span class="hljs-title function_">CreateNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</li><li>
</li><li>    <span class="hljs-comment">// 获取NodeContent</span></li><li>    ArkUI_NodeContentHandle contentHandle;</li><li>    OH_ArkUI_GetNodeContentFromNapiValue(env, args[<span class="hljs-number">0</span>], &amp;contentHandle);</li><li>    NativeEntry::GetInstance()-&gt;SetContentHandle(contentHandle);</li><li>
</li><li>    <span class="hljs-comment">// 创建自定义容器和文本组件。</span></li><li>    <span class="hljs-keyword">auto</span> node = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUICustomContainerNode&gt;();</li><li>    node-&gt;SetBackgroundColor(<span class="hljs-number">0xFFE0FFFF</span>);</li><li>    <span class="hljs-keyword">auto</span> textNode = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUITextNode&gt;();</li><li>    textNode-&gt;SetTextContent(<span class="hljs-string">"CustomContainer Example"</span>);</li><li>    textNode-&gt;SetFontSize(<span class="hljs-number">16</span>);</li><li>    textNode-&gt;SetBackgroundColor(<span class="hljs-number">0xFFfffacd</span>);</li><li>    textNode-&gt;SetTextAlign(ARKUI_TEXT_ALIGNMENT_CENTER);</li><li>    node-&gt;AddChild(textNode);</li><li>    CreateNativeTimer(env, textNode.get(), <span class="hljs-number">1</span>, [](<span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> count) {</li><li>        <span class="hljs-keyword">auto</span> textNode = reinterpret_cast&lt;ArkUITextNode *&gt;(userData);</li><li>        textNode-&gt;SetFontColor(<span class="hljs-number">0xFF00FF7F</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 保持Native侧对象到管理类中，维护生命周期。</span></li><li>    NativeEntry::GetInstance()-&gt;SetRootNode(node);</li><li>    g_env = env;</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>napi_value <span class="hljs-title function_">DestroyNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-comment">// 从管理类中释放Native侧对象。</span></li><li>    NativeEntry::GetInstance()-&gt;DisposeRootNode();</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li></ol></pre></div></div></li>      <li>       <p>修改CMakeList.txt，添加链接库。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>  # CMakeLists.txt</li><li>
</li><li>  <span class="hljs-meta"># the minimum version of CMake.</span></li><li>  <span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span><span class="hljs-number">.1</span>)</li><li>  <span class="hljs-built_in">project</span>(testndk)</li><li>
</li><li>  <span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>  <span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                       ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li>  <span class="hljs-built_in">add_library</span>(entry SHARED NativeEntry.cpp napi_init.cpp)</li><li>  # <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so, libace_ndk.z.so, libhilog_ndk.z.so)</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       hilog-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       hilog_ndk.z</li><li>   )</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libace-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_ndk.z</li><li>   )</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libnapi-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_napi.z</li><li>   )</li><li>
</li><li>   <span class="hljs-built_in">find_library</span>(</li><li>        # Sets the name of the path variable.</li><li>        libuv-lib</li><li>        uv</li><li>    )</li><li>
</li><li>  <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC</li><li>       ${hilog-lib} ${libace-lib} ${libnapi-lib} ${libuv-lib} )</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="自定义绘制组件">自定义绘制组件<i class="anchor-icon anchor-icon-link" anchorid="自定义绘制组件" tips="复制节点链接"></i></h2>          <p>以下示例创建了一个自定义绘制组件，该绘制组件能够绘制自定义矩形，并使用上述自定义容器进行布局排布。</p>     <p><strong>图2</strong> 自定义绘制组件</p>     <p></p>     <p><span><img originheight="664" originwidth="335" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114746.14652943816309797740800014793874:50001231000000:2800:403DA754CE3CA3D4C793701CCB7A8A265AFB7ADA77B8CD9CF93FA5D54C3B5615.png" width="335" height="664"></span></p>     <ol>      <li>       <p>按照<a href="/consumer/cn/doc/harmonyos-guides/ndk-build-custom-components#自定义布局容器">自定义布局容器</a>章节准备前置工程。</p></li>      <li>       <p>创建自定义绘制组件封装对象。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUICustomNode.h</span></li><li><span class="hljs-comment">// 自定义绘制组件示例</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUICUSTOMNODE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUICUSTOMNODE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_drawing/drawing_brush.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_drawing/drawing_canvas.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_drawing/drawing_path.h&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUINode.h"</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUICustomNode</span> :</span> public ArkUINode {</li><li>public:</li><li>    <span class="hljs-comment">// 使用自定义组件类型ARKUI_NODE_CUSTOM创建组件。</span></li><li>    ArkUICustomNode()</li><li>        : ArkUINode((NativeModuleInstance::GetInstance()-&gt;GetNativeNodeAPI())-&gt;createNode(ARKUI_NODE_CUSTOM)) {</li><li>        <span class="hljs-comment">// 注册自定义事件监听器。</span></li><li>        nativeModule_-&gt;addNodeCustomEventReceiver(handle_, OnStaticCustomEvent);</li><li>        <span class="hljs-comment">// 声明自定义事件并传递自身作为自定义数据。</span></li><li>        nativeModule_-&gt;registerNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_DRAW, <span class="hljs-number">0</span>, this);</li><li>    }</li><li>
</li><li>    ~ArkUICustomNode() override {</li><li>        <span class="hljs-comment">// 反注册自定义事件监听器。</span></li><li>        nativeModule_-&gt;removeNodeCustomEventReceiver(handle_, OnStaticCustomEvent);</li><li>        <span class="hljs-comment">// 取消声明自定义事件。</span></li><li>        nativeModule_-&gt;unregisterNodeCustomEvent(handle_, ARKUI_NODE_CUSTOM_EVENT_ON_DRAW);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetRectColor</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> color)</span> {</li><li>        color_ = color;</li><li>        <span class="hljs-comment">// 自定义绘制属性变更需要主动通知框架。</span></li><li>        nativeModule_-&gt;markDirty(handle_, NODE_NEED_RENDER);</li><li>    }</li><li>
</li><li>private:</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">OnStaticCustomEvent</span><span class="hljs-params">(ArkUI_NodeCustomEvent *event)</span> {</li><li>        <span class="hljs-comment">// 获取组件实例对象，调用相关实例方法。</span></li><li>        <span class="hljs-keyword">auto</span> customNode = reinterpret_cast&lt;ArkUICustomNode *&gt;(OH_ArkUI_NodeCustomEvent_GetUserData(event));</li><li>        <span class="hljs-keyword">auto</span> type = OH_ArkUI_NodeCustomEvent_GetEventType(event);</li><li>        <span class="hljs-keyword">switch</span> (type) {</li><li>        <span class="hljs-keyword">case</span> ARKUI_NODE_CUSTOM_EVENT_ON_DRAW:</li><li>            customNode-&gt;OnDraw(event);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">default</span>:</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 自定义绘制逻辑。</span></li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">OnDraw</span><span class="hljs-params">(ArkUI_NodeCustomEvent *event)</span> {</li><li>        <span class="hljs-keyword">auto</span> drawContext = OH_ArkUI_NodeCustomEvent_GetDrawContextInDraw(event);</li><li>        <span class="hljs-comment">// 获取图形绘制对象。</span></li><li>        <span class="hljs-keyword">auto</span> drawCanvas = reinterpret_cast&lt;OH_Drawing_Canvas *&gt;(OH_ArkUI_DrawContext_GetCanvas(drawContext));</li><li>        <span class="hljs-comment">// 获取组件大小。</span></li><li>        <span class="hljs-keyword">auto</span> size = OH_ArkUI_DrawContext_GetSize(drawContext);</li><li>        <span class="hljs-comment">// 绘制自定义内容。</span></li><li>        <span class="hljs-keyword">auto</span> path = OH_Drawing_PathCreate();</li><li>        OH_Drawing_PathMoveTo(path, size.width / <span class="hljs-number">4</span>, size.height / <span class="hljs-number">4</span>);</li><li>        OH_Drawing_PathLineTo(path, size.width * <span class="hljs-number">3</span> / <span class="hljs-number">4</span>, size.height / <span class="hljs-number">4</span>);</li><li>        OH_Drawing_PathLineTo(path, size.width * <span class="hljs-number">3</span> / <span class="hljs-number">4</span>, size.height * <span class="hljs-number">3</span> / <span class="hljs-number">4</span>);</li><li>        OH_Drawing_PathLineTo(path, size.width / <span class="hljs-number">4</span>, size.height * <span class="hljs-number">3</span> / <span class="hljs-number">4</span>);</li><li>        OH_Drawing_PathLineTo(path, size.width / <span class="hljs-number">4</span>, size.height / <span class="hljs-number">4</span>);</li><li>        OH_Drawing_PathClose(path);</li><li>        <span class="hljs-keyword">auto</span> brush = OH_Drawing_BrushCreate();</li><li>        OH_Drawing_BrushSetColor(brush, color_);</li><li>        OH_Drawing_CanvasAttachBrush(drawCanvas, brush);</li><li>        OH_Drawing_CanvasDrawPath(drawCanvas, path);</li><li>        <span class="hljs-comment">// 释放资源</span></li><li>        OH_Drawing_BrushDestroy(brush);</li><li>        OH_Drawing_PathDestroy(path);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">uint32_t</span> color_ = <span class="hljs-number">0xFFFFE4B5</span>;</li><li>};</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUICUSTOMNODE_H</span></span></li></ol></pre></div></div></li>      <li>       <p>使用自定义绘制组件和自定义容器创建示例界面，并沿用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-embed-arkts-components">定时器模块相关简单实现</a>。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// NativeEntry.cpp</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"NativeEntry.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUICustomContainerNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUICustomNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"UITimer.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node_napi.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_type.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>namespace {</li><li>napi_env g_env;</li><li>} <span class="hljs-comment">// namespace</span></li><li>
</li><li>napi_value <span class="hljs-title function_">CreateNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(env, info, &amp;argc, args, nullptr, nullptr);</li><li>
</li><li>    <span class="hljs-comment">// 获取NodeContent</span></li><li>    ArkUI_NodeContentHandle contentHandle;</li><li>    OH_ArkUI_GetNodeContentFromNapiValue(env, args[<span class="hljs-number">0</span>], &amp;contentHandle);</li><li>    NativeEntry::GetInstance()-&gt;SetContentHandle(contentHandle);</li><li>
</li><li>    <span class="hljs-comment">// 创建自定义容器和自定义绘制组件。</span></li><li>    <span class="hljs-keyword">auto</span> node = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUICustomContainerNode&gt;();</li><li>    node-&gt;SetBackgroundColor(<span class="hljs-number">0xFFE0FFFF</span>);</li><li>    <span class="hljs-keyword">auto</span> customNode = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUICustomNode&gt;();</li><li>    customNode-&gt;SetBackgroundColor(<span class="hljs-number">0xFFD3D3D3</span>);</li><li>    customNode-&gt;SetWidth(<span class="hljs-number">150</span>);</li><li>    customNode-&gt;SetHeight(<span class="hljs-number">150</span>);</li><li>    node-&gt;AddChild(customNode);</li><li>    CreateNativeTimer(env, customNode.get(), <span class="hljs-number">1</span>, [](<span class="hljs-type">void</span> *userData, <span class="hljs-type">int32_t</span> count) {</li><li>        <span class="hljs-keyword">auto</span> customNode = reinterpret_cast&lt;ArkUICustomNode *&gt;(userData);</li><li>        customNode-&gt;SetRectColor(<span class="hljs-number">0xFF00FF7F</span>);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// 保持Native侧对象到管理类中，维护生命周期。</span></li><li>    NativeEntry::GetInstance()-&gt;SetRootNode(node);</li><li>    g_env = env;</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>napi_value <span class="hljs-title function_">DestroyNativeRoot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> {</li><li>    <span class="hljs-comment">// 从管理类中释放Native侧对象。</span></li><li>    NativeEntry::GetInstance()-&gt;DisposeRootNode();</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>
</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li></ol></pre></div></div></li>      <li>       <p>修改CMakeList.txt，添加链接库。</p>       <div _ngcontent-hxp-c106="" class="highlight-div"><div _ngcontent-hxp-c106="" class="highlight-div-header"><div _ngcontent-hxp-c106="" class="highlight-div-header-left"><div _ngcontent-hxp-c106="" class="handle-button expand-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hxp-c106="" class="highlight-div-header-right"><div _ngcontent-hxp-c106="" class="handle-button ai-button"></div><div _ngcontent-hxp-c106="" class="handle-button line-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hxp-c106="" class="handle-button theme-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hxp-c106="" class="handle-button copy-button"><div _ngcontent-hxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hxp-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>  # CMakeLists.txt</li><li>
</li><li>  <span class="hljs-meta"># the minimum version of CMake.</span></li><li>  <span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span><span class="hljs-number">.1</span>)</li><li>  <span class="hljs-built_in">project</span>(testndk)</li><li>
</li><li>  <span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li>  <span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                       ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li>  <span class="hljs-built_in">add_library</span>(entry SHARED NativeEntry.cpp napi_init.cpp)</li><li>  # <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so, libace_ndk.z.so, libhilog_ndk.z.so)</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       hilog-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       hilog_ndk.z</li><li>   )</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libace-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_ndk.z</li><li>   )</li><li>
</li><li>  <span class="hljs-built_in">find_library</span>(</li><li>       # Sets the name of the path variable.</li><li>       libnapi-lib</li><li>       # Specifies the name of the NDK library that</li><li>       <span class="hljs-meta"># you want CMake to locate.</span></li><li>       ace_napi.z</li><li>   )</li><li>
</li><li>   <span class="hljs-built_in">find_library</span>(</li><li>        # Sets the name of the path variable.</li><li>        libuv-lib</li><li>        uv</li><li>    )</li><li>
</li><li>  <span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC</li><li>       ${hilog-lib} ${libace-lib} ${libnapi-lib} ${libuv-lib} libnative_drawing.so)</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>