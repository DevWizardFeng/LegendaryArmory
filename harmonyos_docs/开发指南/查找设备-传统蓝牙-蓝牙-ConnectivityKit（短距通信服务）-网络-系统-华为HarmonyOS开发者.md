<h1 _ngcontent-lcl-c119="" class="doc-title ng-star-inserted" title="查找设备"> 查找设备 </h1>

<div _ngcontent-lcl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本指南主要提供了查找设备相关的开发指导，包括如何扫描周边设备、设置本机蓝牙扫描模式以及查找已配对设备信息。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="申请蓝牙权限" class="firsth2">申请蓝牙权限<i class="anchor-icon anchor-icon-link" anchorid="申请蓝牙权限" tips="复制节点链接"></i></h3>          <p>需要申请权限ohos.permission.ACCESS_BLUETOOTH。如何配置和申请权限，具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>    </div>    <div class="tiledSection">     <h3 id="导入所需api模块">导入所需API模块<i class="anchor-icon anchor-icon-link" anchorid="导入所需api模块" tips="复制节点链接"></i></h3>          <p>导入connection和错误码模块。</p>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { connection } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="扫描周边蓝牙设备">扫描周边蓝牙设备<i class="anchor-icon anchor-icon-link" anchorid="扫描周边蓝牙设备" tips="复制节点链接"></i></h3>          <p>用于扫描周边支持蓝牙能力的设备，并获取到蓝牙设备的部分信息。此过程也可被称为“搜索”、“发现”或“查找”。只有周边蓝牙设备处于可被发现的状态时，才能被本机蓝牙设备扫描到。</p>     <p><strong>1. 订阅扫描设备结果上报事件</strong></p>     <ul>      <li>推荐使用API version 18开始支持的扫描结果上报方式。该方式可获取到更多设备信息，包括设备地址、设备信号强度、设备名称和设备类型。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectionondiscoveryresult18" target="_blank">connection.on('discoveryResult')</a>。</li>     </ul>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;connection.DiscoveryResult&gt;</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth device: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'discoveryResult'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>API version 17及以前的扫描结果上报方式只支持获取设备地址信息。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectiononbluetoothdevicefind" target="_blank">connection.on('bluetoothDeviceFind')</a>。</li>     </ul>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth device: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bluetoothDeviceFind'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>2. 发起设备扫描</strong></p>     <p>应用发起扫描后，整个扫描过程大约持续12s。应用可以对扫描到的蓝牙设备发起配对、连接和传输数据流程。具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/br-pair-device-development-guide">配对连接设备</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/spp-development-guide">连接和传输数据</a>。</p>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 判断本机设备是否正在进行扫描</span></li><li>  <span class="hljs-keyword">let</span> scan = connection.<span class="hljs-title function_">isBluetoothDiscovering</span>();</li><li>  <span class="hljs-keyword">if</span> (!scan) {</li><li>    <span class="hljs-comment">// 若当前不处于扫描过程，则开始扫描设备</span></li><li>    connection.<span class="hljs-title function_">startBluetoothDiscovery</span>();</li><li>  }</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 停止设备扫描</strong></p>     <p>扫描是一个很消耗蓝牙硬件资源的过程。当扫描到应用所需的蓝牙设备后，在发起连接前，必须停止设备扫描。</p>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth device: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 判断本机设备是否正在进行扫描</span></li><li>  <span class="hljs-keyword">let</span> scan = connection.<span class="hljs-title function_">isBluetoothDiscovering</span>();</li><li>  <span class="hljs-keyword">if</span> (scan) {</li><li>    <span class="hljs-comment">// 若当前处于扫描过程，则停止扫描设备</span></li><li>    connection.<span class="hljs-title function_">stopBluetoothDiscovery</span>();</li><li>  }</li><li>  <span class="hljs-comment">// 若不再需要使用扫描，可以取消订阅扫描上报结果</span></li><li>  connection.<span class="hljs-title function_">off</span>(<span class="hljs-string">'bluetoothDeviceFind'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置本机蓝牙扫描模式">设置本机蓝牙扫描模式<i class="anchor-icon anchor-icon-link" anchorid="设置本机蓝牙扫描模式" tips="复制节点链接"></i></h3>          <p>本机蓝牙扫描模式用于控制本机设备是否可以被周边其他蓝牙设备扫描到或连接上。非系统应用一般不用关注这个模式，系统设置应用会决定如何设置。</p>     <ul>      <li>系统设置应用打开蓝牙后，若系统蓝牙设置界面在前台，会将本机蓝牙扫描模式设置为可被扫描和可被连接，即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#scanmode" target="_blank">SCAN_MODE_CONNECTABLE_GENERAL_DISCOVERABLE</a>。</li>      <li>系统设置应用打开蓝牙后，若系统蓝牙设置界面在后台，会将本机蓝牙扫描模式设置为可被连接，即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#scanmode" target="_blank">SCAN_MODE_CONNECTABLE</a>。</li>     </ul>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 获取当前本机的扫描模式</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">scanMode</span>: connection.<span class="hljs-property">ScanMode</span> = connection.<span class="hljs-title function_">getBluetoothScanMode</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'scanMode: '</span> + scanMode);</li><li>  <span class="hljs-keyword">if</span> (scanMode != connection.<span class="hljs-property">ScanMode</span>.<span class="hljs-property">SCAN_MODE_CONNECTABLE_GENERAL_DISCOVERABLE</span>) {</li><li>    <span class="hljs-comment">// 将本机设备的扫描模式设置为可被发现和可被连接</span></li><li>    connection.<span class="hljs-title function_">setBluetoothScanMode</span>(connection.<span class="hljs-property">ScanMode</span>.<span class="hljs-property">SCAN_MODE_CONNECTABLE_GENERAL_DISCOVERABLE</span>, <span class="hljs-number">0</span>);</li><li>  }</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="查找已配对设备信息">查找已配对设备信息<i class="anchor-icon anchor-icon-link" anchorid="查找已配对设备信息" tips="复制节点链接"></i></h3>          <p>在发起扫描设备前，可以查找该设备是否是已配对的设备，以减少扫描设备的流程。也可以对已配对设备发起连接和传输数据流程，具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/br-pair-device-development-guide">配对连接设备</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/spp-development-guide">传输数据</a>。</p>     <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 获取已配对设备信息</span></li><li>  <span class="hljs-keyword">let</span> devices = connection.<span class="hljs-title function_">getPairedDevices</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pairedDevices: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(devices));</li><li>  <span class="hljs-comment">// 若已知道设备地址，可主动查询该设备是否是已配对的</span></li><li>  <span class="hljs-keyword">if</span> (devices.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">let</span> pairState = connection.<span class="hljs-title function_">getPairState</span>(devices[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device: '</span>+ devices[<span class="hljs-number">0</span>] + <span class="hljs-string">' pairState is '</span> + pairState);</li><li>  }</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-lcl-c106="" class="highlight-div"><div _ngcontent-lcl-c106="" class="highlight-div-header"><div _ngcontent-lcl-c106="" class="highlight-div-header-left"><div _ngcontent-lcl-c106="" class="handle-button expand-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lcl-c106="" class="highlight-div-header-right"><div _ngcontent-lcl-c106="" class="handle-button ai-button"></div><div _ngcontent-lcl-c106="" class="handle-button line-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lcl-c106="" class="handle-button theme-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lcl-c106="" class="handle-button copy-button"><div _ngcontent-lcl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lcl-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { connection } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiscoveryDeviceManager</span> {</li><li>  <span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li>  onReceiveEvent = <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth device: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startDiscovery</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bluetoothDeviceFind'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 判断本机设备是否正在进行扫描</span></li><li>      <span class="hljs-keyword">let</span> scan = connection.<span class="hljs-title function_">isBluetoothDiscovering</span>();</li><li>      <span class="hljs-keyword">if</span> (!scan) {</li><li>        <span class="hljs-comment">// 若当前不处于扫描过程，则开始扫描设备</span></li><li>        connection.<span class="hljs-title function_">startBluetoothDiscovery</span>();</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stopDiscovery</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 判断本机设备是否正在进行扫描</span></li><li>      <span class="hljs-keyword">let</span> scan = connection.<span class="hljs-title function_">isBluetoothDiscovering</span>();</li><li>      <span class="hljs-keyword">if</span> (scan) {</li><li>        <span class="hljs-comment">// 若当前处于扫描过程，则停止扫描设备</span></li><li>        connection.<span class="hljs-title function_">stopBluetoothDiscovery</span>();</li><li>      }</li><li>      <span class="hljs-comment">// 若不再需要使用扫描，可以取消订阅扫描上报结果</span></li><li>      connection.<span class="hljs-title function_">off</span>(<span class="hljs-string">'bluetoothDeviceFind'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setScanMode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取当前本机的扫描模式</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">scanMode</span>: connection.<span class="hljs-property">ScanMode</span> = connection.<span class="hljs-title function_">getBluetoothScanMode</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'scanMode: '</span> + scanMode);</li><li>      <span class="hljs-keyword">if</span> (scanMode != connection.<span class="hljs-property">ScanMode</span>.<span class="hljs-property">SCAN_MODE_CONNECTABLE_GENERAL_DISCOVERABLE</span>) {</li><li>        <span class="hljs-comment">// 将本机设备的扫描模式设为可被发现和可被连接</span></li><li>        connection.<span class="hljs-title function_">setBluetoothScanMode</span>(connection.<span class="hljs-property">ScanMode</span>.<span class="hljs-property">SCAN_MODE_CONNECTABLE_GENERAL_DISCOVERABLE</span>, <span class="hljs-number">0</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getPairedDevices</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取已配对设备信息</span></li><li>      <span class="hljs-keyword">let</span> devices = connection.<span class="hljs-title function_">getPairedDevices</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pairedDevices: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(devices));</li><li>      <span class="hljs-comment">// 若已知道设备地址，可主动查询该设备是否是已配对的</span></li><li>      <span class="hljs-keyword">if</span> (devices.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">let</span> pairState = connection.<span class="hljs-title function_">getPairState</span>(devices[<span class="hljs-number">0</span>]);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device: '</span>+ devices[<span class="hljs-number">0</span>] + <span class="hljs-string">' pairState is '</span> + pairState);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> discoveryDeviceManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiscoveryDeviceManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> discoveryDeviceManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">DiscoveryDeviceManager</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>