<h1 _ngcontent-irr-c119="" class="doc-title ng-star-inserted" title="查找设备"> 查找设备 </h1>

<div _ngcontent-irr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本指南主要提供了BLE扫描和BLE广播相关操作的开发指导。可以实现发现周边BLE设备和其他设备发现本机设备的场景。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="申请蓝牙权限" class="firsth2">申请蓝牙权限<i class="anchor-icon anchor-icon-link" anchorid="申请蓝牙权限" tips="复制节点链接"></i></h3>          <p>需要申请权限ohos.permission.ACCESS_BLUETOOTH。如何配置和申请权限，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>    </div>    <div class="tiledSection">     <h3 id="导入所需api模块">导入所需API模块<i class="anchor-icon anchor-icon-link" anchorid="导入所需api模块" tips="复制节点链接"></i></h3>          <p>导入ble和错误码模块。</p>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="ble扫描流程">BLE扫描流程<i class="anchor-icon anchor-icon-link" anchorid="ble扫描流程" tips="复制节点链接"></i></h3>          <p><strong>1. 订阅扫描结果上报事件</strong></p>     <ul>      <li>推荐使用API version 15开始支持的扫描方式，该方式支持应用发起和管理多路扫描。该方式支持的上报事件请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbledevicefind15" target="_blank">on('BLEDeviceFind')</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">scanReport: ble.ScanReport</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'BLE scan device find result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(scanReport));</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建ble扫描实例，可以管理该实例下创建的扫描流程</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">bleScanner</span>: ble.<span class="hljs-property">BleScanner</span> = ble.<span class="hljs-title function_">createBleScanner</span>();</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  bleScanner.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEDeviceFind'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>API version 14及以前支持的扫描方式只支持应用发起单路扫描。该方式支持的上报事件请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bleonbledevicefind" target="_blank">ble.on('BLEDeviceFind')</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;ble.ScanResult&gt;</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'BLE scan device find result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  ble.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEDeviceFind'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>如何解析扫描到的广播报文，具体可参考本章节<a href="/consumer/cn/doc/harmonyos-guides/ble-development-guide#完整示例">完整示例</a>。</li>     </ul>     <p><strong>2. 发起扫描</strong></p>     <p>通过BLE扫描周边其他设备发出的BLE广播，可以发现或者查找到应用需要的目标设备，适用于查找设备场景。</p>     <p>若本机设备扫描到可连接的BLE广播，则可以和该设备进行通用属性协议（Generic Attribute Profile，GATT）的连接和数据传输，此时本机设备角色也被称为GATT客户端。具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/gatt-development-guide">连接和传输数据</a>。</p>     <ul>      <li>推荐使用API version 15开始支持的扫描方式，该方式支持应用发起和管理多路扫描。可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blecreateblescanner15" target="_blank">createBleScanner</a>创建扫描实例<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blescanner15" target="_blank">BleScanner</a>，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#startscan15" target="_blank">startScan</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建ble扫描实例</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">bleScanner</span>: ble.<span class="hljs-property">BleScanner</span> = ble.<span class="hljs-title function_">createBleScanner</span>();</li><li>
</li><li><span class="hljs-comment">// 构造扫描BLE广播的过滤条件，目标BLE广播报文需符合该过滤条件</span></li><li><span class="hljs-keyword">let</span> manufactureId = <span class="hljs-number">4567</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataMask</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>]);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">scanFilter</span>: ble.<span class="hljs-property">ScanFilter</span> = { <span class="hljs-comment">// 根据业务实际情况定义过滤器</span></li><li>  <span class="hljs-attr">manufactureId</span>: manufactureId,</li><li>  <span class="hljs-attr">manufactureData</span>: manufactureData.<span class="hljs-property">buffer</span>,</li><li>  <span class="hljs-attr">manufactureDataMask</span>: manufactureDataMask.<span class="hljs-property">buffer</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 构造扫描配置参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">scanOptions</span>: ble.<span class="hljs-property">ScanOptions</span> = {</li><li>  <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>,</li><li>  <span class="hljs-attr">dutyMode</span>: ble.<span class="hljs-property">ScanDuty</span>.<span class="hljs-property">SCAN_MODE_LOW_POWER</span>,</li><li>  <span class="hljs-attr">matchMode</span>: ble.<span class="hljs-property">MatchMode</span>.<span class="hljs-property">MATCH_MODE_AGGRESSIVE</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起扫描</span></li><li>  bleScanner.<span class="hljs-title function_">startScan</span>([scanFilter], scanOptions);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startBleScan success'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>API version 14及以前支持的扫描方式只支持应用发起单路扫描。若要再次发起扫描，必须先停止上一路的扫描流程。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartblescan" target="_blank">ble.startBLEScan</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 构造扫描BLE广播的过滤条件，目标BLE广播报文需符合该过滤条件</span></li><li><span class="hljs-keyword">let</span> manufactureId = <span class="hljs-number">4567</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataMask</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>]);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">scanFilter</span>: ble.<span class="hljs-property">ScanFilter</span> = { <span class="hljs-comment">// 根据业务实际情况定义过滤器</span></li><li>  <span class="hljs-attr">manufactureId</span>: manufactureId,</li><li>  <span class="hljs-attr">manufactureData</span>: manufactureData.<span class="hljs-property">buffer</span>,</li><li>  <span class="hljs-attr">manufactureDataMask</span>: manufactureDataMask.<span class="hljs-property">buffer</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 构造扫描配置参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">scanOptions</span>: ble.<span class="hljs-property">ScanOptions</span> = {</li><li>  <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>,</li><li>  <span class="hljs-attr">dutyMode</span>: ble.<span class="hljs-property">ScanDuty</span>.<span class="hljs-property">SCAN_MODE_LOW_POWER</span>,</li><li>  <span class="hljs-attr">matchMode</span>: ble.<span class="hljs-property">MatchMode</span>.<span class="hljs-property">MATCH_MODE_AGGRESSIVE</span></li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起扫描</span></li><li>  ble.<span class="hljs-title function_">startBLEScan</span>([scanFilter], scanOptions);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startBleScan success'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 停止扫描</strong></p>     <p>扫描流程会消耗蓝牙硬件资源和影响设备功耗。当应用不再需要该扫描时，需要主动停止。</p>     <ul>      <li>搭配API version 15开始支持的多路扫描方式。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#stopscan15" target="_blank">stopScan</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">scanReport: ble.ScanReport</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'BLE scan device find result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(scanReport));</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建ble扫描实例</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">bleScanner</span>: ble.<span class="hljs-property">BleScanner</span> = ble.<span class="hljs-title function_">createBleScanner</span>();</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  bleScanner.<span class="hljs-title function_">off</span>(<span class="hljs-string">'BLEDeviceFind'</span>, onReceiveEvent);</li><li>  <span class="hljs-comment">// 停止扫描</span></li><li>  bleScanner.<span class="hljs-title function_">stopScan</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'stopBleScan success'</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>搭配API version 14及以前支持的单路扫描方式。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopblescan" target="_blank">ble.stopBLEScan</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义扫描结果上报回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;ble.ScanResult&gt;</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'BLE scan device find result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 取消订阅</span></li><li>  ble.<span class="hljs-title function_">off</span>(<span class="hljs-string">'BLEDeviceFind'</span>, onReceiveEvent);</li><li>  <span class="hljs-comment">// 停止扫描</span></li><li>  ble.<span class="hljs-title function_">stopBLEScan</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="ble广播流程">BLE广播流程<i class="anchor-icon anchor-icon-link" anchorid="ble广播流程" tips="复制节点链接"></i></h3>          <p>本机设备发送BLE广播后，可以实现被其他设备发现的功能。</p>     <p>若本机设备发送的是可连接广播，则可以接受其他设备发起的通用属性协议（Generic Attribute Profile，GATT）连接，此时本机设备角色也被称为GATT服务端。具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/gatt-development-guide">连接和传输数据</a>。</p>     <p>推荐使用API version 11及以后开始支持的广播操作方式。</p>     <p><strong>1. 订阅广播状态上报事件</strong></p>     <p>搭配API version 11开始支持的广播操作方式。</p>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: ble.AdvertisingStateChangeInfo</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth advertising state = '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>    ble.<span class="hljs-title function_">on</span>(<span class="hljs-string">'advertisingStateChange'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>2. 启动广播</strong></p>     <ul>      <li>       <p>推荐使用API version 11开始支持的广播操作方式。支持在不释放相关广播资源情况下，多次操作启动或者停止指定标识的广播，且支持设置广播持续发送的时间。</p>       <p>相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising11" target="_blank">ble.startAdvertising</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bleenableadvertising11" target="_blank">ble.enableAdvertising</a>。</p>       <p>首次启动广播接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising11" target="_blank">ble.startAdvertising</a>会分配广播相关资源，从API version 15开始，该接口支持应用多次调用，实现启动多路广播的功能，并通过不同的广播标识进行管理。</p></li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置广播发送的参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">setting</span>: ble.<span class="hljs-property">AdvertiseSetting</span> = {</li><li>    <span class="hljs-attr">interval</span>: <span class="hljs-number">160</span>,</li><li>    <span class="hljs-attr">txPower</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">connectable</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 发送支持连接的广播</span></li><li>};</li><li><span class="hljs-comment">// 构造广播数据</span></li><li><span class="hljs-keyword">let</span> manufactureValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>manufactureValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">4</span>;</li><li><span class="hljs-keyword">let</span> serviceValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>serviceValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">5</span>;</li><li>serviceValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">6</span>;</li><li>serviceValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">7</span>;</li><li>serviceValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">8</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataUnit</span>: ble.<span class="hljs-property">ManufactureData</span> = {</li><li>  <span class="hljs-attr">manufactureId</span>: <span class="hljs-number">4567</span>,</li><li>  <span class="hljs-attr">manufactureValue</span>: manufactureValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit1</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"00001999-0000-1000-8000-00805f9b34fb"</span>,</li><li>  <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit2</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"19991999-0000-1000-8000-00805f9b34fb"</span>,</li><li>  <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advData</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>  <span class="hljs-attr">serviceUuids</span>: [<span class="hljs-string">"00001888-0000-1000-8000-00805f9b34fb"</span>, <span class="hljs-string">"18881888-0000-1000-8000-00805f9b34fb"</span>],</li><li>  <span class="hljs-attr">manufactureData</span>: [manufactureDataUnit],</li><li>  <span class="hljs-attr">serviceData</span>: [],</li><li>  <span class="hljs-attr">includeDeviceName</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 表示是否携带设备名，可选参数。注意：带上设备名时，容易导致广播报文长度超出31个字节，使得广播启动失败</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advResponse</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>  <span class="hljs-attr">serviceUuids</span>: [],</li><li>  <span class="hljs-attr">manufactureData</span>: [],</li><li>  <span class="hljs-attr">serviceData</span>: [serviceDataUnit1, serviceDataUnit2]</li><li>};</li><li><span class="hljs-comment">// 构造广播启动完整参数AdvertisingParams</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingParams</span>: ble.<span class="hljs-property">AdvertisingParams</span> = {</li><li>  <span class="hljs-attr">advertisingSettings</span>: setting,</li><li>  <span class="hljs-attr">advertisingData</span>: advData, <span class="hljs-comment">// 注意: 广播报文长度不能超过31个字节</span></li><li>  <span class="hljs-attr">advertisingResponse</span>: advResponse, <span class="hljs-comment">// 注意: 广播报文长度不能超过31个字节</span></li><li>  <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 可选参数，若大于0，则广播发送一段时间后，则会停止，但分配的广播资源还在，可重新启动发送</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> advHandle = <span class="hljs-number">0xFF</span>; <span class="hljs-comment">// 定义广播标识</span></li><li>
</li><li><span class="hljs-comment">// 首次启动广播，蓝牙子系统会分配相关资源，包括应用获取到的广播的标识ID</span></li><li><span class="hljs-keyword">try</span> {</li><li>  ble.<span class="hljs-title function_">startAdvertising</span>(advertisingParams, <span class="hljs-function">(<span class="hljs-params">err, outAdvHandle</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      advHandle = outAdvHandle;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"advHandle: "</span> + advHandle);</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 构造启动广播参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingEnableParams</span>: ble.<span class="hljs-property">AdvertisingEnableParams</span> = {</li><li>  <span class="hljs-attr">advertisingId</span>: advHandle, <span class="hljs-comment">// 使用首次启动广播时获取到的广播标识ID</span></li><li>  <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span></li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 再次启动</span></li><li>  ble.<span class="hljs-title function_">enableAdvertising</span>(advertisingEnableParams, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>API version 10及以前支持的广播操作方式只支持应用启动单路广播。若要再次启动广播，必须先停止上一路的广播流程。详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising" target="_blank">ble.startAdvertising</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置广播发送的参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">setting</span>: ble.<span class="hljs-property">AdvertiseSetting</span> = {</li><li>    <span class="hljs-attr">interval</span>: <span class="hljs-number">160</span>,</li><li>    <span class="hljs-attr">txPower</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">connectable</span>: <span class="hljs-literal">true</span></li><li>};</li><li><span class="hljs-comment">// 构造广播数据</span></li><li><span class="hljs-keyword">let</span> manufactureValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>manufactureValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;</li><li>manufactureValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">4</span>;</li><li><span class="hljs-keyword">let</span> serviceValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>serviceValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">5</span>;</li><li>serviceValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">6</span>;</li><li>serviceValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">7</span>;</li><li>serviceValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">8</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataUnit</span>: ble.<span class="hljs-property">ManufactureData</span> = {</li><li>  <span class="hljs-attr">manufactureId</span>: <span class="hljs-number">4567</span>,</li><li>  <span class="hljs-attr">manufactureValue</span>: manufactureValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit1</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"00001999-0000-1000-8000-00805f9b34fb"</span>,</li><li>  <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit2</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"19991999-0000-1000-8000-00805f9b34fb"</span>,</li><li>  <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advData</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>  <span class="hljs-attr">serviceUuids</span>: [<span class="hljs-string">"00001888-0000-1000-8000-00805f9b34fb"</span>, <span class="hljs-string">"18881888-0000-1000-8000-00805f9b34fb"</span>],</li><li>  <span class="hljs-attr">manufactureData</span>: [manufactureDataUnit],</li><li>  <span class="hljs-attr">serviceData</span>: [],</li><li>  <span class="hljs-attr">includeDeviceName</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 表示是否携带设备名，可选参数。注意：带上设备名时，容易导致广播报文长度超出31个字节</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advResponse</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>  <span class="hljs-attr">serviceUuids</span>: [],</li><li>  <span class="hljs-attr">manufactureData</span>: [],</li><li>  <span class="hljs-attr">serviceData</span>: [serviceDataUnit1, serviceDataUnit2]</li><li>};</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 启动广播</span></li><li>  ble.<span class="hljs-title function_">startAdvertising</span>(setting, advData ,advResponse);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 停止广播</strong></p>     <p>广播流程会消耗蓝牙硬件资源和影响设备功耗。当应用不再需要该广播时，需要主动停止。</p>     <ul>      <li>       <p>搭配API version 11开始支持的广播方式。相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bledisableadvertising11" target="_blank">ble.disableAdvertising</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopadvertising11" target="_blank">ble.stopAdvertising</a>。</p>       <p>完全停止广播接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopadvertising11" target="_blank">ble.stopAdvertising</a>会释放所有广播资源，因此首次启动广播分配的广播标识将无效。</p></li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> advHandle = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值是首次启动广播时获取到的广播标识，此处是伪代码ID</span></li><li>
</li><li><span class="hljs-comment">// 构造停止广播参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingDisableParams</span>: ble.<span class="hljs-property">AdvertisingDisableParams</span> = {</li><li>    <span class="hljs-attr">advertisingId</span>: advHandle <span class="hljs-comment">// 使用首次启动广播时获取到的广播标识ID</span></li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 停止</span></li><li>  ble.<span class="hljs-title function_">disableAdvertising</span>(advertisingDisableParams, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 完全停止</span></li><li>  ble.<span class="hljs-title function_">stopAdvertising</span>(advHandle, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <ul>      <li>搭配API version 11及以前支持的单路广播方式。相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopadvertising" target="_blank">ble.stopAdvertising</a>。</li>     </ul>     <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 停止</span></li><li>  ble.<span class="hljs-title function_">stopAdvertising</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="ble扫描流程-1" class="firsth2">BLE扫描流程<i class="anchor-icon anchor-icon-link" anchorid="ble扫描流程-1" tips="复制节点链接"></i></h3>          <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.base'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'BleScanManager'</span>;</li><li>
</li><li><span class="hljs-comment">// 参考蓝牙标准协议规范Core Assigned Numbers</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_FLAG</span> = <span class="hljs-number">0x01</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_16_BIT_SERVICE_UUIDS_INCOMPLETE</span> = <span class="hljs-number">0x02</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_16_BIT_SERVICE_UUIDS_COMPLETE</span> = <span class="hljs-number">0x03</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_32_BIT_SERVICE_UUIDS_INCOMPLETE</span> = <span class="hljs-number">0x04</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_32_BIT_SERVICE_UUIDS_COMPLETE</span> = <span class="hljs-number">0x05</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_128_BIT_SERVICE_UUIDS_INCOMPLETE</span> = <span class="hljs-number">0x06</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_128_BIT_SERVICE_UUIDS_COMPLETE</span> = <span class="hljs-number">0x07</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_LOCAL_NAME_SHORT</span> = <span class="hljs-number">0x08</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_LOCAL_NAME_COMPLETE</span> = <span class="hljs-number">0x09</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_TX_POWER_LEVEL</span> = <span class="hljs-number">0x0A</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_16_BIT_SERVICE_SOLICITATION_UUIDS</span> = <span class="hljs-number">0x14</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_128_BIT_SERVICE_SOLICITATION_UUIDS</span> = <span class="hljs-number">0x15</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_32_BIT_SERVICE_SOLICITATION_UUIDS</span> = <span class="hljs-number">0x1F</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_16_BIT_SERVICE_DATA</span> = <span class="hljs-number">0x16</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_32_BIT_SERVICE_DATA</span> = <span class="hljs-number">0x20</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_128_BIT_SERVICE_DATA</span> = <span class="hljs-number">0x21</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLE_ADV_TYPE_MANUFACTURER_SPECIFIC_DATA</span> = <span class="hljs-number">0xFF</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLUETOOTH_UUID_16_BIT_LENGTH</span> = <span class="hljs-number">2</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLUETOOTH_UUID_32_BIT_LENGTH</span> = <span class="hljs-number">4</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLUETOOTH_UUID_128_BIT_LENGTH</span> = <span class="hljs-number">16</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLUETOOTH_MANUFACTURE_ID_LENGTH</span> = <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BleScanManager</span> {</li><li>  <span class="hljs-attr">bleScanner</span>: ble.<span class="hljs-property">BleScanner</span> = ble.<span class="hljs-title function_">createBleScanner</span>();</li><li>
</li><li>  <span class="hljs-comment">// 1. 定义扫描结果上报回调函数</span></li><li>  onReceiveEvent = <span class="hljs-function">(<span class="hljs-params">scanReport: ble.ScanReport</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'BLE scan device find result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(scanReport));</li><li>    <span class="hljs-keyword">if</span> (scanReport.<span class="hljs-property">scanResult</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'BLE scan result: '</span> + scanReport.<span class="hljs-property">scanResult</span>[<span class="hljs-number">0</span>].<span class="hljs-property">deviceId</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseScanResult</span>(scanReport.<span class="hljs-property">scanResult</span>[<span class="hljs-number">0</span>].<span class="hljs-property">data</span>);</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">parseScanResult</span>(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>    <span class="hljs-keyword">let</span> advData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data);</li><li>    <span class="hljs-keyword">if</span> (advData.<span class="hljs-property">byteLength</span> == <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'adv data length is 0'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advertiseFlags</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">txPowerLevel</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">localName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceUuids</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceSolicitationUuids</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureSpecificDatas</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">Uint8Array</span>&gt; = {};</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDatas</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Uint8Array</span>&gt; = {};</li><li>
</li><li>    <span class="hljs-keyword">let</span> curPos = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">while</span> (curPos &lt; advData.<span class="hljs-property">byteLength</span>) {</li><li>      <span class="hljs-keyword">let</span> length = advData[curPos++]; <span class="hljs-comment">// 获取当前广播类型的长度（length+data），curPos指向下一个位置</span></li><li>      <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 获取当前广播类型内容长度（data）</span></li><li>      <span class="hljs-keyword">let</span> advDataLength = length - <span class="hljs-number">1</span>;</li><li>
</li><li>      <span class="hljs-comment">// 获取当前广播类型，curPos指向下一个位置，从该位置解析实际内容，参考Core Specification Supplement, PartA</span></li><li>      <span class="hljs-keyword">let</span> advDataType = advData[curPos++];</li><li>      <span class="hljs-keyword">switch</span> (advDataType) {</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_FLAG</span>:</li><li>          advertiseFlags = advData[curPos];</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_LOCAL_NAME_SHORT</span>:</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_LOCAL_NAME_COMPLETE</span>:</li><li>          localName = advData.<span class="hljs-title function_">slice</span>(curPos, curPos + advDataLength).<span class="hljs-title function_">toString</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_TX_POWER_LEVEL</span>:</li><li>          txPowerLevel = advData[curPos];</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_16_BIT_SERVICE_UUIDS_INCOMPLETE</span>:</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_16_BIT_SERVICE_UUIDS_COMPLETE</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_16_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_32_BIT_SERVICE_UUIDS_INCOMPLETE</span>:</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_32_BIT_SERVICE_UUIDS_COMPLETE</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_32_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_128_BIT_SERVICE_UUIDS_INCOMPLETE</span>:</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_128_BIT_SERVICE_UUIDS_COMPLETE</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_128_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_16_BIT_SERVICE_SOLICITATION_UUIDS</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceSolicitationUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_16_BIT_LENGTH</span>, curPos, advDataLength,</li><li>            advData, serviceSolicitationUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_32_BIT_SERVICE_SOLICITATION_UUIDS</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceSolicitationUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_32_BIT_LENGTH</span>, curPos, advDataLength,</li><li>            advData, serviceSolicitationUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_128_BIT_SERVICE_SOLICITATION_UUIDS</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceSolicitationUuid</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_128_BIT_LENGTH</span>, curPos, advDataLength,</li><li>            advData, serviceSolicitationUuids);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_16_BIT_SERVICE_DATA</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceData</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_16_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceDatas);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_32_BIT_SERVICE_DATA</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceData</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_32_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceDatas);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_128_BIT_SERVICE_DATA</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseServiceData</span>(<span class="hljs-variable constant_">BLUETOOTH_UUID_128_BIT_LENGTH</span>, curPos, advDataLength, advData, serviceDatas);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> <span class="hljs-attr">BLE_ADV_TYPE_MANUFACTURER_SPECIFIC_DATA</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseManufactureData</span>(curPos, advDataLength, advData, manufactureSpecificDatas);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      curPos += advDataLength; <span class="hljs-comment">// curPos指向下一个字段类型</span></li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'advertiseFlags: '</span> + advertiseFlags);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'txPowerLevel: '</span> + txPowerLevel);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'localName: '</span> + localName);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'serviceUuids: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(serviceUuids));</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'serviceSolicitationUuids: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(serviceSolicitationUuids));</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'manufactureSpecificDatas: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(manufactureSpecificDatas));</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'serviceDatas: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(serviceDatas));</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">parseServiceUuid</span>(<span class="hljs-params">uuidLength: <span class="hljs-built_in">number</span>, curPos: <span class="hljs-built_in">number</span>, advDataLength: <span class="hljs-built_in">number</span>,</span></li><li><span class="hljs-params">    advData: <span class="hljs-built_in">Uint8Array</span>, serviceUuids: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    <span class="hljs-keyword">while</span> (advDataLength &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">tmpData</span>: <span class="hljs-title class_">Uint8Array</span> = advData.<span class="hljs-title function_">slice</span>(curPos, curPos + uuidLength);</li><li>      serviceUuids.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUuidFromUint8Array</span>(uuidLength, tmpData));</li><li>      advDataLength -= uuidLength;</li><li>      curPos += uuidLength;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">parseServiceSolicitationUuid</span>(<span class="hljs-params">uuidLength: <span class="hljs-built_in">number</span>, curPos: <span class="hljs-built_in">number</span>, advDataLength: <span class="hljs-built_in">number</span>,</span></li><li><span class="hljs-params">    advData: <span class="hljs-built_in">Uint8Array</span>, serviceSolicitationUuids: <span class="hljs-built_in">string</span>[]</span>) {</li><li>    <span class="hljs-keyword">while</span> (advDataLength &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">tmpData</span>: <span class="hljs-title class_">Uint8Array</span> = advData.<span class="hljs-title function_">slice</span>(curPos, curPos + uuidLength);</li><li>      serviceSolicitationUuids.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUuidFromUint8Array</span>(uuidLength, tmpData));</li><li>      advDataLength -= uuidLength;</li><li>      curPos += uuidLength;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getUuidFromUint8Array</span>(<span class="hljs-attr">uuidLength</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">uuidData</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> uuid = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">temp</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = uuidLength - <span class="hljs-number">1</span>; i &gt; -<span class="hljs-number">1</span>; i--) {</li><li>      temp += uuidData[i].<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (uuidLength) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-attr">BLUETOOTH_UUID_16_BIT_LENGTH</span>:</li><li>        uuid = <span class="hljs-string">`0000<span class="hljs-subst">${temp}</span>-0000-1000-8000-00805F9B34FB`</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-attr">BLUETOOTH_UUID_32_BIT_LENGTH</span>:</li><li>        uuid = <span class="hljs-string">`<span class="hljs-subst">${temp}</span>-0000-1000-8000-00805F9B34FB`</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-attr">BLUETOOTH_UUID_128_BIT_LENGTH</span>:</li><li>        uuid = <span class="hljs-string">`<span class="hljs-subst">${temp.substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>)}</span>-<span class="hljs-subst">${temp.substring(<span class="hljs-number">8</span>, <span class="hljs-number">12</span>)}</span>-<span class="hljs-subst">${temp.substring(<span class="hljs-number">12</span>, <span class="hljs-number">16</span>)}</span>-<span class="hljs-subst">${temp.substring(<span class="hljs-number">16</span>, <span class="hljs-number">20</span>)}</span>-<span class="hljs-subst">${temp.substring(<span class="hljs-number">20</span>, <span class="hljs-number">32</span>)}</span>`</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> uuid;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">parseServiceData</span>(<span class="hljs-params">uuidLength: <span class="hljs-built_in">number</span>, curPos: <span class="hljs-built_in">number</span>, advDataLength: <span class="hljs-built_in">number</span>,</span></li><li><span class="hljs-params">    advData: <span class="hljs-built_in">Uint8Array</span>, serviceDatas: Record&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">Uint8Array</span>&gt;</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">uuid</span>: <span class="hljs-title class_">Uint8Array</span> = advData.<span class="hljs-title function_">slice</span>(curPos, curPos + uuidLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Uint8Array</span> = advData.<span class="hljs-title function_">slice</span>(curPos + uuidLength, curPos + advDataLength);</li><li>    serviceDatas[<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUuidFromUint8Array</span>(uuidLength, uuid)] = data;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">parseManufactureData</span>(<span class="hljs-params">curPos: <span class="hljs-built_in">number</span>, advDataLength: <span class="hljs-built_in">number</span>,</span></li><li><span class="hljs-params">    advData: <span class="hljs-built_in">Uint8Array</span>, manufactureSpecificDatas: Record&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">Uint8Array</span>&gt;</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureId</span>: <span class="hljs-built_in">number</span> = (advData[curPos + <span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) + advData[curPos];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Uint8Array</span> = advData.<span class="hljs-title function_">slice</span>(curPos + <span class="hljs-variable constant_">BLUETOOTH_MANUFACTURE_ID_LENGTH</span>, curPos + advDataLength);</li><li>    manufactureSpecificDatas[manufactureId] = data;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 2. 开启扫描</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startScan</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 2.1 构造扫描BLE广播的过滤条件，目标BLE广播报文需符合该过滤条件</span></li><li>    <span class="hljs-keyword">let</span> manufactureId = <span class="hljs-number">4567</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureData</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataMask</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>]);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">scanFilter</span>: ble.<span class="hljs-property">ScanFilter</span> = { <span class="hljs-comment">// 根据业务实际情况定义过滤器</span></li><li>      <span class="hljs-attr">manufactureId</span>: manufactureId,</li><li>      <span class="hljs-attr">manufactureData</span>: manufactureData.<span class="hljs-property">buffer</span>,</li><li>      <span class="hljs-attr">manufactureDataMask</span>: manufactureDataMask.<span class="hljs-property">buffer</span></li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 2.2 构造扫描配置参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">scanOptions</span>: ble.<span class="hljs-property">ScanOptions</span> = {</li><li>      <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">dutyMode</span>: ble.<span class="hljs-property">ScanDuty</span>.<span class="hljs-property">SCAN_MODE_LOW_POWER</span>,</li><li>      <span class="hljs-attr">matchMode</span>: ble.<span class="hljs-property">MatchMode</span>.<span class="hljs-property">MATCH_MODE_AGGRESSIVE</span></li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 发起订阅</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">bleScanner</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEDeviceFind'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>      <span class="hljs-comment">// 发起扫描</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">bleScanner</span>.<span class="hljs-title function_">startScan</span>([scanFilter], scanOptions);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startBleScan success'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 3. 关闭扫描</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stopScan</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 取消订阅</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">bleScanner</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'BLEDeviceFind'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>      <span class="hljs-comment">// 停止扫描</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">bleScanner</span>.<span class="hljs-title function_">stopScan</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'stopBleScan success'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> bleScanManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BleScanManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> bleScanManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">BleScanManager</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="ble广播流程-1">BLE广播流程<i class="anchor-icon anchor-icon-link" anchorid="ble广播流程-1" tips="复制节点链接"></i></h3>          <div _ngcontent-irr-c106="" class="highlight-div"><div _ngcontent-irr-c106="" class="highlight-div-header"><div _ngcontent-irr-c106="" class="highlight-div-header-left"><div _ngcontent-irr-c106="" class="handle-button expand-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-irr-c106="" class="highlight-div-header-right"><div _ngcontent-irr-c106="" class="handle-button ai-button"></div><div _ngcontent-irr-c106="" class="handle-button line-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-irr-c106="" class="handle-button theme-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-irr-c106="" class="handle-button copy-button"><div _ngcontent-irr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-irr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'BleAdvertisingManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BleAdvertisingManager</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">advHandle</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF</span>; <span class="hljs-comment">// 初始的无效值</span></li><li>
</li><li>  <span class="hljs-comment">// 1. 定义广播状态上报事件</span></li><li>  onReceiveEvent = <span class="hljs-function">(<span class="hljs-params">data: ble.AdvertisingStateChangeInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'bluetooth advertising state = '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'advertiserState'</span>, data.<span class="hljs-property">state</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 2. 首次启动广播</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">startAdvertising</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 2.1 设置广播发送的参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">setting</span>: ble.<span class="hljs-property">AdvertiseSetting</span> = {</li><li>      <span class="hljs-attr">interval</span>: <span class="hljs-number">160</span>,</li><li>      <span class="hljs-attr">txPower</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">connectable</span>: <span class="hljs-literal">true</span></li><li>    };</li><li>    <span class="hljs-comment">// 2.2 构造广播数据</span></li><li>    <span class="hljs-keyword">let</span> manufactureValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>    manufactureValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li>    manufactureValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;</li><li>    manufactureValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;</li><li>    manufactureValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-keyword">let</span> serviceValueBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);</li><li>    serviceValueBuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">5</span>;</li><li>    serviceValueBuffer[<span class="hljs-number">1</span>] = <span class="hljs-number">6</span>;</li><li>    serviceValueBuffer[<span class="hljs-number">2</span>] = <span class="hljs-number">7</span>;</li><li>    serviceValueBuffer[<span class="hljs-number">3</span>] = <span class="hljs-number">8</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">manufactureDataUnit</span>: ble.<span class="hljs-property">ManufactureData</span> = {</li><li>      <span class="hljs-attr">manufactureId</span>: <span class="hljs-number">4567</span>,</li><li>      <span class="hljs-attr">manufactureValue</span>: manufactureValueBuffer.<span class="hljs-property">buffer</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit1</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"00001999-0000-1000-8000-00805f9b34fb"</span>,</li><li>      <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceDataUnit2</span>: ble.<span class="hljs-property">ServiceData</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">"19991999-0000-1000-8000-00805f9b34fb"</span>,</li><li>      <span class="hljs-attr">serviceValue</span>: serviceValueBuffer.<span class="hljs-property">buffer</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advData</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>      <span class="hljs-attr">serviceUuids</span>: [<span class="hljs-string">"00001888-0000-1000-8000-00805f9b34fb"</span>, <span class="hljs-string">"18881888-0000-1000-8000-00805f9b34fb"</span>],</li><li>      <span class="hljs-attr">manufactureData</span>: [manufactureDataUnit],</li><li>      <span class="hljs-attr">serviceData</span>: [],</li><li>      <span class="hljs-attr">includeDeviceName</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 表示是否携带设备名，可选参数。注意：带上设备名时，容易导致广播报文长度超出31个字节，使得广播启动失败</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advResponse</span>: ble.<span class="hljs-property">AdvertiseData</span> = {</li><li>      <span class="hljs-attr">serviceUuids</span>: [],</li><li>      <span class="hljs-attr">manufactureData</span>: [],</li><li>      <span class="hljs-attr">serviceData</span>: [serviceDataUnit1, serviceDataUnit2]</li><li>    };</li><li>    <span class="hljs-comment">// 2.3 构造广播启动完整参数AdvertisingParams</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingParams</span>: ble.<span class="hljs-property">AdvertisingParams</span> = {</li><li>      <span class="hljs-attr">advertisingSettings</span>: setting,</li><li>      <span class="hljs-attr">advertisingData</span>: advData, <span class="hljs-comment">// 注意: 广播报文长度不能超过31个字节</span></li><li>      <span class="hljs-attr">advertisingResponse</span>: advResponse, <span class="hljs-comment">// 注意: 广播报文长度不能超过31个字节</span></li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 可选参数，若参数大于0，则广播发送一段时间后会停止，但分配的广播资源还在，可重新启动发送</span></li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2.4 首次启动广播，蓝牙子系统会分配相关资源，包括应用获取到的广播标识ID</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      ble.<span class="hljs-title function_">on</span>(<span class="hljs-string">'advertisingStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">advHandle</span> = <span class="hljs-keyword">await</span> ble.<span class="hljs-title function_">startAdvertising</span>(advertisingParams);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 3. 停止指定标识的广播，即首次启动时分配的标识，停止后，该路广播资源仍然存在</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">disableAdvertising</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 3.1 构造停止广播参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingDisableParams</span>: ble.<span class="hljs-property">AdvertisingDisableParams</span> = {</li><li>      <span class="hljs-attr">advertisingId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">advHandle</span> <span class="hljs-comment">// 使用首次启动广播时获取到的广播标识ID</span></li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 3.2 停止</span></li><li>      <span class="hljs-keyword">await</span> ble.<span class="hljs-title function_">disableAdvertising</span>(advertisingDisableParams);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 4. 启动指定标识的广播，即首次启动时分配的标识</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">enableAdvertising</span>(<span class="hljs-params">enableDuration: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-comment">// 4.1 构造启动广播参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">advertisingEnableParams</span>: ble.<span class="hljs-property">AdvertisingEnableParams</span> = {</li><li>      <span class="hljs-attr">advertisingId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">advHandle</span>, <span class="hljs-comment">// 使用首次启动广播时获取到的广播标识ID</span></li><li>      <span class="hljs-attr">duration</span>: enableDuration</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 4.2 再次启动</span></li><li>      <span class="hljs-keyword">await</span> ble.<span class="hljs-title function_">enableAdvertising</span>(advertisingEnableParams);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 5. 完全停止广播，释放广播资源</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopAdvertising</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> ble.<span class="hljs-title function_">stopAdvertising</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">advHandle</span>);</li><li>      ble.<span class="hljs-title function_">off</span>(<span class="hljs-string">'advertisingStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onReceiveEvent</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> bleAdvertisingManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BleAdvertisingManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> bleAdvertisingManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">BleAdvertisingManager</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>