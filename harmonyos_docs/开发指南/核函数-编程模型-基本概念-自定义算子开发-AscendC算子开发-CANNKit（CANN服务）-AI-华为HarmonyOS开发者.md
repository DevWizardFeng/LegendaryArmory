<h1 _ngcontent-osb-c119="" class="doc-title ng-star-inserted" title="核函数"> 核函数 </h1>

<div _ngcontent-osb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-spmd-model">SPMD模型</a>可以得知，使用AscendC进行编程时，我们编写一份算子实现代码，算子被调用时，将启动N个运行实例，在N个核上运行。本节将介绍算子实现的入口函数。</p> <p>核函数(Kernel Function)是AscendC算子设备侧实现的入口。在核函数中，需要为在一个核上执行的代码规定要进行的数据访问和计算操作，当核函数被调用时，多个核都执行相同的核函数代码，具有相同的参数，并行执行。</p> <p>AscendC允许开发者使用核函数这种C/C++函数的语法扩展来管理设备端的运行代码，开发者在核函数中进行算子类对象的创建和其成员函数的调用，由此实现该算子的所有功能。核函数是主机端和设备端连接的桥梁，本章将具体介绍核函数的用法。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>Kirin9020/KirinX90系列处理器暂不支持通过&lt;&lt;&lt;&gt;&gt;&gt;调用核函数。</p> </div></div></div> <div class="tiledSection"><h2 id="section552mcpsimp">核函数定义<i class="anchor-icon anchor-icon-link" anchorid="section552mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* x, __gm__ <span class="hljs-type">uint8_t</span>* y, __gm__ <span class="hljs-type">uint8_t</span>* z)</span></span>;</li></ol></pre></div></div> <p>以上是一个核函数声明的例子，编写核函数时需要遵循以下规则。</p> <ul><li><strong>使用函数类型限定符</strong><p>除了需要按照C/C++函数声明的方式定义核函数之外，还要为核函数加上额外的函数类型限定符，包含__global__和__aicore__。</p> <p>使用__global__函数类型限定符来标识它是一个核函数，可以被&lt;&lt;&lt;&gt;&gt;&gt;调用；使用__aicore__函数类型限定符来标识该核函数在设备端AI Core上执行：__global__ __aicore__ void kernel_name(argument list)。</p> <p>编程中使用到的函数可以分为三类：核函数（device侧执行）、host侧执行函数、device侧执行函数（除核函数之外的）。三者的调用关系如下图所示：</p> <ul><li>host侧执行函数可以调用同类的host执行函数，也就是通用C/C++编程中的函数调用；也可以通过&lt;&lt;&lt;&gt;&gt;&gt;调用核函数。</li><li>device侧执行函数（除核函数之外的）可以调用同类的device侧执行函数。</li><li>核函数可以调用device侧执行函数（除核函数之外的）。</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>核函数（device侧执行）、host侧执行函数、device侧执行函数（除核函数之外的）调用关系</span><br><span><img height="430.92" originheight="426" originwidth="373" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114304.92187667398986902781788263504791:50001231000000:2800:65686D18E7B439468C55AD68E7A8CE74D449E3C49F18412E91A326B5547F149D.png" title="点击放大" width="373.73"></span></div> </li><li><strong>使用变量类型限定符</strong><p>指针入参变量需要增加变量类型限定符__gm__，表明该指针变量指向Global Memory上某处内存地址。</p> </li><li><strong>其他规则或建议</strong><ul><li>规则1：核函数必须具有void返回类型。</li><li>规则2：仅支持入参为指针或C/C++内置数据类型(Primitive data types)，如：half* s0、float* s1、int32_t c。</li><li>建议：为了统一表达，建议使用GM_ADDR宏来修饰入参，GM_ADDR宏定义如下。<div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> GM_ADDR __gm__ uint8_t*</span></li></ol></pre></div></div> <p>使用GM_ADDR修饰入参的样例如下。</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z)</span></span></li></ol></pre></div></div> <p>这里统一使用uint8_t类型的指针，在后续的使用中需要将其转化为实际的指针类型。</p> </li></ul> </li></ul> </div> <div class="tiledSection"><h2 id="section581mcpsimp">核函数调用<i class="anchor-icon anchor-icon-link" anchorid="section581mcpsimp" tips="复制节点链接"></i></h2><p>核函数的调用语句是C/C++函数调用语句的一种扩展。本节仅描述最基础的调用方式，实际进行算子开发时，开发者可以通过该方式调用，也可以通过接入AscendC框架的方式调用，更多细节请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-project-based-operator-development">工程化算子开发</a>。</p> <p>常见的函数调用方式是如下的形式：</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">function_name</span>(argument list);</li></ol></pre></div></div> <p>核函数使用内核调用符&lt;&lt;&lt;...&gt;&gt;&gt;这种语法形式，来规定核函数的执行配置：</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>kernel_name&lt;&lt;&lt;blockDim, l2ctrl, stream&gt;&gt;&gt;(argument list);</li></ol></pre></div></div> <p>内核调用符仅可在NPU侧编译时调用，CPU侧编译无法识别该符号。</p> <p>执行配置由以下blockDim, l2ctrl, stream参数决定：</p> </div> <div class="tiledSection"><h3 id="section9971184821716" class="firsth2">blockDim<i class="anchor-icon anchor-icon-link" anchorid="section9971184821716" tips="复制节点链接"></i></h3><p>规定了核函数将会在几个核上执行。每个执行该核函数的核会被分配一个逻辑ID，即block_idx，可以在核函数的实现中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getblockidx">GetBlockIdx</a>来获取block_idx。</p> <p>blockDim是逻辑核的概念，取值范围为[1, 65535]。为了充分利用硬件资源，一般设置为物理核的核数或其倍数。对于耦合架构和分离架构，blockDim在运行时的意义和设置规则有一些区别，具体说明如下。</p> <ul><li>耦合架构：由于其Vector、Cube单元是集成在一起的，blockDim用于设置启动多个AICore核实例执行，不区分Vector、Cube。AI Core的核数可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaic">GetCoreNumAic</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaiv">GetCoreNumAiv</a>获取。</li><li>分离架构：<ul><li>针对仅包含Vector计算的算子，blockDim用于设置启动多少个Vector(AIV)实例执行，比如某款AI处理器上有40个Vector核，建议设置为40</li><li>针对仅包含Cube计算的算子，blockDim用于设置启动多少个Cube(AIC)实例执行，比如某款AI处理器上有20个Cube核，建议设置为20。</li><li>针对Vector/Cube融合计算的算子，启动时，按照AIV和AIC组合启动，blockDim用于设置启动多少个组合执行，比如某款AI处理器上有40个Vector核和20个Cube核，一个组合是2个Vector核和1个Cube核，建议设置为20，此时会启动20个组合，即40个Vector核和20个Cube核。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>该场景下，设置的blockDim逻辑核的核数不能超过物理核（2个Vector核和1个Cube核组合为1个物理核）的核数。</p> </div></div></div> </li><li>AIC/AIV的核数分别通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaic">GetCoreNumAic</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getcorenumaiv">GetCoreNumAiv</a>接口获取。</li></ul> </li></ul> </div> <div class="tiledSection"><h3 id="section39485152185">l2ctrl<i class="anchor-icon anchor-icon-link" anchorid="section39485152185" tips="复制节点链接"></i></h3><p>保留参数，暂时设置为固定值nullptr，开发者无需关注。</p> </div> <div class="tiledSection"><h3 id="section23551538161813">stream<i class="anchor-icon anchor-icon-link" anchorid="section23551538161813" tips="复制节点链接"></i></h3><p>类型为aclrtStream，stream用于维护一些异步操作的执行顺序，确保按照应用程序中的代码调用顺序在device上执行。</p> </div> <div class="tiledSection"><h3 id="section126115517193">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section126115517193" tips="复制节点链接"></i></h3><p>如下名为add_custom的核函数，实现两个矢量的相加，调用示例如下。</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// blockDim设置为8表示在8个核上调用了add_custom核函数，每个核都会独立且并行地执行该核函数，该核函数的参数列表为x，y，z。 </span></li><li>add_custom&lt;&lt;&lt;<span class="hljs-number">8</span>, <span class="hljs-literal">nullptr</span>, stream&gt;&gt;&gt;(x, y, z);</li></ol></pre></div></div> <p>核函数的调用是异步的，核函数的调用结束后，控制权立刻返回给host端，可以调用以下<strong>aclrtSynchronizeStream</strong>函数来强制主机端程序等待所有核函数执行完毕。</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">aclError <span class="hljs-title">aclrtSynchronizeStream</span><span class="hljs-params">(aclrtStream stream)</span></span>;</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section628mcpsimp">核函数示例<i class="anchor-icon anchor-icon-link" anchorid="section628mcpsimp" tips="复制节点链接"></i></h2><p>下面提供核函数实现的样例代码片段，完整样例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-vector-programming">矢量编程</a>。</p> <div _ngcontent-osb-c106="" class="highlight-div"><div _ngcontent-osb-c106="" class="highlight-div-header"><div _ngcontent-osb-c106="" class="highlight-div-header-left"><div _ngcontent-osb-c106="" class="handle-button expand-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-osb-c106="" class="highlight-div-header-right"><div _ngcontent-osb-c106="" class="handle-button ai-button"></div><div _ngcontent-osb-c106="" class="handle-button line-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-osb-c106="" class="handle-button theme-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-osb-c106="" class="handle-button copy-button"><div _ngcontent-osb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-osb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 实现核函数 </span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <span class="hljs-comment">// 初始化算子类，算子类提供算子初始化和核心处理等方法 </span></li><li>    KernelAdd op; </li><li>    <span class="hljs-comment">// 初始化函数，获取该核函数需要处理的输入输出地址，同时完成必要的内存初始化工作 </span></li><li>    op.<span class="hljs-built_in">Init</span>(x, y, z); </li><li>    <span class="hljs-comment">// 核心处理函数，完成算子的数据搬运与计算等核心逻辑 </span></li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>} </li></ol></pre></div></div> </div> </div> <div></div></div>