<h1 _ngcontent-odb-c119="" class="doc-title ng-star-inserted" title="格物开发指导"> 格物开发指导 </h1>

<div _ngcontent-odb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>从API version 20开始支持。端侧推理场景具有保障用户数据隐私、部署成本低、时延低、不受网络影响的高可用性等优点。但是，相比于云侧推理而言，端侧推理也面临着更大的挑战，因为端侧设备的内存资源受限、算力受限、对功耗敏感，并且还需要在运行端侧推理业务时保障用户体验、不卡顿。为了应对端侧推理的这些挑战，格物服务提供QoS感知的推理加速和资源管理优化能力。本文将指导开发者使用格物接口。</p> </div>  <div class="tiledSection"><h2 id="接口">接口<i class="anchor-icon anchor-icon-link" anchorid="接口" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="错误码" class="firsth2">错误码<i class="anchor-icon anchor-icon-link" anchorid="错误码" tips="复制节点链接"></i></h3><p>OH_QoS_GewuErrorCode枚举型作为格物的错误码类型，各函数接口返回的错误码含义见接口描述。</p> </div>  <div class="tiledSection"><h3 id="会话句柄">会话句柄<i class="anchor-icon anchor-icon-link" anchorid="会话句柄" tips="复制节点链接"></i></h3><p>会话句柄用于会话的管理。通过OH_QoS_GewuSession成功创建会话时可获得会话句柄，可用于提交/中止请求和销毁会话。</p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> OH_QoS_GewuSession;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="请求句柄">请求句柄<i class="anchor-icon anchor-icon-link" anchorid="请求句柄" tips="复制节点链接"></i></h3><p>请求句柄用于请求的管理。通过OH_QoS_GewuSubmitRequest成功提交请求时可获得请求句柄，可用于中止请求。</p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> OH_QoS_GewuRequest;</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="函数">函数<i class="anchor-icon anchor-icon-link" anchorid="函数" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.1" valign="top" width="50%">函数名</th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.1.3.1.2" valign="top" width="50%">简介</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">OH_QoS_GewuCreateSession</td> <td class="cellrowborder" valign="top" width="50%">创建会话</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_QoS_GewuDestroySession</td> <td class="cellrowborder" valign="top" width="50%">销毁会话</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_QoS_GewuSubmitRequest</td> <td class="cellrowborder" valign="top" width="50%">提交请求</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">OH_QoS_GewuAbortRequest</td> <td class="cellrowborder" valign="top" width="50%">中止请求</td> </tr>  </tbody></table></div> </div> <p><strong>OH_QoS_GewuCreateSession</strong></p> <p><strong>描述</strong></p> <p>OH_QoS_GewuCreateSession接口用于创建会话。</p> <p>该接口异步处理请求，即该接口只是发起创建会话，并不会等到会话资源分配完成、模型加载完成才返回。格物优化端侧推理资源管理，可以动态按需加载资源。</p> <p>会话对象的生命周期从OH_QoS_GewuCreateSession函数返回开始，到调用OH_QoS_GewuDestroySession为止。</p> <p><strong>声明</strong></p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    OH_QoS_GewuSession session;</li><li>    OH_QoS_GewuErrorCode error;</li><li>} OH_QoS_GewuCreateSessionResult;</li><li>
</li><li>OH_QoS_GewuCreateSessionResult <span class="hljs-title function_">OH_QoS_GewuCreateSession</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* attributes)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>const char* attributes参数表示会话属性的json字符串。该json字符串支持以下字段：<ul><li>"model": string 表示会话使用的模型的路径。</li></ul>  </li></ul> <p>attributes json字符串例子：</p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/data/storage/el2/base/files/qwen2/"</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p><strong>返回值</strong></p> <p>如果创建会话成功，返回值OH_QoS_GewuCreateSessionResult里的error为OH_QOS_GEWU_OK，而session为创建出来的会话句柄。</p> <p>如果创建会话失败，返回值OH_QoS_GewuCreateSessionResult里的error为错误原因，其中OH_QOS_GEWU_NOMEM表示没有足够的内存创建会话。</p> <p><strong>OH_QoS_GewuDestroySession</strong></p> <p><strong>描述</strong></p> <p>OH_QoS_GewuDestroySession接口用于销毁会话。</p> <p>建议用户应当等待至所有请求都已完成或中止，然后再调用该接口来销毁会话。如果调用该接口时还有正在进行的请求，那些请求将会被中止，且用户不会再收到回复。注意，在调用完该接口后，会话对象无法再被使用。</p> <p><strong>声明</strong></p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li>OH_QoS_GewuErrorCode <span class="hljs-title function_">OH_QoS_GewuDestroySession</span><span class="hljs-params">(OH_QoS_GewuSession session)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>OH_QoS_GewuSession session参数为要销毁的会话的句柄。</li></ul> <p><strong>返回值</strong></p> <p>如果会话销毁成功，返回值为OH_QOS_GEWU_OK。</p> <p>如果会话销毁失败，返回值为错误原因，其中OH_QOS_GEWU_NOENT表示找不到会话。</p> <p><strong>OH_QoS_GewuSubmitRequest</strong></p> <p><strong>描述</strong></p> <p>OH_QoS_GewuSubmitRequest接口用于提交请求。该接口异步执行请求，即该接口只是发起请求，并不直接返回结果，该接口返回时请求可能尚未开始执行。请求的结果通过调用用户提供的回调返回给用户。</p> <p><strong>声明</strong></p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></li><li>    OH_QoS_GewuRequest request;</li><li>    OH_QoS_GewuErrorCode error;</li><li>} OH_QoS_GewuSubmitRequestResult;</li><li>
</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*OH_QoS_GewuOnResponse)</span><span class="hljs-params">(<span class="hljs-type">void</span>* context, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* response)</span>;</li><li>
</li><li>OH_QoS_GewuSubmitRequestResult <span class="hljs-title function_">OH_QoS_GewuSubmitRequest</span><span class="hljs-params">(OH_QoS_GewuSession session, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* request,</span></li><li><span class="hljs-params">    OH_QoS_GewuOnResponse callback, <span class="hljs-type">void</span>* context)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <p>OH_QoS_GewuSubmitRequest函数的各参数如下：</p> <ul><li>OH_QoS_GewuSession session参数是会话句柄，表示请求要提交到哪个会话。</li><li>const char* request参数为请求的json字符串，支持以下字段：<ul><li>"messages": array. 表示消息的数组其中每个元素支持以下字段：<ul><li>"role": string. 消息的角色类型。其中"developer"表示开发者或系统提供的指示，"user"表示用户输入，"assistant"表示模型生成结果。</li><li>"content": string. 消息内容。</li></ul>  </li><li>"stream": boolean or null. 是否使能流式推理，默认为非流式。</li></ul>  </li><li>OH_QoS_GewuOnResponse callback参数为请求的回调函数。</li><li>void* context参数为用户提供的上下文指针，用于传递给回调函数。一般用法中，用户代码可通过该参数找到与收到的回复对应的请求，从而进行相应的处理。</li></ul> <p>另外，OH_QoS_GewuOnResponse回调函数的各参数如下：</p> <ul><li>void* context参数是调用OH_QoS_GewuSubmitRequest时传进来的context指针。</li><li>const char* response参数是回复的json字符串，包含以下字段：<ul><li>"message": 回复消息，包含以下字段：<ul><li>"role": string. 消息的角色类型，应为"assistant"。</li><li>"content": string. 消息内容。</li></ul>  </li><li>"finish_reason": string or null. 停止原因，可能的值如下：<ul><li>null: 表示没有停止。流式推理中会有多次回复，只有最后一次回复有非空的"finish_reason"。而非流式推理只有一次回复，且"finish_reason"非空。</li><li>"stop": 正常停止。</li><li>"abort": 用户主动提前中止。</li><li>"length": token数超过限制。</li></ul>  </li></ul>  </li></ul> <p><strong>返回值</strong></p> <p>如果提交请求成功，返回值OH_QoS_GewuSubmitRequestResult里的error为OH_QOS_GEWU_OK，request为请求句柄。</p> <p>如果提交请求失败，返回值OH_QoS_GewuSubmitRequestResult里的error为错误原因，其中OH_QOS_GEWU_NOMEM表示没有足够的内存处理该请求。</p> <p><strong>OH_QoS_GewuAbortRequest</strong></p> <p><strong>描述</strong></p> <p>OH_QoS_GewuAbortRequest接口用于提前中止请求。</p> <p>正常情况下，用户调用OH_QoS_GewuSubmitRequest接口提交请求后，等待至推理完成（即收到"finish_reason"不为空的回复），不需要调用OH_QoS_GewuAbortRequest接口。</p> <p>只有当用户希望提前中止推理请求的时候，才需要调用OH_QoS_GewuAbortRequest接口。</p> <p>成功调用该函数后，用户不会再收到该请求的回复，且该请求句柄无法再被使用。</p> <p><strong>声明</strong></p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li>OH_QoS_GewuErrorCode <span class="hljs-title function_">OH_QoS_GewuAbortRequest</span><span class="hljs-params">(OH_QoS_GewuSession session, OH_QoS_GewuRequest request)</span>;</li></ol></pre></div></div> <p><strong>参数</strong></p> <ul><li>OH_QoS_GewuSession session参数为请求所述的会话的句柄。</li><li>OH_QoS_GewuRequest request参数为要中止的请求的句柄。</li></ul> <p><strong>返回值</strong></p> <p>如果请求中止成功，返回值为OH_QOS_GEWU_OK。</p> <p>如果请求中止失败，返回值为错误原因，其中OH_QOS_GEWU_NOENT表示找不到请求。</p> </div>  <div class="tiledSection"><h2 id="示例">示例<i class="anchor-icon anchor-icon-link" anchorid="示例" tips="复制节点链接"></i></h2><p>示例如下:</p> <div _ngcontent-odb-c106="" class="highlight-div"><div _ngcontent-odb-c106="" class="highlight-div-header"><div _ngcontent-odb-c106="" class="highlight-div-header-left"><div _ngcontent-odb-c106="" class="handle-button expand-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-odb-c106="" class="highlight-div-header-right"><div _ngcontent-odb-c106="" class="handle-button ai-button"></div><div _ngcontent-odb-c106="" class="handle-button line-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-odb-c106="" class="handle-button theme-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-odb-c106="" class="handle-button copy-button"><div _ngcontent-odb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-odb-c106="" class="highlight-scroll-div"><pre class="CPP prettyprint linenums hljs language-CPP" hw-language="CPP" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"DEMO"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;qos/qos.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMO_LOGD(fmt, ...) OH_LOG_DEBUG(LOG_APP, fmt, ##__VA_ARGS__)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMO_LOGI(fmt, ...) OH_LOG_INFO(LOG_APP, fmt, ##__VA_ARGS__)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMO_LOGW(fmt, ...) OH_LOG_WARN(LOG_APP, fmt, ##__VA_ARGS__)</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMO_LOGE(fmt, ...) OH_LOG_ERROR(LOG_APP, fmt, ##__VA_ARGS__)</span></li><li>
</li><li><span class="hljs-keyword">using</span> json = nlohmann::json;</li><li>
</li><li><span class="hljs-comment">/* 用于保存聊天状态 */</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChatContext</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">ChatContext</span>()</li><li>    {</li><li>        future = promise.<span class="hljs-built_in">get_future</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Join</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-built_in">assert</span>(future.<span class="hljs-built_in">valid</span>());</li><li>        std::string stopReasonStr = future.<span class="hljs-built_in">get</span>();</li><li>        <span class="hljs-built_in">DEMO_LOGI</span>(<span class="hljs-string">"stopReasonStr=%s"</span>, stopReasonStr.<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>
</li><li>    std::promise&lt;std::string&gt; promise;</li><li>    std::future&lt;std::string&gt; future;</li><li>    std::string responseContent;</li><li>    <span class="hljs-type">bool</span> earlyAbort = <span class="hljs-literal">false</span>;</li><li>};</li><li>
</li><li><span class="hljs-comment">/* 接收到推理结果时的回调函数 */</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnChatResponse</span><span class="hljs-params">(<span class="hljs-type">void</span> *context, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *response)</span></span></li><li><span class="hljs-function"></span>{</li><li>    ChatContext *chatContext = <span class="hljs-built_in">static_cast</span>&lt;ChatContext *&gt;(context);</li><li>    <span class="hljs-keyword">if</span> (chatContext-&gt;earlyAbort) {</li><li>        <span class="hljs-built_in">DEMO_LOGD</span>(<span class="hljs-string">"ignore response after early abort"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>        json responseJson = json::<span class="hljs-built_in">parse</span>(response);</li><li>        chatContext-&gt;responseContent += responseJson.<span class="hljs-built_in">at</span>(<span class="hljs-string">"message"</span>).<span class="hljs-built_in">at</span>(<span class="hljs-string">"content"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();</li><li>        json finishReasonJson = responseJson.<span class="hljs-built_in">at</span>(<span class="hljs-string">"finish_reason"</span>);</li><li>        <span class="hljs-keyword">if</span> (!finishReasonJson.<span class="hljs-built_in">is_null</span>()) {</li><li>            <span class="hljs-comment">/* finish */</span></li><li>            std::string finishReasonStr = finishReasonJson.<span class="hljs-built_in">get</span>&lt;std::string&gt;();</li><li>            chatContext-&gt;promise.<span class="hljs-built_in">set_value</span>(finishReasonStr);</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (chatContext-&gt;responseContent.<span class="hljs-built_in">find</span>(<span class="hljs-string">"\n"</span>) != std::string::npos) {</li><li>            <span class="hljs-comment">/* customized stop */</span></li><li>            chatContext-&gt;promise.<span class="hljs-built_in">set_value</span>(<span class="hljs-string">"customized"</span>);</li><li>            chatContext-&gt;earlyAbort = <span class="hljs-literal">true</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">/* continue */</span></li><li>            ;</li><li>        }</li><li>    } <span class="hljs-built_in">catch</span> (json::exception &amp;e) {</li><li>        <span class="hljs-built_in">DEMO_LOGE</span>(<span class="hljs-string">"failed to parse response: %s"</span>, e.<span class="hljs-built_in">what</span>());</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Demo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">DEMO_LOGI</span>(<span class="hljs-string">"Demo starts"</span>);</li><li>    json attrJson = {</li><li>        <span class="hljs-comment">/* 模型文件位置，根据实际情况修改 */</span></li><li>        {<span class="hljs-string">"model"</span>, <span class="hljs-string">"/data/storage/el2/base/files/qwen2-awq"</span>},</li><li>    };</li><li>    std::string attrStr = attrJson.<span class="hljs-built_in">dump</span>(<span class="hljs-number">4</span>);</li><li>
</li><li>    <span class="hljs-comment">/* 创建会话 */</span></li><li>    OH_QoS_GewuCreateSessionResult createResult = <span class="hljs-built_in">OH_QoS_GewuCreateSession</span>(attrStr.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-keyword">if</span> (createResult.error != OH_QOS_GEWU_OK) {</li><li>        <span class="hljs-built_in">DEMO_LOGE</span>(<span class="hljs-string">"failed to create session, error=%d"</span>, (<span class="hljs-type">int</span>)createResult.error);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    OH_QoS_GewuSession session = createResult.session;</li><li>
</li><li>    <span class="hljs-comment">/* 创建并提交请求 */</span></li><li>    ChatContext context;</li><li>    json requestJson = {</li><li>        {<span class="hljs-string">"messages"</span>, json::<span class="hljs-built_in">array</span>({</li><li>            {{<span class="hljs-string">"role"</span>, <span class="hljs-string">"developer"</span>}, {<span class="hljs-string">"content"</span>, <span class="hljs-string">"You are a helpful assistant"</span>}},</li><li>            {{<span class="hljs-string">"role"</span>, <span class="hljs-string">"user"</span>}, {<span class="hljs-string">"content"</span>, <span class="hljs-string">"What is LLM?"</span>}},</li><li>        })},</li><li>        {<span class="hljs-string">"stream"</span>, <span class="hljs-literal">true</span>},</li><li>    };</li><li>    std::string requestStr = requestJson.<span class="hljs-built_in">dump</span>(<span class="hljs-number">4</span>);</li><li>    OH_QoS_GewuSubmitRequestResult submitResult = <span class="hljs-built_in">OH_QoS_GewuSubmitRequest</span>(session, requestStr.<span class="hljs-built_in">c_str</span>(),</li><li>                                                                           OnChatResponse, &amp;context);</li><li>    <span class="hljs-keyword">if</span> (submitResult.error != OH_QOS_GEWU_OK) {</li><li>        <span class="hljs-built_in">DEMO_LOGE</span>(<span class="hljs-string">"failed to submit request, error=%d"</span>, (<span class="hljs-type">int</span>)submitResult.error);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    OH_QoS_GewuRequest request = submitResult.request;</li><li>    context.<span class="hljs-built_in">Join</span>();</li><li>
</li><li>    <span class="hljs-comment">/* 提前中止请求 */</span></li><li>    <span class="hljs-keyword">if</span> (context.earlyAbort) {</li><li>        OH_QoS_GewuErrorCode error = <span class="hljs-built_in">OH_QoS_GewuAbortRequest</span>(session, request);</li><li>        <span class="hljs-keyword">if</span> (error != OH_QOS_GEWU_OK) {</li><li>            <span class="hljs-built_in">DEMO_LOGE</span>(<span class="hljs-string">"failed to abort request, error=%d"</span>, (<span class="hljs-type">int</span>)error);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">/* 打印结果 */</span></li><li>    <span class="hljs-built_in">DEMO_LOGI</span>(<span class="hljs-string">"response: %s"</span>, context.responseContent.<span class="hljs-built_in">c_str</span>());</li><li>
</li><li>    <span class="hljs-comment">/* 销毁会话 */</span></li><li>    OH_QoS_GewuErrorCode error = <span class="hljs-built_in">OH_QoS_GewuDestroySession</span>(session);</li><li>    <span class="hljs-keyword">if</span> (error != OH_QOS_GEWU_OK) {</li><li>        <span class="hljs-built_in">DEMO_LOGE</span>(<span class="hljs-string">"failed to destroy session, error=%d"</span>, (<span class="hljs-type">int</span>)error);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>在demo代码中，使用了第三方库nlohmann/json来简化JSON数据的解析与构造。nlohmann/json是一个现代C++的JSON库，提供了直观、简洁的方式来处理JSON数据。</p> <p>它的设计理念是让JSON操作像使用STL容器一样自然。</p> <p>开发者可以下载json.hpp文件并放入项目的include目录即可使用，无需额外链接库文件。</p>  </div></div></div> </div> </div> <div></div></div>