<h1 _ngcontent-tjl-c119="" class="doc-title ng-star-inserted" title="案例：Native内存泄漏分析"> 案例：Native内存泄漏分析 </h1>

<div _ngcontent-tjl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000002318843329"><p id="ZH-CN_TOPIC_0000002510174303__p1155118146159">本案例介绍如何判断应用存在Native内存泄漏，以及如何通过Native Allocation泳道找出Native内存泄漏的原因。</p> <div class="tiledSection"><h2 id="section123371691616">初步识别内存问题<i class="anchor-icon anchor-icon-link" anchorid="section123371691616" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002510174303__ol343717150295"><li id="li11938105618435"><span>使用实时监控功能（详细使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/realtime-monitor">性能问题定界：实时监控</a>）对应用的内存资源进行监控。正常操作应用，观察运行过程中的应用内存变化情况。当在一段时间内， 应用内存没有明显增加或者在内存上涨后又逐渐回落至正常水平，则基本可以排除应用存在内存问题；反之，在一段时间内不断上涨，且无回落或者内存占用明显增长超出预期，那么则可初步判断应用可能存在内存问题。</span><p></p><p id="ZH-CN_TOPIC_0000002510174303__p105419711476"><span><img height="392.3376687116565" originheight="655" originwidth="1544" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104942.77204606872022635315329391614709:50001231000000:2800:F429E802214E3F6FDA092BE487864D066230E6FC3CF97ABA797A461C7D0689CD.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li8415612144411"><span>当从实时监控页面初步判断应用可能存在内存问题后，可以使用Memory泳道来抓取应用内存的详细数据以及变化趋势，初步定界问题出现的位置。Allocation或Snapshot模板中均有Memory泳道，使用Allocation或Snapshot模板录制均可。</span></li><li id="li1251093504416"><span>创建模板后，将模板中的其余泳道去除勾选，仅录制Memory泳道的数据。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002510174303__p2912917205113">其余泳道会开启对内存分配、内存对象等数据的抓取，这些功能会带来额外的开销，可能会对我们初步定界问题产生影响，建议先排除录制。</p> </div></div></div> <p id="ZH-CN_TOPIC_0000002510174303__p1390961135117"><span><img originheight="230" originwidth="427" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104942.00251050604041397280457622816058:50001231000000:2800:35406DF69D65E26CE136741EE5DEEAB19F8747E6264DCB9DE301167FE186E1B0.png" width="427" height="230"></span></p> <p></p></li><li id="li9563918174913"><span>点击三角按钮<span><img height="20.136998" originheight="21" originwidth="22" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104942.50931205168074932045618867631800:50001231000000:2800:A1A55E29DD35E23A6056854ED2D6601DCFB3A66BE9B4913D023072711D26F129.png" width="20.882862" class="IconPic notEnlarge"></span>即开始录制。</span></li><li id="li2068013619454"><span>录制过程中，不断在问题场景操作应用功能，放大问题便于快速定界问题点。</span></li><li id="li24294397545"><span>点击下图中方块按钮或者左侧停止按钮结束录制。</span><p></p><p id="ZH-CN_TOPIC_0000002510174303__p108371507251"><span><img height="313.04834355828217" originheight="632" originwidth="1869" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.24379424193483663378438777854982:50001231000000:2800:FAE415605A3D713CE35456BAEADC38E26D253E0438EAA7974B28C9064D6FA537.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li99643131467"><span>录制完成后，展开Memory泳道，其中ArkTS Heap表示方舟虚拟机内存，这部分内存受到方舟虚拟机的管控。Native Heap表示Native内存，主要是应用使用到的一些涉及Native API所申请的内存以及开发者自己的Native代码所申请使用的堆内存（通常是C/C++），这部分内存需要开发者自行管理申请和释放。</span><p></p><p id="ZH-CN_TOPIC_0000002510174303__p19991015184616">当ArkTS Heap有明显的上涨，说明在方舟虚拟机内的堆内存上可能存在内存泄漏，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-snapshot-basic-operations">Snapshot模板</a>进行下一步分析；当Native Heap有明显的上涨，说明Native内存上可能存在内存泄漏，可以使用<a href="/consumer/cn/doc/harmonyos-guides/ide-native-allocation-case#section776643810160">Allocation模板</a>进行下一步分析。</p> <p id="ZH-CN_TOPIC_0000002510174303__p17529105111575"><span><img height="133.54110429447852" originheight="219" originwidth="1544" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.97084781317773602273897478642904:50001231000000:2800:6A4BDC23456C0E0457D08AC6CB88C5367B276A976E61EC4A75C2ECF6217FE26D.png" title="点击放大" width="920"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section776643810160">使用Allocation模板分析Native内存问题<i class="anchor-icon anchor-icon-link" anchorid="section776643810160" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section47251817111814" class="firsth2">录制Allocation模板数据<i class="anchor-icon anchor-icon-link" anchorid="section47251817111814" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002510174303__ol4648165131817"><li id="li064825115181"><span>连接设备后，点击应用选择框选择需要录制的应用，选择<strong>Allocation</strong>模板，点击Create Session或双击Allocation图标即可创建一个Allocation的录制模板。</span></li><li id="li17769618191"><span>创建模板后，点击三角按钮即开始录制。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002510174303__p6520517671">如果要分析启动内存，单击Allocation任务后的<span><img height="19.7638" originheight="17" originwidth="15" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.88987412295420946762126053248132:50001231000000:2800:CEBF0FDA9DC2D3E71355E0B1845FF4D87A82DD929B3129BADAB1FB57D851141F.png" width="18.0481" class="IconPic notEnlarge"></span>按钮。</p> </div></div></div> <p id="ZH-CN_TOPIC_0000002510174303__p1889411111273"><span><img height="155.40662576687117" originheight="257" originwidth="1551" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.08134755203992191433007539352471:50001231000000:2800:BDD040E8A6A57C8BD38E33ED3270A5995038014ECEDFA07DFF93653F4F966C76.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li9577112081916"><span>操作应用复现问题场景，并在问题复现完成后，点击下图中方块按钮或者左侧停止按钮结束录制。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul id="ZH-CN_TOPIC_0000002510174303__ul17338810141112"><li id="li106061413141112">默认使用统计模式采集数据。该模式下工具的采集性能更好、负载更低。</li><li id="li13338410151120">使用统计模式时，录制的结束时间需要是Sampling Interval即采样周期的整数倍，例如当采样周期是10s时，停止录制时间建议在11s+/21s+，以此类推，留出余量给系统做数据处理与传输。</li></ul> </div></div></div> <p id="ZH-CN_TOPIC_0000002510174303__p1039414032711"><span><img height="313.0596319018405" originheight="631" originwidth="1866" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.76138544121837200035806080009874:50001231000000:2800:617D7FA725B2767058FD1C1864BA63655F29641B87137AFBC2846AB460854A87.png" title="点击放大" width="920"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section10328104122016">分析Native数据<i class="anchor-icon anchor-icon-link" anchorid="section10328104122016" tips="复制节点链接"></i></h3><ol id="ZH-CN_TOPIC_0000002510174303__ol1815311816221"><li id="li1815308192218"><span>框选Native Allocation泳道或子泳道。两个子泳道All Heap和All Anonymous VM分别代表使用malloc和mmap函数分配的内存情况。</span></li></ol><ol id="ZH-CN_TOPIC_0000002510174303__ol81537842213" start="2"><li id="li31537810222"><span>在下方详情区的“Statistics”页签中选择Created &amp; Existing。</span><p></p><ul id="ZH-CN_TOPIC_0000002510174303__ul20572124013246"><li id="li127821342152414">All Allocations：框选的时间段的所有分配内存信息。</li><li id="li257213402245">Created &amp; Existing：在框选范围的起点之后分配的，且在框选范围的终点之前没有释放的内存数据。</li><li id="li5524944122418">Created &amp; Released：在框选范围的起点之后分配的，且在框选范围的终点之前已经释放的内存数据。</li></ul> <p id="ZH-CN_TOPIC_0000002510174303__p649413160471"><span><img height="568.0520245398774" originheight="985" originwidth="1599" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.79450489143375182199457575374668:50001231000000:2800:923D39920EDF10812B6EAE95FDC1C55AFF7546861923DC8F142AA0331B14D291.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li17621858171817"><span>切换到“Call Trees”页签，该部分数据展示了详细的内存分配栈信息，同样需要选择Created &amp; Existing。</span><p></p><p id="ZH-CN_TOPIC_0000002510174303__p1057719211910"><span><img height="385.35018404907976" originheight="647" originwidth="1553" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104943.23696540866351921570759276804876:50001231000000:2800:62B3B23C0C02BCC9997336F86A09182EBFA4074FD76872679FC5E6E53F05BCAC.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li3451163914209"><span>优先在内存分配栈信息中寻找与业务代码强相关的Symbol Name，即Category中为亮色。从上图中看，主要泄漏点在业务代码侧，需要结合业务代码进行分析。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul id="ZH-CN_TOPIC_0000002510174303__ul578561812514"><li id="li18785131819517">Category中亮色代表开发者调用栈，灰色代表系统调用栈。</li><li id="li18785418125117">栈帧中主要为 Native 栈，除了应用本身编译的一些so及带有部分接口信息的so信息外，其他系统库部分仅展示so库与函数偏移信息，若需要查看这部分信息，需要导入相应版本的带符号的 so 库（具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-profiler-data#section11376118192614">离线符号解析</a>）。</li></ul> </div></div></div> <p id="ZH-CN_TOPIC_0000002510174303__p335044716512"></p> <p></p></li></ol> </div> <p id="ZH-CN_TOPIC_0000002510174303__p8060118"></p> </div> <div></div></div>