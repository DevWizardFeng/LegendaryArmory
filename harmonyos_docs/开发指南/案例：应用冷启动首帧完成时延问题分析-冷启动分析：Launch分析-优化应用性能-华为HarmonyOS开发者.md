<h1 _ngcontent-jur-c119="" class="doc-title ng-star-inserted" title="案例：应用冷启动首帧完成时延问题分析"> 案例：应用冷启动首帧完成时延问题分析 </h1>

<div _ngcontent-jur-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000002230951317"><p id="ZH-CN_TOPIC_0000002510174403__p2793125922717">应用冷启动首帧完成时延是指从用户点击桌面应用图标离手开始，到应用进程首帧绘制结束的时间。本案例介绍如何找到应用冷启动首帧完成时延起止点，以及如何通过调用栈和trace信息分析应用运行逻辑，定位应用冷启动首帧完成时延超预期的原因。</p> <p id="ZH-CN_TOPIC_0000002510174403__p1314032253518">应用冷启动分析基础功能请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-launch">Launch模板基本操作</a>。</p> <div class="tiledSection"><h2 id="section1871915383612">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section1871915383612" tips="复制节点链接"></i></h2></div> <p id="ZH-CN_TOPIC_0000002510174403__p19217948113413">分析冷启动首帧完成时延类问题步骤如下：</p> <ol id="ZH-CN_TOPIC_0000002510174403__ol0217248183414"><li id="li4401927174113">确认应用冷启动首帧完成时延起止点。</li><li id="li10217048133415">框选应用冷启动首帧完成时延起止点位置，查看耗时是否超预期。</li><li id="li3217154813414">若超过预期，根据调用栈和trace信息进一步确认问题点。</li></ol> <div class="tiledSection"><h2 id="section643221913118">录制Launch模板数据<i class="anchor-icon anchor-icon-link" anchorid="section643221913118" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002510174403__ol12695136173711"><li id="li0695164376"><span>连接设备后，点击应用选择框选择需要录制的应用，选择<strong>Launch</strong>模板，点击<strong>Create Session</strong>或双击Launch图标即可创建一个Launch的录制模板。</span></li><li id="li144951148153917"><span>创建模板后，点击<span><img height="20.667003" originheight="34" originwidth="38" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.54059632974521577668978262228877:50001231000000:2800:188F277D74DB6172DE9399677CC7DC63DE005DB54E79C679DCFB0B5190A276FE.png" width="22.386028000000003" class="notEnlarge"></span>切换启动模式为<span><img height="21.664503000000003" originheight="35" originwidth="38" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.72923519664128288002924010878350:50001231000000:2800:C51945C41C4B40EEB4AD25F892F10A6409A715313532847E7BD5E055975A8B25.png" width="22.865094000000003" class="notEnlarge"></span>手动启动。</span></li><li id="li776165910396"><span>在工具控制栏中点击齿轮图标<span><img height="20.136998" originheight="20" originwidth="22" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.14312684636990646967521165786523:50001231000000:2800:25C195CA93B1DEEEF01CBB9123B8AAD771757F33B89BAE43AF680583465C69CA.png" width="21.686049" class="IconPic notEnlarge"></span>后勾选Hitrace &gt; multimodalinput。用于采集多模子系统的trace信息，这部分信息会包含硬件传递过来的离屏信号，即多模子系统收到点击离手事件。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p191650134012"><span><img height="431.37219999999996" originheight="647" originwidth="1202" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.90459805239042815223249125164509:50001231000000:2800:3BB6FCE40D87D740CD1031B19BDE07160269C15CFF580D57B47BA9E5AFE89106.png" title="点击放大" width="798"></span></p> <p></p></li><li id="li1816182143815"><span>点击三角按钮<span><img height="20.136998" originheight="21" originwidth="22" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.82546403718835936425395171419724:50001231000000:2800:41F5C6F530F981F9E2E5EF36FC8D9F361A4803FD1BE217AD4C2450E9E3C91139.png" width="20.882862" class="IconPic notEnlarge"></span>即开始录制。等待界面出现弹窗提示启动应用后，需要手动点击设备上的应用图标启动应用。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p790818124315"><span><img height="328.2839" originheight="630" originwidth="1540" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.58106159775448375612675996600518:50001231000000:2800:26E646A644FDF7185CF61918E38C2D9EF34A6B98B8491F35D94594E606D8927C.png" title="点击放大" width="798"></span></p> <p></p></li><li id="li11112200145718"><span>待右侧泳道全部显示recording则表明正在录制中，等待应用冷启动结束后可以点击下图中方块按钮或者左侧停止按钮结束录制。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p192481526163614"><span><img height="270.81460000000004" originheight="631" originwidth="1871" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104937.74131089759719278566217222223594:50001231000000:2800:FF39CCF8A9FA5E3ED58E8AB264ED713AAE729201BA6F352CD53D57A1244DEC2C.png" title="点击放大" width="798"></span></p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section847351924216">分析Launch数据<i class="anchor-icon anchor-icon-link" anchorid="section847351924216" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section150945512210" class="firsth2">确认首帧完成时延起止点<i class="anchor-icon anchor-icon-link" anchorid="section150945512210" tips="复制节点链接"></i></h3><p id="ZH-CN_TOPIC_0000002510174403__p155060117319"><strong>冷启动首帧完成时延起点确认：</strong></p> </div> <p id="ZH-CN_TOPIC_0000002510174403__p663711363214">首帧完成时延起点是用户点击桌面应用图标离手的时刻，即多模子系统收到硬件传递过来的离屏信号的时刻。</p> <p id="ZH-CN_TOPIC_0000002510174403__p1948605934415">由于离屏信号对应的trace点耗时较短且不方便记忆，因此需要优先找到桌面进程收到点击离手事件的trace点（H:DispatchTouchEvent），来辅助定位首帧完成时延的起点位置。具体步骤如下：</p> <ol id="ZH-CN_TOPIC_0000002510174403__ol2994111219452"><li id="li899412120457"><span>找到桌面进程收到点击离手事件的trace点（H:DispatchTouchEvent）。在Profiler面板点击搜索框选项区选择<strong>Search Unit Data</strong>搜索泳道数据，在搜索框中输入H:DispatchTouchEvent后回车，通过点击<span><img height="12.6483" originheight="23" originwidth="27" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.68222792741696826857911979701969:50001231000000:2800:E4EED1B129E2B257BAAFEDAD5D2B6D1AA2169BB9A4988993DF0456DF6110F411.png" width="13.3" class="IconPic notEnlarge"></span>或者<span><img height="12.914300000000003" originheight="24" originwidth="34" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.40325986230338969993840151936275:50001231000000:2800:8748C0F9B2C401841D8CAC43AB3EB8EC3004B856B67B541A4ECC5B46E361D4A1.png" width="13.3" class="notEnlarge"></span>按钮切换搜索结果，找到桌面进程泳道（ohos.sceneboard）中type=1（0：手指按下；1：手指抬起；2：滑动）的H:DispatchTouchEvent点并添加标记，为方便后续查找，可以通过双击标记，在弹出的标记属性框中修改标记描述为点击离手事件。该trace点就代表桌面进程收到点击离手事件。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p74931223541"><span><img height="369.4218181818182" originheight="616" originwidth="1543" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.32187526971465156023982207231558:50001231000000:2800:C05F6386878AD7673362ACE8B288BC7212CC6E0C826DC3519E04FBDDE2AEF463.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li1042325512469"><span>搜索多模子系统泳道（mmi_service）。点击搜索框选项区选择<strong>Search Units搜索泳道</strong>，在输入框中输入mmi_service后回车，该泳道可能有多条，需要通过点击<span><img height="12.6483" originheight="23" originwidth="27" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.69971502513096113095727405902225:50001231000000:2800:83E7B34D3B2E47E6D597D989A8013238C8100AD8EC82C582ADDD5F9E8DE093A7.png" width="13.3" class="IconPic notEnlarge"></span>或者<span><img height="12.914300000000003" originheight="24" originwidth="34" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.60201500320701770647329656605316:50001231000000:2800:1B43DB8A5EEFC13E0DDB0E7FF4F5FC1A6E2366AC58E1B924D64C558C92A9CEF8.png" width="13.3" class="notEnlarge"></span>按钮切换搜索结果，找到包含trace片段的mmi_service泳道。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p09556113536"><span><img height="193.61818181818182" originheight="320" originwidth="1543" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.70178146846356305049817855284454:50001231000000:2800:A4C471476553487DA03DB90539CC4F0339387B7F0AD60C84166362B76CC1FCAE.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li168897581797"><span>借助桌面进程收到点击离手事件trace点，继续定位多模子系统收到点击离手事件的trace点。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p72110111012">在mmi_service泳道中找到位于点击离手事件标记位置前方的CPU Running条块（此段时间表示多模子系统正在运行），在该条块下方找到H:service report touchId:{id}, type: up（或H:service report pointerId:{id}, type: button-up）的trace点并添加标记，然后修改标记描述为首帧完成时延起点。该trace点代表的是多模子系统收到点击离手事件，即冷启动首帧完成时延的起点。</p> <p id="ZH-CN_TOPIC_0000002510174403__p193962445419"><span><img height="335.4057142857143" originheight="562" originwidth="1552" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.52667249368910823700842862129565:50001231000000:2800:A145CC91ECC1B10494ACA6DD14D985BCBFA9EE22881B9C4AE77616EC61BEFEDB.png" title="点击放大" width="920"></span></p> <p></p></li></ol> <p id="ZH-CN_TOPIC_0000002510174403__p64885195412"><strong>冷启动</strong><strong>首帧完成</strong><strong>时延止点确认：</strong></p> <p id="ZH-CN_TOPIC_0000002510174403__p032043517134">首帧完成时延止点是应用进程启动后收到的首个硬件垂直同步信号的时间点，即Render Service（统一渲染服务进程）将应用首帧渲染结果呈现到屏幕上的结束点。定位首帧完成时延止点具体步骤如下：</p> <ol id="ZH-CN_TOPIC_0000002510174403__ol184941317195619"><li id="li154941517155616"><span>找到应用进程启动后的首个垂直同步信号trace点H:ReceiveVsync，这个trace点代表应用的首帧开始绘制。选择应用进程子泳道，点击搜索框选项区选择<strong>Search Unit Data</strong>搜索泳道数据，在输入框中输入H:ReceiveVsync后回车，找到第一个H:ReceiveVsync点。<span><img height="340.1012987012987" originheight="567" originwidth="1544" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.43088730066163153080258901627994:50001231000000:2800:150D781C20E46891A4D0AB700C5E0794A3C6A6E1C4A0AB85EB38C16FF2B36C0E.png" title="点击放大" width="920"></span></span></li><li id="li20671174915111"><span>应用进程启动后收到首个垂直同步信号时，会通知Render Service进程进行图形渲染，因此需要优先找到应用进程通知Render Service进程进行图形渲染的三个trace（H:FlushMessages &gt; H:SendCommands &gt; H:MarshRSTransactionData）。由于这三个trace耗时较短，不便查看，因此需要使用搜索功能来确定。框选H:ReceiveVsync trace点，点击搜索框选项区选择<strong>Search Units Data</strong>搜索泳道数据，在输入框中输入FlushMessages后回车。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p2322131719229"><span><img height="313.1942857142857" originheight="522" originwidth="1545" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.86508675953759666797024077456969:50001231000000:2800:A0E3211A9332D40DF101EFB43D36CA65D38FBC2D2CEC30953997982418FF3A22.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li12194627115616"><span>找到trace点H:FlushMessages（代表绘制消息） 后，继续在该trace点下方逐层分析，先找到trace点H:SendCommands（代表发送绘制指令给Render Service进程进行图形渲染），在下方再找到trace点H:MarshRSTransactionData（代表发送了绘制指令），这3个trace点就代表应用进程通知Render Service进程进行图形渲染的流程。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p83069265571"><span><img height="180.08103896103896" originheight="306" originwidth="1588" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.96800754309078200634267000171591:50001231000000:2800:51DA9C6412FEF87CA462F8FF0F20EB6CE0871675EDC50B6ADE4BBC23F2CEF18B.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li10826633165615"><span>接着需要找Render Service进程收到应用进程首帧渲染通知的trace点，点击H:MarshRSTransactionData条块，“Slice Detail”区域可以查看该trace详情，包括trace名称、所属进程等。点击“Slice Detail”区域中Name后方跳转按钮<span><img originheight="15" originwidth="16" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.53086363589803424928338419340710:50001231000000:2800:B510B81393E4B325F4DBF2A6814F5F20E81444852828E0A7BA563C53A734D969.png" class="IconPic notEnlarge" width="16" height="15"></span>跳转到render_service泳道的H:RSMainThread::ProcessCommandUni trace点并添加标记，然后修改标记描述为收到渲染通知。该trace点就代表Render Service进程收到应用进程首帧渲染通知。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p5171215171516"><span><img height="369.18285714285713" originheight="616" originwidth="1544" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.99168660590177106318661172784071:50001231000000:2800:0CC7B6BD161316ED52E4D6E6FF5761161C731997A8D76374108AB835AB96BA51.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li1969018014572"><span>接着找到Render Service将应用首帧提交硬件上屏的trace点，该操作在Render Service送显线程（RSHardwareThrea）中完成。点击搜索框选项区选择<strong>Search Units</strong>搜索泳道，在输入框中输入RSHardwareThrea后回车，查找位于收到渲染通知标记位置后方的第一个H:CommitLayers并添加标记，然后修改标记描述为提交硬件上屏。该trace点代表Render Service将应用首帧提交硬件上屏。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p236064818265"><span><img height="319.56259740259736" originheight="531" originwidth="1540" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.63953900635561063970464117686163:50001231000000:2800:1DD0A03A1B6A174EAA8E272601150A1218BDF120261EBF2491236E68DB915068.png" title="点击放大" width="920"></span></p> <p></p></li><li id="li16106144735616"><span>最后找到Render Service将应用首帧渲染结果呈现到屏幕上的trace点，该操作在Present Fence中完成。点击搜索框选项区选择<strong>Search Units</strong>搜索泳道，在输入框中输入Present Fence后回车，查找位于提交硬件上屏标记位置后方的第一个H:Waiting for Present Fence，该trace点代表Render Service将应用首帧渲染结果呈现到屏幕上，trace点的结束位置就是冷启动首帧完成时延的止点，在此处添加标记并修改标记描述为首帧完成时延止点。</span><p></p><p id="ZH-CN_TOPIC_0000002510174403__p104959131575"><span><img height="315.5122077922078" originheight="529" originwidth="1554" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.60492608884841799092890991264684:50001231000000:2800:1C46935DACE0487B26B2F65BA5D70F0B6632CBAC6D4A962B8DB0EA092A0A1655.png" title="点击放大" width="920"></span></p> <p></p></li></ol> <div class="tiledSection"><h3 id="section9488182819312">案例：应用首页加载耗时较长导致应用冷启动首帧完成时延不达标<i class="anchor-icon anchor-icon-link" anchorid="section9488182819312" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul id="ZH-CN_TOPIC_0000002510174403__ul14281124302420"><li id="li101931345102419">本案例基于应用进程启动过程中，在Ability的生命周期回调函数中做了耗时操作。</li><li id="li17282343142417">预期冷启动首帧完成时延不超过600ms。</li></ul> </div></div></div> <p id="ZH-CN_TOPIC_0000002510174403__p4869837115810">框选应用冷启动首帧完成时延起止点位置，通过框选区间的时间长度看出，冷启动首帧完成时延超过800ms，比预期的600ms长。</p> <p id="ZH-CN_TOPIC_0000002510174403__p143216545215">切换到应用进程trace泳道，查看应用进程trace，下方详情区展示Details信息，包括trace名称、起始时间、持续时长。将持续时间（Duration）降序排序，可以看到主要耗时在H:void OHOS::AbilityRuntime::UIAbilityThread::HandleAbilityTransaction，该阶段主要是AbilityStage/Ability的启动生命周期在执行相应的回调。从这里可以看出，是因为AbilityStage/Ability启动生命周期的回调执行时间较长。接下来需要分析调用栈，通过调用栈分析回调执行时间长的原因。</p> <p id="ZH-CN_TOPIC_0000002510174403__p2854104732018"><span><img height="373.9023376623377" originheight="628" originwidth="1554" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.54685829043465521038116910877283:50001231000000:2800:9A71B674C83DE4C660D1AD05EA2708BBD7BB36E0AC2D4556C938D2A6CEA3F649.png" title="点击放大" width="920"></span></p> <p id="ZH-CN_TOPIC_0000002510174403__p20284235205920">接着切换到ArkTS Callstack泳道分析ArkTS侧耗时函数。优先查看线程号与进程号一致的ArkVM子泳道（该泳道为主线程调用栈），可以看到ArkTS侧一些方法的耗时。从下图中可以看到ArkTS侧无函数执行，需要切换到Callstack泳道看ArkTS和Native混合函数调用栈。</p> <p id="ZH-CN_TOPIC_0000002510174403__p623255714196"><span><img height="380.42597402597397" originheight="637" originwidth="1549" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104938.17231658722217365042863757508430:50001231000000:2800:71FE626E1FB05151040171EC25353FB8E6A04742FD2222A34432EE47D1FAE5F3.png" title="点击放大" width="920"></span></p> <p id="ZH-CN_TOPIC_0000002510174403__p3354172416412">最后切换到Callstack泳道，查看Callstack泳道的主线程（线程号与进程号一致）子泳道，查看下方Heaviest Stack区域，滑动观察权重占比最大的函数调用栈，定位到耗时主要是EntryAbility.ets文件下第79行代码引起，双击该栈帧可以直接跳转到源码文件的对应位置上。</p> <p id="ZH-CN_TOPIC_0000002510174403__p10310174715101"><span><img height="375.69454545454545" originheight="629" originwidth="1549" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104939.09748286464115725067612632578366:50001231000000:2800:EE30293D8D73EC9533A2F96A3872FE57B9D51D90D84238B0A3F974B28F19B3D6.png" title="点击放大" width="920"></span></p> <p id="ZH-CN_TOPIC_0000002510174403__p03160543175">结合业务代码查看，可以看到是因为在EntryAbility.ets文件下onCreate()中做了耗时操作。耗时操作建议通过异步任务延迟处理或者放到其他线程执行，以降低主线程负载，缩短应用冷启动首帧完成时延。</p> <p id="ZH-CN_TOPIC_0000002510174403__p203154212185"><span><img originheight="248" originwidth="722" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251212104939.07005294161286182684767816543082:50001231000000:2800:668016E0E11B31544F5D3086581B863C0EAC04833931098B94A9759B4820EB38.png" width="722" height="248"></span></p> <p id="ZH-CN_TOPIC_0000002510174403__p128891727561">更多应用冷启动优化方案，请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-application-cold-start-optimization" target="_blank">应用冷启动时延优化</a>。</p> </div> </div> <div></div></div>