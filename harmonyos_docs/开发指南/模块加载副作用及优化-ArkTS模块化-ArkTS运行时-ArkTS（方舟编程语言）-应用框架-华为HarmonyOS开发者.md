<h1 _ngcontent-hqw-c119="" class="doc-title ng-star-inserted" title="模块加载副作用及优化"> 模块加载副作用及优化 </h1>

<div _ngcontent-hqw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2><p>当使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-principle">ArkTS模块化</a>时，模块的加载和执行可能会引发<strong>副作用</strong>。副作用是指在模块导入时除了导出功能或对象之外，额外的行为或状态变化，<strong>这些行为可能影响程序的其他部分，并导致产生非预期的顶层代码执行、全局状态变化、原型链修改、导入内容未定义等问题</strong>。</p> </div>  <div class="tiledSection"><h2 id="arkts模块化导致副作用的场景及优化方式">ArkTS模块化导致副作用的场景及优化方式<i class="anchor-icon anchor-icon-link" anchorid="arkts模块化导致副作用的场景及优化方式" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="模块执行顶层代码" class="firsth2">模块执行顶层代码<i class="anchor-icon anchor-icon-link" anchorid="模块执行顶层代码" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>模块在被导入时，整个模块文件中的顶层代码会立即执行，而不仅仅是导出的部分。这意味着，即使只想使用模块中的某些导出内容，任何在顶层作用域中执行的代码也会运行，从而产生副作用。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Module loaded!"</span>); <span class="hljs-comment">// 这段代码在导入时会立即执行，可能会导致副作用。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> data = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span> <span class="hljs-comment">// 导入时，module.ets中的console.info会执行，产生输出。</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Module</span> loaded!</li><li><span class="hljs-number">1</span></li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>即使只需要data，console.info("Module loaded!") 仍会运行，导致开发者可能预期只输出data的值，但却额外输出了“Module loaded!”，<strong>影响输出内容</strong>。</p> <p><strong>优化方式</strong></p> <p>优化方式1：去除顶层代码，只导出需要的内容，避免不必要的代码执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> data = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">1</span></li></ol></pre></div></div> <p>优化方式2：将可能引发副作用的代码放在函数或方法内部，只有在需要时再执行，而不是在模块加载时立即执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Module loaded!"</span>);</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> data = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">1</span></li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="修改全局对象">修改全局对象<i class="anchor-icon anchor-icon-link" anchorid="修改全局对象" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>顶层代码或导入的模块可能会直接<strong>操作全局变量</strong>，改变全局状态，引发副作用。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data1 = <span class="hljs-string">"data from module"</span></li><li>globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 改变了全局状态</span></li><li>
</li><li><span class="hljs-comment">// sideEffectModule.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data2 = <span class="hljs-string">"data from side effect module"</span></li><li>globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">200</span>; <span class="hljs-comment">// 也变了全局状态</span></li><li>
</li><li><span class="hljs-comment">// moduleUseGlobalVar.ets</span></li><li><span class="hljs-keyword">import</span> { data1 } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span> <span class="hljs-comment">// 此时可能预期全局变量someGlobalVar的值为100</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalVar</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data1 is "</span>, data1);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"globalThis.someGlobalVar is "</span>, globalThis.<span class="hljs-property">someGlobalVar</span>); <span class="hljs-comment">// 此时由于main.ets中加载了sideEffectModule模块，someGlobalVar的值已经被改为200</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// main.ets（执行入口）</span></li><li><span class="hljs-keyword">import</span> { data1 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span> <span class="hljs-comment">// 将全局变量someGlobalVar的值改为100</span></li><li><span class="hljs-keyword">import</span> { data2 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./sideEffectModule"</span> <span class="hljs-comment">// 又将全局变量someGlobalVar的值改为200</span></li><li><span class="hljs-keyword">import</span> { useGlobalVar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleUseGlobalVar'</span></li><li>
</li><li><span class="hljs-title function_">useGlobalVar</span>();</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeNotCalledAtAll</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data1 is "</span>, data1);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data2 is "</span>, data2);</li><li>}</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>data from module</li><li>200</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>模块加载时直接修改全局变量 globalThis.someGlobalVar 的值，<strong>会影响其他依赖该变量的模块或代码</strong>。</p> <p><strong>优化方式</strong></p> <p>将可能引发副作用的代码放在函数或方法内部，只有在需要时再执行，而不是在模块加载时立即执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data1 = <span class="hljs-string">"data from module"</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeGlobalVar</span>(<span class="hljs-params"></span>) {</li><li>    globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">100</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// sideEffectModule.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data2 = <span class="hljs-string">"data from side effect module"</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeGlobalVar</span>(<span class="hljs-params"></span>) {</li><li>    globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">200</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// moduleUseGlobalVar.ets</span></li><li><span class="hljs-keyword">import</span> { data1, changeGlobalVar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalVar</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data1 is "</span>, data1);</li><li>    <span class="hljs-title function_">changeGlobalVar</span>(); <span class="hljs-comment">// 在需要的时候执行代码，而不是模块加载时执行。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"globalThis.someGlobalVar is "</span>, globalThis.<span class="hljs-property">someGlobalVar</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// main.ets（执行入口）</span></li><li><span class="hljs-keyword">import</span> { data1 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span></li><li><span class="hljs-keyword">import</span> { data2 } <span class="hljs-keyword">from</span> <span class="hljs-string">"./sideEffectModule"</span></li><li><span class="hljs-keyword">import</span> { useGlobalVar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleUseGlobalVar'</span></li><li>
</li><li><span class="hljs-title function_">useGlobalVar</span>();</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeNotCalledAtAll</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data1 is "</span>, data1);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data2 is "</span>, data2);</li><li>}</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>data from module</li><li>100</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="修改应用级arkui组件的状态变量信息">修改应用级ArkUI组件的状态变量信息<i class="anchor-icon anchor-icon-link" anchorid="修改应用级arkui组件的状态变量信息" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>顶层代码或导入的模块可能会直接<strong>修改应用级ArkUI组件的状态变量信息</strong>，改变全局状态，引发副作用。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data = <span class="hljs-string">"data from module"</span></li><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"SomeAppStorageVar"</span>, <span class="hljs-number">200</span>); <span class="hljs-comment">// 修改应用全局的UI状态</span></li><li>
</li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span> <span class="hljs-comment">// 将AppStorage中的SomeAppStorageVar改为200</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-comment">// 开发者可能预期该值为100，但是由于module模块导入，该值已经被修改为200，但开发者可能并不知道值已经被修改</span></li><li>    <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">"SomeAppStorageVar"</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">"test"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>    }</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeNotCalledAtAll</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li><li>}</li></ol></pre></div></div> <p>显示内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>test200</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>模块加载时直接修改AppStorage中SomeAppStorageVar的值，<strong>会影响其他依赖该变量的模块或代码</strong>。</p> <p>ArkUI组件的状态变量信息可以通过一些应用级接口修改，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state-management-overview">ArkUI状态管理接口文档</a>。</p> <p><strong>优化方式</strong></p> <p>将可能引发副作用的代码放在函数或方法内部，只有在需要时再执行，而不是在模块加载时立即执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data = <span class="hljs-string">"data from module"</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"SomeAppStorageVar"</span>, <span class="hljs-number">200</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">"SomeAppStorageVar"</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">"test"</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>    }</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeNotCalledAtAll</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li><li>}</li></ol></pre></div></div> <p>显示内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>test100</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="修改内置全局变量或原型链arkts内禁止修改对象原型与内置方法">修改内置全局变量或原型链（ArkTS内禁止修改对象原型与内置方法）<i class="anchor-icon anchor-icon-link" anchorid="修改内置全局变量或原型链arkts内禁止修改对象原型与内置方法" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>为使现代JavaScript特性能够在旧版浏览器或运行环境中运行，第三方库或框架可能会修改内置的全局对象或原型链，从而影响其他代码的执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// modifyPrototype.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data = <span class="hljs-string">"data from modifyPrototype"</span></li><li><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">includes</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">indexOf</span>(value) !== -<span class="hljs-number">1</span>;</li><li>};</li><li>
</li><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { data } <span class="hljs-keyword">from</span> <span class="hljs-string">"./modifyPrototype"</span> <span class="hljs-comment">// 此时修改了Array的原型链</span></li><li><span class="hljs-keyword">let</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"arr.includes(1) = "</span> + arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 此时调用的是modifyPrototype.ts中的Array.prototype.includes方法</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">maybeNotCalledAtAll</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li><li>}</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>修改内置的全局对象或原型链，可能会影响其他代码运行。</p> <p><strong>优化方式</strong></p> <p>导入可能会修改内置的全局对象或原型链的第三方库时，确认该第三方库的行为是符合预期的。</p> </div>  <div class="tiledSection"><h3 id="循环依赖">循环依赖<i class="anchor-icon anchor-icon-link" anchorid="循环依赖" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>ArkTS模块化支持循环依赖，即模块A依赖模块B，同时模块B又依赖模块A。在这种情况下，某些导入的模块可能尚未完全加载，从而导致部分代码在执行时行为异常，产生意外的副作用。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// a.ets</span></li><li><span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">"./b"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Module A: '</span>, b);</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-string">'A'</span>;</li><li>
</li><li><span class="hljs-comment">// b.ets</span></li><li><span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">"./a"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Module B: '</span>, a);</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-string">'B'</span>;</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>Error message: a is not initialized</li><li>Stacktrace:</li><li>    at func_main_0 (b.ets:2:27)</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>由于模块间相互依赖，模块的执行顺序可能导致导出的内容未定义，影响代码的逻辑流，具体报错信息为：“变量名 is not initialized”。</p> <p><strong>优化方式</strong></p> <p>尽量避免模块间的循环依赖，确保模块的加载顺序是明确和可控的，以避免产生意外的副作用。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide_no-cycle" target="_blank">@security/no-cycle循环依赖检查工具</a> 可以辅助检查循环依赖。</p> </div>  <div class="tiledSection"><h3 id="延迟加载lazy-import改变模块执行顺序可能导致预期的全局变量未定义">延迟加载（lazy import）改变模块执行顺序，可能导致预期的全局变量未定义<i class="anchor-icon anchor-icon-link" anchorid="延迟加载lazy-import改变模块执行顺序可能导致预期的全局变量未定义" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-lazy-import">延迟加载</a>特性可使待加载模块在冷启动阶段不被加载，直至应用程序实际运行过程中需要用到这些模块时，才按需同步加载相关模块，从而缩短应用冷启动耗时。但这也同时会改变模块的执行顺序。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data = <span class="hljs-string">"data from module"</span></li><li>globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">100</span>;</li><li>
</li><li><span class="hljs-comment">// moduleUseGlobalVar.ets</span></li><li><span class="hljs-keyword">import</span> lazy { data } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"globalThis.someGlobalVar"</span>, globalThis.<span class="hljs-property">someGlobalVar</span>); <span class="hljs-comment">// 此时由于lazy特性，module模块还未执行，someGlobalVar的值为undefined</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data); <span class="hljs-comment">// 使用到module模块的变量，此时module模块执行，someGlobalVar的值变为100</span></li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>undefined</li><li>data from module</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>由于使用到延迟加载（lazy import）特性，会导致模块变量在使用到时再执行对应的模块，模块中的一些全局变量修改行为也会延迟，可能会导致运行结果不符合预期。</p> <p><strong>优化方式</strong></p> <p>将可能引发副作用的代码放在函数或方法内部，只有在需要时再执行，而不是在模块加载时立即执行。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> data = <span class="hljs-string">"data from module"</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"></span>) {</li><li>    globalThis.<span class="hljs-property">someGlobalVar</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 延迟到函数调用时执行</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// moduleUseGlobalVar.ets</span></li><li><span class="hljs-keyword">import</span> lazy { data, initialize } <span class="hljs-keyword">from</span> <span class="hljs-string">"./module"</span></li><li><span class="hljs-title function_">initialize</span>(); <span class="hljs-comment">// 执行初始化函数，初始化someGlobalVar</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"globalThis.someGlobalVar is "</span>, globalThis.<span class="hljs-property">someGlobalVar</span>); <span class="hljs-comment">// 此时someGlobalVar一定为预期的值</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"data is "</span>, data);</li></ol></pre></div></div> <p>输出内容：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>100</li><li>data from module</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="通过import路径展开优化性能">通过import路径展开优化性能<i class="anchor-icon anchor-icon-link" anchorid="通过import路径展开优化性能" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="原理" class="firsth2">原理<i class="anchor-icon anchor-icon-link" anchorid="原理" tips="复制节点链接"></i></h3><p>在import语句中，跳过中间的依赖路径，直接依赖变量对应的模块，即为import路径展开。</p> <p>下文将通过示例说明import路径展开优化性能的原理。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> har <span class="hljs-keyword">from</span> <span class="hljs-string">"har"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"har.One is "</span>, har.<span class="hljs-property">One</span>); <span class="hljs-comment">// 这里的One变量是har/src/main/ets/NumberString.ets导出的</span></li><li>
</li><li><span class="hljs-comment">// har/Index.ets</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./src/main/ets/OtherModule1"</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./src/main/ets/OtherModule2"</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./src/main/ets/Utils"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"har Index.ets execute."</span>);</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/Utils.ets</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./OtherModule3"</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./OtherModule4"</span></li><li><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./NumberString"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"har Utils.ets execute."</span>);</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/NumberString.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">One</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"1"</span>;</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"har NumberString.ets execute."</span>);</li></ol></pre></div></div> <ol><li><p>如果main.ets只需要依赖har中的NumberString模块，import xxx from "har"的写法会导致har整条链路上的模块被解析、执行，<strong>导致模块解析及执行耗时增加</strong>。上述例子中的har/Index、OtherModule1、OtherModule2、Utils、OtherModule3、OtherModule4、NumberString模块均会被解析、执行。</p>  </li><li><p>在模块解析阶段会通过深度优先遍历的方式建立变量的绑定关系，main.ets中使用的har.One变量是由har/src/main/ets/NumberString.ets导出的，由于使用了export 的写法，建立变量的绑定关系时需要递归去进行变量名的匹配，从而*导致模块解析耗时增加。</p> <p>在上述例子中，会先查找 har/Index.ets 文件。该文件中有多个 export * 语句，因此会依次检查 OtherModule1 和 OtherModule2 是否导出 One 变量。接着，找到 Utils 模块，该模块也有 export * 语句，因此会继续检查 OtherModule3 和 OtherModule4，最终确定 One 变量是从 NumberString 模块导出的。</p>  </li></ol> <p>优化方式：改为如下的代码写法，跳过中间的依赖路径，直接依赖变量对应的模块。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">One</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"har/src/main/ets/NumberString"</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"One is "</span>, <span class="hljs-title class_">One</span>);</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/NumberString.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">One</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"1"</span>;</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"har NumberString.ets execute."</span>);</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="副作用">副作用<i class="anchor-icon anchor-icon-link" anchorid="副作用" tips="复制节点链接"></i></h3><p><strong>副作用产生场景</strong></p> <p>由于import路径展开会跳过中间模块的执行，若业务依赖模块的执行顺序，修改后可能会导致业务异常。</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { serviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"har"</span></li><li>
</li><li>serviceManager.<span class="hljs-title function_">print</span>();</li><li>
</li><li><span class="hljs-comment">// har/Index.ets</span></li><li><span class="hljs-keyword">import</span> { serviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"./src/main/ets/ServiceManager"</span></li><li>
</li><li>serviceManager.<span class="hljs-title function_">init</span>();</li><li><span class="hljs-keyword">export</span> { serviceManager }</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/ServiceManager.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceManager</span> {</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-attr">inited</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>    </li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span> = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">print</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ServiceManager is inited."</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"ServiceManager is not inited."</span>);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceManager</span>: <span class="hljs-title class_">ServiceManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceManager</span>();</li></ol></pre></div></div> <p>运行的输出为：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>ServiceManager is inited.</li></ol></pre></div></div> <p>如果进行import路径展开，展开后的代码为：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { serviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"har/src/main/ets/ServiceManager"</span></li><li>
</li><li>serviceManager.<span class="hljs-title function_">print</span>();</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/ServiceManager.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceManager</span> {</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-attr">inited</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span> = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">print</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ServiceManager is inited."</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"ServiceManager is not inited."</span>);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceManager</span>: <span class="hljs-title class_">ServiceManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceManager</span>();</li></ol></pre></div></div> <p>运行的输出为：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>ServiceManager is not inited.</li></ol></pre></div></div> <p><strong>产生的副作用</strong></p> <p>由于har/Index模块中存在顶层代码进行ServiceManager的初始化，如果在main模块中进行import路径展开，将不会执行har/Index模块，从而导致ServiceManager未初始化，可能引起业务异常。</p> <p><strong>优化方式</strong></p> <p>开发者需根据业务需要排查跳过执行顶层代码的影响，并进行相应的修改。</p> <p>对于上文的示例，可以进行如下修改：</p> <div _ngcontent-hqw-c106="" class="highlight-div"><div _ngcontent-hqw-c106="" class="highlight-div-header"><div _ngcontent-hqw-c106="" class="highlight-div-header-left"><div _ngcontent-hqw-c106="" class="handle-button expand-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqw-c106="" class="highlight-div-header-right"><div _ngcontent-hqw-c106="" class="handle-button ai-button"></div><div _ngcontent-hqw-c106="" class="handle-button line-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqw-c106="" class="handle-button theme-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqw-c106="" class="handle-button copy-button"><div _ngcontent-hqw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// main.ets</span></li><li><span class="hljs-keyword">import</span> { serviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"har/src/main/ets/ServiceManager"</span></li><li>
</li><li>serviceManager.<span class="hljs-title function_">print</span>();</li><li>
</li><li><span class="hljs-comment">// har/src/main/ets/ServiceManager.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceManager</span> {</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-attr">inited</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span> = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">print</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inited</span>) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"ServiceManager is inited."</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"ServiceManager is not inited."</span>);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceManager</span>: <span class="hljs-title class_">ServiceManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceManager</span>();</li><li><span class="hljs-comment">// 在导出的模块执行对应的逻辑。</span></li><li>serviceManager.<span class="hljs-title function_">init</span>();</li></ol></pre></div></div> </div> </div> <div></div></div>