<h1 _ngcontent-mvs-c119="" class="doc-title ng-star-inserted" title="流式传输"> 流式传输 </h1>

<div _ngcontent-mvs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section123091617105820">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section123091617105820" tips="复制节点链接"></i></h2>          <p>HTTP流式传输（Streaming）允许客户端与服务器之间以流的形式进行数据交互，而无需等待所有数据准备完毕，能显著提升用户体验。流式传输适用于大文件的上传下载、直播、实时数据更新等场景。</p>    </div>    <div class="tiledSection">     <h2 id="section15385135185019">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section15385135185019" tips="复制节点链接"></i></h2>          <p>同步读写流能力支持Phone、2in1、Tablet、Wearable设备。并且从5.1.1(19)开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section2376128537">基于缓冲区的流式传输<i class="anchor-icon anchor-icon-link" anchorid="section2376128537" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section745913016369" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section745913016369" tips="复制节点链接"></i></h3>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section127952271692" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="50.17%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="49.830000000000005%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50.17%">          <p>write(buffer: string | ArrayBuffer): void</p></td>         <td class="cellrowborder" valign="top" width="49.830000000000005%">          <p>将一段数据写入队列当中，框架的IO线程会在合适的时候把该数据发送出去。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50.17%">          <p>read(buffer: ArrayBuffer): Promise&lt;number&gt;</p></td>         <td class="cellrowborder" valign="top" width="49.830000000000005%">          <p>从文件中读取数据。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section7719826133913">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section7719826133913" tips="复制节点链接"></i></h3>          <ol>      <li><span>导入模块。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>利用rcp.NetworkInputQueue创建同步写队列对象实现同步写功能。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">testNetworkInputQueue</span> = (<span class="hljs-params"></span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建同步写队列对象</span></li><li>  <span class="hljs-keyword">const</span> networkInputQueue = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">NetworkInputQueue</span>();</li><li>  <span class="hljs-comment">// 模拟文件通过同步读写流上传场景，将文件写入到同步写队列 networkInputQueue 中</span></li><li>  <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 添加数据到同步写队列</span></li><li>    networkInputQueue.<span class="hljs-title function_">write</span>(<span class="hljs-string">'a counter '</span> + counter++);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`networkInputQueue write`</span>);</li><li>    <span class="hljs-keyword">if</span> (counter === <span class="hljs-number">10</span>) {</li><li>      <span class="hljs-built_in">clearInterval</span>(interval);</li><li>      <span class="hljs-comment">// 关闭同步写队列</span></li><li>      networkInputQueue.<span class="hljs-title function_">close</span>();</li><li>    }</li><li>  }, <span class="hljs-number">1000</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 创建session</span></li><li>    <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Post start.`</span>);</li><li>    <span class="hljs-comment">// 发起请求，相关数据在写入队列 networkInputQueue 的同时会同步进行上传</span></li><li>    session.<span class="hljs-title function_">post</span>(<span class="hljs-string">'https://httpbin.org/anything'</span>, networkInputQueue).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 结果状态码</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Response status code is: <span class="hljs-subst">${response.statusCode}</span>`</span>);</li><li>      <span class="hljs-keyword">if</span> (response &amp;&amp; response.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Post succeeded! response: <span class="hljs-subst">${response.toString()}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Post failed.`</span>);</li><li>      }</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Post error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`create session error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>利用rcp.NetworkOutputQueue创建同步读队列对象实现同步读功能。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">testNetworkOutputQueue</span> = (<span class="hljs-params"></span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建同步读队列对象</span></li><li>  <span class="hljs-keyword">const</span> networkOutputQueue = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">NetworkOutputQueue</span>();</li><li>  <span class="hljs-comment">// 创建session</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>    <span class="hljs-comment">// 配置请求流数据size</span></li><li>    <span class="hljs-keyword">const</span> numOfChunks = <span class="hljs-number">10</span>;</li><li>    <span class="hljs-keyword">const</span> chunkLength = <span class="hljs-number">1000</span>;</li><li>    <span class="hljs-keyword">const</span> totalBytes = numOfChunks * chunkLength;</li><li>    <span class="hljs-comment">// 发起请求，响应数据会暂存在同步读队列networkOutputQueue中</span></li><li>    session.<span class="hljs-title function_">get</span>(<span class="hljs-string">'https://httpbin.org/bytes/'</span> + totalBytes.<span class="hljs-title function_">toString</span>(), networkOutputQueue).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (response &amp;&amp; response.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`get byts succeeded.`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`get byts failed.`</span>);</li><li>      }</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`get byts error: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    });</li><li>    <span class="hljs-comment">// 在需要使用响应数据时，可按需从 `networkOutputQueue` 队列中循环读取，例如每隔 1000 毫秒读取一次，每次读取 1000 个字节的数据</span></li><li>    <span class="hljs-keyword">let</span> totalGetLength = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 读取数据后，开发者需根据具体业务场景进行后续处理</span></li><li>      <span class="hljs-keyword">const</span> chunk = networkOutputQueue.<span class="hljs-title function_">read</span>(chunkLength);</li><li>      totalGetLength += chunk.<span class="hljs-property">byteLength</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`get byts totalGetLength: <span class="hljs-subst">${totalGetLength}</span>`</span>);</li><li>      <span class="hljs-comment">// 数据读取完成后，清除计时器</span></li><li>      <span class="hljs-keyword">if</span> (totalGetLength === totalBytes) {</li><li>        <span class="hljs-built_in">clearInterval</span>(intervalId);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`get byts finished.`</span>);</li><li>      }</li><li>    }, <span class="hljs-number">1000</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`create session error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section631595825317">基于回调函数的流式传输<i class="anchor-icon anchor-icon-link" anchorid="section631595825317" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section11618191810544" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section11618191810544" tips="复制节点链接"></i></h3>          <p>具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section187981940151318" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.1" valign="top" width="81.52000000000001%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.2" valign="top" width="18.48%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="81.52000000000001%">          <p>uploadFromStream(url: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section320653742718" target="_blank">URLOrString</a>, uploadFrom: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section187981940151318" target="_blank">UploadFromStream</a>): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section156381815599" target="_blank">Response</a>&gt;</p></td>         <td class="cellrowborder" valign="top" width="18.48%">          <p>从流中上传。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="81.52000000000001%">          <p>downloadToStream(url: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section320653742718" target="_blank">URLOrString</a>, downloadTo: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section1790033215431" target="_blank">DownloadToStream</a>): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section156381815599" target="_blank">Response</a>&gt;</p></td>         <td class="cellrowborder" valign="top" width="18.48%">          <p>下载到流中。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section117211126103916">使用示例<i class="anchor-icon anchor-icon-link" anchorid="section117211126103916" tips="复制节点链接"></i></h3>          <ol>      <li><span>导入模块。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rcp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.RemoteCommunicationKit'</span>;</li><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.file.fs'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>定义FdReadStream实现rcp.ReadStream接口，从流中读取数据。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FdReadStream</span> <span class="hljs-keyword">implements</span> rcp.<span class="hljs-property">ReadStream</span> {</li><li>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fd: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span> = fd;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">read</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> fs.<span class="hljs-title function_">read</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span>, buffer);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>调用uploadFromStream接口以流的形式上传数据。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testUploadFromStream</span>(<span class="hljs-params">uploadFilePath: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 创建session</span></li><li>    <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>    <span class="hljs-comment">// 根据传入的上传文件的路径打开文件</span></li><li>    <span class="hljs-keyword">const</span> file = fs.<span class="hljs-title function_">openSync</span>(uploadFilePath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    <span class="hljs-comment">// 文件读取流</span></li><li>    <span class="hljs-keyword">const</span> fileStream = <span class="hljs-keyword">new</span> rcp.<span class="hljs-title class_">UploadFromStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FdReadStream</span>(file.<span class="hljs-property">fd</span>));</li><li>    <span class="hljs-comment">// 以流的形式上传数据</span></li><li>    session.<span class="hljs-title function_">uploadFromStream</span>(<span class="hljs-string">'https://httpbin.org/anything'</span>, fileStream).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resp</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`testUploadFromStream response: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(resp)}</span>`</span>);</li><li>      <span class="hljs-keyword">if</span> (resp &amp;&amp; resp.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`testUploadFromStream succeeded.`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testUploadFromStream failed.`</span>);</li><li>      }</li><li>      <span class="hljs-comment">// 完成后关闭文件和session</span></li><li>      fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testUploadFromStream error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>      session.<span class="hljs-title function_">close</span>();</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testUploadFromStream error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>定义FdWriteStream实现WriteStream接口，将数据写入流中。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FdWriteStream</span> <span class="hljs-keyword">implements</span> rcp.<span class="hljs-property">WriteStream</span> {</li><li>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fd: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span> = fd;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">write</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span> | <span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> fs.<span class="hljs-title function_">write</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span>, buffer);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>调用downloadToStream接口，以流的形式下载数据。</span>       <p></p>       <div _ngcontent-mvs-c106="" class="highlight-div"><div _ngcontent-mvs-c106="" class="highlight-div-header"><div _ngcontent-mvs-c106="" class="highlight-div-header-left"><div _ngcontent-mvs-c106="" class="handle-button expand-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mvs-c106="" class="highlight-div-header-right"><div _ngcontent-mvs-c106="" class="handle-button ai-button"></div><div _ngcontent-mvs-c106="" class="handle-button line-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mvs-c106="" class="handle-button theme-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mvs-c106="" class="handle-button copy-button"><div _ngcontent-mvs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mvs-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testDownloadToStream</span>(<span class="hljs-params">downloadToPath: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 创建session</span></li><li>    <span class="hljs-keyword">const</span> session = rcp.<span class="hljs-title function_">createSession</span>();</li><li>    <span class="hljs-comment">// 根据传入的下载文件保存路径打开文件</span></li><li>    <span class="hljs-keyword">const</span> file = fs.<span class="hljs-title function_">openSync</span>(downloadToPath, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span>);</li><li>    <span class="hljs-comment">// 文件写入流</span></li><li>    <span class="hljs-keyword">const</span> fileStream = { <span class="hljs-attr">kind</span>: <span class="hljs-string">'stream'</span>, <span class="hljs-attr">stream</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">FdWriteStream</span>(file.<span class="hljs-property">fd</span>) } <span class="hljs-keyword">as</span> rcp.<span class="hljs-property">DownloadToStream</span></li><li>    <span class="hljs-comment">// 以流的形式下载数据</span></li><li>    session.<span class="hljs-title function_">downloadToStream</span>(<span class="hljs-string">'https://httpbin.org/bytes/'</span>, fileStream)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resp</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`testDownloadToStream response: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(resp)}</span>`</span>);</li><li>        <span class="hljs-keyword">if</span> (resp &amp;&amp; resp.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`testDownloadToStream succeeded.`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testDownloadToStream failed.`</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 完成后关闭文件和session</span></li><li>        fs.<span class="hljs-title function_">close</span>(file.<span class="hljs-property">fd</span>);</li><li>        session.<span class="hljs-title function_">close</span>();</li><li>      })</li><li>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testDownloadToStream error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>        fs.<span class="hljs-title function_">close</span>(file.<span class="hljs-property">fd</span>);</li><li>        session.<span class="hljs-title function_">close</span>();</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`testDownloadToStream error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>