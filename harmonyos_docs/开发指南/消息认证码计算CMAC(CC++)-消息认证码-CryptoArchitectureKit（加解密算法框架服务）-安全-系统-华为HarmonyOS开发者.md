<h1 _ngcontent-wyt-c119="" class="doc-title ng-star-inserted" title="消息认证码计算CMAC(C/C++)"> 消息认证码计算CMAC(C/C++) </h1>

<div _ngcontent-wyt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>CMAC通过使用分组密码（如AES）和一个密钥来生成认证码，确保消息在传输过程中未被篡改。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>在调用update接口传入数据时，可以<a href="/consumer/cn/doc/harmonyos-guides/crypto-compute-cmac-ndk#cmac一次性传入">一次性传入</a>，也可以把数据人工<a href="/consumer/cn/doc/harmonyos-guides/crypto-compute-cmac-ndk#cmac分段传入">分段传入</a>。对于同一段数据而言，是否分段，计算结果没有差异。对于数据量较大的数据，开发者可以根据实际需求选择是否分段传入。</p>     <p>下面分别提供两种方式的示例代码。</p>    </div>    <div class="tiledSection">     <h3 id="cmac一次性传入" class="firsth2">CMAC（一次性传入）<i class="anchor-icon anchor-icon-link" anchorid="cmac一次性传入" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-sym-key-h#oh_cryptosymkeygenerator_create" target="_blank">OH_CryptoSymKeyGenerator_Create</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-sym-key-h#oh_cryptosymkeygenerator_generate" target="_blank">OH_CryptoSymKeyGenerator_Generate</a>生成密钥算法为AES128的对称密钥（symKey）。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_create" target="_blank">OH_CryptoMac_Create</a>，指定字符串参数'CMAC'，创建MAC算法为CMAC的MAC生成器。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_setparam" target="_blank">OH_CryptoMac_SetParam</a>，指定参数CRYPTO_MAC_CIPHER_NAME_STR，设置分组密码算法名称。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_init" target="_blank">OH_CryptoMac_Init</a>，指定共享对称密钥（symKey），初始化MAC对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_update" target="_blank">OH_CryptoMac_Update</a>，传入自定义消息，进行消息认证码计算。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_final" target="_blank">OH_CryptoMac_Final</a>，获取MAC计算结果。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_getlength" target="_blank">OH_CryptoMac_GetLength</a>，获取MAC消息认证码的长度，单位为字节。</p></li>     </ol>     <div _ngcontent-wyt-c106="" class="highlight-div"><div _ngcontent-wyt-c106="" class="highlight-div-header"><div _ngcontent-wyt-c106="" class="highlight-div-header-left"><div _ngcontent-wyt-c106="" class="handle-button expand-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyt-c106="" class="highlight-div-header-right"><div _ngcontent-wyt-c106="" class="handle-button ai-button"></div><div _ngcontent-wyt-c106="" class="handle-button line-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyt-c106="" class="handle-button theme-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyt-c106="" class="handle-button copy-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_CryptoSymKey *<span class="hljs-title">GenerateAesKey</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *algoName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    OH_CryptoSymKeyGenerator *keyGen = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Create</span>(algoName, &amp;keyGen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    OH_CryptoSymKey *keyCtx = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Generate</span>(keyGen, &amp;keyCtx);</li><li>    <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Destroy</span>(keyGen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> keyCtx;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestCmacOnce</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 生成AES128密钥。</span></li><li>    OH_CryptoSymKey *keyCtx = <span class="hljs-built_in">GenerateAesKey</span>(<span class="hljs-string">"AES128"</span>);</li><li>    <span class="hljs-keyword">if</span> (keyCtx == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> CRYPTO_OPERTION_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建CMAC生成器。</span></li><li>    OH_CryptoMac *ctx = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoMac_Create</span>(<span class="hljs-string">"CMAC"</span>, &amp;ctx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置分组密码算法名称为AES128。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cipherName = <span class="hljs-string">"AES128"</span>;</li><li>    Crypto_DataBlob cipherNameData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(cipherName)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(cipherName)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_SetParam</span>(ctx, CRYPTO_MAC_CIPHER_NAME_STR, &amp;cipherNameData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 初始化CMAC计算。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_Init</span>(ctx, keyCtx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 一次性传入所有数据。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *message = <span class="hljs-string">"cmacTestMessage"</span>;</li><li>    Crypto_DataBlob input = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(message)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(message)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_Update</span>(ctx, &amp;input);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 完成CMAC计算并获取结果。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_Final</span>(ctx, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取CMAC值的长度。</span></li><li>    <span class="hljs-type">uint32_t</span> macLen = <span class="hljs-number">0</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_GetLength</span>(ctx, &amp;macLen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"CMAC calculation success, length: %u\n"</span>, macLen);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>    <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="cmac分段传入">CMAC（分段传入）<i class="anchor-icon anchor-icon-link" anchorid="cmac分段传入" tips="复制节点链接"></i></h3>          <p>与一次性传入的步骤基本相同，区别在于多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-crypto-mac-h#oh_cryptomac_update" target="_blank">OH_CryptoMac_Update</a>来处理分段数据。</p>     <div _ngcontent-wyt-c106="" class="highlight-div"><div _ngcontent-wyt-c106="" class="highlight-div-header"><div _ngcontent-wyt-c106="" class="highlight-div-header-left"><div _ngcontent-wyt-c106="" class="handle-button expand-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyt-c106="" class="highlight-div-header-right"><div _ngcontent-wyt-c106="" class="handle-button ai-button"></div><div _ngcontent-wyt-c106="" class="handle-button line-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyt-c106="" class="handle-button theme-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyt-c106="" class="handle-button copy-button"><div _ngcontent-wyt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyt-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CryptoArchitectureKit/crypto_architecture_kit.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_CryptoSymKey *<span class="hljs-title">GenerateAesKey</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *algoName)</span></span></li><li><span class="hljs-function"></span>{</li><li>    OH_CryptoSymKeyGenerator *keyGen = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Create</span>(algoName, &amp;keyGen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    OH_CryptoSymKey *keyCtx = <span class="hljs-literal">nullptr</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Generate</span>(keyGen, &amp;keyCtx);</li><li>    <span class="hljs-built_in">OH_CryptoSymKeyGenerator_Destroy</span>(keyGen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> keyCtx;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Crypto_ErrCode <span class="hljs-title">doTestCmacBySegments</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 生成AES128密钥。</span></li><li>    OH_CryptoSymKey *keyCtx = <span class="hljs-built_in">GenerateAesKey</span>(<span class="hljs-string">"AES128"</span>);</li><li>    <span class="hljs-keyword">if</span> (keyCtx == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> CRYPTO_OPERTION_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建CMAC生成器。</span></li><li>    OH_CryptoMac *ctx = <span class="hljs-literal">nullptr</span>;</li><li>    OH_Crypto_ErrCode ret = <span class="hljs-built_in">OH_CryptoMac_Create</span>(<span class="hljs-string">"CMAC"</span>, &amp;ctx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 设置分组密码算法名称为AES128。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cipherName = <span class="hljs-string">"AES128"</span>;</li><li>    Crypto_DataBlob cipherNameData = {</li><li>        .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(cipherName)),</li><li>        .len = <span class="hljs-built_in">strlen</span>(cipherName)</li><li>    };</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_SetParam</span>(ctx, CRYPTO_MAC_CIPHER_NAME_STR, &amp;cipherNameData);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 初始化CMAC计算。</span></li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_Init</span>(ctx, keyCtx);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 分段传入数据。</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *message = <span class="hljs-string">"aaaaa.....bbbbb.....ccccc.....ddddd.....eee"</span>;</li><li>    <span class="hljs-type">size_t</span> messageLen = <span class="hljs-built_in">strlen</span>(message);</li><li>    <span class="hljs-type">size_t</span> segmentSize = <span class="hljs-number">20</span>; <span class="hljs-comment">// 每段20字节。</span></li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; messageLen; i += segmentSize) {</li><li>        <span class="hljs-type">size_t</span> currentSize = (i + segmentSize &lt;= messageLen) ? segmentSize : (messageLen - i);</li><li>        Crypto_DataBlob segment = {</li><li>            .data = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint8_t</span> *&gt;(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(message + i)),</li><li>            .len = currentSize</li><li>        };</li><li>        ret = <span class="hljs-built_in">OH_CryptoMac_Update</span>(ctx, &amp;segment);</li><li>        <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>            <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>            <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>            <span class="hljs-keyword">return</span> ret;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 完成CMAC计算并获取结果。</span></li><li>    Crypto_DataBlob out = {<span class="hljs-number">0</span>};</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_Final</span>(ctx, &amp;out);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取CMAC值的长度。</span></li><li>    <span class="hljs-type">uint32_t</span> macLen = <span class="hljs-number">0</span>;</li><li>    ret = <span class="hljs-built_in">OH_CryptoMac_GetLength</span>(ctx, &amp;macLen);</li><li>    <span class="hljs-keyword">if</span> (ret != CRYPTO_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>        <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>        <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"CMAC calculation success, length: %u\n"</span>, macLen);</li><li>
</li><li>    <span class="hljs-comment">// 清理资源。</span></li><li>    <span class="hljs-built_in">OH_Crypto_FreeDataBlob</span>(&amp;out);</li><li>    <span class="hljs-built_in">OH_CryptoMac_Destroy</span>(ctx);</li><li>    <span class="hljs-built_in">OH_CryptoSymKey_Destroy</span>(keyCtx);</li><li>    <span class="hljs-keyword">return</span> CRYPTO_SUCCESS;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>