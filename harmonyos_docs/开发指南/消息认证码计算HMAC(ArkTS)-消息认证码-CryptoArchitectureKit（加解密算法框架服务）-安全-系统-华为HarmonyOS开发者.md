<h1 _ngcontent-oxo-c119="" class="doc-title ng-star-inserted" title="消息认证码计算HMAC(ArkTS)"> 消息认证码计算HMAC(ArkTS) </h1>

<div _ngcontent-oxo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>HMAC使用指定的摘要算法，以共享密钥和消息作为输入，生成固定长度的消息认证码，用于检验报文的完整性。HMAC在消息摘要算法基础上增加密钥输入，确保信息正确性。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>在调用update接口传入数据时，可以<a href="/consumer/cn/doc/harmonyos-guides/crypto-compute-hmac#hmac一次性传入">一次性传入所有数据</a>，也可以把数据人工分段，然后<a href="/consumer/cn/doc/harmonyos-guides/crypto-compute-hmac#分段hmac">分段update</a>。对于同一段数据而言，是否分段，计算结果没有差异。对于数据量较大的数据，开发者可以根据实际需求选择是否分段传入。</p>     <p>下面分别提供两种方式的示例代码。</p>    </div>    <div class="tiledSection">     <h3 id="hmac一次性传入" class="firsth2">HMAC（一次性传入）<i class="anchor-icon anchor-icon-link" anchorid="hmac一次性传入" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatemac" target="_blank">cryptoFramework.createMac</a>，指定摘要算法SHA256，生成消息认证码实例（Mac）。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatesymkeygenerator" target="_blank">cryptoFramework.createSymKeyGenerator</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#convertkey-1" target="_blank">SymKeyGenerator.convertKey</a>，生成密钥算法为HMAC的对称密钥（SymKey）。</p>       <p>详细开发指导请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-convert-binary-data-to-sym-key">指定二进制数据生成对称密钥</a>。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#init-6" target="_blank">Mac.init</a>，指定共享对称密钥（SymKey），初始化Mac对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#update-8" target="_blank">Mac.update</a>，传入自定义消息，进行消息认证码计算。单次update长度没有限制。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#dofinal-2" target="_blank">Mac.doFinal</a>，获取Mac计算结果。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#getmaclength" target="_blank">Mac.getMacLength</a>，获取Mac消息认证码的长度，单位为字节。</p></li>     </ol>     <ul>      <li>       <p>以使用await方式一次性传入数据，获取消息认证码计算结果为例：</p>       <div _ngcontent-oxo-c106="" class="highlight-div"><div _ngcontent-oxo-c106="" class="highlight-div-header"><div _ngcontent-oxo-c106="" class="highlight-div-header-left"><div _ngcontent-oxo-c106="" class="handle-button expand-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oxo-c106="" class="highlight-div-header-right"><div _ngcontent-oxo-c106="" class="handle-button ai-button"></div><div _ngcontent-oxo-c106="" class="handle-button line-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oxo-c106="" class="handle-button theme-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oxo-c106="" class="handle-button copy-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oxo-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'HMAC'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-keyword">await</span> aesGenerator.<span class="hljs-title function_">convertKey</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doHmac</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 把字符串按utf-8解码为Uint8Array，使用固定的128位的密钥，即16字节。</span></li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(<span class="hljs-string">"12345678abcdefgh"</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">await</span> <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> macAlgName = <span class="hljs-string">'SHA256'</span>; <span class="hljs-comment">// 摘要算法名。</span></li><li>  <span class="hljs-keyword">let</span> message = <span class="hljs-string">'hmacTestMessage'</span>; <span class="hljs-comment">// 待进行HMAC的数据。</span></li><li>  <span class="hljs-keyword">let</span> mac = cryptoFramework.<span class="hljs-title function_">createMac</span>(macAlgName);</li><li>  <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">init</span>(key);</li><li>  <span class="hljs-comment">// 数据量较少时，可以一次性执行update操作，将所有数据传入。该接口不对入参长度进行限制。</span></li><li>  <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(message, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>) });</li><li>  <span class="hljs-keyword">let</span> macResult = <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">doFinal</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC result:'</span> + macResult.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">let</span> macLen = mac.<span class="hljs-title function_">getMacLength</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC len:'</span> + macLen);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>以使用同步方式一次性传入数据，获取消息认证码计算结果为例：</p>       <div _ngcontent-oxo-c106="" class="highlight-div"><div _ngcontent-oxo-c106="" class="highlight-div-header"><div _ngcontent-oxo-c106="" class="highlight-div-header-left"><div _ngcontent-oxo-c106="" class="handle-button expand-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oxo-c106="" class="highlight-div-header-right"><div _ngcontent-oxo-c106="" class="handle-button ai-button"></div><div _ngcontent-oxo-c106="" class="handle-button line-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oxo-c106="" class="handle-button theme-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oxo-c106="" class="handle-button copy-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oxo-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'HMAC'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey =  aesGenerator.<span class="hljs-title function_">convertKeySync</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Sync]convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">doHmacBySync</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 把字符串按utf-8解码为Uint8Array，使用固定的128位的密钥，即16字节。</span></li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(<span class="hljs-string">"12345678abcdefgh"</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> key = <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> macAlgName = <span class="hljs-string">'SHA256'</span>; <span class="hljs-comment">// 摘要算法名。</span></li><li>  <span class="hljs-keyword">let</span> message = <span class="hljs-string">'hmacTestMessage'</span>; <span class="hljs-comment">// 待进行HMAC的数据。</span></li><li>  <span class="hljs-keyword">let</span> mac = cryptoFramework.<span class="hljs-title function_">createMac</span>(macAlgName);</li><li>  mac.<span class="hljs-title function_">initSync</span>(key);</li><li>  <span class="hljs-comment">// 数据量较少时，可以一次性执行update操作，将所有数据传入。接口不对入参长度进行限制。</span></li><li>  mac.<span class="hljs-title function_">updateSync</span>({ <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(message, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>) });</li><li>  <span class="hljs-keyword">let</span> macResult = mac.<span class="hljs-title function_">doFinalSync</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Sync]HMAC result:'</span> + macResult.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">let</span> macLen = mac.<span class="hljs-title function_">getMacLength</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC len:'</span> + macLen);</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="分段hmac">分段HMAC<i class="anchor-icon anchor-icon-link" anchorid="分段hmac" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatemac" target="_blank">cryptoFramework.createMac</a>，指定摘要算法SHA256，生成消息认证码实例（Mac）。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatesymkeygenerator" target="_blank">cryptoFramework.createSymKeyGenerator</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#convertkey-1" target="_blank">SymKeyGenerator.convertKey</a>，生成密钥算法为HMAC的对称密钥（SymKey）。</p>       <p>生成对称密钥的开发指导，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-convert-binary-data-to-sym-key">指定二进制数据生成对称密钥</a>。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#init-7" target="_blank">Mac.init</a>，指定共享对称密钥（SymKey），初始化Mac对象。</p></li>      <li>       <p>传入自定义消息，将一次传入数据量设置为20字节，多次调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#update-9" target="_blank">Mac.update</a>，进行消息认证码计算。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#dofinal-3" target="_blank">Mac.doFinal</a>，获取Mac计算结果。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#getmaclength" target="_blank">Mac.getMacLength</a>，获取Mac消息认证码的长度，单位为字节。</p></li>     </ol>     <ul>      <li>       <p>使用await方式分段传入数据，获取消息认证码计算结果。</p>       <div _ngcontent-oxo-c106="" class="highlight-div"><div _ngcontent-oxo-c106="" class="highlight-div-header"><div _ngcontent-oxo-c106="" class="highlight-div-header-left"><div _ngcontent-oxo-c106="" class="handle-button expand-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oxo-c106="" class="highlight-div-header-right"><div _ngcontent-oxo-c106="" class="handle-button ai-button"></div><div _ngcontent-oxo-c106="" class="handle-button line-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oxo-c106="" class="handle-button theme-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oxo-c106="" class="handle-button copy-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oxo-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'HMAC'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-keyword">await</span> aesGenerator.<span class="hljs-title function_">convertKey</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doLoopHmac</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 把字符串按utf-8解码为Uint8Array，使用固定的128位的密钥，即16字节。</span></li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(<span class="hljs-string">"12345678abcdefgh"</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">await</span> <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> macAlgName = <span class="hljs-string">"SHA256"</span>; <span class="hljs-comment">// 摘要算法名。</span></li><li>  <span class="hljs-keyword">let</span> mac = cryptoFramework.<span class="hljs-title function_">createMac</span>(macAlgName);</li><li>  <span class="hljs-comment">// 消息共43字节，utf-8解码后仍为43字节。</span></li><li>  <span class="hljs-keyword">let</span> messageText = <span class="hljs-string">"aaaaa......bbbbb......ccccc......ddddd......eee"</span>;</li><li>  <span class="hljs-keyword">let</span> messageData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(messageText, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 以20字节为单位进行分段更新。</span></li><li>  <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">init</span>(key);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; messageData.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = messageData.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">update</span>(updateMessageBlob);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> macOutput = <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">doFinal</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"HMAC result: "</span> + macOutput.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">let</span> macLen = mac.<span class="hljs-title function_">getMacLength</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC len:'</span> + macLen);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使用同步方式分段传入数据，获取消息认证码计算结果。</p>       <div _ngcontent-oxo-c106="" class="highlight-div"><div _ngcontent-oxo-c106="" class="highlight-div-header"><div _ngcontent-oxo-c106="" class="highlight-div-header-left"><div _ngcontent-oxo-c106="" class="handle-button expand-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oxo-c106="" class="highlight-div-header-right"><div _ngcontent-oxo-c106="" class="handle-button ai-button"></div><div _ngcontent-oxo-c106="" class="handle-button line-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oxo-c106="" class="handle-button theme-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oxo-c106="" class="handle-button copy-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oxo-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'HMAC'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = aesGenerator.<span class="hljs-title function_">convertKeySync</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[Sync]convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">doLoopHmacBySync</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 字符串按utf-8解码为Uint8Array，使用固定的128位的密钥，即16字节。</span></li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(<span class="hljs-string">"12345678abcdefgh"</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> key = <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> macAlgName = <span class="hljs-string">"SHA256"</span>; <span class="hljs-comment">// 摘要算法名。</span></li><li>  <span class="hljs-keyword">let</span> mac = cryptoFramework.<span class="hljs-title function_">createMac</span>(macAlgName);</li><li>  <span class="hljs-comment">// 消息总计43字节，按utf-8解码。</span></li><li>  <span class="hljs-keyword">let</span> messageText = <span class="hljs-string">"aaaaa.....bbbbb.....ccccc.....ddddd.....eee"</span>;</li><li>  <span class="hljs-keyword">let</span> messageData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(messageText, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> updateLength = <span class="hljs-number">20</span>; <span class="hljs-comment">// 假设以20字节为单位进行分段update，实际并无要求。</span></li><li>  mac.<span class="hljs-title function_">initSync</span>(key);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; messageData.<span class="hljs-property">length</span>; i += updateLength) {</li><li>    <span class="hljs-keyword">let</span> updateMessage = messageData.<span class="hljs-title function_">subarray</span>(i, i + updateLength);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateMessageBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: updateMessage };</li><li>    mac.<span class="hljs-title function_">updateSync</span>(updateMessageBlob);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> macOutput = mac.<span class="hljs-title function_">doFinalSync</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"[Sync]HMAC result: "</span> + macOutput.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">let</span> macLen = mac.<span class="hljs-title function_">getMacLength</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC len:'</span> + macLen);</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="hmachmacspec作为参数传入">HMAC(HmacSpec作为参数传入)<i class="anchor-icon anchor-icon-link" anchorid="hmachmacspec作为参数传入" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatemac" target="_blank">cryptoFramework.createMac</a>，指定消息认证码算法HMAC，指定摘要算法SHA256，生成消息认证码实例（Mac）。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#cryptoframeworkcreatesymkeygenerator" target="_blank">cryptoFramework.createSymKeyGenerator</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#convertkey-1" target="_blank">SymKeyGenerator.convertKey</a>，生成密钥算法为HMAC的对称密钥（SymKey）。</p>       <p>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-convert-binary-data-to-sym-key">指定二进制数据生成对称密钥</a>。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#init-6" target="_blank">Mac.init</a>，指定共享对称密钥（SymKey），初始化Mac对象。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#update-8" target="_blank">Mac.update</a>，传入自定义消息，进行消息认证码计算。单次update长度没有限制。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#dofinal-2" target="_blank">Mac.doFinal</a>，获取Mac计算结果。</p></li>      <li>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#getmaclength" target="_blank">Mac.getMacLength</a>，获取Mac消息认证码的长度，单位为字节。</p></li>     </ol>     <ul>      <li>       <p>以使用await方式一次性传入数据，获取消息认证码计算结果为例：</p>       <div _ngcontent-oxo-c106="" class="highlight-div"><div _ngcontent-oxo-c106="" class="highlight-div-header"><div _ngcontent-oxo-c106="" class="highlight-div-header-left"><div _ngcontent-oxo-c106="" class="handle-button expand-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-oxo-c106="" class="highlight-div-header-right"><div _ngcontent-oxo-c106="" class="handle-button ai-button"></div><div _ngcontent-oxo-c106="" class="handle-button line-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-oxo-c106="" class="handle-button theme-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-oxo-c106="" class="handle-button copy-button"><div _ngcontent-oxo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-oxo-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span>;</li><li><span class="hljs-keyword">import</span> { buffer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">genSymKeyByData</span>(<span class="hljs-params">symKeyData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">symKeyBlob</span>: cryptoFramework.<span class="hljs-property">DataBlob</span> = { <span class="hljs-attr">data</span>: symKeyData };</li><li>  <span class="hljs-keyword">let</span> aesGenerator = cryptoFramework.<span class="hljs-title function_">createSymKeyGenerator</span>(<span class="hljs-string">'HMAC'</span>);</li><li>  <span class="hljs-keyword">let</span> symKey = <span class="hljs-keyword">await</span> aesGenerator.<span class="hljs-title function_">convertKey</span>(symKeyBlob);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'convertKey success'</span>);</li><li>  <span class="hljs-keyword">return</span> symKey;</li><li>}</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doHmac</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 把字符串按utf-8解码为Uint8Array，使用固定的128位的密钥，即16字节。</span></li><li>  <span class="hljs-keyword">let</span> keyData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(<span class="hljs-string">"12345678abcdefgh"</span>, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>);</li><li>  <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">await</span> <span class="hljs-title function_">genSymKeyByData</span>(keyData);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">spec</span>: cryptoFramework.<span class="hljs-property">HmacSpec</span> = {</li><li>      <span class="hljs-attr">algName</span>: <span class="hljs-string">"HMAC"</span>,</li><li>      <span class="hljs-attr">mdName</span>: <span class="hljs-string">"SHA256"</span>,</li><li>  };</li><li>  <span class="hljs-keyword">let</span> message = <span class="hljs-string">'hmacTestMessage'</span>; <span class="hljs-comment">// 待进行HMAC的数据。</span></li><li>  <span class="hljs-keyword">let</span> mac = cryptoFramework.<span class="hljs-title function_">createMac</span>(spec);</li><li>  <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">init</span>(key);</li><li>  <span class="hljs-comment">// 数据量较少时，可以只做一次update，将所有数据传入，接口不对参数长度设限。</span></li><li>  <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer.<span class="hljs-title function_">from</span>(message, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>) });</li><li>  <span class="hljs-keyword">let</span> macResult = <span class="hljs-keyword">await</span> mac.<span class="hljs-title function_">doFinal</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC result:'</span> + macResult.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">let</span> macLen = mac.<span class="hljs-title function_">getMacLength</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HMAC len:'</span> + macLen);</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>