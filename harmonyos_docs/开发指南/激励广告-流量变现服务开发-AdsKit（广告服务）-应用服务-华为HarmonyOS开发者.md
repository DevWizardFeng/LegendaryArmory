<h1 _ngcontent-hcn-c119="" class="doc-title ng-star-inserted" title="激励广告"> 激励广告 </h1>

<div _ngcontent-hcn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section498473910110">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section498473910110" tips="复制节点链接"></i></h2><p>激励广告是一种全屏幕的视频广告，用户可以选择点击观看，以换取相应奖励。</p> <p>  <span><img height="659.6800000000001" originheight="2040" originwidth="987" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.95567158097590402374939392866444:50001231000000:2800:158C3EC970A33E1008A642241F96B4F3BF35D9FDB9BAA03AD35BD62695849B51.png" title="点击放大" width="319.20000000000005"></span></p> </div> <div class="tiledSection"><h2 id="section65401229123616">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section65401229123616" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#loadad" target="_blank">loadAd</a>(adParam: AdRequestParams, adOptions: AdOptions, listener: AdLoadListener): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>请求单广告位广告，通过AdRequestParams、AdOptions进行广告请求参数设置，通过AdLoadListener监听广告请求回调。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#showad" target="_blank">showAd</a>(ad: Advertisement, options: AdDisplayOptions, context?: common.UIAbilityContext): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>展示广告，通过AdDisplayOptions进行广告展示参数设置。</p> <p><strong>说明：</strong>为了保证广告能正确展示，该接口必须和请求广告接口配套使用。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section109329483117">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section109329483117" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1392312617269" class="firsth2">请求广告<i class="anchor-icon anchor-icon-link" anchorid="section1392312617269" tips="复制节点链接"></i></h3></div> <ol><li><span>导入相关模块。</span><p></p><div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, common, <span class="hljs-title class_">PermissionRequestResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { advertising, identifier } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AdsKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>获取OAID。</span><p></p><p>若需提升广告推送精准度，可以在请求参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#adrequestparams" target="_blank">AdRequestParams</a>中添加oaid属性。</p> <p>如何获取OAID参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/oaid-service" target="_blank">获取OAID信息</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用以下示例中提供的测试广告位时，必须先获取OAID信息。</p> </div></div></div> <p></p></li><li><span>请求单广告位广告。</span><p></p><p>需要先创建一个AdLoader对象，通过AdLoader的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#loadad" target="_blank">loadAd</a>方法请求广告，最后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#adloadlistener" target="_blank">AdLoadListener</a>，来监听广告的加载状态。</p> <div class="p">请求广告关键参数如下所示： <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.3.2.2.1.1.5.1.1" valign="top" width="14.21%"><p>请求广告参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.2.2.1.1.5.1.2" valign="top" width="13.900000000000002%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.2.2.1.1.5.1.3" valign="top" width="9.9%"><p>必填</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.2.2.1.1.5.1.4" valign="top" width="61.99%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="14.21%"><p>adType</p> </td> <td class="cellrowborder" valign="top" width="13.900000000000002%"><p>number</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>请求广告类型，激励广告类型为7。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.21%"><p>adId</p> </td> <td class="cellrowborder" valign="top" width="13.900000000000002%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>广告位ID。</p> <ul><li>如果仅调测广告，可使用测试广告位ID：testx9dtjwj8hp。</li><li>如果要接入正式广告，则需要申请正式的广告位ID。可在应用发布前进入<a href="https://developer.huawei.com/consumer/cn/monetize" target="_blank">流量变现官网</a>，点击“开始变现”，登录<a href="https://developer.huawei.com/consumer/cn/service/ads/publisher/html/index.html?lang=zh" target="_blank">鲸鸿动能媒体服务平台</a>进行申请，具体操作详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/monetize/zhanshiweichuangjian-0000001132700049" target="_blank">展示位创建</a>。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.21%"><p>oaid</p> </td> <td class="cellrowborder" valign="top" width="13.900000000000002%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="9.9%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="61.99%"><p>开放匿名设备标识符，用于精准推送广告。不填无法获取到个性化广告。</p> </td> </tr>  </tbody></table></div> </div> </div> <p>示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'LoadAd'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadAd</span>();</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadAd</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// 广告请求回调监听</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoadListener</span>: advertising.<span class="hljs-property">AdLoadListener</span> = {</li><li>      <span class="hljs-comment">// 广告请求失败回调</span></li><li>      <span class="hljs-attr">onAdLoadFailure</span>: <span class="hljs-function">(<span class="hljs-params">errorCode: <span class="hljs-built_in">number</span>, errorMsg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${errorCode}</span>, message is <span class="hljs-subst">${errorMsg}</span>`</span>);</li><li>      },</li><li>      <span class="hljs-comment">// 广告请求成功回调</span></li><li>      <span class="hljs-attr">onAdLoadSuccess</span>: <span class="hljs-function">(<span class="hljs-params">ads: <span class="hljs-built_in">Array</span>&lt;advertising.Advertisement&gt;</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading ad'</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// 广告请求参数</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adRequestParams</span>: advertising.<span class="hljs-property">AdRequestParams</span> = {</li><li>      <span class="hljs-comment">// 'testx9dtjwj8hp'为测试专用的广告位ID，App正式发布时需要改为正式的广告位ID</span></li><li>      <span class="hljs-attr">adId</span>: <span class="hljs-string">'testx9dtjwj8hp'</span>,</li><li>      <span class="hljs-comment">// 激励广告类型</span></li><li>      <span class="hljs-attr">adType</span>: <span class="hljs-number">7</span>,</li><li>      <span class="hljs-comment">// 开放匿名设备标识符</span></li><li>      <span class="hljs-attr">oaid</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestOAID</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>)</li><li>    };</li><li>    <span class="hljs-comment">// 广告配置参数，开发者可根据项目实际情况设置</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adOptions</span>: advertising.<span class="hljs-property">AdOptions</span> = {};</li><li>    <span class="hljs-comment">// 创建AdLoader广告对象</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoader</span>: advertising.<span class="hljs-property">AdLoader</span> = <span class="hljs-keyword">new</span> advertising.<span class="hljs-title class_">AdLoader</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 调用广告请求接口</span></li><li>      adLoader.<span class="hljs-title function_">loadAd</span>(adRequestParams, adOptions, adLoadListener);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestOAID</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-comment">// 向用户请求授权广告跨应用关联访问权限</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isPermissionGranted</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionRequestResult</span> =</li><li>      <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.APP_TRACKING_CONSENT'</span>]);</li><li>    isPermissionGranted = result.<span class="hljs-property">authResults</span>[<span class="hljs-number">0</span>] === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to request permission. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (isPermissionGranted) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in requesting permission'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> oaid = <span class="hljs-keyword">await</span> identifier.<span class="hljs-title function_">getOAID</span>();</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in getting OAID'</span>);</li><li>      <span class="hljs-keyword">return</span> oaid;</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to get OAID. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to request permission. User rejected'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre></div></div> <p></p></li></ol> <div class="tiledSection"><h3 id="section395845163219">事件订阅<i class="anchor-icon anchor-icon-link" anchorid="section395845163219" tips="复制节点链接"></i></h3><ol><li><span>导入相关模块。</span><p></p><div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, commonEventManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div> <p></p></li><li><span>事件订阅。</span><p></p><p>开发者需要在应用中订阅com.huawei.hms.pps.action.PPS_REWARD_STATUS_CHANGED事件来监听激励广告页面变化并接收奖励信息。</p> <p>在订阅到公共事件后，可以从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-commonevent-commoneventdata" target="_blank">CommonEventData</a>的parameters参数中获取激励广告页面变化状态和奖励信息。</p> <ul><li>使用reward_ad_status作为key值获取激励广告页面变化状态，涉及的页面变化状态如下所示： <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.2.2.2.3.1.1.1.3.1.1" valign="top" width="44.26%"><p>页面变化状态</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.2.2.2.3.1.1.1.3.1.2" valign="top" width="55.74%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdOpen</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>打开广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdClick</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>点击广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdClose</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>关闭广告。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onAdReward</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>广告获得奖励。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onVideoPlayBegin</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>广告视频开始播放。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="44.26%"><p>onVideoPlayEnd</p> </td> <td class="cellrowborder" valign="top" width="55.74%"><p>广告视频播放结束。</p> </td> </tr>  </tbody></table></div> </div> </li><li>使用reward_ad_data作为key值获取奖励信息，其中：<ul><li>属性rewardType用来获取奖励物品的名称。</li><li>属性rewardAmount用来获取奖励物品的数量。</li></ul> </li></ul> <p>示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEY_REWARD_DATA</span> = <span class="hljs-string">'reward_ad_data'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEY_REWARD_STATUS</span> = <span class="hljs-string">'reward_ad_status'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RewardAdStatusHandler</span> {</li><li>  <span class="hljs-comment">// 用于保存创建成功的订阅者对象，后续使用其完成订阅及退订的动作</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">subscriber</span>: commonEventManager.<span class="hljs-property">CommonEventSubscriber</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-comment">// 订阅方法，需要在每次展示广告前调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerPPSReceiver</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unRegisterPPSReceiver</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 订阅者信息</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">subscribeInfo</span>: commonEventManager.<span class="hljs-property">CommonEventSubscribeInfo</span> = {</li><li>      <span class="hljs-attr">events</span>: [<span class="hljs-string">'com.huawei.hms.pps.action.PPS_REWARD_STATUS_CHANGED'</span>],</li><li>      <span class="hljs-comment">// publisherBundleName被设置为"com.huawei.hms.adsservice",这意味着只有来自该包名的事件才会被订阅者接受和处理。</span></li><li>      <span class="hljs-comment">// 如果没有明确声明publisherBundleName，那么订阅者可能会收到来自其它包名的伪造事件，从而导致安全性问题或误导。</span></li><li>      <span class="hljs-attr">publisherBundleName</span>: <span class="hljs-string">'com.huawei.hms.adsservice'</span></li><li>    };</li><li>    <span class="hljs-comment">// 创建订阅者回调</span></li><li>    commonEventManager.<span class="hljs-title function_">createSubscriber</span>(subscribeInfo, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, commonEventSubscriber:</span></span></li><li><span class="hljs-function">      commonEventManager.CommonEventSubscriber</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to create subscriber. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in creating subscriber'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span> = commonEventSubscriber;</li><li>      <span class="hljs-comment">// 订阅公共事件回调</span></li><li>      commonEventManager.<span class="hljs-title function_">subscribe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, commonEventSubscriber:</span></span></li><li><span class="hljs-function">        commonEventManager.CommonEventData</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to subscribe. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in subscribing data'</span>);</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">status</span>: <span class="hljs-built_in">string</span> = commonEventSubscriber?.<span class="hljs-property">parameters</span>?.[<span class="hljs-variable constant_">KEY_REWARD_STATUS</span>];</li><li>          <span class="hljs-keyword">switch</span> (status) {</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdOpen'</span>:</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdOpen'</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdClick'</span>:</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdClick'</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdClose'</span>:</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onAdClose'</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unRegisterPPSReceiver</span>();</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onAdReward'</span>:</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">rewardData</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt; = commonEventSubscriber?.<span class="hljs-property">parameters</span>?.[<span class="hljs-variable constant_">KEY_REWARD_DATA</span>];</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">rewardType</span>: <span class="hljs-built_in">string</span> = rewardData?.<span class="hljs-property">rewardType</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">rewardAmount</span>: <span class="hljs-built_in">number</span> = rewardData?.<span class="hljs-property">rewardAmount</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Status is onAdReward. Type is <span class="hljs-subst">${rewardType}</span>, Amount is <span class="hljs-subst">${rewardAmount}</span>`</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onVideoPlayBegin'</span>:</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onVideoPlayBegin'</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-keyword">case</span> <span class="hljs-string">'onVideoPlayEnd'</span>:</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Status is onVideoPlayEnd'</span>);</li><li>              <span class="hljs-keyword">break</span>;</li><li>            <span class="hljs-attr">default</span>:</li><li>              <span class="hljs-keyword">break</span>;</li><li>          }</li><li>        }</li><li>      });</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 取消订阅</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterPPSReceiver</span>(): <span class="hljs-built_in">void</span> {</li><li>    commonEventManager.<span class="hljs-title function_">unsubscribe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to unsubscribe. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in unsubscribing'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscriber</span> = <span class="hljs-literal">null</span>;</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section16597193515555">展示广告<i class="anchor-icon anchor-icon-link" anchorid="section16597193515555" tips="复制节点链接"></i></h3><ol><li><span>导入相关模块。</span><p></p><div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { advertising } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AdsKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// 事件订阅步骤中创建的文件</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RewardAdStatusHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./RewardAdStatusHandler'</span>;</li></ol></pre></div></div> <p></p></li><li><span>展示广告。</span><p></p><p class="continue">开发者需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-advertising#showad" target="_blank">showAd</a>方法来展示广告，ads为<a href="/consumer/cn/doc/harmonyos-guides/ads-publisher-service-reward#section1392312617269">请求广告</a>返回的广告信息，在每次展示广告前需要注册<a href="/consumer/cn/doc/harmonyos-guides/ads-publisher-service-reward#section395845163219">事件订阅</a>中定义的监听器。</p> <p class="continue">示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadAd</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// 广告请求回调监听</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">adLoadListener</span>: advertising.<span class="hljs-property">AdLoadListener</span> = {</li><li>      <span class="hljs-comment">// 广告请求失败回调</span></li><li>      <span class="hljs-attr">onAdLoadFailure</span>: <span class="hljs-function">(<span class="hljs-params">errorCode: <span class="hljs-built_in">number</span>, errorMsg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to load ad. Code is <span class="hljs-subst">${errorCode}</span>, message is <span class="hljs-subst">${errorMsg}</span>`</span>);</li><li>      },</li><li>      <span class="hljs-comment">// 广告请求成功回调</span></li><li>      <span class="hljs-attr">onAdLoadSuccess</span>: <span class="hljs-function">(<span class="hljs-params">ads: <span class="hljs-built_in">Array</span>&lt;advertising.Advertisement&gt;</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading ad'</span>);</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-comment">// 注册激励广告状态监听器</span></li><li>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RewardAdStatusHandler</span>().<span class="hljs-title function_">registerPPSReceiver</span>();</li><li>          <span class="hljs-comment">// 广告展示参数，开发者可根据项目实际情况设置</span></li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">adDisplayOptions</span>: advertising.<span class="hljs-property">AdDisplayOptions</span> = {</li><li>            <span class="hljs-comment">// 是否静音</span></li><li>            <span class="hljs-attr">mute</span>: <span class="hljs-literal">true</span>,</li><li>            <span class="hljs-comment">// ...</span></li><li>          };</li><li>          <span class="hljs-comment">// 此处ads[0]表示请求到的第一个广告，开发者可根据项目实际情况选择</span></li><li>          advertising.<span class="hljs-title function_">showAd</span>(ads[<span class="hljs-number">0</span>], adDisplayOptions, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to show ad. Code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>        }</li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section105579111522">校验激励广告服务端验证回调<i class="anchor-icon anchor-icon-link" anchorid="section105579111522" tips="复制节点链接"></i></h2><p>服务端验证回调是指鲸鸿动能平台发送给媒体服务器的网址请求，其中带有特定的查询参数，用来通知媒体服务器某位用户因为与激励视频广告互动而应予以奖励，从而规避欺骗的行为。</p> <p><span><img height="666.1767555594682" originheight="769" originwidth="1062" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.47289274094286385626220235582267:50001231000000:2800:158BCA65CD33F153C7ED63C29F38056695EEB2E42495CB4E0835350F16427660.png" title="点击放大" width="920"></span></p> <p></p> </div> <div class="tiledSection"><h3 id="section6208115245219" class="firsth2">奖励用户<i class="anchor-icon anchor-icon-link" anchorid="section6208115245219" tips="复制节点链接"></i></h3><ul><li>在给用户发奖励时，要把握好用户体验和奖励验证之间的平衡。由于服务器端回调会存在延迟的情况，因此我们建议客户端立即奖励用户，同时在收到服务器端回调时对所有奖励进行验证。这种做法可确保奖励符合发放条件，同时提供良好的用户体验。</li><li>对于某些应用而言，奖励是否达到发放条件非常重要，用户可适当接受延迟。这时，推荐做法是等待服务器端回调完成验证，再向用户发放奖励。</li></ul> </div> <div class="tiledSection"><h3 id="section77672242539">校验服务端验证回调<i class="anchor-icon anchor-icon-link" anchorid="section77672242539" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>App上架至华为应用市场（AppGallery）时间超过12小时才可以收到回调。</p> </div></div></div> <ol><li>设置激励广告的奖励配置。<p>您在<a href="https://developer.huawei.com/consumer/cn/service/ads/publisher/html/index.html?lang=zh" target="_blank">鲸鸿动能媒体服务平台</a>上申请激励视频广告位时选择“媒体管理（点击媒体名）&gt; 新增展示位 &gt; 选择激励视频（点击下一步，进入编辑页面）”，设置奖励类型和奖励数量，并点击“高级设置”，设置服务器端验证的URL。如下图：</p> <p><span><img originheight="359" originwidth="1006" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.26476264223414800813506731231299:50001231000000:2800:18B881AA24B39A3A2490748E5BD410E86128FBB1957104197B5CFC476A1AD043.png" width="920" height="328.31013916500996"></span></p> </li><li>（可选）设置自定义数据customData和userId。<p>您在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ads-publisher-service-reward#section16597193515555" target="_blank">展示广告第2点</a>之前可以设置自定义数据customData和userId。示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { advertising } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AdsKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 广告展示参数，开发者可根据项目实际情况设置</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">adDisplayOptions</span>: advertising.<span class="hljs-property">AdDisplayOptions</span> = {</li><li>  <span class="hljs-comment">// 是否静音</span></li><li>  <span class="hljs-attr">mute</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-comment">// 设置自定义数据</span></li><li>  <span class="hljs-attr">customData</span>: <span class="hljs-string">'CUSTOM_DATA'</span>,</li><li>  <span class="hljs-comment">// 设置自定义用户id</span></li><li>  <span class="hljs-attr">userId</span>: <span class="hljs-string">'1234567'</span></li><li>};</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果没有设置customData和userId，不影响发放奖励事件上报但是服务端验证的参数中没有这两个字段。如果设置customData和userId，必须在展示广告之前设置并且URLEncode之后，长度不超过1024个字符，否则影响服务端验证。</p> </div></div></div> </li><li>获取要验证的内容。<p>用户观看完激励广告时，鲸鸿动能平台服务端会把需要验证的参数以及keyId和sign传给媒体提供的URL：https://www.example.com/feedback（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ads-publisher-service-reward#section77672242539" target="_blank">即第1点中配置的验证URL</a>）。请求体样例：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>{</li><li>    <span class="hljs-string">"adId"</span> : <span class="hljs-string">"testx9dtjwj8hp"</span>,</li><li>    <span class="hljs-string">"data"</span> : <span class="hljs-string">"CUSTOM_DATA"</span>,</li><li>    <span class="hljs-string">"keyId"</span> : <span class="hljs-string">"12345678"</span>,</li><li>    <span class="hljs-string">"rewardAmount"</span> : <span class="hljs-string">"10"</span>,</li><li>    <span class="hljs-string">"rewardName"</span> : <span class="hljs-string">"金币"</span>,</li><li>    <span class="hljs-string">"sign"</span> : <span class="hljs-string">"OA33u6mypnhE4hbmF32N/ibYi1uXt72nDDyYMwjDI6JXVVFKePZYo4F7Fuk2MaG......"</span>,</li><li>    <span class="hljs-string">"uniqueId"</span> : <span class="hljs-string">"3361626337333932313435313430373438383561376265636130393939313166"</span>,</li><li>    <span class="hljs-string">"userId"</span> : <span class="hljs-string">"1234567"</span></li><li>}</li></ol></pre></div></div> <p>服务器端验证回调查询参数说明：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.3.3.4.1.5.1.1" valign="top" width="25%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.3.4.1.5.1.2" valign="top" width="25%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.3.4.1.5.1.3" valign="top" width="25%"><p>是否必选</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.3.4.1.5.1.4" valign="top" width="25%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>adId</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>激励视频广告位ID</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>data</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>自定义数据字符串</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>keyId</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>验证回调的密钥</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>rewardAmount</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>奖励数量</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>rewardName</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>奖励奖品</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>sign</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>回调的签名</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>uniqueId</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>获奖事件生成的十六进制的标识符</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>userId</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>用户ID</p> </td> </tr>  </tbody></table></div> </div> </li><li>组装验证参数<p>验证内容（除sign、keyId）格式顺序如下：</p> <p>adId={adId}&amp;data={data}&amp;rewardAmount={rewardAmount}&amp;rewardName={rewardName}&amp;uniqueId={uniqueId}&amp;userId={userId}</p> <p>其中‘{}’里面表示参数的值，且参数顺序不能变。如果参数为null或者空字符串，则URL中不拼接该参数。然后用SHA256计算散列值，得到paramContentData。示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">String</span> adId = request.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"adId"</span>);</li><li><span class="hljs-title class_">String</span> data = request.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"data"</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title class_">String</span> userId = request.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"userId"</span>);</li><li><span class="hljs-title class_">String</span> param = <span class="hljs-string">"adId="</span> + adId + <span class="hljs-string">"&amp;data="</span> + data + <span class="hljs-string">"&amp;rewardAmount="</span> + rewardAmount + <span class="hljs-string">"&amp;rewardName="</span> + rewardName + <span class="hljs-string">"&amp;uniqueId="</span> + uniqueId + <span class="hljs-string">"&amp;userId="</span> + userId;</li><li><span class="hljs-title class_">String</span> sha256Value = <span class="hljs-title class_">Sha256Util</span>.<span class="hljs-title function_">digest</span>(param);</li><li>byte[] paramContentData = sha256Value.<span class="hljs-title function_">getBytes</span>(<span class="hljs-title class_">Charset</span>.<span class="hljs-title function_">forName</span>(<span class="hljs-string">"UTF-8"</span>));</li></ol></pre></div></div> </li><li>获取公钥列表。<p>a. 在<a href="https://developer.huawei.com/consumer/cn/service/ads/publisher/html/index.html?lang=zh" target="_blank">鲸鸿动能媒体服务平台</a>上查看对应的账户信息时选择“账户”。</p> <p><span><img originheight="561" originwidth="1227" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.43557349515027873475191731454394:50001231000000:2800:74862CDCEE58410E5495BC74B276A6D452E8B79AF0706291B6FE42FCE93580FC.png" width="920" height="420.6356968215159"></span></p> <p>通过点击上图所示的“获取密钥”按钮弹出如下所示的弹框，获取“开发者ID”和“密钥”。</p> <p><span><img originheight="59" originwidth="421" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.96360344058975988984849736204979:50001231000000:2800:D66C1E0720065CAE85F6B46FD6DA54D2D696B96CE7EC7730783E4EC9AF6ADC40.png" width="421" height="59"></span></p> <p>b. 您根据应用分发区域不同，需要使用对应站点的接口URL去获取公钥列表，不同站点对应的接口URL如下所示：</p> <ul><li>中国境内（不包含中国香港、中国澳门、中国台湾）：https://ppscrowd-drcn.op.hicloud.com/action-lib-track/publickeys</li></ul> <p>将body通过密钥进行HMAC-SHA256加密得到签名，替换到Authorization中，并设置“开发者ID”和Authorization到Header中。示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">String</span> data = <span class="hljs-string">""</span>;</li><li><span class="hljs-title class_">String</span> url = <span class="hljs-string">"https://ppscrowd-dre.op.dbankcloud.com/action-lib-track/publickeys"</span>;</li><li><span class="hljs-title class_">String</span> authorization = <span class="hljs-string">"Digest validTime=\"{0}\", response=\"{1}\""</span>;</li><li><span class="hljs-comment">// 开发者ID</span></li><li><span class="hljs-title class_">String</span> userId = <span class="hljs-string">"YOUR_PUBLISHER_ID"</span>; </li><li><span class="hljs-comment">// 密钥</span></li><li><span class="hljs-title class_">String</span> key = <span class="hljs-string">"YOUR_KEY"</span>; </li><li>
</li><li><span class="hljs-title class_">HttpClient</span> httpclient = <span class="hljs-title class_">HttpClients</span>.<span class="hljs-title function_">createDefault</span>();</li><li><span class="hljs-title class_">HttpGet</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>();</li><li><span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 将body通过密钥进行HMAC-SHA256加密得到签名，替换到Authorization中</span></li><li>    <span class="hljs-title class_">String</span> validTime = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">valueOf</span>(<span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>());</li><li>    <span class="hljs-title class_">String</span> body = validTime + <span class="hljs-string">":/publickeys"</span>;</li><li>    byte[] keyBytes = <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decodeBase64</span>(key);</li><li>    byte[] bodyBytes = body.<span class="hljs-title function_">getBytes</span>(<span class="hljs-title class_">Charsets</span>.<span class="hljs-property">UTF_8</span>);</li><li>
</li><li>    <span class="hljs-title class_">Mac</span> mac = <span class="hljs-title class_">Mac</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-string">"HmacSHA256"</span>);</li><li>    <span class="hljs-title class_">SecretKey</span> secretKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(keyBytes, <span class="hljs-string">"HmacSHA256"</span>);</li><li>    mac.<span class="hljs-title function_">init</span>(secretKey);</li><li>    byte[] signatureBytes = mac.<span class="hljs-title function_">doFinal</span>(bodyBytes);</li><li>
</li><li>    <span class="hljs-title class_">String</span> signature = (signatureBytes == <span class="hljs-literal">null</span>) ? <span class="hljs-literal">null</span> : <span class="hljs-title class_">Hex</span>.<span class="hljs-title function_">encodeHexString</span>(signatureBytes);</li><li>    authorization = <span class="hljs-title class_">MessageFormat</span>.<span class="hljs-title function_">format</span>(authorization, validTime, signature);</li><li>    <span class="hljs-comment">// 设置开发者ID和Authorization到Header中</span></li><li>    request.<span class="hljs-title function_">setURI</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URI</span>(url));</li><li>    request.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"userId"</span>, userId);</li><li>    request.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Authorization"</span>, authorization);</li><li>    <span class="hljs-title class_">HttpResponse</span> response = httpclient.<span class="hljs-title function_">execute</span>(request);</li><li>    data = <span class="hljs-title class_">EntityUtils</span>.<span class="hljs-title function_">toString</span>(response.<span class="hljs-title function_">getEntity</span>());</li><li>} <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {</li><li>    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(e.<span class="hljs-title function_">getMessage</span>());</li><li>}</li></ol></pre></div></div> <p>返回data消息体（publicKey已匿名化）：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>{    </li><li>    <span class="hljs-string">"keys"</span>: [       </li><li>        {          </li><li>            <span class="hljs-string">"keyId"</span>:<span class="hljs-string">"12345678"</span>,          </li><li>            <span class="hljs-string">"publicKey"</span>:<span class="hljs-string">"LS0tLS1*******************************************************"</span>       </li><li>        },      </li><li>        {          </li><li>            <span class="hljs-string">"keyId"</span>: <span class="hljs-string">"22345678"</span>,                               </li><li>            <span class="hljs-string">"publicKey"</span>:<span class="hljs-string">"LS0tLS1*******************************************************"</span>       </li><li>        }     </li><li>    ]</li><li>}</li></ol></pre></div></div> <p>返回消息结构体：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.3.5.12.1.5.1.1" valign="top" width="25%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.12.1.5.1.2" valign="top" width="25%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.12.1.5.1.3" valign="top" width="25%"><p>是否必选</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.12.1.5.1.4" valign="top" width="25%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>keys</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>List&lt;key&gt;</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>返回公钥列表</p> </td> </tr>  </tbody></table></div> </div> <ul><li>key结构体：</li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.3.5.14.1.5.1.1" valign="top" width="25%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.14.1.5.1.2" valign="top" width="25%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.14.1.5.1.3" valign="top" width="25%"><p>是否必选</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.3.5.14.1.5.1.4" valign="top" width="25%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>keyId</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>密钥ID</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>publicKey</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>String</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>公钥</p> </td> </tr>  </tbody></table></div> </div> </li><li>执行验证。<p>a. 根据keyId从公钥列表中找到对应的base64编码后的publicKey。</p> <p>b. 将paramContentData、publicKey、sign和SHA256withRSA数字签名算法的入参，执行验证。</p> <p>示例代码如下所示：</p> <div _ngcontent-hcn-c106="" class="highlight-div"><div _ngcontent-hcn-c106="" class="highlight-div-header"><div _ngcontent-hcn-c106="" class="highlight-div-header-left"><div _ngcontent-hcn-c106="" class="handle-button expand-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hcn-c106="" class="highlight-div-header-right"><div _ngcontent-hcn-c106="" class="handle-button ai-button"></div><div _ngcontent-hcn-c106="" class="handle-button line-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hcn-c106="" class="handle-button theme-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hcn-c106="" class="handle-button copy-button"><div _ngcontent-hcn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hcn-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">byte[] data, <span class="hljs-built_in">String</span> publicKey, <span class="hljs-built_in">String</span> sign, <span class="hljs-built_in">String</span> signatureAlgorithm</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>        byte[] keyBytes = <span class="hljs-title function_">base64Decode</span>(publicKey);</li><li>        X509EncodedKeySpec keySpec = <span class="hljs-keyword">new</span> <span class="hljs-title function_">X509EncodedKeySpec</span>(keyBytes);</li><li>        <span class="hljs-title class_">KeyFactory</span> keyFactory = <span class="hljs-title class_">KeyFactory</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-string">"RSA"</span>);</li><li>        <span class="hljs-title class_">PublicKey</span> publicK = keyFactory.<span class="hljs-title function_">generatePublic</span>(keySpec);</li><li>        <span class="hljs-title class_">Signature</span> signature = <span class="hljs-title class_">Signature</span>.<span class="hljs-title function_">getInstance</span>(signatureAlgorithm);</li><li>        signature.<span class="hljs-title function_">initVerify</span>(publicK);</li><li>        signature.<span class="hljs-title function_">update</span>(data);</li><li>        <span class="hljs-keyword">return</span> signature.<span class="hljs-title function_">verify</span>(<span class="hljs-title function_">base64Decode</span>(sign));</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InvalidKeyException</span> | <span class="hljs-title class_">SignatureException</span> | <span class="hljs-title class_">UnsupportedEncodingException</span> | <span class="hljs-title class_">InvalidKeySpecException</span> | <span class="hljs-title class_">NoSuchAlgorithmException</span> e) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> byte[] <span class="hljs-title function_">base64Decode</span>(<span class="hljs-title class_">String</span> encoded) throws <span class="hljs-title class_">UnsupportedEncodingException</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decodeBase64</span>(encoded.<span class="hljs-title function_">getBytes</span>(<span class="hljs-string">"UTF-8"</span>));</li><li>}</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>