<h1 _ngcontent-cmr-c119="" class="doc-title ng-star-inserted" title="状态管理优秀实践"> 状态管理优秀实践 </h1>

<div _ngcontent-cmr-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本章节旨在帮助开发者提高ArkUI应用质量，重点提高状态管理效率。章节中列举了常见的低效开发场景及解决方案，并通过对比推荐与非推荐用法，帮助开发者正确使用状态变量，实现高性能开发。</p>  <div class="tiledSection"><h2 id="使用objectlink代替prop减少不必要的深拷贝">使用@ObjectLink代替@Prop减少不必要的深拷贝<i class="anchor-icon anchor-icon-link" anchorid="使用objectlink代替prop减少不必要的深拷贝" tips="复制节点链接"></i></h2><p>在应用开发中，父组件常向子组件传值。如果子组件不需要修改该状态变量，子组件使用@Prop装饰器会增加组件创建时间并影响性能，此时建议改用@ObjectLink。</p> <p>【反例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">num: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = num;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PropChild</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">testClass</span>: <span class="hljs-title class_">MyClass</span>; <span class="hljs-comment">// @Prop装饰状态变量会深拷贝。</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`PropChild testNum <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.testClass.num}</span>`</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">testClass</span>: <span class="hljs-title class_">MyClass</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>(<span class="hljs-number">1</span>)];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Parent testNum <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.testClass[<span class="hljs-number">0</span>].num}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">testClass</span>[<span class="hljs-number">0</span>].<span class="hljs-property">num</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-comment">// PropChild没有改变@Prop testClass: MyClass的值，所以这时最优的选择是使用@ObjectLink。</span></li><li>      <span class="hljs-title class_">PropChild</span>({ <span class="hljs-attr">testClass</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">testClass</span>[<span class="hljs-number">0</span>] })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>在以上示例中，PropChild组件没有改变@Prop testClass: MyClass的值，因此使用@ObjectLink更为合适。因为@Prop会深拷贝数据带来性能开销，所以@ObjectLink是比@Link和@Prop更优的选择。</p> <p>【正例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">num: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = num;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PropChild</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">testClass</span>: <span class="hljs-title class_">MyClass</span>; <span class="hljs-comment">// @ObjectLink装饰状态变量不会深拷贝。</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`PropChild testNum <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.testClass.num}</span>`</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">testClass</span>: <span class="hljs-title class_">MyClass</span>[] = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>(<span class="hljs-number">1</span>)];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Parent testNum <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.testClass[<span class="hljs-number">0</span>].num}</span>`</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">testClass</span>[<span class="hljs-number">0</span>].<span class="hljs-property">num</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>
</li><li>      <span class="hljs-comment">// 当子组件不需要本地修改状态时，应优先使用@ObjectLink，因为@Prop会执行深拷贝并带来性能开销，此时@ObjectLink是比@Link和@Prop更优的选择。</span></li><li>      <span class="hljs-title class_">PropChild</span>({ <span class="hljs-attr">testClass</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">testClass</span>[<span class="hljs-number">0</span>] })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="不使用状态变量强行更新非状态变量关联组件">不使用状态变量强行更新非状态变量关联组件<i class="anchor-icon anchor-icon-link" anchorid="不使用状态变量强行更新非状态变量关联组件" tips="复制节点链接"></i></h2><p>【反例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">needsUpdate</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-attr">realStateArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]; <span class="hljs-comment">// 未使用状态变量装饰器。</span></li><li>  <span class="hljs-attr">realState</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>;</li><li>
</li><li>  <span class="hljs-title function_">updateUIArr</span>(<span class="hljs-attr">param</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt;): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>    <span class="hljs-keyword">const</span> triggerAGet = <span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span>;</li><li>    <span class="hljs-keyword">return</span> param;</li><li>  }</li><li>  <span class="hljs-title function_">updateUI</span>(<span class="hljs-attr">param</span>: <span class="hljs-title class_">Color</span>): <span class="hljs-title class_">Color</span> {</li><li>    <span class="hljs-keyword">const</span> triggerAGet = <span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span>;</li><li>    <span class="hljs-keyword">return</span> param;</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateUIArr</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>),</li><li>        <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item}</span>`</span>)</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"add item"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变realStateArr不会触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>);</li><li>
</li><li>          <span class="hljs-comment">// 触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span>;</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"chg color"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变realState不会触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span> == <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>;</li><li>
</li><li>          <span class="hljs-comment">// 触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">needsUpdate</span>;</li><li>        })</li><li>    }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateUI</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span>))</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">500</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <p>上述示例存在以下问题：</p> <ul><li><p>应用程序希望控制UI更新逻辑，然而ArkUI的UI更新是由框架检测状态变量的变化触发的。</p>  </li><li><p>this.needsUpdate是一个自定义的状态变量，仅应用于其绑定的UI组件。变量this.realStateArr和this.realState没有被装饰，它们的变化不会触发UI刷新。</p>  </li><li><p>但是在该应用中，用户试图通过this.needsUpdate的更新来带动常规变量this.realStateArr和this.realState的更新，这种方法不合理且会导致更新性能下降。</p>  </li></ul> <p>【正例】</p> <p>解决此问题，需用@State装饰realStateArr和realState成员变量。解决后就不再需要变量needsUpdate。</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CompA</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">realStateArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>];</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">realState</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>,</li><li>        <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${item}</span>`</span>)</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"add item"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变realStateArr触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">realStateArr</span>.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>);</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"chg color"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变realState触发UI视图更新。</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span> == <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>;</li><li>        })</li><li>    }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realState</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">500</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="精准控制状态变量关联的组件数">精准控制状态变量关联的组件数<i class="anchor-icon anchor-icon-link" anchorid="精准控制状态变量关联的组件数" tips="复制节点链接"></i></h2><p>建议每个状态变量关联的组件数少于20个。精准控制状态变量关联的组件数量可减少不必要的组件刷新，提升刷新效率。有时开发者会将同一状态变量绑定于多个同级组件属性，状态变化时将导致这些组件同步更新，产生不必要的刷新，当组件复杂度较高时会显著影响整体性能。相反，将该状态变量绑定在这些组件的父组件上，可以减少需要刷新的组件数，提高性能。</p> <p>【反例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Translate</span> {</li><li>  <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>}</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Title</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">translateObj</span>: <span class="hljs-title class_">Translate</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">translate</span>({</li><li>          <span class="hljs-attr">x</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> <span class="hljs-comment">// this.translateObj.translateX 绑定在Image和Text组件上。</span></li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Title"</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">translate</span>({</li><li>          <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span></li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateObj</span>: <span class="hljs-title class_">Translate</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Translate</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Title</span>({</li><li>        <span class="hljs-attr">translateObj</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span></li><li>      })</li><li>      <span class="hljs-title class_">Stack</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"black"</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)</li><li>      .<span class="hljs-title function_">translate</span>({</li><li>        <span class="hljs-attr">x</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> <span class="hljs-comment">//this.translateObj.translateX 绑定在Stack和Button组件上。</span></li><li>      })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"move"</span>)</li><li>        .<span class="hljs-title function_">translate</span>({</li><li>          <span class="hljs-attr">x</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span></li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({</li><li>            <span class="hljs-attr">duration</span>: <span class="hljs-number">50</span></li><li>          },<span class="hljs-function">()=&gt;</span>{</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> + <span class="hljs-number">50</span>) % <span class="hljs-number">150</span></li><li>          })</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>在上面的示例中，状态变量this.translateObj.translateX被用在多个同级的子组件下，当this.translateObj.translateX变化时，会导致所有关联它的组件一起刷新，但实际上由于这些组件的变化是相同的，因此可以将这个属性绑定到他们共同的父组件上，来实现减少组件的刷新数量。经过分析，所有子组件均位于Page组件的Column下，因此将所有子组件相同的translate属性统一到Column上，来实现精准控制状态变量关联的组件数。</p> <p>【正例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Translate</span> {</li><li>  <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>}</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Title</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-comment">// 此处'app.media.icon'仅作示例，请开发者自行替换，否则imageSource创建失败会导致后续无法正常执行。</span></li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Title"</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>    }</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Page1</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateObj</span>: <span class="hljs-title class_">Translate</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Translate</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Title</span>()</li><li>      <span class="hljs-title class_">Stack</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"black"</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"move"</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({</li><li>            <span class="hljs-attr">duration</span>: <span class="hljs-number">50</span></li><li>          },<span class="hljs-function">()=&gt;</span>{</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span> + <span class="hljs-number">50</span>) % <span class="hljs-number">150</span></li><li>          })</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">translate</span>({ <span class="hljs-comment">// 子组件Stack和Button设置了同一个translate属性，可以统一到Column上设置。</span></li><li>      <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">translateObj</span>.<span class="hljs-property">translateX</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="合理控制对象类型状态变量关联的组件数量">合理控制对象类型状态变量关联的组件数量<i class="anchor-icon anchor-icon-link" anchorid="合理控制对象类型状态变量关联的组件数量" tips="复制节点链接"></i></h2><p>如果将一个复杂对象定义为状态变量，需要合理控制其关联的组件数。当对象中某个成员属性发生变化时，会导致该对象关联的所有组件刷新，即使这些组件并未直接使用该属性。为了避免这种“冗余刷新”对性能产生影响，建议合理拆分该复杂对象，控制对象关联的组件数量。具体可参考<a href="https://gitcode.com/openharmony/docs/blob/master/zh-cn/application-dev/performance/precisely-control-render-scope.md" target="_blank">精准控制组件的更新范围</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/properly-use-state-management-to-develope">状态管理合理使用开发指导</a>两篇文章。</p> </div>  <div class="tiledSection"><h2 id="查询状态变量关联的组件数">查询状态变量关联的组件数<i class="anchor-icon anchor-icon-link" anchorid="查询状态变量关联的组件数" tips="复制节点链接"></i></h2><p>在应用开发中，可以通过HiDumper查看状态变量关联的组件数，进行性能优化。具体可参考<a href="https://gitcode.com/openharmony/docs/blob/master/zh-cn/application-dev/performance/state_variable_dfx_pratice.md" target="_blank">状态变量组件定位工具实践</a>。</p> </div>  <div class="tiledSection"><h2 id="避免在forwhile等循环逻辑中频繁读取状态变量">避免在for、while等循环逻辑中频繁读取状态变量<i class="anchor-icon anchor-icon-link" anchorid="避免在forwhile等循环逻辑中频繁读取状态变量" tips="复制节点链接"></i></h2><p>在应用开发中，应避免在循环逻辑中频繁读取状态变量，而是应该放在循环外面读取。</p> <p>【反例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击打印日志'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'TAG'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">10</span></li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-number">15</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> <p>【正例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击打印日志'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">logMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>;</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'TAG'</span>, <span class="hljs-string">'%{public}s'</span>, logMessage);</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">10</span></li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-number">15</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h2 id="建议使用临时变量替换状态变量">建议使用临时变量替换状态变量<i class="anchor-icon anchor-icon-link" anchorid="建议使用临时变量替换状态变量" tips="复制节点链接"></i></h2><p>在应用开发中，应尽量减少对状态变量的直接赋值，通过临时变量完成数据计算操作。</p> <p>状态变量发生变化时，ArkUI会查询依赖该状态变量的组件并执行该组件的更新方法，完成组件渲染。通过使用临时变量的计算代替直接操作状态变量，可以使ArkUI仅在最后一次状态变量变更时查询并渲染组件，减少不必要的操作，从而提高应用性能。状态变量行为可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State装饰器：组件内状态</a>。</p> <p>【反例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiTraceMeter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">appendMsg</span>(<span class="hljs-params">newMsg: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// 性能打点</span></li><li>    hiTraceMeter.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'StateVariable'</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += newMsg;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += <span class="hljs-string">';'</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += <span class="hljs-string">'&lt;br/&gt;'</span>;</li><li>    hiTraceMeter.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'StateVariable'</span>, <span class="hljs-number">1</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击打印日志'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMsg</span>(<span class="hljs-string">'操作状态变量'</span>);</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">10</span></li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-number">15</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> <p>直接操作状态变量，三次触发计算函数，运行耗时结果如下：</p> <p><span><img originheight="479" originwidth="1502" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114937.05769977443961854704295173108915:50001231000000:2800:B542D6338BD9B8A7A50F56BF99E1090F4D38130DE27D0057AEC94B26A62C8789.png" width="920" height="293.3954727030626"></span></p> <p>【正例】</p> <div _ngcontent-cmr-c106="" class="highlight-div"><div _ngcontent-cmr-c106="" class="highlight-div-header"><div _ngcontent-cmr-c106="" class="highlight-div-header-left"><div _ngcontent-cmr-c106="" class="handle-button expand-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cmr-c106="" class="highlight-div-header-right"><div _ngcontent-cmr-c106="" class="handle-button ai-button"></div><div _ngcontent-cmr-c106="" class="handle-button line-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cmr-c106="" class="handle-button theme-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cmr-c106="" class="handle-button copy-button"><div _ngcontent-cmr-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cmr-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiTraceMeter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">appendMsg</span>(<span class="hljs-params">newMsg: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// 性能打点。</span></li><li>    hiTraceMeter.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'TemporaryVariable'</span>, <span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>;</li><li>    message += newMsg;</li><li>    message += <span class="hljs-string">';'</span>;</li><li>    message += <span class="hljs-string">'&lt;br/&gt;'</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message;</li><li>    hiTraceMeter.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'TemporaryVariable'</span>, <span class="hljs-number">2</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'点击打印日志'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMsg</span>(<span class="hljs-string">'操作临时变量'</span>);</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-number">10</span></li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-number">15</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> <p>使用临时变量取代状态变量的计算，三次触发计算函数，运行耗时结果如下：</p> <p><span><img originheight="461" originwidth="1505" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114937.79076130658361744624301782917415:50001231000000:2800:40DDA813FD82C9378F7F458568CECDD4280164FEC59F9109C689B91B365093A7.png" width="920" height="281.80730897009965"></span></p> <p>【总结】</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.13.1.4.1.1" valign="top" width="33.33333333333333%"><strong>计算方式</strong></th> <th align="left" class="cellrowborder" id="mcps1.3.8.13.1.4.1.2" valign="top" width="33.33333333333333%"><strong>耗时(局限不同设备和场景，数据仅供参考)</strong></th> <th align="left" class="cellrowborder" id="mcps1.3.8.13.1.4.1.3" valign="top" width="33.33333333333333%"><strong>说明</strong></th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">直接操作状态变量</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">1.01ms</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">增加了ArkUI不必要的查询和渲染行为，导致性能劣化。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">使用临时变量计算</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">0.63ms</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">减少了ArkUI不必要的行为，优化性能。</td> </tr>  </tbody></table></div> </div> </div> </div> <div></div></div>