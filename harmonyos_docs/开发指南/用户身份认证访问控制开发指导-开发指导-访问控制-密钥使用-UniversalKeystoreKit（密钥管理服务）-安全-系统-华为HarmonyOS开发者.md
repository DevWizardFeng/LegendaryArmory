<h1 _ngcontent-cpc-c119="" class="doc-title ng-star-inserted" title="用户身份认证访问控制开发指导"> 用户身份认证访问控制开发指导 </h1>

<div _ngcontent-cpc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>场景介绍及相关概念说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/huks-identity-authentication-overview">用户身份认证访问控制简介</a>。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="生成密钥" class="firsth2">生成密钥<i class="anchor-icon anchor-icon-link" anchorid="生成密钥" tips="复制节点链接"></i></h3>          <p>指定指纹访问控制类型及相关属性。</p>     <p>生成或导入密钥时，在密钥属性集中需指定三个参数：用户认证类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-huks#huksuserauthtype9" target="_blank">HuksUserAuthType</a>、授权访问类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-huks#huksauthaccesstype9" target="_blank">HuksAuthAccessType</a>、挑战值类型<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-huks#hukschallengetype9" target="_blank">HuksChallengeType</a>。</p>     <div _ngcontent-cpc-c106="" class="highlight-div"><div _ngcontent-cpc-c106="" class="highlight-div-header"><div _ngcontent-cpc-c106="" class="highlight-div-header-left"><div _ngcontent-cpc-c106="" class="handle-button expand-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpc-c106="" class="highlight-div-header-right"><div _ngcontent-cpc-c106="" class="handle-button ai-button"></div><div _ngcontent-cpc-c106="" class="handle-button line-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpc-c106="" class="handle-button theme-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpc-c106="" class="handle-button copy-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.BasicServicesKit"</span>;</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 确定密钥别名和封装密钥属性参数集。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'test_sm4_key_alias'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_SM4</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span> | huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_SM4_KEY_SIZE_128</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-comment">// 指定密钥身份认证的类型：指纹。</span></li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_USER_AUTH_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksUserAuthType</span>.<span class="hljs-property">HUKS_USER_AUTH_TYPE_FINGERPRINT</span></li><li>  }, {</li><li>    <span class="hljs-comment">// 指定密钥安全授权的类型（失效类型）：新录入生物特征（指纹）后无效。</span></li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_AUTH_ACCESS_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksAuthAccessType</span>.<span class="hljs-property">HUKS_AUTH_ACCESS_INVALID_NEW_BIO_ENROLL</span></li><li>  }, {</li><li>    <span class="hljs-comment">// 指定挑战值的类型：默认类型。</span></li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_CHALLENGE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksChallengeType</span>.<span class="hljs-property">HUKS_CHALLENGE_TYPE_NORMAL</span></li><li>  }];</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">huksOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: properties,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 生成密钥。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateKeyItem</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: enter generateKeyItem`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: generateKeyItem success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TestGenKeyForFingerprintAccessControl</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateKeyItem</span>(keyAlias, huksOptions);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="传入认证令牌">传入认证令牌<i class="anchor-icon anchor-icon-link" anchorid="传入认证令牌" tips="复制节点链接"></i></h3>          <p>发起指纹认证获取认证令牌，进行数据操作。</p>     <div _ngcontent-cpc-c106="" class="highlight-div"><div _ngcontent-cpc-c106="" class="highlight-div-header"><div _ngcontent-cpc-c106="" class="highlight-div-header-left"><div _ngcontent-cpc-c106="" class="handle-button expand-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpc-c106="" class="highlight-div-header-right"><div _ngcontent-cpc-c106="" class="handle-button ai-button"></div><div _ngcontent-cpc-c106="" class="handle-button line-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpc-c106="" class="handle-button theme-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpc-c106="" class="handle-button copy-button"><div _ngcontent-cpc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 以下以SM4 128密钥为例。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UniversalKeystoreKit'</span>;</li><li><span class="hljs-keyword">import</span> { userAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UserAuthenticationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.BasicServicesKit"</span>;</li><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span></li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 确定密钥别名和封装密钥属性参数集。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable constant_">IV</span> = cryptoFramework.<span class="hljs-title function_">createRandom</span>().<span class="hljs-title function_">generateRandomSync</span>(<span class="hljs-number">16</span>).<span class="hljs-property">data</span>;</li><li><span class="hljs-keyword">let</span> srcKeyAlias = <span class="hljs-string">'test_sm4_key_alias'</span>;</li><li><span class="hljs-keyword">let</span> cipherInData = <span class="hljs-string">'Hks_SM4_Cipher_Test_101010101010101010110_string'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">handle</span>: <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">challenge</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">fingerAuthToken</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">finishOutData</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> authType = userAuth.<span class="hljs-property">UserAuthType</span>.<span class="hljs-property">FINGERPRINT</span>;</li><li><span class="hljs-keyword">let</span> authTrustLevel = userAuth.<span class="hljs-property">AuthTrustLevel</span>.<span class="hljs-property">ATL1</span>;</li><li><span class="hljs-comment">/* 集成生成密钥参数集&amp;加密参数集。 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_SM4</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_SM4_KEY_SIZE_128</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_IV</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-variable constant_">IV</span>,</li><li>  }</li><li>];</li><li><span class="hljs-comment">/* 加密参数集。 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">huksOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: properties,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">StringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">Uint8ArrayToString</span>(<span class="hljs-params">fileData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> dataString = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; fileData.<span class="hljs-property">length</span>; i++) {</li><li>    dataString += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(fileData[i]);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> dataString;</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 初始化HUKS中的会话，获取挑战值。 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSession</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: enter initSession`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        handle = data.<span class="hljs-property">handle</span>;</li><li>        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">challenge</span> != <span class="hljs-literal">undefined</span>) {</li><li>          challenge = data.<span class="hljs-property">challenge</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: initSession success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 调用UserIAM拉起指纹认证，触发HUKS的访问控制流程。 */</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">userIAMAuthFinger</span>(<span class="hljs-params">huksChallenge: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-comment">// 获取认证对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">authTypeList</span>: userAuth.<span class="hljs-property">UserAuthType</span>[] = [authType];</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">authParam</span>: userAuth.<span class="hljs-property">AuthParam</span> = {</li><li>    <span class="hljs-attr">challenge</span>: huksChallenge,</li><li>    <span class="hljs-attr">authType</span>: authTypeList,</li><li>    <span class="hljs-attr">authTrustLevel</span>: userAuth.<span class="hljs-property">AuthTrustLevel</span>.<span class="hljs-property">ATL1</span></li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">widgetParam</span>: userAuth.<span class="hljs-property">WidgetParam</span> = {</li><li>    <span class="hljs-attr">title</span>: <span class="hljs-string">'请输入密码'</span>,</li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">auth</span>: userAuth.<span class="hljs-property">UserAuthInstance</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth = userAuth.<span class="hljs-title function_">getUserAuthInstance</span>(authParam, widgetParam);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"get auth instance success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`get auth instance failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 订阅认证结果。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth.<span class="hljs-title function_">on</span>(<span class="hljs-string">"result"</span>, {</li><li>      <span class="hljs-title function_">onResult</span>(<span class="hljs-params">result</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[HUKS] -&gt; [IAM]  userAuthInstance callback result =</span></li><li><span class="hljs-string">          <span class="hljs-subst">${result.result}</span>, <span class="hljs-subst">${result.token}</span>, <span class="hljs-subst">${result.authType}</span>, <span class="hljs-subst">${result.enrolledState}</span>`</span>);</li><li>        fingerAuthToken = result.<span class="hljs-property">token</span>;</li><li>      }</li><li>    });</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"subscribe authentication event success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe authentication event failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 开始认证。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth.<span class="hljs-title function_">start</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"authV9 start auth success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`authV9 start auth failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSession</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions, token: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`enter promise doUpdate`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">updateSession</span>(handle, huksOptions, token)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> outData = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: updateSession success, data = <span class="hljs-subst">${Uint8ArrayToString(outData)}</span>`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: updateSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: updateSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">finishSession</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions, token: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`enter promise doFinish`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(handle, huksOptions, token)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        finishOutData = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: finishSession success, data = <span class="hljs-subst">${Uint8ArrayToString(finishOutData)}</span>`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 进行数据操作。 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testSm4Cipher</span>(<span class="hljs-params"></span>) {</li><li>  huksOptions.<span class="hljs-property">inData</span> = <span class="hljs-title class_">StringToUint8Array</span>(cipherInData);</li><li>  <span class="hljs-comment">/* 传入认证令牌。 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateSession</span>(handle, huksOptions, fingerAuthToken);</li><li>  <span class="hljs-comment">/* 传入认证令牌。 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">finishSession</span>(handle, huksOptions, fingerAuthToken);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Uint8ArrayToString</span>(finishOutData) == cipherInData) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'test finish encrypt error '</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'test finish encrypt success'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testAuthControl</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">/* 初始化密钥会话获取挑战值。 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSession</span>(srcKeyAlias, huksOptions);</li><li>  <span class="hljs-comment">/* 调用userIAM进行身份认证。 */</span></li><li>  <span class="hljs-comment">/* 需要在超时10秒之前完成指纹认证。 */</span></li><li>  <span class="hljs-title function_">userIAMAuthFinger</span>(challenge);</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-title function_">testSm4Cipher</span>();</li><li>  }, <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>