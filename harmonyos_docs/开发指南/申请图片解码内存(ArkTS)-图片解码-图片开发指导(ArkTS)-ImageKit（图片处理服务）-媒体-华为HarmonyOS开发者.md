<h1 _ngcontent-jwk-c119="" class="doc-title ng-star-inserted" title="申请图片解码内存(ArkTS)"> 申请图片解码内存(ArkTS) </h1>

<div _ngcontent-jwk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>应用在进行图片解码操作时，需要申请对应内存。当前指导将介绍不同的内存类型，以及如何进行申请。</p>    <p>应用侧通过解码API接口获取PixelMap，并将其传递给Image组件以进行显示。</p>    <p>当PixelMap较大且使用共享内存时，RS主线程将经历较长的纹理上传时间，导致卡顿现象。图形侧提供了DMA内存零拷贝功能，可在绘制图片时避免纹理上传时间消耗。</p>    <div class="tiledSection">     <h2 id="内存类型介绍">内存类型介绍<i class="anchor-icon anchor-icon-link" anchorid="内存类型介绍" tips="复制节点链接"></i></h2>          <p>当前PixelMap的内存类型包括以下两种。</p>     <ul>      <li>SHARE_MEMORY：共享内存。需要进行纹理上传。</li>      <li>DMA_ALLOC：DMA内存。无需纹理上传。</li>     </ul>     <p>系统提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmapusingallocator15" target="_blank">createPixelMapUsingAllocator</a>接口，以便用户能够自定义内存分配类型进行解码。接口定义及使用示例详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource" target="_blank">图片解码接口说明</a>。</p>    </div>    <div class="tiledSection">     <h3 id="share_memory和dma_alloc的区别" class="firsth2">SHARE_MEMORY和DMA_ALLOC的区别<i class="anchor-icon anchor-icon-link" anchorid="share_memory和dma_alloc的区别" tips="复制节点链接"></i></h3>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.1" valign="top" width="33.33333333333333%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.2" valign="top" width="33.33333333333333%">SHARE_MEMORY</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.3" valign="top" width="33.33333333333333%">DMA_ALLOC</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">定义</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">操作系统提供的共享内存（如ashmem/匿名共享），便于在同一物理页上读写。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">使用可被外设/GPU/显示管线直接DMA访问的缓冲区（常见形态是dmabuf/SurfaceBuffer），用于零拷贝链路。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">工作原理</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">进程共享同一段内存，通过CPU进行读写。若要给GPU/显示使用，通常需进行拷贝。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">解码器通过DMA将数据写入dmabuf；GPU/显示直接使用该dmabuf，无需拷贝。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">使用场景</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">用于进程或线程间的数据共享，如后处理、算法中间结果交换等场景。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">视频/图片硬解、预览、显示等高带宽数据传输场景。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">CPU占用</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">CPU需参与共享内存的管理和同步（如加锁、解锁），会造成额外开销。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">占用极低，CPU仅参与DMA控制器的配置，实际数据传输无需CPU干预。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">硬件依赖</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">依赖操作系统支持的共享内存机制。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">强依赖硬件DMA控制器。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">内存分配与访问权限</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">系统为共享内存分配物理或虚拟内存区域，访问需通过用户或内核映射操作。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">DMA控制器直接操作物理内存，需预先分配DMA缓冲区（通常是连续内存）。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">优势</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">灵活性强。支持多线程或多进程同时共享数据，便于图像后处理和协作。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">高效、低延迟；适合大数据量、连续数据块的传输。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">缺点</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">共享内存操作需要额外的同步机制，增加编程复杂度和CPU负担。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">需要硬件支持，数据传输范围受DMA地址空间限制（通常需要连续物理内存）。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h3 id="使用dma_alloc的优势">使用DMA_ALLOC的优势<i class="anchor-icon anchor-icon-link" anchorid="使用dma_alloc的优势" tips="复制节点链接"></i></h3>          <ul>      <li>       <p><strong>减少纹理上传时间</strong></p>       <p>当使用SHARE_MEMORY时，图片数据需通过CPU复制到GPU显存，增加了纹理上传的时间。而采用DMA_ALLOC后，数据直接保存在GPU可访问的内存中，避免了耗时的复制过程。</p>       <ul>        <li>SHARE_MEMORY耗时：4K图片单帧渲染耗时约为20ms。</li>        <li>DMA_ALLOC耗时：4K图片单帧渲染时间可降至约4ms。此项优化在大尺寸图片显示和高频动态图片加载场景中效果尤为显著。</li>       </ul></li>      <li>       <p><strong>减轻CPU负载</strong></p>       <p>DMA_ALLOC允许GPU直接访问解码后数据，减少了内存复制带来的负载。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="系统默认的内存分配方式">系统默认的内存分配方式<i class="anchor-icon anchor-icon-link" anchorid="系统默认的内存分配方式" tips="复制节点链接"></i></h2>          <p>在使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmap7" target="_blank">createPixelMap</a>接口进行解码时，不同场景下会采取不同的内存分配类型。</p>     <p>以下场景将使用DMA_ALLOC。</p>     <ul>      <li>解码HDR图片。</li>      <li>解码HEIF格式图片。</li>      <li>解码JPEG格式图片，当原图的宽和高均在1024像素至8192像素之间，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#decodingoptions7" target="_blank">desiredPixelFormat</a>为RGBA_8888或NV21，同时硬件不繁忙（并发数为3）。</li>      <li>解码其他格式图片。要求<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#decodingoptions7" target="_blank">desiredSize</a>大于等于512像素 * 512像素（未设置desiredSize时按原图尺寸考虑），并且宽度为64的倍数。</li>     </ul>     <p>除上述场景外，其余情况均使用SHARE_MEMORY。</p>    </div>    <div class="tiledSection">     <h2 id="自定义内存分配方式">自定义内存分配方式<i class="anchor-icon anchor-icon-link" anchorid="自定义内存分配方式" tips="复制节点链接"></i></h2>          <p>默认场景下，由系统选择性能最优的内存分配方式。特定场景支持应用使用指定的内存分配方式。</p>     <p>开发者使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmapusingallocator15" target="_blank">createPixelMapUsingAllocator</a>进行解码时，系统会根据传入的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#decodingoptions7" target="_blank">解码参数</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-e#allocatortype15" target="_blank">内存申请类型</a>，自动选择硬件解码和软件解码。</p>     <p>在创建像素图时，将根据用户指定的分配器类型来决定采用DMA_ALLOC分配机制还是SHARE_MEMORY分配机制。</p>    </div>    <div class="tiledSection">     <h3 id="使用限制" class="firsth2">使用限制<i class="anchor-icon anchor-icon-link" anchorid="使用限制" tips="复制节点链接"></i></h3>          <p>当前图片解码功能针对内存分配模式有如下限制。</p>     <ul>      <li>HDR图片解码仅支持DMA_ALLOC的内存模式。</li>      <li>硬件解码仅支持DMA_ALLOC的内存模式。</li>      <li>SVG格式图片解码仅支持SHARE_MEMORY的内存模式。</li>     </ul>     <p>使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmapusingallocator15" target="_blank">createPixelMapUsingAllocator</a>进行解码时，若设置的内存分配模式，与图片格式或解码方式不匹配，则会抛出内存分配失败的异常。</p>     <p>如果用户选择的分配类型为AUTO，系统将根据解码和渲染的时间综合评估，以决定使用DMA_ALLOC还是SHARE_MEMORY分配机制。</p>     <p>不同的内存分配策略会导致图片的stride（步幅）有所差异。对于通过DMA_ALLOC申请的内存，在对PixelMap执行编辑等操作时，必须使用stride。接下来将介绍如何获取stride。</p>    </div>    <div class="tiledSection">     <h3 id="获取stride">获取stride<i class="anchor-icon anchor-icon-link" anchorid="获取stride" tips="复制节点链接"></i></h3>          <p>stride（步幅）描述了图片在内存中每一行像素数据的存储宽度。它是图片绘制过程中的重要参数，用于正确定位图片数据在内存中的布局。</p>     <p>使用DMA分配机制分配内存时，stride必须满足硬件对齐要求。</p>     <ul>      <li>stride值需为硬件平台要求字节数的整数倍。</li>      <li>       <p>当stride值不满足对齐要求时，系统会自动补齐填充数据（padding）。</p>       <p>stride的值可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#getimageinfo-1" target="_blank">getImageInfo()</a> 接口获取。</p></li>     </ul>     <ol>      <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#getimageinfo-1" target="_blank">getImageInfo()</a>方法，获取ImageInfo对象。</li>      <li>从ImageInfo对象中访问stride值：info.stride。</li>     </ol>     <div _ngcontent-jwk-c106="" class="highlight-div"><div _ngcontent-jwk-c106="" class="highlight-div-header"><div _ngcontent-jwk-c106="" class="highlight-div-header-left"><div _ngcontent-jwk-c106="" class="handle-button expand-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwk-c106="" class="highlight-div-header-right"><div _ngcontent-jwk-c106="" class="handle-button ai-button"></div><div _ngcontent-jwk-c106="" class="handle-button line-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwk-c106="" class="handle-button theme-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwk-c106="" class="handle-button copy-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwk-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CreatePixelMapUsingAllocator</span>(<span class="hljs-params">context: Context</span>) {</li><li>  <span class="hljs-keyword">const</span> resourceMgr = context.<span class="hljs-property">resourceManager</span>;</li><li>  <span class="hljs-keyword">const</span> rawFile = <span class="hljs-keyword">await</span> resourceMgr.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">"test.jpg"</span>); <span class="hljs-comment">// 测试图片。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">imageSource</span>: image.<span class="hljs-property">ImageSource</span> = image.<span class="hljs-title function_">createImageSource</span>(rawFile.<span class="hljs-property">buffer</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: image.<span class="hljs-property">DecodingOptions</span> = {};</li><li>  <span class="hljs-keyword">let</span> pixelmap = <span class="hljs-keyword">await</span> imageSource.<span class="hljs-title function_">createPixelMapUsingAllocator</span>(options, image.<span class="hljs-property">AllocatorType</span>.<span class="hljs-property">AUTO</span>);</li><li>  <span class="hljs-keyword">if</span> (pixelmap != <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">let</span> info = <span class="hljs-keyword">await</span> pixelmap.<span class="hljs-title function_">getImageInfo</span>();</li><li>    <span class="hljs-comment">// 用DMA_ALLOC内存申请出的pixelmap的stride与SHARE_MEMORY内存申请出的pixelmap的stride不同。</span></li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"stride = "</span> + info.<span class="hljs-property">stride</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">region</span>: image.<span class="hljs-property">Region</span> = {</li><li>      <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">size</span>: { <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">35</span> }</li><li>    }; <span class="hljs-comment">// 在(0, 0)位置，裁剪100 * 35的pixelMap，用于DMA_ALLOC的stride和SHARE_MEMORY的stride对齐方式不同。</span></li><li>    <span class="hljs-keyword">if</span> (pixelmap != <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">await</span> pixelmap.<span class="hljs-title function_">crop</span>(region);</li><li>      <span class="hljs-keyword">let</span> imageInfo = <span class="hljs-keyword">await</span> pixelmap.<span class="hljs-title function_">getImageInfo</span>();</li><li>      <span class="hljs-keyword">if</span> (imageInfo != <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"stride ="</span>, imageInfo.<span class="hljs-property">stride</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="解码单张图片的内存限制">解码单张图片的内存限制<i class="anchor-icon anchor-icon-link" anchorid="解码单张图片的内存限制" tips="复制节点链接"></i></h2>          <p>为了防止内存溢出导致系统崩溃，系统对进程内存做了限制，详细说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-runtime-appkilled-detection" target="_blank">应用被查杀问题检测方法</a>。</p>     <p>图片框架对解码单张图片设置了2GB的内存限制。进程需要主动管理自身内存，建议在不使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>时及时释放，以避免进程被系统终止。</p>     <p>应用可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-abilitystage#onmemorylevel" target="_blank">onMemoryLevel</a>监听系统内存变化情况。</p>     <p>PixelMap申请像素内存的计算规则如下所示。</p>     <div _ngcontent-jwk-c106="" class="highlight-div"><div _ngcontent-jwk-c106="" class="highlight-div-header"><div _ngcontent-jwk-c106="" class="highlight-div-header-left"><div _ngcontent-jwk-c106="" class="handle-button expand-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jwk-c106="" class="highlight-div-header-right"><div _ngcontent-jwk-c106="" class="handle-button ai-button"></div><div _ngcontent-jwk-c106="" class="handle-button line-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jwk-c106="" class="handle-button theme-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jwk-c106="" class="handle-button copy-button"><div _ngcontent-jwk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jwk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-swift" data-highlighted="yes"><ol class="linenums"><li>pixels_size(像素内存大小) <span class="hljs-operator">=</span> <span class="hljs-built_in">stride</span>(图片像素存储宽度) <span class="hljs-operator">*</span> height(图片像素高度)</li></ol></pre></div></div>     <p>对于原始像素内存超过2GB且支持下采样的图片，建议开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmap7" target="_blank">createPixelMap</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmapusingallocator15" target="_blank">createPixelMapUsingAllocator</a>接口，并在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-i#decodingoptions7" target="_blank">DecodingOptions（解码参数）</a>中设置desiredSize（期望输出大小）进行下采样解码。</p>     <p>从API version 21开始，对于支持下采样解码的图片，设置desiredSize（期望输出大小）后，解码器将以基准梯度为1/8的最优下采样率计算PixelMap的像素内存，即按照7/8、6/8、...、1/8的采样率，逐次递减取一个清晰度最高的采样数。</p>     <p>图片框架内，不同图片格式的下采样解码支持情况如下所示。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.11.10.1.3.1.1" valign="top" width="50%">是否支持下采样</th>         <th align="left" class="cellrowborder" id="mcps1.3.11.10.1.3.1.2" valign="top" width="50%">图片格式</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">支持</td>         <td class="cellrowborder" valign="top" width="50%">.jpg .png .heic<sup>12+</sup>（具体支持情况请参考设备规格文档。）</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">不支持</td>         <td class="cellrowborder" valign="top" width="50%">.gif .bmp .webp .dng <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#svg标签说明" target="_blank">.svg<sup>10+</sup></a> .ico<sup>11+</sup></td>        </tr>             </tbody></table></div>     </div>    </div>   </div>   <div></div></div>