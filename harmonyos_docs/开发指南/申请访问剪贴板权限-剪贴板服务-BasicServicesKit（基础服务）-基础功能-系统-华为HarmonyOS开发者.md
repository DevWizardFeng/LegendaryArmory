<h1 _ngcontent-ecp-c119="" class="doc-title ng-star-inserted" title="申请访问剪贴板权限"> 申请访问剪贴板权限 </h1>

<div _ngcontent-ecp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>API version 12及之后，系统为提升用户隐私安全保护能力，剪贴板读取接口增加权限管控。</p>     <p>涉及接口如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.3.1.1" valign="top" width="50%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.3.1.2" valign="top" width="50%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getdata9" target="_blank">getData(callback: AsyncCallback&lt;PasteData&gt;): void</a></td>         <td class="cellrowborder" valign="top" width="50%">读取系统剪贴板内容，使用callback异步回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getdata9-1" target="_blank">getData(): Promise&lt;PasteData&gt;</a></td>         <td class="cellrowborder" valign="top" width="50%">读取系统剪贴板内容，使用Promise异步回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getdatasync11" target="_blank">getDataSync(): PasteData</a></td>         <td class="cellrowborder" valign="top" width="50%">读取系统剪贴板内容, 此接口为同步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getunifieddata12" target="_blank">getUnifiedData(): Promise&lt;unifiedDataChannel.UnifiedData&gt;</a></td>         <td class="cellrowborder" valign="top" width="50%">从系统剪贴板中读取统一数据对象的数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getunifieddatasync12" target="_blank">getUnifiedDataSync(): unifiedDataChannel.UnifiedData</a></td>         <td class="cellrowborder" valign="top" width="50%">从系统剪贴板中读取统一数据对象的数据，此接口为同步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-pasteboard-h#oh_pasteboard_getdata" target="_blank">OH_UdmfData* OH_Pasteboard_GetData (OH_Pasteboard *pasteboard, int *status)</a></td>         <td class="cellrowborder" valign="top" width="50%">获取剪贴板中的数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getdatawithprogress15" target="_blank">getDataWithProgress(params: GetDataParams): Promise&lt;PasteData&gt;</a></td>         <td class="cellrowborder" valign="top" width="50%">获取剪贴板的内容和进度，使用Promise异步回调，不支持对文件夹的拷贝。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-pasteboard-h#oh_pasteboard_getdatawithprogress" target="_blank">OH_UdmfData* OH_Pasteboard_GetDataWithProgress(OH_Pasteboard* pasteboard, Pasteboard_GetDataParams* params, int* status)</a></td>         <td class="cellrowborder" valign="top" width="50%">获取剪贴板的数据以及粘贴进度，不支持对文件夹的拷贝。</td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>申请访问剪贴板权限前，需提前判断剪贴板上的内容是否包含应用所需数据，包括不限于hasData检查是否有数据、hasDataType/getMimeTypes检查是否有应用所需类型、getChangeCount检查数据是否改变，详见<a href="/consumer/cn/doc/harmonyos-guides/get-pastedata-permission-guidelines#剪贴板弹窗适配优化">剪贴板弹窗适配优化</a>。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="访问剪贴板内容">访问剪贴板内容<i class="anchor-icon anchor-icon-link" anchorid="访问剪贴板内容" tips="复制节点链接"></i></h2>          <p>剪贴板为应用提供如下两种访问内容的方式。</p>     <ul>      <li>       <p>使用安全控件</p>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/pastebutton">安全控件</a>访问剪贴板内容的应用，可以无需申请权限。</p>       <p>已经使用了安全控件的应用无需做任何适配就可以访问剪贴板内容。</p></li>      <li>       <p>申请ohos.permission.READ_PASTEBOARD权限</p>       <p>ohos.permission.READ_PASTEBOARD是受限的user_grant（用户授权）权限，使用自定义控件的应用申请此权限后，在用户授权场景下可访问剪贴板内容。</p>       <p>权限申请步骤：</p></li>     </ul>     <ol>      <li>查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_pasteboard">READ_PASTEBOARD</a>介绍，审视应用是否符合申请该权限的使用场景。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-add-releaseprofile-0000001914714796" target="_blank">在AGC侧申请Profile文件</a>，将用于后续的应用签名信息配置。</li>      <li>在module.json5配置文件中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。</li>      <li>通过弹窗向<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization" target="_blank">用户申请权限</a>。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="剪贴板弹窗适配优化">剪贴板弹窗适配优化<i class="anchor-icon anchor-icon-link" anchorid="剪贴板弹窗适配优化" tips="复制节点链接"></i></h2>          <p>应用申请剪贴板权限需要提前判断剪贴板上的内容是否包含所需数据，避免出现无效弹框。</p>     <ul>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#hasdata9" target="_blank">hasData</a>判断剪贴板是否有数据，无数据则不访问剪贴板。</p></li>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#hasdatatype11" target="_blank">hasDataType</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getmimetypes14" target="_blank">getMimeTypes</a>判断是否包含应用当前场景支持处理的数据类型，如果没有对应的数据类型，则不访问剪贴板。</p></li>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#getchangecount18" target="_blank">getChangeCount</a>获取剪贴板的内容变化次数，与上次读取剪贴板时查询的变化次数比较是否一致，一致则剪贴板内容无变化，不访问剪贴板。</p></li>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#detectpatterns13" target="_blank">detectPatterns</a>判断是否包含应用自身口令的格式，如果格式不匹配，则不访问剪贴板。应用读取口令后如果确认是自身的口令，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pasteboard#cleardata9" target="_blank">cleardata</a>清除剪贴板口令内容。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <div _ngcontent-ecp-c106="" class="highlight-div"><div _ngcontent-ecp-c106="" class="highlight-div-header"><div _ngcontent-ecp-c106="" class="highlight-div-header-left"><div _ngcontent-ecp-c106="" class="handle-button expand-button"><div _ngcontent-ecp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ecp-c106="" class="highlight-div-header-right"><div _ngcontent-ecp-c106="" class="handle-button ai-button"></div><div _ngcontent-ecp-c106="" class="handle-button line-button"><div _ngcontent-ecp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ecp-c106="" class="handle-button theme-button"><div _ngcontent-ecp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ecp-c106="" class="handle-button copy-button"><div _ngcontent-ecp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ecp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, pasteboard } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, common, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { preferences } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">permissions</span>: <span class="hljs-title class_">Permissions</span>[] = [<span class="hljs-string">'ohos.permission.READ_PASTEBOARD'</span>];</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">systemPasteboard</span>: pasteboard.<span class="hljs-property">SystemPasteboard</span> = pasteboard.<span class="hljs-title function_">getSystemPasteboard</span>();</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">patterns</span>: pasteboard.<span class="hljs-property">Pattern</span>[] = [pasteboard.<span class="hljs-property">Pattern</span>.<span class="hljs-property">URL</span>, pasteboard.<span class="hljs-property">Pattern</span>.<span class="hljs-property">EMAIL_ADDRESS</span>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dataPreferences</span>: preferences.<span class="hljs-property">Preferences</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isNeedGetPermissionFromUser</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">hasData</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-keyword">await</span> systemPasteboard.<span class="hljs-title function_">hasData</span>();</li><li>    <span class="hljs-keyword">if</span> (!hasData) {</li><li>      <span class="hljs-comment">// 剪贴板不存在数据，无需申请权限</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 获取剪贴板的内容变化次数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span> = systemPasteboard.<span class="hljs-title function_">getChangeCount</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Succeeded in getting the ChangeCount. Result: ${result}'</span>);</li><li>    <span class="hljs-comment">// 从 Preferences 中读取上次保存的 changeCount</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">storedChangeCount</span>: <span class="hljs-built_in">number</span> = dataPreferences ? <span class="hljs-title class_">Number</span>(dataPreferences.<span class="hljs-title function_">getSync</span>(<span class="hljs-string">'pasteboardChangeCount'</span>, <span class="hljs-number">0</span>)) : <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (result === storedChangeCount) {</li><li>      <span class="hljs-comment">// 剪贴板无数据变化，无需申请权限</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Failed to get the ChangeCount. Cause: ${err.message}'</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 查询剪贴板是否存在应用所需数据类型</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// (可选)判断是否有应用需要的数据类型</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">boolean</span> = systemPasteboard.<span class="hljs-title function_">hasDataType</span>(pasteboard.<span class="hljs-property">MIMETYPE_TEXT_PLAIN</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Succeeded in checking the DataType. Result: ${result}'</span>);</li><li>    <span class="hljs-keyword">if</span> (!result) {</li><li>      <span class="hljs-comment">// 剪贴板不存在应用所需数据类型，无需申请权限</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// (可选)涉及口令等应用自身特殊复制内容的，使用detectPatterns过滤口令格式</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: pasteboard.<span class="hljs-property">Pattern</span>[] = <span class="hljs-keyword">await</span> systemPasteboard.<span class="hljs-title function_">detectPatterns</span>(patterns);</li><li>    <span class="hljs-keyword">if</span> (patterns.<span class="hljs-title function_">sort</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>) != data.<span class="hljs-title function_">sort</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Not all needed patterns detected, no need to get data.'</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Failed to check the DataType. Cause:'</span> + err.<span class="hljs-property">message</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  };</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'粘贴'</span>)</li><li>          <span class="hljs-comment">// ...</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isNeedGetPermissionFromUser</span>()) {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'No need to bring up the permission pop-up window'</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>            <span class="hljs-comment">// requestPermissionsFromUser会判断权限的授权状态来决定是否唤起弹窗。</span></li><li>            atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, permissions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">grantStatus</span>: <span class="hljs-built_in">number</span>[] = data.<span class="hljs-property">authResults</span>;</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> status <span class="hljs-keyword">of</span> grantStatus) {</li><li>                <span class="hljs-keyword">if</span> (status === <span class="hljs-number">0</span>) {</li><li>                  <span class="hljs-comment">// 用户授权，使用get操作读取剪贴板内容。</span></li><li>                  <span class="hljs-comment">// ...</span></li><li>                  <span class="hljs-comment">// 执行判断口令逻辑，如果是本应用口令，建议获取完数据后使用cleardata清除剪贴板口令内容</span></li><li>                  systemPasteboard.<span class="hljs-title function_">clearData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>                    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Succeeded in clearing the pasteboard.'</span>);</li><li>                  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Failed to clear the pasteboard. Cause: ${err.message}'</span>);</li><li>                  });</li><li>                  <span class="hljs-comment">// 获取当前 ChangeCount</span></li><li>                  <span class="hljs-keyword">let</span> <span class="hljs-attr">currentChangeCount</span>: <span class="hljs-built_in">number</span> = systemPasteboard.<span class="hljs-title function_">getChangeCount</span>();</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Current ChangeCount: '</span> + currentChangeCount);</li><li>                  <span class="hljs-comment">// 更新 Preferences 中的 ChangeCount</span></li><li>                  <span class="hljs-keyword">if</span> (dataPreferences) {</li><li>                    dataPreferences.<span class="hljs-title function_">putSync</span>(<span class="hljs-string">'pasteboardChangeCount'</span>, currentChangeCount);</li><li>                    dataPreferences.<span class="hljs-title function_">flushSync</span>(); <span class="hljs-comment">// 确保数据写入持久化存储</span></li><li>                    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'ChangeCount has been updated to: '</span> + currentChangeCount);</li><li>                  }</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-comment">// 用户拒绝授权，提示用户必须授权才能访问当前页面的功能，并引导用户到系统设置中打开相应的权限。</span></li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>              }</li><li>              <span class="hljs-comment">// 授权成功。</span></li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'[Sample_pasteboard]'</span>, <span class="hljs-string">'Failed to request permissions from user. '</span>);</li><li>            })</li><li>          })</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>