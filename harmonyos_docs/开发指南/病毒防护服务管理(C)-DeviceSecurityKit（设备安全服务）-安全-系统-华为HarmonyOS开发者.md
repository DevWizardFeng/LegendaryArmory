<h1 _ngcontent-wbb-c119="" class="doc-title ng-star-inserted" title="病毒防护服务管理(C)"> 病毒防护服务管理(C) </h1>

<div _ngcontent-wbb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1848561517482">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1848561517482" tips="复制节点链接"></i></h2>          <p>从6.0.0(20)开始，三方EDR（Endpoint Detection and Response）应用在Device Security Kit上注册后，可以调用注册、更新、卸载（删除数据）接口，将自身应用信息提交至HarmonyOS安全防护服务进行统一管理；零信任应用在Device Security Kit上注册后，可以查询所有注册的EDR信息列表（包含包名、当前版本号、上次更新时间、病毒防护开关状态、用户ID）；MDM应用在Device Security Kit上注册后，企业管理员可通过MDM（Mobile Device Management）应用启用或禁用HarmonyOS自带的安全防护服务。</p>    </div>    <div class="tiledSection">     <h2 id="section171081437499">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section171081437499" tips="复制节点链接"></i></h2>          <ol>      <li>当前能力仅支持2in1设备。</li>      <li>不支持并发场景，同一时间仅允许一个三方EDR应用或MDM应用调用该模块接口。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section13256143917491">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section13256143917491" tips="复制节点链接"></i></h2>          <p><span><img originheight="353" originwidth="694" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115023.36113641844998474003639844645611:50001231000000:2800:A5FA0947B36A69E146488E0740C5CB84C6FB7E1AFDFBAA87D7210A72F66C94FE.png" width="694" height="353"></span></p>     <p><span><img originheight="210" originwidth="694" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115023.45409510678041533116197043589056:50001231000000:2800:9A2699D6732D8F9454D65F9C0A8A55207C3B28946A0F5F6A0534A0BE373CA6A4.png" width="694" height="210"></span></p>     <p><span><img originheight="486" originwidth="714" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115023.72965038621060133981687276142346:50001231000000:2800:AE59745EF6C622BB7E6FB65028F05F90478BF7E740C973771933BE1194F80ECE.png" width="714" height="486"></span></p>    </div>    <p><strong>流程说明</strong>：</p>    <ol>     <li>三方EDR应用注册、更新、卸载时调用该模块接口向HarmonyOS安全防护服务进行应用信息同步。</li>     <li>零信任应用调用该模块接口查询当前注册的所有三方EDR应用的信息。</li>     <li>MDM应用调用该模块接口实现HarmonyOS安全防护功能的启停。</li>    </ol>    <div class="tiledSection">     <h2 id="section183203297523">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section183203297523" tips="复制节点链接"></i></h2>          <p>以下是病毒防护服务管理的相关接口，更多接口及使用方法请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/devicesecurity-capi-securityantivirus" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="break-all layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.3.1.1" valign="top" width="42.78%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.3.1.2" valign="top" width="57.220000000000006%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_RegisterAntivirus(const char* bundleName)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>三方EDR应用向HarmonyOS安全防护服务注册。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_UnregisterAntivirus(const char* bundleName)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>三方EDR应用从HarmonyOS安全防护服务注销。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_UpdateAntivirus(const SecurityAntivirus_Antivirus* antivirus)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>三方EDR应用向HarmonyOS安全防护服务更新自身应用信息，包含包名、当前版本号、上次更新时间、病毒防护开关状态、用户ID。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_QueryAntivirus(SecurityAntivirus_Antivirus** list, uint32_t* length)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>零信任应用向HarmonyOS安全防护服务查询当前所有三方EDR注册信息。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_QueryPreinstalledAntivirus</p>          <p>(SecurityAntivirus_Antivirus** list, uint32_t* length)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>MDM应用向HarmonyOS安全防护服务查询所有用户的防病毒功能状态。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_EnablePreinstalledAntivirus(void)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>MDM应用启用HarmonyOS安全防护服务所有用户的防病毒功能。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_DisablePreinstalledAntivirus(void)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>MDM应用禁用HarmonyOS安全防护服务所有用户的防病毒功能。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_EnablePreinstalledAntivirusByAccount(int32_t accountId)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>MDM应用启用HarmonyOS安全防护服务中用户ID为accountId的防病毒功能。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="42.78%">          <p>SecurityAntivirus_ErrCode HMS_SecurityAntivirus_DisablePreinstalledAntivirusByAccount(int32_t accountId)</p></td>         <td class="cellrowborder" valign="top" width="57.220000000000006%">          <p>MDM应用禁用HarmonyOS安全防护服务中用户ID为accountId的防病毒功能。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section17653123416573">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section17653123416573" tips="复制节点链接"></i></h2>          <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>在开发准备过程中，需要申请权限：ohos.permission.REGISTER_ANTIVIRUS、ohos.permission.MANAGE_ANTIVIRUS、ohos.permission.MANAGE_PREINSTALLED_ANTIVIRUS。</li>        <li>只允许名单内的应用申请该权限，申请方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-enterprise-apps" target="_blank">申请使用企业类应用可用权限</a>，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-mdm-apps" target="_blank">申请使用仅MDM应用可用权限</a></li>       </ul>      </div></div></div>     <ol>      <li><span>在CMakeLists.txt中导入病毒防护服务管理共享库，并链接该库。</span>       <p></p>       <div _ngcontent-wbb-c106="" class="highlight-div"><div _ngcontent-wbb-c106="" class="highlight-div-header"><div _ngcontent-wbb-c106="" class="highlight-div-header-left"><div _ngcontent-wbb-c106="" class="handle-button expand-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wbb-c106="" class="highlight-div-header-right"><div _ngcontent-wbb-c106="" class="handle-button ai-button"></div><div _ngcontent-wbb-c106="" class="handle-button line-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wbb-c106="" class="handle-button theme-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wbb-c106="" class="handle-button copy-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wbb-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(dsm-lib libsecurityantivirus_ndk.z.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so ${dsm-lib})</li></ol></pre></div></div>       <p></p></li>      <li><span>导入病毒防护服务管理的头文件。</span>       <p></p>       <div _ngcontent-wbb-c106="" class="highlight-div"><div _ngcontent-wbb-c106="" class="highlight-div-header"><div _ngcontent-wbb-c106="" class="highlight-div-header-left"><div _ngcontent-wbb-c106="" class="handle-button expand-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wbb-c106="" class="highlight-div-header-right"><div _ngcontent-wbb-c106="" class="handle-button ai-button"></div><div _ngcontent-wbb-c106="" class="handle-button line-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wbb-c106="" class="handle-button theme-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wbb-c106="" class="handle-button copy-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wbb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"DeviceSecurityKit/security_antivirus.h"</span></span></li></ol></pre></div></div>       <p></p></li>      <li><span>EDR应用执行接口调用，分别向HarmonyOS安全防护服务中同步注册、卸载、更新信息，需要ohos.permission.REGISTER_ANTIVIRUS权限。</span>       <p></p>       <div _ngcontent-wbb-c106="" class="highlight-div"><div _ngcontent-wbb-c106="" class="highlight-div-header"><div _ngcontent-wbb-c106="" class="highlight-div-header-left"><div _ngcontent-wbb-c106="" class="handle-button expand-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wbb-c106="" class="highlight-div-header-right"><div _ngcontent-wbb-c106="" class="handle-button ai-button"></div><div _ngcontent-wbb-c106="" class="handle-button line-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wbb-c106="" class="handle-button theme-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wbb-c106="" class="handle-button copy-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wbb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *regisBundleName = <span class="hljs-string">"****"</span>; <span class="hljs-comment">// 构造注册接口入参</span></li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">HMS_SecurityAntivirus_RegisterAntivirus</span>(regisBundleName);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_RegisterAntivirus ret = %d \n"</span>, ret);</li><li>
</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *unRegisBundleName = <span class="hljs-string">"****"</span>; <span class="hljs-comment">// 构造卸载接口入参</span></li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_UnregisterAntivirus</span>(unRegisBundleName);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_UnregisterAntivirus ret = %d \n"</span>, ret);</li><li>
</li><li>SecurityAntivirus_Antivirus updateAntivirus; <span class="hljs-comment">// 构造更新接口入参</span></li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_UpdateAntivirus</span>(&amp;updateAntivirus);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_UpdateAntivirus ret = %d \n"</span>, ret);</li></ol></pre></div></div>       <p></p></li>      <li><span>零信任应用执行接口调用，查询当前所有在HarmonyOS安全防护服务中注册的三方EDR应用信息，需要ohos.permission.MANAGE_ANTIVIRUS权限。</span>       <p></p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>零信任应用在根据应用进程信息进行业务处理后，需要释放查询接口出入参的内存。</p>        </div></div></div>       <div class="p">        <div _ngcontent-wbb-c106="" class="highlight-div"><div _ngcontent-wbb-c106="" class="highlight-div-header"><div _ngcontent-wbb-c106="" class="highlight-div-header-left"><div _ngcontent-wbb-c106="" class="handle-button expand-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wbb-c106="" class="highlight-div-header-right"><div _ngcontent-wbb-c106="" class="handle-button ai-button"></div><div _ngcontent-wbb-c106="" class="handle-button line-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wbb-c106="" class="handle-button theme-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wbb-c106="" class="handle-button copy-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wbb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>SecurityAntivirus_Antivirus *list = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 构造查询接口出参1</span></li><li><span class="hljs-type">uint32_t</span> length = <span class="hljs-number">0</span>; <span class="hljs-comment">// 构造查询接口出参2</span></li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">HMS_SecurityAntivirus_QueryAntivirus</span>(&amp;list, &amp;length);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_QueryAntivirus ret = %d \n"</span>, ret);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; length; ++i) {</li><li>    <span class="hljs-built_in">free</span>((<span class="hljs-type">char</span>*)(list[i].bundleName)); <span class="hljs-comment">// 释放出参内部字符串</span></li><li>    <span class="hljs-built_in">free</span>((<span class="hljs-type">char</span>*)(list[i].metadata));</li><li>}</li><li><span class="hljs-built_in">free</span>(list); <span class="hljs-comment">// 释放出参数组本身</span></li></ol></pre></div></div>       </div>       <p></p></li>      <li><span>MDM应用执行接口调用，实现HarmonyOS安全防护服务的启停，需要ohos.permission.MANAGE_PREINSTALLED_ANTIVIRUS权限。</span>       <p></p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>MDM应用在根据应用进程信息进行业务处理后，需要释放查询接口出入参的内存。</p>        </div></div></div>       <div class="p">        <div _ngcontent-wbb-c106="" class="highlight-div"><div _ngcontent-wbb-c106="" class="highlight-div-header"><div _ngcontent-wbb-c106="" class="highlight-div-header-left"><div _ngcontent-wbb-c106="" class="handle-button expand-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wbb-c106="" class="highlight-div-header-right"><div _ngcontent-wbb-c106="" class="handle-button ai-button"></div><div _ngcontent-wbb-c106="" class="handle-button line-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wbb-c106="" class="handle-button theme-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wbb-c106="" class="handle-button copy-button"><div _ngcontent-wbb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wbb-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>SecurityAntivirus_Antivirus *list = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 构造查询接口出参1</span></li><li><span class="hljs-type">uint32_t</span> length = <span class="hljs-number">0</span>; <span class="hljs-comment">// 构造查询接口出参2</span></li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">HMS_SecurityAntivirus_QueryPreinstalledAntivirus</span>(&amp;list, &amp;length);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_QueryPreinstalledAntivirus ret = %d \n"</span>, ret);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; length; ++i) {</li><li>    <span class="hljs-built_in">free</span>((<span class="hljs-type">char</span>*)(list[i].bundleName)); <span class="hljs-comment">// 释放出参内部字符串</span></li><li>    <span class="hljs-built_in">free</span>((<span class="hljs-type">char</span>*)(list[i].metadata));</li><li>}</li><li><span class="hljs-built_in">free</span>(list); <span class="hljs-comment">// 释放出参数组本身</span></li><li>
</li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_EnablePreinstalledAntivirus</span>();</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_EnablePreinstalledAntivirus ret = %d \n"</span>, ret);</li><li>
</li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_DisablePreinstalledAntivirus</span>();</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_DisablePreinstalledAntivirus ret = %d \n"</span>, ret);</li><li>
</li><li><span class="hljs-type">int32_t</span> accountId = <span class="hljs-number">0</span>; <span class="hljs-comment">// 构造合法的用户ID</span></li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_EnablePreinstalledAntivirusByAccount</span>(accountId);</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_EnablePreinstalledAntivirusByAccount ret = %d \n"</span>, ret);</li><li>
</li><li>ret = <span class="hljs-built_in">HMS_SecurityAntivirus_DisablePreinstalledAntivirusByAccount</span>(accountId );</li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"HMS_SecurityAntivirus_DisablePreinstalledAntivirusByAccount ret = %d \n"</span>, ret);</li></ol></pre></div></div>       </div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>