<h1 _ngcontent-mwe-c119="" class="doc-title ng-star-inserted" title="监听组件布局和绘制送显事件"> 监听组件布局和绘制送显事件 </h1>

<div _ngcontent-mwe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 16开始，NDK接口针对UI组件的布局或绘制送显完成，提供了注册与取消监听函数的方式。开发者可使用如下接口监听指定节点布局完成或者绘制送显完成的时机，并注册相应的回调函数。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_registerlayoutcallbackonnodehandle" target="_blank">OH_ArkUI_RegisterLayoutCallbackOnNodeHandle</a>注册组件布局完成的回调方法。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_registerdrawcallbackonnodehandle" target="_blank">OH_ArkUI_RegisterDrawCallbackOnNodeHandle</a>注册绘制送显完成的回调方法。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_unregisterlayoutcallbackonnodehandle" target="_blank">OH_ArkUI_UnregisterLayoutCallbackOnNodeHandle</a>取消组件布局完成的回调方法注册。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_unregisterdrawcallbackonnodehandle" target="_blank">OH_ArkUI_UnregisterDrawCallbackOnNodeHandle</a>取消绘制送显完成的回调方法注册。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_registerlayoutcallbackonnodehandle" target="_blank">OH_ArkUI_RegisterLayoutCallbackOnNodeHandle</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-h#oh_arkui_registerdrawcallbackonnodehandle" target="_blank">OH_ArkUI_RegisterDrawCallbackOnNodeHandle</a>能够监听组件的布局完成或者绘制送显完成事件触发，但只能传递一个函数指针，多次调用使用最后一次的函数指针进行回调。</p>     </div></div></div>    <p>以下示例基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-access-the-arkts-page">接入ArkTS页面</a>章节，补充相关事件监听。</p>    <p>在ArkUITextNode对象中实现布局或者绘制送显完成事件注册逻辑。</p>    <div _ngcontent-mwe-c106="" class="highlight-div"><div _ngcontent-mwe-c106="" class="highlight-div-header"><div _ngcontent-mwe-c106="" class="highlight-div-header-left"><div _ngcontent-mwe-c106="" class="handle-button expand-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mwe-c106="" class="highlight-div-header-right"><div _ngcontent-mwe-c106="" class="handle-button ai-button"></div><div _ngcontent-mwe-c106="" class="handle-button line-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mwe-c106="" class="handle-button theme-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mwe-c106="" class="handle-button copy-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mwe-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ArkUITextNode.h</span></li><li><span class="hljs-comment">// 实现文本组件的封装类。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_ARKUITEXTNODE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_ARKUITEXTNODE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_type.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arkui/native_node.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUINode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li><span class="hljs-comment">// 布局完成的回调方法</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OnLayoutCompleted</span><span class="hljs-params">(<span class="hljs-type">void</span>* userData)</span> {</li><li>    ArkUI_NodeHandle node = (ArkUI_NodeHandle)userData;</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"the text_node is layout completed"</span>);</li><li>    ArkUI_NativeNodeAPI_1 *nativeModule = NativeModuleInstance::GetInstance()-&gt;GetNativeNodeAPI();</li><li>    ArkUI_AttributeItem item = {nullptr, <span class="hljs-number">0</span>, <span class="hljs-string">"layout callback"</span>};</li><li>    nativeModule-&gt;setAttribute(node, NODE_TEXT_CONTENT, &amp;item);</li><li>}</li><li><span class="hljs-comment">// 绘制送显完成的回调方法</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">OnDrawCompleted</span><span class="hljs-params">(<span class="hljs-type">void</span>* userData)</span> {</li><li>    ArkUI_NodeHandle node = (ArkUI_NodeHandle)userData;</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"the text_node is draw completed"</span>);</li><li>    ArkUI_NativeNodeAPI_1 *nativeModule = NativeModuleInstance::GetInstance()-&gt;GetNativeNodeAPI();</li><li>    ArkUI_AttributeItem item = {nullptr, <span class="hljs-number">0</span>, <span class="hljs-string">"draw callback"</span>};</li><li>    nativeModule-&gt;setAttribute(node, NODE_TEXT_CONTENT, &amp;item);</li><li>}</li><li>
</li><li><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArkUITextNode</span> :</span> public ArkUINode {</li><li>public:</li><li>    ArkUITextNode()</li><li>        : ArkUINode((NativeModuleInstance::GetInstance()-&gt;GetNativeNodeAPI())-&gt;createNode(ARKUI_NODE_TEXT)) {}</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetFontSize</span><span class="hljs-params">(<span class="hljs-type">float</span> fontSize)</span> {</li><li>        assert(handle_);</li><li>        ArkUI_NumberValue value[] = {{.f32 = fontSize}};</li><li>        ArkUI_AttributeItem item = {value, <span class="hljs-number">1</span>};</li><li>        nativeModule_-&gt;setAttribute(handle_, NODE_FONT_SIZE, &amp;item);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetFontColor</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> color)</span> {</li><li>        assert(handle_);</li><li>        ArkUI_NumberValue value[] = {{.u32 = color}};</li><li>        ArkUI_AttributeItem item = {value, <span class="hljs-number">1</span>};</li><li>        nativeModule_-&gt;setAttribute(handle_, NODE_FONT_COLOR, &amp;item);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetTextContent</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;content)</span> {</li><li>        assert(handle_);</li><li>        ArkUI_AttributeItem item = {nullptr, <span class="hljs-number">0</span>, content.c_str()};</li><li>        nativeModule_-&gt;setAttribute(handle_, NODE_TEXT_CONTENT, &amp;item);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetTextAlign</span><span class="hljs-params">(ArkUI_TextAlignment align)</span> {</li><li>        assert(handle_);</li><li>        ArkUI_NumberValue value[] = {{.i32 = align}};</li><li>        ArkUI_AttributeItem item = {value, <span class="hljs-number">1</span>};</li><li>        nativeModule_-&gt;setAttribute(handle_, NODE_TEXT_ALIGN, &amp;item);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetLayoutCallBack</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> nodeId)</span> {</li><li>        assert(handle_);</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"set layout callback"</span>);</li><li>        <span class="hljs-comment">// 注册布局完成的回调方法</span></li><li>        OH_ArkUI_RegisterLayoutCallbackOnNodeHandle(handle_, this, OnLayoutCompleted);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">ResetLayoutCallBack</span><span class="hljs-params">()</span> {</li><li>        assert(handle_);</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"reset layout callback"</span>);</li><li>        <span class="hljs-comment">// 取消注册布局完成的回调方法</span></li><li>        OH_ArkUI_UnregisterLayoutCallbackOnNodeHandle(handle_);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetDrawCallBack</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> nodeId)</span> {</li><li>        assert(handle_);</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"set draw callback"</span>);</li><li>        <span class="hljs-comment">// 注册绘制送显完成的回调方法</span></li><li>        OH_ArkUI_RegisterDrawCallbackOnNodeHandle(handle_, this, OnDrawCompleted);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">ResetDrawCallBack</span><span class="hljs-params">()</span> {</li><li>        assert(handle_);</li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"reset draw callback"</span>);</li><li>        <span class="hljs-comment">// 取消注册绘制送显完成的回调方法</span></li><li>        OH_ArkUI_UnregisterDrawCallbackOnNodeHandle(handle_);</li><li>    }</li><li>    <span class="hljs-type">void</span> <span class="hljs-title function_">SetInspectorId</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> inspectorId)</span> {</li><li>        ArkUI_AttributeItem item = {nullptr, <span class="hljs-number">0</span>, inspectorId.c_str()};</li><li>        nativeModule_-&gt;setAttribute(handle_, NODE_ID, &amp;item);</li><li>    }</li><li>};</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_ARKUITEXTNODE_H</span></span></li></ol></pre></div></div>    <div _ngcontent-mwe-c106="" class="highlight-div"><div _ngcontent-mwe-c106="" class="highlight-div-header"><div _ngcontent-mwe-c106="" class="highlight-div-header-left"><div _ngcontent-mwe-c106="" class="handle-button expand-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mwe-c106="" class="highlight-div-header-right"><div _ngcontent-mwe-c106="" class="handle-button ai-button"></div><div _ngcontent-mwe-c106="" class="handle-button line-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mwe-c106="" class="handle-button theme-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mwe-c106="" class="handle-button copy-button"><div _ngcontent-mwe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mwe-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// NormalTextListExample.h</span></li><li><span class="hljs-comment">// 自定义NDK接口入口函数。</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MYAPPLICATION_NORMALTEXTLISTEXAMPLE_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> MYAPPLICATION_NORMALTEXTLISTEXAMPLE_H</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIBaseNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIListItemNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUIListNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ArkUITextNode.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li>namespace NativeModule {</li><li>
</li><li><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;ArkUIBaseNode&gt; <span class="hljs-title function_">CreateTextListExample</span><span class="hljs-params">()</span> {</li><li>    <span class="hljs-comment">// 创建组件并挂载</span></li><li>    <span class="hljs-comment">// 1：使用智能指针创建List组件。</span></li><li>    <span class="hljs-keyword">auto</span> <span class="hljs-built_in">list</span> = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUIListNode&gt;();</li><li>    <span class="hljs-built_in">list</span>-&gt;SetPercentWidth(<span class="hljs-number">1</span>);</li><li>    <span class="hljs-built_in">list</span>-&gt;SetPercentHeight(<span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 2：创建ListItem子组件并挂载到List上。</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1</span>; ++i) {</li><li>        <span class="hljs-keyword">auto</span> listItem = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUIListItemNode&gt;();</li><li>        <span class="hljs-keyword">auto</span> textNode = <span class="hljs-built_in">std</span>::make_shared&lt;ArkUITextNode&gt;();</li><li>        textNode-&gt;SetTextContent(<span class="hljs-built_in">std</span>::to_string(i));</li><li>        textNode-&gt;SetFontSize(<span class="hljs-number">16</span>);</li><li>        textNode-&gt;SetPercentWidth(<span class="hljs-number">1</span>);</li><li>        textNode-&gt;SetHeight(<span class="hljs-number">100</span>);</li><li>        textNode-&gt;SetBackgroundColor(<span class="hljs-number">0xFFfffacd</span>);</li><li>        textNode-&gt;SetTextAlign(ARKUI_TEXT_ALIGNMENT_CENTER);</li><li>        <span class="hljs-comment">// 在当前节点注册布局回调</span></li><li>        textNode-&gt;SetLayoutCallBack(i);</li><li>        <span class="hljs-comment">// 在当前节点注册绘制送显回调</span></li><li>        textNode-&gt;SetDrawCallBack(i);</li><li>        listItem-&gt;AddChild(textNode);</li><li>        <span class="hljs-built_in">list</span>-&gt;AddChild(listItem);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>;</li><li>}</li><li>} <span class="hljs-comment">// namespace NativeModule</span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MYAPPLICATION_NORMALTEXTLISTEXAMPLE_H</span></span></li></ol></pre></div></div>   </div>   <div></div></div>