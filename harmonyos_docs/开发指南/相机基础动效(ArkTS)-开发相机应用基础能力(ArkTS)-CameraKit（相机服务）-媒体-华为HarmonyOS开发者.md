<h1 _ngcontent-uax-c119="" class="doc-title ng-star-inserted" title="相机基础动效(ArkTS)"> 相机基础动效(ArkTS) </h1>

<div _ngcontent-uax-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在使用相机过程中，如相机模式切换，前后置镜头切换等场景，不可避免出现预览流替换，为优化用户体验，可合理使用动效过渡。本文主要介绍如何使用预览流截图，并通过ArkUI提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-explicit-animatetoimmediately" target="_blank">显示动画能力</a>实现下方三种核心场景动效：</p>    <ul>     <li>      <p>模式切换动效，使用预览流截图做模糊动效过渡。</p>      <p>图片为从录像模式切换为拍照模式的效果。</p>      <p><span><img originheight="458" originwidth="221" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.40697391077938517766297407934122:50001231000000:2800:6523EFB236E6B88946ECB65D860C3ADFBC8A57190354C505FB60D3F9EFCB01C9.gif" class="notEnlarge" width="221" height="458"></span></p></li>     <li>      <p>前后置切换动效，使用预览流截图做翻转模糊动效过渡。</p>      <p>图片为从前置相机切换为后置相机的效果。</p>      <p><span><img originheight="458" originwidth="221" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.65257047947665290588957833759477:50001231000000:2800:6043775B48714888D6610F7D89C918C0CB1CD4ACF3A1CC9AB983F612B34189BA.gif" class="notEnlarge" width="221" height="458"></span></p></li>     <li>      <p>拍照闪黑动效，使用闪黑组件覆盖预览流实现闪黑动效过渡。</p>      <p>图片为点击完成拍摄的效果。</p>      <p><span><img originheight="458" originwidth="221" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114438.83898120486191913806939761877502:50001231000000:2800:CBBB4BEC45EFF8F50F5F3764CB7C236B869C367F091CCF458446146214E26342.gif" class="notEnlarge" width="221" height="458"></span></p></li>    </ul>    <div class="tiledSection">     <h2 id="闪黑动效">闪黑动效<i class="anchor-icon anchor-icon-link" anchorid="闪黑动效" tips="复制节点链接"></i></h2>          <p>使用组件覆盖的形式实现闪黑效果。</p>     <p>以下步骤中的示例代码均为自定义组件（即被@Component修饰的组件）的内部方法或逻辑。</p>     <ol>      <li>       <p>导入依赖，需要导入相机框架、图片、ArkUI相关领域依赖。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { curves } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li></ol></pre></div></div></li>      <li>       <p>构建闪黑组件。</p>       <p>此处定义一个闪黑组件，在拍照闪黑及前后置切换时显示，用来遮挡XComponent组件。</p>       <p>属性定义：</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@State</span> <span class="hljs-attr">isShowBlack</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否显示闪黑组件。</span></li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'captureClick'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onCaptureClick'</span>) <span class="hljs-attr">captureClickFlag</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 拍照闪黑动效入口。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">flashBlackOpacity</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 闪黑组件透明度。</span></li></ol></pre></div></div>       <p>闪黑组件的实现逻辑参考：</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 拍照闪黑及前后置切换时显示，用来遮挡XComponent组件。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlack</span>) {</li><li>  <span class="hljs-title class_">Column</span>()</li><li>    .<span class="hljs-title function_">key</span>(<span class="hljs-string">'black'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1080</span>)) <span class="hljs-comment">// 与预览流XComponent宽高保持一致，图层在预览流之上，截图组件之下。</span></li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1920</span>))</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>    .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">flashBlackOpacity</span>)</li><li>}</li></ol></pre></div></div></li>      <li>       <p>实现闪黑动效。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// @Component修饰组件的内部方法。</span></li><li><span class="hljs-title function_">flashBlackAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'flashBlackAnim E'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">flashBlackOpacity</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 闪黑组件不透明。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlack</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 显示闪黑组件。</span></li><li>  <span class="hljs-title function_">animateToImmediately</span>({</li><li>    <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">interpolatingSpring</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">410</span>, <span class="hljs-number">38</span>),</li><li>    <span class="hljs-attr">delay</span>: <span class="hljs-number">50</span>, <span class="hljs-comment">// 延时50ms，实现黑屏。</span></li><li>    <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlack</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 闪黑组件下树。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">flashBlackOpacity</span> = <span class="hljs-number">1</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'flashBlackAnim X'</span>);</li><li>    }</li><li>  }, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">flashBlackOpacity</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 闪黑组件从不透明到透明。</span></li><li>  })</li><li>}</li></ol></pre></div></div></li>      <li>       <p>触发闪黑动效。</p>       <p>点击或触控拍照按钮，更新StorageLink绑定CaptureClick的值，触发onCaptureClick方法，动效开始播放。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onCaptureClick</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onCaptureClick'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flashBlackAnim</span>();</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="模糊动效">模糊动效<i class="anchor-icon anchor-icon-link" anchorid="模糊动效" tips="复制节点链接"></i></h2>          <p>通过预览流截图，实现模糊动效，从而完成模式切换，或是前后置切换的动效。</p>     <p>以下除了步骤2，其他步骤中的示例代码均为自定义组件（即被@Component修饰的组件）的内部方法或逻辑。</p>     <ol>      <li>       <p>导入依赖，需要导入相机框架、图片、ArkUI相关领域依赖。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { curves } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li></ol></pre></div></div></li>      <li>       <p>获取预览流截图。</p>       <p>预览流截图通过图形提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#imagecreatepixelmapfromsurface11" target="_blank">image.createPixelMapFromSurface</a>接口实现，surfaceId为当前预览流的surfaceId，size为当前预览流profile的宽高。创建截图工具类(ts文件)，导入依赖，导出获取截图方法供页面使用，截图工具类实现参考：</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlurAnimateUtil</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">surfaceShot</span>: image.<span class="hljs-property">PixelMap</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 获取surface截图。</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">surfaceId</span></span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">doSurfaceShot</span>(<span class="hljs-params">surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`doSurfaceShot surfaceId:<span class="hljs-subst">${surfaceId}</span>.`</span>);</li><li>    <span class="hljs-keyword">if</span> (surfaceId === <span class="hljs-string">''</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'surface not ready!'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span>) {</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span>.<span class="hljs-title function_">release</span>();</li><li>      }</li><li>      <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span> = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMapFromSurface</span>(surfaceId, {</li><li>        <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">1080</span> }, <span class="hljs-comment">// 取预览流profile的宽高。</span></li><li>        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span></li><li>      });</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageInfo</span>: image.<span class="hljs-property">ImageInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span>.<span class="hljs-title function_">getImageInfo</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'doSurfaceShot surfaceShot:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(imageInfo.<span class="hljs-property">size</span>));</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 获取doSurfaceShot得到的截图。</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span></span></li><li><span class="hljs-comment">   */</span></li><li> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getSurfaceShot</span>(): image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span> === <span class="hljs-literal">null</span> || <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span> === <span class="hljs-literal">undefined</span>) {</li><li>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SurfaceShot is null!"</span>);</li><li>       <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>     }</li><li>     <span class="hljs-keyword">return</span> <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-property">surfaceShot</span>;</li><li>  }</li><li>
</li><li>}</li></ol></pre></div></div></li>      <li>       <p>构建截图组件。</p>       <p>此处定义一个截图组件，置于预览流XComponent组件之上，用来遮挡XComponent组件。</p>       <p>属性定义：</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@State</span> <span class="hljs-attr">isShowBlur</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否显示截图组件。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">isShowBlack</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 闪黑组件，无需使用可以删除。</span></li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'modeChange'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onModeChange'</span>) <span class="hljs-attr">modeChangeFlag</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 模式切换动效触发入口。</span></li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'switchCamera'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onSwitchCamera'</span>) <span class="hljs-attr">switchCameraFlag</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;<span class="hljs-comment">// 前后置切换动效触发入口。</span></li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'frameStart'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onFrameStart'</span>) <span class="hljs-attr">frameStartFlag</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 动效消失入口。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">screenshotPixelMap</span>: image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 截图组件PixelMap。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 当前预览流XComponent的surfaceId。</span></li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'curPosition'</span>) <span class="hljs-attr">curPosition</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前镜头前后置状态。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">shotImgBlur</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 截图组件模糊度。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">shotImgOpacity</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 截图组件透明度。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">shotImgScale</span>: <span class="hljs-title class_">ScaleOptions</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> }; <span class="hljs-comment">// 截图组件比例。</span></li><li><span class="hljs-meta">@State</span> <span class="hljs-attr">shotImgRotation</span>: <span class="hljs-title class_">RotateOptions</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">0</span> }; <span class="hljs-comment">// 截图组件旋转角度。</span></li></ol></pre></div></div>       <p>截图组件的实现参考：</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 截图组件，置于预览流XComponent组件之上。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlur</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotPixelMap</span>)</li><li>      .<span class="hljs-title function_">blur</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span>)</li><li>      .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgOpacity</span>)</li><li>      .<span class="hljs-title function_">rotate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span>)<span class="hljs-comment">// ArkUI提供，用于组件旋转。</span></li><li>      .<span class="hljs-title function_">scale</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgScale</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1080</span>)) <span class="hljs-comment">// 与预览流XComponent宽高保持一致，图层在预览流之上。</span></li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1920</span>))</li><li>      .<span class="hljs-title function_">syncLoad</span>(<span class="hljs-literal">true</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1080</span>))</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1920</span>))</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（按实际情况选择）实现模糊出现动效。</p>       <p>模式切换动效分两段实现，模糊出现动效和模糊消失动效。</p>       <p>模糊出现动效：用户点击或触控事件触发预览流截图，显示截图组件，截图清晰到模糊，覆盖旧预览流。</p>       <p>注意：由于图形提供的image.createPixelMapFromSurface接口是截取surface内容获取PixelMap，其内容和XComponent组件绘制逻辑不同，需要根据<strong>前后置</strong>镜头做不同的<strong>图片内容旋转补偿</strong>和<strong>组件旋转补偿</strong>。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">showBlurAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'showBlurAnim E'</span>);</li><li>  <span class="hljs-comment">// 获取已完成的surface截图。</span></li><li>  <span class="hljs-keyword">let</span> shotPixel = <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-title function_">getSurfaceShot</span>();</li><li>  <span class="hljs-keyword">if</span> (shotPixel === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`pixelMap is undefined`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 后置。</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curPosition</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'showBlurAnim BACK'</span>);</li><li>    <span class="hljs-comment">// 直板机后置截图初始内容旋转补偿90°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">//ImageKit提供，用于图片内容旋转。</span></li><li>    <span class="hljs-comment">// 直板机后置截图初始组件旋转补偿0°。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">0</span> };</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'showBlurAnim FRONT'</span>);</li><li>    <span class="hljs-comment">// 直板机前置截图内容旋转补偿270°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">270</span>);</li><li>    <span class="hljs-comment">// 直板机前置截图组件旋转补偿180°。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">180</span> };</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotPixelMap</span> = shotPixel;</li><li>  <span class="hljs-comment">// 初始化动效参数。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 无模糊。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgOpacity</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 不透明。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlur</span> = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 显示截图组件。</span></li><li>  <span class="hljs-title function_">animateToImmediately</span>(</li><li>    {</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Friction</span>,</li><li>      <span class="hljs-attr">onFinish</span>: <span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'showBlurAnim X'</span>);</li><li>      }</li><li>    },</li><li>    <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span> = <span class="hljs-number">48</span>; <span class="hljs-comment">// 截图组件模糊度变化动效。</span></li><li>    }</li><li>  );</li><li>}</li></ol></pre></div></div></li>      <li>       <p>实现模糊消失动效。</p>       <p>模糊消失动效：由新模式预览流首帧回调<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#onframestart" target="_blank">on('frameStart')</a>触发，截图组件模糊到清晰，显示新预览流。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">hideBlurAnim</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlack</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'hideBlurAnim E'</span>);</li><li>  <span class="hljs-title function_">animateToImmediately</span>({</li><li>    <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>    <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">FastOutSlowIn</span>,</li><li>    <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlur</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 模糊组件下树。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span> = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgOpacity</span> = <span class="hljs-number">1</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'hideBlurAnim X'</span>);</li><li>    }</li><li>  }, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// 截图透明度变化动效。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgOpacity</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 截图组件透明度变化动效。</span></li><li>  });</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（按实际情况选择）实现模糊翻转动效。</p>       <p>模糊翻转动效分两段实现，模糊翻转动效和模糊消失动效，其中模糊消失动效同第5步。</p>       <p>模糊翻转动效：分两段组件翻转实现，先向外翻转90°再向内翻转90°，同时还执行了模糊度、透明度、比例缩放等动效。</p>       <p>为保证预览流在翻转时不露出，需要构建一个闪黑组件用于遮挡XComponent组件，构建方式参考<a href="/consumer/cn/doc/harmonyos-guides/camera-animation#闪黑动效">闪黑动效</a>-步骤2。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 先向外翻转90°，前后置切换触发。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">rotateFirstAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateFirstAnim E'</span>);</li><li>  <span class="hljs-comment">// 获取已完成的surface截图。</span></li><li>  <span class="hljs-keyword">let</span> shotPixel = <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-title function_">getSurfaceShot</span>();</li><li>  <span class="hljs-keyword">if</span> (shotPixel === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`pixelMap is undefined`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 后置切前置。</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curPosition</span> === <span class="hljs-number">1</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateFirstAnim BACK'</span>);</li><li>    <span class="hljs-comment">// 直板机后置切前置截图初始内容旋转补偿90°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">//ImageKit提供，用于图片内容旋转。</span></li><li>    <span class="hljs-comment">// 直板机后置切前置截图初始组件旋转补偿0°。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">0</span> };</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateFirstAnim FRONT'</span>);</li><li>    <span class="hljs-comment">// 直板机前置切后置截图初始内容旋转补偿270°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">270</span>);</li><li>    <span class="hljs-comment">// 直板机前置切后置截图初始组件旋转补偿180°。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">180</span> };</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotPixelMap</span> = shotPixel;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlack</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 显示闪黑组件，覆盖预览流保证视觉效果。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBlur</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 显示截图组件。</span></li><li>  <span class="hljs-title function_">animateToImmediately</span>(</li><li>    {</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>      <span class="hljs-attr">delay</span>: <span class="hljs-number">50</span>, <span class="hljs-comment">// 时延保证组件缩放模糊动效先行，再翻转,视觉效果更好。</span></li><li>      <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">cubicBezierCurve</span>(<span class="hljs-number">0.20</span>, <span class="hljs-number">0.00</span>, <span class="hljs-number">0.83</span>, <span class="hljs-number">1.00</span>),</li><li>      <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateFirstAnim X'</span>);</li><li>        <span class="hljs-comment">// 在onFinish后触发二段翻转。</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rotateSecondAnim</span>();</li><li>      }</li><li>    },</li><li>    <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 截图向外翻转动效。</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curPosition</span> === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">90</span> };</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">270</span> };</li><li>      }</li><li>    }</li><li>  )</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 再向内翻转90°。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">rotateSecondAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateSecondAnim E'</span>);</li><li>  <span class="hljs-comment">// 获取已完成的surface截图。</span></li><li>  <span class="hljs-keyword">let</span> shotPixel = <span class="hljs-title class_">BlurAnimateUtil</span>.<span class="hljs-title function_">getSurfaceShot</span>();</li><li>  <span class="hljs-keyword">if</span> (shotPixel === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`pixelMap is undefined`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 后置。</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curPosition</span> === <span class="hljs-number">1</span>) {</li><li>    <span class="hljs-comment">// 直板机后置镜头内容旋转补偿90°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">90</span>);</li><li>    <span class="hljs-comment">// 组件旋转调整为-90°，保证二段翻转后，图片不是镜像的。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">90</span> };</li><li>  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 前置。</span></li><li>    <span class="hljs-comment">// 直板机前置截图内容旋转补偿270°。</span></li><li>    <span class="hljs-keyword">await</span> shotPixel.<span class="hljs-title function_">rotate</span>(<span class="hljs-number">270</span>);</li><li>    <span class="hljs-comment">// 直板机前置截图组件旋转补偿180°。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">180</span> };</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenshotPixelMap</span> = shotPixel;</li><li>  <span class="hljs-title function_">animateToImmediately</span>(</li><li>    {</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>      <span class="hljs-attr">curve</span>: curves.<span class="hljs-title function_">cubicBezierCurve</span>(<span class="hljs-number">0.17</span>, <span class="hljs-number">0.00</span>, <span class="hljs-number">0.20</span>, <span class="hljs-number">1.00</span>),</li><li>      <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'rotateSecondAnim X'</span>);</li><li>      }</li><li>    },</li><li>    <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 截图向内翻转动效，翻转至初始状态。</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curPosition</span> === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">0</span> };</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgRotation</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">angle</span>: <span class="hljs-number">180</span> };</li><li>      }</li><li>    }</li><li>  )</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 向外翻转90°同时。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">blurFirstAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'blurFirstAnim E'</span>);</li><li>  <span class="hljs-comment">// 初始化动效参数。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">//无模糊。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgOpacity</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">//不透明。</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgScale</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };</li><li>  <span class="hljs-title function_">animateToImmediately</span>(</li><li>    {</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span>,</li><li>      <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'blurFirstAnim X'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">blurSecondAnim</span>();</li><li>      }</li><li>    },</li><li>    <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 截图模糊动效。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgBlur</span> = <span class="hljs-number">48</span>;</li><li>      <span class="hljs-comment">// 截图比例缩小动效。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgScale</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">0.75</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0.75</span> };</li><li>    }</li><li>  );</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * 向内翻转90°同时。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">blurSecondAnim</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'blurSecondAnim E'</span>);</li><li>  <span class="hljs-title function_">animateToImmediately</span>(</li><li>    {</li><li>      <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span>,</li><li>      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Sharp</span>,</li><li>      <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'blurSecondAnim X'</span>);</li><li>      }</li><li>    },</li><li>    <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// 截图比例恢复动效。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shotImgScale</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };</li><li>    }</li><li>  )</li><li>}</li></ol></pre></div></div></li>      <li>       <p>按需触发动效。</p>       <p>模式切换动效触发：点击或触控模式按钮立即执行doSurfaceShot截图方法，更新StorageLink绑定modeChange的值，触发onModeChange方法，开始动效。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onModeChange</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onModeChange'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showBlurAnim</span>();</li><li>}</li></ol></pre></div></div>       <p>前后置切换动效触发：点击或触控前后置切换按钮立即执行doSurfaceShot截图方法，更新StorageLink绑定switchCamera的值，触发onSwitchCamera方法，开始动效。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onSwitchCamera</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onSwitchCamera'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">blurFirstAnim</span>();</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rotateFirstAnim</span>();</li><li>}</li></ol></pre></div></div>       <p>模糊消失动效触发：监听预览流首帧回调<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#onframestart" target="_blank">on('frameStart')</a>，更新StorageLink绑定frameStart的值，触发onFrameStart方法，开始动效。</p>       <div _ngcontent-uax-c106="" class="highlight-div"><div _ngcontent-uax-c106="" class="highlight-div-header"><div _ngcontent-uax-c106="" class="highlight-div-header-left"><div _ngcontent-uax-c106="" class="handle-button expand-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uax-c106="" class="highlight-div-header-right"><div _ngcontent-uax-c106="" class="handle-button ai-button"></div><div _ngcontent-uax-c106="" class="handle-button line-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uax-c106="" class="handle-button theme-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uax-c106="" class="handle-button copy-button"><div _ngcontent-uax-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uax-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onFrameStart</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onFrameStart'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hideBlurAnim</span>();</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>