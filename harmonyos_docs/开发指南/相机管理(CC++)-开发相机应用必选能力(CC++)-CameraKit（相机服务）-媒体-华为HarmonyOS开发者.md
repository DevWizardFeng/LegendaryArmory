<h1 _ngcontent-mmg-c119="" class="doc-title ng-star-inserted" title="相机管理 (C/C++)"> 相机管理 (C/C++) </h1>

<div _ngcontent-mmg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发一个相机应用前，需要先通过调用相机接口来创建一个独立的相机设备。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口。选择系统提供的NDK接口能力，导入NDK接口的方法如下。</p>       <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libohcamera.so</li><li>    libhilog_ndk.z.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#oh_camera_getcameramanager" target="_blank">OH_Camera_GetCameraManager()</a>方法，获取cameraManager对象。</p>       <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_ErrorCode <span class="hljs-title">CreateCameraManager</span><span class="hljs-params">(Camera_Manager** cameraManager)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_Camera_GetCameraManager</span>(cameraManager);</li><li>    <span class="hljs-keyword">if</span> (*cameraManager == <span class="hljs-literal">nullptr</span> || ret != CAMERA_OK) {</li><li>       <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_Camera_GetCameraManager failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>如果获取对象失败，说明相机可能被占用或无法使用。如果被占用，须等到相机被释放后才能重新获取。</p>        </div></div></div></li>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_getsupportedcameras" target="_blank">OH_CameraManager_GetSupportedCameras()</a>方法，获取当前设备支持的相机列表，列表中存储了设备支持的所有相机ID。若列表不为空，则说明列表中的每个ID都支持独立创建相机对象；否则，说明当前设备无可用相机，不可继续后续操作。</p>       <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode GetSupportedCameras(Camera_Manager* cameraManager, Camera_Device** cameras, uint32_t &amp;size)</li><li>{</li><li>    <span class="hljs-regexp">//</span> 获取相机列表。</li><li>    Camera_ErrorCode ret = OH_CameraManager_GetSupportedCameras(cameraManager, cameras, &amp;size);</li><li>    <span class="hljs-keyword">if</span> (cameras == nullptr || size == <span class="hljs-number">0</span> || ret != CAMERA_OK) {</li><li>       OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_GetSupportedCameras failed."</span>);</li><li>    }</li><li>    // 在不使用cameras时，需要调用<span class="hljs-keyword">delete</span>[]释放。</li><li>    <span class="hljs-keyword">for</span> (uint32_t <span class="hljs-keyword">index</span> = <span class="hljs-number">0</span>; <span class="hljs-keyword">index</span> &lt; size; <span class="hljs-keyword">index</span>++) {</li><li>       OH_LOG_INFO(LOG_APP, <span class="hljs-string">"cameraId  =  %{public}s "</span>, (*cameras)[<span class="hljs-keyword">index</span>].cameraId);              <span class="hljs-regexp">//</span> 获取相机ID。</li><li>       OH_LOG_INFO(LOG_APP, <span class="hljs-string">"cameraPosition  =  %{public}d "</span>, (*cameras)[<span class="hljs-keyword">index</span>].cameraPosition);  <span class="hljs-regexp">//</span> 获取相机位置。</li><li>       OH_LOG_INFO(LOG_APP, <span class="hljs-string">"cameraType  =  %{public}d "</span>, (*cameras)[<span class="hljs-keyword">index</span>].cameraType);          <span class="hljs-regexp">//</span> 获取相机类型。</li><li>       OH_LOG_INFO(LOG_APP, <span class="hljs-string">"connectionType  =  %{public}d "</span>, (*cameras)[<span class="hljs-keyword">index</span>].connectionType);  <span class="hljs-regexp">//</span> 获取相机连接类型。</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2>          <p>在相机应用开发过程中，可以随时监听相机状态，包括新相机的出现、相机的移除、相机的可用状态。在回调函数中，通过相机ID、相机状态这两个参数进行监听，如当有新相机出现时，可以将新相机加入到应用的备用相机中。</p>     <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_registercallback" target="_blank">OH_CameraManager_RegisterCallback()</a>注册cameraStatus事件，通过回调返回监听结果，callback返回Camera_StatusInfo参数，参数的具体内容可参考相机管理器回调接口实例<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera-camera-statusinfo" target="_blank">Camera_StatusInfo</a>。</p>     <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CameraStatusCallback</span><span class="hljs-params">(Camera_Manager* cameraManager, Camera_StatusInfo* status)</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"CameraStatusCallback is called"</span>);</li><li>}</li><li><span class="hljs-function">CameraManager_Callbacks* <span class="hljs-title">GetCameraManagerListener</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>   <span class="hljs-type">static</span> CameraManager_Callbacks cameraManagerListener = {</li><li>      .onCameraStatus = CameraStatusCallback</li><li>   };</li><li>   <span class="hljs-keyword">return</span> &amp;cameraManagerListener;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-mmg-c106="" class="highlight-div"><div _ngcontent-mmg-c106="" class="highlight-div-header"><div _ngcontent-mmg-c106="" class="highlight-div-header-left"><div _ngcontent-mmg-c106="" class="handle-button expand-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mmg-c106="" class="highlight-div-header-right"><div _ngcontent-mmg-c106="" class="handle-button ai-button"></div><div _ngcontent-mmg-c106="" class="handle-button line-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mmg-c106="" class="handle-button theme-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mmg-c106="" class="handle-button copy-button"><div _ngcontent-mmg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mmg-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">RegisterCameraStatusCallback</span><span class="hljs-params">(Camera_Manager &amp;cameraManager)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CameraManager_RegisterCallback(&amp;cameraManager, GetCameraManagerListener());</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>       OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CameraManager_RegisterCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>