<h1 _ngcontent-mqb-c119="" class="doc-title ng-star-inserted" title="知识问答"> 知识问答 </h1>

<div _ngcontent-mqb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1038618146207">约束限制<i class="anchor-icon anchor-icon-link" anchorid="section1038618146207" tips="复制节点链接"></i></h2>          <ol>      <li>知识问答需要先对数据源库进行知识加工生成知识库，否则无法问答。</li>      <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section14201103320529" target="_blank">createRagSession</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section178721756950" target="_blank">streamRun</a>不支持多线程调用。</li>      <li>提问长度限制在1000个字符内（UTF-8下一个汉字占3个字符）。</li>      <li>用户问答时，RAG可使用的历史记录范围为最近1次问答内容。</li>      <li>RAG在检索召回时最多返回600个chunk。</li>      <li>RAG不提供敏感词风控检测能力，开发者需要自行对用户输入内容和RAG返回内容进行敏感词风控检测。</li>      <li>开发者选择的LLM支持的上下文长度至少应该为30k Tokens，如Qwen2.5-7B-32K、Mistral-7B-Instruct-v0.2、Llama-3.1-8B等。否则可能会因大模型上下文长度超限而导致知识问答失败。</li>      <li>LLM由开发者自行选择，问答支持的语言受选择的LLM影响。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1274163417495">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1274163417495" tips="复制节点链接"></i></h2>          <p>知识问答关键接口如下表所示，具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api" target="_blank">API参考</a>。</p>    </div>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.1" valign="top" width="58.03%">         <p>接口名</p></th>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.2" valign="top" width="41.97%">         <p>描述</p></th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="58.03%">         <p>abstract <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section157381918121212" target="_blank">streamChat</a>(query: string, callback: Callback&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section178144421252" target="_blank">LLMStreamAnswer</a>&gt;): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1816505018227" target="_blank">LLMRequestInfo</a>&gt;</p></td>        <td class="cellrowborder" valign="top" width="41.97%">         <p>继承ChatLLM类实现大模型客户端时需要实现的函数。RAG在检索前的问题预处理、检索后的回答生成时，会调用这个函数与大语言模型交互。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="58.03%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section14201103320529" target="_blank">createRagSession</a>(context: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-context" target="_blank">common.Context</a>, config: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1033315317182" target="_blank">Config</a>): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1312212528516" target="_blank">RagSession</a>&gt;</p></td>        <td class="cellrowborder" valign="top" width="41.97%">         <p>获得一个会话用于进行知识问答。</p></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="58.03%">         <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section178721756950" target="_blank">streamRun</a>(question: string, config: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section126313912116" target="_blank">RunConfig</a>, callback: AsyncCallback&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section158611717585" target="_blank">Stream</a>&gt;): Promise&lt;number&gt;</p></td>        <td class="cellrowborder" valign="top" width="41.97%">         <p>知识问答接口，传入问题以及问答配置项。当RAG生成问题结果时，触发callback回调函数来流式传递数据。</p></td>       </tr>           </tbody></table></div>    </div>    <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">      <p>上述接口需在页面或自定义组件生命周期内调用。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="section84162596597">开发准备<i class="anchor-icon anchor-icon-link" anchorid="section84162596597" tips="复制节点链接"></i></h2>          <ol>      <li>申请网络权限。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section157381918121212" target="_blank">streamChat</a>中需要开发者实现与LLM交互的功能，因此需要为应用申请网络权限。       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>// <span class="hljs-built_in">module</span>.json5中配置<span class="hljs-string">"requestPermissions"</span>字段</li><li>// src/main/<span class="hljs-built_in">module</span>.json5</li><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>  }</li><li>],</li></ol></pre></div></div></li>      <li>完成知识加工配置。请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-knowledge-processing">知识加工</a>。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section5780183911195">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5780183911195" tips="复制节点链接"></i></h2>          <p>下面仅对关键步骤关键代码进行说明，详细开发案例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-rag-demo">示例代码</a>。应用的一次流式问答过程，和RagSession、ChatLLM、知识库的交互流程，可参考<a href="/consumer/cn/doc/harmonyos-guides/data-augmentation-rag-development#section1350294615400">流式问答调用流程图</a>。</p>     <ol>      <li><span>kit导入。本模块主要依赖如下，其余依赖需要开发者按需添加。</span>       <p></p>       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>创建http工具类，用以和大模型交互，用户也可选择webSocket（可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/network-api-arkts" target="_blank">Network Kit</a>）或者其他方式与大模型交互。本示例选用了<a href="https://console.huaweicloud.com/modelarts" target="_blank">ModelArts平台</a>的qwen3-235b-a22b模型作为示例，开发者使用时需根据实际情况选择合适大模型。示例代码包括如下三个环节：</span>       <p></p>       <ul>        <li>拼装和大模型交互的请求报文，推荐为流式交互，以获得更好用户体验。</li>        <li>注册大模型的数据接收及输出结束的回调函数，以达到流式访问大模型的效果。</li>        <li>初始化大模型以及向大模型发送请求。</li>       </ul>       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">http</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span> = <span class="hljs-string">'HttpUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpUtils</span> {</li><li>  <span class="hljs-variable">httpRequest</span>?: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">HttpRequest</span>;</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'https://api.modelarts-maas.com/v1/chat/completions'</span>; <span class="hljs-comment">// 开发者需要根据选择的大模型对应修改url以及下面的model</span></li><li>  <span class="hljs-variable">isFinished</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">initOption</span>(<span class="hljs-variable">question</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">option</span>: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">HttpRequestOptions</span> = {</li><li>      <span class="hljs-comment">// 请求方式</span></li><li>      <span class="hljs-variable">method</span>: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">RequestMethod</span>.<span class="hljs-title class_">POST</span>,</li><li>      <span class="hljs-comment">// 请求头</span></li><li>      <span class="hljs-variable">header</span>: {</li><li>        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,</li><li>        <span class="hljs-comment">// API-KEY from Model</span></li><li>        <span class="hljs-string">'Authorization'</span>: `<span class="hljs-title class_">Bearer</span> ****<span class="hljs-title class_">replace</span> <span class="hljs-title class_">your</span> <span class="hljs-title class_">API</span> <span class="hljs-title class_">key</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">here</span>****`</li><li>      },</li><li>      <span class="hljs-comment">// 请求体</span></li><li>      <span class="hljs-variable">extraData</span>: {</li><li>        <span class="hljs-string">'stream'</span>: <span class="hljs-keyword">true</span>,</li><li>        <span class="hljs-string">'temperature'</span>: <span class="hljs-number">0.1</span>,</li><li>        <span class="hljs-string">'max_tokens'</span>: <span class="hljs-number">1000</span>,</li><li>        <span class="hljs-string">'frequency_penalty'</span>: <span class="hljs-number">1</span>,</li><li>        <span class="hljs-string">'model'</span>: <span class="hljs-string">'qwen3-235b-a22b'</span>,</li><li>        <span class="hljs-string">'top_p'</span>: <span class="hljs-number">0.1</span>,</li><li>        <span class="hljs-string">'presence_penalty'</span>: -<span class="hljs-number">1</span>,</li><li>        <span class="hljs-string">'messages'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title class_">parse</span>(<span class="hljs-title class_">question</span>),</li><li>        <span class="hljs-string">"chat_template_kwargs"</span>: {</li><li>          <span class="hljs-comment">// 关闭思考中数据</span></li><li>          <span class="hljs-string">"enable_thinking"</span>: <span class="hljs-keyword">false</span></li><li>        }</li><li>      }</li><li>    };</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">option</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">requestInStream</span>(<span class="hljs-variable">question</span>: <span class="hljs-title class_">string</span>) { <span class="hljs-comment">// 拼装流式请求的option并发起流式请求</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span> = <span class="hljs-variable">http</span>.<span class="hljs-title function_">createHttp</span>();</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span>?.<span class="hljs-title function_">requestInStream</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">url</span>, <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initOption</span>(<span class="hljs-variable">question</span>)).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'Failed to request. Cause: %{public}s'</span>, <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>));</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">isFinished</span> = <span class="hljs-keyword">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">on</span>(<span class="hljs-variable">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt;) { <span class="hljs-comment">// 注册数据接受、数据结束的监听</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span> = <span class="hljs-variable">http</span>.<span class="hljs-title function_">createHttp</span>();</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">httpRequest</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataReceive'</span>, <span class="hljs-variable">callback</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-variable">new</span> <span class="hljs-variable">HttpUtils</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>继承实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1400115191116" target="_blank">ChatLLM</a>类，在此函数中与大模型进行交互，并将大模型返回结果通过callback函数返回给RagSession。</span>       <p></p>       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSON</span>, util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">HttpUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HttpUtils'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">"MyChatLLM"</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyChatLLM</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rag.ChatLLM</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">streamChat</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;rag.<span class="hljs-property">LLMStreamAnswer</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;rag.<span class="hljs-property">LLMRequestInfo</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">ret</span>: rag.<span class="hljs-property">LLMRequestStatus</span> = rag.<span class="hljs-property">LLMRequestStatus</span>.<span class="hljs-property">LLM_SUCCESS</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-title function_">dataCallback</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt; { <span class="hljs-comment">// 收到数据时的回调函数，解析数据并组装LLMStreamAnswer，通过callback回调</span></li><li>        hilog.<span class="hljs-title function_">debug</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'on callback enter. data length: %{public}d'</span>, data.<span class="hljs-property">byteLength</span>);</li><li>        <span class="hljs-comment">// 解析大模型返回报文，逻辑因选择模型而异，此处省略具体解析代码，示例参见完整示例代码</span></li><li>        <span class="hljs-keyword">const</span> answer = <span class="hljs-title function_">parseLLMResponse</span>(data);</li><li>        <span class="hljs-keyword">if</span> (!answer) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-property">isFinished</span> = answer.<span class="hljs-property">isFinished</span>;</li><li>        <span class="hljs-title function_">callback</span>(answer);</li><li>        hilog.<span class="hljs-title function_">debug</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLLM'</span>, <span class="hljs-string">'Request LLM success. isFinished: %{public}s, data: %{public}s'</span>,</li><li>          <span class="hljs-title class_">Number</span>(answer.<span class="hljs-property">isFinished</span>).<span class="hljs-title function_">toString</span>(), answer.<span class="hljs-property">chunk</span>);</li><li>      };</li><li>
</li><li>      <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">on</span>(dataCallback);</li><li>      <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">requestInStream</span>(query);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Request LLM failed, error code: <span class="hljs-subst">${err.code}</span>, error message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      ret = rag.<span class="hljs-property">LLMRequestStatus</span>.<span class="hljs-property">LLM_REQUEST_ERROR</span>; <span class="hljs-comment">// 开发者可判断错误码从而返回其他LLM错误码</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-attr">chatId</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">status</span>: ret,</li><li>    };</li><li>  }</li><li>  <span class="hljs-title function_">cancel</span>(<span class="hljs-attr">chatId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`The request for the large model has been canceled. chatId: <span class="hljs-subst">${chatId}</span>`</span>);</li><li>    <span class="hljs-title class_">HttpUtils</span>.<span class="hljs-title function_">cancel</span>();</li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1033315317182" target="_blank">Config</a>配置中的属性。下面简要介绍几个主要参数，全量配置字段的含义见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/dataaugmentation-retrieval">智慧化数据检索</a>中的说明。</span>       <p></p>       <ul>        <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-retrieval-api#section95236010016" target="_blank">RetrievalConfig</a>主要配置知识库的数据库配置。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-knowledge-processing#section13189205451011">知识加工</a>将会生成向量及倒排两种知识库表。         <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">common</span>, <span class="hljs-variable">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">rag</span>, <span class="hljs-variable">retrieval</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">relationalStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">storeConfigVector</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span> = {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-string">'testmail_store_vector.db'</span>, <span class="hljs-comment">// 知识加工后向量数据库文件名，在原数据库名基础上加_vector后缀</span></li><li>  <span class="hljs-variable">securityLevel</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">SecurityLevel</span>.<span class="hljs-title class_">S3</span>,</li><li>  <span class="hljs-variable">vector</span>: <span class="hljs-keyword">true</span>  <span class="hljs-comment">// 向量数据库应设置该项为true</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">storeConfigInvIdx</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span> = {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-string">'testmail_store.db'</span>, <span class="hljs-comment">// 知识加工后，倒排数据库即原数据库</span></li><li>  <span class="hljs-variable">securityLevel</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">SecurityLevel</span>.<span class="hljs-title class_">S3</span>,</li><li>  <span class="hljs-variable">tokenizer</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">Tokenizer</span>.<span class="hljs-title class_">CUSTOM_TOKENIZER</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">context</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-variable">get</span>&lt;<span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>&gt;(<span class="hljs-string">'Context'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">channelConfigVector</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelConfig</span> = {</li><li>  <span class="hljs-variable">channelType</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelType</span>.<span class="hljs-title class_">VECTOR_DATABASE</span>,</li><li>  <span class="hljs-variable">context</span>: <span class="hljs-title class_">context</span>,</li><li>  <span class="hljs-variable">dbConfig</span>: <span class="hljs-title class_">storeConfigVector</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">channelConfigInvIdx</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelConfig</span> = {</li><li>  <span class="hljs-variable">channelType</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelType</span>.<span class="hljs-title class_">INVERTED_INDEX_DATABASE</span>,</li><li>  <span class="hljs-variable">context</span>: <span class="hljs-title class_">context</span>,</li><li>  <span class="hljs-variable">dbConfig</span>: <span class="hljs-title class_">storeConfigInvIdx</span></li><li>};</li><li><span class="hljs-comment">// 最终创建成功的RetrievalConfig数据</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">retrievalConfig</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalConfig</span> = {</li><li>  <span class="hljs-variable">channelConfigs</span>: [<span class="hljs-variable">channelConfigInvIdx</span>, <span class="hljs-variable">channelConfigVector</span>]</li><li>};</li></ol></pre></div></div></li>        <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-retrieval-api#section4881955192413" target="_blank">RetrievalCondition</a>主要配置检索条件及多路召回之后的排序配置。其中fromClause为查询目标索引名，可按照如下示例代码配置为业务数据库表及知识加工产生的数据库表联合形成的虚拟表；responseColumns为召回的字段集合，范围为fromClause配置的数据库表中的列。关于知识库的数据库表结构可参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-knowledge-processing#table1186182016388">表1</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-augmentation-knowledge-processing#table57920393405">表2</a>。         <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { retrieval } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">recallConditionInvIdx</span>: retrieval.<span class="hljs-property">InvertedIndexRecallCondition</span> = {</li><li>  <span class="hljs-attr">ftsTableName</span>: <span class="hljs-string">'email_inverted'</span>,</li><li>  <span class="hljs-comment">// 使用id（原始数据库表主键，配置在知识加工schema中）和reference_id（知识库表中的字段）关联原始数据库表及知识库的表，增加检索及召回数据范围</span></li><li>  <span class="hljs-attr">fromClause</span>: <span class="hljs-string">'select email_inverted.reference_id as rowid, * from email INNER JOIN email_inverted ON email.id = email_inverted.reference_id'</span>,</li><li>  <span class="hljs-attr">primaryKey</span>: [<span class="hljs-string">'chunk_id'</span>],</li><li>  <span class="hljs-comment">// 配置范围为fromClause配置的数据库表中的列，超出范围会导致检索失败。</span></li><li>  <span class="hljs-attr">responseColumns</span>: [<span class="hljs-string">'reference_id'</span>, <span class="hljs-string">'chunk_id'</span>, <span class="hljs-string">'chunk_source'</span>, <span class="hljs-string">'chunk_text'</span>, <span class="hljs-string">'subject'</span>, <span class="hljs-string">'image_text'</span>,</li><li>    <span class="hljs-string">'attachment_names'</span>],</li><li>  <span class="hljs-attr">deepSize</span>: <span class="hljs-number">500</span>,</li><li>  <span class="hljs-attr">recallName</span>: <span class="hljs-string">'invertedvectorRecall'</span>,</li><li>};</li><li><span class="hljs-keyword">let</span> floatArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-number">128</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0.1</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">vectorQuery</span>: retrieval.<span class="hljs-property">VectorQuery</span> = {</li><li>  <span class="hljs-attr">column</span>: <span class="hljs-string">'repr'</span>,</li><li>  <span class="hljs-attr">value</span>: floatArray,</li><li>  <span class="hljs-attr">similarityThreshold</span>: <span class="hljs-number">0.1</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">recallConditionVector</span>: retrieval.<span class="hljs-property">VectorRecallCondition</span> = {</li><li>  <span class="hljs-attr">vectorQuery</span>: vectorQuery,</li><li>  <span class="hljs-comment">// 只配置知识库的向量表作为查询目标</span></li><li>  <span class="hljs-attr">fromClause</span>: <span class="hljs-string">'email_vector'</span>,</li><li>  <span class="hljs-attr">primaryKey</span>: [<span class="hljs-string">'id'</span>],</li><li>  <span class="hljs-comment">// 配置知识库的向量表中的列作为召回列</span></li><li>  <span class="hljs-attr">responseColumns</span>: [<span class="hljs-string">'reference_id'</span>, <span class="hljs-string">'chunk_id'</span>, <span class="hljs-string">'chunk_source'</span>, <span class="hljs-string">'repr'</span>],</li><li>  <span class="hljs-attr">recallName</span>: <span class="hljs-string">'vectorRecall'</span>,</li><li>  <span class="hljs-attr">deepSize</span>: <span class="hljs-number">500</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">rerankMethod</span>: retrieval.<span class="hljs-property">RerankMethod</span> = {</li><li>  <span class="hljs-attr">rerankType</span>: retrieval.<span class="hljs-property">RerankType</span>.<span class="hljs-property">RRF</span>,</li><li>  <span class="hljs-attr">isSoftmaxNormalized</span>: <span class="hljs-literal">true</span>,</li><li>};</li><li><span class="hljs-comment">// 最终创建成功的RetrievalCondition数据</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">retrievalCondition</span>: retrieval.<span class="hljs-property">RetrievalCondition</span> = {</li><li>  <span class="hljs-attr">rerankMethod</span>: rerankMethod,</li><li>  <span class="hljs-attr">recallConditions</span>: [recallConditionInvIdx, recallConditionVector],</li><li>  <span class="hljs-attr">resultCount</span>: <span class="hljs-number">5</span></li><li>};</li></ol></pre></div></div></li>        <li>完成Config数据的构造。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1400115191116" target="_blank">ChatLLM</a>参数则使用步骤3继承实现的ChatLLM的自定义的类的实例。         <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.DataAugmentationKit"</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: rag.<span class="hljs-property">Config</span> = {</li><li>  <span class="hljs-attr">llm</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyChatLlm</span>(), <span class="hljs-comment">// 来源参考步骤3示例代码</span></li><li>  <span class="hljs-attr">retrievalConfig</span>: retrievalConfig, <span class="hljs-comment">// 来源参考当前步骤RetrievalConfig代码示例</span></li><li>  <span class="hljs-attr">retrievalCondition</span>: retrievalCondition  <span class="hljs-comment">// 来源参考当前步骤RetrievalCondition代码示例</span></li><li>}</li></ol></pre></div></div></li>       </ul>       <p></p></li>      <li><span>创建RagSession。</span>       <p></p>       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建RagSession并存入APP上下文中</span></li><li>rag.<span class="hljs-title function_">createRagSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {  <span class="hljs-comment">// config来源参考步骤4代码示例</span></li><li>  <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;rag.<span class="hljs-property">RagSession</span>&gt;(<span class="hljs-string">'RagSessionObject'</span>, data);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`createRagSession failed, code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>});</li></ol></pre></div></div>       <p></p></li>      <li><span>使用步骤5创建的RagSession的streamRun()函数进行问答。</span>       <p></p>       <ul>        <li>answerTypes属性用来指定流式输出的数据类型（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section172106569558" target="_blank">StreamType</a>），当前示例代码配置了三种数据类型，所以最终streamRun()函数的callback回调函数将会输出这三种类型的数据。</li>        <li>streamRun()函数以增量流式的方式输出数据，所以需要开发者自行对结果进行拼接。</li>       </ul>       <div _ngcontent-mqb-c106="" class="highlight-div"><div _ngcontent-mqb-c106="" class="highlight-div-header"><div _ngcontent-mqb-c106="" class="highlight-div-header-left"><div _ngcontent-mqb-c106="" class="handle-button expand-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqb-c106="" class="highlight-div-header-right"><div _ngcontent-mqb-c106="" class="handle-button ai-button"></div><div _ngcontent-mqb-c106="" class="handle-button line-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqb-c106="" class="handle-button theme-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqb-c106="" class="handle-button copy-button"><div _ngcontent-mqb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqb-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { rag } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DataAugmentationKit'</span>;</li><li><span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;</li><li>
</li><li><span class="hljs-comment">// 获取创建的RagSession</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: rag.<span class="hljs-property">RagSession</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;rag.<span class="hljs-property">RagSession</span>&gt;(<span class="hljs-string">'RagSessionObject'</span>) <span class="hljs-keyword">as</span> rag.<span class="hljs-property">RagSession</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: rag.<span class="hljs-property">RunConfig</span> = {</li><li>  <span class="hljs-comment">// 指定流式输出的输出类型</span></li><li>  <span class="hljs-attr">answerTypes</span>: [rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">THOUGHT</span>, rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">ANSWER</span>]</li><li>};</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">thoughtStr</span> = <span class="hljs-string">''</span>;</li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">''</span>;</li><li><span class="hljs-comment">// 发起提问</span></li><li>session.<span class="hljs-title function_">streamRun</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">inputStr</span>, config, (<span class="hljs-function">(<span class="hljs-params">err: BusinessError, stream: rag.Stream</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// 接收答案的callback回调，处理答案信息</span></li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">`streamRun inner failed. code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 根据不同的数据类型，选择不同的处理方式</span></li><li>    <span class="hljs-keyword">switch</span> (stream.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">THOUGHT</span>:</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">thoughtStr</span> += stream.<span class="hljs-property">answer</span>.<span class="hljs-property">chunk</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">ANSWER</span>:</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> += stream.<span class="hljs-property">answer</span>.<span class="hljs-property">chunk</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> rag.<span class="hljs-property">StreamType</span>.<span class="hljs-property">REFERENCE</span>:</li><li>      <span class="hljs-attr">default</span>:</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">`streamRun msg: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(stream)}</span>`</span>);</li><li>    }</li><li>  }</li><li>})).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">answerStr</span> = <span class="hljs-string">`streamRun failed. code is <span class="hljs-subst">${e.code}</span>, message is <span class="hljs-subst">${e.message}</span>`</span>;</li><li>});</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1350294615400">流式问答调用流程图<i class="anchor-icon anchor-icon-link" anchorid="section1350294615400" tips="复制节点链接"></i></h2>          <p><span><img originheight="1124" originwidth="815" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114731.10481206262333978709883740632749:50001231000000:2800:A8F9929D485FDCD9BB3FC85BB2789E77118A1332314F7DE9B908462991D62FA6.png" width="815" height="1124"></span></p>    </div>   </div>   <div></div></div>