<h1 _ngcontent-ifd-c119="" class="doc-title ng-star-inserted" title="矩阵编程算子实现"> 矩阵编程算子实现 </h1>

<div _ngcontent-ifd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section2355mcpsimp">实现流程<i class="anchor-icon anchor-icon-link" anchorid="section2355mcpsimp" tips="复制节点链接"></i></h2><p>上文介绍了Matmul矩阵乘的数据切分方案和数据流。AscendC提供一组Matmul高阶API，封装了这些常用的切分和数据搬运、计算的算法逻辑，方便开发者快速实现Matmul矩阵乘法的运算操作。开发者在host侧通过调用API自动获取Tiling参数，该参数传递到kernel侧后，在初始化操作时传入，通过几个简单的API即可完成矩阵乘操作。以下代码仅包含Matmul的关键步骤，不能直接运行。</p> <p class="msonormal"><span><img height="277.97" originheight="437" originwidth="842" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114304.73079844671030326475108991036109:50001231000000:2800:40013D50B4E7A880DE5B76D1E8414445592F6F6650B2FA4846749106614A1BE0.png" title="点击放大" width="526.6800000000001"></span></p> <p><strong>host侧自动获取Tiling参数的关键步骤介绍如下。</strong></p> <ol><li><span>创建Tiling对象。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> ascendcPlatform = platform_ascendc::<span class="hljs-built_in">PlatformAscendC</span>(context-&gt;<span class="hljs-built_in">GetPlatformInfo</span>()); </li><li><span class="hljs-function">matmul_tiling::MatmulApiTiling <span class="hljs-title">cubeTiling</span><span class="hljs-params">(ascendcPlatform)</span></span>; </li></ol></pre></div></div> <p>创建对象时需要传入硬件平台信息，硬件平台信息可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-getplatforminfo">GetPlatformInfo</a>获取。</p> <p></p></li><li><span>设置A、B、Bias的数据类型和格式。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>cubeTiling.<span class="hljs-built_in">SetAType</span>(AscendC::TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16); </li><li>cubeTiling.<span class="hljs-built_in">SetBType</span>(AscendC::TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT16); </li><li>cubeTiling.<span class="hljs-built_in">SetCType</span>(AscendC::TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT); </li><li>cubeTiling.<span class="hljs-built_in">SetBiasType</span>(AscendC::TPosition::GM, CubeFormat::ND, matmul_tiling::DataType::DT_FLOAT);</li></ol></pre></div></div> <p></p></li><li><span>设置矩阵shape信息。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>cubeTiling.<span class="hljs-built_in">SetShape</span>(M, N, K); </li><li>cubeTiling.<span class="hljs-built_in">SetOrgShape</span>(M, N, K);</li></ol></pre></div></div> <p></p></li><li><span>设置可用空间大小信息。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>cubeTiling.<span class="hljs-built_in">SetBufferSpace</span>(<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>);</li></ol></pre></div></div> <p></p></li><li><span>按需设置其他参数，比如设置bias参与计算。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>cubeTiling.<span class="hljs-built_in">SetBias</span>(<span class="hljs-literal">true</span>);</li></ol></pre></div></div> <p></p></li><li><span>获取Tiling参数。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>MatmulCustomTilingData tiling; </li><li><span class="hljs-keyword">if</span> (cubeTiling.GetTiling(tiling.cubeTilingData) == -<span class="hljs-number">1</span>){  </li><li>    <span class="hljs-keyword">return</span> ge::GRAPH_FAILED;   </li><li>}</li></ol></pre></div></div> <p></p></li><li><span>Tiling参数的序列化保存等其他操作。</span></li></ol> <p><strong>kernel侧使用Matmul API矩阵乘运算的具体步骤如下。</strong></p> <ol><li><span>创建Matmul对象。示例如下。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib/matmul_intf.h"</span> </span></li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; aType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; bType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; cType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; biasType;  </li><li>matmul::Matmul&lt;aType, bType, cType, biasType&gt; mm; </li></ol></pre></div></div> <p>创建对象时需要传入A、B、C、Bias的参数类型信息， 类型信息通过MatmulType来定义，包括：内存逻辑位置、数据格式、数据类型。</p> <p></p></li><li><span>初始化操作。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">Init</span>(&amp;tiling.cubeTilingData, &amp;pipe); <span class="hljs-comment">// 初始化</span></li></ol></pre></div></div> <p></p></li><li><span>设置左矩阵A、右矩阵B、Bias。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">SetTensorA</span>(gm_a);    <span class="hljs-comment">// 设置左矩阵A </span></li><li>mm.<span class="hljs-built_in">SetTensorB</span>(gm_b);    <span class="hljs-comment">// 设置右矩阵B </span></li><li>mm.<span class="hljs-built_in">SetBias</span>(gm_bias);    <span class="hljs-comment">// 设置Bias</span></li></ol></pre></div></div> <p></p></li><li><span>完成矩阵乘操作。</span><p></p><ul><li>调用Iterate完成单次迭代计算，叠加while循环完成单核全量数据的计算。Iterate方式，可以自行控制迭代次数，完成所需数据量的计算，方式比较灵活。<div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">while</span> (mm.<span class="hljs-built_in">Iterate</span>()) {    </li><li>     mm.<span class="hljs-built_in">GetTensorC</span>(gm_c);  </li><li> }</li></ol></pre></div></div> </li><li>调用IterateAll完成单核上所有数据的计算。IterateAll方式，无需循环迭代，使用比较简单。<div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">IterateAll</span>(gm_c);</li></ol></pre></div></div> </li></ul> <p></p></li><li><span>结束矩阵乘操作。</span><p></p><div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>mm.<span class="hljs-built_in">End</span>();</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section2435mcpsimp">设置format格式<i class="anchor-icon anchor-icon-link" anchorid="section2435mcpsimp" tips="复制节点链接"></i></h2><p>创建Matmul对象时需要传入A、B、C、Bias的参数类型信息， 类型信息通过MatmulType来定义，包括：内存逻辑位置、数据格式、数据类型。示例如下。</p> <div _ngcontent-ifd-c106="" class="highlight-div"><div _ngcontent-ifd-c106="" class="highlight-div-header"><div _ngcontent-ifd-c106="" class="highlight-div-header-left"><div _ngcontent-ifd-c106="" class="handle-button expand-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ifd-c106="" class="highlight-div-header-right"><div _ngcontent-ifd-c106="" class="handle-button ai-button"></div><div _ngcontent-ifd-c106="" class="handle-button line-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ifd-c106="" class="handle-button theme-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ifd-c106="" class="handle-button copy-button"><div _ngcontent-ifd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ifd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; aType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, half&gt; bType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; cType;  </li><li><span class="hljs-keyword">typedef</span> matmul::MatmulType&lt;AscendC::TPosition::GM, CubeFormat::ND, <span class="hljs-type">float</span>&gt; biasType;  </li><li>matmul::Matmul&lt;aType, bType, cType, biasType&gt; mm; </li></ol></pre></div></div> <p>针对数据格式，包括CubeFormat::ND, CubeFormat::NZ, CubeFormat::ND_ALIGN三种，ND和NZ格式在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-basic-knowledge#section2313mcpsimp">数据格式</a>章节已经介绍。</p> <p>ND_ALIGN用于配置输出矩阵时按照一定的补齐规则进行输出。ND–&gt;ND_ALIGN变换过程下图所示，矩阵数据类型为uint32_t，假设输出矩阵输出到UB，原矩阵N方向没有32字节对齐，设置ND_ALIGN则在其后补0，将其对齐到32字节。</p> <p class="msonormal"><span><img height="353.78000000000003" originheight="610" originwidth="902" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114304.48348389447424780592661477496579:50001231000000:2800:48E136F7E8D70F5C838B1945D145E194710CF58DF3A0DF3EAB477852447BCAF5.png" title="点击放大" width="526.6800000000001"></span></p> </div> <div class="tiledSection"><h2 id="section2443mcpsimp">设置Shape信息<i class="anchor-icon anchor-icon-link" anchorid="section2443mcpsimp" tips="复制节点链接"></i></h2><p>Host Tiling时可以设置Shape信息，用于Tiling计算；kernel侧运行时也可以修改部分shape信息，用于尾块设置、Matmul复用（多个Matmul计算复用一个Matmul对象）等场景。本节对涉及到的Shape概念进行介绍，并给出host侧和kernel侧设置Tiling信息的指导。</p> <ul><li>orgShape：M、N、K</li><li>singleCoreShape：singleCoreM、singleCoreN、singleCoreK</li><li>singleShape：singleM、singleN、singleK</li><li>baseShape：baseM、baseN、baseK</li></ul> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-basic-knowledge#section2326mcpsimp">数据分块(Tiling)</a>的介绍我们已经了解了orgShape(M、N、K)，singleCoreShape(singleCoreM、singleCoreN、singleCoreK)，baseShape(baseM、baseN、baseK)的概念，如下图所示：</p> <p class="msonormal"><span><img height="199.5" originheight="406" originwidth="1062" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114304.51806309375970417505762100886164:50001231000000:2800:5666971BA26368BA71625D00BA768139D270E0877B7D2BA777D36078DDA539CA.png" title="点击放大" width="526.6800000000001"></span></p> <p>除此之外，单核的Matmul Tiling时，实际参与Matmul计算的shape可以是原始shape中的一部分，singleM, singleN, singleK用于表达实际参与Matmul计算的shape，如下图所示。在单核的情况下，singleM, singleN, singleK会透传给singleCoreM, singleCoreN, singleCoreK。</p> <p class="msonormal"><span><img height="373.73" originheight="611" originwidth="719" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114304.50435288830833319092370526960093:50001231000000:2800:582FA98FFC8F5BC3C65764C138F28A29B13F244A737B2E8ED1883D27ED214FE6.png" title="点击放大" width="440.23"></span></p> </div> </div> <div></div></div>