<h1 _ngcontent-tus-c119="" class="doc-title ng-star-inserted" title="简介"> 简介 </h1>

<div _ngcontent-tus-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section27280mcpsimp">模板参数<i class="anchor-icon anchor-icon-link" anchorid="section27280mcpsimp" tips="复制节点链接"></i></h2><div _ngcontent-tus-c106="" class="highlight-div"><div _ngcontent-tus-c106="" class="highlight-div-header"><div _ngcontent-tus-c106="" class="highlight-div-header-left"><div _ngcontent-tus-c106="" class="handle-button expand-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tus-c106="" class="highlight-div-header-right"><div _ngcontent-tus-c106="" class="handle-button ai-button"></div><div _ngcontent-tus-c106="" class="handle-button line-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tus-c106="" class="handle-button theme-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tus-c106="" class="handle-button copy-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tus-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;TPosition pos, <span class="hljs-type">int32_t</span> depth, <span class="hljs-keyword">auto</span> mask = <span class="hljs-number">0</span>&gt; <span class="hljs-keyword">class</span> TQue{...};</li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>TQue模板参数介绍</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.2.3.1.1" valign="top" width="14.000000000000002%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.2.3.1.2" valign="top" width="86%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>pos</p> </td> <td class="cellrowborder" valign="top" width="86%"><p>队列逻辑位置，可以为VECIN、VECOUT、A1、A2、B1、B2、CO1、CO2。关于TPosition的具体介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-tposition">TPosition</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>depth</p> </td> <td class="cellrowborder" valign="top" width="86%"><p>队列的深度表示该队列可以连续进行入队/出队的次数，在代码运行时，对同一个队列有n次连续的EnQue（中间没有DeQue），那么该队列的深度就需要设置为n。</p> <p>注意，这里的队列深度和double buffer无关，队列机制用于实现流水线并行，double buffer在此基础上进一步提高流水线的利用率。即使队列的深度为1，仍可以开启double buffer。</p> <p>队列的深度设置为1时，编译器对这种场景做了特殊优化，性能通常更好，<strong>推荐设置为1</strong>。</p> <ul><li>如下样例中队列没有连续入队，队列的深度设置为1。<div _ngcontent-tus-c106="" class="highlight-div"><div _ngcontent-tus-c106="" class="highlight-div-header"><div _ngcontent-tus-c106="" class="highlight-div-header-left"><div _ngcontent-tus-c106="" class="handle-button expand-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tus-c106="" class="highlight-div-header-right"><div _ngcontent-tus-c106="" class="handle-button ai-button"></div><div _ngcontent-tus-c106="" class="handle-button line-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tus-c106="" class="handle-button theme-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tus-c106="" class="handle-button copy-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tus-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>a1 = que.<span class="hljs-built_in">AllocTensor</span>();  </li><li>que.<span class="hljs-built_in">EnQue</span>(a1); </li><li>a1 = que.<span class="hljs-built_in">DeQue</span>(); </li><li>que.<span class="hljs-built_in">FreeTensor</span>(a1);</li></ol></pre></div></div> </li></ul> <ul><li>如下样例中队列连续2次入队，队列的深度应设置为2，仅在极少数preload场景（比如连续搬入两份数据，计算处理一份，完成后再搬入一份，然后计算处理提前搬入的一份...）可能会使用。其他情况下均不推荐depth &gt;= 2 。<div _ngcontent-tus-c106="" class="highlight-div"><div _ngcontent-tus-c106="" class="highlight-div-header"><div _ngcontent-tus-c106="" class="highlight-div-header-left"><div _ngcontent-tus-c106="" class="handle-button expand-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tus-c106="" class="highlight-div-header-right"><div _ngcontent-tus-c106="" class="handle-button ai-button"></div><div _ngcontent-tus-c106="" class="handle-button line-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tus-c106="" class="handle-button theme-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tus-c106="" class="handle-button copy-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tus-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>a1 = que.<span class="hljs-built_in">AllocTensor</span>();  </li><li>a2 = que.<span class="hljs-built_in">AllocTensor</span>(); </li><li>que.<span class="hljs-built_in">EnQue</span>(a1); </li><li>que.<span class="hljs-built_in">EnQue</span>(a2); </li><li>a1 = que.<span class="hljs-built_in">DeQue</span>(); </li><li>a2 = que.<span class="hljs-built_in">DeQue</span>();  </li><li>que.<span class="hljs-built_in">FreeTensor</span>(a1); </li><li>que.<span class="hljs-built_in">FreeTensor</span>(a2);</li></ol></pre></div></div> </li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.000000000000002%"><p>mask</p> </td> <td class="cellrowborder" valign="top" width="86%"><p>保留参数，不支持：</p> <p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section27352mcpsimp">TQue Buffer限制<i class="anchor-icon anchor-icon-link" anchorid="section27352mcpsimp" tips="复制节点链接"></i></h2><p>由于TQue分配的Buffer存储着同步事件eventID，故同一个TPosition上QUE Buffer的数量与硬件的同步事件eventID有关。</p> <p>Kirin9020与KirinX90系列处理器，eventID的数量均为8。</p> <p>QUE的Buffer数量最大也分别为8个或4个，即能插入的同步事件的个数为8个或4个。当用TPipe的InitBuffer申请TQue时，会受到Buffer数量的限制，TQue能申请到的最大个数分别为8个或4个。</p> <p>如果同时使用的QUE Buffer超出限制，则无法再申请TQue。如果想要继续申请，可以调用FreeAllEvent接口来释放一些暂时不用的TQue。在使用完对应TQue后，用该接口释放对应队列中的所有事件，之后便可再次申请TQue。样例如下。</p> <div _ngcontent-tus-c106="" class="highlight-div"><div _ngcontent-tus-c106="" class="highlight-div-header"><div _ngcontent-tus-c106="" class="highlight-div-header-left"><div _ngcontent-tus-c106="" class="handle-button expand-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tus-c106="" class="highlight-div-header-right"><div _ngcontent-tus-c106="" class="handle-button ai-button"></div><div _ngcontent-tus-c106="" class="handle-button line-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tus-c106="" class="handle-button theme-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tus-c106="" class="handle-button copy-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tus-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 能申请的VECIN position上的buffer数量最大为8。如果超出该限制，在后续使用AllocTensor/FreeTensor可能会出现分配资源失败。故当不开启double buffer时，此时最多能申请8个TQue。 </span></li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TPipe</span> <span class="hljs-title class_">pipe</span>; </li><li><span class="hljs-variable">int</span> <span class="hljs-variable">len</span> = <span class="hljs-number">1024</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que0</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que1</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que2</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que3</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que4</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que5</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que6</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que7</span>; </li><li>  </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que0</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que2</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que3</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que4</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que5</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que6</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que7</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li>  </li><li><span class="hljs-comment">// 如果开启double buffer，此时每一个TQue分配的内存块个数为2，故最多只能申请4个TQue。 </span></li><li><span class="hljs-variable">TPipe</span> <span class="hljs-variable">pipe</span>; </li><li><span class="hljs-variable">int</span> <span class="hljs-variable">len</span> = <span class="hljs-number">1024</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que0</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que1</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que2</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que3</span>; </li><li>  </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que0</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que1</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que2</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que3</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">len</span>); </li><li>  </li><li><span class="hljs-comment">// 如果TQue个数已达最大值，可以调用FreeAllEvent接口来继续申请TQue。 </span></li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TPipe</span> <span class="hljs-title class_">pipe</span>; </li><li><span class="hljs-variable">int</span> <span class="hljs-variable">len</span> = <span class="hljs-number">1024</span>; </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que0</span>; </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que0</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>); </li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">LocalTensor</span>&lt;<span class="hljs-title class_">half</span>&gt; <span class="hljs-title class_">tensor1</span> = <span class="hljs-variable">que0</span>.<span class="hljs-title class_">AllocTensor</span>&lt;<span class="hljs-title class_">half</span>&gt;(); </li><li><span class="hljs-variable">que0</span>.<span class="hljs-title function_">EnQue</span>(<span class="hljs-variable">tensor1</span>); </li><li><span class="hljs-variable">tensor1</span> = <span class="hljs-variable">que0</span>.<span class="hljs-title class_">DeQue</span>&lt;<span class="hljs-title class_">half</span>&gt;(); <span class="hljs-comment">// 将tensor从VECOUT的Queue中搬出 </span></li><li><span class="hljs-variable">que0</span>.<span class="hljs-title class_">FreeTensor</span>&lt;<span class="hljs-title class_">half</span>&gt;(<span class="hljs-variable">tensor1</span>); </li><li><span class="hljs-variable">que0</span>.<span class="hljs-title function_">FreeAllEvent</span>(); <span class="hljs-comment">// 释放que0的所有同步事件，之后可继续申请TQue </span></li><li><span class="hljs-variable">AscendC</span>::<span class="hljs-title class_">TQue</span>&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">TPosition</span>::<span class="hljs-title class_">VECIN</span>, <span class="hljs-number">1</span>&gt; <span class="hljs-title class_">que1</span>; </li><li><span class="hljs-variable">pipe</span>.<span class="hljs-title function_">InitBuffer</span>(<span class="hljs-variable">que1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">len</span>);</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section27364mcpsimp">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section27364mcpsimp" tips="复制节点链接"></i></h2><p>以下用例通过传入TQueConfig使能bufferNumber的编译期计算。vector算子不涉及数据格式的转换，所以nd2nz和nz2nd是false。</p> <div _ngcontent-tus-c106="" class="highlight-div"><div _ngcontent-tus-c106="" class="highlight-div-header"><div _ngcontent-tus-c106="" class="highlight-div-header-left"><div _ngcontent-tus-c106="" class="handle-button expand-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tus-c106="" class="highlight-div-header-right"><div _ngcontent-tus-c106="" class="handle-button ai-button"></div><div _ngcontent-tus-c106="" class="handle-button line-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tus-c106="" class="handle-button theme-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tus-c106="" class="handle-button copy-button"><div _ngcontent-tus-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tus-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 开发者自定义的构造TQueConfig的元函数 </span></li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">constexpr</span> AscendC::TQueConfig <span class="hljs-title">GetMyTQueConfig</span><span class="hljs-params">(<span class="hljs-type">bool</span> </span></span><em><span class="hljs-function"><span class="hljs-params">nd2nzIn</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">bool</span> </span></span><em><span class="hljs-function"><span class="hljs-params">nz2ndIn</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">bool</span> </span></span><em><span class="hljs-function"><span class="hljs-params">scmBlockGroupIn</span></span></em><span class="hljs-function"><span class="hljs-params">, </span></span></li><li><span class="hljs-function">    <span class="hljs-type">uint32_t</span> </span><em><span class="hljs-function"><span class="hljs-params">bufferLenIn</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">uint32_t</span> </span></span><em><span class="hljs-function"><span class="hljs-params">bufferNumberIn</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">uint32_t</span> </span></span><em><span class="hljs-function"><span class="hljs-params">consumerSizeIn</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">const</span> AscendC::TPosition </span></span><em><span class="hljs-function"><span class="hljs-params">consumerIn</span></span></em><span class="hljs-function"><span class="hljs-params">[])</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    <span class="hljs-keyword">return</span> { </li><li>        .nd2nz = <em>nd2nzIn</em>, </li><li>        .nz2nd = <em>nz2ndIn</em>, </li><li>        .scmBlockGroup = <em>scmBlockGroupIn</em>, </li><li>        .bufferLen = <em>bufferLenIn</em>, </li><li>        .bufferNumber = <em>bufferNumberIn</em>, </li><li>        .consumerSize = <em>consumerSizeIn</em>, </li><li>        .consumer = {<em>consumerIn</em>[<span class="hljs-number">0</span>], <em>consumerIn</em>[<span class="hljs-number">1</span>], <em>consumerIn</em>[<span class="hljs-number">2</span>], <em>consumerIn</em>[<span class="hljs-number">3</span>], </li><li>            <em>consumerIn</em>[<span class="hljs-number">4</span>], <em>consumerIn</em>[<span class="hljs-number">5</span>], <em>consumerIn</em>[<span class="hljs-number">6</span>], <em>consumerIn</em>[<span class="hljs-number">7</span>]} </li><li>    }; </li><li>} </li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> AscendC::TPosition tp[<span class="hljs-number">8</span>] = {AscendC::TPosition::MAX, AscendC::TPosition::MAX, AscendC::TPosition::MAX, AscendC::TPosition::MAX, </li><li>            AscendC::TPosition::MAX, AscendC::TPosition::MAX, AscendC::TPosition::MAX, AscendC::TPosition::MAX}; </li><li><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> AscendC::TQueConfig conf = <span class="hljs-built_in">GetMyTQueConfig</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, tp); </li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> srcType&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAscendQuant</span> { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelAscendQuant</span><span class="hljs-params">()</span> </span>{} </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR </span></span><em><span class="hljs-function"><span class="hljs-params">src_gm</span></span></em><span class="hljs-function"><span class="hljs-params">, GM_ADDR </span></span><em><span class="hljs-function"><span class="hljs-params">dst_gm</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">uint32_t</span> </span></span><em><span class="hljs-function"><span class="hljs-params">inputSize</span></span></em><span class="hljs-function"><span class="hljs-params">)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        dataSize = <em>inputSize</em>; </li><li>        src_global.<span class="hljs-built_in">SetGlobalBuffer</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;__gm__ srcType*&gt;(<em>src_gm</em>), dataSize); </li><li>        dst_global.<span class="hljs-built_in">SetGlobalBuffer</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;__gm__ <span class="hljs-type">int8_t</span>*&gt;(<em>dst_gm</em>), dataSize); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueX, <span class="hljs-number">1</span>, dataSize * <span class="hljs-built_in">sizeof</span>(srcType)); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(outQueue, <span class="hljs-number">1</span>, dataSize * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int8_t</span>)); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-built_in">CopyIn</span>(); </li><li>        <span class="hljs-built_in">Compute</span>(); </li><li>        <span class="hljs-built_in">CopyOut</span>(); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// ... </span></li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// ... </span></li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-comment">// ... </span></li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    AscendC::GlobalTensor&lt;srcType&gt; src_global; </li><li>    AscendC::GlobalTensor&lt;<span class="hljs-type">int8_t</span>&gt; dst_global; </li><li>    AscendC::TPipe pipe; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>, &amp;conf&gt; inQueueX; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>, &amp;conf&gt; outQueue; </li><li>    <span class="hljs-type">uint32_t</span> dataSize = <span class="hljs-number">0</span>; </li><li>}; </li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> dataType&gt; <span class="hljs-function">__aicore__ <span class="hljs-type">void</span> <span class="hljs-title">kernel_ascend_quant_operator</span><span class="hljs-params">(GM_ADDR </span></span><em><span class="hljs-function"><span class="hljs-params">src_gm</span></span></em><span class="hljs-function"><span class="hljs-params">, GM_ADDR </span></span><em><span class="hljs-function"><span class="hljs-params">dst_gm</span></span></em><span class="hljs-function"><span class="hljs-params">, <span class="hljs-type">uint32_t</span> </span></span><em><span class="hljs-function"><span class="hljs-params">dataSize</span></span></em><span class="hljs-function"><span class="hljs-params">)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    KernelAscendQuant&lt;dataType&gt; op; </li><li>    op.<span class="hljs-built_in">Init</span>(<em>src_gm</em>, <em>dst_gm</em>, <em>dataSize</em>); </li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>