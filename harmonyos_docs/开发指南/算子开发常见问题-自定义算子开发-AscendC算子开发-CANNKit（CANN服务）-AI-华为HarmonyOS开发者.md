<h1 _ngcontent-ayc-c119="" class="doc-title ng-star-inserted" title="算子开发常见问题"> 算子开发常见问题 </h1>

<div _ngcontent-ayc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted renderOptimization" style="position: relative;"> <div><div class="tiledSection" style="contain-intrinsic-size: auto 32px;"><h2 id="section4863191813232">核函数运行验证时算子存在精度问题<i class="anchor-icon anchor-icon-link" anchorid="section4863191813232" tips="复制节点链接"></i></h2></div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 277px;"><h3 id="section6031mcpsimp" class="firsth2">现象描述<i class="anchor-icon anchor-icon-link" anchorid="section6031mcpsimp" tips="复制节点链接"></i></h3><p>在进行算子NPU域的运行验证时，通过md5sum等方式进行算子精度比对，实际数据和真值数据不一致，算子存在精度问题。本示例中通过md5sum来进行精度比对，打印出的真值数据和实际输出数据的md5值不一致，具体打印信息如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>md5sum: </li><li>45e17ee4c068a655be2af4d8c3a1f191  output/golden.bin </li><li>6a99e41a84b14dd04f32730ceb9a3988  output/output_y.bin</li></ol></pre></div></div> </div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 92px;"><h3 id="section6035mcpsimp">问题根因<i class="anchor-icon anchor-icon-link" anchorid="section6035mcpsimp" tips="复制节点链接"></i></h3><p>算子出现精度问题，一般是由于算子的实现逻辑有误。</p> </div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 1844px;"><h3 id="section0876170182818">定位步骤<i class="anchor-icon anchor-icon-link" anchorid="section0876170182818" tips="复制节点链接"></i></h3><p>AscendC提供孪生调试的功能，通过CPU域的功能验证、gdb单步调试、printf数值打印来定位算子的实现逻辑问题。本样例仅展示了可能会出现的场景，便于演示定位步骤。实际使用过程中，请根据代码情况进行调试。</p> <ol><li><span>进行CPU域的功能验证，观察是否有日志报错。</span><p></p><p>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-project-based-operator-development">工程化算子开发</a>章节，编写CPU侧的运行验证代码，并进行运行验证。得到CPU域的精度比对结果如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>md5sum: </li><li>45e17ee4c068a655be2af4d8c3a1f191  output/golden.bin </li><li>5d6e1aec686b28bd3839dbcd5caaa8b2  output/output_y.bin</li></ol></pre></div></div> <p>可以看出CPU域的精度比对也存在不一致的问题，然后观察是否有打屏日志报错，可搜索关键词"failed"。比如，下图的报错示例指示，错误出现在代码中调用LeakyRelu接口的地方。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>leakyrelu_custom_cpu: /home/workdir/AscendC/ddk/tikcpp/tikcfw/interface/kernel_operator_vec_binary_scalar_intf.h:447: void AscendC::LeakyRelu(const AscendC::LocalTensor&lt;T&gt;&amp;, const AscendC::LocalTensor&lt;T&gt;&amp;, const T&amp;, const int32_t&amp;) [with T = float16::Fp16T; int32_t = int]: Assertion `false &amp;&amp; "check vlrelu instr failed"' failed</li></ol></pre></div></div> <p>通过上述报错日志，一般只能定位到报错的代码行，无法明确具体错误，接下来需要通过gdb调试的方式或者printf打印的方式进一步精确定位。</p> <p></p></li><li><span>gdb调试。下面的样例展示了拉起leakyrelu算子CPU侧运行程序的样例，该样例程序会直接抛出异常，直接gdb运行，查看调用栈信息分析定位即可。其他场景下开发者可以使用gdb打断点等基本操作进行调试。使用gdb调试AscendC程序的详细内容请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-gdb">gdb调试</a>。</span><p></p><ol><li>使用gdb拉起待调试程序，进入gdb界面进行debug。<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>gdb leakyrelu_custom_cpu</li></ol></pre></div></div> </li><li>单独调试一个子进程。<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) set follow-fork-mode child</li></ol></pre></div></div> </li><li>运行程序。<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) r</li></ol></pre></div></div> </li><li>通过bt查看程序调用栈。<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>(gdb) bt</li></ol></pre></div></div> </li><li>查看具体层的堆栈信息，打印具体变量的值。本示例中，打印了tileLength为1024，该程序中表示需要处理1024个half类型的数，大小为1024*sizeof(half)=2048字节；输入Tensor xLocal的值，其中dataLen表示LocalTensor的size大小为1024字节，只能计算1024字节的数据。可以看出两者的长度不匹配，由此可以定位问题。<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>(<span class="hljs-variable">gdb</span>) <span class="hljs-variable">f</span> <span class="hljs-number">5</span> </li><li> #<span class="hljs-number">5</span>  <span class="hljs-number">0x000055555555d364</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">KernelLeakyRelu</span>::<span class="hljs-title class_">Compute</span> (<span class="hljs-keyword">this</span>=<span class="hljs-number">0x7fffffffd7d0</span>, <span class="hljs-variable">progress</span>=<span class="hljs-number">0</span>) <span class="hljs-variable">at</span> /<span class="hljs-variable">root</span>/<span class="hljs-variable">AscendC_DemoCode</span>-<span class="hljs-variable">master</span>/<span class="hljs-variable">precision</span>-<span class="hljs-variable">error</span>/<span class="hljs-variable">vector</span>/<span class="hljs-variable">leakyrelu_custom</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">59</span> </li><li> <span class="hljs-number">59</span>              <strong class="shell, console"><span class="hljs-title function_">LeakyRelu</span>(<span class="hljs-variable">yLocal</span>, <span class="hljs-variable">xLocal</span>, <span class="hljs-variable">scalar</span>, <span class="hljs-variable">tileLength</span>);</strong></li><li> (<span class="hljs-variable">gdb</span>) <strong><span class="hljs-variable">p</span> <span class="hljs-variable">tileLength</span></strong></li><li> <strong class="shell">$<span class="hljs-number">1</span> = <span class="hljs-number">1024</span></strong></li><li> (<span class="hljs-variable">gdb</span>) <strong><span class="hljs-variable">p</span> <span class="hljs-variable">xLocal</span></strong></li><li> $<span class="hljs-number">1</span> = {&lt;<span class="hljs-title class_">AscendC</span>::<span class="hljs-title class_">BaseTensor</span>&lt;<span class="hljs-title class_">float16</span>::<span class="hljs-title class_">Fp16T</span>&gt;&gt; = {&lt;<span class="hljs-title class_">No</span> <span class="hljs-title class_">data</span> <span class="hljs-title class_">fields</span>&gt;}, <span class="hljs-variable">address_</span> = {<span class="hljs-variable">logicPos</span> = <span class="hljs-number">9</span> <span class="hljs-string">'\t'</span>, <span class="hljs-variable">bufferHandle</span> = <span class="hljs-number">0x7fffffffd930</span> <span class="hljs-string">"\003\005\377\377"</span>, <strong><span class="hljs-variable">dataLen</span> = <span class="hljs-number">1024</span></strong>,<span class="hljs-variable">bufferAddr</span> = <span class="hljs-number">0</span>,<span class="hljs-variable">absAddr</span> = ...}</li></ol></pre></div></div> </li></ol> <p></p></li><li><span>printf打印。在合适的位置增加变量打印。样例代码如下。</span><p></p><div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"xLocal size: %d\n"</span>, xLocal.<span class="hljs-built_in">GetSize</span>()); </li><li><span class="hljs-built_in">printf</span>(<span class="hljs-string">"tileLength: %d\n"</span>, tileLength);</li></ol></pre></div></div> <p>可以看到有如下打屏日志输出，打印了tileLength为1024，该程序中表示需要处理1024个half类型的数；输入Tensor xLocal的size大小，为512，表示只能计算512个half类型的数。可以看出两者的长度不匹配，由此可以定位问题。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>xLocal size: 512 </li><li>tileLength: 1024</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 80px;"><h2 id="section1645073042411">kernel侧获取Tiling信息不正确<i class="anchor-icon anchor-icon-link" anchorid="section1645073042411" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 409px;"><h3 id="section6107mcpsimp" class="firsth2">现象描述<i class="anchor-icon anchor-icon-link" anchorid="section6107mcpsimp" tips="复制节点链接"></i></h3><p>通过算子在kernel侧实现代码中添加PRINTF打印发现kernel侧获取的Tiling信息不正确。</p> <p>比如下文样例，增加的打印代码如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">PRINTF</span>(<span class="hljs-string">"tiling_data.totalLength: %d tiling_data.tileNum: %d.\n"</span>, tiling_data.totalLength, tiling_data.tileNum);</li></ol></pre></div></div> <p>打印的Tiling数据如下，全为0：</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>tiling_data.totalLength: 0 tiling_data.tileNum: 0.</li></ol></pre></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 172px;"><h3 id="section6114mcpsimp">问题根因<i class="anchor-icon anchor-icon-link" anchorid="section6114mcpsimp" tips="复制节点链接"></i></h3><p>kernel侧获取Tiling信息不正确的原因一般有以下两种：</p> <ul><li>host侧计算Tiling的逻辑不正确</li><li>kernel侧核函数的参数未按照正确顺序填写</li></ul> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 524px;"><h3 id="section108768010282">处理步骤<i class="anchor-icon anchor-icon-link" anchorid="section108768010282" tips="复制节点链接"></i></h3><ol><li><span>参考如下示例，打印TilingData的数据，确认host侧序列化保存的TilingData是否正确。如果此时打印值有误，说明Tiling的计算逻辑可能不正确，需要进一步检查host侧Tiling实现代码，排查计算逻辑是否有误。</span><p></p><div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>std::out&lt;&lt;*<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint32_t</span> *&gt;(context-&gt;<span class="hljs-built_in">GetRawTilingData</span>()-&gt;<span class="hljs-built_in">GetData</span>())&lt;&lt;std::endl; <span class="hljs-comment">// 按照实际数据类型打印TilingData第一个参数值，如需确认其他值，取值指针向后偏移即可</span></li></ol></pre></div></div> <p></p></li><li><span>如果上一步骤中打印的TilingData正确，需要排查kernel侧核函数的参数是否按照正确顺序填写。</span><p></p><p>使用msOpGen工具创建算子工程，并基于工程进行kernel侧算子开发时，核函数的定义模板已通过msOpGen工具自动生成，样例如下所示<strong>。</strong>参数按照 “输入、输出、workspace、tiling”的顺序排布。请检查是否调整过参数顺序导致和正确顺序不一致。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{ </li><li>    <span class="hljs-built_in">GET_TILING_DATA</span>(tiling_data, tiling);<span class="hljs-comment">// 获取Tiling参数 </span></li><li>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> user kernel impl </span></li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section137055533258">Kernel编译时报错“error: out of jump/jumpc imm range”<i class="anchor-icon anchor-icon-link" anchorid="section137055533258" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 205px;"><h3 id="section6131mcpsimp" class="firsth2">现象描述<i class="anchor-icon anchor-icon-link" anchorid="section6131mcpsimp" tips="复制节点链接"></i></h3><p>使用工程化算子开发方式，基于自定义算子工程进行算子开发。编译算子时失败，报如下错误：</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>[ERROR] [ascendxxxx] PowerCustom_88a695f03edfbc0af76b9eaae9e4556c error: out of jump/jumpc imm range</li></ol></pre></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 116px;"><h3 id="section6135mcpsimp">问题根因<i class="anchor-icon anchor-icon-link" anchorid="section6135mcpsimp" tips="复制节点链接"></i></h3><p>该编译错误的原因是算子kernel代码过大，导致在编译时跳转指令跳转的偏移值超过了限定的大小（int16_t的数据范围），可通过添加编译选项“-mllvm -cce-aicore-jump-expand=true”通过间接跳转的方式来避免该问题，让编译器能够正常编译。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 288px;"><h3 id="section5877150132812">处理步骤<i class="anchor-icon anchor-icon-link" anchorid="section5877150132812" tips="复制节点链接"></i></h3><ol><li><span>在kernel侧的CMakeLists中通过add_ops_compile_options针对报错算子添加编译选项“-mllvm -cce-aicore-jump-expand=true”，示例如下。</span><p></p><div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">add_ops_compile_options</span>(PowerCustom OPTIONS -mllvm -cce-aicore-jump-expand=true)</li></ol></pre></div></div> <p>add_ops_compile_options的具体使用方法请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-operator-project-compilation#section4830mcpsimp">支持自定义编译选项</a>。</p> <p></p></li><li><span>重新编译该算子。正常编译无报错。</span></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section1121953816264">有可选输入的情况下，算子编译失败，报找不到DTYPE_XX<i class="anchor-icon anchor-icon-link" anchorid="section1121953816264" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 1993px;"><h3 id="section187875557269" class="firsth2">现象描述<i class="anchor-icon anchor-icon-link" anchorid="section187875557269" tips="复制节点链接"></i></h3><p>使用tilingkey设置代码分支时，无法生成对应omc文件。例如onnx模型为2个输入，算子有4个输入x、y、m、n，2个为required和2个optional，tiling key设置为2。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAddCustom_omc2</span> {</li><li><span class="hljs-comment">// ... ...</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAddCustom_omc3</span> {</li><li><span class="hljs-comment">// ... ...</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAddCustom_omc4</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelAddCustom_omc4</span><span class="hljs-params">()</span> </span>{}</li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init4</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR m, GM_ADDR n, GM_ADDR z, <span class="hljs-type">uint32_t</span> totalLength, <span class="hljs-type">uint32_t</span> tileNum)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-built_in">ASSERT</span>(<span class="hljs-built_in">GetBlockNum</span>() != <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-string">"block dim can not be zero!"</span>);</li><li>        <span class="hljs-keyword">this</span>-&gt;blockLength = totalLength / <span class="hljs-built_in">GetBlockNum</span>();</li><li>        <span class="hljs-keyword">this</span>-&gt;tileNum = tileNum;</li><li>        <span class="hljs-built_in">ASSERT</span>(tileNum != <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-string">"tile num can not be zero!"</span>);</li><li>        <span class="hljs-keyword">this</span>-&gt;tileLength = <span class="hljs-keyword">this</span>-&gt;blockLength / tileNum / BUFFER_NUM;</li><li>
</li><li>        xGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_X*)x + <span class="hljs-keyword">this</span>-&gt;blockLength * <span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength);</li><li>        yGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_Y*)y + <span class="hljs-keyword">this</span>-&gt;blockLength * <span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength);</li><li>        mGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_M*)m + <span class="hljs-keyword">this</span>-&gt;blockLength * <span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength);</li><li>        nGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_N*)n + <span class="hljs-keyword">this</span>-&gt;blockLength * <span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength);</li><li>        zGm.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ DTYPE_Z*)z + <span class="hljs-keyword">this</span>-&gt;blockLength * <span class="hljs-built_in">GetBlockIdx</span>(), <span class="hljs-keyword">this</span>-&gt;blockLength);</li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueX, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_X));</li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueY, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_Y));</li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueM, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_M));</li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueN, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_N));</li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(outQueueZ, BUFFER_NUM, <span class="hljs-keyword">this</span>-&gt;tileLength * <span class="hljs-built_in">sizeof</span>(DTYPE_Z));</li><li>    }</li><li><span class="hljs-comment">// ... ...</span></li><li><span class="hljs-keyword">private</span>:</li><li>    TPipe pipe;</li><li>    TQue&lt;QuePosition::VECIN, BUFFER_NUM&gt; inQueueX, inQueueY, inQueueM, inQueueN;</li><li>    TQue&lt;QuePosition::VECOUT, BUFFER_NUM&gt; outQueueZ;</li><li>    GlobalTensor&lt;DTYPE_X&gt; xGm;</li><li>    GlobalTensor&lt;DTYPE_Y&gt; yGm;</li><li>    GlobalTensor&lt;DTYPE_M&gt; mGm;</li><li>    GlobalTensor&lt;DTYPE_N&gt; nGm;</li><li>    GlobalTensor&lt;DTYPE_Z&gt; zGm;</li><li>    <span class="hljs-type">uint32_t</span> blockLength;</li><li>    <span class="hljs-type">uint32_t</span> tileNum;</li><li>    <span class="hljs-type">uint32_t</span> tileLength;</li><li>};</li><li>
</li><li>
</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom_omc</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR m, GM_ADDR n, GM_ADDR z, GM_ADDR workspace, GM_ADDR tiling)</span> </span>{</li><li>    <span class="hljs-built_in">GET_TILING_DATA</span>(tiling_data, tiling);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">2</span>)){</li><li>        KernelAddCustom_omc2 op;</li><li>        op.<span class="hljs-built_in">Init2</span>(x, y, z, tiling_data.size, <span class="hljs-number">4</span>);</li><li>        op.<span class="hljs-built_in">Process2</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">3</span>)){</li><li>        KernelAddCustom_omc3 op;</li><li>        op.<span class="hljs-built_in">Init3</span>(x, y, m, z, tiling_data.size, <span class="hljs-number">4</span>);</li><li>        op.<span class="hljs-built_in">Process3</span>();</li><li>    }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TILING_KEY_IS</span>(<span class="hljs-number">4</span>)){</li><li>        KernelAddCustom_omc4 op;</li><li>        op.<span class="hljs-built_in">Init4</span>(x, y, m, n, z, tiling_data.size, <span class="hljs-number">4</span>);</li><li>        op.<span class="hljs-built_in">Process4</span>();</li><li>    }</li><li>}</li></ol></pre></div></div> <p>omg模型转换失败，报错如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>ddk/ascendc/ops/impl/custom/add_custom_omc.cpp:165:37: error: unknown type name 'DTYPE_N'</li><li>        nGm.SetGlobalBuffer((__gm__ DTYPE_N*)n + this-&gt;blockLength * GetBlockIdx(), this-&gt;blockLength);</li><li>                                    ^</li><li>ddk/ascendc/ops/impl/custom/add_custom_omc.cpp:169:73: error: use of undeclared identifier 'DTYPE_M'</li><li>        pipe.InitBuffer(inQueueM, BUFFER_NUM, this-&gt;tileLength * sizeof(DTYPE_M));</li><li>                                                                        ^</li></ol></pre></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section1478885514268">问题根因<i class="anchor-icon anchor-icon-link" anchorid="section1478885514268" tips="复制节点链接"></i></h3><p>模型仅有2个输入x、y的情况下，仅会生成对应的宏DTYPE_X、DTYPE_Y，不会生成DTYPE_M，DTYPE_N。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 301px;"><h3 id="section106857341998">处理步骤<i class="anchor-icon anchor-icon-link" anchorid="section106857341998" tips="复制节点链接"></i></h3><div class="p">通过编译宏隔离：<div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined (DTYPE_M) &amp;&amp; defined (DTYPE_N)</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAddCustom_omc4</span> {</li><li><span class="hljs-comment">// ... ...</span></li><li>};</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li></ol></pre></div></div> </div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section0672125218309">如何通过gdb启动算子调测工具脚本<i class="anchor-icon anchor-icon-link" anchorid="section0672125218309" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4687mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4687mcpsimp" tips="复制节点链接"></i></h3><p>在Linux环境下，开发者需要通过gdb方式开启对算子调测（ascendebug）工具的调试。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4690mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4690mcpsimp" tips="复制节点链接"></i></h3><p>无</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 941px;"><h3 id="section13594113410285">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section13594113410285" tips="复制节点链接"></i></h3><ol><li><span>执行如下命令，获取工具安装路径。</span><p></p><div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>which ascendebug</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>一般情况下，ascendebug工具路径缺省为“{INSTALL_DIR}/tools/tools_ascendc/package/ascendebug”，其中${INSTALL_DIR}请替换为DDK软件安装后文件存储路径。</p> </div></div></div> <p></p></li><li><span>打开ascendebug工具启动脚本（以缺省路径为例）。</span><p></p><div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>vim ${INSTALL_DIR}/tools/tools_ascendc/package/ascendebug</li></ol></pre></div></div> <p></p></li><li><span>在启动脚本中添加gdb调试命令。</span><p></p><p>样例如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">main</span>() { </li><li>    check_env $LD_LIBRARY_PATH </li><li>    ret1=$? </li><li>    check_env $PATH </li><li>    ret2=$? </li><li>    check_env $TOOLCHAIN_HOME </li><li>    ret3=$? </li><li>    <span class="hljs-keyword">if</span> [ $ret1 -eq <span class="hljs-number">1</span> ] || [ $ret2 -eq <span class="hljs-number">1</span> ] || [ $ret3 -eq <span class="hljs-number">1</span> ]; then </li><li>        echo <span class="hljs-string">"Please make sure source the correct cann package setenv.bash only. you can open a new window,and restart"</span> </li><li>        exit <span class="hljs-number">0</span> </li><li>    fi </li><li>    <span class="hljs-keyword">export</span> _ASCENDC_DEBUG_TOOL_INSTALL_PATH=${DIR%%latest*} </li><li>    <strong>gdb --ex r --args</strong> python3 -m ascendebug.cmd $@ </li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section7929104318319">环境变量报错提示there are multiple xxx env variable<i class="anchor-icon anchor-icon-link" anchorid="section7929104318319" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 277px;"><h3 id="section4707mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4707mcpsimp" tips="复制节点链接"></i></h3><p>使用本工具进行算子功能调测时失败，提示的报错信息如下。</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>error: User specified two different cann Installation package path: {PATH_A} and {PATH_B} </li><li>error: User specified two different cann Installation package path: {PATH_A} and {PATH_B} </li><li>error: User specified two different cann Installation package path: {PATH_A} and {PATH_B} </li><li>Please make sure source the correct cann package setenv.bash only. you can open a new window,and restart</li></ol></pre></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4711mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4711mcpsimp" tips="复制节点链接"></i></h3><p>重复设置了环境变量。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 148px;"><h3 id="section13594173452814">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section13594173452814" tips="复制节点链接"></i></h3><ol><li><span>检查当前运行环境中的环境变量（缺省路径为${INSTALL_DIR}/ddk/tools/tools_ascendc/set_ascendc_env.sh）是否有重复设置。</span></li><li><span>如果有重复，重新打开一个终端窗口，按照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-environment-preparation">环境准备</a>章节设置环境变量。</span></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section2094534714322">NPU编译失败提示RuntimeError: Cannot find compile result file<i class="anchor-icon anchor-icon-link" anchorid="section2094534714322" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 288px;"><h3 id="section4723mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4723mcpsimp" tips="复制节点链接"></i></h3><p>opc编译方式下，kernel编译报错，如图1所示。</p> <div class="fignone"><span class="figcap"><b>图1 </b>报错样例</span><br><span><img height="171.57000000000002" originheight="509" originwidth="1462" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114256.79785418678037131791098248454354:50001231000000:2800:DC8980FE648FB71B8941522230EE088F6EB13BC8D53408A841D33CFF76A23F21.png" title="点击放大" width="497.42"></span></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4728mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4728mcpsimp" tips="复制节点链接"></i></h3><p>Kernel代码实现有误，导致编译失败。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 632px;"><h3 id="section52631357122813">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section52631357122813" tips="复制节点链接"></i></h3><ol><li><span>设置环境变量。</span><p></p><p>在任意终端窗口打开ascendc环境变量文件，缺省路径为“${INSTALL_DIR}/tools/tools_ascendc/set_ascendc_env.sh”，设置如下变量，放开日志打印等级：</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>export ASCEND_GLOBAL_LOG_LEVEL=3         # 设置日志级别为ERROR </li><li>export ASCEND_SLOG_PRINT_TO_STDOUT=1     # 开启日志打屏，日志将不会保存在log文件中</li></ol></pre></div></div> <p></p></li><li><span>获取日志文件。</span><p></p><p>通过命令行方式，日志落盘地址由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section10645104532410">Simulator仿真参数</a>接口指定，缺省为当前操作路径的debug_op.log。请根据实际路径打开日志文件。</p> <p></p></li><li><span>截取调测命令，重新执行后再分析。</span><p></p><ol><li>在debug_op.log中找到“opc npu compile start”关键字。</li><li>手动拷贝opc npu compile start后的命令，如图2所示，并在终端窗口执行，通过打屏或者落盘的日志文件进一步分析问题。<div class="fignone"><span class="figcap"><b>图2 </b>NPU编译命令</span><br><span><img height="63.84" originheight="137" originwidth="973" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114256.43983651155396700232686381029071:50001231000000:2800:E073CDF8C56D237BB79120A5DF02C04F9E06ECCD682604EDF4D51F4C79B580E6.png" title="点击放大" width="469.49"></span></div> </li></ol> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 112px;"><h2 id="section72117653318">NPU编译失败提示RuntimeError: Cannot get compiling bash file! Maybe template json does not match<i class="anchor-icon anchor-icon-link" anchorid="section72117653318" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 270px;"><h3 id="section4749mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4749mcpsimp" tips="复制节点链接"></i></h3><p>opc编译方式下，kernel编译报错，如图3所示。</p> <div class="fignone"><span class="figcap"><b>图3 </b>报错样例</span><br><span><img height="154.28" originheight="419" originwidth="1349" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114256.71898529270458645313966770479731:50001231000000:2800:F7CBE8DC7D379B97B51626B94E900AD964BA362F04FB2A1E4F9876E8B864AB23.png" title="点击放大" width="498.75"></span></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4754mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4754mcpsimp" tips="复制节点链接"></i></h3><p>开发者输入的算子json配置文件与自定义算子工程的算子json模板配置不一致（如输入/输出的dtype不一样）。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 188px;"><h3 id="section4757mcpsimp">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section4757mcpsimp" tips="复制节点链接"></i></h3><p>若调试的算子json模板可变更：</p> <p>修改开发者输入的算子json配置文件，使其与自定义算子工程的算子json模板配置保持一致。</p> <p>例如图3 报错样例中，将json中的padding_mask改为模板对应的pse_shift。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section192124611335">调测失败提示RuntimeError: run output data xxx not found<i class="anchor-icon anchor-icon-link" anchorid="section192124611335" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4765mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4765mcpsimp" tips="复制节点链接"></i></h3><p>执行Kernel显示结束，但最后报错提示没有找到output输出文件。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4768mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4768mcpsimp" tips="复制节点链接"></i></h3><p>CPU/Simulator的Kernel执行失败，导致输出路径下无输出文件生成。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 856px;"><h3 id="section226495710281">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section226495710281" tips="复制节点链接"></i></h3><ol><li><span>设置环境变量。</span><p></p><p>在任意终端窗口打开ascendc环境变量文件，缺省路径为“${INSTALL_DIR}/tools/tools_ascendc/set_ascendc_env.sh”，设置如下变量，放开日志打印等级：</p> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="shell prettyprint linenums hljs language-shell" hw-language="shell" data-highlighted="yes"><ol class="linenums"><li>export ASCEND_GLOBAL_LOG_LEVEL=3         # 设置日志级别为ERROR </li><li>export ASCEND_SLOG_PRINT_TO_STDOUT=1     # 开启日志打屏，日志将不会保存在log文件中</li></ol></pre></div></div> <p></p></li><li><span>获取日志文件。</span><p></p><p>通过命令行方式，日志落盘地址由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section1351011652416">NPU调测参数</a>接口指定，缺省为当前操作路径的debug_op.log。请根据实际路径打开日志文件。</p> <p></p></li><li><span>截取CPU/Simulator调测命令，重新执行后再分析。</span><p></p><ol><li>在debug_op.log中找到“cpu kernel run start”或“npu kernel run start”关键字。</li><li>手动拷贝关键字后的所有命令，在终端窗口分别执行，通过打屏或者落盘的日志文件信息进一步分析问题。</li></ol> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>[<span class="hljs-variable">CONSOLE</span>] <span class="hljs-variable">ascendc_debug_tool</span> [<span class="hljs-number">3626213</span>] <span class="hljs-number">2024</span>-<span class="hljs-number">05</span>-<span class="hljs-number">21</span> <span class="hljs-number">19</span>:<span class="hljs-number">15</span>:<span class="hljs-number">35</span>,<span class="hljs-number">513</span> ==================== <strong><span class="hljs-variable">cpu</span> <span class="hljs-variable">kernel</span> <span class="hljs-variable">run</span> <span class="hljs-variable">start</span></strong> ==================== </li><li>[<span class="hljs-variable">CONSOLE</span>] <span class="hljs-variable">ascendc_debug_tool</span> [<span class="hljs-number">3626213</span>] <span class="hljs-number">2024</span>-<span class="hljs-number">05</span>-<span class="hljs-number">21</span> <span class="hljs-number">19</span>:<span class="hljs-number">15</span>:<span class="hljs-number">35</span>,<span class="hljs-number">513</span> <span class="hljs-variable">execute_cmd</span>: <strong class="text"><span class="hljs-title class_">bash</span> -<span class="hljs-title class_">c</span> <span class="hljs-string">"cd /home/ascendebug_smoking_test/op_contrib/api_opcontrib_case/ForeachSigmoid/cpu/build &amp;&amp; ./foreach_sigmoid_cpu | tee -a /home/ascendebug_smoking_test/op_contrib/api_opcontrib_case.log &amp;&amp; cd -"</span></strong> </li><li><span class="hljs-variable">cpu</span> <span class="hljs-variable">run</span> <span class="hljs-variable">start</span></li></ol></pre></div></div> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-swift" data-highlighted="yes"><ol class="linenums"><li>[<span class="hljs-type">CONSOLE</span>] ascendc_debug_tool [<span class="hljs-number">3626213</span>] <span class="hljs-number">2024</span><span class="hljs-operator">-</span><span class="hljs-number">05</span><span class="hljs-operator">-</span><span class="hljs-number">21</span> <span class="hljs-number">19</span>:<span class="hljs-number">15</span>:<span class="hljs-number">36</span>,<span class="hljs-number">046</span> <span class="hljs-operator">====================</span> <strong>npu kernel run start</strong> <span class="hljs-operator">====================</span> </li><li>[<span class="hljs-type">CONSOLE</span>] ascendc_debug_tool [<span class="hljs-number">3626213</span>] <span class="hljs-number">2024</span><span class="hljs-operator">-</span><span class="hljs-number">05</span><span class="hljs-operator">-</span><span class="hljs-number">21</span> <span class="hljs-number">19</span>:<span class="hljs-number">15</span>:<span class="hljs-number">36</span>,<span class="hljs-number">046</span> <strong><span class="hljs-regexp">/home/</span>run_pkg<span class="hljs-regexp">/latest/</span>toolkit<span class="hljs-regexp">/tools/</span>ascendc_tools<span class="hljs-regexp">/npu_kernel_launch/</span>npu_kernel_launch <span class="hljs-operator">--</span>kernel <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>data<span class="hljs-regexp">/op-contrib/</span>build_out<span class="hljs-regexp">/binary/</span>${chip_version}<span class="hljs-regexp">/bin/</span>foreach_sigmoid<span class="hljs-regexp">/ForeachSigmoid_0885a6586f8e7f8dc8d03c4dabc73ef4_high_performance.o --name ForeachSigmoid --json_file /</span>home<span class="hljs-regexp">/ascendebug_smoking_test/</span>op_contrib<span class="hljs-regexp">/api_opcontrib_case/</span><span class="hljs-type">ForeachSigmoid</span><span class="hljs-regexp">/data/</span><span class="hljs-type">ForeachSigmoid</span>.json <span class="hljs-operator">--</span>input_path <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>api_opcontrib_case<span class="hljs-regexp">/ForeachSigmoid/</span>data <span class="hljs-operator">--</span>output_path <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>api_opcontrib_case<span class="hljs-regexp">/ForeachSigmoid/</span>npu<span class="hljs-regexp">/output --tiling_data /</span>home<span class="hljs-regexp">/ascendebug_smoking_test/</span>op_contrib<span class="hljs-regexp">/api_opcontrib_case/</span><span class="hljs-type">ForeachSigmoid</span><span class="hljs-regexp">/tiling/</span>tiling_data_tiling_key_1_block_dim_1_workspace_33554432.bin <span class="hljs-operator">--</span>tiling_key <span class="hljs-number">1</span> <span class="hljs-operator">--</span>workspace <span class="hljs-number">33554432</span> <span class="hljs-operator">--</span>block_dim <span class="hljs-number">1</span> <span class="hljs-operator">--</span>timeout <span class="hljs-number">600</span> <span class="hljs-operator">--</span>device <span class="hljs-number">0</span> <span class="hljs-operator">--</span>core_type <span class="hljs-type">VectorCore</span> <span class="hljs-operator">--</span>arg_lib <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>api_opcontrib_case<span class="hljs-regexp">/ForeachSigmoid/</span>npu<span class="hljs-regexp">/build/</span>launch_args.so</strong> </li><li>kernel name: <span class="hljs-type">ForeachSigmoid</span> </li><li>kernel file: <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>data<span class="hljs-regexp">/op-contrib/</span>build_out<span class="hljs-regexp">/binary/</span>${chip_version}<span class="hljs-regexp">/bin/</span>foreach_sigmoid<span class="hljs-operator">/</span><span class="hljs-type">ForeachSigmoid_0885a6586f8e7f8dc8d03c4dabc73ef4_high_performance</span>.o </li><li>json file: <span class="hljs-regexp">/home/</span>ascendebug_smoking_test<span class="hljs-regexp">/op_contrib/</span>api_opcontrib_case<span class="hljs-regexp">/ForeachSigmoid/</span>data<span class="hljs-operator">/</span><span class="hljs-type">ForeachSigmoid</span>.json </li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section42017198344">使能打印功能后提示block info is not valid, skip this block<i class="anchor-icon anchor-icon-link" anchorid="section42017198344" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 116px;"><h3 id="section4793mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4793mcpsimp" tips="复制节点链接"></i></h3><p>开启printf/PRINTF/DumpTensor/DumpAccChkPoint/assert打印功能后，代码执行出现block info is not valid, skip this block，无打印信息。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 361px;"><h3 id="section4796mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4796mcpsimp" tips="复制节点链接"></i></h3><p>打印DumpTensor的代码未在报错核中执行 （以CPU调测为例，如图4所示，block32~70 的核没有执行Dump和Print操作），后续解析对应.bin时无法获取该核对应的数据，因此该block的数据无效，打印跳过。</p> <div class="fignone"><span class="figcap"><b>图4 </b>报错样例</span><br><span><img height="220.78" originheight="412" originwidth="927" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114256.07225955627873220140290359689077:50001231000000:2800:83909981B7CA0F43D87341EAE0E35C148B40AA246059F64E6E57E2C1A2052E67.png" title="点击放大" width="497.42"></span></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4801mcpsimp">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section4801mcpsimp" tips="复制节点链接"></i></h3><p>请自行检查算子实现代码，确保printf/PRINTF/DumpTensor/DumpAccChkPoint/assert已执行到该核中。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section452194293419">调试Kernel代码时打印错误或者无打印信息<i class="anchor-icon anchor-icon-link" anchorid="section452194293419" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4805mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4805mcpsimp" tips="复制节点链接"></i></h3><p>调试Kernel代码时虽开启了打印功能，但无论如何修改代码，总是打印错误甚至无打印。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 136px;"><h3 id="section4808mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4808mcpsimp" tips="复制节点链接"></i></h3><ul><li>算子Kernel代码执行过程中异常退出，无打印信息。</li><li>上一次执行日志未清理，真值比对和Dump解析模块按照其路径读取了残留文件，输出了错误的值。</li></ul> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 212px;"><h3 id="section122641257202819">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section122641257202819" tips="复制节点链接"></i></h3><ol><li><span>先清理系统中残留的日志文。</span><p></p><p>请根据实际情况清理上一次生成的调测结果目录（由--work-dir参数指定），包括落盘的日志文件（缺省为当前操作路径的debug_op.log）。</p> <p></p></li><li><span>重新进行CPU/Simulator调测。</span></li><li><span>查看最新生成的日志文件，根据提示的warning、error日志进一步分析问题。</span></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section1134281610352">CPU/Simulator调测的精度比对结果部分为0<i class="anchor-icon anchor-icon-link" anchorid="section1134281610352" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 524px;"><h3 id="section4822mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4822mcpsimp" tips="复制节点链接"></i></h3><p>CPU/Simulator调测生成的精度比对结果文件出现“Failed”，部分输出为0，结果如图5所示。</p> <div class="fignone"><span class="figcap"><b>图5 </b>精度比对结果文件</span><br><span><img height="408.31" originheight="585" originwidth="710" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114256.34471279328131829244851612045979:50001231000000:2800:E786F141F3E6126EBE51C38AE684717F10F04682AB268B3A4A49C4678C7150BD.png" title="点击放大" width="496.09000000000003"></span></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4827mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4827mcpsimp" tips="复制节点链接"></i></h3><p>算子指定的block num没有跑满，导致部分输出为0。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4830mcpsimp">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section4830mcpsimp" tips="复制节点链接"></i></h3><p>检查Tiling文件中设置的block num或者检查--block-num参数配置是否合理，请保证该值满足算子计算业务的需求。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section765642703913">如何通过查看Tiling日志定位问题<i class="anchor-icon anchor-icon-link" anchorid="section765642703913" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4835mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4835mcpsimp" tips="复制节点链接"></i></h3><p>Tiling调测过程中提示报错，需要通过日志进一步定位问题。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4838mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4838mcpsimp" tips="复制节点链接"></i></h3><p>Tiling函数代码实现有误或者输入配置有误（如数据、算子json配置文件等）。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 512px;"><h3 id="section724131815292">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section724131815292" tips="复制节点链接"></i></h3><ol><li><span>获取日志文件。</span><p></p><p>通过命令行方式，日志落盘地址由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section1351011652416">NPU调测参数</a>接口指定，缺省为当前操作路径的debug_op.log。请根据实际路径打开日志文件。</p> <p></p></li><li><span>截取Tiling调测命令，重新执行，根据提示进一步定位Tiling代码问题。</span><p></p><ol><li>在debug_op.log中找到“gen_tiling_data_cmd”关键字。</li><li>手动拷贝gen_tiling_data_cmd后的所有命令，在终端窗口执行，通过打屏或者落盘的日志文件进一步分析问题。</li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>执行命令之前，请确保当前终端<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-environment-preparation">环境准备</a>设置并生效。</p> </div></div></div> <div _ngcontent-ayc-c106="" class="highlight-div"><div _ngcontent-ayc-c106="" class="highlight-div-header"><div _ngcontent-ayc-c106="" class="highlight-div-header-left"><div _ngcontent-ayc-c106="" class="handle-button expand-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ayc-c106="" class="highlight-div-header-right"><div _ngcontent-ayc-c106="" class="handle-button ai-button"></div><div _ngcontent-ayc-c106="" class="handle-button line-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ayc-c106="" class="handle-button theme-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ayc-c106="" class="handle-button copy-button"><div _ngcontent-ayc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ayc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>[CONSOLE] ascendc_debug_tool [4149480] 2024-06-03 15:57:42,364 ==================== generate tiling data start ==================== </li><li> [CONSOLE] ascendc_debug_tool [4149480] 2024-06-03 15:57:42,364 gen_tiling_data_cmd:  </li><li> /home/install_daily/latest/toolkit/tools/ascendc_tools/ascendc_tiling_tool /home/install_daily/latest/opp/built-in/op_impl/ai_core/tbe/op_tiling/lib/linux/aarch64/liboptiling.so FlashAttentionScore ${chip_version} /home/ascendebug_smoking_test/ops_adv/adt_biprof/FlashAttentionScore/tiling/tiling_data.bin /home/ascendebug_smoking_test/ops_adv/adt_biprof/FlashAttentionScore/tiling/tiling_run_info.bin /home/ascendebug_smoking_test/ops_adv/adt_biprof/FlashAttentionScore/tiling/inputs.json /home/ascendebug_smoking_test/ops_adv/adt_biprof/FlashAttentionScore/tiling/outputs.json /home/ascendebug_smoking_test/ops_adv/adt_biprof/FlashAttentionScore/tiling/attrs.json </li><li> [CONSOLE] ascendc_debug_tool [4149480] 2024-06-03 15:57:42,917 ==================== generate tiling data end, takes 552974.0(us) ====================</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section164031852113919">CAModel仿真过慢导致运行失败<i class="anchor-icon anchor-icon-link" anchorid="section164031852113919" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section4861mcpsimp" class="firsth2">问题描述<i class="anchor-icon anchor-icon-link" anchorid="section4861mcpsimp" tips="复制节点链接"></i></h3><p>使用CAModel进行算子性能仿真时，发现运行时间较长，直至调测失败。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 200px;"><h3 id="section4864mcpsimp">可能的原因<i class="anchor-icon anchor-icon-link" anchorid="section4864mcpsimp" tips="复制节点链接"></i></h3><ul><li>硬件资源有限，多任务抢占资源，导致CAModel运行缓慢。</li><li>硬件性能不足以支撑算子仿真计算。</li><li>算子的输入/输出Shape过大，导致CAModel仿真耗时激增。</li><li>CAModel仿真参数设置不合理，如block num取值过大。</li></ul> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 328px;"><h3 id="section4871mcpsimp">处理方案<i class="anchor-icon anchor-icon-link" anchorid="section4871mcpsimp" tips="复制节点链接"></i></h3><ul><li>建议1：尽可能避免多个任务同时抢占硬件资源，保障CAModel主任务运行效果。</li><li>建议2：提高硬件性能，尽量满足如下要求：<ul><li>服务器：X86物理服务器或者计算云（暂支持x86）</li><li>CPU核数：建议大于16核</li><li>内存：建议大于64GB</li><li>硬盘：建议大于2T</li></ul> </li><li>建议3：适当调小算子的输入/输出Shape，降低仿真数据量。</li><li>建议4：请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-cli-parameters#section10645104532410">Simulator仿真参数</a>设置CAModel仿真参数，如block num建议设置为1。</li></ul> </div> </div> <div></div></div>