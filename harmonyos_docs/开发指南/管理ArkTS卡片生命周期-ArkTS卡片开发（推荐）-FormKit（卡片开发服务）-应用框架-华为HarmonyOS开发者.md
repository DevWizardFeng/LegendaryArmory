<h1 _ngcontent-jkm-c119="" class="doc-title ng-star-inserted" title="管理ArkTS卡片生命周期"> 管理ArkTS卡片生命周期 </h1>

<div _ngcontent-jkm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>创建ArkTS卡片，需实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>生命周期接口。</p>    <ol>     <li>      <p>在EntryFormAbility.ets中，导入相关模块。</p>      <div _ngcontent-jkm-c106="" class="highlight-div"><div _ngcontent-jkm-c106="" class="highlight-div-header"><div _ngcontent-jkm-c106="" class="highlight-div-header-left"><div _ngcontent-jkm-c106="" class="handle-button expand-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jkm-c106="" class="highlight-div-header-right"><div _ngcontent-jkm-c106="" class="handle-button ai-button"></div><div _ngcontent-jkm-c106="" class="handle-button line-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jkm-c106="" class="handle-button theme-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jkm-c106="" class="handle-button copy-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jkm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Configuration</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div></li>     <li>      <p>在EntryFormAbility.ets中，实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>生命周期接口，其中在onAddForm的入参<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">want</a>中可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-forminfo#formparam" target="_blank">FormParam</a>取出卡片的相关信息。</p>      <div _ngcontent-jkm-c106="" class="highlight-div"><div _ngcontent-jkm-c106="" class="highlight-div-header"><div _ngcontent-jkm-c106="" class="highlight-div-header-left"><div _ngcontent-jkm-c106="" class="handle-button expand-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jkm-c106="" class="highlight-div-header-right"><div _ngcontent-jkm-c106="" class="handle-button ai-button"></div><div _ngcontent-jkm-c106="" class="handle-button line-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jkm-c106="" class="handle-button theme-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jkm-c106="" class="handle-button copy-button"><div _ngcontent-jkm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jkm-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryFormAbility'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DOMAIN_NUMBER</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li> </li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): formBindingData.<span class="hljs-property">FormBindingData</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onAddForm'</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, want.<span class="hljs-property">parameters</span>?.[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">NAME_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);</li><li> </li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 卡片使用方创建卡片时触发，提供方需要返回卡片数据绑定类</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {</li><li>      <span class="hljs-string">'title'</span>: <span class="hljs-string">'titleOnAddForm'</span>,</li><li>      <span class="hljs-string">'detail'</span>: <span class="hljs-string">'detailOnAddForm'</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formData</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(obj);</li><li>    <span class="hljs-keyword">return</span> formData;</li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onCastToNormalForm</span>(<span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 当前卡片使用方不会涉及该场景，无需实现该回调函数</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onCastToNormalForm'</span>);</li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onUpdateForm</span>(<span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 若卡片支持定时更新/定点更新/卡片使用方主动请求更新功能，则提供方需要重写该方法以支持数据更新</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onUpdateForm'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {</li><li>      <span class="hljs-string">'title'</span>: <span class="hljs-string">'titleOnUpdateForm'</span>,</li><li>      <span class="hljs-string">'detail'</span>: <span class="hljs-string">'detailOnUpdateForm'</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formData</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(obj);</li><li>    formProvider.<span class="hljs-title function_">updateForm</span>(formId, formData).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] updateForm, error:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>    });</li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onChangeFormVisibility</span>(<span class="hljs-attr">newStatus</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 卡片使用方发起可见或者不可见通知触发，提供方需要做相应的处理，仅系统应用生效</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onChangeFormVisibility'</span>);</li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onFormEvent</span>(<span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 若卡片支持触发事件，则需要重写该方法并实现对事件的触发</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onFormEvent'</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onRemoveForm</span>(<span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 删除卡片实例数据</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onRemoveForm'</span>);</li><li>    <span class="hljs-comment">// 删除之前持久化的卡片实例数据</span></li><li>    <span class="hljs-comment">// 此接口请根据实际情况实现，具体请参考：FormExtAbility Stage模型卡片实例</span></li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onConfigurationUpdate</span>(<span class="hljs-params">config: Configuration</span>) {</li><li>    <span class="hljs-comment">// 当前formExtensionAbility存活时更新系统配置信息时触发的回调。</span></li><li>    <span class="hljs-comment">// 需注意：formExtensionAbility创建后10秒内无操作将会被清理。</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN_NUMBER</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'[EntryFormAbility] onConfigurationUpdate:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(config));</li><li>  }</li><li> </li><li>  <span class="hljs-title function_">onAcquireFormState</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-comment">// 卡片提供方接收查询卡片状态通知接口，默认返回卡片初始状态。</span></li><li>    <span class="hljs-keyword">return</span> formInfo.<span class="hljs-property">FormState</span>.<span class="hljs-property">READY</span>;</li><li>  }</li><li>}</li></ol></pre></div></div></li>    </ol>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>FormExtensionAbility进程不能常驻后台，即在卡片生命周期回调函数中无法处理长时间的任务，在生命周期调度完成后会继续存在10秒，如10秒内没有新的生命周期回调触发则进程自动退出。针对可能需要10秒以上才能完成的业务逻辑，建议<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-overview">拉起主应用</a>进行处理，处理完成后使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm</a>通知卡片进行刷新。</p>     </div></div></div>   </div>   <div></div></div>