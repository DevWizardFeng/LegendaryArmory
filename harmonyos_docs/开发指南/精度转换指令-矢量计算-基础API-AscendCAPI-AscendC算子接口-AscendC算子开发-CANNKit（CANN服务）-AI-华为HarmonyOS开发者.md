<h1 _ngcontent-tkx-c119="" class="doc-title ng-star-inserted" title="精度转换指令"> 精度转换指令 </h1>

<div _ngcontent-tkx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section2123310174717">Cast<i class="anchor-icon anchor-icon-link" anchorid="section2123310174717" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section8236172313171" class="firsth2">函数功能<i class="anchor-icon anchor-icon-link" anchorid="section8236172313171" tips="复制节点链接"></i></h3><p>根据源操作数和目的操作数Tensor的数据类型进行精度转换。</p> <p>在了解精度转换规则之前，需要先了解浮点数的表示方式和二进制的舍入规则：</p> <div class="p"><strong>浮点数的表示方式</strong>：<ul><li>half共16bit，包括1bit符号位（S），5bit指数位（E）和10bit尾数位（M）。<p>当E不全为0或不全为1时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>E - 15</sup> * (1 + M)</p> <p>当E全为0时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>-14</sup> * M</p> <p>当E全为1时，若M全为0，表示的结果为±inf（取决于符号位）；若M不全为0，表示的结果为nan。</p> <p><span><img height="97.75500000000001" originheight="98" originwidth="360" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.55049863475081612721530741634814:50001231000000:2800:1B5373990C9B95ADBA5F4753C6EB657D2FB72BF98895B9C518EE9C898CE53A39.png" title="点击放大" width="359.1"></span></p> <p>上图中S=0，E=15，M = 2<sup>-1</sup> + 2<sup>-2</sup>，表示的结果为1.75。</p> </li><li>float共32bit，包括1bit符号位（S），8bit指数位（E）和23bit尾数位（M）。<p>当E不全为0或不全为1时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>E - 127</sup> * (1 + M)</p> <p>当E全为0时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>-126</sup> * M</p> <p>当E全为1时，若M全为0，表示的结果为±inf（取决于符号位）；若M不全为0，表示的结果为nan。</p> <p><span><img height="85.23238500000001" originheight="104" originwidth="639" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.19988607522017300947707674676776:50001231000000:2800:40F6993632861C62D7ACD7B4F8D3EBC9A94F1A30ABB91E6FC4984DD91DBDEB37.png" title="点击放大" width="523.6875"></span></p> <p>上图中S = 0，E = 127，M = 2<sup>-1</sup> + 2<sup>-2</sup>，最终表示的结果为1.75 。</p> </li><li>bfloat16_t共16bit，包括1bit符号位（S），8bit指数位（E）和7bit尾数位（M）。<p>当E不全为0或不全为1时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>E - 127</sup> * (1 + M)</p> <p>当E全为0时，表示的结果为：</p> <p>(-1)<sup>S</sup> * 2<sup>-126</sup> * M</p> <p>当E全为1时，若M全为0，表示的结果为±inf（取决于符号位）；若M不全为0，表示的结果为nan。</p> <p><span><img height="106.7325" originheight="107" originwidth="371" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.18039914917871851602814054205922:50001231000000:2800:40555E6CE6E14F4AC81E567B2DB17FB8E779F36378D920FEC1D95D29B41E50D3.png" title="点击放大" width="370.07250000000005"></span></p> <p>上图中S = 0，E = 127，M = 2<sup>-1</sup> + 2<sup>-2</sup>，最终表示的结果为1.75。</p> </li></ul> </div> <p><strong>二进制的舍入规则和十进制类似，具体如下。</strong></p> <p><span><img height="69.190191" originheight="109" originwidth="825" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.93162140560107552337882664036410:50001231000000:2800:15D4648D39A32E5D297D39D1A2772FE0ACEB9D95AB5E768B8887EF50B56B10B9.png" title="点击放大" width="523.6875"></span></p> <ul><li>CAST_RINT模式下，若待舍入部分的第一位为0，则不进位；若第一位为1且后续位不全为0，则进位；若第一位为1且后续位全为0，当M的最后一位为0则不进位，当M的最后一位为1则进位。</li><li>CAST_FLOOR模式下，若S为0，则不进位；若S为1，当待舍入部分全为0则不进位，否则，进位。</li><li>CAST_CEIL模式下，若S为1，则不进位；若S为0，当待舍入部分全为0则不进位；否则，进位。</li><li>CAST_ROUND模式下，若待舍入部分的第一位为0，则不进位；否则，进位。</li><li>CAST_TRUNC模式下，总是不进位。</li><li>CAST_ODD模式下，若待舍入部分全为0，则不进位；若待舍入部分不全为0，当M的最后一位为1则不进位，当M的最后一位为0则进位。</li></ul> <p>精度转换规则如下表所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>精度转换规则</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.9.2.4.1.1" valign="top" width="8.160816081608163%"><p>src类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.9.2.4.1.2" valign="top" width="9.18091809180918%"><p>dst类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.9.2.4.1.3" valign="top" width="82.65826582658265%"><p>精度转换规则介绍</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="6" valign="top" width="8.160816081608163%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src按照round_mode（精度转换处理模式，参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-precision-conversion-instruction#section1932592331714">参数说明</a>中的round_mode参数）取整，仍以float格式存入dst中。</p> <p>示例：输入0.5，</p> <p>CAST_RINT模式输出0.0，CAST_FLOOR模式输出0.0，CAST_CEIL模式输出1.0，CAST_ROUND模式输出1.0，CAST_TRUNC模式输出0.0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>half</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取到half所能表示的数，以half格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入0.5 + 2<sup>-12</sup>，写成float的表示形式：2<sup>-1</sup> * (1 + 2<sup>-11</sup>)，因此E = -1 + 127 = 126，M = 2<sup>-11</sup><sup>。</sup></p> <p><span><img height="9.840847792207793" originheight="104" originwidth="639" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.74339801723752228291628669037169:50001231000000:2800:46DA8BD2FFA2B1E6B524E68B1008DC20BCD1FFA626BA35CB182EB5A53BA64A11.png" title="点击放大" width="60.464446444644466"></span></p> <p>half的指数位可以表示出2<sup>-1</sup>，E = -1 + 15 = 14，但half只有10 bit尾数位，因此灰色部分要进行舍入。</p> <p>CAST_RINT模式舍入得尾数0000000000，E = 14，M = 0，最终表示的结果为0.5。</p> <p>CAST_FLOOR模式舍入得尾数0000000000，E = 14，M = 0，最终表示的结果为0.5。</p> <p>CAST_CEIL模式舍入得尾数0000000001，E = 14，M = 2<sup>-10</sup>，最终表示的结果为0.5 + 2<sup>-11</sup>。</p> <p>CAST_ROUND模式舍入得尾数0000000001，E = 14，M = 2<sup>-10</sup>，最终表示的结果为0.5 + 2<sup>-11</sup>。</p> <p>CAST_TRUNC模式舍入得尾数0000000000，E = 14，M = 0，最终表示的结果为0.5。</p> <p>CAST_ODD模式舍入得尾数0000000001，E = 14，M = 2<sup>-10</sup>，最终表示的结果为0.5 + 2<sup>-11</sup> 。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int64_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int64_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>22</sup> + 0.5，</p> <p>CAST_RINT模式输出2<sup>22</sup>，CAST_FLOOR模式输出2<sup>22</sup>，CAST_CEIL模式输出2<sup>22</sup> + 1，CAST_ROUND模式输出2<sup>22</sup> + 1，CAST_TRUNC模式输出2<sup>22</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int32_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int32_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>22  </sup>+ 0.5，</p> <p>CAST_RINT模式输出2<sup>22</sup>，CAST_FLOOR模式输出2<sup>22</sup> ，CAST_CEIL模式输出2<sup>22 </sup>+ 1，CAST_ROUND模式输出2<sup>22</sup> + 1，CAST_TRUNC模式输出2<sup>22</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int16_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>22</sup> + 0.5，</p> <p>CAST_RINT模式输出2<sup>15</sup> - 1（溢出处理），CAST_FLOOR模式输出2<sup>15</sup> - 1（溢出处理），CAST_CEIL模式输出2<sup>15</sup> - 1（溢出处理），CAST_ROUND模式输出2<sup>15</sup> - 1（溢出处理），CAST_TRUNC模式输出2<sup>15</sup> - 1（溢出处理）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>bfloat16_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取到bfloat16_t所能表示的数，以bfloat16_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入0.5+ 2<sup>-9</sup> + 2<sup>-11</sup> , 写成float的表示形式：2<sup>-1</sup> * (1 + 2<sup>-8</sup> + 2<sup>-10</sup>)，因此E = -1 + 127 = 126，M = 2<sup>-8</sup> + 2<sup>-10</sup> 。</p> <p><span><img height="9.840847792207793" originheight="104" originwidth="639" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114316.01241285594749098676298200807394:50001231000000:2800:B01F3C46D14E777F25A89AAB9EF75DCBFAB8C1FBB004908DEA70CFA7B270C9A6.png" title="点击放大" width="60.464446444644466"></span></p> <p>bfloat16_t的指数位位数和float的相同，有E = 126，但bfloat16_t只有7bit尾数位，因此灰色部分要进行舍入。</p> <p>CAST_RINT模式舍入得尾数0000001，E = 126，M = 2<sup>-7</sup>，最终表示的结果为0.5 + 2<sup>-8</sup>。</p> <p>CAST_FLOOR模式舍入得尾数0000000，E = 126，M = 0，最终表示的结果为0.5。</p> <p>CAST_CEIL模式舍入得尾数0000001，E = 126，M = 2<sup>-7</sup>，最终表示的结果为0.5 + 2<sup>-8</sup>。</p> <p>CAST_ROUND模式舍入得尾数0000001，E = 126，M = 2<sup>-7</sup>，最终表示的结果为0.5 + 2<sup>-8</sup>。</p> <p>CAST_TRUNC模式舍入得尾数0000000，E = 126，M = 0，最终表示的结果为0.5。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="6" valign="top" width="8.160816081608163%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以float格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入1.5 - 2<sup>-10</sup>，输出1.5 - 2<sup>-10</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int32_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int32_t格式存入dst中。</p> <p>示例：输入-1.5，</p> <p>CAST_RINT模式输出-2，CAST_FLOOR模式输出-2，CAST_CEIL模式输出-1，CAST_ROUND模式输出-2，CAST_TRUNC模式输出-1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int16_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>7</sup> - 0.5，</p> <p>CAST_RINT模式输出2<sup>7</sup>，CAST_FLOOR模式输出2<sup>7</sup> - 1，CAST_CEIL模式输出2<sup>7</sup>，CAST_ROUND模式输出2<sup>7</sup>，CAST_TRUNC模式输出2<sup>7</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int8_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int8_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>7 </sup>- 0.5，</p> <p>CAST_RINT模式输出2<sup>7</sup> - 1（溢出处理），CAST_FLOOR模式输出2<sup>7</sup> - 1，CAST_CEIL模式输出2<sup>7</sup> - 1（溢出处理），CAST_ROUND模式输出2<sup>7</sup> - 1（溢出处理），CAST_TRUNC模式输出2<sup>7</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>uint8_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以uint8_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入1.75，</p> <p>CAST_RINT模式输出2，CAST_FLOOR模式输出1，CAST_CEIL模式输出2，CAST_ROUND模式输出2，CAST_TRUNC模式输出1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int4b_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int4b_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入1.5，</p> <p>CAST_RINT模式输出2，CAST_FLOOR模式输出1，CAST_CEIL模式输出2，CAST_ROUND模式输出2，CAST_TRUNC模式输出1。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="8.160816081608163%"><p>bfloat16_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以float格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入1.5 - 2<sup>-6</sup>，输出1.5 - 2<sup>-6</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int32_t</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取整，以int32_t格式（溢出默认按照饱和处理）存入dst中。</p> <p>示例：输入2<sup>6 </sup>+ 0.5</p> <p>CAST_RINT模式输出2<sup>6</sup>，CAST_FLOOR模式输出2<sup>6</sup> ，CAST_CEIL模式输出2<sup>6</sup> + 1，CAST_ROUND模式输出2<sup>6 </sup>+ 1，CAST_TRUNC模式输出2<sup>6</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.160816081608163%"><p>int4b_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以half格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入1，输出1.0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.160816081608163%"><p>uint8_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以half格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入1，输出1.0。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.160816081608163%"><p>int8_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以half格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入-1，输出-1.0。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="8.160816081608163%"><p>int16_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src按照round_mode取到half所能表示的数，以half格式存入dst中。</p> <p>示例：输入2<sup>12</sup> + 2，写成half的表示形式：2<sup>12</sup> * (1 + 2<sup>-11</sup>)，要求E = 12 + 15 = 27，M = 2<sup>-11</sup>：</p> <p><span><img height="97.75500000000001" originheight="98" originwidth="369" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114317.47289855025230268205509260695647:50001231000000:2800:2B7EEBACFDE1B51F6DAB6651647E183AD7A144F6C69B5B5BB3C47B8D6F3D8A4A.png" title="点击放大" width="368.07750000000004"></span></p> <p>由于half只有10bit尾数位，因此灰色部分要进行舍入。</p> <p>CAST_RINT模式舍入得尾数0000000000，E = 27，M = 0，最终表示的结果为2<sup>12</sup>。</p> <p>CAST_FLOOR模式舍入得尾数0000000000，E = 27，M = 0，最终表示的结果为2<sup>12</sup>。</p> <p>CAST_CEIL模式舍入得尾数0000000001，E = 27，M = 2<sup>-10</sup>，最终表示的结果为2<sup>12</sup> + 4。</p> <p>CAST_ROUND模式舍入得尾数0000000001，E = 27，M = 2<sup>-10</sup>，最终表示的结果为2<sup>12 </sup>+ 4。</p> <p>CAST_TRUNC模式舍入得尾数0000000000，E = 27，M = 0，最终表示的结果为2<sup>12</sup>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>float</p> </td> <td class="cellrowborder" valign="top"><p>将src以float格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入2<sup>15</sup> - 1，输出2<sup>15</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="3" valign="top" width="8.160816081608163%"><p>int32_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src按照round_mode取到float所能表示的数，以float格式存入dst中。</p> <p>示例：输入2<sup>25</sup> + 3，写成float的表示形式：2<sup>25</sup> * (1 + 2<sup>-24</sup> + 2<sup>-25</sup>)，要求E = 25 + 127 = 152，   M = 2<sup>-24</sup> + 2<sup>-25</sup><sup>。</sup></p> <p><span><img height="81.41023100000001" originheight="104" originwidth="669" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114317.22863459489473876173172025458413:50001231000000:2800:ACA57C732FBA958B127D2BFC778DD401E69591338E0BF08694C65558AB80E8B8.png" title="点击放大" width="523.6875"></span></p> <p>由于float只有23bit尾数位，因此灰色部分要进行舍入。</p> <p>CAST_RINT模式舍入得尾数00000000000000000000001，E = 152，M = 2<sup>-23</sup>，最终表示的结果为2<sup>25</sup> + 4。</p> <p>CAST_FLOOR模式舍入得尾数00000000000000000000000，E = 152，M = 0，最终表示的结果为2<sup>25</sup>。</p> <p>CAST_CEIL模式舍入得尾数00000000000000000000001，E = 152，M = 2<sup>-23</sup>，最终表示的结果为2<sup>25 </sup>+ 4。</p> <p>CAST_ROUND模式舍入得尾数00000000000000000000001，E = 152，M = 2<sup>-23</sup>，最终表示的结果为2<sup>25</sup> + 4。</p> <p>CAST_TRUNC模式舍入得尾数00000000000000000000000，E = 152，M = 0，最终表示的结果为2<sup>25</sup> 。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int64_t</p> </td> <td class="cellrowborder" valign="top"><p>将src以int64_t格式存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入2<sup>31</sup> - 1，输出2<sup>31</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>将src以int16_t格式（溢出默认按照饱和处理）存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入2<sup>31</sup> - 1，输出2<sup>15</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="8.160816081608163%"><p>int64_t</p> </td> <td class="cellrowborder" valign="top" width="9.18091809180918%"><p>int32_t</p> </td> <td class="cellrowborder" valign="top" width="82.65826582658265%"><p>将src以int32_t格式（溢出默认按照饱和处理）存入dst中，不存在精度转换问题，无舍入模式。</p> <p>示例：输入2<sup>31</sup>，输出2<sup>31</sup> - 1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>float</p> </td> <td class="cellrowborder" valign="top"><p>将src按照round_mode取到float所能表示的数，以float格式存入dst中。</p> <p>示例：输入2<sup>35 </sup>+ 2<sup>12</sup> + 2<sup>11</sup>，写成float的表示形式：2<sup>35</sup> * (1 + 2<sup>-23</sup> + 2<sup>-24</sup>)，要求E = 35 + 127 = 162，M = 2<sup>-23</sup> + 2<sup>-24</sup>。</p> <p><span><img height="9.39954563044876" originheight="104" originwidth="669" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114317.34410512853156263044096592133315:50001231000000:2800:1C7D7267D288B31D70165F63355FA14692B19A7D263B85F562955A0E9D3C6663.png" title="点击放大" width="60.464446444644466"></span></p> <p>由于float只有23bit尾数位，因此灰色部分要进行舍入。</p> <p>CAST_RINT模式舍入得尾数00000000000000000000010，E = 162，M = 2<sup>-22</sup>，最终表示的结果为2<sup>35</sup> + 2<sup>13</sup>。</p> <p>CAST_FLOOR模式舍入得尾数00000000000000000000001，E = 162，M = 2<sup>-23</sup>，最终表示的结果为2<sup>25</sup> + 2<sup>12</sup>。</p> <p>CAST_CEIL模式舍入得尾数00000000000000000000010，E = 162，M = 2<sup>-22</sup>，最终表示的结果为2<sup>25</sup>  + 2<sup>13</sup>。</p> <p>CAST_ROUND模式舍入得尾数00000000000000000000010，E = 162，M = 2<sup>-22</sup>，最终表示的结果为2<sup>25</sup> + 2<sup>13</sup>。</p> <p>CAST_TRUNC模式舍入得尾数00000000000000000000001，E = 162，M = 2<sup>-23</sup>，最终表示的结果为2<sup>25 </sup>+ 2<sup>12</sup>。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section332372319176">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section332372319176" tips="复制节点链接"></i></h3><div class="p">tensor前n个数据计算：<div _ngcontent-tkx-c106="" class="highlight-div"><div _ngcontent-tkx-c106="" class="highlight-div-header"><div _ngcontent-tkx-c106="" class="highlight-div-header-left"><div _ngcontent-tkx-c106="" class="handle-button expand-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tkx-c106="" class="highlight-div-header-right"><div _ngcontent-tkx-c106="" class="handle-button ai-button"></div><div _ngcontent-tkx-c106="" class="handle-button line-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tkx-c106="" class="handle-button theme-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tkx-c106="" class="handle-button copy-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tkx-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T1, <span class="hljs-keyword">typename</span> T2&gt; </li><li> <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Cast</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T1&gt;&amp; dstLocal, <span class="hljs-type">const</span> LocalTensor&lt;T2&gt;&amp; srcLocal, <span class="hljs-type">const</span> RoundMode&amp; round_mode, <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> calCount)</span></span></li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h3 id="section1932592331714">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section1932592331714" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>模板参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.2.3.1.1" valign="top" width="16.16%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.2.3.1.2" valign="top" width="83.84%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.16%"><p>T1</p> </td> <td class="cellrowborder" valign="top" width="83.84%"><p>目的操作数数据类型。</p> <p>Kirin9020支持的数据类型见表4。</p> <p>KirinX90支持的数据类型见表4。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.16%"><p>T2</p> </td> <td class="cellrowborder" valign="top" width="83.84%"><p>源操作数数据类型。</p> <p>Kirin9020支持的数据类型见表4。</p> <p>KirinX90支持的数据类型见表4。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.2.4.1.1" valign="top" width="16.33%"><p>参数名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.4.1.2" valign="top" width="11.219999999999999%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.2.4.1.3" valign="top" width="72.45%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.33%"><p>dstLocal</p> </td> <td class="cellrowborder" valign="top" width="11.219999999999999%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="72.45%"><p>目的操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.33%"><p>srcLocal</p> </td> <td class="cellrowborder" valign="top" width="11.219999999999999%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.45%"><p>源操作数。</p> <p>类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-localtensor">LocalTensor</a>，支持的TPosition为VECIN/VECCALC/VECOUT。</p> <p>LocalTensor的起始地址需要32字节对齐。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.33%"><p>round_mode</p> </td> <td class="cellrowborder" valign="top" width="11.219999999999999%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.45%"><p>精度转换处理模式，类型是RoundMode。</p> <p>RoundMode为枚举类型，用以控制精度转换处理模式，具体定义为：</p> <div _ngcontent-tkx-c106="" class="highlight-div"><div _ngcontent-tkx-c106="" class="highlight-div-header"><div _ngcontent-tkx-c106="" class="highlight-div-header-left"><div _ngcontent-tkx-c106="" class="handle-button expand-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tkx-c106="" class="highlight-div-header-right"><div _ngcontent-tkx-c106="" class="handle-button ai-button"></div><div _ngcontent-tkx-c106="" class="handle-button line-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tkx-c106="" class="handle-button theme-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tkx-c106="" class="handle-button copy-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tkx-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">RoundMode</span> { </li><li>     CAST_NONE = <span class="hljs-number">0</span>,  <span class="hljs-comment">// 在转换有精度损失时表示CAST_RINT模式，不涉及精度损失时表示不舍入 </span></li><li>     CAST_RINT,      <span class="hljs-comment">// rint，四舍六入五成双舍入 </span></li><li>     CAST_FLOOR,     <span class="hljs-comment">// floor，向负无穷舍入 </span></li><li>     CAST_CEIL,      <span class="hljs-comment">// ceil，向正无穷舍入 </span></li><li>     CAST_ROUND,     <span class="hljs-comment">// round，四舍五入舍入 </span></li><li>     CAST_TRUNC,     <span class="hljs-comment">// trunc，向零舍入 </span></li><li>     CAST_ODD,       <span class="hljs-comment">// Von Neumann rounding，最近邻奇数舍入 </span></li><li> };</li></ol></pre></div></div> <p>CAST_ROUND表示反向0取整，远离0，对正数x.y变成(x + 1)，对负数-x.y，变成-(x + 1)。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.33%"><p>calCount</p> </td> <td class="cellrowborder" valign="top" width="11.219999999999999%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="72.45%"><p>输入数据元素个数。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表4 </b>Kirin系列产品Cast指令参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.4.2.4.1.1" valign="top" width="13.13%"><p>src数据类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.2.4.1.2" valign="top" width="14.14%"><p>dst数据类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.4.2.4.1.3" valign="top" width="72.72999999999999%"><p>支持的roundMode</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="4" valign="top" width="13.13%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>溢出部分按饱和处理。CAST_RINT/CAST_ODD/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC/CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>溢出部分按饱和处理。</p> <p>CAST_RINT/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int32_t</p> </td> <td class="cellrowborder" valign="top"><p>溢出部分按饱和处理。</p> <p>CAST_RINT/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC/CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>float</p> </td> <td class="cellrowborder" valign="top"><p>CAST_RINT/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC</p> </td> </tr> <tr><td class="cellrowborder" rowspan="5" valign="top" width="13.13%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>int8_t/uint8_t</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>溢出部分按饱和处理。</p> <p>CAST_RINT/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC/CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int32_t</p> </td> <td class="cellrowborder" valign="top"><p>CAST_RINT/CAST_ROUND/CAST_FLOOR/CAST_CEIL/CAST_TRUNC</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>float</p> </td> <td class="cellrowborder" valign="top"><p>CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>CAST_RINT</p> </td> </tr> <tr><td class="cellrowborder" valign="top"> </td> <td class="cellrowborder" valign="top"> </td> </tr> <tr><td class="cellrowborder" valign="top" width="13.13%"><p>int16_t</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>half/float</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="13.13%"><p>int32_t</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>int16_t</p> </td> <td class="cellrowborder" valign="top"><p>溢出部分按饱和处理。CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="13.13%"><p>uint8_t</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>CAST_NONE</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="13.13%"><p>int8_t</p> </td> <td class="cellrowborder" valign="top" width="14.14%"><p>half</p> </td> <td class="cellrowborder" valign="top" width="72.72999999999999%"><p>CAST_NONE</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section739612361714">返回值<i class="anchor-icon anchor-icon-link" anchorid="section739612361714" tips="复制节点链接"></i></h3><p>无</p> </div> <div class="tiledSection"><h3 id="section23961223171710">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section23961223171710" tips="复制节点链接"></i></h3><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> <div class="tiledSection"><h3 id="section173971823151718">注意事项<i class="anchor-icon anchor-icon-link" anchorid="section173971823151718" tips="复制节点链接"></i></h3><ul><li>操作数地址偏移对齐要求请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-general-constraints">通用约束</a>。</li><li>dst与src的应为不同Tensor，或同一Tensor的同一元素，不支持同一Tensor的不同元素。</li><li>src为float，dst为float时，取整模式表示向整数取整（仍为float类型），其他情况表示向dst数据类型所能表示的数字取整。</li></ul> </div> <div class="tiledSection"><h3 id="section15402523171712">调用示例<i class="anchor-icon anchor-icon-link" anchorid="section15402523171712" tips="复制节点链接"></i></h3><p>本样例中只展示Compute流程中的部分代码。本样例的srcLocal为half类型，dstLocal为int32_t类型，计算mask时以int32_t为准。</p> <p>如果开发者需要运行样例代码，请将该代码段拷贝并替换样例模板中Compute函数的部分代码即可。</p> <div class="p">tensor前n个数据计算样例：<div _ngcontent-tkx-c106="" class="highlight-div"><div _ngcontent-tkx-c106="" class="highlight-div-header"><div _ngcontent-tkx-c106="" class="highlight-div-header-left"><div _ngcontent-tkx-c106="" class="handle-button expand-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tkx-c106="" class="highlight-div-header-right"><div _ngcontent-tkx-c106="" class="handle-button ai-button"></div><div _ngcontent-tkx-c106="" class="handle-button line-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tkx-c106="" class="handle-button theme-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tkx-c106="" class="handle-button copy-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tkx-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>AscendC::<span class="hljs-built_in">Cast</span>(dstLocal, srcLocal, AscendC::RoundMode::CAST_CEIL, <span class="hljs-number">512</span>);</li></ol></pre></div></div> </div> <p>结果示例如下。</p> <div _ngcontent-tkx-c106="" class="highlight-div"><div _ngcontent-tkx-c106="" class="highlight-div-header"><div _ngcontent-tkx-c106="" class="highlight-div-header-left"><div _ngcontent-tkx-c106="" class="handle-button expand-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tkx-c106="" class="highlight-div-header-right"><div _ngcontent-tkx-c106="" class="handle-button ai-button"></div><div _ngcontent-tkx-c106="" class="handle-button line-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tkx-c106="" class="handle-button theme-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tkx-c106="" class="handle-button copy-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tkx-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>输入数据(srcLocal):  </li><li>[29.5    83.6    16.75   45.1    40.62   69.06   47.6    96.5    72.7 </li><li> 57.56   61.25   69.7    29.27   91.2    70.1    14.484   9.625  21.58 </li><li>  9.336   3.125  63.72    9.9    17.28   73.2    75.7    29.81   98.8 </li><li> 99.06   72.94    3.785  24.94   25.56   39.1    58.94   39.6    78.4 </li><li>  5.43   25.48    9.58   60.8    77.56   29.7    70.3     6.312   4.047 </li><li> 87.1    81.6    76.56   59.28   55.66   81.75   73.56   76.9    54.38 </li><li>  7.254  37.84   11.08   77.6    83.6    89.2    93.06    2.96   76.56 </li><li> 62.16   76.25   95.44   86.6    86.75   29.83   82.2    55.03   64.9 </li><li> 56.44   12.89   87.06   39.34   72.25   43.06   63.4    51.72   63.9 </li><li>  0.703  47.84   27.73   99.     89.     97.3     1.277  58.44   14.05 </li><li> 78.9    98.5    28.55   44.8    41.03   40.75   74.2    74.06   10.51 </li><li> 69.2    25.83   35.8    85.5    25.12   82.25   95.3    36.75   55.88 </li><li> 90.9    57.47    7.13   18.1    40.97   31.     99.3    69.4    72.94 </li><li> 62.44   63.7    80.     37.94   11.11   37.     39.72   87.94   31.72 </li><li> 25.7    54.7    32.8    21.64   14.53   55.1     3.607  40.16   77.7 </li><li> 15.15   77.44   43.25   85.75   67.3    30.33   67.56   60.72   58.16 </li><li> 19.84   89.2    18.75   55.56   31.61    9.445   6.5    27.95   48.5 </li><li> 37.16    7.805  37.72   69.6    36.2    92.56   24.72   41.56   48.44 </li><li> 19.27   25.94   25.      8.836  55.75   77.8    25.84   46.16   71.7 </li><li> 63.62   33.28    3.719  55.22   45.97   35.8    27.86   42.22    3.078 </li><li> 92.06    0.805  51.97   76.4    32.03   74.56   28.1    91.2    35.38 </li><li>  0.2009 74.25   87.5    92.75   76.25   51.28   22.9    34.4    28.23 </li><li> 87.5    78.75   63.1    61.56   79.94    6.766  95.1    55.     56.75 </li><li> 39.66   94.75   24.19   29.83   72.6    99.9    12.43   46.56   51.9 </li><li> 92.3    42.66   91.8    95.8    35.2    13.08   60.7    22.22    6.055 </li><li>  2.23   13.875  71.3    99.56   91.94   92.     96.06   97.5    68.75 </li><li>  8.61    1.157  68.2    20.73   63.44   90.     38.78   64.4    88.9 </li><li> 20.75   14.03   97.06   66.8    57.9    86.94   28.5     0.2279 51.8 </li><li> 84.56   39.53   93.     15.66   15.23   71.75   11.44   45.28   57.38 </li><li> 82.5    88.7     9.74   90.4    61.56   68.56   11.22   69.3    40.28 </li><li> 24.78   84.44   23.92    8.4    20.88   48.2    17.42   59.84   93.2 </li><li>  2.191  95.94   93.06   54.53   76.5    37.     41.7    82.7    69.5 </li><li> 92.6     5.8    32.78   84.56   26.5    96.56    0.858  96.44   52.8 </li><li> 90.9    30.52    2.656  32.03   35.72    8.125  21.94   84.5    66.7 </li><li> 96.75   46.8     1.42   58.3    28.75   44.94   66.2    28.67   11.695 </li><li> 41.75   67.25   26.75   17.72   35.9     5.72   55.88   94.7    80.8 </li><li> 71.     86.06   36.78   81.06   56.8    61.34   11.42   74.     32.16 </li><li> 14.695  78.6    56.1    64.4    61.75   50.88   39.6    79.94   71.25 </li><li> 40.7     5.99   67.4    62.28   89.25   12.02   63.12   33.1    59.06 </li><li> 28.2    19.22   59.66   51.6    53.28   97.8    42.25   82.     39.7 </li><li> 50.6    95.06   20.64   26.62   54.9    55.     28.44   26.25   46.56 </li><li> 87.06   98.44   49.34   37.2    97.4    34.3    83.4    57.4    94. </li><li> 29.31   79.44   19.72   54.9    50.25   58.75   92.5    17.3    17.88 </li><li> 44.7     6.047  50.78   75.3    21.66   71.5    97.75   35.8    93.6 </li><li>  4.367  31.02   66.5    48.25   34.     92.7    36.97   86.5    10.37 </li><li> 82.     29.39   10.63   40.72   72.5    31.56   96.5    70.44    6.074 </li><li> 37.34    7.58   21.72   44.97   77.6    14.22   18.62   47.97   54.6 </li><li> 99.56   81.7    35.75   44.22   28.64   91.56    1.005  44.      8.125 </li><li> 11.7    93.6    70.25   63.94   11.05   50.97   56.47   39.4    35.53 </li><li> 84.     10.21   42.66   62.12   87.7    71.25   87.75   56.03   60.88 </li><li> 31.81   68.1    91.1    67.3    53.6    96.06   43.75   27.86   46.6 </li><li> 87.7    29.47    2.174  88.4    49.53   63.53   84.9    91.75   48.53 </li><li> 91.94   88.44   58.3    88.44   23.11   91.56   71.4    59.66   93.44 </li><li> 28.56   93.3    59.94   90.     18.95   52.8    70.3    58.     21.47 </li><li> 93.7    45.03   84.25   34.06   23.86   38.4     5.566  41.5    35.1 </li><li> 34.8    32.8    81.44   74.75   95.9    23.56    3.562  48.72   92.7 </li><li> 43.88   83.75   69.06   85.8    22.84   63.78   90.94   52.78  ] </li><li>输出数据(dstLocal):  </li><li>[ 30  84  17  46  41  70  48  97  73  58  62  70  30  92  71  15  10  22 </li><li>  10   4  64  10  18  74  76  30  99 100  73   4  25  26  40  59  40  79 </li><li>   6  26  10  61  78  30  71   7   5  88  82  77  60  56  82  74  77  55 </li><li>   8  38  12  78  84  90  94   3  77  63  77  96  87  87  30  83  56  65 </li><li>  57  13  88  40  73  44  64  52  64   1  48  28  99  89  98   2  59  15 </li><li>  79  99  29  45  42  41  75  75  11  70  26  36  86  26  83  96  37  56 </li><li>  91  58   8  19  41  31 100  70  73  63  64  80  38  12  37  40  88  32 </li><li>  26  55  33  22  15  56   4  41  78  16  78  44  86  68  31  68  61  59 </li><li>  20  90  19  56  32  10   7  28  49  38   8  38  70  37  93  25  42  49 </li><li>  20  26  25   9  56  78  26  47  72  64  34   4  56  46  36  28  43   4 </li><li>  93   1  52  77  33  75  29  92  36   1  75  88  93  77  52  23  35  29 </li><li>  88  79  64  62  80   7  96  55  57  40  95  25  30  73 100  13  47  52 </li><li>  93  43  92  96  36  14  61  23   7   3  14  72 100  92  92  97  98  69 </li><li>   9   2  69  21  64  90  39  65  89  21  15  98  67  58  87  29   1  52 </li><li>  85  40  93  16  16  72  12  46  58  83  89  10  91  62  69  12  70  41 </li><li>  25  85  24   9  21  49  18  60  94   3  96  94  55  77  37  42  83  70 </li><li>  93   6  33  85  27  97   1  97  53  91  31   3  33  36   9  22  85  67 </li><li>  97  47   2  59  29  45  67  29  12  42  68  27  18  36   6  56  95  81 </li><li>  71  87  37  82  57  62  12  74  33  15  79  57  65  62  51  40  80  72 </li><li>  41   6  68  63  90  13  64  34  60  29  20  60  52  54  98  43  82  40 </li><li>  51  96  21  27  55  55  29  27  47  88  99  50  38  98  35  84  58  94 </li><li>  30  80  20  55  51  59  93  18  18  45   7  51  76  22  72  98  36  94 </li><li>   5  32  67  49  34  93  37  87  11  82  30  11  41  73  32  97  71   7 </li><li>  38   8  22  45  78  15  19  48  55 100  82  36  45  29  92   2  44   9 </li><li>  12  94  71  64  12  51  57  40  36  84  11  43  63  88  72  88  57  61 </li><li>  32  69  92  68  54  97  44  28  47  88  30   3  89  50  64  85  92  49 </li><li>  92  89  59  89  24  92  72  60  94  29  94  60  90  19  53  71  58  22 </li><li>  94  46  85  35  24  39   6  42  36  35  33  82  75  96  24   4  49  93 </li><li>  44  84  70  86  23  64  91  53]</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section640952391712">样例模板<i class="anchor-icon anchor-icon-link" anchorid="section640952391712" tips="复制节点链接"></i></h3><p>为了方便开发者快速运行指令中的参考样例，本章节提供样例模板。</p> <p>开发者可以将以下样例模板作为代码框架，只需将具体指令中的样例片段拷贝替换下文代码段中的加粗内容即可。</p> <div _ngcontent-tkx-c106="" class="highlight-div"><div _ngcontent-tkx-c106="" class="highlight-div-header"><div _ngcontent-tkx-c106="" class="highlight-div-header-left"><div _ngcontent-tkx-c106="" class="handle-button expand-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tkx-c106="" class="highlight-div-header-right"><div _ngcontent-tkx-c106="" class="handle-button ai-button"></div><div _ngcontent-tkx-c106="" class="handle-button line-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tkx-c106="" class="handle-button theme-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tkx-c106="" class="handle-button copy-button"><div _ngcontent-tkx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tkx-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_operator.h"</span> </span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelCast</span> { </li><li><span class="hljs-keyword">public</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelCast</span><span class="hljs-params">()</span> </span>{} </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* srcGm, __gm__ <span class="hljs-type">uint8_t</span>* dstGm)</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        srcGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ half*)srcGm); </li><li>        dstGlobal.<span class="hljs-built_in">SetGlobalBuffer</span>((__gm__ <span class="hljs-type">int32_t</span>*)dstGm); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(inQueueSrc, <span class="hljs-number">1</span>, <span class="hljs-number">512</span> * <span class="hljs-built_in">sizeof</span>(half)); </li><li>        pipe.<span class="hljs-built_in">InitBuffer</span>(outQueueDst, <span class="hljs-number">1</span>, <span class="hljs-number">512</span> * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int32_t</span>)); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        <span class="hljs-built_in">CopyIn</span>(); </li><li>        <span class="hljs-built_in">Compute</span>(); </li><li>        <span class="hljs-built_in">CopyOut</span>(); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyIn</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; srcLocal = inQueueSrc.<span class="hljs-built_in">AllocTensor</span>&lt;half&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(srcLocal, srcGlobal, <span class="hljs-number">512</span>); </li><li>        inQueueSrc.<span class="hljs-built_in">EnQue</span>(srcLocal); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;half&gt; srcLocal = inQueueSrc.<span class="hljs-built_in">DeQue</span>&lt;half&gt;(); </li><li>        AscendC::LocalTensor&lt;<span class="hljs-type">int32_t</span>&gt; dstLocal = outQueueDst.<span class="hljs-built_in">AllocTensor</span>&lt;<span class="hljs-type">int32_t</span>&gt;(); </li><li>  </li><li>        <strong>AscendC::<span class="hljs-built_in">Cast</span>(dstLocal, srcLocal, AscendC::RoundMode::CAST_CEIL, <span class="hljs-number">512</span>);</strong></li><li>  </li><li>        outQueueDst.<span class="hljs-built_in">EnQue</span>&lt;<span class="hljs-type">int32_t</span>&gt;(dstLocal); </li><li>        inQueueSrc.<span class="hljs-built_in">FreeTensor</span>(srcLocal); </li><li>    } </li><li>    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOut</span><span class="hljs-params">()</span> </span></li><li><span class="hljs-function">    </span>{ </li><li>        AscendC::LocalTensor&lt;<span class="hljs-type">int32_t</span>&gt; dstLocal = outQueueDst.<span class="hljs-built_in">DeQue</span>&lt;<span class="hljs-type">int32_t</span>&gt;(); </li><li>        AscendC::<span class="hljs-built_in">DataCopy</span>(dstGlobal, dstLocal, <span class="hljs-number">512</span>); </li><li>        outQueueDst.<span class="hljs-built_in">FreeTensor</span>(dstLocal); </li><li>    } </li><li><span class="hljs-keyword">private</span>: </li><li>    AscendC::TPipe pipe; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECIN, <span class="hljs-number">1</span>&gt; inQueueSrc; </li><li>    AscendC::TQue&lt;AscendC::QuePosition::VECOUT, <span class="hljs-number">1</span>&gt; outQueueDst; </li><li>    AscendC::GlobalTensor&lt;half&gt; srcGlobal; </li><li>    AscendC::GlobalTensor&lt;<span class="hljs-type">int32_t</span>&gt; dstGlobal; </li><li>}; </li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">cast_simple_kernel</span><span class="hljs-params">(__gm__ <span class="hljs-type">uint8_t</span>* srcGm, __gm__ <span class="hljs-type">uint8_t</span>* dstGm)</span> </span></li><li><span class="hljs-function"></span>{ </li><li>    KernelCast op; </li><li>    op.<span class="hljs-built_in">Init</span>(srcGm, dstGm); </li><li>    op.<span class="hljs-built_in">Process</span>(); </li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>