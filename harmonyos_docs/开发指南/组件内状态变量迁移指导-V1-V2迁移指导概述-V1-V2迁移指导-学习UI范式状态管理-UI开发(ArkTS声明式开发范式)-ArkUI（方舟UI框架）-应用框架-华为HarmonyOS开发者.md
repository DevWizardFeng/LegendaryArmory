<h1 _ngcontent-cqd-c119="" class="doc-title ng-star-inserted" title="组件内状态变量迁移指导"> 组件内状态变量迁移指导 </h1>

<div _ngcontent-cqd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文档主要介绍数据组件内的状态变量的迁移场景，包含以下场景。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.1.3.1.1" valign="top" width="50%">V1装饰器名</th> <th align="left" class="cellrowborder" id="mcps1.3.2.1.3.1.2" valign="top" width="50%">V2装饰器名</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state">@State</a></td> <td class="cellrowborder" valign="top" width="50%"><p>无外部初始化：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-local">@Local</a></p> <p>外部初始化一次：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-param">@Param</a><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-once">@Once</a></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-param">@Param</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-param">@Param</a><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-event">@Event</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@ObjectLink</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-param">@Param</a><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-event">@Event</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Provide</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-provider-and-consumer">@Provider</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Consume</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-provider-and-consumer">@Consumer</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-watch">@Watch</a></td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-monitor">@Monitor</a></td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">无计算属性相关能力，需要重复计算</td> <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-computed">@Computed</a></td> </tr>  </tbody></table></div> </div>  <div class="tiledSection"><h2 id="各装饰器迁移示例">各装饰器迁移示例<i class="anchor-icon anchor-icon-link" anchorid="各装饰器迁移示例" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="state-local" class="firsth2">@State-&gt;@Local<i class="anchor-icon anchor-icon-link" anchorid="state-local" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>在V1中，@State装饰器用于装饰组件内部的状态变量，在V2中提供了@Local作为其替代能力，但两者在观察能力和初始化规则上存在明显差异。针对不同的使用场景，迁移策略如下：</p> <ul><li>简单类型：对于简单类型的变量，可以直接将@State替换为@Local。</li><li>复杂类型：V1中的@State可以观察复杂对象的第一层属性变化，而V2中的@Local只能观察对象自身的变化。如果需要追踪对象内部的属性变化，可以结合使用@ObservedV2和@Trace。</li><li>外部初始化：V1中，@State支持从外部传递初始值，但在V2中，@Local禁止外部初始化。若需要从外部传递初始值，可以使用@Param和@Once装饰器来实现类似的效果。</li></ul> <p><strong>示例</strong></p> <p><strong>简单类型</strong></p> <p>对于简单类型变量，V1的@State可以直接替换为V2的@Local。</p> <p>V1：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">val</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：直接替换。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">val</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>复杂类型</strong></p> <p>V1的@State能够观察复杂对象的第一层属性变化，但V2的@Local无法观察对象内部变化。为了解决这个问题，需要在类上添加@ObservedV2，并在需要观察的属性上添加@Trace。这样，框架就能追踪对象内部的属性变化。</p> <p>V1：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-meta">@Entry</span></li><li>struct example {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">child</span>: <span class="hljs-title class_">Child</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-comment">// @State可以观察第一层变化</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'value+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span>.<span class="hljs-property">value</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@ObservedV2和@Trace。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li><span class="hljs-meta">@Entry</span></li><li>struct example {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">child</span>: <span class="hljs-title class_">Child</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-comment">// @Local只能观察自身，需要给Child加上@ObservedV2和@Trace</span></li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'value+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span>.<span class="hljs-property">value</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>外部初始化状态变量</strong></p> <p>V1的@State变量可以从外部初始化，V2的@Local禁止外部初始化。为实现类似功能，需要用@Param和@Once代替@State，允许外部传入初始值，并确保该值只初始化时同步一次。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// @State可以从外部初始化</span></li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@Param和@Once。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// @Local禁止从外部初始化，可以用@Param和@Once替代实现</span></li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="link---paramevent">@Link -&gt; @Param/@Event<i class="anchor-icon anchor-icon-link" anchorid="link---paramevent" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>在V1中，@Link允许父组件和子组件之间进行双向数据绑定。迁移到V2时，可以用@Param和@Event模拟双向同步。@Param实现父到子的单向传递，子组件再通过@Event回调函数触发父组件的状态更新。</p> <p><strong>示例</strong></p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Link可以双向同步数据</span></li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">val</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'child: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">myVal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'parent: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">myVal</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">val</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myVal</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@Param和@Event。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Param搭配@Event回调实现数据双向同步</span></li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">val</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@Event</span> <span class="hljs-attr">addOne</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'child: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addOne</span>();</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">myVal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'parent: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">myVal</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">val</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myVal</span>, <span class="hljs-attr">addOne</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">myVal</span>++ })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="prop---param">@Prop -&gt; @Param<i class="anchor-icon anchor-icon-link" anchorid="prop---param" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>在V1中，@Prop装饰器用于从父组件传递参数给子组件，这些参数在子组件中可以被直接修改。在V2中，@Param取代了@Prop的作用，但@Param是只读的，子组件不能直接修改参数的值。因此，根据场景的不同，有几种迁移策略：</p> <ul><li>简单类型：对于简单类型的参数，将@Prop替换为@Param。</li><li>复杂类型：如果传递的是复杂对象且需要严格的单向数据绑定，需要深拷贝对象，防止子组件修改父组件的数据。</li><li>子组件修改变量：如果子组件需要修改传入的参数，使用@Once允许子组件在本地修改该变量。但需要注意，使用@Once修饰符后，当前子组件只会被初始化一次，后续无父组件到子组件的同步能力。</li></ul> <p><strong>示例</strong></p> <p><strong>简单类型</strong></p> <p>对于简单类型变量，V1的@Prop可以直接替换为V2的@Param。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：直接替换。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>复杂类型的单向数据传递</strong></p> <p>在V2中，传递复杂类型时，如果希望实现严格的单向数据绑定，防止子组件修改父组件的数据，需要在使用@Param传递复杂对象时进行深拷贝以避免传递对象的引用。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span> {</li><li>  <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;</li><li>  <span class="hljs-attr">orange</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Prop传递Fruit类，当子类修改属性，父类不受影响</span></li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">fruit</span>: <span class="hljs-title class_">Fruit</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'child apple: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">apple</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'child orange: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">orange</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'apple+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'orange+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">orange</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">parentFruit</span>: <span class="hljs-title class_">Fruit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'parent apple: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span>.<span class="hljs-property">apple</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'parent orange: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span>.<span class="hljs-property">orange</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">fruit</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用深拷贝。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">orange</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-comment">// 实现深拷贝，子组件不会修改父组件的数据</span></li><li>  <span class="hljs-title function_">clone</span>(): <span class="hljs-title class_">Fruit</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">newFruit</span>: <span class="hljs-title class_">Fruit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();</li><li>    newFruit.<span class="hljs-property">apple</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>;</li><li>    newFruit.<span class="hljs-property">orange</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">orange</span>;</li><li>    <span class="hljs-keyword">return</span> newFruit;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">fruit</span>: <span class="hljs-title class_">Fruit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'child'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">apple</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">orange</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'apple+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'orange+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">fruit</span>.<span class="hljs-property">orange</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">parentFruit</span>: <span class="hljs-title class_">Fruit</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fruit</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'parent'</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span>.<span class="hljs-property">apple</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span>.<span class="hljs-property">orange</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">fruit</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentFruit</span>.<span class="hljs-title function_">clone</span>() })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>子组件修改变量</strong></p> <p>在V1中，子组件可以修改@Prop的变量，然而在V2中，@Param是只读的。如果子组件需要修改传入的值，可以使用@Param和@Once允许子组件在本地修改。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Prop可以直接修改变量值</span></li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@Param和@Once。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Param搭配@Once使用，可以在本地修改@Param变量</span></li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'+1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>在V1中，子组件可以修改@Prop的变量，且只会在本地更新，不会同步回父组件。父组件数据源更新时，会通知子组件更新，并覆写子组件本地@Prop的值。</p> <p>V1：</p> <ul><li>改变子组件Child的localValue，不会同步回父组件Parent。</li><li>父组件更新value，通知子组件Child更新，并覆写本地子组件localValue的值。</li></ul> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">localValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.localValue}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Child +100'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变localValue不会传递给父组件Parent</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">localValue</span> += <span class="hljs-number">100</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Parent +1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变value的值，通知子组件Child value更新</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">localValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2中，@Param本地不可写，与@Once搭配使用时只同步一次。若要实现子组件本地可写，且父组件后续更新仍能通知子组件，可借助@Monitor实现。</p> <p>V2实现：</p> <ul><li>父组件Parent更新通知子组件value的刷新，并回调@Monitor修饰的onValueChange回调方法，onValueChange将更新后的值赋值给localValue。</li><li>子组件Child改变localValue的值，不会同步给父组件Parent。</li><li>父组件Parent中再次改变value，将会继续通知给子组件，并覆写子组件本地localValue的值。</li></ul> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">localValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'value'</span>)</li><li>  <span class="hljs-title function_">onValueChange</span>(<span class="hljs-params">mon: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`value has been changed from <span class="hljs-subst">${mon.value()?.before}</span> to <span class="hljs-subst">${mon.value()?.now}</span>`</span>);</li><li>    <span class="hljs-comment">// 父组件value变化时，通知子组件value更新，回调Monitor函数，将更新的值覆写给本地的localValue</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.localValue}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Child +100'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变localValue不会传递给父组件Parent</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">localValue</span> += <span class="hljs-number">100</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Parent +1'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 改变value的值，通知子组件Child value更新</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> += <span class="hljs-number">1</span>;</li><li>        })</li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="provideconsume---providerconsumer">@Provide/@Consume -&gt; @Provider/@Consumer<i class="anchor-icon anchor-icon-link" anchorid="provideconsume---providerconsumer" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>V1的@Provide和@Consume与V2的@Provider和@Consumer定位和作用类似，基本可以实现丝滑替换，但存在以下细微差异，开发者可根据自己代码实现情况参考是否需要调整：</p> <p>在V1中，@Provide和@Consume用于父子组件之间的数据共享，可以通过alias（别名）或属性名匹配，同时@Consume依赖父组件的@Provide，API version 20以前不允许本地初始化。V2中，@Provider和@Consumer增强了这些特性，使数据共享更加灵活。根据不同的场景，有以下迁移策略：</p> <ul><li>V1中@Provide和@Consume在没有指定alias的情况下，可以直接使用。V2中@Provider和@Consumer是标准装饰器，且参数可选，所以不管有无指定alias后面需要必须跟随“()”。</li><li>alias和属性名匹配规则：V1中，@Provide和@Consume可以通过alias或属性名匹配；V2中，alias是唯一的匹配key，指定alias后只能通过alias匹配。</li><li>本地初始化支持：API version 20以前，@Consume不允许本地初始化，必须依赖父组件；从API version 20开始，@Consume支持本地初始化，当找不到对应的@Provide时使用本地默认值，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume#consume装饰的变量支持设置默认值">@Consume装饰的变量支持设置默认值</a>；V2中，@Consumer支持本地初始化，当找不到对应的@Provider时使用本地默认值。</li><li>从父组件初始化：V1中，@Provide可以直接从父组件初始化；V2中，@Provider不支持外部初始化，需用@Param和@Once接受初始值并赋给 @Provider。</li><li>重载支持：V1中，@Provide默认不支持重载，需设置 allowOverride；V2中，@Provider默认支持重载，@Consumer会向上查找最近的@Provider。</li></ul> <p><strong>示例</strong></p> <p><strong>alias和属性名匹配规则</strong></p> <p>在V1中，@Provide和@Consume的匹配既可以通过alias，也可以通过属性名。在V2中，alias成为唯一的key，如果在@Consumer中制定了alias，只能通过alias而非属性名进行匹配。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// alias和属性名都为key，alias和属性名都可以匹配</span></li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'text'</span>) <span class="hljs-attr">childMessage</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Consume</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">childMessage</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>) <span class="hljs-comment">// Text是Hello World</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Provide</span>(<span class="hljs-string">'text'</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>()</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：确保alias一致，没有指定alias的情况下，依赖属性名进行匹配。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// alias是唯一匹配的key，有alias情况下无法通过属性名匹配</span></li><li>  <span class="hljs-meta">@Consumer</span>(<span class="hljs-string">'text'</span>) <span class="hljs-attr">childMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'default'</span>;</li><li>  <span class="hljs-meta">@Consumer</span>() <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'default'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">childMessage</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>) <span class="hljs-comment">// Text是default</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Provider</span>(<span class="hljs-string">'text'</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>()</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>V1的@Consume不支持本地初始化，V2支持</strong></p> <p>V1中，API version 20之前，@Consume不允许本地初始化变量，必须依赖父组件的@Provide，否则会抛出异常。迁移到V2后，@Consumer允许本地初始化，当找不到对应的@Provider，会使用本地默认值。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Consume禁止本地初始化，当找不到对应的@Provide时抛出异常</span></li><li>  <span class="hljs-meta">@Consume</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Provide</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>()</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：@Consumer可以本地初始化。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-comment">// @Consumer允许本地初始化，当找不到@Provider的时候使用本地默认值</span></li><li>  <span class="hljs-meta">@Consumer</span>() <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Child</span>()</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>V1的@Provide可以从父组件初始化，V2不支持</strong></p> <p>在V1中，@Provide允许从父组件初始化，可以直接通过组件参数传递初始值。在V2中，@Provider禁止从外部初始化。为实现相同功能，可以在子组件中使用@Param @Once接受初始值，然后将其赋值给@Provider变量。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">parentValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">42</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// @Provide可以从父组件初始化</span></li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">childValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentValue</span> })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Provide</span> <span class="hljs-attr">childValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">childValue</span>.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：使用@Param接受初始值，再赋值给@Provider。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">parentValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">42</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// @Provider禁止从父组件初始化，替代方案为先用@Param接受，再赋值给@Provider</span></li><li>      <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">initialValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentValue</span> })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Param</span> <span class="hljs-meta">@Once</span> <span class="hljs-attr">initialValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@Provider</span>() <span class="hljs-attr">childValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialValue</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">childValue</span>.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>V1的@Provide默认不支持重载，V2默认支持</strong></p> <p>在V1中，@Provide默认不支持重载，无法覆盖上层组件的同名@Provide。若需支持重载，必须设置allowOverride。在V2中，@Provider默认支持重载，@Consumer会向上查找最近的@Provider，无需额外设置。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GrandParent</span> {</li><li>  <span class="hljs-meta">@Provide</span>(<span class="hljs-string">'reviewVotes'</span>) <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">40</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Parent</span>()</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-comment">// @Provide默认不支持重载，支持重载需设置allowOverride函数</span></li><li>  <span class="hljs-meta">@Provide</span>({ <span class="hljs-attr">allowOverride</span>: <span class="hljs-string">'reviewVotes'</span> }) <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Child</span>()</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'reviewVotes'</span>) <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewVotes</span>.<span class="hljs-title function_">toString</span>()) <span class="hljs-comment">// Text显示20</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：去掉allowOverride。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">GrandParent</span> {</li><li>  <span class="hljs-meta">@Provider</span>(<span class="hljs-string">'reviewVotes'</span>) <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">40</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Parent</span>()</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-comment">// @Provider默认支持重载，@Consumer向上查找最近的@Provider</span></li><li>  <span class="hljs-meta">@Provider</span>() <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Child</span>()</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Consumer</span>() <span class="hljs-attr">reviewVotes</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewVotes</span>.<span class="hljs-title function_">toString</span>()) <span class="hljs-comment">// Text显示20</span></li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="watch---monitor">@Watch -&gt; @Monitor<i class="anchor-icon anchor-icon-link" anchorid="watch---monitor" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>在V1中，@Watch用于监听状态变量的变化，并在变量变化时触发指定回调函数。在V2中，@Monitor替代了@Watch，可以更灵活地监听变量的变化，并获取变量变化前后的值。具体的迁移策略如下：</p> <ul><li>单变量监听：对于简单的场景，可以直接用@Monitor替换@Watch，效果一致。</li><li><p>多变量监听：V1的@Watch无法获取变化前的值。在V2中，@Monitor支持同时监听多个变量，并可以访问变量变化前后的状态。</p> <p><strong>示例</strong></p> </li></ul> <p><strong>单变量监听</strong></p> <p>对于简单案例，V1的@Watch可以直接替换为V2的@Monitor。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct watchExample {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onAppleChange'</span>) <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">onAppleChange</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'apple count changed to '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`apple count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apple}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add apple'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：直接替换。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct monitorExample {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'apple'</span>)</li><li>  <span class="hljs-title function_">onFruitChange</span>(<span class="hljs-params">monitor: IMonitor</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`apple changed from <span class="hljs-subst">${monitor.value()?.before}</span> to <span class="hljs-subst">${monitor.value()?.now}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`apple count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apple}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add apple'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>多变量监听</strong></p> <p>在V1中，每个@Watch回调函数只能监听一个变量，且无法获取变化前的值。迁移到V2后，可以使用一个@Monitor同时监听多个变量，并获取监听变量变化前后的值。</p> <p>V1实现：</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct watchExample {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onAppleChange'</span>) <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onOrangeChange'</span>) <span class="hljs-attr">orange</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-comment">// @Watch 回调，只能监听单个变量，不能获取变化前的值</span></li><li>  <span class="hljs-title function_">onAppleChange</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'apple count changed to '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onOrangeChange</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'orange count changed to '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">orange</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`apple count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apple}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`orange count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.orange}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add apple'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add orange'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">orange</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2迁移策略：同时监听多个变量，以及获取变化前的值。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct monitorExample {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">apple</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">orange</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-comment">// @Monitor回调，支持监听多个变量，可以获取变化前的值</span></li><li>  <span class="hljs-meta">@Monitor</span>(<span class="hljs-string">'apple'</span>,<span class="hljs-string">'orange'</span>)</li><li>  <span class="hljs-title function_">onFruitChange</span>(<span class="hljs-params">monitor: IMonitor</span>) {</li><li>    monitor.<span class="hljs-property">dirty</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> changed from <span class="hljs-subst">${monitor.value(name)?.before}</span> to <span class="hljs-subst">${monitor.value(name)?.now}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`apple count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apple}</span>`</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`orange count: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.orange}</span>`</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add apple'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">apple</span>++;</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add orange'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">orange</span>++;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="computed">@Computed<i class="anchor-icon anchor-icon-link" anchorid="computed" tips="复制节点链接"></i></h3><p><strong>迁移规则</strong></p> <p>V1中并没有提供计算属性的概念，所以对于UI中的冗余计算，并没有办法可以减少重复计算。V2针对该场景，提供了@Computed装饰器，可以帮助开发者减少重复计算。</p> <p>V1：</p> <p>在下面的示例中，每次改变lastName都会触发Text组件的刷新，每次Text组件的刷新，都需要重复计算this.lastName + ' ' + this.firstName。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Li'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">lastName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hua'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">lastName</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstName</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">lastName</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstName</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'changed lastName'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastName</span> += <span class="hljs-string">'a'</span>;</li><li>      })</li><li>
</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>V2:</p> <p>使用V2中的@Computed，每次改变lastName仅会触发一次计算。</p> <div _ngcontent-cqd-c106="" class="highlight-div"><div _ngcontent-cqd-c106="" class="highlight-div-header"><div _ngcontent-cqd-c106="" class="highlight-div-header-left"><div _ngcontent-cqd-c106="" class="handle-button expand-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cqd-c106="" class="highlight-div-header-right"><div _ngcontent-cqd-c106="" class="handle-button ai-button"></div><div _ngcontent-cqd-c106="" class="handle-button line-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cqd-c106="" class="handle-button theme-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cqd-c106="" class="handle-button copy-button"><div _ngcontent-cqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@ComponentV2</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Li'</span>;</li><li>  <span class="hljs-meta">@Local</span> <span class="hljs-attr">lastName</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hua'</span>;</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">fullName</span>() {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstName</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastName</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fullName</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fullName</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'changed lastName'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastName</span> += <span class="hljs-string">'a'</span>;</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>