<h1 _ngcontent-ewv-c119="" class="doc-title ng-star-inserted" title="细粒度用户身份认证访问控制开发指导"> 细粒度用户身份认证访问控制开发指导 </h1>

<div _ngcontent-ewv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>细粒度用户身份认证访问控制是基于已有用户身份认证访问控制的扩展，提供了基于生物特征和锁屏密码二次身份认证的细粒度访问控制能力，允许设置密钥在加密、解密、签名、验签、密钥协商、密钥派生的单个或多个场景时是否需要进行身份验证。</p> <p>比如，业务需要使用HUKS密钥加密保存账号密码信息等数据，要求在加密的时候不进行指纹等身份认证，解密的时候需要进行指纹等身份认证，这时就需要依赖HUKS提供细粒度的二次身份认证访问控制机制。</p> <p>使用该功能仅需在密钥生成阶段，通过额外指定用于细粒度用户身份认证访问控制的HuksTag：HUKS_TAG_KEY_AUTH_PURPOSE，来指定在某种算法用途的情况下需要使用用户身份认证访问控制能力。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"> <p>对于对称加解密场景，仅AES/CBC、AES/GCM、SM4/CBC模式支持细粒度访问控制。</p>  </div></div></div>  <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="生成密钥" class="firsth2">生成密钥<i class="anchor-icon anchor-icon-link" anchorid="生成密钥" tips="复制节点链接"></i></h3><p>指定指纹类型的访问控制及相关属性，指定HUKS_TAG_KEY_AUTH_PURPOSE值。</p> <div _ngcontent-ewv-c106="" class="highlight-div"><div _ngcontent-ewv-c106="" class="highlight-div-header"><div _ngcontent-ewv-c106="" class="highlight-div-header-left"><div _ngcontent-ewv-c106="" class="handle-button expand-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewv-c106="" class="highlight-div-header-right"><div _ngcontent-ewv-c106="" class="handle-button ai-button"></div><div _ngcontent-ewv-c106="" class="handle-button line-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewv-c106="" class="handle-button theme-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewv-c106="" class="handle-button copy-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.UniversalKeystoreKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.BasicServicesKit"</span>;</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 确定密钥别名和封装密钥属性参数集。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'test_sm4_key_alias'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_SM4</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span> | huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_SM4_KEY_SIZE_128</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_USER_AUTH_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksUserAuthType</span>.<span class="hljs-property">HUKS_USER_AUTH_TYPE_FINGERPRINT</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_AUTH_ACCESS_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksAuthAccessType</span>.<span class="hljs-property">HUKS_AUTH_ACCESS_INVALID_NEW_BIO_ENROLL</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_CHALLENGE_TYPE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksChallengeType</span>.<span class="hljs-property">HUKS_CHALLENGE_TYPE_NORMAL</span></li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_AUTH_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span></li><li>  }</li><li>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">huksOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: properties,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 生成密钥。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateKeyItem</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: enter generateKeyItem`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">generateKeyItem</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: generateKeyItem success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: generateKeyItem input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TestGenKeyForFingerprintAccessControl</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateKeyItem</span>(keyAlias, huksOptions);</li><li>}</li></ol></pre></div></div> </div>  <div class="tiledSection"><h3 id="使用密钥">使用密钥<i class="anchor-icon anchor-icon-link" anchorid="使用密钥" tips="复制节点链接"></i></h3><p>加密时不需要用户身份认证访问控制，解密时需要进行用户身份认证访问控制。</p> <div _ngcontent-ewv-c106="" class="highlight-div"><div _ngcontent-ewv-c106="" class="highlight-div-header"><div _ngcontent-ewv-c106="" class="highlight-div-header-left"><div _ngcontent-ewv-c106="" class="handle-button expand-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ewv-c106="" class="highlight-div-header-right"><div _ngcontent-ewv-c106="" class="handle-button ai-button"></div><div _ngcontent-ewv-c106="" class="handle-button line-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ewv-c106="" class="handle-button theme-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ewv-c106="" class="handle-button copy-button"><div _ngcontent-ewv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ewv-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { huks } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.UniversalKeystoreKit"</span>;</li><li><span class="hljs-keyword">import</span> { userAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.UserAuthenticationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.BasicServicesKit"</span>;</li><li><span class="hljs-keyword">import</span> { cryptoFramework } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CryptoArchitectureKit'</span></li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">StringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = str.<span class="hljs-property">length</span>; i &lt; j; ++i) {</li><li>    arr.<span class="hljs-title function_">push</span>(str.<span class="hljs-title function_">charCodeAt</span>(i));</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arr);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">Uint8ArrayToString</span>(<span class="hljs-params">fileData: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">let</span> dataString = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; fileData.<span class="hljs-property">length</span>; i++) {</li><li>    dataString += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(fileData[i]);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> dataString;</li><li>}</li><li>
</li><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * 确定密钥别名和封装密钥属性参数集。</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">let</span> keyAlias = <span class="hljs-string">'test_sm4_key_alias'</span>;</li><li><span class="hljs-keyword">let</span> cipherInData = <span class="hljs-string">'Hks_SM4_Cipher_Test_101010101010101010110_string'</span>; <span class="hljs-comment">// 明文数据。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable constant_">IV</span> = cryptoFramework.<span class="hljs-title function_">createRandom</span>().<span class="hljs-title function_">generateRandomSync</span>(<span class="hljs-number">16</span>).<span class="hljs-property">data</span>;</li><li><span class="hljs-keyword">let</span> handle = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">cipherText</span>: <span class="hljs-title class_">Uint8Array</span>; <span class="hljs-comment">// 加密后的密文数据。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">fingerAuthToken</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">challenge</span>: <span class="hljs-title class_">Uint8Array</span>;</li><li><span class="hljs-keyword">let</span> authType = userAuth.<span class="hljs-property">UserAuthType</span>.<span class="hljs-property">FINGERPRINT</span>;</li><li><span class="hljs-keyword">let</span> authTrustLevel = userAuth.<span class="hljs-property">AuthTrustLevel</span>.<span class="hljs-property">ATL1</span>;</li><li><span class="hljs-comment">/* 加密参数集。 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">propertiesEncrypt</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_SM4</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_ENCRYPT</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_SM4_KEY_SIZE_128</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_IV</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-variable constant_">IV</span>,</li><li>  }</li><li>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">encryptOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: propertiesEncrypt,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li><span class="hljs-comment">/* 解密参数集。 */</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">propertiesDecrypt</span>: <span class="hljs-title class_">Array</span>&lt;huks.<span class="hljs-property">HuksParam</span>&gt; = [{</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_ALGORITHM</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyAlg</span>.<span class="hljs-property">HUKS_ALG_SM4</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PURPOSE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPurpose</span>.<span class="hljs-property">HUKS_KEY_PURPOSE_DECRYPT</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_KEY_SIZE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeySize</span>.<span class="hljs-property">HUKS_SM4_KEY_SIZE_128</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_PADDING</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksKeyPadding</span>.<span class="hljs-property">HUKS_PADDING_NONE</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_BLOCK_MODE</span>,</li><li>    <span class="hljs-attr">value</span>: huks.<span class="hljs-property">HuksCipherMode</span>.<span class="hljs-property">HUKS_MODE_CBC</span>,</li><li>  }, {</li><li>    <span class="hljs-attr">tag</span>: huks.<span class="hljs-property">HuksTag</span>.<span class="hljs-property">HUKS_TAG_IV</span>,</li><li>    <span class="hljs-attr">value</span>: <span class="hljs-variable constant_">IV</span>,</li><li>  }</li><li>]</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">decryptOptions</span>: huks.<span class="hljs-property">HuksOptions</span> = {</li><li>  <span class="hljs-attr">properties</span>: propertiesDecrypt,</li><li>  <span class="hljs-attr">inData</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>())</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSession</span>(<span class="hljs-params">keyAlias: <span class="hljs-built_in">string</span>, huksOptions: huks.HuksOptions</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: enter initSession`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">initSession</span>(keyAlias, huksOptions)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        handle = data.<span class="hljs-property">handle</span>;</li><li>        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">challenge</span> != <span class="hljs-literal">undefined</span>) {</li><li>          challenge = data.<span class="hljs-property">challenge</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: initSession success`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: initSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">finishSession</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions, token?: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: enter finishSession`</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> huks.<span class="hljs-title function_">finishSession</span>(handle, huksOptions, token)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        cipherText = data.<span class="hljs-property">outData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>;</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`promise: finishSession success, data = <span class="hljs-subst">${Uint8ArrayToString(cipherText)}</span>`</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession failed, errCode : <span class="hljs-subst">${error.code}</span>, errMsg : <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`promise: finishSession input arg invalid`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">finishDecrypt</span>(<span class="hljs-params">handle: <span class="hljs-built_in">number</span>, huksOptions: huks.HuksOptions, token: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">finishSession</span>(handle, huksOptions, token)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">userIAMAuthFinger</span>(<span class="hljs-params">huksChallenge: <span class="hljs-built_in">Uint8Array</span></span>) {</li><li>  <span class="hljs-comment">// 获取认证对象。</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">authTypeList</span>: userAuth.<span class="hljs-property">UserAuthType</span>[] = [authType];</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">authParam</span>: userAuth.<span class="hljs-property">AuthParam</span> = {</li><li>    <span class="hljs-attr">challenge</span>: huksChallenge,</li><li>    <span class="hljs-attr">authType</span>: authTypeList,</li><li>    <span class="hljs-attr">authTrustLevel</span>: userAuth.<span class="hljs-property">AuthTrustLevel</span>.<span class="hljs-property">ATL1</span></li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">widgetParam</span>: userAuth.<span class="hljs-property">WidgetParam</span> = {</li><li>    <span class="hljs-attr">title</span>: <span class="hljs-string">'请输入密码'</span>,</li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">auth</span>: userAuth.<span class="hljs-property">UserAuthInstance</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth = <span class="hljs-keyword">await</span> userAuth.<span class="hljs-title function_">getUserAuthInstance</span>(authParam, widgetParam)</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"get auth instance success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`get auth instance failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 订阅认证结果。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth.<span class="hljs-title function_">on</span>(<span class="hljs-string">"result"</span>, {</li><li>      <span class="hljs-title function_">onResult</span>(<span class="hljs-params">result</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[HUKS] -&gt; [IAM]  userAuthInstance callback result =</span></li><li><span class="hljs-string">          <span class="hljs-subst">${result.result}</span>, <span class="hljs-subst">${result.token}</span>, <span class="hljs-subst">${result.authType}</span>, <span class="hljs-subst">${result.enrolledState}</span>`</span>);</li><li>        fingerAuthToken = result.<span class="hljs-property">token</span>;</li><li>      }</li><li>    });</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"subscribe authentication event success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`subscribe authentication event failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 开始认证。</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    auth.<span class="hljs-title function_">start</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"authV9 start auth success"</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`authV9 start auth failed, errCode : <span class="hljs-subst">${err.code}</span>, errMsg : <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 1.加密时不需要用户身份认证访问控制。 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testSm4Encrypt</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`enter testSm4Encrypt`</span>);</li><li>  <span class="hljs-comment">/* 初始化密钥会话获取挑战值。 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSession</span>(keyAlias, encryptOptions);</li><li>  <span class="hljs-comment">/* 加密。 */</span></li><li>  encryptOptions.<span class="hljs-property">inData</span> = <span class="hljs-title class_">StringToUint8Array</span>(cipherInData);</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">finishSession</span>(handle, encryptOptions);</li><li>}</li><li>
</li><li><span class="hljs-comment">/* 2.解密时需要进行用户身份认证访问控制。 */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testSm4Decrypt</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`enter testSm4Decrypt`</span>);</li><li>  <span class="hljs-comment">/* 初始化密钥会话获取挑战值。 */</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">initSession</span>(keyAlias, decryptOptions);</li><li>  <span class="hljs-comment">/* 调用userIAM进行身份认证。 */</span></li><li>  <span class="hljs-title function_">userIAMAuthFinger</span>(challenge);</li><li>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">/* 认证成功后进行解密，需要传入Auth获取到的authToken值。 */</span></li><li>    <span class="hljs-comment">/* 需要在超时10秒之前完成指纹认证。 */</span></li><li>    decryptOptions.<span class="hljs-property">inData</span> = cipherText;</li><li>    <span class="hljs-title function_">finishDecrypt</span>(handle, decryptOptions, fingerAuthToken);</li><li>  }, <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testSm4EncryptDecrypt</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">testSm4Encrypt</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">testSm4Decrypt</span>();</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>