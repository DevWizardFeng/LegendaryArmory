<h1 _ngcontent-hei-c119="" class="doc-title ng-star-inserted" title="网络结构搜索训练"> 网络结构搜索训练 </h1>

<div _ngcontent-hei-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p class="msonormal">网络结构搜索训练请按照如下步骤进行：</p> <ol><li><span>准备环境（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section193737375169">环境准备</a>）。</span></li><li><span>准备数据集（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section1766391819183">数据集准备</a>）。</span></li><li><span>配置搜索参数（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section9753193220185">搜索参数配置</a>）。</span></li><li><span>配置开发者接口（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section183452511917">TensorFlow开发者自定义接口</a>、<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section56271946125514">PyTorch开发者自定义接口</a>）。</span></li><li><span>搜索和训练网络结构（<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section05357228205">搜索训练</a>）。</span></li></ol> <div class="tiledSection"><h2 id="section193737375169">环境准备<i class="anchor-icon anchor-icon-link" anchorid="section193737375169" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section11862353121616" class="firsth2">Linux环境<i class="anchor-icon anchor-icon-link" anchorid="section11862353121616" tips="复制节点链接"></i></h3><ol><li><span>NASEA策略运行环境的依赖在如下的requirements中：</span><p></p><div _ngcontent-hei-c106="" class="highlight-div"><div _ngcontent-hei-c106="" class="highlight-div-header"><div _ngcontent-hei-c106="" class="highlight-div-header-left"><div _ngcontent-hei-c106="" class="handle-button expand-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hei-c106="" class="highlight-div-header-right"><div _ngcontent-hei-c106="" class="handle-button ai-button"></div><div _ngcontent-hei-c106="" class="handle-button line-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hei-c106="" class="handle-button theme-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hei-c106="" class="handle-button copy-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hei-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>tensorflow-gpu==2.8</li><li>ruamel.yaml==0.17.28</li><li>PyYAML==5.4.1</li><li>Cython==0.29.35</li><li>pymoo==0.3.2</li><li>pathlib</li><li>mpi4py==3.1.4</li><li>sklearn</li><li>opencv-python</li><li>matplotlib</li><li>numpy==1.23.5</li><li>tqdm==4.43.0</li><li>protobuf==3.20.3</li><li>requests==2.31.0</li><li>Pillow==7.1.2</li></ol></pre></div></div> <p>请使用pip或者conda安装上述依赖。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果仅需要在单机单卡运行工具，可跳过后续步骤。如需要单机多卡环境运行，请继续完成如下步骤。</p> </div></div></div> <p></p></li><li><span>安装并配置<a href="https://github.com/horovod/horovod#instal" target="_blank">Horovod</a>和Open MPI。</span></li><li><span>安装mpi4py。</span><p></p><div _ngcontent-hei-c106="" class="highlight-div"><div _ngcontent-hei-c106="" class="highlight-div-header"><div _ngcontent-hei-c106="" class="highlight-div-header-left"><div _ngcontent-hei-c106="" class="handle-button expand-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hei-c106="" class="highlight-div-header-right"><div _ngcontent-hei-c106="" class="handle-button ai-button"></div><div _ngcontent-hei-c106="" class="handle-button line-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hei-c106="" class="handle-button theme-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hei-c106="" class="handle-button copy-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hei-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>pip3 install mpi4py</li></ol></pre></div></div> <p></p></li><li><span>验证安装。</span><p></p><p class="MsoNormal">下载<a href="https://github.com/horovod/horovod/blob/master/examples/tensorflow/tensorflow_mnist.py" target="_blank">Horovod</a>官方对应的<a href="https://github.com/horovod/horovod/blob/master/examples/tensorflow/tensorflow_mnist.py" target="_blank">Demo</a>到当前目录。在一台服务器上利用4张加速卡运行如下命令：</p> <div _ngcontent-hei-c106="" class="highlight-div"><div _ngcontent-hei-c106="" class="highlight-div-header"><div _ngcontent-hei-c106="" class="highlight-div-header-left"><div _ngcontent-hei-c106="" class="handle-button expand-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hei-c106="" class="highlight-div-header-right"><div _ngcontent-hei-c106="" class="handle-button ai-button"></div><div _ngcontent-hei-c106="" class="handle-button line-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hei-c106="" class="handle-button theme-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hei-c106="" class="handle-button copy-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hei-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>horovodrun -np 4 -H localhost:4 python3 tensorflow_mnist.py</li></ol></pre></div></div> <p>若正常训练，则Horovod环境部署成功。</p> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section1766391819183">数据集准备<i class="anchor-icon anchor-icon-link" anchorid="section1766391819183" tips="复制节点链接"></i></h2><p>开发者根据需要准备数据集或代理数据集：</p> <ol><li><span>在user_module.py中定义数据集函数，并在该函数中接收scen.yaml传入的数据集路径。</span><p></p><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>TensorFlow版本中函数名为build_dataset_search，PyTorch版本中函数名为dataset_define。</p> </div></div></div> <p></p></li><li><span>解析数据集，读取图片和标签。根据is_training判断是训练还是评估模式。</span><p></p><ul><li>如果是训练模式，则dataset_dir传入scen.yaml中配置的train_dir目录。</li><li>如果是评估模式，则dataset_dir传入scen.yaml中配置的val_dir目录。</li></ul> <p></p></li><li><span>解析对应的数据并返回处理后的数据（具体接口定义参见<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section183452511917">TensorFlow开发者自定义接口</a>、<a href="/consumer/cn/doc/harmonyos-guides/cannkit-network-structure-search-training#section56271946125514">PyTorch开发者自定义接口</a>）。</span></li></ol> </div> <div class="tiledSection"><h2 id="section9753193220185">搜索参数配置<i class="anchor-icon anchor-icon-link" anchorid="section9753193220185" tips="复制节点链接"></i></h2><div class="p">开发者可配置合适的搜索参数，以达到较优的搜索结果。开发者需自行完成配置文件（可参考<span class="filepath">“tools_dopt/dopt_tf_py3/demo/nas_ea/ea_cls_imagenet/scen.yaml”</span>），如下示例：<div _ngcontent-hei-c106="" class="highlight-div"><div _ngcontent-hei-c106="" class="highlight-div-header"><div _ngcontent-hei-c106="" class="highlight-div-header-left"><div _ngcontent-hei-c106="" class="handle-button expand-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hei-c106="" class="highlight-div-header-right"><div _ngcontent-hei-c106="" class="handle-button ai-button"></div><div _ngcontent-hei-c106="" class="handle-button line-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hei-c106="" class="handle-button theme-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hei-c106="" class="handle-button copy-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hei-c106="" class="highlight-scroll-div"><pre class="yaml prettyprint linenums hljs language-yaml" hw-language="yaml" data-highlighted="yes"><ol class="linenums"><li><em><span class="hljs-comment">## Network architecture search scenario</span></em></li><li><span class="hljs-attr">scenario:</span></li><li>  <span class="hljs-attr">strategy:</span></li><li>    <span class="hljs-attr">name:</span>                <span class="hljs-string">NASEA</span></li><li>    <span class="hljs-attr">framework:</span>           <span class="hljs-string">Tensorflow</span></li><li>    <span class="hljs-attr">batch_size:</span>          <span class="hljs-number">128</span></li><li>    <span class="hljs-attr">epochs:</span>              <span class="hljs-number">60</span></li><li>    <span class="hljs-attr">constraint:</span></li><li>      <span class="hljs-attr">application_type:</span>  <span class="hljs-string">"image_classification"</span></li><li>      <span class="hljs-attr">constraint_type:</span>   <span class="hljs-string">"size"</span></li><li>      <span class="hljs-attr">constraint_value:</span>  <span class="hljs-number">11000000</span></li><li>    <span class="hljs-attr">supernet:</span></li><li>      <span class="hljs-attr">input_shape:</span>       <span class="hljs-string">(224,</span> <span class="hljs-number">224</span><span class="hljs-string">,</span> <span class="hljs-number">3</span><span class="hljs-string">)</span> </li><li>      <span class="hljs-attr">data_format:</span>       <span class="hljs-string">"channels_last"</span> </li><li>      <span class="hljs-attr">filters:</span>           [<span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>] </li><li>      <span class="hljs-attr">strides:</span>           [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>] </li><li>      <span class="hljs-attr">feature_choose:</span>    [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>]</li><li>    <span class="hljs-attr">optimizer:</span></li><li>      <span class="hljs-attr">weights_optimizer:</span></li><li>        <span class="hljs-attr">type:</span>            <span class="hljs-string">"Adam"</span></li><li>        <span class="hljs-attr">betas:</span>           [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.999</span>]</li><li>        <span class="hljs-attr">learning_rate:</span>   <span class="hljs-number">0.0001</span></li><li>    <span class="hljs-attr">dataset:</span></li><li>      <span class="hljs-string">pre_train_dir：</span>   <span class="hljs-string">"/tmp/tfrecords"</span></li><li>      <span class="hljs-attr">train_dir:</span>        <span class="hljs-string">"/tmp/ImageNet_tf/"</span></li><li>      <span class="hljs-attr">val_dir:</span>          <span class="hljs-string">"/tmp/ImageNet_tf/"</span></li><li>    <span class="hljs-attr">searcher:</span></li><li>      <span class="hljs-attr">generation_num:</span>    <span class="hljs-number">100</span></li><li>      <span class="hljs-attr">pop_size:</span>          <span class="hljs-number">40</span></li><li>    <span class="hljs-attr">resource:</span></li><li>      <span class="hljs-attr">name:</span>              <span class="hljs-string">Tensorflow_standalone</span></li><li>      <span class="hljs-attr">gpu_id:</span>            <span class="hljs-number">0</span><span class="hljs-string">,1,2,3,4,5,6,7</span></li></ol></pre></div></div> </div> </div> <p class="msonormal">参数说明如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.1.6.1.1" valign="top" width="16.73%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.6.1.2" valign="top" width="11.77%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.6.1.3" valign="top" width="23.22%"><p>取值范围</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.6.1.4" valign="top" width="7.46%"><p>是否必选</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.6.1.5" valign="top" width="40.82%"><p>参数描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>name</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>NASEA</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>策略名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>framework</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>TensorFlow、PyTorch</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>训练框架</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>batch_size</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>int</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>数据集的batch_size。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>epochs</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>int</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>数据集轮询次数。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.supernet</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>input_shape</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>tuple</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>模型输入shape的CHW或HWC的维度，默认值：(224, 224, 3)。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>data_format</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>channels_first/channels_last</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>数据格式，input_shape和data_format取值需要对应，例："channels_last"。在PyTorch版本中，该参数只支持channels_first选项。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>filters</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>list</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>搜索骨架每层的cout，与strides对应的列表，格式为[cout, ..., cout]，例：[64, 64, 128, 128, 256, 256]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>strides</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>list</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>搜索骨架每层使用的stride，例：[1, 1, 2, 1, 2, 1]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>feature_choose</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>list</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>需要融合的待搜索层，以逗号分隔，从0开始计数。例：融合第4、6层：[3, 5]。</p> <p>该参数当前仅适用于TensorFlow版本的检测场景和PyTorch版本的分割场景。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.constraint</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>application_type</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>image_classification/object_detection/ semantic_segmentation</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>应用类型，支持分类、检测和分割场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>constraint_type</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>size/flops/latency</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>模型约束类型。目前“latency”约束仅支持TensorFlow版本的分类场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>constraint_value</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>int, float</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>模型约束取值，整个网络的大小。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>processor_version</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>npu_v1</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>该参数目前仅支持模型约束类型为"latency"的场景。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.optimizer</strong></p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.optimizer.weights_optimizer</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>type</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>SGD/Momentum/Adam</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>优化器<sup>[1]</sup>，分类检测默认值："Adam"，分割默认值："Momentum"。在PyTorch版本中，目前仅支持"SGD"和"Adam"两种优化器，分类场景和分割场景的默认优化器为"Adam"。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>betas</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>list</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>(0, 1)</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>衰减因子，Adam优化器参数，默认值：[0.9, 0.999]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>learning_rate</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>(0, 1)</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>学习率，多GPU时工具会自动翻倍，分类检测默认值：0.0001，分割默认值：0.00001。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>momentum</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>float</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>(0, 1)</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>动量，Momentum优化器参数，默认值：0.9。该参数目前仅支持TensorFlow版本。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.dataset</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>pre_train_dir</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>检测和分割场景为<strong>必选项</strong>，分类场景无需此字段，预训练数据集路径或预训练生成的ckpt路径（参见注释[2]）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>train_dir</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>训练数据集路径。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>val_dir</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>验证数据集路径。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.strategy.searcher</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>generation_num</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>int</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>进化算法的代数，例：100。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>pop_size</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>int</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>进化算法的种群数量，默认值：40。</p> </td> </tr> <tr><td class="cellrowborder" colspan="5" valign="top"><p><strong>scenario.resource</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>name</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>Tensorflow_standalone/ pytorch_standalone</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>资源对象名称。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.73%"><p>gpu_id</p> </td> <td class="cellrowborder" valign="top" width="11.77%"><p>string</p> </td> <td class="cellrowborder" valign="top" width="23.22%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="7.46%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="40.82%"><p>指定使用的gpuID。</p> <ul><li>填写一个gpu id，如0，则使用单机单卡模式进行训练。</li><li>填写多个gpu id，如0, 1, 2, 3，则使用单机多卡模型进行训练。</li></ul> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p class="msonormal">[1] 优化器类型支持SGD，Momentum和Adam三种优化器类型。</p> <ul><li>SGD优化器，支持learning_rate参数。</li><li>Momentum优化器，支持momentum、learning_rate参数。PyTorch版本目前不支持该优化器。</li><li>Adam优化器，支持betas、learning_rate参数，betas的形式为list，list中索引为0的元素为beta1，索引为1的元素为beta2。</li></ul> <p>[2] 当没有预训练的ckpt文件时，其取值为预训练数据集的目录路径；当有预训练的ckpt文件时，其取值为ckpt所在的目录路径。</p> </div></div></div> <div class="tiledSection"><h2 id="section183452511917">TensorFlow开发者自定义接口<i class="anchor-icon anchor-icon-link" anchorid="section183452511917" tips="复制节点链接"></i></h2><p>网络结构搜索基于TensorFlow框架进行训练，开发者需要按照如下的接口定义配置模型训练文件。</p> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>仅支持tf.keras实现。</p> </div></div></div> <div class="tiledSection"><h3 id="section412821151614" class="firsth2">UserModule类<i class="anchor-icon anchor-icon-link" anchorid="section412821151614" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.12.2.1.3.1.1" valign="top" width="26.26%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>class <strong>UserModule</strong> - 定义开发者侧接口。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.12.2.1.3.2.1" valign="top" width="26.26%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>构造函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.12.2.1.3.3.1" valign="top" width="26.26%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="73.74000000000001%"><p>def <strong>__init__</strong>(self, epoch, batch_size)</p> </td> </tr>  </tbody></table></div> </div> <p>此类用于定义搜索过程中的以下几个函数：</p> </div> <ul><li>数据集读取。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.13.1.1.1.3.1.1" valign="top" width="28.96%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.04%"><p>数据集读取函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.1.1.1.3.2.1" valign="top" width="28.96%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="71.04%"><p>分类场景：</p> <p>def <strong>build_dataset_search</strong>(self, dataset_dir, is_training)</p> <p>检测、分割场景：</p> <p>def <strong>build_dataset_search</strong>(self, dataset_dir, is_training, is_shuffle)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.1.1.1.3.3.1" valign="top" width="28.96%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.04%"><p>dataset_dir：数据集路径。当前is_training为True时传入scen.yaml中配置的train_dir路径，否则传入scen.yaml中配置的val_dir路径。</p> <p>is_training：训练时为True； 推理时为False。</p> <p>is_shuffle：数据集是否需要shuffle。提示：在evaluation阶段更新bn时，数据集不需要做shuffle。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.1.1.1.3.4.1" valign="top" width="28.96%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="71.04%"><ul><li>训练流程<p>分类、分割场景：</p> <p>dataset: TensorFlow数据集。</p> <p>data_num: 数据集图片数量。</p> <p>检测场景：</p> <p>train_generator：训练集生成器。</p> <p>train_dataset_size：训练集数量。</p> </li></ul> <ul><li>推理流程<p>分类、分割场景：</p> <p>dataset: TensorFlow数据集。</p> <p>data_num: 数据集图片数量。</p> <p>检测场景：</p> <p>val_generator：验证集生成器。</p> <p>val_dataset：解析json文件后的数据集。</p> <p>val_dataset_size：验证集数量。</p> </li></ul> </td> </tr>  </tbody></table></div> </div> </li><li>学习率更新策略。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.13.2.1.1.3.1.1" valign="top" width="28.63%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>学习率更新策略函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.2.1.1.3.2.1" valign="top" width="28.63%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>def <strong>lr_scheduler</strong>(self, lr_init, global_step)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.2.1.1.3.3.1" valign="top" width="28.63%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>lr_init：学习率的初始值。</p> <p>global_step：TensorFlow的global step。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.2.1.1.3.4.1" valign="top" width="28.63%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>已更新的学习率。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>推荐将学习率的初始值设为常数。</p> </div></div></div> </li><li>评估函数。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.13.3.1.1.3.1.1" valign="top" width="28.63%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>评估函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.3.1.1.3.2.1" valign="top" width="28.63%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>def <strong>metrics_op</strong>(self, inputs, outputs)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.3.1.1.3.3.1" valign="top" width="28.63%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><ul><li>分类、分割场景<p>inputs：真值标签(ground truth labels)。</p> <p>outputs：前向推理的结果。</p> </li></ul> <ul><li>检测场景<p>inputs: [valid_dir, model]</p> <p>valid_dir：验证集路径。</p> <p>model：网络模型。</p> <p>outputs： [data_generator, proxy_val_image_ids, data_size]</p> <p>data_generator：数据集生成器。</p> <p>proxy_val_image_ids：代理验证集图片索引，用于从验证集中挑选出一个子集，以加快评估效率。</p> <p>data_size：数据集大小。</p> </li></ul> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.3.1.1.3.4.1" valign="top" width="28.63%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>评估结果。</p> </td> </tr>  </tbody></table></div> </div> </li><li>loss计算函数。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.13.4.1.1.3.1.1" valign="top" width="28.63%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>loss计算函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.4.1.1.3.2.1" valign="top" width="28.63%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>def <strong>loss_op</strong>(self, labels, logits)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.4.1.1.3.3.1" valign="top" width="28.63%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>labels：真值标签(ground truth labels)。</p> <p>logits：前向推理的结果。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.13.4.1.1.3.4.1" valign="top" width="28.63%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="71.37%"><p>loss值，tensor。</p> </td> </tr>  </tbody></table></div> </div> </li></ul> <div class="tiledSection"><h3 id="section1251917352179">PreNet类<i class="anchor-icon anchor-icon-link" anchorid="section1251917352179" tips="复制节点链接"></i></h3><p>模型中输入层不需要搜索，因此通过固定网络结构的形式定义。</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.15.1.3.1.1" valign="top" width="29.15%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>Class <strong>PreNet </strong>- 模型输入层。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.2.1" valign="top" width="29.15%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>PreNet构造函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.3.1" valign="top" width="29.15%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>def <strong>__init__</strong>(self)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.4.1" valign="top" width="29.15%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>NA。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.5.1" valign="top" width="29.15%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>NA。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.6.1" valign="top" width="29.15%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>构建模型的输入结构。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.7.1" valign="top" width="29.15%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>def <strong>call</strong>(self, inputs, training=True)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.8.1" valign="top" width="29.15%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>inputs：输入数据。</p> <p>training：训练时为True； 推理时为False。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.15.1.3.9.1" valign="top" width="29.15%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>搜索骨架的输入，tensor。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section871910541812">PostNet类<i class="anchor-icon anchor-icon-link" anchorid="section871910541812" tips="复制节点链接"></i></h3><p>模型中输出层不需要搜索，因此通过固定网络结构的形式定义。</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.17.1.3.1.1" valign="top" width="29.15%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>Class <strong>PostNet</strong> - 模型输出层。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.2.1" valign="top" width="29.15%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>PostNet构造函数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.3.1" valign="top" width="29.15%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>def <strong>__init__</strong>(self)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.4.1" valign="top" width="29.15%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>NA。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.5.1" valign="top" width="29.15%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>NA。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.6.1" valign="top" width="29.15%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>构建模型的输出结构。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.7.1" valign="top" width="29.15%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>def<strong> call</strong>(self, inputs, training=True)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.8.1" valign="top" width="29.15%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>inputs：搜索骨架的输出。</p> <p>training：训练时为True； 推理时为False。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.17.1.3.9.1" valign="top" width="29.15%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.85000000000001%"><p>模型输出，tensor。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section56271946125514">PyTorch开发者自定义接口<i class="anchor-icon anchor-icon-link" anchorid="section56271946125514" tips="复制节点链接"></i></h2><p>网络结构搜索基于PyTorch框架进行训练，开发者需要按照如下的接口定义配置模型训练文件。</p> </div> <div class="tiledSection"><h3 id="section679125092719" class="firsth2">UserModule类<i class="anchor-icon anchor-icon-link" anchorid="section679125092719" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>UserModule类</caption><tbody><tr><th class="firstcol" id="mcps1.3.19.2.2.3.1.1" valign="top" width="29.5%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>class <strong>UserModule</strong> - 定义开发者侧接口</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.2.2.3.2.1" valign="top" width="29.5%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>构造函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.2.2.3.3.1" valign="top" width="29.5%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>def <strong>__init__</strong>(self, epoch, batch_size)</p> </td> </tr>  </tbody></table></div> </div> <p>此类用于定义搜索过程中的以下几个函数：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>数据集读取</caption><tbody><tr><th class="firstcol" id="mcps1.3.19.4.2.3.1.1" valign="top" width="29.59%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>数据集读取函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.4.2.3.2.1" valign="top" width="29.59%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>def <strong>dataset_define</strong>(self, dataset_dir, is_training)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.4.2.3.3.1" valign="top" width="29.59%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>dataset_dir：数据集路径，当前is_training为True时传入scen.yaml中配置的train_dir路径，否则传入scen.yaml中配置的val_dir路径。</p> <p>is_training：训练时为True； 推理时为False。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.4.2.3.4.1" valign="top" width="29.59%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>PyTorch的torch.utils.data.Dataset对象实例。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>学习率更新策略</caption><tbody><tr><th class="firstcol" id="mcps1.3.19.5.2.3.1.1" valign="top" width="29.849999999999998%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>学习率更新策略函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.5.2.3.2.1" valign="top" width="29.849999999999998%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>def <strong>scheduler_define</strong>(self, optimizer, steps_per_epoch)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.5.2.3.3.1" valign="top" width="29.849999999999998%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>optimizer：优化器对象实例。</p> <p>steps_per_epoch：训练过程中每个epoch的步数。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.5.2.3.4.1" valign="top" width="29.849999999999998%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>PyTorch的lr_scheduler对象实例。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表4 </b>评估函数</caption><tbody><tr><th class="firstcol" id="mcps1.3.19.6.2.3.1.1" valign="top" width="29.849999999999998%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>评估函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.6.2.3.2.1" valign="top" width="29.849999999999998%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>def <strong>metrics_func</strong>(self, eval_dataloader, eval_function)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.6.2.3.3.1" valign="top" width="29.849999999999998%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><ul><li>eval_dataloader：PyTorch的Dataloader对象，用于加载验证数据集。</li><li>eval_function：前向推理函数，eval_dataloader中加载的数据输入到该函数中可以得到对应的推理结果。</li></ul> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.6.2.3.4.1" valign="top" width="29.849999999999998%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.15%"><p>评估结果。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表5 </b>loss计算函数</caption><tbody><tr><th class="firstcol" id="mcps1.3.19.7.2.3.1.1" valign="top" width="29.59%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>loss计算函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.7.2.3.2.1" valign="top" width="29.59%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>def <strong>loss_func</strong>(self, labels, logits)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.7.2.3.3.1" valign="top" width="29.59%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>labels：数据的真实标签。</p> <p>logits：前向推理的结果。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.19.7.2.3.4.1" valign="top" width="29.59%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.41%"><p>loss值。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section385165022717">PreNet类<i class="anchor-icon anchor-icon-link" anchorid="section385165022717" tips="复制节点链接"></i></h3><p>模型中输入层不需要搜索，因此通过固定网络结构的形式定义。</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.21.1.3.1.1" valign="top" width="29.409999999999997%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>Class <strong>PreNet </strong>- 模型输入层</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.2.1" valign="top" width="29.409999999999997%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>PreNet构造函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.3.1" valign="top" width="29.409999999999997%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>def <strong>__init__</strong>(self)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.4.1" valign="top" width="29.409999999999997%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>NA</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.5.1" valign="top" width="29.409999999999997%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>NA</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.6.1" valign="top" width="29.409999999999997%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>构建模型的输入结构。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.7.1" valign="top" width="29.409999999999997%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>def <strong>forward</strong>(self, inputs)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.8.1" valign="top" width="29.409999999999997%"><p><strong>参数</strong><strong>描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>inputs：输入数据。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.21.1.3.9.1" valign="top" width="29.409999999999997%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.59%"><p>搜索骨架的输入，tensor。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section38765013274">PostNet类<i class="anchor-icon anchor-icon-link" anchorid="section38765013274" tips="复制节点链接"></i></h3><p>模型中输出层不需要搜索，因此通过固定网络结构的形式定义。</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th class="firstcol" id="mcps1.3.23.1.3.1.1" valign="top" width="29.5%"><p><strong>类描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>Class <strong>PostNet</strong> - 模型输出层</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.2.1" valign="top" width="29.5%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>PostNet构造函数</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.3.1" valign="top" width="29.5%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>def <strong>__init__</strong>(self)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.4.1" valign="top" width="29.5%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>NA</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.5.1" valign="top" width="29.5%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>NA</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.6.1" valign="top" width="29.5%"><p><strong>函数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>构建模型的输出结构</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.7.1" valign="top" width="29.5%"><p><strong>接口定义</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>def<strong> forward</strong>(self, inputs)</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.8.1" valign="top" width="29.5%"><p><strong>参数描述</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>inputs：搜索骨架的输出，如果开发者在scen.yaml中没有配置feature_choose，那么inputs是一个tensor；如果开发者配置了scen.yaml中的feature_choose参数，那么inputs是一个列表，其内容依次为feature_choose中配置的对应层的输出以及搜索骨架最后一层的输出。</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.23.1.3.9.1" valign="top" width="29.5%"><p><strong>返回值</strong></p> </th> <td class="cellrowborder" valign="top" width="70.5%"><p>模型输出，tensor。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section05357228205">搜索训练<i class="anchor-icon anchor-icon-link" anchorid="section05357228205" tips="复制节点链接"></i></h2><p>主要从以下三个方面介绍工具的训练入口，维测方式以及搜索结果展示。</p> </div> <div class="tiledSection"><h3 id="section09271415206" class="firsth2">训练入口<i class="anchor-icon anchor-icon-link" anchorid="section09271415206" tips="复制节点链接"></i></h3><p>TensorFlow开发者执行<span class="filepath">“python3 tools_dopt/dopt_tf_py3/dopt_so.py -c scen.yaml”</span>，即开启搜索训练；PyTorch开发者执行<span class="filepath">“python3 tools_dopt/dopt_pytorch_py3/dopt_so.py -c scen.yaml”</span>。针对每种场景都有对应的demo目录入口，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-examples#section1897718597348">TensorFlow NASEA网络结构搜索Demo</a>。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>在执行上述命令时，工具将在当前目录下查找user_module.py文件。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section20368181119216">维测方式<i class="anchor-icon anchor-icon-link" anchorid="section20368181119216" tips="复制节点链接"></i></h3><p>搜索训练过程可以利用<a href="https://www.tensorflow.org/tensorboard?hl=zh-cn" target="_blank">TensorBoard</a>进行观测中间信息，生成的信息文件保存在log_*目录。</p> </div> <ul><li>loss-模型精度损失loss曲线<p><span><img height="179.912957" originheight="523" originwidth="1522" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114255.53456712099111517329127422176859:50001231000000:2800:4411DBE942565076D2E4B6B5AB152B273A30AECA103DE301426CB54ECFB95F16.png" title="点击放大" width="523.621"></span></p> </li><li>lr-学习率变化曲线<p><span><img height="181.502307" originheight="528" originwidth="1523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114255.40827970052761508597049366169290:50001231000000:2800:B75914DFF0E3A9978FB8BE6A4269656C9CEF749B23EB637CAE6F1958171A695D.png" title="点击放大" width="523.621"></span></p> </li><li>pareto-帕累托前沿图<p><span><img height="385.05840800000004" originheight="753" originwidth="1024" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114255.52184620454245032288324648073452:50001231000000:2800:7A99A7898A594298E7EDED162F5C16917F6B75255D64D81712DBFD73D7CB16C7.png" title="点击放大" width="523.621"></span></p> </li></ul> <p>帕累托图横坐标为模型大小或计算量即约束项，纵坐标为结构搜索后的精度。图中的精度为搜索过程的评估结果，如果要获得更好的精度，建议对搜索结构进行充分训练。</p> <p>搜索模型结构具有不同的精度、参数量/计算量/时延，开发者可根据实际需求选择合适的模型。</p> <div class="tiledSection"><h3 id="section463643318211">搜索结果展示<i class="anchor-icon anchor-icon-link" anchorid="section463643318211" tips="复制节点链接"></i></h3><p>搜索结束后，工具会自动将pareto图中模型结构保存在results目录，生成多个model_arch_result_$NUM.py文件。其中$NUM文件编号与pareto图上的编号一致，头部有model_param_size和accuracy，开发者可根据TensorBoard中的pareto图或者这两个参数选择合适的网络结构，例如TensorFlow版本的搜索结果（PyTorch版本的搜索结果只是实现框架不同，不再赘述）如下图所示：</p> </div> <p><span><img height="647.4388130000001" originheight="915" originwidth="740" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114255.72774856288228912079795551487419:50001231000000:2800:4758D2612D92A18967914EA82050CAC7880F9A51B4B794B7FCBC59F39C3C1FC0.png" title="点击放大" width="523.621"></span></p> <p>开发者选定合适的模型结构文件，可以拷贝到results的上一级目录，并执行模型结构文件。</p> <div _ngcontent-hei-c106="" class="highlight-div"><div _ngcontent-hei-c106="" class="highlight-div-header"><div _ngcontent-hei-c106="" class="highlight-div-header-left"><div _ngcontent-hei-c106="" class="handle-button expand-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hei-c106="" class="highlight-div-header-right"><div _ngcontent-hei-c106="" class="handle-button ai-button"></div><div _ngcontent-hei-c106="" class="handle-button line-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hei-c106="" class="handle-button theme-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hei-c106="" class="handle-button copy-button"><div _ngcontent-hei-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hei-c106="" class="highlight-scroll-div"><pre class="console prettyprint linenums hljs language-shell" hw-language="console" data-highlighted="yes"><ol class="linenums"><li>python3 model_arch_result_$NUM.py</li></ol></pre></div></div> <p>执行结束后，当前目录下会生成模型的pb文件和TensorBoard日志文件，开发者可通过TensorBoard查看模型的图结构。如下：</p> <p><span><img height="989.9760570000001" originheight="1515" originwidth="595" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114255.08180776399158246149696068322926:50001231000000:2800:49B47314224B608F0D1013AF1F67CEED58B589D058D7D870726F2C887A7BAAA9.png" title="点击放大" width="389.02500000000003"></span></p> </div> <div></div></div>