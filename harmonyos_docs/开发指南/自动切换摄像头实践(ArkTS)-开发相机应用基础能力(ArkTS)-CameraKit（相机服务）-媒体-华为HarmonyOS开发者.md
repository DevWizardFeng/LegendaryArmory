<h1 _ngcontent-dcb-c119="" class="doc-title ng-star-inserted" title="自动切换摄像头实践(ArkTS)"> 自动切换摄像头实践(ArkTS) </h1>

<div _ngcontent-dcb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本文档仅针对折叠屏设备自动切换前置摄像头的场景。在不同折叠状态下，自动切换到当前状态支持的摄像头。</p>    <p>例如：折叠设备A拥有三颗摄像头：后置摄像头B、前置摄像头C和前置摄像头D。在展开状态下，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedcameras" target="_blank">CameraManager.getSupportedCameras</a>接口可获取到后置摄像头B和前置摄像头C。在折叠状态下，可获取到后置摄像头B和前置摄像头D。在当前折叠状态下启用前置摄像头，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-autodeviceswitch#enableautodeviceswitch13" target="_blank">enableAutoDeviceSwitch</a>开启自动切换镜头。这样，在下次折叠屏状态变化时，会自动切换到对应折叠状态下的前置摄像头。</p>    <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera" target="_blank">Camera API参考</a>。</p>    <p>Context获取方式请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-usage#获取uiability的上下文信息">获取UIAbility的上下文信息</a>。</p>    <p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p>    <div class="tiledSection">     <h2 id="导入相关依赖">导入相关依赖<i class="anchor-icon anchor-icon-link" anchorid="导入相关依赖" tips="复制节点链接"></i></h2>          <div _ngcontent-dcb-c106="" class="highlight-div"><div _ngcontent-dcb-c106="" class="highlight-div-header"><div _ngcontent-dcb-c106="" class="highlight-div-header-left"><div _ngcontent-dcb-c106="" class="handle-button expand-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcb-c106="" class="highlight-div-header-right"><div _ngcontent-dcb-c106="" class="handle-button ai-button"></div><div _ngcontent-dcb-c106="" class="handle-button line-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcb-c106="" class="handle-button theme-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcb-c106="" class="handle-button copy-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="创建xcomponent">创建XComponent<i class="anchor-icon anchor-icon-link" anchorid="创建xcomponent" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>展示摄像头的预览画面。</p>     <div _ngcontent-dcb-c106="" class="highlight-div"><div _ngcontent-dcb-c106="" class="highlight-div-header"><div _ngcontent-dcb-c106="" class="highlight-div-header-left"><div _ngcontent-dcb-c106="" class="handle-button expand-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcb-c106="" class="highlight-div-header-right"><div _ngcontent-dcb-c106="" class="handle-button ai-button"></div><div _ngcontent-dcb-c106="" class="handle-button line-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcb-c106="" class="handle-button theme-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcb-c106="" class="handle-button copy-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mCameraPosition</span>: camera.<span class="hljs-property">CameraPosition</span> = camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentOptions</span>: <span class="hljs-title class_">XComponentOptions</span> = {</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>    <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadXComponent</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">//初始化XComponent。</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-title class_">XComponent</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentOptions</span>)</li><li>        .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadXComponent</span>();</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1080</span>))</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1920</span>))</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'切换相机'</span>)</li><li>        .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">48</span> })</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">24</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span> === camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span> ?</li><li>            camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_FRONT</span> : camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>          <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadXComponent</span>();</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开启自动切换摄像头">开启自动切换摄像头<i class="anchor-icon anchor-icon-link" anchorid="开启自动切换摄像头" tips="复制节点链接"></i></h2>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-autodeviceswitch#enableautodeviceswitch13" target="_blank">enableAutoDeviceSwitch</a>接口前需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-autodeviceswitchquery#isautodeviceswitchsupported13" target="_blank">isAutoDeviceSwitchSupported</a>接口查询当前设备是否支持自动切换摄像头能力。</p>     <div _ngcontent-dcb-c106="" class="highlight-div"><div _ngcontent-dcb-c106="" class="highlight-div-header"><div _ngcontent-dcb-c106="" class="highlight-div-header-left"><div _ngcontent-dcb-c106="" class="handle-button expand-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcb-c106="" class="highlight-div-header-right"><div _ngcontent-dcb-c106="" class="handle-button ai-button"></div><div _ngcontent-dcb-c106="" class="handle-button line-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcb-c106="" class="handle-button theme-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcb-c106="" class="handle-button copy-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">enableAutoDeviceSwitch</span>(<span class="hljs-params">session: camera.PhotoSession</span>) {</li><li>  <span class="hljs-keyword">if</span> (session.<span class="hljs-title function_">isAutoDeviceSwitchSupported</span>()) {</li><li>    session.<span class="hljs-title function_">enableAutoDeviceSwitch</span>(<span class="hljs-literal">true</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="监听或解监听自动切换摄像头状态">监听或解监听自动切换摄像头状态<i class="anchor-icon anchor-icon-link" anchorid="监听或解监听自动切换摄像头状态" tips="复制节点链接"></i></h2>          <p>可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photosession#onautodeviceswitchstatuschange13" target="_blank">enableAutoDeviceSwitch</a>监听自动切换摄像头的结果。系统自动切换镜头结束后会触发该回调。</p>     <p>自动切换摄像头期间，禁止调用任何session相关接口。</p>     <div _ngcontent-dcb-c106="" class="highlight-div"><div _ngcontent-dcb-c106="" class="highlight-div-header"><div _ngcontent-dcb-c106="" class="highlight-div-header-left"><div _ngcontent-dcb-c106="" class="handle-button expand-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcb-c106="" class="highlight-div-header-right"><div _ngcontent-dcb-c106="" class="handle-button ai-button"></div><div _ngcontent-dcb-c106="" class="handle-button line-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcb-c106="" class="handle-button theme-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcb-c106="" class="handle-button copy-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">err: BusinessError, autoDeviceSwitchStatus: camera.AutoDeviceSwitchStatus</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Callback Error, errorCode: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`isDeviceSwitched: <span class="hljs-subst">${autoDeviceSwitchStatus.isDeviceSwitched}</span>, isDeviceCapabilityChanged: <span class="hljs-subst">${autoDeviceSwitchStatus.isDeviceCapabilityChanged}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">registerAutoDeviceSwitchStatus</span>(<span class="hljs-params">photoSession: camera.PhotoSession</span>): <span class="hljs-built_in">void</span> {</li><li>  photoSession.<span class="hljs-title function_">on</span>(<span class="hljs-string">'autoDeviceSwitchStatusChange'</span>, callback);</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">unregisterAutoDeviceSwitchStatus</span>(<span class="hljs-params">photoSession: camera.PhotoSession</span>): <span class="hljs-built_in">void</span> {</li><li>  photoSession.<span class="hljs-title function_">off</span>(<span class="hljs-string">'autoDeviceSwitchStatusChange'</span>, callback);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例代码">完整示例代码<i class="anchor-icon anchor-icon-link" anchorid="完整示例代码" tips="复制节点链接"></i></h2>          <div _ngcontent-dcb-c106="" class="highlight-div"><div _ngcontent-dcb-c106="" class="highlight-div-header"><div _ngcontent-dcb-c106="" class="highlight-div-header-left"><div _ngcontent-dcb-c106="" class="handle-button expand-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcb-c106="" class="highlight-div-header-right"><div _ngcontent-dcb-c106="" class="handle-button ai-button"></div><div _ngcontent-dcb-c106="" class="handle-button line-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcb-c106="" class="handle-button theme-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcb-c106="" class="handle-button copy-button"><div _ngcontent-dcb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcb-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'AutoSwitchCameraDemo '</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">reloadXComponentFlag</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentOptions</span>: <span class="hljs-title class_">XComponentOptions</span> = {</li><li>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>    <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mSurfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mCameraPosition</span>: camera.<span class="hljs-property">CameraPosition</span> = camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mCameraManager</span>: camera.<span class="hljs-property">CameraManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">curCameraDevice</span>: camera.<span class="hljs-property">CameraDevice</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mCameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mPreviewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mPhotoSession</span>: camera.<span class="hljs-property">PhotoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-comment">// One of the recommended preview resolutions.</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">previewProfileObj</span>: camera.<span class="hljs-property">Profile</span> = {</li><li>    <span class="hljs-attr">format</span>: <span class="hljs-number">1003</span>,</li><li>    <span class="hljs-attr">size</span>: {</li><li>      <span class="hljs-attr">width</span>: <span class="hljs-number">1920</span>,</li><li>      <span class="hljs-attr">height</span>: <span class="hljs-number">1080</span></li><li>    }</li><li>  };</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mContext</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">autoDeviceSwitchCallback</span>: <span class="hljs-function">(<span class="hljs-params">err: BusinessError, autoDeviceSwitchStatus: camera.AutoDeviceSwitchStatus</span>) =&gt;</span> <span class="hljs-built_in">void</span> =</li><li>    <span class="hljs-function">(<span class="hljs-params">err: BusinessError, autoDeviceSwitchStatus: camera.AutoDeviceSwitchStatus</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> Callback Error, errorCode: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span> isDeviceSwitched: <span class="hljs-subst">${autoDeviceSwitchStatus.isDeviceSwitched}</span>, isDeviceCapabilityChanged: <span class="hljs-subst">${autoDeviceSwitchStatus.isDeviceCapabilityChanged}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">requestPermissionsFn</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mContext</span>, [</li><li>      <span class="hljs-string">'ohos.permission.CAMERA'</span></li><li>    ]).<span class="hljs-title function_">then</span>((): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = <span class="hljs-literal">true</span>;</li><li>    }).<span class="hljs-title function_">catch</span>((<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">`ohos.permission.CAMERA no permission, error: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initContext</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> uiContext = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mContext</span> = uiContext.<span class="hljs-title function_">getHostContext</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initCameraManager</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mContext</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getCameraManager failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'aboutToAppear is called'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initContext</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissionsFn</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCameraManager</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mSurfaceId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// 停止当前会话。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>?.<span class="hljs-title function_">stop</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to stop session, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放相机输入流。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraInput</span>?.<span class="hljs-title function_">close</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to close device, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 释放预览输出流。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPreviewOutput</span>?.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to release previewOutput, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPreviewOutput</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>?.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to release photoSession, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 会话置空。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadXComponent</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mSurfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">`mCameraPosition: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.mCameraPosition}</span>`</span>)</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mSurfaceId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getPreviewProfile</span>(<span class="hljs-attr">cameraOutputCapability</span>: camera.<span class="hljs-property">CameraOutputCapability</span>): camera.<span class="hljs-property">Profile</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> previewProfiles = cameraOutputCapability.<span class="hljs-property">previewProfiles</span>;</li><li>    <span class="hljs-keyword">if</span> (previewProfiles.<span class="hljs-property">length</span> &lt; <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> index = previewProfiles.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">previewProfile: camera.Profile</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewProfileObj</span>.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> &amp;&amp;</li><li>        previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewProfileObj</span>.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> &amp;&amp;</li><li>        previewProfile.<span class="hljs-property">format</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewProfileObj</span>.<span class="hljs-property">format</span>;</li><li>    })</li><li>    <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> previewProfiles[index];</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initCamera</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">cameraPosition</span>: camera.<span class="hljs-property">CameraPosition</span>,</li><li>    <span class="hljs-attr">connectionType</span>: camera.<span class="hljs-property">ConnectionType</span> = camera.<span class="hljs-property">ConnectionType</span>.<span class="hljs-property">CAMERA_CONNECTION_BUILT_IN</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>    <span class="hljs-comment">// 创建CameraManager对象。</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'camera.getCameraManager error'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机列表。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>    <span class="hljs-keyword">if</span> (cameraArray.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'cameraManager.getSupportedCameras error'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; cameraArray.<span class="hljs-property">length</span>; index++) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'cameraId : '</span> + cameraArray[index].<span class="hljs-property">cameraId</span>); <span class="hljs-comment">// 获取相机ID。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'cameraPosition : '</span> + cameraArray[index].<span class="hljs-property">cameraPosition</span>); <span class="hljs-comment">// 获取相机位置。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'cameraType : '</span> + cameraArray[index].<span class="hljs-property">cameraType</span>); <span class="hljs-comment">// 获取相机类型。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'connectionType : '</span> + cameraArray[index].<span class="hljs-property">connectionType</span>); <span class="hljs-comment">// 获取相机连接类型。</span></li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> deviceIndex = cameraArray.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">cameraDevice: camera.CameraDevice</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">return</span> cameraDevice.<span class="hljs-property">cameraPosition</span> === cameraPosition &amp;&amp; cameraDevice.<span class="hljs-property">connectionType</span> === connectionType;</li><li>    })</li><li>    <span class="hljs-comment">// 没有找到对应位置的摄像头，可选择其他摄像头，具体场景具体对待。</span></li><li>    <span class="hljs-keyword">if</span> (deviceIndex === -<span class="hljs-number">1</span>) {</li><li>      deviceIndex = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'not found camera'</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">curCameraDevice</span> = cameraArray[deviceIndex];</li><li>
</li><li>    <span class="hljs-comment">// 创建相机输入流。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">createCameraInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curCameraDevice</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to createCameraInput errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraInput</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 打开相机。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraInput</span>.<span class="hljs-title function_">open</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to open device, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取支持的模式类型。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneModes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">SceneMode</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">getSupportedSceneModes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curCameraDevice</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupportPhotoMode</span>: <span class="hljs-built_in">boolean</span> = sceneModes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) &gt;= <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (!isSupportPhotoMode) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'photo mode not support'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取相机设备支持的输出流能力。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraOutputCapability</span>: camera.<span class="hljs-property">CameraOutputCapability</span> =</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">getSupportedOutputCapability</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curCameraDevice</span>, camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>);</li><li>    <span class="hljs-keyword">if</span> (!cameraOutputCapability) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'cameraManager.getSupportedOutputCapability error'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'outputCapability: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cameraOutputCapability));</li><li>    <span class="hljs-keyword">let</span> previewProfile = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPreviewProfile</span>(cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (previewProfile === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'The resolution of the current preview stream is not supported.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewProfileObj</span> = previewProfile;</li><li>
</li><li>    <span class="hljs-comment">// 创建预览输出流,其中参数 surfaceId 参考上文 XComponent 组件，预览流为XComponent组件提供的surface。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPreviewOutput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">createPreviewOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">previewProfileObj</span>, surfaceId);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">`Failed to create the PreviewOutput instance. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mPreviewOutput</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//创建会话。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraManager</span>.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">PhotoSession</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to create the session instance. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span> === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">isAutoDeviceSwitchSupported</span>()) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">enableAutoDeviceSwitch</span>(<span class="hljs-literal">true</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'autoDeviceSwitchStatusChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">autoDeviceSwitchCallback</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 开始配置会话。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">beginConfig</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to beginConfig. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加相机输入流。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">addInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraInput</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to addInput. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 向会话中添加预览输出流。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mPreviewOutput</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to addOutput(previewOutput). errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 提交会话配置。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">commitConfig</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to commit session configuration, errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 启动会话。</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mPhotoSession</span>.<span class="hljs-title function_">start</span>()</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span> + <span class="hljs-string">'Failed to start session. errorCode = '</span> + err.<span class="hljs-property">code</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>      <span class="hljs-title class_">Stack</span>() {</li><li>        <span class="hljs-title class_">XComponent</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentOptions</span>)</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadXComponent</span>();</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1080</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-number">1920</span>))</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'切换相机'</span>)</li><li>          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">48</span> })</li><li>          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">24</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mCameraPosition</span> === camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span> ?</li><li>            camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_FRONT</span> : camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadXComponent</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>