<h1 _ngcontent-bnh-c119="" class="doc-title ng-star-inserted" title="自定义Native Transferable对象的多线程操作场景"> 自定义Native Transferable对象的多线程操作场景 </h1>

<div _ngcontent-bnh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在ArkTS应用开发中，有很多场景需要将ArkTS对象与Native对象进行绑定。ArkTS对象将数据写入Native对象，Native对象再将数据写入目的地。例如，将ArkTS对象中的数据写入C++数据库场景。</p> <p>Native Transferable对象有两种模式：共享模式和转移模式。本示例将详细说明如何实现这两种模式。</p> <ol><li><p>Native实现各项功能。</p>  <div _ngcontent-bnh-c106="" class="highlight-div"><div _ngcontent-bnh-c106="" class="highlight-div-header"><div _ngcontent-bnh-c106="" class="highlight-div-header-left"><div _ngcontent-bnh-c106="" class="handle-button expand-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnh-c106="" class="highlight-div-header-right"><div _ngcontent-bnh-c106="" class="handle-button ai-button"></div><div _ngcontent-bnh-c106="" class="handle-button line-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnh-c106="" class="handle-button theme-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnh-c106="" class="handle-button copy-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnh-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// napi_init.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomNativeObject</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-built_in">CustomNativeObject</span>() {}</li><li>    ~<span class="hljs-built_in">CustomNativeObject</span>() = <span class="hljs-keyword">default</span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> CustomNativeObject&amp; <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">static</span> CustomNativeObject instance;</li><li>        <span class="hljs-keyword">return</span> instance;</li><li>    }</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetAddress</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">uint64_t</span> addressVal = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(object);</li><li>        napi_value address = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_bigint_uint64</span>(env, addressVal, &amp;address);</li><li>        <span class="hljs-keyword">return</span> address;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取数组大小</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetSetSize</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        CustomNativeObject* obj = <span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(object);</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(obj-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-type">uint32_t</span> setSize = <span class="hljs-built_in">reinterpret_cast</span>&lt;CustomNativeObject*&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">size</span>();</li><li>        napi_value napiSize = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_uint32</span>(env, setSize, &amp;napiSize);</li><li>        <span class="hljs-keyword">return</span> napiSize;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 往数组里插入元素</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Store</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Store args number must be one."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        napi_valuetype type = napi_undefined;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;type);</li><li>        <span class="hljs-keyword">if</span> (type != napi_number) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Store args is not number."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">napi_get_value_uint32</span>(env, args[<span class="hljs-number">0</span>], &amp;value);</li><li>        CustomNativeObject* obj = <span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(object);</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(obj-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;CustomNativeObject *&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">insert</span>(value);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 删除数组元素</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Erase</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Erase args number must be one."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        napi_valuetype type = napi_undefined;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;type);</li><li>        <span class="hljs-keyword">if</span> (type != napi_number) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"Erase args is not number."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-built_in">napi_get_value_uint32</span>(env, args[<span class="hljs-number">0</span>], &amp;value);</li><li>        </li><li>        CustomNativeObject* obj = <span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(object);</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(obj-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;CustomNativeObject *&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">erase</span>(value);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空数组</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Clear</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        napi_value thisVar = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        CustomNativeObject* obj = <span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(object);</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(obj-&gt;numberSetMutex_)</span></span>;</li><li>        <span class="hljs-built_in">reinterpret_cast</span>&lt;CustomNativeObject *&gt;(object)-&gt;numberSet_.<span class="hljs-built_in">clear</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 设置传输模式</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetTransferDetached</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>        napi_value args[<span class="hljs-number">1</span>];</li><li>        napi_value thisVar;</li><li>        <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;thisVar, <span class="hljs-literal">nullptr</span>);</li><li>        <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"SetTransferDetached args number must be one."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-keyword">if</span> (thisVar == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        napi_valuetype type = napi_undefined;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;type);</li><li>        <span class="hljs-keyword">if</span> (type != napi_boolean) {</li><li>            <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"SetTransferDetached args is not boolean."</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-type">bool</span> isDetached;</li><li>        <span class="hljs-built_in">napi_get_value_bool</span>(env, args[<span class="hljs-number">0</span>], &amp;isDetached);</li><li>        </li><li>        <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_unwrap</span>(env, thisVar, &amp;object);</li><li>        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>        }</li><li>        CustomNativeObject* obj = <span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(object);</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(obj-&gt;numberSetMutex_)</span></span>;</li><li>        obj-&gt;isDetached_ = isDetached;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    </li><li>    <span class="hljs-type">bool</span> isDetached_ = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-built_in">CustomNativeObject</span>(<span class="hljs-type">const</span> CustomNativeObject &amp;) = <span class="hljs-keyword">delete</span>;</li><li>    CustomNativeObject &amp;<span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> CustomNativeObject &amp;) = <span class="hljs-keyword">delete</span>;</li><li>
</li><li>    std::unordered_set&lt;<span class="hljs-type">uint32_t</span>&gt; numberSet_{};</li><li>    std::mutex numberSetMutex_{};</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FinalizeCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data, <span class="hljs-type">void</span> *hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解绑回调，在序列化时调用，可在对象解绑时执行一些清理操作</span></li><li><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">DetachCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *value, <span class="hljs-type">void</span> *hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (hint == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> value;</li><li>    }</li><li>    napi_value jsObject = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_get_reference_value</span>(env, <span class="hljs-built_in">reinterpret_cast</span>&lt;napi_ref&gt;(hint), &amp;jsObject);</li><li>    <span class="hljs-type">void</span>* object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">static_cast</span>&lt;CustomNativeObject*&gt;(value)-&gt;isDetached_) {</li><li>        <span class="hljs-built_in">napi_remove_wrap</span>(env, jsObject, &amp;object);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> value;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 绑定回调，在反序列化时调用</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">AttachCallback</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span>* value, <span class="hljs-type">void</span>* hint)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value object = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;object);</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"getAddress"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::GetAddress, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"getSetSize"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::GetSetSize, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"store"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Store, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"erase"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Erase, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"clear"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Clear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, object, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-comment">// 将JS对象object和native对象value生命周期进行绑定</span></li><li>    <span class="hljs-built_in">napi_wrap</span>(env, object, value, FinalizeCallback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// JS对象携带native信息</span></li><li>    <span class="hljs-built_in">napi_coerce_to_native_binding_object</span>(env, object, DetachCallback, AttachCallback, value, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> object;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"getAddress"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::GetAddress, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"getSetSize"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::GetSetSize, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"store"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Store, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"erase"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Erase, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"clear"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::Clear, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"setTransferDetached"</span>, <span class="hljs-literal">nullptr</span>, CustomNativeObject::SetTransferDetached, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">auto</span> &amp;object = CustomNativeObject::<span class="hljs-built_in">GetInstance</span>();</li><li>    <span class="hljs-built_in">napi_wrap</span>(env, exports, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(&amp;object), FinalizeCallback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_ref exportsRef;</li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, exports, <span class="hljs-number">1</span>, &amp;exportsRef);</li><li>    <span class="hljs-built_in">napi_coerce_to_native_binding_object</span>(env, exports, DetachCallback, AttachCallback, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(&amp;object), exportsRef);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div>  </li><li><p>在ArkTS中声明接口。</p>  <div _ngcontent-bnh-c106="" class="highlight-div"><div _ngcontent-bnh-c106="" class="highlight-div-header"><div _ngcontent-bnh-c106="" class="highlight-div-header-left"><div _ngcontent-bnh-c106="" class="handle-button expand-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnh-c106="" class="highlight-div-header-right"><div _ngcontent-bnh-c106="" class="handle-button ai-button"></div><div _ngcontent-bnh-c106="" class="handle-button line-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnh-c106="" class="handle-button theme-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnh-c106="" class="handle-button copy-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getAddress</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getSetSize</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">store</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">erase</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">clear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">setTransferDetached</span>: <span class="hljs-function">(<span class="hljs-params">b : <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre></div></div>  </li><li><p>ArkTS对象调用Native侧实现的各项功能。</p>  <p>在转移模式下，跨线程传递后，原来的ArkTS对象与Native对象解绑，因此不能继续访问。示例如下：</p>  <div _ngcontent-bnh-c106="" class="highlight-div"><div _ngcontent-bnh-c106="" class="highlight-div-header"><div _ngcontent-bnh-c106="" class="highlight-div-header-left"><div _ngcontent-bnh-c106="" class="handle-button expand-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnh-c106="" class="highlight-div-header-right"><div _ngcontent-bnh-c106="" class="handle-button ai-button"></div><div _ngcontent-bnh-c106="" class="handle-button line-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnh-c106="" class="handle-button theme-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnh-c106="" class="handle-button copy-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAddress</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>: <span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"taskpool:: address is "</span> + address);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span>, c:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before store"</span>);</li><li>  testNapi.<span class="hljs-title function_">store</span>(a);</li><li>  testNapi.<span class="hljs-title function_">store</span>(b);</li><li>  testNapi.<span class="hljs-title function_">store</span>(c);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after store"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">erase</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before erase"</span>);</li><li>  testNapi.<span class="hljs-title function_">erase</span>(a);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after erase"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before clear"</span>);</li><li>  testNapi.<span class="hljs-title function_">clear</span>();</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after clear"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 转移模式</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// setTransferDetached 设置为true，表示传输方式为转移模式</span></li><li>  testNapi.<span class="hljs-title function_">setTransferDetached</span>(<span class="hljs-literal">true</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"host thread address is "</span> + address);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task1 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(getAddress, testNapi);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task1);</li><li>  </li><li>  <span class="hljs-keyword">let</span> task2 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task2);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task3 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task3);</li><li>
</li><li>  <span class="hljs-comment">// 由于已经设置了转移模式，且testNapi已跨线程传递，所以主线程无法继续访问到Native对象的值</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-comment">// 输出的日志为“host thread size is undefined”</span></li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"host thread size is "</span> + size);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task4 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">3</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task4);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task5 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">5</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task5);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task6 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(clear);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task6);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">test</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  <p>在共享模式下，跨线程传递后，原来的ArkTS对象还可以继续访问Native对象。示例如下：</p>  <div _ngcontent-bnh-c106="" class="highlight-div"><div _ngcontent-bnh-c106="" class="highlight-div-header"><div _ngcontent-bnh-c106="" class="highlight-div-header-left"><div _ngcontent-bnh-c106="" class="handle-button expand-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bnh-c106="" class="highlight-div-header-right"><div _ngcontent-bnh-c106="" class="handle-button ai-button"></div><div _ngcontent-bnh-c106="" class="handle-button line-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bnh-c106="" class="handle-button theme-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bnh-c106="" class="handle-button copy-button"><div _ngcontent-bnh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bnh-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAddress</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>: <span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"taskpool:: address is "</span> + address);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span>, c:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before store"</span>);</li><li>  testNapi.<span class="hljs-title function_">store</span>(a);</li><li>  testNapi.<span class="hljs-title function_">store</span>(b);</li><li>  testNapi.<span class="hljs-title function_">store</span>(c);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after store"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">erase</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before erase"</span>);</li><li>  testNapi.<span class="hljs-title function_">erase</span>(a);</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after erase"</span>);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" before clear"</span>);</li><li>  testNapi.<span class="hljs-title function_">clear</span>();</li><li>  size = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"set size is "</span> + size + <span class="hljs-string">" after clear"</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 共享模式</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">address</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getAddress</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"host thread address is "</span> + address);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task1 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(getAddress, testNapi);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task1);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task2 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task2);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task3 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(store, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task3);</li><li>
</li><li>  <span class="hljs-comment">// 由于默认的传输模式为共享模式，testNapi跨线程传递后，主线程可以继续访问Native对象的值</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">size</span>:<span class="hljs-built_in">number</span> = testNapi.<span class="hljs-title function_">getSetSize</span>();</li><li>  <span class="hljs-comment">// 输出的日志为“host thread size is 6”</span></li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"host thread size is "</span> + size);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task4 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">3</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task4);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task5 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(erase, <span class="hljs-number">5</span>);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task5);</li><li>
</li><li>  <span class="hljs-keyword">let</span> task6 = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(clear);</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task6);</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title function_">test</span>();</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> <div></div></div>