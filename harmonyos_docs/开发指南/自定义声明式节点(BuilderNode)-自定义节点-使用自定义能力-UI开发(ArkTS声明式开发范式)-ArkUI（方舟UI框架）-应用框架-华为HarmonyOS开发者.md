<h1 _ngcontent-frw-c119="" class="doc-title ng-star-inserted" title="自定义声明式节点 (BuilderNode)"> 自定义声明式节点 (BuilderNode) </h1>

<div _ngcontent-frw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>自定义声明式节点 (<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode" target="_blank">BuilderNode</a>)提供能够挂载系统组件的能力，支持采用无状态的UI方式，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-builder#全局自定义构建函数">全局自定义构建函数</a>@Builder定制组件树。组件树的根<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode" target="_blank">FrameNode</a>节点可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#getframenode" target="_blank">getFrameNode</a>获取，该节点既可直接由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>返回并挂载于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>节点下，亦可在FrameNode树与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode" target="_blank">RenderNode</a>树中嵌入声明式组件，实现混合显示。同时，BuilderNode具备纹理导出功能，导出的纹理可在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>中实现同层渲染。</p>     <p>由BuilderNode构建的ArkTS组件树，支持与自定义节点（如FrameNode、RenderNode）关联使用，确保了系统组件与自定义节点的混合显示效果。对于需与自定义节点对接的第三方框架，BuilderNode提供了嵌入系统组件的方法。</p>     <p>此外，BuilderNode还提供了组件预创建的能力，能够自定义系统组件的创建开始的时间，在后续业务中实现动态挂载与显示。此功能尤其适用于初始化耗时较长的声明式组件，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web" target="_blank">Web</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>等，通过预创建，可以有效减少初始化时间，优化组件加载效率。</p>     <p><span><img originheight="830" originwidth="1258" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114939.26586037313312924100774960306531:50001231000000:2800:8319096474423575FD8363050F49F94F9050C17551890FBB30F7FE3ABCA2E253.png" width="920" height="606.9952305246422"></span></p>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>系统组件：组件是UI的必要元素，形成了在界面中的样子，由ArkUI直接提供的称为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-development-overview">系统组件</a>。</p></li>      <li>       <p>实体节点：由后端创建的Native节点。</p></li>     </ul>     <p>BuilderNode仅可作为叶子节点进行使用。如有更新需要，建议通过BuilderNode中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#update" target="_blank">update</a>方式触发更新，不建议通过BuilderNode中获取的RenderNode对节点进行修改操作。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>         <p>BuilderNode只支持一个由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-wrapbuilder">wrapBuilder</a>包装的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-builder#全局自定义构建函数">全局自定义构建函数</a>@Builder。</p></li>        <li>         <p>一个新建的BuilderNode在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#build" target="_blank">build</a>之后才能通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#getframenode" target="_blank">getFrameNode</a>获取到一个指向根节点的FrameNode对象，否则返回null。</p></li>        <li>         <p>如果传入的Builder的根节点为语法节点（if/else/foreach/...），需要额外生成一个FrameNode，在节点树中的显示为“BuilderProxyNode”。</p></li>        <li>         <p>如果BuilderNode通过getFrameNode将节点挂载在另一个FrameNode上，或者将其作为子节点挂载在NodeContainer节点上。则节点中使用父组件的布局约束进行布局。</p></li>        <li>         <p>如果BuilderNode的FrameNode通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#getrendernode" target="_blank">getRenderNode</a>形式将自己的节点挂载在RenderNode节点上，由于其FrameNode未上树，其大小默认为0，需要通过构造函数中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#renderoptions" target="_blank">selfIdeaSize</a>显式指定布局约束大小，才能正常显示。</p></li>        <li>         <p>BuilderNode的预加载并不会减少组件的创建时间。Web组件创建的时候需要在内核中加载资源，预创建不能减少Web组件的创建的时间，但是可以让内核进行预加载，减少正式使用时候内核的加载耗时。</p></li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="创建buildernode对象">创建BuilderNode对象<i class="anchor-icon anchor-icon-link" anchorid="创建buildernode对象" tips="复制节点链接"></i></h2>          <p>BuilderNode对象为一个模板类，需要在创建的时候指定类型。该类型需要与后续build方法中传入的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-wrapbuilder">WrappedBuilder</a>的类型保持一致，否则会存在编译告警导致编译失败。</p>    </div>    <div class="tiledSection">     <h2 id="创建组件树">创建组件树<i class="anchor-icon anchor-icon-link" anchorid="创建组件树" tips="复制节点链接"></i></h2>          <p>通过BuilderNode的build可以实现组件树的创建。依照传入的WrappedBuilder对象创建组件树，并持有组件树的根节点。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>无状态的UI方法全局@Builder最多拥有一个根节点。</p>       <p>build方法中对应的@Builder支持一个参数作为入参。</p>       <p>build中对于@Builder嵌套@Builder进行使用的场景，需要保证嵌套的参数与build的中提供的入参一致。</p>       <p>对于@Builder嵌套@Builder进行使用的场景，如果入参类型不一致，则要求增加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#buildoptions12" target="_blank">BuilderOptions</a>字段作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#build12" target="_blank">build</a>的入参。</p>       <p>需要操作BuilderNode中的对象时，需要保证其引用不被回收。当BuilderNode对象被虚拟机回收之后，它的FrameNode、RenderNode对象也会与后端节点解引用。即从BuilderNode中获取的FrameNode对象不对应任何一个节点。</p>      </div></div></div>     <p>创建离线节点以及组件树，结合FrameNode进行使用。</p>     <p>BuilderNode的根节点直接作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller#makenode" target="_blank">makeNode</a>返回值。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"DEFAULT"</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildText), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>))</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>将BuilderNode与RenderNode进行结合使用。</p>     <p>BuilderNode的RenderNode挂载其它RenderNode下时，需要明确定义<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#renderoptions" target="_blank">selfIdeaSize</a>的大小作为BuilderNode的布局约束。不推荐通过该方式挂载节点。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span>, <span class="hljs-title class_">RenderNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"DEFAULT"</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(context);</li><li>    <span class="hljs-keyword">let</span> renderNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RenderNode</span>();</li><li>    renderNode.<span class="hljs-property">clipToFrame</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context, { <span class="hljs-attr">selfIdealSize</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">150</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">150</span> } });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildText), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>));</li><li>    <span class="hljs-keyword">const</span> textRenderNode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>?.<span class="hljs-title function_">getFrameNode</span>()?.<span class="hljs-title function_">getRenderNode</span>();</li><li>
</li><li>    <span class="hljs-keyword">const</span> rootRenderNode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getRenderNode</span>();</li><li>    <span class="hljs-keyword">if</span> (rootRenderNode !== <span class="hljs-literal">null</span>) {</li><li>      rootRenderNode.<span class="hljs-title function_">appendChild</span>(renderNode);</li><li>      renderNode.<span class="hljs-title function_">appendChild</span>(textRenderNode);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="更新组件树">更新组件树<i class="anchor-icon anchor-icon-link" anchorid="更新组件树" tips="复制节点链接"></i></h2>          <p>通过BuilderNode对象的build创建组件树。依照传入的WrappedBuilder对象创建组件树，并持有组件树的根节点。</p>     <p>自定义组件的更新遵循<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state-management-overview">状态管理</a>的更新机制。WrappedBuilder中直接使用的自定义组件其父组件为BuilderNode对象。因此，更新子组件即WrappedBuilder中定义的自定义组件，需要遵循状态管理的定义将相关的状态变量定义为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink">@ObjectLink</a>。装饰器的选择请参照状态管理的装饰器规格结合应用开发需求进行选择。</p>     <p>使用update更新BuilderNode中的节点。</p>     <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#updateconfiguration12" target="_blank">updateConfiguration</a>触发BuilderNode中节点的全量更新。</p>     <p>更新BuilderNode中的节点。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义组件</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">TextBuilder</span> {</li><li>  <span class="hljs-comment">// 作为自定义组件中需要更新的属性，数据类型为基础属性，定义为@Prop</span></li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"TextBuilder"</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>    <span class="hljs-title class_">TextBuilder</span>({ <span class="hljs-attr">message</span>: params.<span class="hljs-property">text</span> }) <span class="hljs-comment">// 自定义组件</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildText), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>))</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">update</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 调用update进行更新。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">update</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(message));</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-keyword">private</span> count = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Update'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;</li><li>            <span class="hljs-keyword">const</span> message = <span class="hljs-string">"Update "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toString</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>.<span class="hljs-title function_">update</span>(message);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="270" originwidth="400" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114939.04041505432076149402906329067682:50001231000000:2800:B57002330AF508745D666FE731C1FBC260360FE27A1712AD3667E78AEB07F17F.gif" width="400" height="270"></span></p>    </div>    <div class="tiledSection">     <h2 id="解除实体节点引用关系">解除实体节点引用关系<i class="anchor-icon anchor-icon-link" anchorid="解除实体节点引用关系" tips="复制节点链接"></i></h2>          <p>由于BuilderNode对应的是后端的实体节点，正常的内存释放依赖前端对象的回收。如果期望直接释放后端的节点对象，则可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#dispose12" target="_blank">dispose</a>与实体节点解除引用关系，此时持有的前端BuilderNode对象不再影响实体节点的生命周期。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>当BuilderNode对象调用dispose之后，不仅BuilderNode对象与后端实体节点解除引用关系，BuilderNode中的FrameNode与RenderNode也会同步和实体节点解除引用关系。</p>       <p>若前端对象BuilderNode无法释放，容易导致内存泄漏。建议在不再需要对该BuilderNode对象进行操作时，开发者应主动调用dispose释放后端节点，以减少引用关系的复杂性，降低内存泄漏的风险。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="注入触摸事件">注入触摸事件<i class="anchor-icon anchor-icon-link" anchorid="注入触摸事件" tips="复制节点链接"></i></h2>          <p>BuilderNode中提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#posttouchevent" target="_blank">postTouchEvent</a>，可以通过该接口向BuilderNode中绑定的组件注入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-touch" target="_blank">触摸事件</a>，实现事件的模拟转发。</p>     <p>通过postTouchEvent向BuilderNode对应的节点树中注入触摸事件。</p>     <p>向BuilderNode中的Column组件转发另一个Column接收的事件，即点击下方的Column组件，上方的Column组件也会收到同样的触摸事件。当Button中的事件被成功识别的时候，返回值为true。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"this is a text"</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">ButtonBuilder</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Button</span>(<span class="hljs-string">`button `</span> + params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">2</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">gesture</span>(</li><li>        <span class="hljs-title class_">TapGesture</span>()</li><li>          .<span class="hljs-title function_">onAction</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"TapGesture"</span>);</li><li>          })</li><li>      )</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-number">500</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">wrapBuilder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; = <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">ButtonBuilder</span>);</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wrapBuilder</span>, { <span class="hljs-attr">text</span>: <span class="hljs-string">"this is a string"</span> })</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">postTouchEvent</span>(<span class="hljs-attr">touchEvent</span>: <span class="hljs-title class_">TouchEvent</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">postTouchEvent</span>(touchEvent);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"result "</span> + result);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">nodeController</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">500</span>)</li><li>      <span class="hljs-title class_">Column</span>()</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">500</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)</li><li>        .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (event != <span class="hljs-literal">undefined</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">postTouchEvent</span>(event);</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="buildernode内的builderproxynode导致树结构发生变化">BuilderNode内的BuilderProxyNode导致树结构发生变化<i class="anchor-icon anchor-icon-link" anchorid="buildernode内的builderproxynode导致树结构发生变化" tips="复制节点链接"></i></h2>          <p>若传入的Builder的根节点为语法节点（if/else/foreach/…）或自定义组件，将额外生成一个FrameNode，在节点树中显示为“BuilderProxyNode”，这会导致树结构变化，影响某些测试的传递过程。</p>     <p>在以下示例中，Column和Row绑定了触摸事件，同时Column设置了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-hit-test-behavior#hittestbehavior" target="_blank">hitTestBehavior</a>属性为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-appendix-enums#hittestmode9" target="_blank">HitTestMode.Transparent</a>。然而，由于生成了BuilderProxyNode，且BuilderProxyNode无法设置属性，因此在触摸Column时，Column的触摸测试无法传递到Row上。</p>     <p><span><img originheight="738" originwidth="633" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.32534324443038672520897223323982:50001231000000:2800:B1DA9E1BD46511BBE4518F4FC67A8ACE4FB227C7F6EB8C7F1952E57FBF9EB135.png" width="633" height="738"></span></p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, typeNode, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BlueRowComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'200vp'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF2787D9</span>)</li><li>      .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 触摸绿色Column，蓝色Row的触摸事件不触发</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"blue touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GreenColumnComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100vp'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF17A98D</span>)</li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>    .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"green touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildBlueRow</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Builder直接挂载自定义组件，生成BuilderProxyNode</span></li><li>  <span class="hljs-title class_">BlueRowComponent</span>()</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildGreenColumn</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Builder直接挂载自定义组件，生成BuilderProxyNode</span></li><li>  <span class="hljs-title class_">GreenColumnComponent</span>()</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">const</span> relativeContainer = typeNode.<span class="hljs-title function_">createNode</span>(uiContext, <span class="hljs-string">'RelativeContainer'</span>);</li><li>
</li><li>    <span class="hljs-keyword">const</span> blueRowNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    blueRowNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildBlueRow));</li><li>
</li><li>    <span class="hljs-keyword">const</span> greenColumnNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    greenColumnNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildGreenColumn));</li><li>
</li><li>    <span class="hljs-comment">// greenColumnNode覆盖在blueRowNode上</span></li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(blueRowNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(greenColumnNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>
</li><li>    <span class="hljs-keyword">return</span> relativeContainer;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>())</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>在上述场景中，若要实现触摸测试的传递，可以使用一个容器组件包裹语法节点或自定义组件，以避免生成BuilderProxyNode，并将容器组件的hitTestBehavior设置为HitTestMode.Transparent，从而向兄弟节点传递触摸测试。</p>     <p><span><img originheight="736" originwidth="671" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.30467169550191527348226966111852:50001231000000:2800:6B47577BB356C35FC888C9AB77D7A9B4187ACC33ADAD2316E9F54BDF73B9D0EC.png" width="671" height="736"></span></p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, typeNode, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BlueRowComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'200vp'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF2787D9</span>)</li><li>      .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 触摸绿色Column，蓝色Row的触摸事件触发</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"blue touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GreenColumnComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100vp'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF17A98D</span>)</li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>    .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"green touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildBlueRow</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Builder直接挂载自定义组件，生成BuilderProxyNode</span></li><li>  <span class="hljs-title class_">BlueRowComponent</span>()</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildGreenColumn</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Builder根节点为容器组件，不会生成BuilderProxyNode，可以设置属性</span></li><li>  <span class="hljs-title class_">Stack</span>() {</li><li>    <span class="hljs-title class_">GreenColumnComponent</span>()</li><li>  }</li><li>  .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">const</span> relativeContainer = typeNode.<span class="hljs-title function_">createNode</span>(uiContext, <span class="hljs-string">'RelativeContainer'</span>);</li><li>
</li><li>    <span class="hljs-keyword">const</span> blueRowNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    blueRowNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildBlueRow));</li><li>
</li><li>    <span class="hljs-keyword">const</span> greenColumnNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    greenColumnNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildGreenColumn));</li><li>
</li><li>    <span class="hljs-comment">// greenColumnNode覆盖在blueRowNode上</span></li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(blueRowNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(greenColumnNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>
</li><li>    <span class="hljs-keyword">return</span> relativeContainer;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>())</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>此外，对于自定义组件，可以直接设置属性，此时将额外生成节点__Common__，自定义组件的属性将挂载于__Common__上，同样能够实现上述效果。</p>     <p><span><img originheight="721" originwidth="648" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.29160391429418431949250248614445:50001231000000:2800:7E8BDDCB3E64B8BD06B3A09CADC0112D081721400CCE9397A8117A0121724FFD.png" width="648" height="721"></span></p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, typeNode, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BlueRowComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'200vp'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF2787D9</span>)</li><li>      .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 触摸绿色Column，蓝色Row的触摸事件触发</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"blue touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>      })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GreenColumnComponent</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100vp'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xFF17A98D</span>)</li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>    .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">event: TouchEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"green touched: "</span> + event.<span class="hljs-property">type</span>);</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildBlueRow</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Builder直接挂载自定义组件，生成BuilderProxyNode</span></li><li>  <span class="hljs-title class_">BlueRowComponent</span>()</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildGreenColumn</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// 给自定义组件设置属性生成__Common__节点，Builder根节点为__Common__节点，不会生成BuilderProxyNode</span></li><li>  <span class="hljs-title class_">GreenColumnComponent</span>()</li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">const</span> relativeContainer = typeNode.<span class="hljs-title function_">createNode</span>(uiContext, <span class="hljs-string">'RelativeContainer'</span>);</li><li>
</li><li>    <span class="hljs-keyword">const</span> blueRowNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    blueRowNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildBlueRow));</li><li>
</li><li>    <span class="hljs-keyword">const</span> greenColumnNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    greenColumnNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(buildGreenColumn));</li><li>
</li><li>    <span class="hljs-comment">// greenColumnNode覆盖在blueRowNode上</span></li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(blueRowNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>    relativeContainer.<span class="hljs-title function_">appendChild</span>(greenColumnNode.<span class="hljs-title function_">getFrameNode</span>());</li><li>
</li><li>    <span class="hljs-keyword">return</span> relativeContainer;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>())</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="buildernode调用reuse和recycle接口实现节点复用能力">BuilderNode调用reuse和recycle接口实现节点复用能力<i class="anchor-icon anchor-icon-link" anchorid="buildernode调用reuse和recycle接口实现节点复用能力" tips="复制节点链接"></i></h2>          <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#reuse12" target="_blank">reuse</a>接口和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#recycle12" target="_blank">recycle</a>接口，将复用和回收事件传递至BuilderNode中的自定义组件，以实现BuilderNode节点内部的自定义组件的复用。</p>     <p>以下面的Demo为例，被复用的自定义组件ReusableChildComponent可以传递复用和回收事件到其下的自定义组件ChildComponent3，但无法传递给自定义组件ChildComponent2，因为被BuilderNode所隔断。因此需要主动调用BuilderNode的reuse和recycle接口，将复用和回收事件传递给自定义组件ChildComponent2，以达成复用效果。</p>     <p><span><img originheight="660" originwidth="928" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.52837452079800223919308483764893:50001231000000:2800:DF36CA2E43162D799F53A85EAE2CC620220B57DEEE177D86AAE5D3594E27CFA3.png" width="920" height="654.3103448275863"></span></p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TEST_TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Reuse+Recycle"</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDataSource</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">dataArray</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-property">length</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>[index];</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">pushData</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">push</span>(data);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reloadListener</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span>?.<span class="hljs-title function_">onDataReloaded</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span> = listener;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unregisterDataChangeListener</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listener</span> = <span class="hljs-literal">null</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = item;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildNode</span>(<span class="hljs-params">param: Params = <span class="hljs-keyword">new</span> Params(<span class="hljs-string">"hello"</span>)</span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`C<span class="hljs-subst">${param.item}</span> -- `</span>)</li><li>    <span class="hljs-title class_">ChildComponent2</span>({ <span class="hljs-attr">item</span>: param.<span class="hljs-property">item</span> }) <span class="hljs-comment">//该自定义组件在BuilderNode中无法被正确复用</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext, { <span class="hljs-attr">selfIdealSize</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">200</span> } });</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildNode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 被回收复用的自定义组件，其状态变量会更新，而子自定义组件ChildComponent3中的状态变量也会更新，但BuilderNode会阻断这一传递过程</span></li><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ReusableChildComponent</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">switch</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">controller</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-property">item</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ReusableChildComponent aboutToRecycle <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>
</li><li>    <span class="hljs-comment">// 当开关为open，通过BuilderNode的reuse接口和recycle接口传递给其下的自定义组件，例如ChildComponent2，完成复用</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">switch</span> === <span class="hljs-string">'open'</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>?.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">recycle</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-built_in">object</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ReusableChildComponent aboutToReuse <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>
</li><li>    <span class="hljs-comment">// 当开关为open，通过BuilderNode的reuse接口和recycle接口传递给其下的自定义组件，例如ChildComponent2，完成复用</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">switch</span> === <span class="hljs-string">'open'</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>?.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">reuse</span>(params);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`A<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>--`</span>)</li><li>      <span class="hljs-title class_">ChildComponent3</span>({ <span class="hljs-attr">item</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> })</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildComponent2</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"false"</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent2 aboutToReuse <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent2 aboutToRecycle <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`D<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span> })</li><li>    }.<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span> })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildComponent3</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"false"</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent3 aboutToReuse <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent3 aboutToRecycle <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`B<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Yellow</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span> })</li><li>    }.<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span> })</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">MyDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">pushData</span>(i.<span class="hljs-title function_">toString</span>());</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">3</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">ReusableChildComponent</span>({</li><li>              <span class="hljs-attr">item</span>: item,</li><li>              <span class="hljs-attr">switch</span>: <span class="hljs-string">'open'</span> <span class="hljs-comment">// 将open改为close可观察到，BuilderNode不通过reuse和recycle接口传递复用时，BuilderNode内部的自定义组件的行为表现</span></li><li>            })</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="buildernode在子自定义组件中使用reusable装饰器">BuilderNode在子自定义组件中使用@Reusable装饰器<i class="anchor-icon anchor-icon-link" anchorid="buildernode在子自定义组件中使用reusable装饰器" tips="复制节点链接"></i></h2>          <p>BuilderNode节点的复用机制与使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-reusable">@Reusable</a>装饰器的自定义组件的复用机制会相互冲突。因此，当BuilderNode的子节点为自定义组件时，不支持该自定义组件使用@Reusable装饰器标记，否则将导致应用程序触发JSCrash。若需要使用@Reusable装饰器，应使用一个普通自定义组件包裹该自定义组件。</p>     <p>在下面的示例中，ReusableChildComponent作为BuilderNode的子自定义组件，无法标记为@Reusable。通过ChildComponent2对其包裹，ReusableChildComponent可以使用@Reusable装饰器标记。</p>     <p><span><img originheight="550" originwidth="351" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.15703016227626582387877405985757:50001231000000:2800:661254A86D89434894B236BFCD573B5076BD81DAFC80F2F795EE0470371C830C.png" width="351" height="550"></span></p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TEST_TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Reusable"</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = item;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildNode</span>(<span class="hljs-params">param: Params = <span class="hljs-keyword">new</span> Params(<span class="hljs-string">"Hello"</span>)</span>) {</li><li>  <span class="hljs-title class_">ChildComponent2</span>({ <span class="hljs-attr">item</span>: param.<span class="hljs-property">item</span> })</li><li>  <span class="hljs-comment">// 如果直接使用ReusableChildComponent，则会编译报错</span></li><li>  <span class="hljs-comment">// ReusableChildComponent({ item: param.item })</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = item;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext, { <span class="hljs-attr">selfIdealSize</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">200</span> } });</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildNode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>));</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 标记了@Reusable的自定义组件，无法直接被BuilderNode挂载为子节点</span></li><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ReusableChildComponent</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-built_in">object</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ReusableChildComponent aboutToReuse <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ReusableChildComponent aboutToRecycle <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`A--<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 未标记@Reusable的自定义组件</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ChildComponent2</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent2 aboutToReuse <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TEST_TAG}</span> ChildComponent2 aboutToRecycle <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.item}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">ReusableChildComponent</span>({ <span class="hljs-attr">item</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> })</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">controller</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-string">"Child"</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="通过系统环境变化更新节点">通过系统环境变化更新节点<i class="anchor-icon anchor-icon-link" anchorid="通过系统环境变化更新节点" tips="复制节点链接"></i></h2>          <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#updateconfiguration12" target="_blank">updateConfiguration</a>来监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-configuration" target="_blank">系统环境变化</a>事件，以触发节点的全量更新。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>updateConfiguration接口用于通知对象进行更新，更新所使用的系统环境取决于应用当前系统环境的变化。</p>      </div></div></div>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">Configuration</span>, <span class="hljs-title class_">EnvironmentCallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 自定义组件</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">TextBuilder</span> {</li><li>  <span class="hljs-comment">// 作为自定义组件中需要更新的属性，数据类型为基础属性，定义为@Prop</span></li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"TextBuilder"</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>          .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">`app.color.text_color`</span>))</li><li>          .<span class="hljs-title function_">backgroundColor</span>($r(<span class="hljs-string">`app.color.start_window_background`</span>))</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span> })</li><li>      .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">`app.color.text_color`</span>))</li><li>    <span class="hljs-title class_">TextBuilder</span>({ <span class="hljs-attr">message</span>: params.<span class="hljs-property">text</span> }) <span class="hljs-comment">// 自定义组件</span></li><li>  }.<span class="hljs-title function_">backgroundColor</span>($r(<span class="hljs-string">`app.color.start_window_background`</span>))</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">super</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>?.<span class="hljs-title function_">getFrameNode</span>() ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>?.<span class="hljs-title function_">getFrameNode</span>() : <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">createNode</span>(<span class="hljs-params">context: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildText), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>));</li><li>    builderNodeMap.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">deleteNode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> node = builderNodeMap.<span class="hljs-title function_">pop</span>();</li><li>    node?.<span class="hljs-title function_">dispose</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">update</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 调用update进行更新。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">update</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(message));</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 记录创建的自定义节点对象</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">builderNodeMap</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt;&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateColorMode</span>(<span class="hljs-params"></span>) {</li><li>  builderNodeMap.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// 通知BuilderNode环境变量改变</span></li><li>    value.<span class="hljs-title function_">updateConfiguration</span>();</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-keyword">private</span> count = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">environmentCallback</span>: <span class="hljs-title class_">EnvironmentCallback</span> = {</li><li>      <span class="hljs-attr">onMemoryLevel</span>: (<span class="hljs-attr">level</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">MemoryLevel</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onMemoryLevel'</span>);</li><li>      },</li><li>      <span class="hljs-attr">onConfigurationUpdated</span>: (<span class="hljs-attr">config</span>: <span class="hljs-title class_">Configuration</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onConfigurationUpdated '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(config));</li><li>        <span class="hljs-title function_">updateColorMode</span>();</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// 注册监听回调</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'environment'</span>, environmentCallback);</li><li>    <span class="hljs-comment">//创建自定义节点并添加至map</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>.<span class="hljs-title function_">createNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">//移除map中的引用，并将自定义节点释放</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>.<span class="hljs-title function_">deleteNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Update'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;</li><li>            <span class="hljs-keyword">const</span> message = <span class="hljs-string">"Update "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toString</span>();</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>.<span class="hljs-title function_">update</span>(message);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="跨页面复用注意事项">跨页面复用注意事项<i class="anchor-icon anchor-icon-link" anchorid="跨页面复用注意事项" tips="复制节点链接"></i></h2>          <p>在使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router" target="_blank">路由</a>接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router#replaceurl" target="_blank">router.replaceUrl</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router#back" target="_blank">router.back</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router#clear" target="_blank">router.clear</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router#replacenamedroute" target="_blank">router.replaceNamedRoute</a>操作页面时，若某个被缓存的BuilderNode位于即将销毁的页面内，那么在新页面中复用该BuilderNode时，可能会存在数据无法更新或新创建节点无法显示的问题。以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-router#replacenamedroute" target="_blank">router.replaceNamedRoute</a>为例，在以下示例代码中，当点击“router replace”按钮后，页面将切换至PageTwo，同时标志位isShowText会被设定为false。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-string">"ets/pages/PageTwo"</span></li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// @Builder中使用语法节点生成BuilderProxyNode</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {</li><li>    <span class="hljs-title class_">MyComponent</span>()</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">"isShowText"</span>) <span class="hljs-attr">isShowText</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowText</span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"BuilderNode Reuse"</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(context);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">has</span>(<span class="hljs-string">"textNode"</span>)) {</li><li>      <span class="hljs-comment">// 复用AppStorage中的BuilderNode</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt;(<span class="hljs-string">"textNode"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;;</li><li>      <span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>()?.<span class="hljs-title function_">getParent</span>();</li><li>      <span class="hljs-keyword">if</span> (parent) {</li><li>        parent.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[]&gt;(buildText));</li><li>      <span class="hljs-comment">// 将创建的BuilderNode存入AppStorage</span></li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt;(<span class="hljs-string">"textNode"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span>({ <span class="hljs-attr">routeName</span>: <span class="hljs-string">"myIndex"</span> })</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">"isShowText"</span>, <span class="hljs-literal">true</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>())</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Router pageTwo'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 改变AppStorage中的状态变量触发Text节点的重新创建</span></li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">"isShowText"</span>, <span class="hljs-literal">false</span>);</li><li>
</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">replaceNamedRoute</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"pageTwo"</span> });</li><li>          })</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>PageTwo的实现如下：</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ets/pages/PageTwo.ets</span></li><li><span class="hljs-comment">// 该页面中存在一个按钮，可跳转回主页面，回到主页面后，原有的文字消失</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-string">"ets/pages/Index"</span></li><li>
</li><li><span class="hljs-meta">@Entry</span>({ <span class="hljs-attr">routeName</span>: <span class="hljs-string">"pageTwo"</span> })</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PageTwo</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Router replace to index'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">replaceNamedRoute</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"myIndex"</span> });</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="275" originwidth="408" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.48301476614646228125723727594138:50001231000000:2800:0AA5BB9FBCE0CE65AFB234E8712558E4DF69FE39414672BAD0A25A4FBBBAD177.gif" width="408" height="275"></span></p>     <p>在API version 16之前，解决该问题的方法是在页面销毁时，将页面上的BuilderNode从缓存中移除。以上述例子为例，可以在页面跳转前，通过点击事件将BuilderNode从AppStorage中移除，以此达到预期效果。</p>     <p>API version 16及之后版本，BuilderNode在新页面被复用时，会自动刷新自身内容，无需在页面销毁时将BuilderNode从缓存中移除。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ets/pages/Index.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.ArkUI"</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-string">"ets/pages/PageTwo"</span></li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// @Builder中使用语法节点生成BuilderProxyNode</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {</li><li>    <span class="hljs-title class_">MyComponent</span>()</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">"isShowText"</span>) <span class="hljs-attr">isShowText</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowText</span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"BuilderNode Reuse"</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(context);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">has</span>(<span class="hljs-string">"textNode"</span>)) {</li><li>      <span class="hljs-comment">// 复用AppStorage中的BuilderNode</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt;(<span class="hljs-string">"textNode"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;;</li><li>      <span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>()?.<span class="hljs-title function_">getParent</span>();</li><li>      <span class="hljs-keyword">if</span> (parent) {</li><li>        parent.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[]&gt;(buildText));</li><li>      <span class="hljs-comment">// 将创建的BuilderNode存入AppStorage</span></li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt;(<span class="hljs-string">"textNode"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span>({ <span class="hljs-attr">routeName</span>: <span class="hljs-string">"myIndex"</span> })</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">"isShowText"</span>, <span class="hljs-literal">true</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>())</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Router pageTwo'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 改变AppStorage中的状态变量触发Text节点的重新创建</span></li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">"isShowText"</span>, <span class="hljs-literal">false</span>);</li><li>            <span class="hljs-comment">// 将BuilderNode从AppStorage中移除</span></li><li>            <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"textNode"</span>);</li><li>
</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">replaceNamedRoute</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"pageTwo"</span> });</li><li>          })</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="buildernode中使用localstorage">BuilderNode中使用LocalStorage<i class="anchor-icon anchor-icon-link" anchorid="buildernode中使用localstorage" tips="复制节点链接"></i></h2>          <p>从API version 12开始，自定义组件支持接收<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage">LocalStorage</a>实例。可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#自定义组件接收localstorage实例">传递LocalStorage实例</a>来使用LocalStorage相关的装饰器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstorageprop">@LocalStorageProp</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstoragelink">@LocalStorageLink</a>。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">localStorage1</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>localStorage1.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'PropA'</span>, <span class="hljs-string">'PropA'</span>);</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">localStorage2</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>localStorage2.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'PropB'</span>, <span class="hljs-string">'PropB'</span>);</li><li>
</li><li><span class="hljs-meta">@Entry</span>(localStorage1)</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// 'PropA'，和localStorage1中'PropA'的双向同步</span></li><li>  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'PropA'</span>) <span class="hljs-title class_">PropA</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">controller</span>: <span class="hljs-title class_">NodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>, localStorage2);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">PropA</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        <span class="hljs-comment">// 使用LocalStorage 实例localStorage2</span></li><li>        <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> }, localStorage2)</li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">localStorage</span>: <span class="hljs-title class_">LocalStorage</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateChild</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-comment">//构造过程中传递localStorage</span></li><li>  <span class="hljs-title class_">Child</span>({ <span class="hljs-attr">count</span>: params.<span class="hljs-property">count</span> }, params.<span class="hljs-property">localStorage</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> count?: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable language_">localStorage</span> ?: <span class="hljs-title class_">LocalStorage</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">count: <span class="hljs-built_in">number</span>, <span class="hljs-variable language_">localStorage</span>: LocalStorage</span>) {</li><li>    <span class="hljs-variable language_">super</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = count;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStorage</span> = <span class="hljs-variable language_">localStorage</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">let</span> builderNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt;(uiContext);</li><li>    <span class="hljs-comment">//构造过程中传递localStorage</span></li><li>    builderNode.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">CreateChild</span>), { <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>, <span class="hljs-attr">localStorage</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStorage</span> });</li><li>    <span class="hljs-keyword">return</span> builderNode.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-comment">//  'Hello World'，和localStorage2中'PropB'的双向同步，如果localStorage2中没有'PropB'，则使用默认值'Hello World'</span></li><li>  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'PropB'</span>) <span class="hljs-title class_">PropB</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">PropB</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="查询当前buildernode是否解除引用">查询当前BuilderNode是否解除引用<i class="anchor-icon anchor-icon-link" anchorid="查询当前buildernode是否解除引用" tips="复制节点链接"></i></h2>          <p>前端节点均绑定有相应的后端实体节点，当节点调用dispose接口解除绑定后，再次调用接口可能会出现crash、返回默认值的情况。</p>     <p>从API version 20开始，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#isdisposed20" target="_blank">isDisposed</a>接口查询当前BuilderNode对象是否已解除与后端实体节点的引用关系，从而可以在操作节点前检查其有效性，避免潜在风险。</p>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">BuilderNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Test"</span>)</li><li>    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-property">commonAttribute</span>.<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[]&gt;(buildText));</li><li>
</li><li>    <span class="hljs-comment">// 挂载BuilderNode</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">disposeBuilderNode</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 解除BuilderNode与后端实体节点的引用关系</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">dispose</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">isDisposed</span>() : <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 查询BuilderNode是否解除引用</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">isDisposed</span>()) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">'builderNode isDisposed is true'</span>;</li><li>      }</li><li>      <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">'builderNode isDisposed is false'</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'builderNode is null'</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">myNodeController</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">4</span> }) {</li><li>      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'BuilderNode dispose'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>.<span class="hljs-title function_">disposeBuilderNode</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-string">''</span>;</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'BuilderNode isDisposed'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>.<span class="hljs-title function_">isDisposed</span>();</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">25</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="设置buildernode继承冻结能力">设置BuilderNode继承冻结能力<i class="anchor-icon anchor-icon-link" anchorid="设置buildernode继承冻结能力" tips="复制节点链接"></i></h2>          <p>ArkUI支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-custom-components-freeze">自定义组件冻结</a>，该功能冻结非激活状态组件的刷新能力。当组件处于非激活状态时，即便其绑定状态变量发生变化，也不会触发组件UI的重新渲染，从而减少复杂UI场景的刷新负载。</p>     <p>从API version 20开始，BuilderNode节点可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#inheritfreezeoptions20" target="_blank">inheritFreezeOptions</a>接口继承父自定义组件（即从该BuilderNode节点向上查找的第一个自定义组件）的冻结策略。当BuilderNode节点继承父自定义组件的冻结策略时，若父自定义组件的冻结策略设置为开启组件冻结（即<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-parameter#componentoptions" target="_blank">freezeWhenInactive</a>选项设为true），则BuilderNode节点在不活跃时将会冻结，当切换至活跃状态时解冻，并使用缓存的数据更新节点。</p>     <p>BuilderNode节点只有通过以下方式上下树时，才会根据该节点是否继承父自定义组件的冻结策略，来更新自己的冻结策略：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.15.5.1.3.1.1" valign="top" width="50%">类</th>         <th align="left" class="cellrowborder" id="mcps1.3.15.5.1.3.1.2" valign="top" width="50%">接口</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode" target="_blank">FrameNode</a></td>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#appendchild12" target="_blank">appendChild</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#insertchildafter12" target="_blank">insertChildAfter</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#removechild12" target="_blank">removeChild</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#clearchildren12" target="_blank">clearChildren</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#addcomponentcontent12" target="_blank">addComponentContent</a></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent" target="_blank">NodeContent</a></td>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent#addframenode12" target="_blank">addFrameNode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent#removeframenode12" target="_blank">removeFrameNode</a></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a></td>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller#makenode" target="_blank">makeNode</a></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode" target="_blank">RenderNode</a></td>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode#appendchild" target="_blank">appendChild</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode#insertchildafter" target="_blank">insertChildAfter</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode#removechild" target="_blank">removeChild</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-rendernode#clearchildren" target="_blank">clearChildren</a></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#nodeadapter12" target="_blank">NodeAdaper</a></td>         <td class="cellrowborder" valign="top" width="50%">节点通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">懒加载</a>方式上下树时</td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>当BuilderNode节点设置为继承父自定义组件的冻结策略时，BuilderNode节点的冻结策略将与其上层最近的自定义组件或BuilderNode节点的冻结策略保持一致。</p>       <p>当BuilderNode节点被冻结时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#update" target="_blank">update</a>接口不会触发节点的更新，等其被解冻时再更新节点。</p>      </div></div></div>     <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">count: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = count;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildText</span>(<span class="hljs-params">params: Params</span>) {</li><li>
</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">TextBuilder</span>({ <span class="hljs-attr">message</span>: params.<span class="hljs-property">count</span> })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(context);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(context, { <span class="hljs-attr">selfIdealSize</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">150</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">150</span> } });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(buildText), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>));</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">inheritFreezeOptions</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 设置BuilderNode的冻结继承状态为true</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">getFrameNode</span>()); <span class="hljs-comment">// 将BuilderNode上树</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">update</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNode</span>.<span class="hljs-title function_">update</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>)); <span class="hljs-comment">// 更新BuilderNode中的数据，可以触发Log</span></li><li>    }</li><li>
</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">textNodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyNavigationTestStack</span> {</li><li>  <span class="hljs-meta">@Provide</span>(<span class="hljs-string">'pageInfo'</span>) <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>();</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">logNumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">PageMap</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>) {</li><li>    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'pageOne'</span>) {</li><li>      <span class="hljs-title function_">pageOneStack</span>({ <span class="hljs-attr">message</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>, <span class="hljs-attr">logNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">logNumber</span> })</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'pageTwo'</span>) {</li><li>      <span class="hljs-title function_">pageTwoStack</span>({ <span class="hljs-attr">message</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>, <span class="hljs-attr">logNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">logNumber</span> })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'update builderNode'</span>) <span class="hljs-comment">// 点击更新BuildrNode</span></li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          textNodeController.<span class="hljs-title function_">update</span>();</li><li>        })</li><li>      <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Next Page'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'pageOne'</span> }); <span class="hljs-comment">// 将name指定的NavDestination页面信息入栈</span></li><li>            })</li><li>        }</li><li>      }.<span class="hljs-title function_">title</span>(<span class="hljs-string">'NavIndex'</span>)</li><li>      .<span class="hljs-title function_">navDestination</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">PageMap</span>)</li><li>      .<span class="hljs-title function_">mode</span>(<span class="hljs-title class_">NavigationMode</span>.<span class="hljs-property">Stack</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct pageOneStack {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'pageInfo'</span>) <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">logNumber</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NavigationContentMsgStack</span>({ <span class="hljs-attr">message</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>, <span class="hljs-attr">index</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>, <span class="hljs-attr">logNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">logNumber</span> })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Next Page'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pushPathByName</span>(<span class="hljs-string">'pageTwo'</span>, <span class="hljs-literal">null</span>);</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Back Page'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>          })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">'pageOne'</span>)</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct pageTwoStack {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'pageInfo'</span>) <span class="hljs-attr">pageInfo</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">logNumber</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">NavigationContentMsgStack</span>({ <span class="hljs-attr">message</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>, <span class="hljs-attr">index</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>, <span class="hljs-attr">logNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">logNumber</span> })</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'BuilderNode处于冻结'</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">48</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">48</span> })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Back Page'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>          })</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">'pageTwo'</span>)</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfo</span>.<span class="hljs-title function_">pop</span>();</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span>({ <span class="hljs-attr">freezeWhenInactive</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// 设置冻结策略为不活跃冻结</span></li><li>struct <span class="hljs-title class_">NavigationContentMsgStack</span> {</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">logNumber</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-title class_">NodeContainer</span>(textNodeController)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span>({ <span class="hljs-attr">freezeWhenInactive</span>: <span class="hljs-literal">true</span> }) <span class="hljs-comment">// 设置冻结策略为不活跃冻结</span></li><li>struct <span class="hljs-title class_">TextBuilder</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">"info"</span>) <span class="hljs-attr">message</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">info</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`freeze-test TextBuilder message callback <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message}</span>`</span>); <span class="hljs-comment">// 根据message内容变化来打印日志来判断是否冻结</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`文本更新次数： <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.message}</span>`</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">48</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">48</span> })</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     <p><span><img originheight="309" originwidth="297" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114940.72998917620299388284549933532434:50001231000000:2800:5382AA5818D22A6063A688EF256FAF85BB15BDFB69771B86B9EF4B5332195904.gif" class="notEnlarge" width="297" height="309"></span></p>    </div>    <div class="tiledSection">     <h2 id="设置buildernode支持内部consume接收外部的provide数据">设置BuilderNode支持内部@Consume接收外部的@Provide数据<i class="anchor-icon anchor-icon-link" anchorid="设置buildernode支持内部consume接收外部的provide数据" tips="复制节点链接"></i></h2>          <p>从API version 20开始，通过配置BuildOptions参数，BuilderNode内部自定义组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Consume</a>支持接收所在页面的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume">@Provide</a>数据。</p>     <p>参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#示例5buildernode支持内部consume接收外部的provide数据" target="_blank">示例代码</a>。</p>    </div>    <div class="tiledSection">     <h2 id="buildernode结合arkweb组件实现预渲染页面">BuilderNode结合ArkWeb组件实现预渲染页面<i class="anchor-icon anchor-icon-link" anchorid="buildernode结合arkweb组件实现预渲染页面" tips="复制节点链接"></i></h2>          <p>预渲染适用于Web页面启动与跳转等场景。通过结合BuilderNode，可以将ArkWeb组件提前进行离线预渲染，组件不会即时挂载至页面，而是在需要时通过NodeController动态挂载与显示。此举能够提高页面切换的流畅度及用户体验。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>访问在线网页时需添加网络权限：ohos.permission.INTERNET，具体申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>。</p>      </div></div></div>     <ol>      <li>       <p>创建载体Ability，并创建Web组件。</p>       <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 载体Ability</span></li><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { createNWeb } <span class="hljs-keyword">from</span> <span class="hljs-string">"../pages/common"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 创建ArkWeb动态组件（需传入UIContext），loadContent之后的任意时机均可创建。</span></li><li>      <span class="hljs-title function_">createNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>, windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">getUIContext</span>());</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>创建NodeContainer和对应的NodeController，渲染后台Web组件。</p>       <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建NodeController。</span></li><li><span class="hljs-comment">// common.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeController</span>, <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">Size</span>, <span class="hljs-title class_">FrameNode</span> }  <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// @Builder中为动态组件的具体组件内容。</span></li><li><span class="hljs-comment">// Data为入参封装类。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>{</li><li>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'https://www.example.com'</span>;</li><li>  <span class="hljs-attr">controller</span>: <span class="hljs-title class_">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>}</li><li><span class="hljs-comment">// 通过布尔变量shouldInactive控制网页在后台完成预渲染后停止渲染。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">shouldInactive</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebBuilder</span>(<span class="hljs-params">data:Data</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: data.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: data.<span class="hljs-property">controller</span> })</li><li>      .<span class="hljs-title function_">onPageBegin</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-comment">// 调用onActive，开启渲染。</span></li><li>        data.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onActive</span>();</li><li>      })</li><li>      .<span class="hljs-title function_">onFirstMeaningfulPaint</span>(<span class="hljs-function">() =&gt;</span>{</li><li>        <span class="hljs-keyword">if</span> (!shouldInactive) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 在预渲染完成时触发，停止渲染。</span></li><li>        data.<span class="hljs-property">controller</span>.<span class="hljs-title function_">onInactive</span>();</li><li>        shouldInactive = <span class="hljs-literal">false</span>;</li><li>      })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>  }</li><li>}</li><li><span class="hljs-keyword">let</span> wrap = wrapBuilder&lt;<span class="hljs-title class_">Data</span>[]&gt;(<span class="hljs-title class_">WebBuilder</span>);</li><li><span class="hljs-comment">// 用于控制和反馈对应的NodeContainer上的节点的行为，需要与NodeContainer一起使用。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">myNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootnode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Data</span>[]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-comment">// 必须要重写的方法，用于构建节点数、返回节点挂载在对应NodeContainer中。</span></li><li>  <span class="hljs-comment">// 在对应NodeContainer创建的时候调用、或者通过rebuild方法调用刷新。</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">" uicontext is undefined : "</span>+ (uiContext === <span class="hljs-literal">undefined</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootnode</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-comment">// 返回FrameNode节点。</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootnode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 返回null控制动态组件脱离绑定节点。</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当布局大小发生变化时进行回调。</span></li><li>  <span class="hljs-title function_">aboutToResize</span>(<span class="hljs-params">size: Size</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToResize width : "</span> + size.<span class="hljs-property">width</span>  +  <span class="hljs-string">" height : "</span> + size.<span class="hljs-property">height</span> );</li><li>  }</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Appear的时候进行回调。</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToAppear"</span>);</li><li>    <span class="hljs-comment">// 切换到前台后，不需要停止渲染。</span></li><li>    shouldInactive = <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-comment">// 当controller对应的NodeContainer在Disappear的时候进行回调。</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"aboutToDisappear"</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 此函数为自定义函数，可作为初始化函数使用。</span></li><li>  <span class="hljs-comment">// 通过UIContext初始化BuilderNode，再通过BuilderNode中的build接口初始化@Builder中的内容。</span></li><li>  <span class="hljs-title function_">initWeb</span>(<span class="hljs-params">url:<span class="hljs-built_in">string</span>, uiContext:UIContext, control:WebviewController</span>) {</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootnode</span> != <span class="hljs-literal">null</span>){</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建节点，需要uiContext。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootnode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-comment">// 创建动态Web组件。</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootnode</span>.<span class="hljs-title function_">build</span>(wrap, { <span class="hljs-attr">url</span>:url, <span class="hljs-attr">controller</span>:control });</li><li>  }</li><li>}</li><li><span class="hljs-comment">// 创建Map保存所需要的NodeController。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">NodeMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, myNodeController | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 创建Map保存所需要的WebViewController。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">controllerMap</span>:<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">WebviewController</span> | <span class="hljs-literal">undefined</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li><span class="hljs-comment">// 初始化需要UIContext 需在Ability获取。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createNWeb</span> = (<span class="hljs-params">url: <span class="hljs-built_in">string</span>, uiContext: UIContext</span>) =&gt; {</li><li>  <span class="hljs-comment">// 创建NodeController。</span></li><li>  <span class="hljs-keyword">let</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title function_">myNodeController</span>();</li><li>  <span class="hljs-keyword">let</span> controller = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>() ;</li><li>  <span class="hljs-comment">// 初始化自定义Web组件。</span></li><li>  baseNode.<span class="hljs-title function_">initWeb</span>(url, uiContext, controller);</li><li>  controllerMap.<span class="hljs-title function_">set</span>(url, controller);</li><li>  <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">set</span>(url, baseNode);</li><li>}</li><li><span class="hljs-comment">// 自定义获取NodeController接口。</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getNWeb = (url : <span class="hljs-built_in">string</span>) : myNodeController | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NodeMap</span>.<span class="hljs-title function_">get</span>(url);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过NodeContainer使用已经预渲染的页面。</p>       <div _ngcontent-frw-c106="" class="highlight-div"><div _ngcontent-frw-c106="" class="highlight-div-header"><div _ngcontent-frw-c106="" class="highlight-div-header-left"><div _ngcontent-frw-c106="" class="handle-button expand-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-frw-c106="" class="highlight-div-header-right"><div _ngcontent-frw-c106="" class="handle-button ai-button"></div><div _ngcontent-frw-c106="" class="handle-button line-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-frw-c106="" class="handle-button theme-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-frw-c106="" class="handle-button copy-button"><div _ngcontent-frw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-frw-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 使用NodeController的Page页。</span></li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { createNWeb, getNWeb } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common"</span>;</li><li>  </li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-comment">// NodeContainer用于与NodeController节点绑定，rebuild会触发makeNode。</span></li><li>        <span class="hljs-comment">// Page页通过NodeContainer接口绑定NodeController，实现动态组件页面显示。</span></li><li>        <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-title function_">getNWeb</span>(<span class="hljs-string">"https://www.example.com"</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">"90%"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>