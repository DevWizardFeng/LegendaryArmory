<h1 _ngcontent-kcu-c119="" class="doc-title ng-star-inserted" title="自定义存储插件配置"> 自定义存储插件配置 </h1>

<div _ngcontent-kcu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001839949485"><p id="ZH-CN_TOPIC_0000002478333740__p7644114918122">ohpm-repo从2.2.0版本开始支持自定义存储插件（需要配套使用1.7.0及以上版本ohpm命令行工具），允许您开发定制化的存储插件来对接您自己的存储系统，您希望将ohpm-repo下的三方包文件存储在华为云OBS或者其他云存储平台，可以按照如下步骤来实现自定义存储插件。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p id="ZH-CN_TOPIC_0000002478333740__p563041585218">当您使用自定义认证插件对接自己的存储系统时，如果存在网络通信，建议使用https协议，确保信息安全传输。</p> </div></div></div> <div class="tiledSection"><h2 id="section1294845133311">准备工作<i class="anchor-icon anchor-icon-link" anchorid="section1294845133311" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478333740__ol666325179192207"><li id="li846616424192207">下载ohpm-repo私仓工具安装包并解压。</li><li id="li16773142554612">进入ohpm-repo部署根目录，把模板文件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-template-file#section14188258114612">tsconfig.json 文件</a>移动到ohpm-repo解压根目录。</li><li id="li1657201278192207"><strong>建议</strong>将模板文件中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-template-file#section3671144204619">CustomStorage.ts</a>文件存入ohpm-repo解压根目录的plugins文件夹内。</li></ol> </div> <div class="tiledSection"><h2 id="section3872164573411">编辑CustomStorage.ts文件，实现存储插件接口StoragePlugin<i class="anchor-icon anchor-icon-link" anchorid="section3872164573411" tips="复制节点链接"></i></h2><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ul id="ZH-CN_TOPIC_0000002478333740__ul1883411451435"><li id="li198341245733">打开CustomStorage.ts模板文件，需要编写代码实现接口类StoragePlugin，实现init, save, delete, download和getDownloadUrl五个基础函数，实现类CustomStorage的名字可自定义修改。</li><li id="li1213648739">当使用自定义存储插件时，db存储位置必须为<strong>MySQL</strong>。</li></ul> </div></div></div> </div> <p id="ZH-CN_TOPIC_0000002478333740__p634613142192207">接口类StoragePlugin中包含如下五个函数，需要在实现类中完成功能的实现。</p> <div _ngcontent-kcu-c106="" class="highlight-div"><div _ngcontent-kcu-c106="" class="highlight-div-header"><div _ngcontent-kcu-c106="" class="highlight-div-header-left"><div _ngcontent-kcu-c106="" class="handle-button expand-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kcu-c106="" class="highlight-div-header-right"><div _ngcontent-kcu-c106="" class="handle-button ai-button"></div><div _ngcontent-kcu-c106="" class="handle-button line-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kcu-c106="" class="handle-button theme-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kcu-c106="" class="handle-button copy-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kcu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478333740__screen2063063693192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 存储插件接口类定义如下</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StoragePlugin</span> {</li><li> </li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 初始化插件</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">init</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt;;</li><li> </li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 上传文件</span></li><li><span class="hljs-comment">   * @param srcPath 上传文件的本地路径</span></li><li><span class="hljs-comment">   * @param packageInfo: 待上传包的详细信息，包括包名（含组织名）和包版本号两部分，包名：packageInfo.packageName，包版本：packageInfo.version.</span></li><li><span class="hljs-comment">   * @returns 响应的返回信息</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">save</span>(<span class="hljs-variable">srcPath</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">packageInfo</span>: <span class="hljs-title class_">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">string</span>&gt;; </li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 删除文件</span></li><li><span class="hljs-comment">   * @param savedResponse 上传文件的响应值</span></li><li><span class="hljs-comment">   * @returns 删除的结果：true表示删除成功</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">delete</span>(<span class="hljs-variable">savedResponse</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">boolean</span>&gt;;</li><li> </li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 获取以上传文件的数据</span></li><li><span class="hljs-comment">   * @param savedResponse 上传文件的响应值</span></li><li><span class="hljs-comment">   * @returns 获取文件的内容，数据格式为 Buffer</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">download</span>(<span class="hljs-variable">savedResponse</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Buffer</span>&gt;;</li><li>
</li><li>   <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 根据保存文件生成的结果字符串，获取文件下载url</span></li><li><span class="hljs-comment">   * @param savedResponse 保存文件的结果字符串</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">getDownloadUrl</span>(<span class="hljs-variable">savedResponse</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>}</li><li> </li></ol></pre></div></div> <ol id="ZH-CN_TOPIC_0000002478333740__ol13428122292714"><li id="li433246627192207"><p id="ZH-CN_TOPIC_0000002478333740__p2109511376192207"><a name="ZH-CN_TOPIC_0000002478333740__li433246627192207"></a><a name="li433246627192207"></a>init</p> <p id="ZH-CN_TOPIC_0000002478333740__p2120615834192207">实现初始化准备工作。在配置文件config.yaml中store.config处可自定义一些插件所需要的参数信息，可通过函数getStorageConfigInfo()读取配置文件中自定义的参数信息。</p> </li><li id="li1214353540192207"><p id="ZH-CN_TOPIC_0000002478333740__p1975232107192207"><a name="ZH-CN_TOPIC_0000002478333740__li1214353540192207"></a><a name="li1214353540192207"></a>save</p> <p id="ZH-CN_TOPIC_0000002478333740__p141324816507">实现本地文件的上传功能。返回值为一个字符串，能够标识所上传的文件。函数入参为上传文件的本地路径srcPath和待上传包的详细信息packageInfo，packageInfo为可选项。</p> <p id="ZH-CN_TOPIC_0000002478333740__p1736232120549">在实现save方法的时候，上传每一个三方包有三类文件待上传：</p> <ul id="ZH-CN_TOPIC_0000002478333740__ul20990134585413"><li id="li19990194555419">包文件（har包有：&lt;package_name&gt;.har一个文件，tgz包有：&lt;package_name&gt;.har和&lt;package_name&gt;.hsp两个文件）；</li><li id="li6990164585414">元数据文件（metadata.json文件）；</li><li id="li18990114515412">文档文件（readme.md和changelog.md文件）。</li></ul> <p id="ZH-CN_TOPIC_0000002478333740__p01334813503">由于后面两类文件在每个三方包中名称都相同，请存放在不同位置或者使用不同文件名存储，避免文件被覆盖。</p> </li><li id="li227878036192207"><p id="ZH-CN_TOPIC_0000002478333740__p434297295192207"><a name="ZH-CN_TOPIC_0000002478333740__li227878036192207"></a><a name="li227878036192207"></a>delete</p> <p id="ZH-CN_TOPIC_0000002478333740__p227781027192207">实现已上传文件的删除功能。函数入参为savedResponse：上传文件save后的返回信息，通过入参信息定位已上传文件，进行文件的删除；返回值信息为删除的结果，布尔类型。</p> </li><li id="li1173317253172">download<p id="ZH-CN_TOPIC_0000002478333740__p83031530131719"><a name="ZH-CN_TOPIC_0000002478333740__li1173317253172"></a><a name="li1173317253172"></a>实现已上传文件的内容读取功能。函数入参为savedResponse：上传文件save后的返回信息，通过入参信息定位已上传文件，进行文件内容读取；返回所读取到的文件信息，数据类型为Buffer。</p> </li><li id="li144281022172715"><p id="ZH-CN_TOPIC_0000002478333740__p1925391657192207"><a name="ZH-CN_TOPIC_0000002478333740__li144281022172715"></a><a name="li144281022172715"></a>getDownloadUrl</p> <p id="ZH-CN_TOPIC_0000002478333740__p144261242181716">实现已上传文件下载URL的获取。函数入参为savedResponse：上传文件save后的返回信息，通过入参信息定位已上传文件，进行文件内容读取；返回所读取到文件的下载URL，数据类型为String。</p> </li></ol> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ol id="ZH-CN_TOPIC_0000002478333740__ol87694260416"><li id="li5770162617413">在实现上述五个函数时，插件文件CustomStorage.ts需要引用：StoragePlugin接口类和getStorageConfigInfo方法，故需要根据当前插件文件CustomStorage.ts所在位置，正确地书写引用地址，被引用的接口类和方法地址如下：<ul id="ZH-CN_TOPIC_0000002478333740__ul1991153331720"><li id="li55161217252">getStorageConfigInfo方法所在文件的位置：ohpm-repo解压根目录/libs/common/getStorageConfigInfo</li><li id="li61610303181">StoragePlugin接口类所在文件的位置：ohpm-repo解压根目录/libs/plugins/storage/customStorage/StoragePlugin</li></ul> </li><li id="li56041302412">如果插件文件CustomStorage.ts存储在默认位置（ohpm-repo解压根目录的plugins文件夹内），插件文件CustomStorage.ts中引用StoragePlugin类和getStorageConfigInfo方法的默认地址如下：<ul id="ZH-CN_TOPIC_0000002478333740__ul131913555367"><li id="li6319185510363">import {StoragePlugin} from '../libs/plugins/storage/customStorage/StoragePlugin';</li><li id="li069115833619">import {getStorageConfigInfo} from '../libs/common/getStorageConfigInfo';</li></ul> </li></ol> </div></div></div> <div class="tiledSection"><h2 id="section58651533143513">使用插件文件和启动ohpm-repo<i class="anchor-icon anchor-icon-link" anchorid="section58651533143513" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478333740__ol1520538404192207"><li id="li41491451289">安装必要的npm包<p id="ZH-CN_TOPIC_0000002478333740__p1286351715299">安装typescript包，编译ts文件为js文件。</p> <div _ngcontent-kcu-c106="" class="highlight-div"><div _ngcontent-kcu-c106="" class="highlight-div-header"><div _ngcontent-kcu-c106="" class="highlight-div-header-left"><div _ngcontent-kcu-c106="" class="handle-button expand-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kcu-c106="" class="highlight-div-header-right"><div _ngcontent-kcu-c106="" class="handle-button ai-button"></div><div _ngcontent-kcu-c106="" class="handle-button line-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kcu-c106="" class="handle-button theme-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kcu-c106="" class="handle-button copy-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kcu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478333740__screen13287123961417" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">$ </span>npm i typescript -g</li></ol></pre></div></div> </li><li id="li535554465192207"><p id="ZH-CN_TOPIC_0000002478333740__p1466600073192207">编译插件文件</p> <ul id="ZH-CN_TOPIC_0000002478333740__ul590304761192207"><li id="li1171348702192207">如果CustomStorage.ts存放在ohpm-repo安装根目录的plugins文件夹中，在ohpm-repo安装根目录下执行编译命令。<div _ngcontent-kcu-c106="" class="highlight-div"><div _ngcontent-kcu-c106="" class="highlight-div-header"><div _ngcontent-kcu-c106="" class="highlight-div-header-left"><div _ngcontent-kcu-c106="" class="handle-button expand-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kcu-c106="" class="highlight-div-header-right"><div _ngcontent-kcu-c106="" class="handle-button ai-button"></div><div _ngcontent-kcu-c106="" class="handle-button line-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kcu-c106="" class="handle-button theme-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kcu-c106="" class="handle-button copy-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kcu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478333740__screen700581150192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">$ </span>tsc </li></ol></pre></div></div> </li><li id="li1507656819192207">命令成功执行后会在ohpm-repo解压目录的plugins/outDir文件夹中生成编译后的文件CustomStorage.js。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002478333740__p999105693020">如果CustomStorage.ts没有存放在plugins内，请先修改<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-template-file#section14188258114612">tsconfig.json</a>文件include和outDir参数，前者指定待编译插件代码的存储目录，后者指定编译完成后文件的输出位置，然后再在ohpm-repo解压根目录执行编译命令tsc。</p> <div _ngcontent-kcu-c106="" class="highlight-div"><div _ngcontent-kcu-c106="" class="highlight-div-header"><div _ngcontent-kcu-c106="" class="highlight-div-header-left"><div _ngcontent-kcu-c106="" class="handle-button expand-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kcu-c106="" class="highlight-div-header-right"><div _ngcontent-kcu-c106="" class="handle-button ai-button"></div><div _ngcontent-kcu-c106="" class="handle-button line-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kcu-c106="" class="handle-button theme-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kcu-c106="" class="handle-button copy-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kcu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478333740__screen714874842192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// tsconfig.json 文件中的默认配置</span></li><li><span class="hljs-comment">// 默认值：插件存放在 ./plugins 中，编译后的文件存放在./plugins/outDir中</span></li><li><span class="hljs-string">"include"</span>: <span class="hljs-string">"plugins/*"</span>          <span class="hljs-comment">// 插件文件的位置</span></li><li><span class="hljs-string">"outDir"</span>: <span class="hljs-string">"./plugins/outDir"</span>    <span class="hljs-comment">// 编译后文件的存放位置</span></li></ol></pre></div></div> </div></div></div> </li></ul> </li><li id="li2076692259192207"><p id="ZH-CN_TOPIC_0000002478333740__p235000461192207">编译后文件存放指定位置</p> <p id="ZH-CN_TOPIC_0000002478333740__p1836401416192207">编译后获得的CustomStorage.js需要与CustomStorage.ts保持在同一级目录中，否则会运行出错，默认输出在./plugins/outDir 内，需要把CustomStorage.js拷贝到CustomStorage.ts同级目录./plugins中（ohpm-repo成功启动后可删除CustomStorage.ts文件）。</p> </li><li id="li1975328939192207"><p id="ZH-CN_TOPIC_0000002478333740__p670928449192207">编辑配置文件</p> <p id="ZH-CN_TOPIC_0000002478333740__p1682009451192207">为了保证ohpm-repo能够正确加载自定义存储插件，需要修改配置文件config.yaml，主要涉及store处内容修改。</p> <div _ngcontent-kcu-c106="" class="highlight-div"><div _ngcontent-kcu-c106="" class="highlight-div-header"><div _ngcontent-kcu-c106="" class="highlight-div-header-left"><div _ngcontent-kcu-c106="" class="handle-button expand-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kcu-c106="" class="highlight-div-header-right"><div _ngcontent-kcu-c106="" class="handle-button ai-button"></div><div _ngcontent-kcu-c106="" class="handle-button line-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kcu-c106="" class="handle-button theme-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kcu-c106="" class="handle-button copy-button"><div _ngcontent-kcu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kcu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478333740__screen1651252936192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置文件中 store 项的格式参考</span></li><li><span class="hljs-variable">store</span>:</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">custom</span>    </li><li>  <span class="hljs-variable">config</span>:        </li><li>    <span class="hljs-variable">export_name</span>: <span class="hljs-title class_">CustomStorage</span>         </li><li>    <span class="hljs-variable">plugin_path</span>: <span class="hljs-title class_">plugins</span>/<span class="hljs-variable">CustomStorage</span>.<span class="hljs-variable">js</span>    </li><li>    <span class="hljs-variable">custom_field</span>: <span class="hljs-string">"test"</span> </li><li>    #<span class="hljs-variable">server</span>: <span class="hljs-title class_">http</span>:<span class="hljs-comment">//localhost:8088</span></li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478333740__p179353318192207"><strong>参数说明</strong><strong>：</strong></p> <ul id="ZH-CN_TOPIC_0000002478333740__ul931927873192207"><li id="li2090790552192207">type: 插件名称，如果是自定义插件，值必须为：custom。</li><li id="li1778245918192207">config: 插件配置项，具体为：<ul id="ZH-CN_TOPIC_0000002478333740__ul727512540192207"><li id="li1354508322192207">export_name: <strong>必填</strong>，自定义插件文件CustomStorage.js中定义的实现类名称，如果实现类为CustomStorage，故此处export_name值为：CustomStorage。</li><li id="li871710263192207">plugin_path: <strong>必填</strong>，编译后插件文件CustomStorage.js的存储位置。支持绝对路径和相对路径，相对路径的基准为ohpm-repo解压根目录。</li><li id="li1094059140192207">custom_field: <strong>选填</strong>，可配置多个，自定义名称和值，值的类型为字符串，方便在插件文件CustomStorage.ts中通过函数getStorageConfigInfo()进行读取。参考上述store项的格式，已添加配置参数custom_field，故getStorageConfigInfo()函数的返回结果中会包含与custom_field配置项同名的属性。</li><li id="zh-cn_topic_0000001745376470_li922300957171146">server: <strong>选填项</strong>，仓库内容的下载地址，但当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-configuration#zh-cn_topic_0000001745376470_listen">listen</a>的host为0.0.0.0且本机存在多个网络接口时，则必须配置。<ul id="ZH-CN_TOPIC_0000002478333740__ul142881818153816"><li id="li14969195681913">server的格式如下：&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-configuration#zh-cn_topic_0000001745376470_listen">listen</a> 的proto&gt;://&lt;host&gt;:&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-configuration#zh-cn_topic_0000001745376470_listen">listen</a> 的port&gt;</li><li id="li18288151883819">当配置项<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-configuration#zh-cn_topic_0000001745376470_listen">listen</a>的host不为0.0.0.0时，则server<strong>默认</strong>取listen的完整格式，例如listen为127.0.0.1:8088，故server默认值为http://127.0.0.1:8088；</li><li id="li1528831819381">当配置项<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-repo-configuration#zh-cn_topic_0000001745376470_listen">listen</a>的host为0.0.0.0时，如果本机仅存在一个网络接口，则server中的host默认为 本机网络接口的ipv4地址；如果本机存在多个网络接口，则server中的host默认为本机获取到的第一个网络接口的ipv4地址，建议手动修改host为指定的本机ip/域名，例如listen为0.0.0.0:8088，故server需配置为http://&lt;本机ip/域名&gt;:8088；</li><li id="li1128831818389">如果需要通过反向代理来访问ohpm-repo服务，则该字段须配置为反向代理服务器的域名地址。</li></ul> </li></ul> </li></ul> </li><li id="li1146379329192207"><p id="ZH-CN_TOPIC_0000002478333740__p1375085967192207">ohpm-repo服务部署</p> <p id="ZH-CN_TOPIC_0000002478333740__p940576546192207">在完成上述操作之后，按照ohpm-repo部署指导，完成服务部署。</p> </li></ol> </div> </div> <div></div></div>