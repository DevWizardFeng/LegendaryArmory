<h1 _ngcontent-mtq-c119="" class="doc-title ng-star-inserted" title="自定义渲染 (XComponent)"> 自定义渲染 (XComponent) </h1>

<div _ngcontent-mtq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="概述">概述<i class="anchor-icon anchor-icon-link" anchorid="概述" tips="复制节点链接"></i></h2>          <p>XComponent组件作为一种渲染组件，可用于EGL/OpenGLES和媒体数据写入，通过使用XComponent持有的“<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-window-guidelines">NativeWindow</a>”来渲染画面，通常用于满足开发者较为复杂的自定义渲染需求，例如相机预览流的显示和游戏画面的渲染。其可通过指定type字段来实现不同的渲染方式，分别为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-appendix-enums#xcomponenttype10" target="_blank">XComponentType</a>.SURFACE和XComponentType.TEXTURE。对于SURFACE类型，开发者将定制的绘制内容单独展示到屏幕上。对于TEXTURE类型，开发者将定制的绘制内容和XComponent组件的内容合成后展示到屏幕上。</p>     <p>XComponent持有一个Surface，开发者能通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-window-guidelines">NativeWindow</a>等接口，申请并提交Buffer至图形队列，以此方式将自绘制内容传送至该Surface。XComponent负责将此Surface整合进UI界面，其中展示的内容正是开发者传送的自绘制内容。Surface的默认位置与大小与XComponent组件一致，开发者可利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#setxcomponentsurfacerect12" target="_blank">setXComponentSurfaceRect</a>接口自定义调整Surface的位置和大小。XComponent组件负责创建Surface，并通过回调将Surface的相关信息告知应用。应用可以通过一系列接口设定Surface的属性。该组件本身不对所绘制的内容进行感知，亦不提供渲染绘制的接口。</p>     <p>目前XComponent组件主要有三个应用场景：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.1" valign="top" width="33.33333333333333%">XComponent组件应用场景</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.2" valign="top" width="33.33333333333333%">场景简介</th>         <th align="left" class="cellrowborder" id="mcps1.3.1.5.1.4.1.3" valign="top" width="33.33333333333333%">场景特点</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines#使用xcomponentcontroller管理surface生命周期">使用XComponentController管理Surface生命周期场景</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">该场景在ArkTS侧的XComponentController获取SurfaceId，生命周期回调、触摸、鼠标、按键等事件回调等均在ArkTS侧触发。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">适用于视频播放、相机预览等媒体播放类场景，该场景需要在ArkTS侧获取SurfaceId，并将SurfaceId传入对应接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines#使用oh_arkui_surfaceholder管理surface生命周期">使用OH_ArkUI_SurfaceHolder管理Surface生命周期场景</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">该场景根据XComponent组件对应的ArkUI_NodeHandle创建OH_ArkUI_SurfaceHolder，生命周期回调、触摸等事件回调、无障碍和可变帧率回调等均在Native侧触发。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">          <p>适用于如下场景：</p>          <p>1.有较复杂的交互逻辑、对频繁跨语言调用导致性能损耗敏感的场景。</p>          <p>2.希望能控制Surface生命周期触发时机的场景。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><a href="/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines#使用nativexcomponent管理surface生命周期">使用NativeXComponent管理Surface生命周期场景</a></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">该场景在native层获取Native XComponent实例，在Native侧注册XComponent的生命周期回调，以及触摸、鼠标、按键等事件回调。</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">与<a href="/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines#使用oh_arkui_surfaceholder管理surface生命周期">使用OH_ArkUI_SurfaceHolder管理Surface生命周期场景</a>类似，但交互事件接口不够丰富，且使用不当容易出现稳定性问题，建议使用OH_ArkUI_SurfaceHolder的接口。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="约束与限制">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="约束与限制" tips="复制节点链接"></i></h2>          <p>当开发者传输的绘制内容包含透明元素时，Surface区域的显示效果会与下方内容进行合成展示。例如，若传输的内容完全透明，且XComponent的背景色被设置为黑色，同时Surface保持默认的大小与位置，则最终显示的将是一片黑色区域。</p>    </div>    <div class="tiledSection">     <h2 id="使用xcomponentcontroller管理surface生命周期">使用XComponentController管理Surface生命周期<i class="anchor-icon anchor-icon-link" anchorid="使用xcomponentcontroller管理surface生命周期" tips="复制节点链接"></i></h2>          <p>本场景通过在ArkTS侧获取SurfaceId，布局信息、生命周期回调、触摸、鼠标、按键等事件回调等均在ArkTS侧触发，按需传递到Native侧进行处理。主要开发场景如下：</p>     <ul>      <li>基于ArkTS侧获取的SurfaceId，在Native侧调用OH_NativeWindow_CreateNativeWindowFromSurfaceId接口创建出NativeWindow实例。</li>      <li>利用NativeWindow和EGL接口开发自定义绘制内容以及申请和提交Buffer到图形队列。</li>      <li>ArkTS侧获取生命周期、事件等信息传递到Native侧处理。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>         <p>Native侧的NativeWindow缓存在字典中，其key需要保证其唯一性，当对应的XComponent销毁后，需要及时从字典里将其删除。</p></li>        <li>         <p>对于使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#typenode12" target="_blank">typeNode</a>创建的SURFACE或TEXTURE类型的XComponent组件，由于typeNode组件的生命周期与声明式组件存在差异，组件在创建后的缓冲区尺寸为未设置状态，因此在开始绘制内容之前，应调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-external-window-h#oh_nativewindow_nativewindowhandleopt" target="_blank">OH_NativeWindow_NativeWindowHandleOpt</a>接口进行缓冲区尺寸设置。</p></li>        <li>         <p>多个XComponent开发时，缓存Native侧资源需要保证key是唯一的，key推荐使用id+随机数或者surfaceId。</p></li>        <li>         <p>在onSurfaceCreated回调触发后，才能获取到有效的surfaceId。</p></li>       </ol>      </div></div></div>     <p><strong>效果预览</strong></p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.4.1.1" valign="top" width="33.33333333333333%">主页</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.4.1.2" valign="top" width="33.33333333333333%">绘制五角星</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.6.1.4.1.3" valign="top" width="33.33333333333333%">改变颜色</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><span><img originheight="747" originwidth="464" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.17601759769431087607246582458117:50001231000000:2800:732E3C7A9E1E3E9C45CAD9D0A79523F0CBAA59AD74DADA180A04CE1348A45986.png" width="282.66666666666663" height="455.06896551724134"></span></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><span><img originheight="734" originwidth="466" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.84927308565174010723446860481288:50001231000000:2800:68122A42B1665C0F745FE36ABADF29CD8244D068B4E506D1B80E1CD03A5E0576.png" width="282.66666666666663" height="445.23032904148783"></span></td>         <td class="cellrowborder" valign="top" width="33.33333333333333%"><span><img originheight="729" originwidth="463" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.00155449540750968348638922775514:50001231000000:2800:B77869272A7B9968EABAB3B9559DA2EDB7B36D52823262D68469F0B1D75BF8A1.png" width="282.66666666666663" height="445.06263498920083"></span></td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>         <p>安装编译生成的hap包，并打开应用。</p></li>        <li>         <p>点击页面底部“Draw Star”按钮，页面将绘制一个五角星。</p></li>        <li>         <p>点击XComponent组件区域（页面中灰色区域）改变五角星颜色。</p></li>       </ol>      </div></div></div>     <p><strong>生命周期</strong>：</p>     <ul>      <li>       <p>onSurfaceCreated回调</p>       <p>触发时刻：XComponent创建完成且创建好Surface后触发。</p>       <p>ArkTS侧onSurfaceCreated的时序如下图：</p>       <p><span><img originheight="139" originwidth="319" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.74572745883078327041644120931519:50001231000000:2800:D713D9721607CCFD3283D4397CF44E42AB0911E1C96D576259BC9F6DDA38A400.png" width="319" height="139"></span></p></li>      <li>       <p>onSurfaceChanged回调</p>       <p>触发时刻：Surface大小变化触发重新布局之后触发。</p>       <p>ArkTS侧onSurfaceChanged的时序如下图：</p>       <p><span><img originheight="141" originwidth="317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.82829095685668360802847976489197:50001231000000:2800:9F9CF65FB3CCFBE187275CDFFE821EBB2BE056948B46E91F135117A59144C332.png" width="317" height="141"></span></p></li>      <li>       <p>onSurfaceDestroyed回调</p>       <p>触发时刻：XComponent组件被销毁时触发，与一般ArkUI的组件销毁时机一致。</p>       <p>ArkTS侧onSurfaceDestroyed的时序图：</p>       <p><span><img originheight="142" originwidth="316" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.01109514542349519311817278749911:50001231000000:2800:2A2BB9B228CEF78EA83A5FAE20FF6BC86A2F930F1D1FFFE58685DF3298DFAD9A.png" width="316" height="142"></span></p></li>     </ul>     <p><strong>接口说明</strong></p>     <p>ArkTS侧的XComponentController</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.12.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.12.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">getXComponentSurfaceId(): string</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent对应Surface的ID。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">onSurfaceCreated(surfaceId: string): void</td>         <td class="cellrowborder" valign="top" width="50%">当XComponent持有的Surface创建后进行该回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">onSurfaceChanged(surfaceId: string, rect: SurfaceRect): void</td>         <td class="cellrowborder" valign="top" width="50%">当XComponent持有的Surface大小改变后（包括首次创建时的大小改变）进行该回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">onSurfaceDestroyed(surfaceId: string): void</td>         <td class="cellrowborder" valign="top" width="50%">当XComponent持有的Surface销毁后进行该回调。</td>        </tr>             </tbody></table></div>     </div>     <p>Native侧</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.14.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.3.14.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">int32_t OH_NativeWindow_CreateNativeWindowFromSurfaceId (uint64_t surfaceId, OHNativeWindow **window )</td>         <td class="cellrowborder" valign="top" width="50%">通过surfaceId创建对应的OHNativeWindow。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">void OH_NativeWindow_DestroyNativeWindow (OHNativeWindow* window)</td>         <td class="cellrowborder" valign="top" width="50%">将OHNativeWindow对象的引用计数减1，当引用计数为0的时候，该OHNativeWindow对象会被析构掉。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>开发步骤</strong></p>     <p>核心开发流程如下图所示：</p>     <p><span><img originheight="214" originwidth="501" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.31889448052251959222925193439347:50001231000000:2800:351052BEED68C6E83F52B467C5EB6193BA135F738E4A8533AD18A0A1F012846E.png" width="501" height="214"></span></p>     <p>以下步骤以SURFACE类型为例，描述了如何使用XComponent组件在ArkTS侧传入SurfaceId，在Native侧创建NativeWindow实例，然后创建EGL/GLES环境，实现在主页面绘制图形，并可以改变图形的颜色。</p>     <ol>      <li>       <p>在界面中定义XComponent，在cpp/types/libnativerender/Index.d.ts中声明接口，具体实现位于Native侧。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="javascript prettyprint linenums hljs language-javascript" hw-language="javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 函数声明，在cpp/types/libnativerender/Index.d.ts中定义</span></li><li>type <span class="hljs-title class_">XComponentContextStatus</span> = {</li><li>    <span class="hljs-attr">hasDraw</span>: boolean,</li><li>    <span class="hljs-attr">hasChangeColor</span>: boolean,</li><li>};</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SetSurfaceId</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span></span>) =&gt;</span> any;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ChangeSurface</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span>, w: number, h: number</span>) =&gt;</span>any;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DrawPattern</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span></span>) =&gt;</span> any;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GetXComponentStatus</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span></span>) =&gt;</span> <span class="hljs-title class_">XComponentContextStatus</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ChangeColor</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span></span>) =&gt;</span> any;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DestroySurface</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">BigInt</span></span>) =&gt;</span> any;</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> nativeRender <span class="hljs-keyword">from</span> <span class="hljs-string">'libnativerender.so'</span>;</li><li>
</li><li><span class="hljs-comment">// 重写XComponentController，设置生命周期回调</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyXComponentController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">XComponentController</span> {</li><li>    <span class="hljs-title function_">onSurfaceCreated</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onSurfaceCreated surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>)</li><li>        nativeRender.<span class="hljs-title class_">SetSurfaceId</span>(<span class="hljs-title class_">BigInt</span>(surfaceId));</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onSurfaceChanged</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">rect</span>: <span class="hljs-title class_">SurfaceRect</span>): <span class="hljs-built_in">void</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onSurfaceChanged surfaceId: <span class="hljs-subst">${surfaceId}</span>, rect: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(rect)}</span>}`</span>)</li><li>        <span class="hljs-comment">// 在onSurfaceChanged中调用ChangeSurface绘制内容</span></li><li>        nativeRender.<span class="hljs-title class_">ChangeSurface</span>(<span class="hljs-title class_">BigInt</span>(surfaceId), rect.<span class="hljs-property">surfaceWidth</span>, rect.<span class="hljs-property">surfaceHeight</span>)</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">onSurfaceDestroyed</span>(<span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onSurfaceDestroyed surfaceId: <span class="hljs-subst">${surfaceId}</span>`</span>)</li><li>        nativeRender.<span class="hljs-title class_">DestroySurface</span>(<span class="hljs-title class_">BigInt</span>(surfaceId))</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">currentStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"index"</span>;</li><li>    <span class="hljs-attr">xComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyXComponentController</span>();</li><li>
</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>            <span class="hljs-comment">//在xxx.ets 中定义 XComponent</span></li><li>            <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>                <span class="hljs-title class_">XComponent</span>({</li><li>                    <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>                    <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentController</span></li><li>                })</li><li>            <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'24fp'</span>)</li><li>                .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>            }</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">let</span> surfaceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>()</li><li>                nativeRender.<span class="hljs-title class_">ChangeColor</span>(<span class="hljs-title class_">BigInt</span>(surfaceId))</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-attr">hasChangeColor</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>                <span class="hljs-keyword">if</span> (nativeRender.<span class="hljs-title class_">GetXComponentStatus</span>(<span class="hljs-title class_">BigInt</span>(surfaceId))) {</li><li>                    hasChangeColor = nativeRender.<span class="hljs-title class_">GetXComponentStatus</span>(<span class="hljs-title class_">BigInt</span>(surfaceId)).<span class="hljs-property">hasChangeColor</span>;</li><li>                }</li><li>                <span class="hljs-keyword">if</span> (hasChangeColor) {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span> = <span class="hljs-string">"change color"</span>;</li><li>                }</li><li>            })</li><li>
</li><li>            <span class="hljs-comment">//...</span></li><li>            <span class="hljs-title class_">Row</span>() {</li><li>                <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Draw Star'</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'16fp'</span>)</li><li>                    .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>                    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">24</span> })</li><li>                    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                        <span class="hljs-keyword">let</span> surfaceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>()</li><li>                        nativeRender.<span class="hljs-title class_">DrawPattern</span>(<span class="hljs-title class_">BigInt</span>(surfaceId))</li><li>                        <span class="hljs-keyword">let</span> <span class="hljs-attr">hasDraw</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>                        <span class="hljs-keyword">if</span> (nativeRender.<span class="hljs-title class_">GetXComponentStatus</span>(<span class="hljs-title class_">BigInt</span>(surfaceId))) {</li><li>                            hasDraw = nativeRender.<span class="hljs-title class_">GetXComponentStatus</span>(<span class="hljs-title class_">BigInt</span>(surfaceId)).<span class="hljs-property">hasDraw</span>;</li><li>                        }</li><li>                        <span class="hljs-keyword">if</span> (hasDraw) {</li><li>                            <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span> = <span class="hljs-string">"draw star"</span></li><li>                        }</li><li>                    })</li><li>                    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'53.6%'</span>)</li><li>                    .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>            .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span>)</li><li>            .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API模块注册，具体使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines">Node-API开发规范</a>。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li>#include &lt;hilog/log.<span class="hljs-property">h</span>&gt;</li><li>#include <span class="hljs-string">"common/common.h"</span></li><li>#include <span class="hljs-string">"manager/plugin_manager.h"</span></li><li><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">NativeXComponentSample</span> {</li><li><span class="hljs-comment">// 在napi_init.cpp文件中，Init方法注册接口函数，从而将封装的C++方法传递出来，供ArkTS侧调用</span></li><li><span class="hljs-variable constant_">EXTERN_C_START</span></li><li><span class="hljs-keyword">static</span> napi_value <span class="hljs-title class_">Init</span>(napi_env env, napi_value <span class="hljs-built_in">exports</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 向ArkTS侧暴露接口SetSurfaceId(),ChangeSurface(),DestroySurface(),</span></li><li>    <span class="hljs-comment">// DrawPattern(),ChangeColor(),GetXComponentStatus()</span></li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"SetSurfaceId"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">SetSurfaceId</span>, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>        {<span class="hljs-string">"ChangeSurface"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">ChangeSurface</span>, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>        {<span class="hljs-string">"DestroySurface"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">DestroySurface</span>, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>        {<span class="hljs-string">"DrawPattern"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">DrawPattern</span>, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>        {<span class="hljs-string">"ChangeColor"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">ChangeColor</span>, nullptr, nullptr, nullptr, napi_default, nullptr},</li><li>        {<span class="hljs-string">"GetXComponentStatus"</span>, nullptr, <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">GetXComponentStatus</span>, nullptr, nullptr, nullptr, napi_default,</li><li>         nullptr}};</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">napi_define_properties</span>(env, <span class="hljs-built_in">exports</span>, <span class="hljs-title function_">sizeof</span>(desc) / <span class="hljs-title function_">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc) != napi_ok) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable constant_">LOG_APP</span>, <span class="hljs-variable constant_">LOG_ERROR</span>, <span class="hljs-variable constant_">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Init"</span>, <span class="hljs-string">"napi_define_properties failed"</span>);</li><li>        <span class="hljs-keyword">return</span> nullptr;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;</li><li>}</li><li><span class="hljs-variable constant_">EXTERN_C_END</span></li><li><span class="hljs-comment">// 编写接口的描述信息，根据实际需要可以修改对应参数</span></li><li><span class="hljs-keyword">static</span> napi_module nativerenderModule = {.<span class="hljs-property">nm_version</span> = <span class="hljs-number">1</span>,</li><li>                                         .<span class="hljs-property">nm_flags</span> = <span class="hljs-number">0</span>,</li><li>                                         .<span class="hljs-property">nm_filename</span> = nullptr,</li><li>                                         <span class="hljs-comment">// 入口函数</span></li><li>                                         .<span class="hljs-property">nm_register_func</span> = <span class="hljs-title class_">Init</span>,</li><li>                                         <span class="hljs-comment">// 模块名称</span></li><li>                                         .<span class="hljs-property">nm_modname</span> = <span class="hljs-string">"nativerender"</span>,</li><li>                                         .<span class="hljs-property">nm_priv</span> = ((<span class="hljs-built_in">void</span> *)<span class="hljs-number">0</span>),</li><li>                                         .<span class="hljs-property">reserved</span> = {<span class="hljs-number">0</span>}};</li><li>} <span class="hljs-comment">// namespace NativeXComponentSample</span></li><li><span class="hljs-comment">// __attribute__((constructor))修饰的方法由系统自动调用，使用Node-API接口napi_module_register()传入模块描述信息进行模块注册</span></li><li>extern <span class="hljs-string">"C"</span> <span class="hljs-title function_">__attribute__</span>((constructor)) <span class="hljs-built_in">void</span> <span class="hljs-title class_">RegisterModule</span>(<span class="hljs-built_in">void</span>) {</li><li>    <span class="hljs-title function_">napi_module_register</span>(&amp;<span class="hljs-title class_">NativeXComponentSample</span>::nativerenderModule);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>上述注册的六个函数在Native侧的具体实现如下：ChangeColor和DrawPattern利用OpenGL(https://developer.huawei.com/consumer/cn/doc/harmonyos-references/opengl)进行五角星的绘制；ChangeSurface根据传入的surfaceId、width、height调整Surface的大小；SetSurfaceId基于SurfaceId完成NativeWindow的初始化；DestroySurface销毁与Surface相关的资源；GetXComponentStatus获取xcomponent状态并返回至ArkTS侧。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// PluginManager类定义</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginManager</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    ~<span class="hljs-built_in">PluginManager</span>();</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> PluginRender *<span class="hljs-title">GetPluginRender</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> &amp;id)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ChangeColor</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DrawPattern</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetSurfaceId</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ChangeSurface</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DestroySurface</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetXComponentStatus</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;<span class="hljs-type">int64_t</span>, PluginRender *&gt; pluginRenderMap_;</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;<span class="hljs-type">int64_t</span>, OHNativeWindow *&gt; windowMap_;</li><li>};</li><li>
</li><li><span class="hljs-comment">// 解析从ArkTS侧传入的surfaceId，此处surfaceId是一个64位int值</span></li><li><span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">ParseId</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((env == <span class="hljs-literal">nullptr</span>) || (info == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ParseId"</span>, <span class="hljs-string">"env or info is null"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ParseId"</span>, <span class="hljs-string">"GetContext napi_get_cb_info failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> value = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">bool</span> lossless = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_value_bigint_int64</span>(env, args[<span class="hljs-number">0</span>], &amp;value, &amp;lossless)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"ParseId"</span>, <span class="hljs-string">"Get value failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> value;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置SurfaceId，基于SurfaceId完成对NativeWindow的初始化</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::SetSurfaceId</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-built_in">ParseId</span>(env, info);</li><li>    OHNativeWindow *nativeWindow;</li><li>    PluginRender *pluginRender;</li><li>    <span class="hljs-keyword">if</span> (windowMap_.<span class="hljs-built_in">find</span>(surfaceId) == windowMap_.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-built_in">OH_NativeWindow_CreateNativeWindowFromSurfaceId</span>(surfaceId, &amp;nativeWindow);</li><li>        windowMap_[surfaceId] = nativeWindow;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (pluginRenderMap_.<span class="hljs-built_in">find</span>(surfaceId) == pluginRenderMap_.<span class="hljs-built_in">end</span>()) {</li><li>        pluginRender = <span class="hljs-keyword">new</span> <span class="hljs-built_in">PluginRender</span>(surfaceId);</li><li>        pluginRenderMap_[surfaceId] = pluginRender;</li><li>    }</li><li>    pluginRender-&gt;<span class="hljs-built_in">InitNativeWindow</span>(nativeWindow);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PluginRender::InitNativeWindow</span><span class="hljs-params">(OHNativeWindow *window)</span> </span>{</li><li>    eglCore_-&gt;<span class="hljs-built_in">EglContextInit</span>(window); <span class="hljs-comment">// 参考Native XComponent场景EglContextInit的实现</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 根据传入的surfaceId、width、height实现Surface大小的变动</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::ChangeSurface</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((env == <span class="hljs-literal">nullptr</span>) || (info == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"ChangeSurface: OnLoad env or info is null"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    napi_value args[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"ChangeSurface: GetContext napi_get_cb_info failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">bool</span> lossless = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_value_bigint_int64</span>(env, args[index++], &amp;surfaceId, &amp;lossless)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"ChangeSurface: Get value failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">double</span> width;</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_value_double</span>(env, args[index++], &amp;width)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"ChangeSurface: Get width failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">double</span> height;</li><li>    <span class="hljs-keyword">if</span> (napi_ok != <span class="hljs-built_in">napi_get_value_double</span>(env, args[index++], &amp;height)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"ChangeSurface: Get height failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> pluginRender = <span class="hljs-built_in">GetPluginRender</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (pluginRender == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"ChangeSurface: Get pluginRender failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    pluginRender-&gt;<span class="hljs-built_in">UpdateNativeWindowSize</span>(width, height);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PluginRender::UpdateNativeWindowSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> </span>{</li><li>    eglCore_-&gt;<span class="hljs-built_in">UpdateSize</span>(width, height); <span class="hljs-comment">// 参考Native XComponent场景UpdateSize的实现</span></li><li>    <span class="hljs-keyword">if</span> (!hasChangeColor_ &amp;&amp; !hasDraw_) {</li><li>        eglCore_-&gt;<span class="hljs-built_in">Background</span>(); <span class="hljs-comment">// 参考Native XComponent场景Background的实现</span></li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 销毁Surface</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::DestroySurface</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-built_in">ParseId</span>(env, info);</li><li>    <span class="hljs-keyword">auto</span> pluginRenderMapIter = pluginRenderMap_.<span class="hljs-built_in">find</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (pluginRenderMapIter != pluginRenderMap_.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-keyword">delete</span> pluginRenderMapIter-&gt;second;</li><li>        pluginRenderMap_.<span class="hljs-built_in">erase</span>(pluginRenderMapIter);</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> windowMapIter = windowMap_.<span class="hljs-built_in">find</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (windowMapIter != windowMap_.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-built_in">OH_NativeWindow_DestroyNativeWindow</span>(windowMapIter-&gt;second);</li><li>        windowMap_.<span class="hljs-built_in">erase</span>(windowMapIter);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 实现EGL绘画逻辑</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::DrawPattern</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-built_in">ParseId</span>(env, info);</li><li>    <span class="hljs-keyword">auto</span> pluginRender = <span class="hljs-built_in">GetPluginRender</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (pluginRender == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"DrawPattern: Get pluginRender failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    pluginRender-&gt;<span class="hljs-built_in">DrawPattern</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">PluginRender *<span class="hljs-title">PluginManager::GetPluginRender</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> &amp;id)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (pluginRenderMap_.<span class="hljs-built_in">find</span>(id) != pluginRenderMap_.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-keyword">return</span> pluginRenderMap_[id];</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PluginRender::DrawPattern</span><span class="hljs-params">()</span> </span>{</li><li>    eglCore_-&gt;<span class="hljs-built_in">Draw</span>(hasDraw_); <span class="hljs-comment">// 参考Native XComponent场景Draw实现</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 实现改变绘制图形颜色的功能</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::ChangeColor</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-built_in">ParseId</span>(env, info);</li><li>    <span class="hljs-keyword">auto</span> pluginRender = <span class="hljs-built_in">GetPluginRender</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (pluginRender == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"ChangeColor: Get pluginRender failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    pluginRender-&gt;<span class="hljs-built_in">ChangeColor</span>(); <span class="hljs-comment">// 参考Native XComponent场景ChangeColor实现</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PluginRender::ChangeColor</span><span class="hljs-params">()</span> </span>{ eglCore_-&gt;<span class="hljs-built_in">ChangeColor</span>(hasChangeColor_); }</li><li>
</li><li><span class="hljs-comment">// 获得xcomponent状态，并返回至ArkTS侧</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">PluginManager::GetXComponentStatus</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">int64_t</span> surfaceId = <span class="hljs-built_in">ParseId</span>(env, info);</li><li>    <span class="hljs-keyword">auto</span> pluginRender = <span class="hljs-built_in">GetPluginRender</span>(surfaceId);</li><li>    <span class="hljs-keyword">if</span> (pluginRender == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: Get pluginRender failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value hasDraw;</li><li>    napi_value hasChangeColor;</li><li>    napi_status ret = <span class="hljs-built_in">napi_create_int32</span>(env, pluginRender-&gt;<span class="hljs-built_in">HasDraw</span>(), &amp;(hasDraw));</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: napi_create_int32 hasDraw_ error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    ret = <span class="hljs-built_in">napi_create_int32</span>(env, pluginRender-&gt;<span class="hljs-built_in">HasChangedColor</span>(), &amp;(hasChangeColor));</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: napi_create_int32 hasChangeColor_ error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value obj;</li><li>    ret = <span class="hljs-built_in">napi_create_object</span>(env, &amp;obj);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: napi_create_object error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    ret = <span class="hljs-built_in">napi_set_named_property</span>(env, obj, <span class="hljs-string">"hasDraw"</span>, hasDraw);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: napi_set_named_property hasDraw error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    ret = <span class="hljs-built_in">napi_set_named_property</span>(env, obj, <span class="hljs-string">"hasChangeColor"</span>, hasChangeColor);</li><li>    <span class="hljs-keyword">if</span> (ret != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"PluginManager"</span>,</li><li>                     <span class="hljs-string">"GetXComponentStatus: napi_set_named_property hasChangeColor error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> obj;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">PluginRender::HasDraw</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> hasDraw_; }</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">PluginRender::HasChangedColor</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> hasChangeColor_; }</li></ol></pre></div></div></li>      <li>       <p>配置具体的CMakeLists，使用CMake工具链将C++源代码编译成动态链接库文件。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-bash" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># 设置CMake最小版本</span></li><li>cmake_minimum_required(VERSION 3.4.1)</li><li><span class="hljs-comment"># 项目名称</span></li><li>project(XComponent)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH <span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span>)</li><li>add_definitions(-DOHOS_PLATFORM)</li><li><span class="hljs-comment"># 设置头文件搜索目录</span></li><li>include_directories(</li><li>    <span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span></li><li>    <span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span>/include</li><li>)</li><li><span class="hljs-comment"># 添加名为nativerender的动态库，库文件名为libnativerender.so，添加cpp文件</span></li><li>add_library(nativerender SHARED</li><li>    render/egl_core.cpp</li><li>    render/plugin_render.cpp</li><li>    manager/plugin_manager.cpp</li><li>    napi_init.cpp</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    EGL-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    EGL</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    GLES-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    GLESv3</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    hilog-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    libace-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    ace_ndk.z</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    libnapi-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    ace_napi.z</li><li>)</li><li>
</li><li>find_library(</li><li>    <span class="hljs-comment"># 设置路径变量的名称。</span></li><li>    libuv-lib</li><li>    <span class="hljs-comment"># 指定要让CMake查找的NDK库的名称。</span></li><li>    uv</li><li>)</li><li><span class="hljs-comment"># 添加构建需要链接的库</span></li><li>target_link_libraries(nativerender PUBLIC</li><li>    <span class="hljs-variable">${EGL-lib}</span> <span class="hljs-variable">${GLES-lib}</span> <span class="hljs-variable">${hilog-lib}</span> <span class="hljs-variable">${libace-lib}</span> <span class="hljs-variable">${libnapi-lib}</span> <span class="hljs-variable">${libuv-lib}</span> libnative_window.so)</li></ol></pre></div></div></li>     </ol>     <p>上述用例具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Native/ArkTSXComponent" target="_blank">ArkTSXComponent（API12）</a>。</p>    </div>    <div class="tiledSection">     <h2 id="使用oh_arkui_surfaceholder管理surface生命周期">使用OH_ArkUI_SurfaceHolder管理Surface生命周期<i class="anchor-icon anchor-icon-link" anchorid="使用oh_arkui_surfaceholder管理surface生命周期" tips="复制节点链接"></i></h2>          <p>与使用XComponentController管理Surface生命周期场景不同，本场景允许应用根据XComponent组件对应的ArkUI_NodeHandle中创建OH_ArkUI_SurfaceHolder，并通过OH_ArkUI_SurfaceHolder上的相关接口注册Surface生命周期，XComponent组件相关的无障碍、可变帧率等能力也可根据ArkUI_NodeHandle通过相关接口来实现。同时，XComponent组件上的基础/手势事件也可通过ArkUI_NodeHandle对象使用ArkUI NDK接口来监听（具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ndk-listen-to-component-events">监听组件事件</a>）。主要开发场景如下：</p>     <ul>      <li>在ArkTS侧创建的XComponent组件可以将其对应的FrameNode节点传递到Native侧以获取ArkUI_NodeHandle，或者在Native侧直接创建XComponent组件对应的ArkUI_NodeHandle，然后调用OH_ArkUI_SurfaceHolder_Create接口创建OH_ArkUI_SurfaceHolder实例。</li>      <li>基于OH_ArkUI_SurfaceHolder实例注册相应的生命周期回调、事件回调，获取NativeWindow实例。</li>      <li>利用NativeWindow和EGL接口开发自定义绘制内容以及申请和提交Buffer到图形队列。</li>     </ul>     <p><strong>生命周期</strong>：</p>     <ul>      <li>       <p>OnSurfaceCreated回调</p>       <p>触发时刻：XComponent创建完成且创建好Surface后达成以下两个条件中的一个触发。</p>       <ol>        <li>组件上树且autoInitialize = true。</li>        <li>调用OH_ArkUI_XComponent_Initialize。</li>       </ol>       <p>Native侧OnSurfaceCreated的时序如下图：</p>       <p><span><img originheight="403" originwidth="683" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.50046230158904640379871569492230:50001231000000:2800:5C95EAE2B01AFDEB9DB99679747E59E91DCEC2E186BFF9C7E7D0F21213B86412.png" width="683" height="403"></span></p></li>      <li>       <p>OnSurfaceChanged回调</p>       <p>触发时刻：OnSurfaceCreated回调成功触发且Surface大小变化触发重新布局之后触发。</p>       <p>Native侧OnSurfaceChanged的时序如下图：</p>       <p><span><img originheight="205" originwidth="319" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.86999730006646954281269566114502:50001231000000:2800:8B4B55530EE862FEACF79D627B15C2EE9300A54B1571C95C0B4CBAD343794096.png" width="319" height="205"></span></p></li>      <li>       <p>OnSurfaceDestroyed回调</p>       <p>触发时刻：组件下树且autoInitialize=true 或者调用 OH_ArkUI_XComponent_Finalize后触发。</p>       <p>Native侧OnSurfaceDestroyed的时序图：</p>       <p><span><img originheight="279" originwidth="836" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.94760143036755586213208399039622:50001231000000:2800:A5D6AFC1810DB78FF6053800CF67BD4B67B2F5074C4D4B8B8F16DBE2752B68AD.png" width="836" height="279"></span></p></li>     </ul>     <p><strong>接口说明</strong></p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.7.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.4.7.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_QueryModuleInterfaceByName(ArkUI_NativeAPIVariantKind type, const char* structName)</td>         <td class="cellrowborder" valign="top" width="50%">获取指定类型的Native模块接口集合。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_XComponent_GetNativeWindow(OH_ArkUI_SurfaceHolder* surfaceHolder)</td>         <td class="cellrowborder" valign="top" width="50%">获取与OH_ArkUI_SurfaceHolder实例关联的nativeWindow。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceHolder_RemoveSurfaceCallback(OH_ArkUI_SurfaceHolder* surfaceHolder, OH_ArkUI_SurfaceCallback* callback)</td>         <td class="cellrowborder" valign="top" width="50%">从OH_ArkUI_SurfaceHolder实例中移除先前添加的Surface生命周期回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_Dispose(OH_ArkUI_SurfaceCallback* callback)</td>         <td class="cellrowborder" valign="top" width="50%">释放OH_ArkUI_SurfaceCallback对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceHolder_Dispose(OH_ArkUI_SurfaceHolder* surfaceHolder)</td>         <td class="cellrowborder" valign="top" width="50%">释放OH_ArkUI_SurfaceHolder对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeEvent_GetEventType(ArkUI_NodeEvent* event)</td>         <td class="cellrowborder" valign="top" width="50%">从组件事件获取事件类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeEvent_GetNodeHandle(ArkUI_NodeEvent* event)</td>         <td class="cellrowborder" valign="top" width="50%">获取触发组件事件的组件对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_GetNodeHandleFromNapiValue(napi_env env, napi_value frameNode, ArkUI_NodeHandle* handle)</td>         <td class="cellrowborder" valign="top" width="50%">获取ArkTS侧创建的FrameNode节点对象映射到Native侧的ArkUI_NodeHandle。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceHolder_Create(ArkUI_NodeHandle node)</td>         <td class="cellrowborder" valign="top" width="50%">从XComponent节点创建一个OH_ArkUI_SurfaceHolder对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_Create()</td>         <td class="cellrowborder" valign="top" width="50%">创建一个OH_ArkUI_SurfaceCallback对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_SetSurfaceCreatedEvent(OH_ArkUI_SurfaceCallback* callback, void (*onSurfaceCreated)(OH_ArkUI_SurfaceHolder* surfaceHolder))</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceCallback对象中注册onSurfaceCreated回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_SetSurfaceChangedEvent(OH_ArkUI_SurfaceCallback* callback, void (*onSurfaceChanged)(OH_ArkUI_SurfaceHolder* surfaceHolder, uint64_t width, uint64_t height))</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceCallback对象中注册onSurfaceChanged回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_SetSurfaceDestroyedEvent(OH_ArkUI_SurfaceCallback* callback, void (*onSurfaceDestroyed)(OH_ArkUI_SurfaceHolder* surfaceHolder))</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceCallback对象中注册onSurfaceDestroyed回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_SetSurfaceShowEvent(OH_ArkUI_SurfaceCallback* callback, void (*onSurfaceShow)(OH_ArkUI_SurfaceHolder* surfaceHolder))</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceCallback对象中注册onSurfaceShow回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceCallback_SetSurfaceHideEvent(OH_ArkUI_SurfaceCallback* callback, void (*onSurfaceHide)(OH_ArkUI_SurfaceHolder* surfaceHolder))</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceCallback对象中注册onSurfaceHide回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_XComponent_RegisterOnFrameCallback(ArkUI_NodeHandle node, void (*callback)(ArkUI_NodeHandle node, uint64_t timestamp, uint64_t targetTimestamp))</td>         <td class="cellrowborder" valign="top" width="50%">为XComponent节点注册onFrame回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_SurfaceHolder_AddSurfaceCallback(OH_ArkUI_SurfaceHolder* surfaceHolder, OH_ArkUI_SurfaceCallback* callback)</td>         <td class="cellrowborder" valign="top" width="50%">往OH_ArkUI_SurfaceHolder实例注册OH_ArkUI_SurfaceCallback对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_AccessibilityProvider_Create(ArkUI_NodeHandle node)</td>         <td class="cellrowborder" valign="top" width="50%">从XComponent节点创建一个ArkUI_AccessibilityProvider对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_XComponent_UnregisterOnFrameCallback(ArkUI_NodeHandle node)</td>         <td class="cellrowborder" valign="top" width="50%">取消注册XComponent节点的onFrame回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_AccessibilityProvider_Dispose(ArkUI_AccessibilityProvider* provider)</td>         <td class="cellrowborder" valign="top" width="50%">释放ArkUI_AccessibilityProvider对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_XComponent_SetExpectedFrameRateRange(ArkUI_NodeHandle node, OH_NativeXComponent_ExpectedRateRange range)</td>         <td class="cellrowborder" valign="top" width="50%">为XComponent节点设置预期的帧率范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_XComponent_SetNeedSoftKeyboard(ArkUI_NodeHandle node, bool needSoftKeyboard)</td>         <td class="cellrowborder" valign="top" width="50%">设置XComponent节点在获得焦点时是否需要显示软键盘。</td>        </tr>             </tbody></table></div>     </div>     <p><strong>开发步骤</strong></p>     <p>以下步骤通过在ArkTS侧创建SURFACE类型的XComponent为例（Native侧如何创建XComponent组件对应的ArkUI_NodeHandle可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1" target="_blank">ArkUI_NativeNodeAPI_1</a>），描述了如何使用XComponent组件调用OH_ArkUI_SurfaceHolder相关接口管理Surface生命周期，并在Native侧创建EGL/GLES环境，实现在主页面绘制图形，以及可以改变图形的颜色。</p>     <ol>      <li>       <p>在界面中定义XComponent。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> native <span class="hljs-keyword">from</span> <span class="hljs-string">'libnativerender.so'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-attr">xcomponentId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'xcp'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>());</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">minRate</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">maxRate</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">120</span>;</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">expected</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">60</span>;</li><li>    <span class="hljs-attr">needSoftKeyboard</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">needSoftKeyboardState</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'needSoftKeyboard='</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span>;</li><li>    <span class="hljs-meta">@State</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'单指点击XComponent软件盘消失'</span></li><li>    <span class="hljs-attr">controller</span>: <span class="hljs-title class_">TextInputController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextInputController</span>()</li><li>
</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'please input ...'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>                .<span class="hljs-title function_">placeholderColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Grey</span>)</li><li>                .<span class="hljs-title function_">placeholderFont</span>({ <span class="hljs-attr">size</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">weight</span>: <span class="hljs-number">400</span> })</li><li>                .<span class="hljs-title function_">caretColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-number">400</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>                .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>                .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = value</li><li>                })</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>                    <span class="hljs-title class_">XComponent</span>({</li><li>                        <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span></li><li>                    })</li><li>                        .<span class="hljs-title function_">id</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>)</li><li>                        .<span class="hljs-title function_">onAttach</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                            <span class="hljs-keyword">let</span> node = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getFrameNodeById</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>)</li><li>                            native.<span class="hljs-title function_">bindNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>, node)</li><li>                        })</li><li>                        .<span class="hljs-title function_">onDetach</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                            native.<span class="hljs-title function_">unbindNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>)</li><li>                        })</li><li>                        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>                        .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>                        .<span class="hljs-title function_">focusable</span>(<span class="hljs-literal">true</span>)</li><li>                        .<span class="hljs-title function_">focusOnTouch</span>(<span class="hljs-literal">true</span>)</li><li>                        .<span class="hljs-title function_">defaultFocus</span>(<span class="hljs-literal">true</span>)</li><li>                }</li><li>            }.<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>
</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'创建/销毁'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>;</li><li>            })</li><li>
</li><li>            <span class="hljs-title class_">Column</span>() {</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">'期望帧率设置：'</span>)</li><li>                    .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Start</span>)</li><li>                    .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">15</span>)</li><li>                    .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span> })</li><li>                    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>                    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                    .<span class="hljs-title function_">margin</span>(<span class="hljs-number">5</span>)</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">'min: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span>)</li><li>                <span class="hljs-title class_">Slider</span>({</li><li>                    <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span>,</li><li>                    <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,</li><li>                    <span class="hljs-attr">max</span>: <span class="hljs-number">240</span>,</li><li>                    <span class="hljs-attr">step</span>: <span class="hljs-number">1</span></li><li>                }).<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span>, mode: SliderChangeMode</span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span> = value;</li><li>                    native.<span class="hljs-title function_">setFrameRate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span>)</li><li>                }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">'max: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span>)</li><li>                <span class="hljs-title class_">Slider</span>({</li><li>                    <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span>,</li><li>                    <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,</li><li>                    <span class="hljs-attr">max</span>: <span class="hljs-number">240</span>,</li><li>                    <span class="hljs-attr">step</span>: <span class="hljs-number">1</span></li><li>                }).<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span>, mode: SliderChangeMode</span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span> = value;</li><li>                    native.<span class="hljs-title function_">setFrameRate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span>)</li><li>                }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                <span class="hljs-title class_">Text</span>(<span class="hljs-string">'expected: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span>)</li><li>                <span class="hljs-title class_">Slider</span>({</li><li>                    <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span>,</li><li>                    <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,</li><li>                    <span class="hljs-attr">max</span>: <span class="hljs-number">240</span>,</li><li>                    <span class="hljs-attr">step</span>: <span class="hljs-number">1</span></li><li>                }).<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">number</span>, mode: SliderChangeMode</span>) =&gt;</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span> = value;</li><li>                    native.<span class="hljs-title function_">setFrameRate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">minRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRate</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">expected</span>)</li><li>                }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#F0FAFF"</span>)</li><li>
</li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboardState</span>)</li><li>                .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span>;</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboardState</span> = <span class="hljs-string">'needSoftKeyboard='</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span>;</li><li>                    native.<span class="hljs-title function_">setNeedSoftKeyboard</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">xcomponentId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span>);</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">needSoftKeyboard</span> ? <span class="hljs-string">'单指点击XComponent软键盘不消失'</span> : <span class="hljs-string">'单指点击XComponent软件盘消失'</span></li><li>                })</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API模块注册，具体使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines">Node-API开发规范</a>。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"manager/plugin_manager.h"</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> NativeXComponentSample {</li><li>
</li><li><span class="hljs-comment">// 在napi_init.cpp文件中，Init方法注册接口函数，从而将封装的C++方法传递出来，供ArkTS侧调用</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 向ArkTS侧暴露接口</span></li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"bindNode"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::BindNode,</li><li>            <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"unbindNode"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::UnbindNode,</li><li>            <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"setFrameRate"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::SetFrameRate,</li><li>            <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"setNeedSoftKeyboard"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::SetNeedSoftKeyboard,</li><li>            <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-comment">// 编写接口的描述信息，根据实际需要可以修改对应参数</span></li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    <span class="hljs-comment">// 入口函数</span></li><li>    .nm_register_func = Init, <span class="hljs-comment">// 指定加载对应模块时的回调函数</span></li><li>    <span class="hljs-comment">// 模块名称</span></li><li>    .nm_modname = <span class="hljs-string">"nativerender"</span>, <span class="hljs-comment">// 指定模块名称，对于XComponent相关开发，这个名称必须和ArkTS侧XComponent中libraryname的值保持一致</span></li><li>    .nm_priv = ((<span class="hljs-type">void</span>*)<span class="hljs-number">0</span>),</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>}</li><li>
</li><li><span class="hljs-comment">// __attribute__((constructor))修饰的方法由系统自动调用，使用Node-API接口napi_module_register()传入模块描述信息进行模块注册</span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;NativeXComponentSample::demoModule);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>注册XComponent生命周期、事件、无障碍和可变帧率回调，使用CAPI实现往XComponent注册回调函数。</p>       <p>(1) 定义BindNode、UnbindNode、SetFrameRate、SetNeedSoftKeyboard方法，暴露到ArkTS侧的bindNode、unbindNode、setFrameRate、setNeedSoftKeyboard方法会执行该方法。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// plugin_manager.h</span></li><li><span class="hljs-keyword">namespace</span> NativeXComponentSample {</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginManager</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    ~<span class="hljs-built_in">PluginManager</span>();</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">BindNode</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">UnbindNode</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetFrameRate</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SetNeedSoftKeyboard</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;std::string, ArkUI_NodeHandle&gt; nodeHandleMap_;</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;<span class="hljs-type">void</span> *, EGLRender *&gt; renderMap_;</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;<span class="hljs-type">void</span> *, OH_ArkUI_SurfaceCallback *&gt; callbackMap_;</li><li>    <span class="hljs-type">static</span> std::unordered_map&lt;<span class="hljs-type">void</span> *, OH_ArkUI_SurfaceHolder *&gt; surfaceHolderMap_;</li><li>    <span class="hljs-type">static</span> ArkUI_AccessibilityProvider* provider_;</li><li>};</li><li>}</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// plugin_manager.cpp</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unordered_map</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">string</span>, <span class="hljs-title class_">ArkUI_NodeHandle</span>&gt; <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">nodeHandleMap_</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unordered_map</span>&lt;<span class="hljs-title class_">void</span> *, <span class="hljs-title class_">EGLRender</span> *&gt; <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unordered_map</span>&lt;<span class="hljs-title class_">void</span> *, <span class="hljs-title class_">OH_ArkUI_SurfaceCallback</span> *&gt; <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">callbackMap_</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unordered_map</span>&lt;<span class="hljs-title class_">void</span> *, <span class="hljs-title class_">OH_ArkUI_SurfaceHolder</span> *&gt; <span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">surfaceHolderMap_</span>;</li><li><span class="hljs-variable">ArkUI_NativeNodeAPI_1</span> *<span class="hljs-variable">nodeAPI</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">ArkUI_NativeNodeAPI_1</span> *&gt;(</li><li>    <span class="hljs-title function_">OH_ArkUI_QueryModuleInterfaceByName</span>(<span class="hljs-variable">ARKUI_NATIVE_NODE</span>, <span class="hljs-string">"ArkUI_NativeNodeAPI_1"</span>));</li><li>
</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">value2String</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_value</span> <span class="hljs-title class_">value</span>) { <span class="hljs-comment">// 将napi_value转化为string类型的变量</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">stringSize</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">stringSize</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">valueString</span>;</li><li>    <span class="hljs-variable">valueString</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable">stringSize</span>);</li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, &amp;<span class="hljs-title class_">valueString</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">stringSize</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">stringSize</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">valueString</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">BindNode</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">nodeId</span> = <span class="hljs-title function_">value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">handle</span>;</li><li>    <span class="hljs-title function_">OH_ArkUI_GetNodeHandleFromNapiValue</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">handle</span>); <span class="hljs-comment">// 获取nodeHandle</span></li><li>    <span class="hljs-variable">OH_ArkUI_SurfaceHolder</span> *<span class="hljs-variable">holder</span> = <span class="hljs-title function_">OH_ArkUI_SurfaceHolder_Create</span>(<span class="hljs-variable">handle</span>); <span class="hljs-comment">// 获取SurfaceHolder</span></li><li>    <span class="hljs-variable">nodeHandleMap_</span>[<span class="hljs-variable">nodeId</span>] = <span class="hljs-variable">handle</span>;</li><li>    <span class="hljs-variable">surfaceHolderMap_</span>[<span class="hljs-variable">handle</span>] = <span class="hljs-variable">holder</span>;</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">callback</span> = <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_Create</span>(); <span class="hljs-comment">// 创建SurfaceCallback</span></li><li>    <span class="hljs-variable">callbackMap_</span>[<span class="hljs-variable">holder</span>] = <span class="hljs-variable">callback</span>;</li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_SetSurfaceCreatedEvent</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnSurfaceCreated</span>); <span class="hljs-comment">// 注册OnSurfaceCreated回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_SetSurfaceChangedEvent</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnSurfaceChanged</span>); <span class="hljs-comment">// 注册OnSurfaceChanged回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_SetSurfaceDestroyedEvent</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnSurfaceDestroyed</span>); <span class="hljs-comment">// 注册OnSurfaceDestroyed回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_SetSurfaceShowEvent</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnSurfaceShow</span>); <span class="hljs-comment">// 注册OnSurfaceShow回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_SetSurfaceHideEvent</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnSurfaceHide</span>); <span class="hljs-comment">// 注册OnSurfaceHide回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_XComponent_RegisterOnFrameCallback</span>(<span class="hljs-variable">handle</span>, <span class="hljs-variable">OnFrameCallback</span>); <span class="hljs-comment">// 注册OnFrameCallback回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceHolder_AddSurfaceCallback</span>(<span class="hljs-variable">holder</span>, <span class="hljs-variable">callback</span>); <span class="hljs-comment">// 注册SurfaceCallback回调</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">addNodeEventReceiver</span>(<span class="hljs-title class_">handle</span>, <span class="hljs-title class_">onEvent</span>)) { <span class="hljs-comment">// 添加事件监听，返回成功码 0</span></li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"addNodeEventReceiver error"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">registerNodeEvent</span>(<span class="hljs-title class_">handle</span>, <span class="hljs-title class_">NODE_TOUCH_EVENT</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">nullptr</span>)) { <span class="hljs-comment">// 用C接口注册touch事件，返回成功码 0</span></li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"registerTouchEvent error"</span>);</li><li>    }</li><li>    <span class="hljs-variable">provider_</span> = <span class="hljs-title function_">OH_ArkUI_AccessibilityProvider_Create</span>(<span class="hljs-variable">handle</span>); <span class="hljs-comment">// 创建一个ArkUI_AccessibilityProvider类型的对象</span></li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">    * 获取ArkUI_AccessibilityProvider后，如果注册无障碍回调函数请参考：</span></li><li><span class="hljs-comment">    * https://gitcode.com/openharmony/docs/blob/HarmonyOS-5.1.0-Release/zh-cn/application-dev/ui/ndk-accessibility-xcomponent.md</span></li><li><span class="hljs-comment">    * **/</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">UnbindNode</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">nodeId</span> = <span class="hljs-title function_">value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">node</span> = <span class="hljs-variable">nodeHandleMap_</span>[<span class="hljs-variable">nodeId</span>];</li><li>    <span class="hljs-title function_">OH_ArkUI_XComponent_UnregisterOnFrameCallback</span>(<span class="hljs-variable">node</span>); <span class="hljs-comment">// 解注册帧回调</span></li><li>    <span class="hljs-title function_">OH_ArkUI_AccessibilityProvider_Dispose</span>(<span class="hljs-variable">provider_</span>); <span class="hljs-comment">// 销毁ArkUI_AccessibilityProvider</span></li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">disposeNode</span>(<span class="hljs-title class_">node</span>); <span class="hljs-comment">// 销毁nodeHandle</span></li><li>    <span class="hljs-variable">nodeHandleMap_</span>.<span class="hljs-title function_">erase</span>(<span class="hljs-variable">nodeId</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">SetFrameRate</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">4</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">nodeId</span> = <span class="hljs-title function_">value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">node</span> = <span class="hljs-variable">nodeHandleMap_</span>[<span class="hljs-variable">nodeId</span>];</li><li>    </li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">min</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>( <span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">min</span>);</li><li>
</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">max</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>], &amp;<span class="hljs-title class_">max</span>);</li><li>
</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">expected</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], &amp;<span class="hljs-title class_">expected</span>);</li><li>    <span class="hljs-variable">OH_NativeXComponent_ExpectedRateRange</span> <span class="hljs-variable">range</span> = {</li><li>        .<span class="hljs-variable">min</span> = <span class="hljs-variable">min</span>,</li><li>        .<span class="hljs-variable">max</span> = <span class="hljs-variable">max</span>,</li><li>        .<span class="hljs-variable">expected</span> = <span class="hljs-variable">expected</span></li><li>    };</li><li>    <span class="hljs-title function_">OH_ArkUI_XComponent_SetExpectedFrameRateRange</span>(<span class="hljs-variable">node</span>, <span class="hljs-variable">range</span>); <span class="hljs-comment">// 设置期望帧率</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">SetNeedSoftKeyboard</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">nodeId</span> = <span class="hljs-title function_">value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">node</span> = <span class="hljs-variable">nodeHandleMap_</span>[<span class="hljs-variable">nodeId</span>];</li><li>    </li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">needSoftKeyboard</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-title function_">napi_get_value_bool</span>( <span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">needSoftKeyboard</span>);</li><li>    <span class="hljs-title function_">OH_ArkUI_XComponent_SetNeedSoftKeyboard</span>(<span class="hljs-variable">node</span>, <span class="hljs-variable">needSoftKeyboard</span>); <span class="hljs-comment">// 设置是否需要软键盘</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div>       <p>(2) 定义Surface创建成功，发生改变，销毁和事件，可变帧率回调接口。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceCreated</span>(<span class="hljs-variable">OH_ArkUI_SurfaceHolder</span> *<span class="hljs-variable">holder</span>) {</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">window</span> = <span class="hljs-title function_">OH_ArkUI_XComponent_GetNativeWindow</span>(<span class="hljs-variable">holder</span>); <span class="hljs-comment">// 获取native window</span></li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">EGLRender</span>();</li><li>    <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>[<span class="hljs-title class_">holder</span>] = <span class="hljs-variable">render</span>;</li><li>    <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">SetUpEGLContext</span>(<span class="hljs-title class_">window</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceChanged</span>(<span class="hljs-variable">OH_ArkUI_SurfaceHolder</span> *<span class="hljs-variable">holder</span>, <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">width</span>, <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">height</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>.<span class="hljs-title class_">count</span>(<span class="hljs-title class_">holder</span>)) {</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>[<span class="hljs-title class_">holder</span>];</li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">SetEGLWindowSize</span>(<span class="hljs-title class_">width</span>, <span class="hljs-title class_">height</span>); <span class="hljs-comment">// 设置绘制区域大小</span></li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">DrawStar</span>(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// 绘制五角星</span></li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceDestroyed</span>(<span class="hljs-variable">OH_ArkUI_SurfaceHolder</span> *<span class="hljs-variable">holder</span>) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-number">0xff00</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"on destroyed"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>.<span class="hljs-title class_">count</span>(<span class="hljs-title class_">holder</span>)) { <span class="hljs-comment">// 销毁render对象</span></li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>[<span class="hljs-title class_">holder</span>];</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">render</span>;</li><li>        <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>.<span class="hljs-title class_">erase</span>(<span class="hljs-title class_">holder</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">callbackMap_</span>.<span class="hljs-title class_">count</span>(<span class="hljs-title class_">holder</span>)) {</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">callback</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">callbackMap_</span>[<span class="hljs-title class_">holder</span>];</li><li>        <span class="hljs-title function_">OH_ArkUI_SurfaceHolder_RemoveSurfaceCallback</span>(<span class="hljs-variable">holder</span>, <span class="hljs-variable">callback</span>); <span class="hljs-comment">// 移除SurfaceCallback</span></li><li>        <span class="hljs-title function_">OH_ArkUI_SurfaceCallback_Dispose</span>(<span class="hljs-variable">callback</span>); <span class="hljs-comment">// 销毁surfaceCallback</span></li><li>        <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">callbackMap_</span>.<span class="hljs-title class_">erase</span>(<span class="hljs-title class_">holder</span>);</li><li>    }</li><li>    <span class="hljs-title function_">OH_ArkUI_SurfaceHolder_Dispose</span>(<span class="hljs-variable">holder</span>); <span class="hljs-comment">// 销毁surfaceHolder</span></li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceShow</span>(<span class="hljs-variable">OH_ArkUI_SurfaceHolder</span>* <span class="hljs-variable">holder</span>)</li><li>{</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"on surface show"</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceHide</span>(<span class="hljs-variable">OH_ArkUI_SurfaceHolder</span>* <span class="hljs-variable">holder</span>)</li><li>{</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"on surface hide"</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnFrameCallback</span>(<span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">node</span>, <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">timestamp</span>, <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">targetTimestamp</span>)</li><li>{</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">surfaceHolderMap_</span>.<span class="hljs-title class_">count</span>(<span class="hljs-title class_">node</span>)) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">count</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">count</span>++;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">count</span> % <span class="hljs-number">50</span> == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"OnFrameCallback count = %{public}ld"</span>, <span class="hljs-variable">count</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">onEvent</span>(<span class="hljs-variable">ArkUI_NodeEvent</span> *<span class="hljs-variable">event</span>) {</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">eventType</span> = <span class="hljs-title function_">OH_ArkUI_NodeEvent_GetEventType</span>(<span class="hljs-variable">event</span>); <span class="hljs-comment">// 获取组件事件类型</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"on event"</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">eventType</span> == <span class="hljs-variable">NODE_TOUCH_EVENT</span>) {</li><li>        <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_">OH_ArkUI_NodeEvent_GetNodeHandle</span>(<span class="hljs-variable">event</span>); <span class="hljs-comment">// 获取触发该事件的组件对象</span></li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">holder</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">surfaceHolderMap_</span>[<span class="hljs-title class_">handle</span>];</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>.<span class="hljs-title class_">count</span>(<span class="hljs-title class_">holder</span>)) {</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">renderMap_</span>[<span class="hljs-title class_">holder</span>];</li><li>            <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">DrawStar</span>(<span class="hljs-keyword">false</span>); <span class="hljs-comment">// 绘制五角星</span></li><li>        }</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"onBind"</span>, <span class="hljs-string">"on touch"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>初始化环境，包括初始化可用的EGLDisplay、确定可用的Surface配置、创建渲染区域Surface、创建并关联上下文等。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-php" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EGLConst.h</span></li><li><span class="hljs-comment">#include &lt;EGL/egl.h&gt;</span></li><li><span class="hljs-comment">#include &lt;EGL/eglext.h&gt;</span></li><li><span class="hljs-comment">#include &lt;GLES3/gl3.h&gt;</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">unsigned</span> <span class="hljs-keyword">int</span> LOG_PRINT_DOMAIN = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Program 错误。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLuint</span> PROGRAM_ERROR = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 位置错误。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLint</span> POSITION_ERROR = -<span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 默认x坐标。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">int</span> DEFAULT_X_POSITION = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 默认y坐标。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">int</span> DEFAULT_Y_POSITION = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Gl 红色默认值。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> GL_RED_DEFAULT = <span class="hljs-number">0.0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Gl 绿色默认值。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> GL_GREEN_DEFAULT = <span class="hljs-number">0.0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Gl 蓝色默认值。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> GL_BLUE_DEFAULT = <span class="hljs-number">0.0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Gl 透明度。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> GL_ALPHA_DEFAULT = <span class="hljs-number">1.0</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Pointer 数量。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLint</span> POINTER_SIZE = <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Triangle fan 尺寸。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLsizei</span> TRIANGLE_FAN_SIZE = <span class="hljs-number">4</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">*  50%。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">float</span> FIFTY_PERCENT = <span class="hljs-number">0.5</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 位置句柄名字。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">char</span> POSITION_NAME[] = <span class="hljs-string">"a_position"</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 背景色 #f4f4f4。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> BACKGROUND_COLOR[] = {<span class="hljs-number">244.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">244.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">244.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">1.0</span>f};</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Draw 颜色 #7E8FFB。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> DRAW_COLOR[] = {<span class="hljs-number">126.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">143.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">251.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">1.0</span>f};</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* Change 颜色 #92D6CC。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> CHANGE_COLOR[] = {<span class="hljs-number">146.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">214.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">204.0</span>f / <span class="hljs-number">255</span>, <span class="hljs-number">1.0</span>f};</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 背景区域。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLfloat</span> BACKGROUND_RECTANGLE_VERTICES[] = {-<span class="hljs-number">1.0</span>f, <span class="hljs-number">1.0</span>f, <span class="hljs-number">1.0</span>f, <span class="hljs-number">1.0</span>f, <span class="hljs-number">1.0</span>f, -<span class="hljs-number">1.0</span>f, -<span class="hljs-number">1.0</span>f, -<span class="hljs-number">1.0</span>f};</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EGLint</span> ATTRIB_LIST[] = {</li><li>    <span class="hljs-comment">// 键，值。</span></li><li>    EGL_SURFACE_TYPE, EGL_WINDOW_BIT, EGL_RED_SIZE, <span class="hljs-number">8</span>, EGL_GREEN_SIZE, <span class="hljs-number">8</span>, EGL_BLUE_SIZE, <span class="hljs-number">8</span>, EGL_ALPHA_SIZE, <span class="hljs-number">8</span>,</li><li>    EGL_RENDERABLE_TYPE, EGL_OPENGL_ES2_BIT,</li><li>    <span class="hljs-comment">// 结束。</span></li><li>    EGL_NONE};</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EGLint</span> CONTEXT_ATTRIBS[] = {EGL_CONTEXT_CLIENT_VERSION, <span class="hljs-number">2</span>, EGL_NONE};</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 顶点着色器。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">char</span> VERTEX_SHADER[] = <span class="hljs-string">"#version 300 es\n"</span></li><li>                            <span class="hljs-string">"layout(location = 0) in vec4 a_position;\n"</span></li><li>                            <span class="hljs-string">"layout(location = 1) in vec4 a_color;   \n"</span></li><li>                            <span class="hljs-string">"out vec4 v_color;                       \n"</span></li><li>                            <span class="hljs-string">"void main()                             \n"</span></li><li>                            <span class="hljs-string">"{                                       \n"</span></li><li>                            <span class="hljs-string">"   gl_Position = a_position;            \n"</span></li><li>                            <span class="hljs-string">"   v_color = a_color;                   \n"</span></li><li>                            <span class="hljs-string">"}                                       \n"</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment">* 片元着色器。</span></li><li><span class="hljs-comment">*/</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">char</span> FRAGMENT_SHADER[] = <span class="hljs-string">"#version 300 es\n"</span></li><li>                            <span class="hljs-string">"precision mediump float;                  \n"</span></li><li>                            <span class="hljs-string">"in vec4 v_color;                          \n"</span></li><li>                            <span class="hljs-string">"out vec4 fragColor;                       \n"</span></li><li>                            <span class="hljs-string">"void main()                               \n"</span></li><li>                            <span class="hljs-string">"{                                         \n"</span></li><li>                            <span class="hljs-string">"   fragColor = v_color;                   \n"</span></li><li>                            <span class="hljs-string">"}                                         \n"</span>;</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EGLRender.h</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"EGLConst.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/egl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/eglext.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/eglplatform.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;GLES3/gl3.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">EGLRender</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SetUpEGLContext</span><span class="hljs-params">(<span class="hljs-type">void</span> *window)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetEGLWindowSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawStar</span><span class="hljs-params">(<span class="hljs-type">bool</span> drawColor)</span></span>;</li><li>
</li><li>    std::string xcomponentId;</li><li>    EGLNativeWindowType eglWindow_;</li><li>
</li><li>    EGLDisplay eglDisplay_ = EGL_NO_DISPLAY;</li><li>    EGLConfig eglConfig_ = EGL_NO_CONFIG_KHR;</li><li>    EGLSurface eglSurface_ = EGL_NO_SURFACE;</li><li>    EGLContext eglContext_ = EGL_NO_CONTEXT;</li><li>    GLuint program_;</li><li>    <span class="hljs-type">int</span> width_ = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int</span> height_ = <span class="hljs-number">0</span>;</li><li>    ~<span class="hljs-built_in">EGLRender</span>();</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-function">GLint <span class="hljs-title">PrepareDraw</span><span class="hljs-params">()</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ExecuteDraw</span><span class="hljs-params">(GLint position, <span class="hljs-type">const</span> GLfloat *color, <span class="hljs-type">const</span> GLfloat shapeVertices[])</span></span>;</li><li>};</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EGLRender.cpp</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"EGLRender.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"EGLConst.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/egl.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;EGL/eglext.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;GLES3/gl3.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li><span class="hljs-keyword">namespace</span> {</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Rotate2d</span><span class="hljs-params">(GLfloat centerX, GLfloat centerY, GLfloat *rotateX, GLfloat *rotateY, GLfloat theta)</span> </span>{</li><li>    GLfloat tempX = <span class="hljs-built_in">cos</span>(theta) * (*rotateX - centerX) - <span class="hljs-built_in">sin</span>(theta) * (*rotateY - centerY);</li><li>    GLfloat tempY = <span class="hljs-built_in">sin</span>(theta) * (*rotateX - centerX) + <span class="hljs-built_in">cos</span>(theta) * (*rotateY - centerY);</li><li>    *rotateX = tempX + centerX;</li><li>    *rotateY = tempY + centerY;</li><li>}</li><li>
</li><li><span class="hljs-function">GLuint <span class="hljs-title">LoadShader</span><span class="hljs-params">(GLenum type, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *shaderSrc)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((type == <span class="hljs-number">0</span>) || (shaderSrc == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"glCreateShader type or shaderSrc error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint shader = <span class="hljs-built_in">glCreateShader</span>(type);</li><li>    <span class="hljs-keyword">if</span> (shader == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"glCreateShader unable to load shader"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// The gl function has no return value.</span></li><li>    <span class="hljs-built_in">glShaderSource</span>(shader, <span class="hljs-number">1</span>, &amp;shaderSrc, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">glCompileShader</span>(shader);</li><li>
</li><li>    GLint compiled;</li><li>    <span class="hljs-built_in">glGetShaderiv</span>(shader, GL_COMPILE_STATUS, &amp;compiled);</li><li>    <span class="hljs-keyword">if</span> (compiled != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> shader;</li><li>    }</li><li>
</li><li>    GLint infoLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">glGetShaderiv</span>(shader, GL_INFO_LOG_LENGTH, &amp;infoLen);</li><li>    <span class="hljs-keyword">if</span> (infoLen &lt;= <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-built_in">glDeleteShader</span>(shader);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">char</span> *infoLog = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * (infoLen + <span class="hljs-number">1</span>));</li><li>    <span class="hljs-keyword">if</span> (infoLog != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">memset</span>(infoLog, <span class="hljs-number">0</span>, infoLen + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-built_in">glGetShaderInfoLog</span>(shader, infoLen, <span class="hljs-literal">nullptr</span>, infoLog);</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"glCompileShader error = %s"</span>, infoLog);</li><li>        <span class="hljs-built_in">free</span>(infoLog);</li><li>        infoLog = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">glDeleteShader</span>(shader);</li><li>    <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建program</span></li><li><span class="hljs-function">GLuint <span class="hljs-title">CreateProgram</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *vertexShader, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fragShader)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((vertexShader == <span class="hljs-literal">nullptr</span>) || (fragShader == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>,</li><li>                    <span class="hljs-string">"createProgram: vertexShader or fragShader is null"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint vertex = <span class="hljs-built_in">LoadShader</span>(GL_VERTEX_SHADER, vertexShader);</li><li>    <span class="hljs-keyword">if</span> (vertex == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"createProgram vertex error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint fragment = <span class="hljs-built_in">LoadShader</span>(GL_FRAGMENT_SHADER, fragShader);</li><li>    <span class="hljs-keyword">if</span> (fragment == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"createProgram fragment error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint program = <span class="hljs-built_in">glCreateProgram</span>();</li><li>    <span class="hljs-keyword">if</span> (program == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"createProgram program error"</span>);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">//  该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glAttachShader</span>(program, vertex);</li><li>    <span class="hljs-built_in">glAttachShader</span>(program, fragment);</li><li>    <span class="hljs-built_in">glLinkProgram</span>(program);</li><li>
</li><li>    GLint linked;</li><li>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_LINK_STATUS, &amp;linked);</li><li>    <span class="hljs-keyword">if</span> (linked != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>        <span class="hljs-keyword">return</span> program;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"createProgram linked error"</span>);</li><li>    GLint infoLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_INFO_LOG_LENGTH, &amp;infoLen);</li><li>    <span class="hljs-keyword">if</span> (infoLen &gt; <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-type">char</span> *infoLog = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * (infoLen + <span class="hljs-number">1</span>));</li><li>        <span class="hljs-built_in">memset</span>(infoLog, <span class="hljs-number">0</span>, infoLen + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-built_in">glGetProgramInfoLog</span>(program, infoLen, <span class="hljs-literal">nullptr</span>, infoLog);</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"glLinkProgram error = %s"</span>, infoLog);</li><li>        <span class="hljs-built_in">free</span>(infoLog);</li><li>        infoLog = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>    <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>    <span class="hljs-built_in">glDeleteProgram</span>(program);</li><li>    <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>}</li><li>} <span class="hljs-comment">// namespace</span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLRender::SetUpEGLContext</span><span class="hljs-params">(<span class="hljs-type">void</span> *window)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"EglContextInit execute"</span>);</li><li>    eglWindow_ = (EGLNativeWindowType)(window);</li><li>    <span class="hljs-comment">// 初始化display。</span></li><li>    eglDisplay_ = <span class="hljs-built_in">eglGetDisplay</span>(EGL_DEFAULT_DISPLAY);</li><li>    <span class="hljs-keyword">if</span> (eglDisplay_ == EGL_NO_DISPLAY) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"eglGetDisplay: unable to get EGL display"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    EGLint majorVersion;</li><li>    EGLint minorVersion;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglInitialize</span>(eglDisplay_, &amp;majorVersion, &amp;minorVersion)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>,</li><li>                    <span class="hljs-string">"eglInitialize: unable to get initialize EGL display"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>    <span class="hljs-comment">// 选择配置。</span></li><li>    <span class="hljs-type">const</span> EGLint maxConfigSize = <span class="hljs-number">1</span>;</li><li>    EGLint numConfigs;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglChooseConfig</span>(eglDisplay_, ATTRIB_LIST, &amp;eglConfig_, maxConfigSize, &amp;numConfigs)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"eglChooseConfig: unable to choose configs"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>    <span class="hljs-comment">// 创建环境。</span></li><li>    <span class="hljs-comment">// 创建 Surface。</span></li><li>    eglSurface_ = <span class="hljs-built_in">eglCreateWindowSurface</span>(eglDisplay_, eglConfig_, eglWindow_, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-keyword">if</span> (eglSurface_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>,</li><li>                    <span class="hljs-string">"eglCreateWindowSurface: unable to create Surface"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建上下文。</span></li><li>    eglContext_ = <span class="hljs-built_in">eglCreateContext</span>(eglDisplay_, eglConfig_, EGL_NO_CONTEXT, CONTEXT_ATTRIBS);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglMakeCurrent</span>(eglDisplay_, eglSurface_, eglSurface_, eglContext_)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"eglMakeCurrent failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建program。</span></li><li>    program_ = <span class="hljs-built_in">CreateProgram</span>(VERTEX_SHADER, FRAGMENT_SHADER);</li><li>    <span class="hljs-keyword">if</span> (program_ == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"CreateProgram: unable to create program"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">GLint <span class="hljs-title">EGLRender::PrepareDraw</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglSurface_ == <span class="hljs-literal">nullptr</span>) || (eglContext_ == <span class="hljs-literal">nullptr</span>) ||</li><li>        (!<span class="hljs-built_in">eglMakeCurrent</span>(eglDisplay_, eglSurface_, eglSurface_, eglContext_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"PrepareDraw: param error"</span>);</li><li>        <span class="hljs-keyword">return</span> POSITION_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glViewport</span>(DEFAULT_X_POSITION, DEFAULT_Y_POSITION, width_, height_);</li><li>    <span class="hljs-built_in">glClearColor</span>(GL_RED_DEFAULT, GL_GREEN_DEFAULT, GL_BLUE_DEFAULT, GL_ALPHA_DEFAULT);</li><li>    <span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</li><li>    <span class="hljs-built_in">glUseProgram</span>(program_);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">glGetAttribLocation</span>(program_, POSITION_NAME);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 绘制五角星</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EGLRender::DrawStar</span><span class="hljs-params">(<span class="hljs-type">bool</span> drawColor)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw"</span>);</li><li>    GLint position = <span class="hljs-built_in">PrepareDraw</span>();</li><li>    <span class="hljs-keyword">if</span> (position == POSITION_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw get position failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 绘制背景</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExecuteDraw</span>(position, BACKGROUND_COLOR, BACKGROUND_RECTANGLE_VERTICES)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw execute draw background failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 将其划分为五个四边形，并计算其中一个四边形的顶点</span></li><li>    GLfloat rotateX = <span class="hljs-number">0</span>;</li><li>    GLfloat rotateY = FIFTY_PERCENT * height_;</li><li>    GLfloat centerX = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 将角度 54° 和 18° 转换为弧度</span></li><li>    GLfloat centerY = -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">54</span>) * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-comment">// 将角度 18° 转换为弧度</span></li><li>    GLfloat leftX = -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    GLfloat leftY = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 将角度 18° 转换为弧度</span></li><li>    GLfloat rightX = rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    GLfloat rightY = <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>    <span class="hljs-type">const</span> GLfloat shapeVertices[] = {centerX / width_, centerY / height_, leftX / width_,  leftY / height_,</li><li>                                    rotateX / width_, rotateY / height_, rightX / width_, rightY / height_};</li><li>    <span class="hljs-keyword">auto</span> color = drawColor ? DRAW_COLOR : CHANGE_COLOR;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExecuteDraw</span>(position, color, shapeVertices)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw execute draw shape failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 将角度 72° 转换为弧度</span></li><li>    GLfloat rad = M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">72</span>;</li><li>    <span class="hljs-comment">// 旋转四次。</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i) {</li><li>        <span class="hljs-comment">// 旋转得其他四个四边形的顶点</span></li><li>        <span class="hljs-built_in">Rotate2d</span>(centerX, centerY, &amp;rotateX, &amp;rotateY, rad);</li><li>        <span class="hljs-built_in">Rotate2d</span>(centerX, centerY, &amp;leftX, &amp;leftY, rad);</li><li>        <span class="hljs-built_in">Rotate2d</span>(centerX, centerY, &amp;rightX, &amp;rightY, rad);</li><li>
</li><li>        <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>        <span class="hljs-type">const</span> GLfloat shapeVertices[] = {centerX / width_, centerY / height_, leftX / width_,  leftY / height_,</li><li>                                        rotateX / width_, rotateY / height_, rightX / width_, rightY / height_};</li><li>
</li><li>        <span class="hljs-comment">// 绘制图形</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExecuteDraw</span>(position, color, shapeVertices)) {</li><li>            <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw execute draw shape failed"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// 将绘制命令提交给GPU，GPU执行完成后将渲染结果显示到屏幕</span></li><li>    <span class="hljs-built_in">glFlush</span>();</li><li>    <span class="hljs-built_in">glFinish</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglSwapBuffers</span>(eglDisplay_, eglSurface_)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Draw FinishDraw failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLRender::ExecuteDraw</span><span class="hljs-params">(GLint position, <span class="hljs-type">const</span> GLfloat *color, <span class="hljs-type">const</span> GLfloat shapeVertices[])</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((position &gt; <span class="hljs-number">0</span>) || (color == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"ExecuteDraw: param error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glVertexAttribPointer</span>(position, POINTER_SIZE, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, shapeVertices);</li><li>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(position);</li><li>    <span class="hljs-built_in">glVertexAttrib4fv</span>(<span class="hljs-number">1</span>, color);</li><li>    <span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_FAN, <span class="hljs-number">0</span>, TRIANGLE_FAN_SIZE);</li><li>    <span class="hljs-built_in">glDisableVertexAttribArray</span>(position);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EGLRender::SetEGLWindowSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> </span>{</li><li>    width_ = width;</li><li>    height_ = height;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 释放相关资源</span></li><li>EGLRender::~<span class="hljs-built_in">EGLRender</span>() {</li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglSurface_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglDestroySurface</span>(eglDisplay_, eglSurface_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, <span class="hljs-number">0xff00</span>, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Release eglDestroySurface failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglContext_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglDestroyContext</span>(eglDisplay_, eglContext_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, <span class="hljs-number">0xff00</span>, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Release eglDestroySurface failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglTerminate</span>(eglDisplay_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, <span class="hljs-number">0xff00</span>, <span class="hljs-string">"EGLRender"</span>, <span class="hljs-string">"Release eglDestroySurface failed"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>CMakeLists，使用CMake工具链将C++源代码编译成动态链接库文件。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="CMake prettyprint linenums hljs language-scss" hw-language="CMake" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)</li><li><span class="hljs-built_in">project</span>(LCNXComponent2)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li>
</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li>
</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/render</li><li>                    ${NATIVERENDER_ROOT_PATH}/manager)</li><li>
</li><li><span class="hljs-built_in">add_library</span>(nativerender SHARED</li><li>            render/EGLRender.cpp</li><li>            manager/plugin_manager.cpp</li><li>            napi_init.cpp)</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    EGL-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    EGL</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    GLES-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    GLESv3</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    hilog-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    libace-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    ace_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    libnapi-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    ace_napi.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # 设置路径变量的名称。</li><li>    libuv-lib</li><li>    # 指定要让CMake查找的NDK库的名称。</li><li>    uv</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC ${EGL-lib} ${GLES-lib} ${hilog-lib} ${libace-lib} ${libnapi-lib} ${libuv-lib} libnative_window.so)</li></ol></pre></div></div>       <p>上述用例具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/ArkUISample/NativeXComponentSample" target="_blank">NativeXComponent</a>。</p>       <p><span><img originheight="737" originwidth="462" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.20060651978268699012067380260512:50001231000000:2800:157BD8D2A3D5DC78AE3663A28A3BE9AB48DD3310A237B07E56D31C7AF79EC2A3.jpeg" width="462" height="737"></span></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="使用nativexcomponent管理surface生命周期">使用NativeXComponent管理Surface生命周期<i class="anchor-icon anchor-icon-link" anchorid="使用nativexcomponent管理surface生命周期" tips="复制节点链接"></i></h2>          <p>与上述两种场景不同，本场景在Native侧使用ArkUI NDK 接口创建XComponent组件进行自定义绘制。具体步骤包括：创建组件，获取NativeXComponent实例，注册XComponent的生命周期回调及触摸、鼠标、按键等事件回调，通过回调获取NativeWindow，使用OpenGL ES/EGL接口在XComponent组件上进行图形绘制，最后在ArkTS层使用ContentSlot占位组件进行挂载显示。针对Native侧创建XComponent的主要开发场景如下：</p>     <ul>      <li>利用Native XComponent提供的接口注册XComponent的生命周期和事件回调。</li>      <li>在这些回调中进行初始化环境、获取当前状态、响应各类事件的开发。</li>      <li>利用NativeWindow和EGL接口开发自定义绘制内容以及申请和提交Buffer到图形队列。</li>     </ul>     <p><strong>约束条件</strong>：</p>     <p>构造XComponent时需要根据需要的type使用对应的节点类型。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>         <p>Native侧的OH_NativeXComponent缓存在字典中，其key需要保证其唯一性，当对应的XComponent销毁后，需要及时从字典里将其删除。</p></li>        <li>         <p>多个XComponent开发时，缓存Native侧资源需要保证key是唯一的，key推荐使用id+随机数或者surfaceId。</p></li>       </ol>      </div></div></div>     <p><strong>生命周期</strong>：</p>     <ul>      <li>       <p>OnSurfaceCreated回调</p>       <p>触发时刻：XComponent创建完成且创建好Surface后触发。</p>       <p>Native侧OnSurfaceCreated的时序如下图：</p>       <p><span><img originheight="145" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.10959777582896530493999530793413:50001231000000:2800:330412AB64418830C3AE77004C1FAEC870A63F036144BEB556C149326009ED5E.png" width="318" height="145"></span></p></li>      <li>       <p>OnSurfaceChanged回调</p>       <p>触发时刻：Surface大小变化触发重新布局后触发。</p>       <p>Native侧OnSurfaceChanged的时序如下图：</p>       <p><span><img originheight="142" originwidth="317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.22433591484376702009350815906326:50001231000000:2800:D9F83AA58B7C40D916AE9DCCECE75258195C360ED39F8BEB3D1513A04B4E559B.png" width="317" height="142"></span></p></li>      <li>       <p>OnSurfaceDestroyed回调</p>       <p>触发时刻：XComponent组件被销毁时触发，与一般ArkUI的组件销毁时机一致。</p>       <p>Native侧OnSurfaceDestroyed的时序图：</p>       <p><span><img originheight="144" originwidth="317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114753.55551451091614367811663198576482:50001231000000:2800:FE9DDD0A1862EDDD803643392DCE1A0B03B6D59799EE5F1E6C5CBE8CD0EF3422.png" width="317" height="144"></span></p></li>     </ul>     <p><strong>接口说明</strong></p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.10.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.10.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetXComponentId(OH_NativeXComponent* component, char* id, uint64_t* size)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent的id。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetXComponentSize(OH_NativeXComponent* component, const void* window, uint64_t* width, uint64_t* height)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent持有的Surface的大小。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetXComponentOffset(OH_NativeXComponent* component, const void* window, double* x, double* y)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent持有的Surface相对其父组件左顶点的偏移量。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetTouchEvent(OH_NativeXComponent* component, const void* window, OH_NativeXComponent_TouchEvent* touchEvent)</td>         <td class="cellrowborder" valign="top" width="50%">获取由XComponent触发的触摸事件。touchEvent内的具体属性值可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/t-native-xcomponent-oh-nativexcomponent-touchevent" target="_blank">OH_NativeXComponent_TouchEvent</a>。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetTouchPointToolType(OH_NativeXComponent* component, uint32_t pointIndex, OH_NativeXComponent_TouchPointToolType* toolType)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent触摸点的工具类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetTouchPointTiltX(OH_NativeXComponent* component, uint32_t pointIndex, float* tiltX)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent触摸点处相对X轴的倾斜角度。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetTouchPointTiltY(OH_NativeXComponent* component, uint32_t pointIndex, float* tiltY)</td>         <td class="cellrowborder" valign="top" width="50%">获取XComponent触摸点处相对Y轴的倾斜角度。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetMouseEvent(OH_NativeXComponent* component, const void* window, OH_NativeXComponent_MouseEvent* mouseEvent)</td>         <td class="cellrowborder" valign="top" width="50%">获取由XComponent触发的鼠标事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_RegisterCallback(OH_NativeXComponent* component, OH_NativeXComponent_Callback* callback)</td>         <td class="cellrowborder" valign="top" width="50%">为此OH_NativeXComponent实例注册生命周期和触摸事件回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_RegisterMouseEventCallback(OH_NativeXComponent* component, OH_NativeXComponent_MouseEvent_Callback* callback)</td>         <td class="cellrowborder" valign="top" width="50%">为此OH_NativeXComponent实例注册鼠标事件回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_RegisterFocusEventCallback(OH_NativeXComponent* component, void (*callback)(OH_NativeXComponent* component, void* window))</td>         <td class="cellrowborder" valign="top" width="50%">为此OH_NativeXComponent实例注册获得焦点事件回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_RegisterKeyEventCallback(OH_NativeXComponent* component, void (*callback)(OH_NativeXComponent* component, void* window))</td>         <td class="cellrowborder" valign="top" width="50%">为此OH_NativeXComponent实例注册按键事件回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_RegisterBlurEventCallback(OH_NativeXComponent* component, void (*callback)(OH_NativeXComponent* component, void* window))</td>         <td class="cellrowborder" valign="top" width="50%">为此OH_NativeXComponent实例注册失去焦点事件回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEvent(OH_NativeXComponent* component, OH_NativeXComponent_KeyEvent** keyEvent)</td>         <td class="cellrowborder" valign="top" width="50%">获取由XComponent触发的按键事件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEventAction(OH_NativeXComponent_KeyEvent* keyEvent, OH_NativeXComponent_KeyAction* action)</td>         <td class="cellrowborder" valign="top" width="50%">获取按键事件的动作。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEventCode(OH_NativeXComponent_KeyEvent* keyEvent, OH_NativeXComponent_KeyCode* code)</td>         <td class="cellrowborder" valign="top" width="50%">获取按键事件的键码值。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEventSourceType(OH_NativeXComponent_KeyEvent* keyEvent, OH_NativeXComponent_EventSourceType* sourceType)</td>         <td class="cellrowborder" valign="top" width="50%">获取按键事件的输入源类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEventDeviceId(OH_NativeXComponent_KeyEvent* keyEvent, int64_t* deviceId)</td>         <td class="cellrowborder" valign="top" width="50%">获取按键事件的设备ID。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetKeyEventTimestamp(OH_NativeXComponent_KeyEvent* keyEvent, int64_t* timestamp)</td>         <td class="cellrowborder" valign="top" width="50%">获取按键事件的时间戳。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_QueryModuleInterfaceByName(ArkUI_NativeAPIVariantKind type, const char* structName)</td>         <td class="cellrowborder" valign="top" width="50%">获取指定类型的Native模块接口集合。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_GetNodeContentFromNapiValue(napi_env env, napi_value value, ArkUI_NodeContentHandle* content)</td>         <td class="cellrowborder" valign="top" width="50%">获取ArkTS侧创建的NodeContent对象映射到Native侧的ArkUI_NodeContentHandle。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContent_SetUserData(ArkUI_NodeContentHandle content, void* userData)</td>         <td class="cellrowborder" valign="top" width="50%">在NodeContent对象上保存自定义数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContentEvent_GetNodeContentHandle(ArkUI_NodeContentEvent* event)</td>         <td class="cellrowborder" valign="top" width="50%">获取触发事件的NodeContent对象。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContent_GetUserData(ArkUI_NodeContentHandle content)</td>         <td class="cellrowborder" valign="top" width="50%">获取在NodeContent对象上保存的自定义数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContentEvent_GetEventType(ArkUI_NodeContentEvent* event)</td>         <td class="cellrowborder" valign="top" width="50%">获取触发NodeContent事件的事件类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContent_AddNode(ArkUI_NodeContentHandle content, ArkUI_NodeHandle node)</td>         <td class="cellrowborder" valign="top" width="50%">将一个ArkUI组件节点添加到对应的NodeContent对象下。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_ArkUI_NodeContent_RegisterCallback(ArkUI_NodeContentHandle content, ArkUI_NodeContentCallback callback)</td>         <td class="cellrowborder" valign="top" width="50%">注册NodeContent事件函数。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetNativeXComponent(ArkUI_NodeHandle node)</td>         <td class="cellrowborder" valign="top" width="50%">基于Native接口创建的组件实例获取OH_NativeXComponent类型的指针。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_NativeXComponent_GetHistoricalPoints(OH_NativeXComponent* component, const void* window, int32_t* size, OH_NativeXComponent_HistoricalPoint** historicalPoints )</td>         <td class="cellrowborder" valign="top" width="50%">获取当前XComponent触摸事件的历史点信息。由于部分输入设备上报触点的频率非常高（最高可达每1 ms上报一次），而对输入事件的响应通常是为了使UI界面发生变化以响应用户操作，如果将触摸事件按照上报触点的频率如此高频率上报给应用，大多会造成冗余，因此触摸事件在一帧内只会上报一次给应用。在当前帧内上报的触点均作为历史点保存，如果应用需要直接处理这些数据，可调用该接口获取历史点信息。历史接触点historicalPoints的具体规格可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-interaction-development-guide-touch-screen#重采样与历史点">重采样与历史点</a>。</td>        </tr>             </tbody></table></div>     </div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述接口不支持跨线程访问。</p>       <p>XComponent销毁（onSurfaceDestroyed回调触发后）时会释放上述接口中获取的OH_NativeXComponent和window对象。如果再次使用获取的对象，有可能会导致使用野指针或空指针的崩溃问题。</p>      </div></div></div>     <p><strong>开发步骤</strong></p>     <p>以下步骤以SURFACE类型为例，描述了如何使用XComponent组件调用Node-API接口来创建EGL/GLES环境，实现在主页面绘制图形，并可以改变图形的颜色。以下仅包含主要步骤，详细工程请参见<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/ArkUISample/NativeXComponentSample" target="_blank">NativeXComponent</a>。</p>     <ol>      <li>       <p>在界面中定义XComponent。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> nativeNode <span class="hljs-keyword">from</span> <span class="hljs-string">'libnativenode.so'</span>;</li><li><span class="hljs-keyword">import</span> {<span class="hljs-title class_">NodeContent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentStatus</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"init"</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">nodeContent</span>: <span class="hljs-title class_">NodeContent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>  <span class="hljs-title function_">aboutToAppear</span>():<span class="hljs-built_in">void</span>{</li><li>    <span class="hljs-comment">// 通过C-API创建节点，并添加到管理器nodeContent上</span></li><li>    nativeNode.<span class="hljs-title function_">createNativeNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeContent</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Native XComponent Sample'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'24fp'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>        .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>,</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">12</span></li><li>        })</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">24</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>
</li><li>      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>        <span class="hljs-comment">// 显示nodeContent管理器里存放的Native侧的组件</span></li><li>        <span class="hljs-title class_">ContentSlot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeContent</span>);</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'24fp'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">hasChangeColor</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-comment">// 获取当前绘制内容状态</span></li><li>        <span class="hljs-keyword">if</span> (nativeNode.<span class="hljs-title function_">getStatus</span>()) {</li><li>          hasChangeColor = nativeNode.<span class="hljs-title function_">getStatus</span>().<span class="hljs-property">hasChangeColor</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (hasChangeColor) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span> = <span class="hljs-string">"change color"</span>;</li><li>        }</li><li>      })</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">top</span>: <span class="hljs-number">27</span>,</li><li>        <span class="hljs-attr">left</span>: <span class="hljs-number">12</span>,</li><li>        <span class="hljs-attr">right</span>: <span class="hljs-number">12</span></li><li>      })</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>
</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Draw Star'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-string">'16fp'</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">24</span> })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 调用drawPattern绘制内容</span></li><li>          nativeNode.<span class="hljs-title function_">drawPattern</span>();</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">hasDraw</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>          <span class="hljs-comment">// 获取当前绘制内容状态</span></li><li>          <span class="hljs-keyword">if</span> (nativeNode.<span class="hljs-title function_">getStatus</span>()) {</li><li>            hasDraw = nativeNode.<span class="hljs-title function_">getStatus</span>().<span class="hljs-property">hasDraw</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (hasDraw) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStatus</span> = <span class="hljs-string">"draw star"</span>;</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'53.6%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>Node-API模块注册，具体使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines">Node-API开发规范</a>。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"common/common.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"manager/plugin_manager.h"</span></span></li><li>
</li><li><span class="hljs-comment">// 在napi_init.cpp文件中，Init方法注册接口函数，从而将封装的C++方法传递出来，供ArkTS侧调用</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 向ArkTS侧暴露接口</span></li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"createNativeNode"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::createNativeNode, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>        napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        {<span class="hljs-string">"getStatus"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::GetXComponentStatus, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>        <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        {<span class="hljs-string">"drawPattern"</span>, <span class="hljs-literal">nullptr</span>, PluginManager::NapiDrawPattern, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>,</li><li>        <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}</li><li>    };</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc) != napi_ok) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"Init"</span>, <span class="hljs-string">"napi_define_properties failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-comment">// 编写接口的描述信息，根据实际需要可以修改对应参数</span></li><li><span class="hljs-type">static</span> napi_module nativerenderModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    <span class="hljs-comment">// 入口函数</span></li><li>    .nm_register_func = Init,<span class="hljs-comment">// 指定加载对应模块时的回调函数</span></li><li>    <span class="hljs-comment">// 模块名称</span></li><li>    .nm_modname =</li><li>        <span class="hljs-string">"nativerender"</span>, <span class="hljs-comment">// 指定模块名称，对于XComponent相关开发，这个名称必须和ArkTS侧XComponent中libraryname的值保持一致</span></li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>}};</li><li>
</li><li><span class="hljs-comment">// __attribute__((constructor))修饰的方法由系统自动调用，使用Node-API接口napi_module_register()传入模块描述信息进行模块注册</span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{ <span class="hljs-built_in">napi_module_register</span>(&amp;nativerenderModule); }</li></ol></pre></div></div></li>      <li>       <p>注册XComponent事件回调，使用Node-API实现XComponent事件回调函数。</p>       <p>(1) 定义Surface创建成功，发生改变，销毁和XComponent的touch事件回调接口。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 在头文件中定义PluginManager类</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginManager</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-type">static</span> OH_NativeXComponent_Callback callback_;</li><li>    <span class="hljs-built_in">PluginManager</span>();</li><li>    ~<span class="hljs-built_in">PluginManager</span>();</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> PluginManager* <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function">    </span>{</li><li>        <span class="hljs-keyword">return</span> &amp;PluginManager::pluginManager_;</li><li>    }</li><li>    </li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">createNativeNode</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetXComponentStatus</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NapiDrawPattern</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>;</li><li>    </li><li>    <span class="hljs-comment">// CAPI XComponent</span></li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnSurfaceChanged</span><span class="hljs-params">(OH_NativeXComponent* component, <span class="hljs-type">void</span>* window)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnSurfaceDestroyed</span><span class="hljs-params">(OH_NativeXComponent* component, <span class="hljs-type">void</span>* window)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DispatchTouchEvent</span><span class="hljs-params">(OH_NativeXComponent* component, <span class="hljs-type">void</span>* window)</span></span>;</li><li>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnSurfaceCreated</span><span class="hljs-params">(OH_NativeXComponent* component, <span class="hljs-type">void</span>* window)</span></span>;</li><li>
</li><li><span class="hljs-keyword">public</span>:</li><li>    EGLCore *eglcore_;</li><li>    <span class="hljs-type">uint64_t</span> width_;</li><li>    <span class="hljs-type">uint64_t</span> height_;</li><li>    OH_NativeXComponent_TouchEvent touchEvent_;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> hasDraw_;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> hasChangeColor_;</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-type">static</span> PluginManager pluginManager_;</li><li>    std::unordered_map&lt;std::string, OH_NativeXComponent*&gt; nativeXComponentMap_;</li><li>    std::unordered_map&lt;std::string, PluginManager*&gt; pluginManagerMap_;</li><li>};</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义一个函数OnSurfaceCreatedCB()，封装初始化环境与绘制背景</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceCreatedCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 初始化环境与绘制背景</span></li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">pluginManager</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>();</li><li>    <span class="hljs-variable">pluginManager</span>-&gt;<span class="hljs-title class_">OnSurfaceCreated</span>(<span class="hljs-title class_">component</span>, <span class="hljs-title class_">window</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义一个函数OnSurfaceChangedCB()</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceChangedCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">pluginManager</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>();</li><li>    <span class="hljs-comment">// 封装OnSurfaceChanged方法</span></li><li>    <span class="hljs-variable">pluginManager</span>-&gt;<span class="hljs-title class_">OnSurfaceChanged</span>(<span class="hljs-title class_">component</span>, <span class="hljs-title class_">window</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义一个函数OnSurfaceDestroyedCB()，将PluginRender类内释放资源的方法Release()封装在其中</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceDestroyedCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">pluginManager</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>();</li><li>    <span class="hljs-variable">pluginManager</span>-&gt;<span class="hljs-title class_">OnSurfaceDestroyed</span>(<span class="hljs-title class_">component</span>, <span class="hljs-title class_">window</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义一个函数DispatchTouchEventCB()，响应触摸事件时触发该回调</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">DispatchTouchEventCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">pluginManager</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>();</li><li>    <span class="hljs-variable">pluginManager</span>-&gt;<span class="hljs-title class_">DispatchTouchEvent</span>(<span class="hljs-title class_">component</span>, <span class="hljs-title class_">window</span>);</li><li>}</li></ol></pre></div></div>       <p>(2) 定义createNativeNode方法，暴露到ArkTS侧的createNativeNode()方法会执行该方法。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">createNativeNode</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">env</span> == <span class="hljs-variable">nullptr</span>) || (<span class="hljs-variable">info</span> == <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"CreateNativeNode env or info is null"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argCnt</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>] = { <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span> };</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argCnt</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>) != <span class="hljs-variable">napi_ok</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"CreateNativeNode napi_get_cb_info failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">argCnt</span> != <span class="hljs-variable">ARG_CNT</span>) {</li><li>        <span class="hljs-title function_">napi_throw_type_error</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">NULL</span>, <span class="hljs-string">"Wrong number of arguments"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">ArkUI_NodeContentHandle</span> <span class="hljs-variable">nodeContentHandle_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_ArkUI_GetNodeContentFromNapiValue</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">nodeContentHandle_</span>);</li><li>    <span class="hljs-variable">nodeAPI</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">ArkUI_NativeNodeAPI_1</span>*&gt;(</li><li>        <span class="hljs-title function_">OH_ArkUI_QueryModuleInterfaceByName</span>(<span class="hljs-variable">ARKUI_NATIVE_NODE</span>, <span class="hljs-string">"ArkUI_NativeNodeAPI_1"</span>)</li><li>    );</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">tag</span> = <span class="hljs-title function_">value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"tag=%{public}s"</span>, <span class="hljs-variable">tag</span>.<span class="hljs-title function_">c_str</span>());</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_ArkUI_NodeContent_SetUserData</span>(<span class="hljs-variable">nodeContentHandle_</span>, <span class="hljs-variable">new</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span>(<span class="hljs-title class_">tag</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">ARKUI_ERROR_CODE_NO_ERROR</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"setUserData failed error=%{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nodeAPI</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">createNode</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">addChild</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>,</li><li>                    <span class="hljs-string">"CreateNativeNode tag=%{public}s"</span>, <span class="hljs-variable">tag</span>.<span class="hljs-title function_">c_str</span>());</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">nodeContentEvent</span> = [](<span class="hljs-variable">ArkUI_NodeContentEvent</span> *<span class="hljs-variable">event</span>) {</li><li>            <span class="hljs-variable">ArkUI_NodeContentHandle</span> <span class="hljs-variable">handle</span> = <span class="hljs-title function_">OH_ArkUI_NodeContentEvent_GetNodeContentHandle</span>(<span class="hljs-variable">event</span>);</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> *<span class="hljs-title class_">userDate</span> = <span class="hljs-variable">reinterpret_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">string</span>*&gt;(<span class="hljs-title function_">OH_ArkUI_NodeContent_GetUserData</span>(<span class="hljs-variable">handle</span>));</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">OH_ArkUI_NodeContentEvent_GetEventType</span>(<span class="hljs-variable">event</span>) == <span class="hljs-variable">NODE_CONTENT_EVENT_ON_ATTACH_TO_WINDOW</span>) {</li><li>                <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">testNode</span>;</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">userDate</span>) {</li><li>                    <span class="hljs-variable">testNode</span> = <span class="hljs-title function_">CreateNodeHandle</span>(*<span class="hljs-variable">userDate</span>);</li><li>                    <span class="hljs-variable">delete</span> <span class="hljs-variable">userDate</span>;</li><li>                    <span class="hljs-variable">userDate</span> = <span class="hljs-variable">nullptr</span>;</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                    <span class="hljs-variable">testNode</span> = <span class="hljs-title function_">CreateNodeHandle</span>(<span class="hljs-string">"noUserData"</span>);</li><li>                }</li><li>                <span class="hljs-title function_">OH_ArkUI_NodeContent_AddNode</span>(<span class="hljs-variable">handle</span>, <span class="hljs-variable">testNode</span>);</li><li>            }</li><li>        };</li><li>        <span class="hljs-title function_">OH_ArkUI_NodeContent_RegisterCallback</span>(<span class="hljs-variable">nodeContentHandle_</span>, <span class="hljs-variable">nodeContentEvent</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-title function_">CreateNodeHandle</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> &amp;<span class="hljs-title class_">tag</span>)</li><li>{</li><li>    <span class="hljs-variable">ArkUI_NodeHandle</span> <span class="hljs-variable">column</span> = <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">createNode</span>(<span class="hljs-title class_">ARKUI_NODE_COLUMN</span>);</li><li>    <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">value</span>[] = {<span class="hljs-number">480</span>};</li><li>    <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">value1</span>[] = {{.<span class="hljs-variable">u32</span> = <span class="hljs-number">15</span>}, {.<span class="hljs-variable">f32</span> = <span class="hljs-number">15</span>}};</li><li>    <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item</span> = {<span class="hljs-variable">value</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"changeSize"</span>};</li><li>    <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item1</span> = {<span class="hljs-variable">value1</span>, <span class="hljs-number">2</span>};</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">column</span>, <span class="hljs-title class_">NODE_WIDTH</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">f32</span> = <span class="hljs-variable">COLUMN_MARGIN</span>;</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">column</span>, <span class="hljs-title class_">NODE_MARGIN</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    <span class="hljs-comment">// 创建XComponent组件</span></li><li>    <span class="hljs-variable">xc</span> = <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">createNode</span>(<span class="hljs-title class_">ARKUI_NODE_XCOMPONENT</span>);</li><li>    <span class="hljs-comment">// 设置XComponent组件属性</span></li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">u32</span> = <span class="hljs-variable">ARKUI_XCOMPONENT_TYPE_SURFACE</span>;</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_XCOMPONENT_TYPE</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_XCOMPONENT_ID</span>, &amp;<span class="hljs-title class_">item</span>);</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_XCOMPONENT_SURFACE_SIZE</span>, &amp;<span class="hljs-title class_">item1</span>);</li><li>    <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">focusable</span>[] = {<span class="hljs-number">1</span>};</li><li>    <span class="hljs-variable">focusable</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">i32</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">focusableItem</span> = {<span class="hljs-variable">focusable</span>, <span class="hljs-number">1</span>};</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_FOCUSABLE</span>, &amp;<span class="hljs-title class_">focusableItem</span>);</li><li>    <span class="hljs-variable">ArkUI_NumberValue</span> <span class="hljs-variable">valueSize</span>[] = {<span class="hljs-number">480</span>};</li><li>    <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">itemSize</span> = {<span class="hljs-variable">valueSize</span>, <span class="hljs-number">1</span>};</li><li>    <span class="hljs-variable">valueSize</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">f32</span> = <span class="hljs-variable">XC_WIDTH</span>;</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_WIDTH</span>, &amp;<span class="hljs-title class_">itemSize</span>);</li><li>    <span class="hljs-variable">valueSize</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">f32</span> = <span class="hljs-variable">XC_HEIGHT</span>;</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_HEIGHT</span>, &amp;<span class="hljs-title class_">itemSize</span>);</li><li>    <span class="hljs-variable">ArkUI_AttributeItem</span> <span class="hljs-variable">item2</span> = {<span class="hljs-variable">value</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"ndkxcomponent"</span>};</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">setAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_ID</span>, &amp;<span class="hljs-title class_">item2</span>);</li><li>    </li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">nativeXComponent</span> = <span class="hljs-title function_">OH_NativeXComponent_GetNativeXComponent</span>(<span class="hljs-variable">xc</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">nativeXComponent</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"GetNativeXComponent error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">column</span>;</li><li>    }</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"GetNativeXComponent success"</span>);</li><li>    <span class="hljs-comment">// 注册XComponent回调函数</span></li><li>    <span class="hljs-title function_">OH_NativeXComponent_RegisterCallback</span>(<span class="hljs-variable">nativeXComponent</span>, &amp;<span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">callback_</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">typeRet</span> = <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">getAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_XCOMPONENT_TYPE</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"xcomponent type: %{public}d"</span>,</li><li>                <span class="hljs-variable">typeRet</span>-&gt;<span class="hljs-title class_">value</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">i32</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">idRet</span> = <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">getAttribute</span>(<span class="hljs-title class_">xc</span>, <span class="hljs-title class_">NODE_XCOMPONENT_ID</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"xcomponent id: %{public}s"</span>,</li><li>                <span class="hljs-variable">idRet</span>-&gt;<span class="hljs-title class_">string</span>);</li><li>    <span class="hljs-variable">nodeAPI</span>-&gt;<span class="hljs-title class_">addChild</span>(<span class="hljs-title class_">column</span>, <span class="hljs-title class_">xc</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">column</span>;</li><li>}</li></ol></pre></div></div>       <p>(3) 定义NapiDrawPattern方法，暴露到ArkTS侧的drawPattern()方法会执行该方法。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">NapiDrawPattern</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 获取环境变量参数</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">thisArg</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">thisArg</span>, <span class="hljs-variable">nullptr</span>) != <span class="hljs-variable">napi_ok</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"NapiDrawPattern: napi_get_cb_info fail"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">pluginManager</span> = <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>();</li><li>    <span class="hljs-comment">// 调用绘制方法</span></li><li>    <span class="hljs-variable">pluginManager</span>-&gt;<span class="hljs-title class_">eglcore_</span>-&gt;<span class="hljs-title class_">Draw</span>(<span class="hljs-title class_">hasDraw_</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"PluginManager"</span>, <span class="hljs-string">"render-&gt;eglCore_-&gt;Draw() executed"</span>);</li><li>    </li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>初始化环境，包括初始化可用的EGLDisplay、确定可用的Surface配置、创建渲染区域Surface、创建并关联上下文等。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EGLCore::UpdateSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> </span>{</li><li>    <span class="hljs-comment">// width_和height_在头文件中定义</span></li><li>    width_ = width;</li><li>    height_ = height;</li><li>    <span class="hljs-keyword">if</span> (width_ &gt; <span class="hljs-number">0</span>) {</li><li>        widthPercent_ = FIFTY_PERCENT * height_ / width_;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLCore::EglContextInit</span><span class="hljs-params">(<span class="hljs-type">void</span> *window, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-built_in">UpdateSize</span>(width, height);</li><li>    eglWindow_ = <span class="hljs-built_in">static_cast</span>&lt;EGLNativeWindowType&gt;(window);</li><li>
</li><li>    <span class="hljs-comment">// 初始化display</span></li><li>    eglDisplay_ = <span class="hljs-built_in">eglGetDisplay</span>(EGL_DEFAULT_DISPLAY);</li><li>    <span class="hljs-keyword">if</span> (eglDisplay_ == EGL_NO_DISPLAY) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglGetDisplay: unable to get EGL display"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 初始化EGL</span></li><li>    EGLint majorVersion;</li><li>    EGLint minorVersion;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglInitialize</span>(eglDisplay_, &amp;majorVersion, &amp;minorVersion)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(</li><li>            LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglInitialize: unable to get initialize EGL display"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 选择配置</span></li><li>    <span class="hljs-type">const</span> EGLint maxConfigSize = <span class="hljs-number">1</span>;</li><li>    EGLint numConfigs;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglChooseConfig</span>(eglDisplay_, ATTRIB_LIST, &amp;eglConfig_, maxConfigSize, &amp;numConfigs)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglChooseConfig: unable to choose configs"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 创建环境</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateEnvironment</span>();</li><li>    }</li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLCore::CreateEnvironment</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// 创建Surface</span></li><li>    <span class="hljs-keyword">if</span> (eglWindow_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglWindow_ is null"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    eglSurface_ = <span class="hljs-built_in">eglCreateWindowSurface</span>(eglDisplay_, eglConfig_, eglWindow_, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-keyword">if</span> (eglSurface_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(</li><li>            LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglCreateWindowSurface: unable to create surface"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建context</span></li><li>    eglContext_ = <span class="hljs-built_in">eglCreateContext</span>(eglDisplay_, eglConfig_, EGL_NO_CONTEXT, CONTEXT_ATTRIBS);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">eglMakeCurrent</span>(eglDisplay_, eglSurface_, eglSurface_, eglContext_)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"eglMakeCurrent failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建program</span></li><li>    program_ = <span class="hljs-built_in">CreateProgram</span>(VERTEX_SHADER, FRAGMENT_SHADER);</li><li>    <span class="hljs-keyword">if</span> (program_ == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"CreateProgram: unable to create program"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">GLuint <span class="hljs-title">EGLCore::CreateProgram</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* vertexShader, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* fragShader)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((vertexShader == <span class="hljs-literal">nullptr</span>) || (fragShader == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(</li><li>            LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"createProgram: vertexShader or fragShader is null"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint vertex = <span class="hljs-built_in">LoadShader</span>(GL_VERTEX_SHADER, vertexShader);</li><li>    <span class="hljs-keyword">if</span> (vertex == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"createProgram vertex error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint fragment = <span class="hljs-built_in">LoadShader</span>(GL_FRAGMENT_SHADER, fragShader);</li><li>    <span class="hljs-keyword">if</span> (fragment == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"createProgram fragment error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint program = <span class="hljs-built_in">glCreateProgram</span>();</li><li>    <span class="hljs-keyword">if</span> (program == PROGRAM_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"createProgram program error"</span>);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glAttachShader</span>(program, vertex);</li><li>    <span class="hljs-built_in">glAttachShader</span>(program, fragment);</li><li>    <span class="hljs-built_in">glLinkProgram</span>(program);</li><li>
</li><li>    GLint linked;</li><li>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_LINK_STATUS, &amp;linked);</li><li>    <span class="hljs-keyword">if</span> (linked != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>        <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>        <span class="hljs-keyword">return</span> program;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"createProgram linked error"</span>);</li><li>    GLint infoLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">glGetProgramiv</span>(program, GL_INFO_LOG_LENGTH, &amp;infoLen);</li><li>    <span class="hljs-keyword">if</span> (infoLen &gt; <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-type">char</span>* infoLog = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * (infoLen + <span class="hljs-number">1</span>));</li><li>        <span class="hljs-built_in">memset</span>(infoLog, <span class="hljs-number">0</span>, infoLen + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-built_in">glGetProgramInfoLog</span>(program, infoLen, <span class="hljs-literal">nullptr</span>, infoLog);</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"glLinkProgram error = %s"</span>, infoLog);</li><li>        <span class="hljs-built_in">free</span>(infoLog);</li><li>        infoLog = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">glDeleteShader</span>(vertex);</li><li>    <span class="hljs-built_in">glDeleteShader</span>(fragment);</li><li>    <span class="hljs-built_in">glDeleteProgram</span>(program);</li><li>    <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>}</li><li>
</li><li><span class="hljs-function">GLuint <span class="hljs-title">EGLCore::LoadShader</span><span class="hljs-params">(GLenum type, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* shaderSrc)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((type == <span class="hljs-number">0</span>) || (shaderSrc == <span class="hljs-literal">nullptr</span>)) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"glCreateShader type or shaderSrc error"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    GLuint shader = <span class="hljs-built_in">glCreateShader</span>(type);</li><li>    <span class="hljs-keyword">if</span> (shader == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"glCreateShader unable to load shader"</span>);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glShaderSource</span>(shader, <span class="hljs-number">1</span>, &amp;shaderSrc, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">glCompileShader</span>(shader);</li><li>
</li><li>    GLint compiled;</li><li>    <span class="hljs-built_in">glGetShaderiv</span>(shader, GL_COMPILE_STATUS, &amp;compiled);</li><li>    <span class="hljs-keyword">if</span> (compiled != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> shader;</li><li>    }</li><li>
</li><li>    GLint infoLen = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">glGetShaderiv</span>(shader, GL_INFO_LOG_LENGTH, &amp;infoLen);</li><li>    <span class="hljs-keyword">if</span> (infoLen &lt;= <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-built_in">glDeleteShader</span>(shader);</li><li>        <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">char</span> *infoLog = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * (infoLen + <span class="hljs-number">1</span>));</li><li>    <span class="hljs-keyword">if</span> (infoLog != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">memset</span>(infoLog, <span class="hljs-number">0</span>, infoLen + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-built_in">glGetShaderInfoLog</span>(shader, infoLen, <span class="hljs-literal">nullptr</span>, infoLog);</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"glCompileShader error = %s"</span>, infoLog);</li><li>        <span class="hljs-built_in">free</span>(infoLog);</li><li>        infoLog = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">glDeleteShader</span>(shader);</li><li>    <span class="hljs-keyword">return</span> PROGRAM_ERROR;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>渲染功能实现。</p>       <p>(1) 绘制背景。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// 绘制背景颜色 #f4f4f4</span></li><li><span class="hljs-type">const</span> GLfloat BACKGROUND_COLOR[] = { <span class="hljs-number">244.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">244.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">244.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">1.0f</span> };</li><li>
</li><li><span class="hljs-comment">// 绘制图案颜色</span></li><li><span class="hljs-type">const</span> GLfloat DRAW_COLOR[] = {<span class="hljs-number">126.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">143.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">251.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">1.0f</span>};</li><li>
</li><li><span class="hljs-comment">// 绘制图案改变后的颜色</span></li><li><span class="hljs-type">const</span> GLfloat CHANGE_COLOR[] = {<span class="hljs-number">146.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">214.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">204.0f</span> / <span class="hljs-number">255</span>, <span class="hljs-number">1.0f</span>};</li><li>
</li><li><span class="hljs-comment">// 绘制背景顶点</span></li><li><span class="hljs-type">const</span> GLfloat BACKGROUND_RECTANGLE_VERTICES[] = {</li><li>    <span class="hljs-number">-1.0f</span>, <span class="hljs-number">1.0f</span>,</li><li>    <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>,</li><li>    <span class="hljs-number">1.0f</span>, <span class="hljs-number">-1.0f</span>,</li><li>    <span class="hljs-number">-1.0f</span>, <span class="hljs-number">-1.0f</span></li><li>};</li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 绘制背景颜色</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EGLCore::Background</span><span class="hljs-params">()</span> </span>{</li><li>    GLint position = <span class="hljs-built_in">PrepareDraw</span>();</li><li>    <span class="hljs-keyword">if</span> (position == POSITION_ERROR) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Background get position failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExecuteDraw</span>(position, BACKGROUND_COLOR, BACKGROUND_RECTANGLE_VERTICES,</li><li>                     <span class="hljs-built_in">sizeof</span>(BACKGROUND_RECTANGLE_VERTICES))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Background execute draw failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">FinishDraw</span>()) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Background FinishDraw failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 绘前准备，获取position，创建成功时position值从0开始</span></li><li><span class="hljs-function">GLint <span class="hljs-title">EGLCore::PrepareDraw</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglSurface_ == <span class="hljs-literal">nullptr</span>) || (eglContext_ == <span class="hljs-literal">nullptr</span>) ||</li><li>        (!<span class="hljs-built_in">eglMakeCurrent</span>(eglDisplay_, eglSurface_, eglSurface_, eglContext_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"PrepareDraw: param error"</span>);</li><li>        <span class="hljs-keyword">return</span> POSITION_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glViewport</span>(DEFAULT_X_POSITION, DEFAULT_Y_POSITION, width_, height_);</li><li>    <span class="hljs-built_in">glClearColor</span>(GL_RED_DEFAULT, GL_GREEN_DEFAULT, GL_BLUE_DEFAULT, GL_ALPHA_DEFAULT);</li><li>    <span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</li><li>    <span class="hljs-built_in">glUseProgram</span>(program_);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">glGetAttribLocation</span>(program_, POSITION_NAME);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 依据传入参数在指定区域绘制指定颜色</span></li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLCore::ExecuteDraw</span><span class="hljs-params">(GLint position, <span class="hljs-type">const</span> GLfloat *color, <span class="hljs-type">const</span> GLfloat shapeVertices[], <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vertSize)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> ((position &gt; <span class="hljs-number">0</span>) || (color == <span class="hljs-literal">nullptr</span>) || (vertSize / <span class="hljs-built_in">sizeof</span>(shapeVertices[<span class="hljs-number">0</span>])) != SHAPE_VERTICES_SIZE) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ExecuteDraw: param error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    <span class="hljs-built_in">glVertexAttribPointer</span>(position, POINTER_SIZE, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, shapeVertices);</li><li>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(position);</li><li>    <span class="hljs-built_in">glVertexAttrib4fv</span>(<span class="hljs-number">1</span>, color);</li><li>    <span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_FAN, <span class="hljs-number">0</span>, TRIANGLE_FAN_SIZE);</li><li>    <span class="hljs-built_in">glDisableVertexAttribArray</span>(position);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 结束绘制操作</span></li><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EGLCore::FinishDraw</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// 强制刷新缓冲</span></li><li>    <span class="hljs-built_in">glFlush</span>();</li><li>    <span class="hljs-built_in">glFinish</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eglSwapBuffers</span>(eglDisplay_, eglSurface_);</li><li>}</li></ol></pre></div></div>       <p>(2) 绘制图形。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> EGLCore::Draw(<span class="hljs-type">int</span>&amp; hasDraw) {</li><li>    flag_ = <span class="hljs-literal">false</span>;</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw"</span>);</li><li>    <span class="hljs-type">GLint</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> PrepareDraw();</li><li>    <span class="hljs-keyword">if</span> (position == POSITION_ERROR) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw get position failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 绘制背景</span></li><li>    <span class="hljs-keyword">if</span> (!ExecuteDraw(position, BACKGROUND_COLOR,</li><li>                    BACKGROUND_RECTANGLE_VERTICES, sizeof(BACKGROUND_RECTANGLE_VERTICES))) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw background failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 将五角星分为五个四边形，计算其中一个四边形的四个顶点</span></li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rotateX</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rotateY</span> <span class="hljs-operator">=</span> FIFTY_PERCENT * height_;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">centerX</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">centerY</span> <span class="hljs-operator">=</span> -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">54</span>) * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">leftX</span> <span class="hljs-operator">=</span> -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">leftY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rightX</span> <span class="hljs-operator">=</span> rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rightY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>    const GLfloat shapeVertices[] = {</li><li>        centerX / width_, centerY / height_,</li><li>        leftX / width_, leftY / height_,</li><li>        rotateX / width_, rotateY / height_,</li><li>        rightX / width_, rightY / height_</li><li>    };</li><li>    </li><li>    <span class="hljs-keyword">if</span> (!ExecuteDrawStar(position, DRAW_COLOR, shapeVertices, sizeof(shapeVertices))) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw star failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    </li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rad</span> <span class="hljs-operator">=</span> M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">72</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; NUM_4; ++i) {</li><li>        <span class="hljs-comment">// 旋转得其他四个四边形的顶点</span></li><li>        Rotate2d(centerX, centerY, &amp;rotateX, &amp;rotateY, rad);</li><li>        Rotate2d(centerX, centerY, &amp;leftX, &amp;leftY, rad);</li><li>        Rotate2d(centerX, centerY, &amp;rightX, &amp;rightY, rad);</li><li>        </li><li>        <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>        const GLfloat shapeVertices[] = {</li><li>            centerX / width_, centerY / height_,</li><li>            leftX / width_, leftY / height_,</li><li>            rotateX / width_, rotateY / height_,</li><li>            rightX / width_, rightY / height_</li><li>        };</li><li>        </li><li>        <span class="hljs-comment">// 绘制图形</span></li><li>        <span class="hljs-keyword">if</span> (!ExecuteDrawStar(position, DRAW_COLOR, shapeVertices, sizeof(shapeVertices))) {</li><li>            OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw shape failed"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 结束绘制</span></li><li>    <span class="hljs-keyword">if</span> (!FinishDraw()) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw FinishDraw failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    hasDraw = <span class="hljs-number">1</span>;</li><li>
</li><li>    flag_ = <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div>       <p>(3) 改变颜色，重新画一个大小相同颜色不同的图形，与原图形替换，达到改变颜色的效果。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> EGLCore::ChangeColor(<span class="hljs-type">int</span>&amp; hasChangeColor) {</li><li>    <span class="hljs-keyword">if</span> (!flag_) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ChangeColor"</span>);</li><li>    <span class="hljs-type">GLint</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> PrepareDraw();</li><li>    <span class="hljs-keyword">if</span> (position == POSITION_ERROR) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ChangeColor get position failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 绘制背景</span></li><li>    <span class="hljs-keyword">if</span> (!ExecuteDraw(position, BACKGROUND_COLOR,</li><li>                    BACKGROUND_RECTANGLE_VERTICES, sizeof(BACKGROUND_RECTANGLE_VERTICES))) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ChangeColor execute draw background failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rotateX</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rotateY</span> <span class="hljs-operator">=</span> FIFTY_PERCENT * height_;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">centerX</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">centerY</span> <span class="hljs-operator">=</span> -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">54</span>) * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">leftX</span> <span class="hljs-operator">=</span> -rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">leftY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rightX</span> <span class="hljs-operator">=</span> rotateY * (M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">18</span>);</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rightY</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;</li><li>
</li><li>    <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>    const GLfloat shapeVertices[] = {</li><li>        centerX / width_, centerY / height_,</li><li>        leftX / width_, leftY / height_,</li><li>        rotateX / width_, rotateY / height_,</li><li>        rightX / width_, rightY / height_</li><li>    };</li><li>    </li><li>    <span class="hljs-comment">// 使用新的颜色绘制</span></li><li>    <span class="hljs-keyword">if</span> (!ExecuteDrawNewStar(position, CHANGE_COLOR, shapeVertices, sizeof(shapeVertices))) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw star failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">GLfloat</span> <span class="hljs-variable">rad</span> <span class="hljs-operator">=</span> M_PI / <span class="hljs-number">180</span> * <span class="hljs-number">72</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; NUM_4; ++i) {</li><li>        <span class="hljs-comment">// 旋转得其他四个四边形的顶点</span></li><li>        Rotate2d(centerX, centerY, &amp;rotateX, &amp;rotateY, rad);</li><li>        Rotate2d(centerX, centerY, &amp;leftX, &amp;leftY, rad);</li><li>        Rotate2d(centerX, centerY, &amp;rightX, &amp;rightY, rad);</li><li>        </li><li>        <span class="hljs-comment">// 确定绘制四边形的顶点，使用绘制区域的百分比表示</span></li><li>        const GLfloat shapeVertices[] = {</li><li>            centerX / width_, centerY / height_,</li><li>            leftX / width_, leftY / height_,</li><li>            rotateX / width_, rotateY / height_,</li><li>            rightX / width_, rightY / height_</li><li>        };</li><li>
</li><li>        <span class="hljs-comment">// 使用新的颜色绘制</span></li><li>        <span class="hljs-keyword">if</span> (!ExecuteDrawNewStar(position, CHANGE_COLOR, shapeVertices, sizeof(shapeVertices))) {</li><li>            OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw shape failed"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 结束绘制</span></li><li>    <span class="hljs-keyword">if</span> (!FinishDraw()) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ChangeColor FinishDraw failed"</span>);</li><li>    }</li><li>    hasChangeColor = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li>bool EGLCore::ExecuteDrawNewStar(</li><li>   GLint position, const GLfloat* color, const GLfloat shapeVertices[], unsigned <span class="hljs-type">long</span> vertSize) {</li><li>   <span class="hljs-keyword">if</span> ((position &gt; <span class="hljs-number">0</span>) || (color == nullptr) || (vertSize / sizeof(shapeVertices[<span class="hljs-number">0</span>])) != SHAPE_VERTICES_SIZE) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"ExecuteDraw: param error"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 该gl函数没有返回值。</span></li><li>    glVertexAttribPointer(position, POINTER_SIZE, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, shapeVertices);</li><li>    glEnableVertexAttribArray(position);</li><li>    glVertexAttrib4fv(<span class="hljs-number">1</span>, color);</li><li>    glDrawArrays(GL_TRIANGLE_FAN, <span class="hljs-number">0</span>, TRIANGLE_FAN_SIZE);</li><li>    glDisableVertexAttribArray(position);</li><li>
</li><li>   <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>释放相关资源。</p>       <p>EGLCore类下创建Release()方法，释放初始化环境时申请的资源，包含窗口display、渲染区域surface、环境上下文context等。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EGLCore::Release</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// 释放Surface</span></li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglSurface_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglDestroySurface</span>(eglDisplay_, eglSurface_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Release eglDestroySurface failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 释放context</span></li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (eglContext_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglDestroyContext</span>(eglDisplay_, eglContext_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Release eglDestroyContext failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 释放display</span></li><li>    <span class="hljs-keyword">if</span> ((eglDisplay_ == <span class="hljs-literal">nullptr</span>) || (!<span class="hljs-built_in">eglTerminate</span>(eglDisplay_))) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Release eglTerminate failed"</span>);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>CMakeLists，使用CMake工具链将C++源代码编译成动态链接库文件。</p>       <div _ngcontent-mtq-c106="" class="highlight-div"><div _ngcontent-mtq-c106="" class="highlight-div-header"><div _ngcontent-mtq-c106="" class="highlight-div-header-left"><div _ngcontent-mtq-c106="" class="handle-button expand-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mtq-c106="" class="highlight-div-header-right"><div _ngcontent-mtq-c106="" class="handle-button ai-button"></div><div _ngcontent-mtq-c106="" class="handle-button line-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mtq-c106="" class="handle-button theme-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mtq-c106="" class="handle-button copy-button"><div _ngcontent-mtq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mtq-c106="" class="highlight-scroll-div"><pre class="CMake prettyprint linenums hljs language-scss" hw-language="CMake" data-highlighted="yes"><ol class="linenums"><li># 设置CMake最小版本</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span>.<span class="hljs-number">1</span>)</li><li># 项目名称</li><li><span class="hljs-built_in">project</span>(XComponent)</li><li>
</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li><span class="hljs-built_in">add_definitions</span>(-DOHOS_PLATFORM)</li><li># 设置头文件搜索目录</li><li><span class="hljs-built_in">include_directories</span>(</li><li>    ${NATIVERENDER_ROOT_PATH}</li><li>    ${NATIVERENDER_ROOT_PATH}/include</li><li>)</li><li># 添加名为nativerender的动态库，库文件名为libnativerender<span class="hljs-selector-class">.so</span>，添加cpp文件</li><li><span class="hljs-built_in">add_library</span>(nativerender SHARED</li><li>    render/egl_core.cpp</li><li>    render/plugin_render.cpp</li><li>    manager/plugin_manager.cpp</li><li>    napi_init.cpp</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    EGL-lib</li><li>    EGL</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    GLES-lib</li><li>    GLESv3</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    hilog-lib</li><li>    hilog_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    libace-lib</li><li>    ace_ndk.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    libnapi-lib</li><li>    ace_napi.z</li><li>)</li><li>
</li><li><span class="hljs-built_in">find_library</span>(</li><li>    libuv-lib</li><li>    uv</li><li>)</li><li># 添加构建需要链接的库</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>    ${EGL-lib} ${GLES-lib} ${hilog-lib} ${libace-lib} ${libnapi-lib} ${libuv-lib})</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/HarmonyOS_Samples/guide-snippets/tree/master/ArkUIKit/ArkTSXComponent" target="_blank">ArkTS XComponent</a></li>      <li><a href="https://gitcode.com/HarmonyOS_Samples/guide-snippets/tree/master/ArkUIKit/NdkXComponent" target="_blank">NdkXComponent</a></li>      <li><a href="https://gitcode.com/HarmonyOS_Samples/guide-snippets/tree/master/ArkUIKit/NativeXComponent" target="_blank">NativeXComponent</a></li>     </ul>    </div>   </div>   <div></div></div>