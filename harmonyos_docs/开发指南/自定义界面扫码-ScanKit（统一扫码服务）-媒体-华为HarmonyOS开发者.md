<h1 _ngcontent-bvh-c119="" class="doc-title ng-star-inserted" title="自定义界面扫码"> 自定义界面扫码 </h1>

<div _ngcontent-bvh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section16522171851016">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section16522171851016" tips="复制节点链接"></i></h2>          <p>自定义界面扫码能力提供了相机流控制接口，可根据自身需求自定义扫码界面，适用于对扫码界面有定制化需求的应用开发。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>通过自定义界面扫码可以实现应用内的扫码功能，为了应用更好的体验，推荐同时<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/scan-directservice">接入“扫码直达”服务</a>，应用可以同时支持系统扫码入口（控制中心扫一扫）和应用内扫码两种方式跳转到指定服务页面。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section15946202982010">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section15946202982010" tips="复制节点链接"></i></h2>          <p>自定义界面扫码能力提供扫码相机流控制接口，支持相机流的初始化、开启、暂停、释放、重新扫码功能；支持闪光灯的状态获取、开启、关闭；支持变焦比的获取和设置；支持设置相机焦点和连续自动对焦；支持对条形码、二维码、MULTIFUNCTIONAL CODE进行扫码识别（具体类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-scancore#section113371139123212" target="_blank">ScanType</a>），并获得码类型、码值、码位置信息、相机预览流（YUV）。该能力可用于单码和多码的扫描识别。</p>     <p>开发者集成自定义界面扫码能力可以自行定义扫码的界面样式，请按照业务流程完成扫码接口调用实现实时扫码功能。建议开发者基于<a href="https://gitcode.com/HarmonyOS_Samples/scan-kit_-sample-code_-clientdemo_-arkts" target="_blank">Sample Code</a>做个性化修改。</p>     <p>扫码页面UX设计规范：</p>     <p><span><img height="294.2625" originheight="3240" originwidth="5760" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114420.00254072454462953420068866184483:50001231000000:2800:5634B21F74C7331E3873D0A3E0CDC75C943E3332C5A77CDCF09E93828326CF2E.png" title="点击放大" width="523.6875"></span></p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>YUV（相机预览流图像数据）适合于扫码和识物的综合识别场景，开发者需要自己控制相机流，普通扫码场景无需关注。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section9684181513312">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section9684181513312" tips="复制节点链接"></i></h2>          <ul>      <li>需要请求相机的使用权限。</li>      <li>需要开发者自行实现扫码的人机交互界面。例如：多码场景需要暂停相机流由用户选择一个码图进行识别。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section52491649171418">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section52491649171418" tips="复制节点链接"></i></h2>          <p><span><img height="723.2673" originheight="1689" originwidth="1551" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114420.10765477435750433218986722154273:50001231000000:2800:69D8B0A07CDBBCC3698CDCD6C3FC1CB5EA0E9BD9C22E00D91B48B3A5BD78ACAC.png" title="点击放大" width="665"></span></p>     <ol>      <li><strong>发起请求：</strong>用户向开发者的应用发起扫码请求，应用拉起已定义好的扫码界面。</li>      <li><strong>申请授权：</strong>应用需要向用户申请相机权限授权。若未同意授权，则无法使用此功能。</li>      <li><strong>启动自定义界面扫码：</strong>在扫码前必须调用init接口初始化自定义扫码界面，加载资源。相机流初始化结束后，调用start接口开始扫码。</li>      <li><strong>自定义界面扫码相机操作：</strong>可以配置自定义界面扫码相机操作参数，调整相应功能，包括闪光灯、变焦、焦距、暂停、重启扫码等。例如：       <ul>        <li>根据当前码图位置，比如当前码图太远或太近时，调用getZoom获取变焦比，setZoom接口设置变焦比，调整焦距以便于用户扫码。</li>        <li>根据当前扫码的光线条件或根据on('lightingFlash')监听闪光灯开启时机，通过getFlashLightStatus接口先获取闪光灯状态，再调用openFlashLight/closeFlashLight接口控制闪光灯开启或关闭，以便于用户进行扫码。</li>        <li>调用setFocusPoint设置对焦位置，resetFocus恢复默认对焦模式，以便于用户进行扫码。</li>        <li>在应用处于前后台或其他特殊场景需要中断/重新进行扫码时，可调用stop或start接口来控制相机流达到暂停或重新扫码的目的。</li>       </ul></li>      <li><strong>自定义界面扫码：</strong>Scan Kit API在扫码完成后会返回扫码结果。同时根据开发者的需要，Scan Kit API会返回每帧相机预览流数据。如需不重启相机并重新触发一次扫码，可以在start接口的Callback异步回调中，调用rescan接口。完成扫码后，需调用release接口进行释放扫码资源的操作。</li>      <li><strong>获取结果：</strong>解析码值结果跳转应用服务页。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section11259105832014">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section11259105832014" tips="复制节点链接"></i></h2>          <p>自定义界面扫码提供init、start、stop、release、getFlashLightStatus、openFlashLight、closeFlashLight、setZoom、getZoom、setFocusPoint、resetFocus、rescan、on('lightingFlash')、off('lightingFlash')接口，其中部分接口返回值有两种返回形式：Callback和Promise回调。Callback和Promise回调函数只是返回值方式不一样，功能相同。具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api" target="_blank">接口文档</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.1" valign="top" width="49.95%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.2" valign="top" width="50.05%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section447114223245" target="_blank">init</a>(options?: scanBarcode.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-scanbarcode-api#section1285191073117" target="_blank">ScanOptions</a>): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>初始化自定义界面扫码，加载资源。无返回结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section38711535114711" target="_blank">start</a>(viewControl: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section8604949165313" target="_blank">ViewControl</a>): Promise&lt;Array&lt;scanBarcode.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-scanbarcode-api#section10614317162112" target="_blank">ScanResult</a>&gt;&gt;</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>启动扫码相机流。使用Promise异步回调获取扫码结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section6949611114915" target="_blank">stop</a>(): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>暂停扫码相机流。使用Promise异步回调返回执行结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1109456134917" target="_blank">release</a>(): Promise&lt;void&gt;</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>释放扫码相机流。使用Promise异步回调返回执行结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section747366165913" target="_blank">start</a>(viewControl: ViewControl, callback: AsyncCallback&lt;Array&lt;scanBarcode.ScanResult&gt;&gt;, frameCallback?: AsyncCallback&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1670633211200" target="_blank">ScanFrame</a>&gt;): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>启动扫码相机流。使用Callback异步回调返回扫码结果以及YUV图像数据。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1693117333508" target="_blank">getFlashLightStatus</a>(): boolean</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取闪光灯状态。返回结果为布尔值，true为打开状态，false为关闭状态。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section75901948175116" target="_blank">openFlashLight</a>(): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>开启闪光灯。无返回结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section17980725135120" target="_blank">closeFlashLight</a>(): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>关闭闪光灯。无返回结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section070810389567" target="_blank">setZoom</a>(zoomValue : number): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>设置变焦比。无返回结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1699185032017" target="_blank">getZoom</a>(): number</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>获取当前的变焦比。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section288962116197" target="_blank">setFocusPoint</a>(point: scanBarcode.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-scanbarcode-api#section9634457911" target="_blank">Point</a>): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>设置相机焦点。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section12891152115196" target="_blank">resetFocus</a>(): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>设置连续自动对焦模式。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section19244173211169" target="_blank">rescan</a>(): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>触发一次重新扫码。仅对start接口Callback异步回调有效，Promise异步回调无效。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section031674815483" target="_blank">stop</a>(callback: AsyncCallback&lt;void&gt;): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>暂停扫码相机流。使用Callback异步回调返回执行结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section169321832184912" target="_blank">release</a>(callback: AsyncCallback&lt;void&gt;): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>释放扫码相机流。使用Callback异步回调返回执行结果。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1788353253914" target="_blank">on</a>(type: 'lightingFlash', callback: AsyncCallback&lt;boolean&gt;): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>订阅闪光灯状态监听事件，当环境昏、亮状态变化时，使用Callback异步回调返回打开时机。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.95%">          <p style="color: rgb(63,63,63);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section128574416409" target="_blank">off</a>(type: 'lightingFlash', callback?: AsyncCallback&lt;boolean&gt;): void</p></td>         <td class="cellrowborder" valign="top" width="50.05%">          <p>注销闪光灯状态监听事件。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section2061992014108">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2061992014108" tips="复制节点链接"></i></h2>          <p>自定义界面扫码接口支持自定义UI界面，识别相机流中的条形码，二维码以及MULTIFUNCTIONAL CODE，并返回码图的值、类型、码的位置信息（码图最小外接矩形左上角和右下角的坐标）以及相机预览流（YUV）。</p>     <p>为了方便开发者接入，我们提供了详细的样例工程供参考，推荐参考<a href="https://gitcode.com/HarmonyOS_Samples/scan-kit_-sample-code_-clientdemo_-arkts" target="_blank">示例工程</a>接入。</p>     <p>以下示例为调用自定义界面扫码接口拉起相机流并返回扫码结果和相机预览流（YUV）。</p>     <ol>      <li>在开发应用前，需要先申请相机相关权限，确保应用拥有访问相机的权限。在<span class="filepath">“module.json5”</span>文件中配置相机权限，具体配置方式，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。        <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.4.1.1" valign="top" width="33.33333333333333%">            <p>权限名</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.4.1.2" valign="top" width="33.33333333333333%">            <p>说明</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.4.1.3" valign="top" width="33.33333333333333%">            <p>授权方式</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">            <p>ohos.permission.CAMERA</p></td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">            <p>允许应用使用相机扫码。</p></td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">            <p>user_grant</p></td>          </tr>                 </tbody></table></div>       </div></li>      <li>使用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestpermissionsfromuser9-1" target="_blank">requestPermissionsFromUser</a>请求用户授权。具体申请方式及校验方式，请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization" target="_blank">向用户申请授权</a>。</li>      <li>导入自定义界面扫码接口以及相关接口模块，导入方法如下。       <div _ngcontent-bvh-c106="" class="highlight-div"><div _ngcontent-bvh-c106="" class="highlight-div-header"><div _ngcontent-bvh-c106="" class="highlight-div-header-left"><div _ngcontent-bvh-c106="" class="handle-button expand-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bvh-c106="" class="highlight-div-header-right"><div _ngcontent-bvh-c106="" class="handle-button ai-button"></div><div _ngcontent-bvh-c106="" class="handle-button line-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bvh-c106="" class="handle-button theme-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bvh-c106="" class="handle-button copy-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bvh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { scanCore, scanBarcode, customScan } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ScanKit'</span>;</li><li><span class="hljs-comment">// 导入功能涉及的权限申请、回调接口</span></li><li><span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncCallback</span>, <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { common, abilityAccessCtrl, <span class="hljs-title class_">PermissionRequestResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li></ol></pre></div></div></li>      <li>遵循<a href="/consumer/cn/doc/harmonyos-guides/scan-customscan#section52491649171418">业务流程</a>完成自定义界面扫码功能。       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ol>          <li>在设置start接口的viewControl参数时，width和height与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>的宽高值相同，start接口会根据XComponent的宽高比例从相机的分辨率选择最优分辨率，如果比例与相机的分辨率比例相差过大会返回内部错误。当前支持的分辨率比例为16:9、4:3、1:1。竖屏场景下，XComponent的高度需要大于宽度，且高宽比在支持的分辨率比例中。横屏场景下，XComponent的宽度需要大于高度，且宽高比在支持的分辨率比例中。</li>          <li>XComponent的宽高需根据使用场景计算适配。例如：在开发设备为折叠屏时，需按照折叠屏的展开态和折叠态分别计算XComponent的宽高，start接口会根据XComponent的宽高适配对应的相机分辨率。设备屏幕宽高可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#displaygetdefaultdisplaysync9" target="_blank">display.getDefaultDisplaySync</a>方法获取（获取的为px单位，需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#px2vp12" target="_blank">px2vp</a>方法转为vp）。</li>         </ol>        </div></div></div>       <ul>        <li>通过Promise方式回调，调用自定义界面扫码接口拉起相机流并返回扫码结果。         <div _ngcontent-bvh-c106="" class="highlight-div"><div _ngcontent-bvh-c106="" class="highlight-div-header"><div _ngcontent-bvh-c106="" class="highlight-div-header-left"><div _ngcontent-bvh-c106="" class="handle-button expand-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bvh-c106="" class="highlight-div-header-right"><div _ngcontent-bvh-c106="" class="handle-button ai-button"></div><div _ngcontent-bvh-c106="" class="handle-button line-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bvh-c106="" class="handle-button theme-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bvh-c106="" class="handle-button copy-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bvh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[customScanPage]'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CustomScanPage</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">userGrant</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否已申请相机权限</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span> <span class="hljs-comment">// XComponent组件生成id</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShowBack</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否已经返回扫码结果</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isFlashLightEnable</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否开启了闪光灯</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isSensorLight</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 记录当前环境亮暗状态</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">cameraHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">640</span> <span class="hljs-comment">// 设置预览流高度，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">cameraWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">360</span> <span class="hljs-comment">// 设置预览流宽度，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">offsetX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 设置预览流x轴方向偏移量，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">offsetY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 设置预览流y轴方向偏移量，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">zoomValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 预览流缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">setZoomValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 已设置的预览流缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scaleValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 屏幕缩放比</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">pinchValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 双指缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 屏幕高度，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 屏幕宽度，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanResult</span>: <span class="hljs-title class_">Array</span>&lt;scanBarcode.<span class="hljs-property">ScanResult</span>&gt; = [] <span class="hljs-comment">// 扫码结果</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>()</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onPageShow</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 自定义启动第一步，用户申请权限</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestCameraPermission</span>();</li><li>    <span class="hljs-comment">// 多码扫码识别，enableMultiMode: true 单码扫码识别enableMultiMode: false</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: scanBarcode.<span class="hljs-property">ScanOptions</span> = {</li><li>      <span class="hljs-attr">scanTypes</span>: [scanCore.<span class="hljs-property">ScanType</span>.<span class="hljs-property">ALL</span>],</li><li>      <span class="hljs-attr">enableMultiMode</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-attr">enableAlbum</span>: <span class="hljs-literal">true</span></li><li>    }</li><li>    <span class="hljs-comment">// 自定义启动第二步：设置预览流布局尺寸</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setDisplay</span>();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 自定义启动第三步，初始化接口</span></li><li>      customScan.<span class="hljs-title function_">init</span>(options);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to init customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onPageHide</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 页面消失或隐藏时，停止并释放相机流</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlashLightEnable</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSensorLight</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      customScan.<span class="hljs-title function_">off</span>(<span class="hljs-string">'lightingFlash'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to off lightingFlash. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customScanStop</span>();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 自定义相机流释放接口</span></li><li>      customScan.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>          <span class="hljs-string">`Failed to release customScan by promise. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to release customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 用户申请权限</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">reqPermissionsFromUser</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>[]&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'reqPermissionsFromUser start'</span>);</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();    </li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">grantStatus</span>: <span class="hljs-title class_">PermissionRequestResult</span> =</li><li>        <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.CAMERA'</span>]);</li><li>      <span class="hljs-keyword">return</span> grantStatus.<span class="hljs-property">authResults</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to requestPermissionsFromUser. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> [];</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 用户申请相机权限</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestCameraPermission</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> grantStatus = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reqPermissionsFromUser</span>();</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; grantStatus.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">if</span> (grantStatus[i] === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-comment">// 用户授权，可以继续访问目标操作</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in getting permissions.'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 竖屏时获取屏幕尺寸，设置预览流全屏示例</span></li><li>  <span class="hljs-title function_">setDisplay</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 默认竖屏</span></li><li>      <span class="hljs-keyword">let</span> displayClass = display.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">height</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">width</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">maxLen</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">minLen</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">RATIO</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraHeight</span> = maxLen;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraWidth</span> = maxLen / <span class="hljs-variable constant_">RATIO</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> = (minLen - <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraWidth</span>) / <span class="hljs-number">2</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to getDefaultDisplaySync. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// toast显示扫码结果</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">showScanResult</span>(<span class="hljs-params">result: scanBarcode.ScanResult</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 使用toast显示出扫码结果</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-attr">message</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result),</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">5000</span></li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to showToast. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initCamera</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanResult</span> = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">viewControl</span>: customScan.<span class="hljs-property">ViewControl</span> = {</li><li>      <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraWidth</span>,</li><li>      <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraHeight</span>,</li><li>      <span class="hljs-attr">surfaceId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span></li><li>    };</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 自定义启动第四步，请求扫码接口，通过Promise方式回调</span></li><li>      customScan.<span class="hljs-title function_">start</span>(viewControl)</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">Array</span>&lt;scanBarcode.ScanResult&gt;</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`result: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);</li><li>          <span class="hljs-keyword">if</span> (result.<span class="hljs-property">length</span>) {</li><li>            <span class="hljs-comment">// 解析码值结果跳转应用服务页</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanResult</span> = result;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span> = <span class="hljs-literal">true</span>;</li><li>            <span class="hljs-comment">// 获取到扫描结果后暂停相机流</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customScanStop</span>();</li><li>          }</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">customScanStop</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      customScan.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 自定义扫码界面的顶部返回按钮和扫码提示</span></li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">TopTool</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Flex</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-property">Row</span>, <span class="hljs-attr">justifyContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>, <span class="hljs-attr">alignItems</span>: <span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span> }) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'返回'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>();</li><li>          })</li><li>      }.<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">40</span> })</li><li>
</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'扫描二维码/条形码'</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'对准二维码/条形码，即可自动扫描'</span>)</li><li>      }.<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">24</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">146</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">XComponent</span>({</li><li>            <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>            <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>            <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>          })</li><li>            .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in loading, onLoad is called.'</span>);</li><li>              <span class="hljs-comment">// 获取XComponent组件的surfaceId</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting surfaceId: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.surfaceId}</span>`</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>              <span class="hljs-comment">// 闪光灯监听接口</span></li><li>              customScan.<span class="hljs-title function_">on</span>(<span class="hljs-string">'lightingFlash'</span>, <span class="hljs-function">(<span class="hljs-params">error, isLightingFlash</span>) =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (error) {</li><li>                  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                    <span class="hljs-string">`Failed to on lightingFlash. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>                <span class="hljs-keyword">if</span> (isLightingFlash) {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlashLightEnable</span> = <span class="hljs-literal">true</span>;</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-keyword">try</span> {</li><li>                    <span class="hljs-keyword">if</span> (!customScan.<span class="hljs-title function_">getFlashLightStatus</span>()) {</li><li>                      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlashLightEnable</span> = <span class="hljs-literal">false</span>;</li><li>                    }</li><li>                  } <span class="hljs-keyword">catch</span> (error) {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                      <span class="hljs-string">`Failed to get flashLightStatus. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  }</li><li>                }</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSensorLight</span> = isLightingFlash;</li><li>              });</li><li>            })</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraWidth</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraHeight</span>)</li><li>            .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>
</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">TopTool</span>()</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>        }</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 闪光灯按钮，启动相机流后才能使用</span></li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'FlashLight'</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-attr">lightStatus</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  lightStatus = customScan.<span class="hljs-title function_">getFlashLightStatus</span>();</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                    <span class="hljs-string">`Failed to get flashLightStatus. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                }</li><li>
</li><li>
</li><li>                <span class="hljs-comment">// 根据当前闪光灯状态，选择打开或关闭闪光灯</span></li><li>                <span class="hljs-keyword">if</span> (lightStatus) {</li><li>                  <span class="hljs-keyword">try</span> {</li><li>                    customScan.<span class="hljs-title function_">closeFlashLight</span>();</li><li>                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlashLightEnable</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSensorLight</span>;</li><li>                    }, <span class="hljs-number">200</span>);</li><li>                  } <span class="hljs-keyword">catch</span> (error) {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                      <span class="hljs-string">`Failed to close flashLight. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  }</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-keyword">try</span> {</li><li>                    customScan.<span class="hljs-title function_">openFlashLight</span>();</li><li>                  } <span class="hljs-keyword">catch</span> (error) {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                      <span class="hljs-string">`Failed to open flashLight. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  }</li><li>                }</li><li>              })</li><li>              .<span class="hljs-title function_">visibility</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlashLightEnable</span>) ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span>)</li><li>
</li><li>
</li><li>            <span class="hljs-comment">// 扫码成功后，点击按钮后重新扫码</span></li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Scan'</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-comment">// 点击按钮重启相机流，重新扫码</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>              })</li><li>              .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span>)</li><li>          }</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 预览流设置缩放比例</span></li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'缩放比例,当前比例:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-comment">// 设置相机缩放比例</span></li><li>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span>) {</li><li>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span>) {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>                  } <span class="hljs-keyword">else</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span>;</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customSetZoom</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span>);</li><li>                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span>) {</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>                      }</li><li>                    }, <span class="hljs-number">1000</span>);</li><li>                  }</li><li>                }</li><li>              })</li><li>          }</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 输入要设置的预览流缩放比例</span></li><li>            <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'输入缩放倍数'</span> })</li><li>              .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">InputType</span>.<span class="hljs-property">Number</span>)</li><li>              .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>              .<span class="hljs-title function_">onChange</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> = <span class="hljs-title class_">Number</span>(value);</li><li>              })</li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">180</span>)</li><li>      }</li><li>
</li><li>
</li><li>      <span class="hljs-comment">// 单码、多码扫描后，显示码图蓝点位置。点击toast码图信息</span></li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanResult</span>, <span class="hljs-function">(<span class="hljs-params">item: scanBarcode.ScanResult</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">scanCodeRect</span>) {</li><li>          <span class="hljs-title class_">Image</span>($rawfile(<span class="hljs-string">'scan_selected2.svg'</span>)) <span class="hljs-comment">// src/main/resources/rawfile/scan_selected2.svg</span></li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">markAnchor</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">20</span> })</li><li>            .<span class="hljs-title function_">position</span>({</li><li>              <span class="hljs-attr">x</span>: (item.<span class="hljs-property">scanCodeRect</span>.<span class="hljs-property">left</span> + item?.<span class="hljs-property">scanCodeRect</span>?.<span class="hljs-property">right</span>) / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span>,</li><li>              <span class="hljs-attr">y</span>: (item.<span class="hljs-property">scanCodeRect</span>.<span class="hljs-property">top</span> + item?.<span class="hljs-property">scanCodeRect</span>?.<span class="hljs-property">bottom</span>) / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span></li><li>            })</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showScanResult</span>(item);</li><li>            })</li><li>        }</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: scanBarcode.ScanResult</span>) =&gt;</span> <span class="hljs-string">''</span> + item?.<span class="hljs-property">scanCodeRect</span>?.<span class="hljs-property">left</span> + item?.<span class="hljs-property">scanCodeRect</span>?.<span class="hljs-property">right</span> + <span class="hljs-string">'px'</span>)</li><li>    }</li><li>    <span class="hljs-comment">// 建议相机流设置为全屏</span></li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 是否已扫描到结果</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 点击屏幕位置，获取点击位置(x,y)，设置相机焦点</span></li><li>      <span class="hljs-keyword">let</span> x1 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">displayY</span>) / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span> + <span class="hljs-number">0.0</span>);</li><li>      <span class="hljs-keyword">let</span> y1 = <span class="hljs-number">1.0</span> - (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">displayX</span>) / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span> + <span class="hljs-number">0.0</span>));</li><li>      <span class="hljs-keyword">try</span> {</li><li>        customScan.<span class="hljs-title function_">setFocusPoint</span>({ <span class="hljs-attr">x</span>: x1, <span class="hljs-attr">y</span>: y1 });</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in setting focusPoint x1: <span class="hljs-subst">${x1}</span>, y1: <span class="hljs-subst">${y1}</span>`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set focusPoint. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in setting focusPoint x1: <span class="hljs-subst">${x1}</span>, y1: <span class="hljs-subst">${y1}</span>`</span>);</li><li>      <span class="hljs-comment">// 设置连续自动对焦模式</span></li><li>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          customScan.<span class="hljs-title function_">resetFocus</span>();</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to reset focus. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        }</li><li>      }, <span class="hljs-number">200</span>);</li><li>    }).<span class="hljs-title function_">gesture</span>(<span class="hljs-title class_">PinchGesture</span>({ <span class="hljs-attr">fingers</span>: <span class="hljs-number">2</span> })</li><li>      .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">(<span class="hljs-params">_: GestureEvent</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Pinch start'</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (event) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = event.<span class="hljs-property">scale</span>;</li><li>        }</li><li>      })</li><li>      .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">(<span class="hljs-params">_: GestureEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 是否已扫描到结果</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowBack</span>) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 获取双指缩放比例，设置变焦比</span></li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">let</span> zoom = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pinchValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> * zoom;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customSetZoom</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pinchValue</span>);</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Pinch end'</span>);</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        }</li><li>      }))</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">customGetZoom</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> zoom = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      zoom = customScan.<span class="hljs-title function_">getZoom</span>();</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting zoom, zoom: <span class="hljs-subst">${zoom}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> zoom;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">customSetZoom</span>(<span class="hljs-attr">pinchValue</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      customScan.<span class="hljs-title function_">setZoom</span>(pinchValue);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in setting zoom.`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>        <li>通过Callback方式回调，调用自定义界面扫码接口拉起相机流并返回扫码结果和相机预览流（YUV）。         <div _ngcontent-bvh-c106="" class="highlight-div"><div _ngcontent-bvh-c106="" class="highlight-div-header"><div _ngcontent-bvh-c106="" class="highlight-div-header-left"><div _ngcontent-bvh-c106="" class="handle-button expand-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bvh-c106="" class="highlight-div-header-right"><div _ngcontent-bvh-c106="" class="handle-button ai-button"></div><div _ngcontent-bvh-c106="" class="handle-button line-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bvh-c106="" class="handle-button theme-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bvh-c106="" class="handle-button copy-button"><div _ngcontent-bvh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bvh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { bundleManager, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'[YUV CPSample]'</span>;</li><li>
</li><li><span class="hljs-comment">// 用户申请权限</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionsUtil</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">checkAccessToken</span>(<span class="hljs-attr">permission</span>: <span class="hljs-title class_">Permissions</span>): <span class="hljs-title class_">Promise</span>&lt;abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">grantStatus</span>: abilityAccessCtrl.<span class="hljs-property">GrantStatus</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-comment">// 获取应用程序的accessTokenID</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">tokenId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;    </li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">bundleInfo</span>: bundleManager.<span class="hljs-property">BundleInfo</span> =</li><li>        <span class="hljs-keyword">await</span> bundleManager.<span class="hljs-title function_">getBundleInfoForSelf</span>(bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_WITH_APPLICATION</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: bundleManager.<span class="hljs-property">ApplicationInfo</span> = bundleInfo.<span class="hljs-property">appInfo</span>;</li><li>      tokenId = appInfo.<span class="hljs-property">accessTokenId</span>;</li><li>      <span class="hljs-comment">// 校验应用是否被授予权限</span></li><li>      grantStatus = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">checkAccessToken</span>(tokenId, permission);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>       <span class="hljs-string">`Failed to getBundleInfoForSelf or checkAccessToken. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> grantStatus;</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// 申请相机权限</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">reqPermissionsFromUser</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>[]&gt; {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in getting permissions by promise.'</span>)</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();    </li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">grantStatus</span>: <span class="hljs-title class_">PermissionRequestResult</span> =</li><li>        <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.CAMERA'</span>]);</li><li>      <span class="hljs-keyword">return</span> grantStatus.<span class="hljs-property">authResults</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to requestPermissionsFromUser. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> [];</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Extend</span>(<span class="hljs-title class_">Column</span>)</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">mainStyle</span>(<span class="hljs-params"></span>) {</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">padding</span>({</li><li>    <span class="hljs-attr">top</span>: <span class="hljs-number">40</span></li><li>  })</li><li>  .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">YUVScan</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">userGrant</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否已申请相机权限</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">surfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span> <span class="hljs-comment">// XComponent组件生成id</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">cameraHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">640</span> <span class="hljs-comment">// 设置预览流高度，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">cameraWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">360</span> <span class="hljs-comment">// 设置预览流宽度，默认单位：vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">zoomValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 预览流缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">setZoomValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 已设置的预览流缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isReleaseCamera</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否已释放相机流</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">384</span> <span class="hljs-comment">// XComponent宽度，默认设置384，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">682</span> <span class="hljs-comment">// XComponent高度，默认设置682，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanBottom</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">220</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">offsetX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// XComponent位置x轴偏移量，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">offsetY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// XComponent位置y轴偏移量，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanCodeRect</span>: <span class="hljs-title class_">Array</span>&lt;scanBarcode.<span class="hljs-property">ScanCodeRect</span>&gt; = [] <span class="hljs-comment">// 扫码结果码图位置</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanFlag</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否已经扫码到结果</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scanFrameResult</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">scaleValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 屏幕缩放比</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">pinchValue</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 双指缩放比例</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 屏幕高度，单位vp</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 屏幕宽度，单位vp</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mXComponentController</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>()</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">viewControl</span>: customScan.<span class="hljs-property">ViewControl</span> = { <span class="hljs-attr">width</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">1080</span>, <span class="hljs-attr">surfaceId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> }</li><li>  <span class="hljs-attr">options</span>: scanBarcode.<span class="hljs-property">ScanOptions</span> = {</li><li>    <span class="hljs-comment">// 扫码类型，可选参数</span></li><li>    <span class="hljs-attr">scanTypes</span>: [scanCore.<span class="hljs-property">ScanType</span>.<span class="hljs-property">ALL</span>],</li><li>    <span class="hljs-comment">// 是否开启多码识别，可选参数</span></li><li>    <span class="hljs-attr">enableMultiMode</span>: <span class="hljs-literal">true</span>,</li><li>    <span class="hljs-comment">// 是否开启相册扫码，可选参数</span></li><li>    <span class="hljs-attr">enableAlbum</span>: <span class="hljs-literal">true</span>,</li><li>  }</li><li>  <span class="hljs-comment">// 返回自定义扫描结果的回调</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">callback</span>: <span class="hljs-title class_">AsyncCallback</span>&lt;scanBarcode.<span class="hljs-property">ScanResult</span>[]&gt; =</li><li>    <span class="hljs-keyword">async</span> (<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">result</span>: scanBarcode.<span class="hljs-property">ScanResult</span>[]) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (error &amp;&amp; error.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>          <span class="hljs-string">`Failed to get ScanResult by callback. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 解析码值结果跳转应用服务页</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting ScanResult by callback, result: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);</li><li>    }</li><li>  <span class="hljs-comment">// 返回相机帧的回调</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">frameCallback</span>: <span class="hljs-title class_">AsyncCallback</span>&lt;customScan.<span class="hljs-property">ScanFrame</span>&gt; =</li><li>    <span class="hljs-keyword">async</span> (<span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">frameResult</span>: customScan.<span class="hljs-property">ScanFrame</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get ScanFrame by callback. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// byteBuffer相机YUV图像数组</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`Succeeded in getting ScanFrame.byteBuffer.byteLength: <span class="hljs-subst">${frameResult.byteBuffer.byteLength}</span>`</span>)</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting ScanFrame.width: <span class="hljs-subst">${frameResult.width}</span>`</span>)</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting ScanFrame.height: <span class="hljs-subst">${frameResult.height}</span>`</span>)</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFrameResult</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(frameResult.<span class="hljs-property">scanCodeRects</span>);</li><li>      <span class="hljs-keyword">if</span> (frameResult &amp;&amp; frameResult.<span class="hljs-property">scanCodeRects</span> &amp;&amp; frameResult.<span class="hljs-property">scanCodeRects</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>        <span class="hljs-keyword">if</span> (frameResult.<span class="hljs-property">scanCodeRects</span>[<span class="hljs-number">0</span>]) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopCamera</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span> = [];</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-comment">// 码图位置信息转换</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeToXComponent</span>(frameResult);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> = <span class="hljs-literal">false</span>;</li><li>        }</li><li>      }</li><li>    }</li><li>
</li><li>  <span class="hljs-comment">// frameCallback横向码图位置信息转换为预览流XComponent对应码图位置信息</span></li><li>  <span class="hljs-title function_">changeToXComponent</span>(<span class="hljs-params">frameResult: customScan.ScanFrame</span>) {</li><li>    <span class="hljs-keyword">if</span> (frameResult &amp;&amp; frameResult.<span class="hljs-property">scanCodeRects</span>) {</li><li>      <span class="hljs-keyword">let</span> frameHeight = frameResult.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-keyword">let</span> ratio = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanWidth</span> / frameHeight;</li><li>      frameResult.<span class="hljs-property">scanCodeRects</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span>.<span class="hljs-title function_">push</span>({</li><li>          <span class="hljs-attr">left</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toFixedNumber</span>((frameHeight - item.<span class="hljs-property">bottom</span>) * ratio),</li><li>          <span class="hljs-attr">top</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toFixedNumber</span>(item.<span class="hljs-property">left</span> * ratio),</li><li>          <span class="hljs-attr">right</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toFixedNumber</span>((frameHeight - item.<span class="hljs-property">top</span>) * ratio),</li><li>          <span class="hljs-attr">bottom</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toFixedNumber</span>(item.<span class="hljs-property">right</span> * ratio)</li><li>        });</li><li>      });</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFrameResult</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">toFixedNumber</span>(<span class="hljs-attr">no</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Number</span>((no).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>));</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onPageShow</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 自定义启动第一步，用户申请权限</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">permissions</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Permissions</span>&gt; = [<span class="hljs-string">'ohos.permission.CAMERA'</span>];</li><li>    <span class="hljs-comment">// 自定义启动第二步：设置预览流布局尺寸</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setDisplay</span>();</li><li>    <span class="hljs-keyword">let</span> grantStatus = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PermissionsUtil</span>.<span class="hljs-title function_">checkAccessToken</span>(permissions[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">if</span> (grantStatus === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>) {</li><li>      <span class="hljs-comment">// 已经授权，可以继续访问目标操作</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span>) {</li><li>        <span class="hljs-comment">// 自定义启动第三步，初始化接口</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 申请相机权限</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestCameraPermission</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onPageHide</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 用户申请权限</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestCameraPermission</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> grantStatus =</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">PermissionsUtil</span>.<span class="hljs-title function_">reqPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>)</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> = grantStatus.<span class="hljs-property">length</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">userGrant</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 用户拒绝授权，提示用户必须授权才能访问当前页面的功能，并引导用户到系统设置中打开相应的权限</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {</li><li>      <span class="hljs-keyword">if</span> (grantStatus[i] === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-comment">// 用户授权，可以继续访问目标操作</span></li><li>        userGrant = <span class="hljs-literal">true</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> = userGrant;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 竖屏时获取屏幕尺寸，设置预览流全屏示例</span></li><li>  <span class="hljs-title function_">setDisplay</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 以手机为例计算宽高</span></li><li>      <span class="hljs-keyword">let</span> displayClass = display.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">height</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">width</span>);</li><li>      <span class="hljs-keyword">if</span> (displayClass !== <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">width</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanHeight</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanWidth</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewControl</span>.<span class="hljs-property">width</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewControl</span>.<span class="hljs-property">height</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanBottom</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">220</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(displayClass.<span class="hljs-property">height</span>) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanHeight</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span> = <span class="hljs-number">0</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to getDefaultDisplaySync. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 初始化相机流</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initCamera</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReleaseCamera</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 自定义启动第三步，初始化接口</span></li><li>      customScan.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in initializing customScan with options.'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to init customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span> = [];</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 自定义启动第四步，请求扫码接口</span></li><li>      customScan.<span class="hljs-title function_">start</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">viewControl</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">callback</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameCallback</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 暂停相机流</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopCamera</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReleaseCamera</span>) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        customScan.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        });</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to stop customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放相机流</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseCamera</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReleaseCamera</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopCamera</span>();</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">await</span> customScan.<span class="hljs-title function_">release</span>();</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to release customScan. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReleaseCamera</span> = <span class="hljs-literal">true</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Stack</span>() {</li><li>      <span class="hljs-comment">// 相机预览流XComponent</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span>) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">XComponent</span>({</li><li>            <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>            <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>            <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span></li><li>          })</li><li>            .<span class="hljs-title function_">onLoad</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Succeeded in loading, onLoad is called.'</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting surfaceId is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.surfaceId}</span>`</span>);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewControl</span> = { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanWidth</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanHeight</span>, <span class="hljs-attr">surfaceId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> };</li><li>              <span class="hljs-comment">// 启动相机进行扫码</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>            })</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanHeight</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanWidth</span>)</li><li>            .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span> })</li><li>      }</li><li>
</li><li>
</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>        }</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>
</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 闪光灯按钮，启动相机流后才能使用</span></li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'FlashLight'</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-attr">lightStatus</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>                <span class="hljs-keyword">try</span> {</li><li>                  lightStatus = customScan.<span class="hljs-title function_">getFlashLightStatus</span>();</li><li>                } <span class="hljs-keyword">catch</span> (error) {</li><li>                  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                    <span class="hljs-string">`Failed to get flashLightStatus. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                }</li><li>                <span class="hljs-comment">// 根据当前闪光灯状态，选择打开或关闭闪光灯</span></li><li>                <span class="hljs-keyword">if</span> (lightStatus) {</li><li>                  <span class="hljs-keyword">try</span> {</li><li>                    customScan.<span class="hljs-title function_">closeFlashLight</span>();</li><li>                  } <span class="hljs-keyword">catch</span> (error) {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                      <span class="hljs-string">`Failed to close flashLight. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  }</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-keyword">try</span> {</li><li>                    customScan.<span class="hljs-title function_">openFlashLight</span>();</li><li>                  } <span class="hljs-keyword">catch</span> (error) {</li><li>                    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>                      <span class="hljs-string">`Failed to open flashLight. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>                  }</li><li>                }</li><li>              })</li><li>              .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span>)</li><li>          }</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 预览流设置缩放比例</span></li><li>            <span class="hljs-title class_">Button</span>(<span class="hljs-string">'缩放比例,当前比例:'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span>)</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>              .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>              .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-comment">// 设置相机缩放比例</span></li><li>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span>) {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>                  } <span class="hljs-keyword">else</span> {</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span>;</li><li>                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customSetZoom</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span>);</li><li>                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">setZoomValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>                      }</li><li>                    }, <span class="hljs-number">1000</span>);</li><li>                  }</li><li>                }</li><li>              })</li><li>          }</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })</li><li>          .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span>)</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">// 输入要设置的预览流缩放比例</span></li><li>            <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'输入缩放倍数'</span> })</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>              .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">InputType</span>.<span class="hljs-property">Number</span>)</li><li>              .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)</li><li>              .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>              .<span class="hljs-title function_">onChange</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">zoomValue</span> = <span class="hljs-title class_">Number</span>(value);</li><li>              })</li><li>          }</li><li>          .<span class="hljs-title function_">visibility</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> ? <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">None</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-property">Visible</span>)</li><li>
</li><li>
</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> ? <span class="hljs-string">'继续扫码'</span> : <span class="hljs-string">'扫码中'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">30</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFrameResult</span> = <span class="hljs-string">''</span>;</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>              }</li><li>            })</li><li>          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'扫码结果：'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFrameResult</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanBottom</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">mainStyle</span>()</li><li>
</li><li>
</li><li>      <span class="hljs-title class_">Image</span>($rawfile(<span class="hljs-string">'scan_back.svg'</span>)) <span class="hljs-comment">// src/main/resources/rawfile/scan_back.svg</span></li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">position</span>({</li><li>          <span class="hljs-attr">x</span>: <span class="hljs-number">40</span>,</li><li>          <span class="hljs-attr">y</span>: <span class="hljs-number">40</span></li><li>        })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>();</li><li>        })</li><li>
</li><li>
</li><li>      <span class="hljs-comment">// 实时扫码码图中心点位置</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanCodeRect</span>, <span class="hljs-function">(<span class="hljs-params">item: scanBarcode.ScanCodeRect</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Image</span>($rawfile(<span class="hljs-string">'scan_selected2.svg'</span>)) <span class="hljs-comment">// src/main/resources/rawfile/scan_selected2.svg</span></li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>            .<span class="hljs-title function_">markAnchor</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">20</span> })</li><li>            .<span class="hljs-title function_">position</span>({</li><li>              <span class="hljs-attr">x</span>: (item.<span class="hljs-property">left</span> + item.<span class="hljs-property">right</span>) / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span>,</li><li>              <span class="hljs-attr">y</span>: (item.<span class="hljs-property">top</span> + item.<span class="hljs-property">bottom</span>) / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span></li><li>            })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: scanBarcode.ScanCodeRect</span>) =&gt;</span> <span class="hljs-string">''</span> + item.<span class="hljs-property">left</span> + item.<span class="hljs-property">right</span>)</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">userGrant</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// 是否已扫描到结果</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 点击屏幕位置，获取点击位置(x,y)，设置相机焦点</span></li><li>      <span class="hljs-keyword">let</span> x1 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">displayY</span>) / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayHeight</span> + <span class="hljs-number">0.0</span>);</li><li>      <span class="hljs-keyword">let</span> y1 = <span class="hljs-number">1.0</span> - (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(event.<span class="hljs-property">displayX</span>) / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">displayWidth</span> + <span class="hljs-number">0.0</span>));</li><li>      <span class="hljs-keyword">try</span> {</li><li>        customScan.<span class="hljs-title function_">setFocusPoint</span>({ <span class="hljs-attr">x</span>: x1, <span class="hljs-attr">y</span>: y1 });</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in setting focusPoint x1: <span class="hljs-subst">${x1}</span>, y1: <span class="hljs-subst">${y1}</span>`</span>);</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set focusPoint. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          customScan.<span class="hljs-title function_">resetFocus</span>();</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to reset focus. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        }</li><li>      }, <span class="hljs-number">200</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">gesture</span>(<span class="hljs-title class_">PinchGesture</span>({ <span class="hljs-attr">fingers</span>: <span class="hljs-number">2</span> })</li><li>      .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">(<span class="hljs-params">_: GestureEvent</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Pinch start'</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (event) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> = event.<span class="hljs-property">scale</span>;</li><li>        }</li><li>      })</li><li>      .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">(<span class="hljs-params">_: GestureEvent</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// 是否已扫描到结果</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scanFlag</span>) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 获取双指缩放比例，设置变焦比</span></li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">let</span> zoom = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customGetZoom</span>();</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pinchValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scaleValue</span> * zoom;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customSetZoom</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pinchValue</span>);</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Pinch end'</span>);</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>        }</li><li>      }))</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">customGetZoom</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> zoom = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      zoom = customScan.<span class="hljs-title function_">getZoom</span>();</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in getting zoom, zoom: <span class="hljs-subst">${zoom}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> zoom;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">customSetZoom</span>(<span class="hljs-attr">pinchValue</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      customScan.<span class="hljs-title function_">setZoom</span>(pinchValue);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in setting zoom.`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to set zoom. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div></li>       </ul></li>      <li>通过scanCodeRect数据可确定码图中心点的位置。       <ul>        <li>以设备竖屏、充电口向下为例，使用说明如下。         <ul>          <li>scanCodeRect的四个点坐标如下，可根据坐标点绘制码图外围矩形框           <ul>            <li>左上角(x, y)：(left, top)</li>           </ul>           <ul>            <li>右上角(x, y)：(right, top)</li>           </ul>           <ul>            <li>左下角(x, y)：(left, bottom)</li>           </ul>           <ul>            <li>右下角(x, y)：(right, bottom)</li>           </ul></li>          <li>由于码图中心点坐标需和XComponent的坐标保持一致，如果XComponent的x轴和y轴存在偏移，则码图位置需做相应的偏移。例如：x轴偏移量为：offsetX；y轴偏移量为：offsetY，中心点坐标最终转换为：           <ul>            <li>x = (left + right) / 2 + offsetX</li>           </ul>           <ul>            <li>y = (top + bottom) / 2 + offsetY</li>           </ul></li>         </ul></li>        <li>         <p>如果设备涉及旋转，码图中心点位置需要根据屏幕旋转角度(<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a>)进行变换，以保证在各旋转角度下码图中心位置正确。推荐参考<a href="https://gitcode.com/HarmonyOS_Samples/scan-kit_-sample-code_-clientdemo_-arkts" target="_blank">示例工程</a>。</p>         <p>例如：XComponent宽度为width，高度为height，x轴偏移量为offsetX，y轴偏移量为offsetY：</p>         <ul>          <li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> = 0时，中心点坐标为：           <ul>            <li>x = (left + right) / 2 + offsetX</li>            <li>y = (top + bottom) / 2 + offsetY</li>           </ul></li>          <li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> = 1时，中心点坐标为：           <ul>            <li>x = width - (top + bottom) / 2 + offsetX</li>            <li>y = (left + right) / 2 + offsetY</li>           </ul></li>          <li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> = 2时，中心点坐标为：           <ul>            <li>x = width - (left + right) / 2 + offsetX</li>            <li>y = height - (top + bottom) / 2 + offsetY</li>           </ul></li>          <li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> = 3时，中心点坐标为：           <ul>            <li>x = (top + bottom) / 2 + offsetX</li>            <li>y = height - (left + right) / 2+ offsetY</li>           </ul></li>         </ul></li>       </ul>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <div class="p">          从5.0.2(14)开始，由于屏幕Display对象rotation和orientation属性变更，设备旋转不同角度后码图的位置需要重新适配。          <ul>           <li>对于5.0.2(14)之前版本，可以使用Display对象中的rotation或者orientation属性处理设备旋转不同角度后的码图位置，且需要针对设备类型做特殊适配。</li>           <li>对于5.0.2(14)及之后版本，需要统一使用Display对象的rotation属性处理设备旋转不同角度后的码图位置，无需针对设备类型做特殊适配。</li>          </ul>         </div>        </div></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section8793479155">模拟器开发<i class="anchor-icon anchor-icon-link" anchorid="section8793479155" tips="复制节点链接"></i></h2>          <p>从6.0.0(20)版本开始，自定义界面扫码部分接口支持模拟器开发，支持情况参考说明，使用指导请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-run-emulator" target="_blank">使用模拟器运行应用</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ol>        <li>自定义界面扫码<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section447114223245" target="_blank">init</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section38711535114711" target="_blank">start</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section6949611114915" target="_blank">stop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section1109456134917" target="_blank">release</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/scan-customscan-api#section19244173211169" target="_blank">rescan</a>基础扫码能力接口支持在模拟器上使用，可基于上述接口完成自定义界面扫码基本功能验证。</li>        <li>模拟器场景下，自定义界面扫码仅支持1280*720分辨率，传入其他分辨率会统一转换成1280*720。</li>        <li>其他自定义界面扫码接口由于模拟器硬件原因暂不支持模拟器使用，调用会返回模拟器不支持。</li>       </ol>      </div></div></div>    </div>   </div>   <div></div></div>