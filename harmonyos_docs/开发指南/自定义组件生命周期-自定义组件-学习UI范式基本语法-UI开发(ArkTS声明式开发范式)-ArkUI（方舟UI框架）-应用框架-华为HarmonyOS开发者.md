<h1 _ngcontent-yqd-c119="" class="doc-title ng-star-inserted" title="自定义组件生命周期"> 自定义组件生命周期 </h1>

<div _ngcontent-yqd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>自定义组件生命周期，即用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-create-custom-components#component">@Component</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-componentv2">@ComponentV2</a>装饰的自定义组件的生命周期，提供以下生命周期接口：</p>    <ul>     <li>      <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttoappear" target="_blank">aboutToAppear</a>：组件即将出现时回调该接口，具体时机为在创建自定义组件的新实例后，在执行其build函数之前执行。</p></li>     <li>      <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#ondidbuild12" target="_blank">onDidBuild</a>：在组件首次渲染触发的build函数执行完成之后回调该接口，后续组件重新渲染将不回调该接口。开发者可以在这个阶段实现埋点数据上报等不影响实际UI的功能。</p></li>     <li>      <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttodisappear" target="_blank">aboutToDisappear</a>：aboutToDisappear函数在自定义组件析构销毁之前执行。不允许在aboutToDisappear函数中改变状态变量，特别是@Link变量的修改可能会导致应用程序行为不稳定。</p></li>    </ul>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>页面生命周期及其相关内容参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-routing#生命周期">页面路由</a>。</p>     </div></div></div>    <p>自定义组件生命周期流程如下图所示。</p>    <p><span><img originheight="467" originwidth="268" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114910.84153224044451531958858669063155:50001231000000:2800:6E0CC0BED14BFB1F275CB8BE77E4EFB6B530AD9109803A3C53447150D94A0E76.png" class="notEnlarge" width="268" height="467"></span></p>    <p>根据上面的流程图，接下来从自定义组件的初始创建、重新渲染和删除来详细说明。</p>    <div class="tiledSection">     <h2 id="自定义组件的创建和渲染流程">自定义组件的创建和渲染流程<i class="anchor-icon anchor-icon-link" anchorid="自定义组件的创建和渲染流程" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>自定义组件的创建：自定义组件的实例由ArkUI框架创建。</p></li>      <li>       <p>初始化自定义组件的成员变量：通过本地默认值或者构造方法传递参数来初始化自定义组件的成员变量，初始化顺序为成员变量的定义顺序。</p></li>      <li>       <p>如果开发者定义了aboutToAppear，则执行build方法之前执行该方法。</p></li>      <li>       <p>在首次渲染的时候，执行build方法渲染系统组件，如果子组件为自定义组件，则创建自定义组件的实例。在首次渲染的过程中，框架会记录状态变量和组件的映射关系，当状态变量改变时，驱动其相关的组件刷新。</p></li>      <li>       <p>如果开发者定义了onDidBuild，则执行build方法之后执行该方法。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="自定义组件重新渲染">自定义组件重新渲染<i class="anchor-icon anchor-icon-link" anchorid="自定义组件重新渲染" tips="复制节点链接"></i></h2>          <p>当触发事件（比如点击）改变状态变量时，或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage">LocalStorage</a> / <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage">AppStorage</a>中的属性更改，并导致绑定的状态变量更改其值时：</p>     <ol>      <li>       <p>框架观察到变化，启动重新渲染。</p></li>      <li>       <p>根据框架记录的状态变量和组件的映射关系，仅刷新发生变化的状态变量所关联的组件，实现最小化更新。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="自定义组件的删除">自定义组件的删除<i class="anchor-icon anchor-icon-link" anchorid="自定义组件的删除" tips="复制节点链接"></i></h2>          <p>例如if组件的分支改变或ForEach循环渲染中数组的个数改变，组件将被移除：</p>     <ol>      <li>       <p>在删除组件之前，将调用其aboutToDisappear生命周期函数，标记着该节点将要被销毁。ArkUI的节点删除机制是：后端节点直接从组件树上摘下，后端节点被销毁，对前端节点解引用，前端节点已经没有引用时，将被Ark虚拟机垃圾回收。</p></li>      <li>       <p>自定义组件和它的变量将被删除，如果组件有同步的变量（如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link">@Link</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop">@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storagelink">@StorageLink</a>），将从<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state-management-overview#基本概念">同步源</a>上取消注册。</p></li>     </ol>     <p>不建议在生命周期aboutToDisappear中使用async await。如果在此生命周期中使用异步操作（如 Promise 或回调方法），自定义组件将被保留在Promise的闭包中，直到回调方法执行完毕，这会阻止自定义组件的垃圾回收。</p>    </div>    <div class="tiledSection">     <h2 id="自定义组件嵌套使用与示例">自定义组件嵌套使用与示例<i class="anchor-icon anchor-icon-link" anchorid="自定义组件嵌套使用与示例" tips="复制节点链接"></i></h2>          <p>通过以下示例，来详细说明自定义组件在嵌套使用时，自定义组件生命周期的调用时序：</p>     <div _ngcontent-yqd-c106="" class="highlight-div"><div _ngcontent-yqd-c106="" class="highlight-div-header"><div _ngcontent-yqd-c106="" class="highlight-div-header-left"><div _ngcontent-yqd-c106="" class="handle-button expand-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yqd-c106="" class="highlight-div-header-right"><div _ngcontent-yqd-c106="" class="handle-button ai-button"></div><div _ngcontent-yqd-c106="" class="handle-button line-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yqd-c106="" class="handle-button theme-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yqd-c106="" class="handle-button copy-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Parent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">showChild</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">btnColor</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'#FF007DFF'</span>;</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Parent aboutToAppear'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">onDidBuild</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Parent onDidBuild'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Parent aboutToDisappear'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// this.showChild为true，创建Child子组件，执行Child aboutToAppear</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">showChild</span>) {</li><li>        <span class="hljs-title class_">Child</span>()</li><li>      }</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'delete Child'</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">btnColor</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// 更改this.showChild为false，删除Child子组件，执行Child aboutToDisappear</span></li><li>          <span class="hljs-comment">// 更改this.showChild为true，添加Child子组件，执行Child aboutToAppear</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">showChild</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">showChild</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Child</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Child aboutToDisappear'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">onDidBuild</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Child onDidBuild'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 组件生命周期</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Child aboutToAppear'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = <span class="hljs-string">'Hello ArkUI'</span>;</li><li>      })</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>以上示例中，Index页面包含两个自定义组件，一个是Parent，一个是Child，Parent及其子组件Child分别声明了各自的自定义组件生命周期函数（aboutToAppear / onDidBuild / aboutToDisappear）。</p>     <ul>      <li>应用冷启动的初始化流程为：Parent aboutToAppear --&gt; Parent build --&gt; Parent onDidBuild --&gt; Child aboutToAppear --&gt; Child build --&gt; Child onDidBuild。此处体现了自定义组件懒展开特性，即Parent执行完onDidBuild之后才会执行Child组件的aboutToAppear。日志输出信息如下：</li>     </ul>     <div _ngcontent-yqd-c106="" class="highlight-div"><div _ngcontent-yqd-c106="" class="highlight-div-header"><div _ngcontent-yqd-c106="" class="highlight-div-header-left"><div _ngcontent-yqd-c106="" class="handle-button expand-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yqd-c106="" class="highlight-div-header-right"><div _ngcontent-yqd-c106="" class="handle-button ai-button"></div><div _ngcontent-yqd-c106="" class="handle-button line-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yqd-c106="" class="handle-button theme-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yqd-c106="" class="handle-button copy-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Parent</span> aboutToAppear</li><li><span class="hljs-title class_">Parent</span> onDidBuild</li><li><span class="hljs-title class_">Child</span> aboutToAppear</li><li><span class="hljs-title class_">Child</span> onDidBuild</li></ol></pre></div></div>     <ul>      <li>       <p>点击Button按钮，更改showChild为false，删除Child组件，执行Child aboutToDisappear方法。</p></li>      <li>       <p>如果直接退出应用，则会触发以下生命周期：Parent aboutToDisappear --&gt; Child aboutToDisappear，此处体现了自定义组件删除顺序也是从父到子。日志输出信息如下：</p></li>     </ul>     <div _ngcontent-yqd-c106="" class="highlight-div"><div _ngcontent-yqd-c106="" class="highlight-div-header"><div _ngcontent-yqd-c106="" class="highlight-div-header-left"><div _ngcontent-yqd-c106="" class="handle-button expand-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yqd-c106="" class="highlight-div-header-right"><div _ngcontent-yqd-c106="" class="handle-button ai-button"></div><div _ngcontent-yqd-c106="" class="handle-button line-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yqd-c106="" class="handle-button theme-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yqd-c106="" class="handle-button copy-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Parent</span> aboutToDisappear</li><li><span class="hljs-title class_">Child</span> aboutToDisappear</li></ol></pre></div></div>     <ul>      <li>       <p>最小化应用或者应用进入后台，当前Index页面未被销毁，所以并不会执行组件的aboutToDisappear。</p></li>      <li>       <p>如果showChild的默认值为false，则应用冷启动的初始化流程为：Parent aboutToAppear --&gt; Parent build --&gt; Parent onDidBuild。日志输出信息如下：</p></li>     </ul>     <div _ngcontent-yqd-c106="" class="highlight-div"><div _ngcontent-yqd-c106="" class="highlight-div-header"><div _ngcontent-yqd-c106="" class="highlight-div-header-left"><div _ngcontent-yqd-c106="" class="handle-button expand-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yqd-c106="" class="highlight-div-header-right"><div _ngcontent-yqd-c106="" class="handle-button ai-button"></div><div _ngcontent-yqd-c106="" class="handle-button line-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yqd-c106="" class="handle-button theme-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yqd-c106="" class="handle-button copy-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Parent</span> aboutToAppear</li><li><span class="hljs-title class_">Parent</span> onDidBuild</li></ol></pre></div></div>     <ul>      <li>       <p>如果showChild的默认值为false，直接退出应用，则只执行Parent aboutToDisappear方法。</p></li>      <li>       <p>如果showChild的默认值为false，此时点击Button按钮，更改showChild为true，添加Child组件，添加流程为：Child aboutToAppear --&gt; Child build --&gt; Child onDidBuild。日志输出信息如下：</p></li>     </ul>     <div _ngcontent-yqd-c106="" class="highlight-div"><div _ngcontent-yqd-c106="" class="highlight-div-header"><div _ngcontent-yqd-c106="" class="highlight-div-header-left"><div _ngcontent-yqd-c106="" class="handle-button expand-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yqd-c106="" class="highlight-div-header-right"><div _ngcontent-yqd-c106="" class="handle-button ai-button"></div><div _ngcontent-yqd-c106="" class="handle-button line-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yqd-c106="" class="handle-button theme-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yqd-c106="" class="handle-button copy-button"><div _ngcontent-yqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yqd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Child</span> aboutToAppear</li><li><span class="hljs-title class_">Child</span> onDidBuild</li></ol></pre></div></div>     <p>当showChild为默认值true时，该示例的生命周期流程图如下所示：</p>     <p><span><img originheight="941" originwidth="269" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114910.04160764907910917393413025203126:50001231000000:2800:C17619629E6024262B89843FAD43F720AB19FC883CDFD4936B6DB8E76F700775.png" class="notEnlarge" width="269" height="941"></span></p>    </div>   </div>   <div></div></div>