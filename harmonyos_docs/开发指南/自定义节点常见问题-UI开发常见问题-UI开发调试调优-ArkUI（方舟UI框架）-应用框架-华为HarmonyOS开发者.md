<h1 _ngcontent-mla-c119="" class="doc-title ng-star-inserted" title="自定义节点常见问题"> 自定义节点常见问题 </h1>

<div _ngcontent-mla-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>本文档介绍自定义节点的常见问题并提供参考。</p>    <div class="tiledSection">     <h2 id="自定义组件的abouttodisappear回调异常">自定义组件的aboutToDisappear回调异常<i class="anchor-icon anchor-icon-link" anchorid="自定义组件的abouttodisappear回调异常" tips="复制节点链接"></i></h2>          <p><strong>问题现象</strong></p>     <p>从API version 12开始，自定义节点的子节点在页面退出后未立即回调自定义组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttodisappear" target="_blank">aboutToDisappear</a>方法。自定义组件的aboutToDisappear通常在其销毁的时候触发，页面销毁后未立即回调则说明该自定义组件在页面销毁后未立即销毁。</p>     <p><strong>可能原因</strong></p>     <ul>      <li>自定义组件存在父节点且父节点未销毁。</li>      <li>自定义组件由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode">BuilderNode</a>创建，该前端对象既未被回收，也未解除对后端自定义组件的引用。BuilderNode创建时，默认持有后端节点的强引用。</li>      <li>通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-node-napi-h#oh_arkui_getnodehandlefromnapivalue" target="_blank">OH_ArkUI_GetNodeHandleFromNapiValue</a>方法，可以获取BuilderNode或ComponentContent对象中的root节点，此操作会使后端节点的引用计数加一。</li>      <li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent" target="_blank">NodeContent</a>中，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent#addframenode12" target="_blank">addFrameNode</a>方法增加了对被添加的FrameNode对象节点的引用关系。然而，该NodeContent对象未被回收，且未通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontent#removeframenode12" target="_blank">removeFrameNode</a>接口删除所增加的引用关系。</li>     </ul>     <p><strong>解决措施</strong></p>     <ul>      <li>将需要释放的自定义组件从父节点上移除，排除父节点对自定义组件生命周期的影响。</li>      <li>自定义组件由<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode">BuilderNode</a>创建时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#dispose12" target="_blank">dispose</a>接口，立即释放前端BuilderNode对象对于后端节点的强引用。</li>      <li>       <p>对于使用OH_ArkUI_GetNodeHandleFromNapiValue获取BuilderNode或ComponentContent对象的root节点，</p>       <p>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-arkui-nativemodule-arkui-nativenodeapi-1#disposenode" target="_blank">disposenode</a>减少OH_ArkUI_GetNodeHandleFromNapiValue增加的引用计数。</p></li>      <li>未调用dispose时，当前端的BuilderNode对象在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/gc-introduction">GC</a>中被回收会释放对后端根节点的引用。调试阶段可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hidumper">hidumper</a>指令触发GC或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hidumper#查询虚拟机堆内存">查询堆内存</a>来分析引用关系。</li>     </ul>     <p><strong>示例代码</strong></p>     <p>下文中，根节点表示BuilderNode的根节点，aboutToDisappear表示BuilderNode中构建的自定义组件（即BuilderNodePage）中的回调。</p>     <ul>      <li>       <p>跳转至pageOneTmp页面后返回，通过指令触发GC，继续操作设备后可以看到aboutToDisappear回调。根节点相关的引用关系和解决方案：</p>       <ul>        <li>NodeContent对根节点的引用关系：需要触发NodeContent对象的回收，或主动调用removeFrameNode接口。</li>        <li>全局对象对BuilderNode的引用关系：通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arraylist" target="_blank">ArrayList</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arraylist#clear" target="_blank">clear</a>方法清除对BuilderNode的引用。</li>        <li>BuilderNode对象对根节点的引用关系：确保BuilderNode对象无其他引用关系，触发该对象的回收可以解除其对根节点的引用。</li>       </ul></li>      <li>       <p>跳转至pageTwoTmp页面后返回，可以直接看到aboutToDisappear回调。根节点相关的引用关系以及解决方案：</p>       <ul>        <li>NodeContent对根节点的引用关系：通过NodeContent的removeFrameNode接口解除引用关系。</li>        <li>BuilderNode对象对根节点的引用关系：通过BuilderNode的dispose接口直接解除引用关系。</li>       </ul></li>      <li>       <p>跳转至pageThreeTmp页面后返回，可以直接看到aboutToDisappear回调。根节点相关的引用关系以及解决方案：</p>       <ul>        <li>根节点的父节点对其的引用关系：由于父节点为FrameNode对象对应的节点，可以直接通过FrameNode的removeChild方法解除引用关系。</li>        <li>BuilderNode对象对根节点的引用关系：通过BuilderNode的dispose接口直接解除引用关系。</li>       </ul></li>     </ul>     <div _ngcontent-mla-c106="" class="highlight-div"><div _ngcontent-mla-c106="" class="highlight-div-header"><div _ngcontent-mla-c106="" class="highlight-div-header-left"><div _ngcontent-mla-c106="" class="handle-button expand-button"><div _ngcontent-mla-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mla-c106="" class="highlight-div-header-right"><div _ngcontent-mla-c106="" class="handle-button ai-button"></div><div _ngcontent-mla-c106="" class="handle-button line-button"><div _ngcontent-mla-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mla-c106="" class="handle-button theme-button"><div _ngcontent-mla-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mla-c106="" class="handle-button copy-button"><div _ngcontent-mla-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mla-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrayList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">CUSTOM_COMPONENT_CONT</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"CustomComponentCont"</span></li><li><span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">globalBuilderNodeList</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-title class_">BuilderNode</span>&lt;[]&gt;&gt;();</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">BuilderNodePage</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span> = count ? count + <span class="hljs-number">1</span> : <span class="hljs-number">1</span>;</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>, current);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"BuilderNodePage"</span>, <span class="hljs-string">"aboutToAppear "</span> + <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>))</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"BuilderNodePage"</span>, <span class="hljs-string">"aboutToDisappear "</span> + count)</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span> = count ? count - <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;</li><li>      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">set</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>, current)</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"BuilderNodePage"</span>, <span class="hljs-string">"aboutToDisappear "</span> + <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>))</li><li>    }, <span class="hljs-number">1</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Text</span>(<span class="hljs-string">"This is a BuilderNode"</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">BuilderNodeBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">BuilderNodePage</span>();</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">NavigationExample</span> {</li><li>  <span class="hljs-meta">@Provide</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NavPathStack</span>()</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];</li><li>  <span class="hljs-meta">@StorageProp</span>(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>) <span class="hljs-attr">customComponentCount</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> =</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-variable constant_">CUSTOM_COMPONENT_CONT</span>);</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title function_">pageMap</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"NavDestinationTitle1"</span>) {</li><li>      <span class="hljs-title function_">pageOneTmp</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"NavDestinationTitle2"</span>) {</li><li>      <span class="hljs-title function_">pageTwoTmp</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"NavDestinationTitle3"</span>) {</li><li>      <span class="hljs-title function_">pageThreeTmp</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"NavigationExample "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">customComponentCount</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>) {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"BuilderNode中自定义组件的遗留数量 "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">customComponentCount</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"90%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFFFFF'</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">"移除全局引用"</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// 清除所有全局引用。</span></li><li>            <span class="hljs-comment">// 可以使用hidumper指令触发GC验证引用关系是否清零。</span></li><li>            globalBuilderNodeList.<span class="hljs-title function_">clear</span>();</li><li>          })</li><li>        <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">ListItem</span>() {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Page"</span> + item)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-number">72</span>)</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFFFFF'</span>)</li><li>                .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">24</span>)</li><li>                .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>                .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>                .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)</li><li>                .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"NavDestinationTitle"</span> + item });</li><li>                })</li><li>            }</li><li>          }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">12</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">title</span>(<span class="hljs-string">"主标题"</span>)</li><li>      .<span class="hljs-title function_">mode</span>(<span class="hljs-title class_">NavigationMode</span>.<span class="hljs-property">Stack</span>)</li><li>      .<span class="hljs-title function_">navDestination</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageMap</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct pageOneTmp {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">content</span>: <span class="hljs-title class_">NodeContent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageOneTmp"</span>, <span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">BuilderNodeBuilder</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>()) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>.<span class="hljs-title function_">addFrameNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>    }</li><li>    <span class="hljs-comment">// 添加全局引用，该对象在全局引用移除前无法被GC。</span></li><li>    globalBuilderNodeList.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageOneTmp"</span>, <span class="hljs-string">"aboutToDisappear"</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"pageOneTmp"</span>)</li><li>        <span class="hljs-title class_">ContentSlot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">"NavDestinationTitle1"</span>)</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> popDestinationInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 弹出路由栈栈顶元素。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pop'</span> + <span class="hljs-string">'返回值'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(popDestinationInfo));</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct pageTwoTmp {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">content</span>: <span class="hljs-title class_">NodeContent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageTwoTmp"</span>, <span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>!.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">BuilderNodeBuilder</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>!.<span class="hljs-title function_">getFrameNode</span>()) {</li><li>      <span class="hljs-comment">// 将BuilderNode的根节点挂载至NodeContent对象中。</span></li><li>      <span class="hljs-comment">// 如果要触发builderNode的根节点的析构，需要主动从NodeContent对象中移除该节点，或者等待NodeContent对象被GC。</span></li><li>      <span class="hljs-comment">// 否则，BuilderNode的根节点无法触发析构。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>.<span class="hljs-title function_">addFrameNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>!.<span class="hljs-title function_">getFrameNode</span>());</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageTwoTmp"</span>, <span class="hljs-string">"aboutToDisappear"</span>)</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">getFrameNode</span>()) {</li><li>      <span class="hljs-comment">// 将BuilderNode的根节点从NodeContent对象中移除。</span></li><li>      <span class="hljs-comment">// 需要在BuilderNode的dispose操作之前执行，否则无法获得该BuilderNode的根节点。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>.<span class="hljs-title function_">removeFrameNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">getFrameNode</span>());</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">dispose</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"pageTwoTmp"</span>)</li><li>        <span class="hljs-title class_">ContentSlot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">"NavDestinationTitle2"</span>)</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> popDestinationInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 弹出路由栈栈顶元素。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pop'</span> + <span class="hljs-string">'返回值'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(popDestinationInfo));</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct pageThreeTmp {</li><li>  <span class="hljs-meta">@Consume</span>(<span class="hljs-string">'pageInfos'</span>) <span class="hljs-attr">pageInfos</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">builderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">content</span>: <span class="hljs-title class_">NodeContent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeContent</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>());</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageThreeTmp"</span>, <span class="hljs-string">"aboutToAppear"</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>!.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">BuilderNodeBuilder</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>!.<span class="hljs-title function_">getFrameNode</span>()) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>.<span class="hljs-title function_">addFrameNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>);</li><li>      <span class="hljs-comment">// BuilderNode的根节点被挂载至FrameNode对象对应的节点中。</span></li><li>      <span class="hljs-comment">// BuilderNode的根节点如果要触发析构需要从主动从FrameNode对象对应的节点中移除，或者等待FrameNode对象对应的节点析构。</span></li><li>      <span class="hljs-comment">// 否则，BuilderNode的根节点无法触发析构。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>.<span class="hljs-title function_">getFrameNode</span>());</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"pageThreeTmp"</span>, <span class="hljs-string">"aboutToDisappear"</span>)</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">getFrameNode</span>()) {</li><li>      <span class="hljs-comment">// 将BuilderNode的根节点从FrameNode对象对应的节点中移除。</span></li><li>      <span class="hljs-comment">// 需要在BuilderNode的dispose操作以及FrameNode对象dispose之前执行，否则无法获得他们对应的节点。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">getFrameNode</span>());</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">builderNode</span>?.<span class="hljs-title function_">dispose</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">"pageThreeTmp"</span>)</li><li>        <span class="hljs-title class_">ContentSlot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">title</span>(<span class="hljs-string">"NavDestinationTitle3"</span>)</li><li>    .<span class="hljs-title function_">onBackPressed</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> popDestinationInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 弹出路由栈栈顶元素。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pop'</span> + <span class="hljs-string">'返回值'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(popDestinationInfo));</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>