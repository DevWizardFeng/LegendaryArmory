<h1 _ngcontent-gsp-c119="" class="doc-title ng-star-inserted" title="自定义认证插件配置"> 自定义认证插件配置 </h1>

<div _ngcontent-gsp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div id="body0000001831853526"><p id="ZH-CN_TOPIC_0000002478173734__p8060118">ohpm-repo从2.3.0版本开始支持自定义认证插件（需配套使用1.8.0及以上版本ohpm命令行工具），允许您使用AccessToken认证，开发定制化的认证插件来对接开发者自己的用户信息系统。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p id="ZH-CN_TOPIC_0000002478173734__p563041585218">当您使用自定义认证插件对接自己的用户系统时，如果存在网络通信，建议使用https协议，确保信息安全传输。</p> </div></div></div> <div class="tiledSection"><h2 id="section1294845133311">准备工作<i class="anchor-icon anchor-icon-link" anchorid="section1294845133311" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478173734__ol666325179192207"><li id="li846616424192207">下载ohpm-repo私仓工具安装包并解压。</li><li id="li16773142554612">进入ohpm-repo解压根目录，把模板文件中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-custom-auth-plugin-template#section14188258114612">tsconfig.json 文件</a>移动到ohpm-repo解压根目录。</li><li id="li1657201278192207">建议将模板文件中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-custom-auth-plugin-template#section14072085013">CustomAuth.ts</a>文件存入ohpm-repo解压根目录的plugins文件夹内。</li></ol> </div> <div class="tiledSection"><h2 id="section32544215215">编辑CustomAuth.ts文件，实现认证插件接口AuthPlugin<i class="anchor-icon anchor-icon-link" anchorid="section32544215215" tips="复制节点链接"></i></h2><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p id="ZH-CN_TOPIC_0000002478173734__p18279152411620">打开CustomAuth.ts模板文件，需要编写代码实现接口类AuthPlugin，实现auth和getUserInfo两个基础方法，实现类CustomAuth的名字可自定义修改。</p> </div></div></div> <p id="ZH-CN_TOPIC_0000002478173734__p164511561764">接口类AuthPlugin中包含如下三个方法，需要在实现类中完成功能的实现。</p> <div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478173734__screen1989488216" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 插件文件的接口类定义如下</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthPlugin</span> {</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 用户信息获取:根据读写accessToken的值，返回用户的数据:用户的id，用户的名字，用户所属的组织，用户所创建的组织</span></li><li><span class="hljs-comment">   * @param accessToken 用户的读写accessToken</span></li><li><span class="hljs-comment">   * @returns</span></li><li><span class="hljs-comment">   * id：用户的id，保证唯一性</span></li><li><span class="hljs-comment">   * name：用户的名字，保证唯一性</span></li><li><span class="hljs-comment">   * belongGroupList：用户所在的组织，具有发指定组织包的权限</span></li><li><span class="hljs-comment">   * groupAdminList： 用户所管理的组织，具有删除组织内包的权限</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">auth</span>(<span class="hljs-variable">accessToken</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;{</li><li>    <span class="hljs-title class_">id</span>: <span class="hljs-title class_">string</span>;</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>;</li><li>    <span class="hljs-variable">belongGroupList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>    <span class="hljs-variable">groupAdminList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>  }&gt;;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 用户信息获取:根据只读accessToken的值，返回用户的数据:用户的id，用户的名字，用户所属的组织，用户所创建的组织</span></li><li><span class="hljs-comment">   * @param accessToken 用户的只读accessToken</span></li><li><span class="hljs-comment">   * @returns</span></li><li><span class="hljs-comment">   * id：用户的id，保证唯一性</span></li><li><span class="hljs-comment">   * name：用户的名字，保证唯一性</span></li><li><span class="hljs-comment">   * belongGroupList：用户所在的组织，具有发指定组织包的权限</span></li><li><span class="hljs-comment">   * groupAdminList： 用户所管理的组织，具有删除组织内包的权限</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">authWithReadOnly</span>(<span class="hljs-variable">accessToken</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;{</li><li>    <span class="hljs-title class_">id</span>: <span class="hljs-title class_">string</span>;</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>;</li><li>    <span class="hljs-variable">belongGroupList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>    <span class="hljs-variable">groupAdminList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>  }&gt;;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 根据用户id,返回用户的名字</span></li><li><span class="hljs-comment">   * @param id 用户的id值</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>}</li></ol></pre></div></div> <ol id="ZH-CN_TOPIC_0000002478173734__ol24981152385"><li id="li34989521483">auth<p id="ZH-CN_TOPIC_0000002478173734__p1549845210815">通过读写AccessToken获取对应用户信息，函数的入参为读写AccessToken值，返回值有四个参数：用户的id值，用户的name值，用户所属于的组织列表belongGroupList，用户所管理的组织列表groupAdminList。</p> </li><li id="li188635211177">authWithReadOnly(5.0.5版本新增)<p id="ZH-CN_TOPIC_0000002478173734__p19263141810178">通过只读AccessToken获取对应用户信息，函数的入参为只读AccessToken值，返回值有四个参数：用户的id值，用户的name值，用户所属于的组织列表belongGroupList，用户所管理的组织列表groupAdminList。当ohpm-repo配置不支持匿名访问时，ohpm可以通过配置只读AccessToken值，获取执行install,info和update命令的权限。</p> </li><li id="li124981252786">getUserInfo<p id="ZH-CN_TOPIC_0000002478173734__p149817523810">实现根据用户id获取用户名字的功能。函数入参为用户的id值；返回值为用户的名字。</p> </li></ol> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ol id="ZH-CN_TOPIC_0000002478173734__ol87694260416"><li id="li147471242182017">AccessToken分两种权限等级：只读AccessToken允许ohpm命令行执行info，install和update操作，只需要ohpm-repo读权限；读写AccessToken除了包含只读权限外，还支持执行publish，unpublish和dist-tags相关操作，需要ohpm-repo读写权限。</li><li id="li1843414222118">如果ohpm-repo支持匿名访问，ohpm执行info，install和update等读操作命令，不需要配置AccessToken值；当ohpm-repo配置不支持匿名访问时，必须配置只读/读写AccessToken，才能获得执行info，install和update命令权限。</li><li id="li5770162617413">在实现上述三个函数时，插件文件CustomAuth.ts需要引用AuthPlugin接口类，故需要根据当前插件文件CustomAuth.ts所在位置，正确地编写AuthPlugin接口类的引用地址，被引用接口类所在文件的地址如下：<ul id="ZH-CN_TOPIC_0000002478173734__ul1991153331720"><li id="li1529619551177">AuthPlugin接口类所在文件的位置：ohpm-repo解压根目录/libs/plugins/auth/AuthPlugin</li></ul> </li><li id="li56041302412">如果插件文件CustomAuth.ts存储在默认位置（ohpm-repo解压根目录中plugins文件夹内），插件文件CustomAuth.ts中默认AuthPlugin接口类引用地址如下：<ul id="ZH-CN_TOPIC_0000002478173734__ul131913555367"><li id="li5748132441317">import {AuthPlugin} from '../libs/plugins/auth/AuthPlugin';</li></ul> </li></ol> </div></div></div> </div> <div class="tiledSection"><h2 id="section1465331810148">插件文件的使用和ohpm-repo的启动<i class="anchor-icon anchor-icon-link" anchorid="section1465331810148" tips="复制节点链接"></i></h2><ol id="ZH-CN_TOPIC_0000002478173734__ol14349993113"><li id="li203497918117"><span>安装必要的npm包。安装typescript和@types/node包，编译ts文件为js文件。</span><p></p><div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478173734__screen13287123961417" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">$ </span>npm i typescript</li><li><span class="hljs-variable">$ </span>npm i <span class="hljs-variable">@types</span>/node</li></ol></pre></div></div> <p></p></li><li id="li1634939618"><span id="ZH-CN_TOPIC_0000002478173734__p73491694114">编译插件文件。</span><p></p><ul id="ZH-CN_TOPIC_0000002478173734__ul590304761192207"><li id="li1171348702192207">如果CustomAuth.ts存放在ohpm-repo解压根目录的plugins文件夹中，在ohpm-repo解压根目录下执行编译命令。<div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478173734__screen700581150192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">$ </span>tsc </li></ol></pre></div></div> </li><li id="li1507656819192207">命令成功执行后会在ohpm-repo解压根目录的plugins/outDir文件夹中生成编译后的文件CustomAuth.js。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p id="ZH-CN_TOPIC_0000002478173734__p999105693020">如果CustomAuth.ts没有存放在ohpm-repo解压根目录的plugins内，请先修改<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-custom-auth-plugin-template#section14188258114612">tsconfig.json 文件</a>中include和outDir参数，前者指定待编译插件代码的存储目录，后者指定编译完成后文件的输出位置，然后再在ohpm-repo解压根目录执行编译命令tsc。</p> <div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478173734__screen714874842192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// tsconfig.json 文件中的默认配置</span></li><li><span class="hljs-comment">// 默认值：插件存放在 ./plugins 中，编译后的文件存放在./plugins/outDir中</span></li><li><span class="hljs-string">"include"</span>: <span class="hljs-string">"plugins/*"</span>          <span class="hljs-comment">// 插件文件的位置</span></li><li><span class="hljs-string">"outDir"</span>: <span class="hljs-string">"./plugins/outDir"</span>    <span class="hljs-comment">// 编译后文件的存放位置</span></li></ol></pre></div></div> </div></div></div> </li></ul> <p></p></li><li id="li5349791118"><span id="ZH-CN_TOPIC_0000002478173734__p934910918110">编译后文件存放指定位置。</span><p></p><p id="ZH-CN_TOPIC_0000002478173734__p1836401416192207">编译后获得的CustomAuth.js需要与CustomAuth.ts 保持在同一级目录中，否则会编译出错，默认输出在./plugins/outDir内，需要把CustomAuth.js拷贝到CustomAuth.ts同级目录./plugins中（ohpm-repo成功启动后可删除CustomAuth.ts文件）。</p> <p></p></li><li id="li1634911910119"><span id="ZH-CN_TOPIC_0000002478173734__p1349191215">编辑配置文件。为了保证ohpm-repo能够正确加载自定义认证插件，需要修改配置文件config.yaml中auth_plugin配置项(配置文件默认没有配置auth_plugin参数)。</span><p></p><div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" id="ZH-CN_TOPIC_0000002478173734__screen1651252936192207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置文件中 auth_plugin 项的格式参考 </span></li><li><span class="hljs-variable">auth_plugin</span>: </li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">CustomAuth</span>              </li><li>  <span class="hljs-variable">path</span>: <span class="hljs-title class_">plugins</span>/<span class="hljs-variable">CustomAuth</span>.<span class="hljs-variable">js</span>   </li></ol></pre></div></div> <p id="ZH-CN_TOPIC_0000002478173734__p179353318192207">参数说明：</p> <ul id="ZH-CN_TOPIC_0000002478173734__ul1976588121910"><li id="li776508141911">name: 插件名称，自定义插件文件CustomAuth.js中定义的实现类名称，如果实现类为CustomAuth，故此处name值为：CustomAuth 。</li><li id="li37652871917">path: 编译后插件文件CustomAuth.js的存储位置。支持绝对路径和相对路径，相对路径的基准为ohpm-repo解压根目录。</li></ul> <p></p></li><li id="li1034915911118"><span id="ZH-CN_TOPIC_0000002478173734__p1234917915111">ohpm-repo服务部署。在完成上述操作之后，按照ohpm-repo<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpm-deploy-guide">部署指导</a>，完成服务部署。</span></li><li id="li15349149813"><span>使用自定义认证插件进行包的发布和下架等操作。</span><p></p><p id="ZH-CN_TOPIC_0000002478173734__p9740845794">当ohpm-repo成功启动后，在ohpm客户端的配置文件.ohpmrc中新增一行（//是有效字符，不是注释，勿删）。</p> <ul id="ZH-CN_TOPIC_0000002478173734__ul18683114713716"><li id="li146831747183719">通过authWithReadOnly认证：配置只读AccessToken，ohpm能够执行info，install和update命令，这三个命令需要读取ohpm-repo数据权限。<div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478173734__screen1133313343388" data-highlighted="yes"><ol class="linenums"><li> /<span class="hljs-regexp">/&lt;ip&gt;:&lt;port&gt;/repos</span><span class="hljs-regexp">/ohpm/</span><span class="hljs-symbol">:_read_auth=&lt;readOnlyToken&gt;</span></li></ol></pre></div></div> </li><li id="li1887315143817">通过auth认证：配置读写AccessToken，ohpm除了能够执行需要ohpm-repo读权限的info，install和update命令，还能够执行publish，unpublish和dist-tags等需要读写权限命令。<div _ngcontent-gsp-c106="" class="highlight-div"><div _ngcontent-gsp-c106="" class="highlight-div-header"><div _ngcontent-gsp-c106="" class="highlight-div-header-left"><div _ngcontent-gsp-c106="" class="handle-button expand-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gsp-c106="" class="highlight-div-header-right"><div _ngcontent-gsp-c106="" class="handle-button ai-button"></div><div _ngcontent-gsp-c106="" class="handle-button line-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gsp-c106="" class="handle-button theme-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gsp-c106="" class="handle-button copy-button"><div _ngcontent-gsp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gsp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ruby" id="ZH-CN_TOPIC_0000002478173734__screen0529185623815" data-highlighted="yes"><ol class="linenums"><li>/<span class="hljs-regexp">/&lt;ip&gt;:&lt;port&gt;/repos</span><span class="hljs-regexp">/ohpm/</span><span class="hljs-symbol">:_auth=&lt;readWriteToken&gt;</span></li></ol></pre></div></div> </li></ul> <p id="ZH-CN_TOPIC_0000002478173734__p116647431891">其中ip和port为ohpm-repo私仓启动机器所在的ip值和端口值；readOnlyToken/readWriteToken为用户信息系统内有效的只读/读写accessToken值，通过该accessToken值，用户调用自定义认证插件CustomAuth中auth和authWithReadOnly方法，能够获取到有效的用户信息。</p> <p></p></li></ol> </div> </div> <div></div></div>