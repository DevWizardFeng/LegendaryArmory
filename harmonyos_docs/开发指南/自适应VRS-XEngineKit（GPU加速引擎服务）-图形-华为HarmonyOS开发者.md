<h1 _ngcontent-xnt-c119="" class="doc-title ng-star-inserted" title="自适应VRS"> 自适应VRS </h1>

<div _ngcontent-xnt-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>XEngine Kit提供自适应VRS功能，其通过合理分配画面的计算资源，视觉无损降低渲染频次，使不同的渲染图像使用不同的渲染速率，能够有效提高渲染性能。</p> <div class="tiledSection"><h2 id="section624112515458">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section624112515458" tips="复制节点链接"></i></h2><ul><li>支持的设备类型：Phone，从5.0.2(14)版本开始，新增支持Tablet、PC/2in1设备，从5.1.0(18)版本开始新增支持TV设备。</li><li>可通过以下方式查询相关扩展特性是否支持：<p>对于OpenGL ES，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga76f9695fa41c6664e949cdba586699c0" target="_blank">HMS_XEG_GetString</a>'扩展特性查询接口进行查询，如查询结果包含<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga4a9a55586368519629571dd2ba204a95" target="_blank">XEG_ADAPTIVE_VRS_EXTENSION_NAME</a>，则表示支持该特性，若查询结果未包含，则表示不支持该特性。</p> </li></ul> </div> <div class="tiledSection"><h2 id="section1890013261807">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1890013261807" tips="复制节点链接"></i></h2><p>以下接口为自适应VRS设置接口，如需使用更丰富的设置和查询接口，具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine" target="_blank">接口文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>const GLubyte * HMS_XEG_GetString (GLenum name)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>XEngine OpenGL ES扩展特性查询接口。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>GL_APICALL void GL_APIENTRY HMS_XEG_AdaptiveVRSParameter (GLenum pname, GLvoid * param)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置自适应VRS的参数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>GL_APICALL void GL_APIENTRY HMS_XEG_DispatchAdaptiveVRS (GLfloat * reprojectionMatrix, GLuint inputColorImage, GLuint inputDepthImage, GLuint shadingRateImage)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>计算着色率图像。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>GL_APICALL void GL_APIENTRY HMS_XEG_ApplyAdaptiveVRS (GLuint shadingRateImage)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>将着色率图像应用到渲染目标中。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_EnumerateDeviceExtensionProperties (VkPhysicalDevice physicalDevice, uint32_t * pPropertyCount, XEG_ExtensionProperties * pProperties)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>XEngine Vulkan扩展特性查询接口。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CreateAdaptiveVRS (VkDevice device, XEG_AdaptiveVRSCreateInfo * pXegAdaptiveVRSCreateInfo, XEG_AdaptiveVRS * pXegAdaptiveVRS)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建XEG_AdaptiveVRS对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_CmdDispatchAdaptiveVRS (VkCommandBuffer cmdBuffer, XEG_AdaptiveVRS xegAdaptiveVRS, XEG_AdaptiveVRSDescription * pXegAdaptiveVRSDescription)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>执行计算自适应可变着色率命令。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_DestroyAdaptiveVRS (XEG_AdaptiveVRS xegAdaptiveVRS)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁XEG_AdaptiveVRS对象。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section6132437143913">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section6132437143913" tips="复制节点链接"></i></h2></div> <p>本章以OpenGL ES和Vulkan图像API集成为例，说明XEngine集成操作过程。</p> <div class="tiledSection"><h3 id="section121331377397" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section121331377397" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so编译需要依赖NDK中的libxengine.so。</p> <ul><li>头文件引用<p>按需引用XEngine的头文件，如使用OpenGL ES自适应VRS功能。</p> <div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_gles_extension.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_gles_adaptive_vrs.h&gt;</span></span></li></ol></pre></div></div> <p>按需引用XEngine的头文件，如使用Vulkan自适应VRS功能。</p> <div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_extension.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_adaptive_vrs.h&gt;</span></span></li></ol></pre></div></div> </li><li>编写CMakeLists.txt<p>按需引用XEngine的CMakeLists，如使用OpenGL ES自适应VRS功能，CMakeLists.txt部分示例代码如下，完整示例代码请参见<a href="https://gitcode.com/harmonyos_samples/xengine-samplecode-gles-demo-cpp" target="_blank">Demo（GPU加速引擎-GLES）</a>。</p> <div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>( </li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    EGL-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    EGL</li><li>)</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    GLES-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    GLESv3</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>${EGL-lib} ${GLES-lib} ${xengine-lib})</li></ol></pre></div></div> <p>按需引用XEngine的CMakeLists，如使用Vulkan自适应VRS功能，CMakeLists.txt部分示例代码如下，完整示例代码请参见<a href="https://gitcode.com/harmonyos_samples/xengine-samplecode-vulkan-demo-cpp" target="_blank">Demo（GPU加速引擎-Vulkan）</a>。</p> <div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    Vulkan-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    vulkan</li><li>)</li><li>
</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>${Vulkan-lib} ${xengine-lib})</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section16115154553211">集成自适应VRS功能（OpenGL ES）<i class="anchor-icon anchor-icon-link" anchorid="section16115154553211" tips="复制节点链接"></i></h3><p>自适应VRS功能OpenGL ES版本的着色率纹理创建和绑定由特性提供的接口实现。</p> <p>在调用XEngine Kit能力前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga76f9695fa41c6664e949cdba586699c0" target="_blank">HMS_XEG_GetString</a>接口，获取XEngine支持的扩展信息，只有在支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga4a9a55586368519629571dd2ba204a95" target="_blank">XEG_ADAPTIVE_VRS_EXTENSION_NAME</a>扩展时才可以使用自适应VRS的相关接口。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 查询XEngine支持的GLES扩展信息</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span>* extensions = (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)<span class="hljs-built_in">HMS_XEG_GetString</span>(XEG_EXTENSIONS);</li><li><span class="hljs-comment">// 查询是否支持自适应VRS</span></li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strstr</span>(extensions, XEG_ADAPTIVE_VRS_EXTENSION_NAME)) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// return error</span></li><li>}</li></ol></pre></div></div> <p></p></li></ol><ol start="2"><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga878f849c0f748225f068606bfb10659b" target="_blank">HMS_XEG_AdaptiveVRSParameter</a>接口，对自适应VRS的参数赋值。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// renderWidth与renderHeight分别为用户自定义的渲染宽度与渲染高度，此处以800*600分辨率为例</span></li><li><span class="hljs-type">uint32_t</span> renderWidth = <span class="hljs-number">800</span>;</li><li><span class="hljs-type">uint32_t</span> renderHeight = <span class="hljs-number">600</span>;</li><li><span class="hljs-comment">// inputSize为上一帧渲染管线最终渲染的图像尺寸，用户可自定义</span></li><li>GLsizei inputSize[<span class="hljs-number">2</span>] = {<span class="hljs-built_in">static_cast</span>&lt;GLsizei&gt;(renderWidth), <span class="hljs-built_in">static_cast</span>&lt;GLsizei&gt;(renderHeight)};</li><li><span class="hljs-built_in">HMS_XEG_AdaptiveVRSParameter</span>(XEG_ADAPTIVE_VRS_INPUT_SIZE, inputSize);</li><li><span class="hljs-comment">// inputRegion为上一帧渲染管线最终渲染的图像区域，用户可自定义</span></li><li>GLuint inputRegion[<span class="hljs-number">4</span>] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, renderWidth, renderHeight};</li><li><span class="hljs-built_in">HMS_XEG_AdaptiveVRSParameter</span>(XEG_ADAPTIVE_VRS_INPUT_REGION, inputRegion);</li><li><span class="hljs-comment">// texelSizes为渲染的分片大小，用户可自定义，当前支持[8, 8]和[16, 16]两种规格</span></li><li>GLsizei texelSizes[<span class="hljs-number">2</span>] = {<span class="hljs-number">8</span>, <span class="hljs-number">8</span>};</li><li><span class="hljs-built_in">HMS_XEG_AdaptiveVRSParameter</span>(XEG_ADAPTIVE_VRS_TEXEL_SIZE, texelSizes);</li><li><span class="hljs-comment">// sensitivity为控制生成着色率图像的阈值，用户可自定义，建议取值范围为[0, 1]</span></li><li>GLfloat sensitivity = <span class="hljs-number">0.15</span>;</li><li><span class="hljs-built_in">HMS_XEG_AdaptiveVRSParameter</span>(XEG_ADAPTIVE_VRS_ERROR_SENSITIVITY, &amp;sensitivity);</li><li><span class="hljs-comment">// flip为判断是否执行图像上下翻转，为true表示不进行图像上下翻转，false则表示进行图像上下翻转，此处以false为例</span></li><li>GLboolean flip = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">HMS_XEG_AdaptiveVRSParameter</span>(XEG_ADAPTIVE_VRS_FLIP, &amp;flip);</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga952c594c8e0bdfff0994206e0c21d825" target="_blank">HMS_XEG_DispatchAdaptiveVRS</a>接口计算着色率图像。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// inputColorImage为用户自定义上一帧渲染管线最终渲染结果颜色附件纹理 </span></li><li>GLuint inputColorImage; </li><li><span class="hljs-comment">// inputDepthImage为用户自定义当前帧渲染管线最终渲染结果深度附件纹理</span></li><li>GLuint inputDepthImage;</li><li><span class="hljs-comment">// outputShadingRateImage为用户可自定义生成着色率图像信息的纹理</span></li><li>GLuint outputShadingRateImage;</li><li><span class="hljs-comment">// reprojectionMatrix为用户根据投影矩阵和观察矩阵计算得来的重投影矩阵</span></li><li><span class="hljs-type">float</span> *reprojectionMatrix = <span class="hljs-literal">nullptr</span>; </li><li><span class="hljs-built_in">HMS_XEG_DispatchAdaptiveVRS</span>(reprojectionMatrix, inputColorImage, inputDepthImage, outputShadingRateImage);</li></ol></pre></div></div> <p></p></li></ol><ol start="4"><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga4964ed03c504b2800fc73e8bad919a66" target="_blank">HMS_XEG_ApplyAdaptiveVRS</a>接口，将着色率图像应用到渲染目标中。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">HMS_XEG_ApplyAdaptiveVRS</span>(outputShadingRateImage);</li></ol></pre></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section20543957182511">集成自适应VRS功能（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section20543957182511" tips="复制节点链接"></i></h3><p>在调用XEngine Kit能力前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询您的目标设备是否支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga4a9a55586368519629571dd2ba204a95" target="_blank">XEG_ADAPTIVE_VRS_EXTENSION_NAME</a>扩展时才可以使用自适应VRS的相关接口。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// physicalDevice为Vulkan物理设备，用户需进行初始化</span></li><li>VkPhysicalDevice physicalDevice;</li><li><span class="hljs-comment">// 查询XEngine支持的Vulkan扩展列表</span></li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> pPropertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;pPropertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (pPropertyCount &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">pProperties</span><span class="hljs-params">(pPropertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;pPropertyCount, &amp;pProperties.<span class="hljs-built_in">front</span>()) == VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : pProperties) {</li><li>        supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-comment">// 查询是否支持自适应VRS</span></li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_ADAPTIVE_VRS_EXTENSION_NAME) == supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// return error</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_AdaptiveVRS xeg_adaptiveVRS;</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga0800207cf28ce27dbf7d1d1261c08188" target="_blank">HMS_XEG_CreateAdaptiveVRS</a>接口，定义并创建实例。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// m_renderWidth与m_renderHeight分别为纹理采样宽高</span></li><li><span class="hljs-type">int</span> m_renderWidth;</li><li><span class="hljs-type">int</span> m_renderHeight;</li><li><span class="hljs-comment">// VRS_TILE_SIZE为自适应VRS的渲染的分片大小</span></li><li><span class="hljs-type">int</span> VRS_TILE_SIZE;</li><li><span class="hljs-comment">// Vulkan逻辑设备，用户需进行初始化</span></li><li>VkDevice device;</li><li><span class="hljs-comment">// XEG_AdaptiveVRSCreateInfo为自适应VRS实例句柄对象的参数信息</span></li><li>XEG_AdaptiveVRSCreateInfo xeg_createInfo;</li><li><span class="hljs-comment">// XEG_AdaptiveVRSDescription为下发绘制着色率纹理命令所需参数信息</span></li><li>XEG_AdaptiveVRSDescription xeg_description;</li><li><span class="hljs-comment">// VkExtent2D inputSize为上一帧渲染管线最终渲染的图像尺寸，用户可自定义</span></li><li>VkExtent2D inputSize;</li><li>inputSize.width = m_renderWidth;</li><li>inputSize.height = m_renderHeight;</li><li><span class="hljs-comment">// VkRect2D为Vulkan指定的二维区域结构</span></li><li><span class="hljs-comment">// inputRegion为自适应VRS输入纹理区域，用户可自定义</span></li><li>VkRect2D inputRegion {};</li><li><span class="hljs-comment">// inputRegion.extent.width与inputRegion.extent.height分别为纹理采样宽高</span></li><li>inputRegion.extent.width = m_renderWidth;</li><li>inputRegion.extent.height = m_renderHeight;</li><li><span class="hljs-comment">// inputRegion.offset.x和inputRegion.offset.y为原点偏移量</span></li><li>inputRegion.offset.x = <span class="hljs-number">0</span>;</li><li>inputRegion.offset.y = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// xeg_createInfo.inputSize为上一帧渲染管线最终渲染的图像尺寸</span></li><li>xeg_createInfo.inputSize = inputSize;</li><li><span class="hljs-comment">// xeg_createInfo.inputRegion为上一帧渲染管线最终渲染的图像区域</span></li><li>xeg_createInfo.inputRegion = inputRegion;</li><li><span class="hljs-comment">// xeg_createInfo.adaptiveTileSize为自适应VRS的渲染的分片大小</span></li><li>xeg_createInfo.adaptiveTileSize = VRS_TILE_SIZE;</li><li><span class="hljs-comment">// xeg_createInfo.errorSensitivity为控制最终生成着色率纹理结果的阈值，此处以阈值为0.5为例</span></li><li>xeg_createInfo.errorSensitivity = <span class="hljs-number">0.5</span>;</li><li><span class="hljs-comment">// xeg_createInfo.flip为判断是否执行图像上下翻转，为true表示进行图像上下翻转，false则表示不进行图像上下翻转，此处以false为例</span></li><li>xeg_createInfo.flip = <span class="hljs-literal">false</span>;</li><li><span class="hljs-built_in">HMS_XEG_CreateAdaptiveVRS</span>(device, &amp;xeg_createInfo, &amp;xeg_adaptiveVRS);</li></ol></pre></div></div> <p></p></li></ol><ol start="4"><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga5c5833ba829376453278b32fd0659a9f" target="_blank">HMS_XEG_CmdDispatchAdaptiveVRS</a>接口，下发自适应VRS命令，生成perImage着色率纹理。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// inputColorImageView为用户自定义的上一帧渲染管线最终渲染结果颜色附件纹理</span></li><li>VkImageView inputColorImageView = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// inputColorImageView为用户自定义的前帧渲染管线最终渲染结果深度附件纹理</span></li><li>VkImageView inputDepthImageView = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// outputShadingRateImage为用户自定义的生成着色率图信息的纹理</span></li><li>VkImageView outputShadingRateImage = VK_NULL_HANDLE;</li><li><span class="hljs-comment">// cmdBuff为命令缓冲区，用户需进行初始化</span></li><li>VkCommandBuffer commandBuffer = VK_NULL_HANDLE ;</li><li>xeg_description.inputColorImage = inputColorImageView; </li><li>xeg_description.inputDepthImage = inputDepthImageView;</li><li>xeg_description.outputShadingRateImage = outputShadingRateImage;</li><li> <span class="hljs-comment">// xeg_description.reprojectionMatrix为使用投影矩阵和观察矩阵计算而来的重投影矩阵</span></li><li>xeg_description.reprojectionMatrix = <span class="hljs-literal">nullptr</span>; </li><li><span class="hljs-built_in">HMS_XEG_CmdDispatchAdaptiveVRS</span>(commandBuffer, xeg_adaptiveVRS, &amp;xeg_description);</li></ol></pre></div></div> <p></p></li></ol><ol start="5"><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga87a2e1f8f1f5e2ddfa6946437928959b" target="_blank">HMS_XEG_DestroyAdaptiveVRS</a>接口，卸载VRS实例，清理VRS相关资源。</span><p></p><div _ngcontent-xnt-c106="" class="highlight-div"><div _ngcontent-xnt-c106="" class="highlight-div-header"><div _ngcontent-xnt-c106="" class="highlight-div-header-left"><div _ngcontent-xnt-c106="" class="handle-button expand-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xnt-c106="" class="highlight-div-header-right"><div _ngcontent-xnt-c106="" class="handle-button ai-button"></div><div _ngcontent-xnt-c106="" class="handle-button line-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xnt-c106="" class="handle-button theme-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xnt-c106="" class="handle-button copy-button"><div _ngcontent-xnt-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xnt-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">HMS_XEG_DestroyAdaptiveVRS</span>(xeg_adaptiveVRS);</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>