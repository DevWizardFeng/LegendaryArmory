<h1 _ngcontent-ndv-c119="" class="doc-title ng-star-inserted" title="获取密钥属性(C/C++)"> 获取密钥属性(C/C++) </h1>

<div _ngcontent-ndv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>HUKS提供了接口供业务获取指定密钥的相关属性。在获取指定密钥属性前，需要确保已在HUKS中生成或导入持久化存储的密钥。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>轻量级设备不支持获取密钥属性功能。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="在cmake脚本中链接相关动态库">在CMake脚本中链接相关动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接相关动态库" tips="复制节点链接"></i></h2>          <div _ngcontent-ndv-c106="" class="highlight-div"><div _ngcontent-ndv-c106="" class="highlight-div-header"><div _ngcontent-ndv-c106="" class="highlight-div-header-left"><div _ngcontent-ndv-c106="" class="handle-button expand-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ndv-c106="" class="highlight-div-header-right"><div _ngcontent-ndv-c106="" class="handle-button ai-button"></div><div _ngcontent-ndv-c106="" class="handle-button line-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ndv-c106="" class="handle-button theme-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ndv-c106="" class="handle-button copy-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ndv-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libhuks_ndk.z.so)</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>构造对应参数。</p>       <ul>        <li>keyAlias：密钥别名，封装成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hukstypeapi-oh-huks-blob" target="_blank">OH_Huks_Blob</a>结构，密钥别名最大长度为128字节。</li>        <li>paramSetIn：预留参数，暂不需要处理，传空即可。</li>        <li>paramSetOut：用于放置获取到的参数集结果，为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hukstypeapi-oh-huks-paramset" target="_blank">OH_Huks_ParamSet</a>类型对象，需要业务提前申请好内存，需申请足够容纳获取到的密钥属性集的内存大小。</li>       </ul></li>      <li>       <p>调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-huks-api-h#oh_huks_getkeyitemparamset" target="_blank">OH_Huks_GetKeyItemParamSet</a>，传入上述参数。</p></li>      <li>       <p>返回值为成功码/错误码，获取成功后，从参数集中读取需要的参数。</p></li>     </ol>     <div _ngcontent-ndv-c106="" class="highlight-div"><div _ngcontent-ndv-c106="" class="highlight-div-header"><div _ngcontent-ndv-c106="" class="highlight-div-header-left"><div _ngcontent-ndv-c106="" class="handle-button expand-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ndv-c106="" class="highlight-div-header-right"><div _ngcontent-ndv-c106="" class="handle-button ai-button"></div><div _ngcontent-ndv-c106="" class="handle-button line-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ndv-c106="" class="handle-button theme-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ndv-c106="" class="handle-button copy-button"><div _ngcontent-ndv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ndv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"huks/native_huks_param.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span></li><li>
</li><li><span class="hljs-function">OH_Huks_Result <span class="hljs-title">InitParamSet</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_Huks_ParamSet **paramSet, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> OH_Huks_Param *params,</span></span></li><li><span class="hljs-function">                            <span class="hljs-type">uint32_t</span> paramCount)</span></li><li><span class="hljs-function"></span>{</li><li>    OH_Huks_Result ret = <span class="hljs-built_in">OH_Huks_InitParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_AddParams</span>(*paramSet, params, paramCount);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    ret = <span class="hljs-built_in">OH_Huks_BuildParamSet</span>(paramSet);</li><li>    <span class="hljs-keyword">if</span> (ret.errorCode != OH_HUKS_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(paramSet);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Param</span> g_testGenerateKeyParam[] = {{.tag = OH_HUKS_TAG_ALGORITHM, .uint32Param = OH_HUKS_ALG_ECC},</li><li>                                                 {.tag = OH_HUKS_TAG_PURPOSE, .uint32Param = OH_HUKS_KEY_PURPOSE_AGREE},</li><li>                                                 {.tag = OH_HUKS_TAG_KEY_SIZE, .uint32Param = OH_HUKS_ECC_KEY_SIZE_256},</li><li>                                                 {.tag = OH_HUKS_TAG_DIGEST, .uint32Param = OH_HUKS_DIGEST_NONE}};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> OH_Huks_Result <span class="hljs-title">GenerateKeyHelper</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *alias)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> aliasBlob = {.size = (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(alias), .data = (<span class="hljs-type">uint8_t</span> *)alias};</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *testGenerateKeyParamSet = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> ohResult;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-comment">/* 1.初始化密钥属性集 */</span></li><li>        ohResult = <span class="hljs-built_in">InitParamSet</span>(&amp;testGenerateKeyParamSet, g_testGenerateKeyParam,</li><li>                                <span class="hljs-built_in">sizeof</span>(g_testGenerateKeyParam) / <span class="hljs-built_in">sizeof</span>(OH_Huks_Param));</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 1.生成密钥 */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GenerateKeyItem</span>(&amp;aliasBlob, testGenerateKeyParamSet, <span class="hljs-literal">nullptr</span>);</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;testGenerateKeyParamSet);</li><li>    <span class="hljs-keyword">return</span> ohResult;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetKeyParamSet</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">/* 1. 参数构造：确定密钥别名 */</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *alias = <span class="hljs-string">"test_key"</span>;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Blob</span> aliasBlob = { .size = (<span class="hljs-type">uint32_t</span>)<span class="hljs-built_in">strlen</span>(alias), .data = (<span class="hljs-type">uint8_t</span> *)alias };</li><li>
</li><li>    <span class="hljs-comment">/* 生成密钥 */</span></li><li>    OH_Huks_Result genResult = <span class="hljs-built_in">GenerateKeyHelper</span>(alias);</li><li>    <span class="hljs-keyword">if</span> (genResult.errorCode != OH_HUKS_SUCCESS) {</li><li>        napi_value ret;</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, genResult.errorCode, &amp;ret);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> paramSetSize = <span class="hljs-number">512</span>;</li><li>    <span class="hljs-comment">/* 构造参数：为参数集申请内存</span></li><li><span class="hljs-comment">     * 请业务按实际情况评估大小进行申请</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_ParamSet</span> *outParamSet = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> OH_Huks_ParamSet *&gt;(<span class="hljs-built_in">malloc</span>(paramSetSize));</li><li>    <span class="hljs-keyword">if</span> (outParamSet == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    outParamSet-&gt;paramSetSize = paramSetSize;</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OH_Huks_Result</span> ohResult;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        <span class="hljs-comment">/* 2. 获取密钥属性集 */</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GetKeyItemParamSet</span>(&amp;aliasBlob, <span class="hljs-literal">nullptr</span>, outParamSet);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">/* 3. 从参数集中读取参数，以OH_HUKS_TAG_PURPOSE为例 */</span></li><li>        OH_Huks_Param *purposeParam = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 无需申请内存，获取后指针指向该参数在参数集中所处内存地址</span></li><li>        ohResult = <span class="hljs-built_in">OH_Huks_GetParam</span>(outParamSet, OH_HUKS_TAG_PURPOSE, &amp;purposeParam);</li><li>        <span class="hljs-keyword">if</span> (ohResult.errorCode != OH_HUKS_SUCCESS) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">OH_Huks_FreeParamSet</span>(&amp;outParamSet);</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_int32</span>(env, ohResult.errorCode, &amp;ret);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>