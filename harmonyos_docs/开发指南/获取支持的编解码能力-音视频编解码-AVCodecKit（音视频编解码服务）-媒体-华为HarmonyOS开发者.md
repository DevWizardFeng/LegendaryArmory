<h1 _ngcontent-wog-c119="" class="doc-title ng-star-inserted" title="获取支持的编解码能力"> 获取支持的编解码能力 </h1>

<div _ngcontent-wog-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>因来源、编解码协议及设备能力的不同，导致不同设备上可用的编解码器及其能力存在差异。</p>    <p>为确保编解码行为符合预期，请通过音视频编解码能力接口查询系统支持的编解码器及其能力，选择符合开发需求的编解码器，并正确配置参数。</p>    <div class="tiledSection">     <h2 id="通用开发指导">通用开发指导<i class="anchor-icon anchor-icon-link" anchorid="通用开发指导" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>在CMake脚本中链接动态库。</p>       <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_venc.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_acodec.so)</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>        </div></div></div></li>      <li>       <p>添加头文件。</p>       <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_audiocodec.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>获得音视频编解码能力实例。</p>       <p>支持两种方式获取音视频编解码能力实例。</p>       <p>方式一：通过OH_AVCodec_GetCapability获取系统推荐的音视频编解码器能力实例。推荐策略与OH_XXX_CreateByMime系列接口一致。</p>       <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取系统推荐的音频AAC解码器能力实例。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">false</span>);</li></ol></pre></div></div>       <p>方式二：通过OH_AVCodec_GetCapabilityByCategory获取指定软硬件的编解码能力实例。</p>       <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取指定硬件的视频AVC编码器能力实例。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>, HARDWARE);</li></ol></pre></div></div>       <p>若获取能力实例成功，继续向下执行。实例无显性释放接口，使用完毕后系统会自动回收。</p></li>      <li>       <p>按需调用相应的查询接口。详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcapability-h" target="_blank">API文档</a>。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="场景化开发">场景化开发<i class="anchor-icon anchor-icon-link" anchorid="场景化开发" tips="复制节点链接"></i></h2>          <p>基于开发过程中可能遇到的具体场景，此处将举例说明能力查询接口的使用方法。</p>    </div>    <div class="tiledSection">     <h3 id="创建指定名称的编解码器" class="firsth2">创建指定名称的编解码器<i class="anchor-icon anchor-icon-link" anchorid="创建指定名称的编解码器" tips="复制节点链接"></i></h3>          <p>如果系统存在多个相同MIME类型的编解码器，使用OH_XXX_CreateByMime系列接口创建系统推荐的编解码器。如需创建其他编解码器，先获取名称，再通过OH_XXX_CreateByName系列接口创建指定名称的编解码器。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetName</td>         <td class="cellrowborder" valign="top" width="50%">获取能力实例对应编解码器的名称。</td>        </tr>             </tbody></table></div>     </div>     <p>当H.264软件解码器和H.264硬件解码器同时存在时，创建H.264软件解码器的示例代码如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 获取H.264软件解码器能力实例。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>, SOFTWARE);</li><li><span class="hljs-keyword">if</span> (capability != <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 2. 获取H.264软件解码器名称。</span></li><li>   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *codecName = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>   <span class="hljs-comment">// 3. 创建H.264软件解码器实例。</span></li><li>   OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(codecName);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="针对软硬件类别差异化配置编解码器参数">针对软硬件类别差异化配置编解码器参数<i class="anchor-icon anchor-icon-link" anchorid="针对软硬件类别差异化配置编解码器参数" tips="复制节点链接"></i></h3>          <p>以下是软件编解码器和硬件编解码器的定义。</p>     <ul>      <li>       <p><strong>软件编解码器：</strong> 指在CPU上工作的编解码器，具有迭代灵活、兼容性好和扩展能力强等特点。</p></li>      <li>       <p><strong>硬件编解码器：</strong> 指在专有硬件上工作的编解码器，具有低功耗、高性能和减少CPU负载等特点。</p></li>     </ul>     <p>在硬件编解码器充足且满足能力要求时，优先使用硬件编解码器；否则使用软件编解码器。开发者可根据编解码器类别配置不同的编解码参数。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_IsHardware</td>         <td class="cellrowborder" valign="top" width="50%">确认能力实例对应的编解码器是否为硬件编解码器。</td>        </tr>             </tbody></table></div>     </div>     <p>视频编码的软硬件类别差异化配置帧率示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 确认推荐的H.264编码器的软硬件类别。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-type">bool</span> isHardware = <span class="hljs-built_in">OH_AVCapability_IsHardware</span>(capability);</li><li><span class="hljs-comment">// 2. 基于软硬件类别差异化配置。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-type">double</span> frameRate = isHardware ? <span class="hljs-number">60.0</span> : <span class="hljs-number">30.0</span>;</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetDoubleValue</span>(format, OH_MD_KEY_FRAME_RATE, frameRate)) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="创建多路编解码器">创建多路编解码器<i class="anchor-icon anchor-icon-link" anchorid="创建多路编解码器" tips="复制节点链接"></i></h3>          <p>部分业务场景涉及创建多路编解码器，基于系统内存、处理器和带宽等资源的限制，某一编解码器的实例数是有限的，不能无限制创建。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetMaxSupportedInstances</td>         <td class="cellrowborder" valign="top" width="50%">获取能力实例对应编解码器的最大实例数。实际创建数还受系统内存、处理器和带宽等资源的约束。</td>        </tr>             </tbody></table></div>     </div>     <p>优先创建硬件解码器实例，资源不足时创建软件解码器实例。示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int32_t</span> NEEDED_VDEC_NUM = <span class="hljs-number">8</span>;</li><li><span class="hljs-comment">// 1. 创建硬件解码器实例。</span></li><li>OH_AVCapability *capHW = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>, HARDWARE);</li><li><span class="hljs-keyword">if</span> (capHW == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-type">int32_t</span> vDecNumHW = std::<span class="hljs-built_in">min</span>(<span class="hljs-built_in">OH_AVCapability_GetMaxSupportedInstances</span>(capHW), NEEDED_VDEC_NUM);</li><li><span class="hljs-type">int32_t</span> createdVDecNum = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vDecNumHW; i++) {</li><li>   OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(<span class="hljs-built_in">OH_AVCapability_GetName</span>(capHW));</li><li>   <span class="hljs-keyword">if</span> (videoDec != <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-comment">// 维护在videoDecVector中。</span></li><li>      createdVDecNum++;</li><li>   }</li><li>}</li><li><span class="hljs-keyword">if</span> (createdVDecNum &lt; NEEDED_VDEC_NUM) {</li><li>   <span class="hljs-comment">// 2. 不够时，创建软件解码器实例。</span></li><li>   OH_AVCapability *capSW = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>, SOFTWARE);</li><li>   <span class="hljs-keyword">if</span> (capSW == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-comment">// 异常处理。</span></li><li>   }</li><li>   <span class="hljs-type">int32_t</span> vDecNumSW = std::<span class="hljs-built_in">min</span>(<span class="hljs-built_in">OH_AVCapability_GetMaxSupportedInstances</span>(capSW), NEEDED_VDEC_NUM - createdVDecNum);</li><li>   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vDecNumSW; i++) {</li><li>      OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(<span class="hljs-built_in">OH_AVCapability_GetName</span>(capSW));</li><li>      <span class="hljs-keyword">if</span> (videoDec != <span class="hljs-literal">nullptr</span>) {</li><li>         <span class="hljs-comment">// 维护在videoDecVector中。</span></li><li>         createdVDecNum++;</li><li>      }</li><li>   }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="控制编码质量">控制编码质量<i class="anchor-icon anchor-icon-link" anchorid="控制编码质量" tips="复制节点链接"></i></h3>          <p>提供四种码控模式供开发者选择：恒定码率（CBR）、动态码率（VBR）、恒定质量（CQ）及质量稳定（SQR）。</p>     <ul>      <li>CBR和VBR码控模式下，编码质量取决于码率参数。</li>      <li>CQ码控模式下，编码质量取决于质量参数。</li>      <li>SQR码控模式下，编码质量由质量稳定码率因子和最大码率决定，且仅支持H.265（HEVC）编码。</li>     </ul>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.8.4.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.8.4.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_IsEncoderBitrateModeSupported</td>         <td class="cellrowborder" valign="top" width="50%">确认当前编码器是否支持给定的码控模式。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetEncoderBitrateRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编码器支持的码率范围，适用于CBR、VBR和SQR码控模式。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetEncoderQualityRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编码器支持的质量范围，适用于CQ码控模式。</td>        </tr>             </tbody></table></div>     </div>     <p>CBR和VBR码控模式示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_BitrateMode bitrateMode = BITRATE_MODE_CBR;</li><li><span class="hljs-type">int32_t</span> bitrate = <span class="hljs-number">3000000</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置码控模式是否支持。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_IsEncoderBitrateModeSupported</span>(capability, bitrateMode);</li><li><span class="hljs-keyword">if</span> (!isSupported) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 获取码率范围，判断待配置码率参数是否在范围内。</span></li><li>OH_AVRange bitrateRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetEncoderBitrateRange</span>(capability, &amp;bitrateRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || bitrateRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (bitrate &gt; bitrateRange.maxVal || bitrate &lt; bitrateRange.minVal) {</li><li>   <span class="hljs-comment">// 3.（可选）调整待配置码率参数。</span></li><li>}</li><li><span class="hljs-comment">// 4. 配置编码参数。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE, bitrateMode) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetLongValue</span>(format, OH_MD_KEY_BITRATE, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int64_t</span>&gt;(bitrate))) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>     <p>CQ码控模式示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_BitrateMode bitrateMode = BITRATE_MODE_CQ;</li><li><span class="hljs-type">int32_t</span> quality = <span class="hljs-number">0</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置码控模式是否支持。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_IsEncoderBitrateModeSupported</span>(capability, bitrateMode);</li><li><span class="hljs-keyword">if</span> (!isSupported) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 获取质量范围，判断待配置质量参数是否在范围内。</span></li><li>OH_AVRange qualityRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetEncoderQualityRange</span>(capability, &amp;qualityRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || qualityRange.maxVal &lt; <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (quality &gt; qualityRange.maxVal || quality &lt; qualityRange.minVal) {</li><li>   <span class="hljs-comment">// 3.（可选）调整待配置质量参数。</span></li><li>}</li><li><span class="hljs-comment">// 4. 配置编码参数。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE, bitrateMode) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_QUALITY, quality)) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>     <p>SQR码控模式示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_BitrateMode bitrateMode = BITRATE_MODE_SQR;</li><li><span class="hljs-type">int32_t</span> sqrFactor = <span class="hljs-number">30</span>; <span class="hljs-comment">// 质量稳定码率因子。</span></li><li><span class="hljs-type">int32_t</span> maxBitrate = <span class="hljs-number">20000000</span>; <span class="hljs-comment">// 最大码率。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置码控模式是否支持。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_IsEncoderBitrateModeSupported</span>(capability, bitrateMode);</li><li><span class="hljs-keyword">if</span> (!isSupported) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 获取码率范围，判断待配置最大码率参数是否在范围内。</span></li><li>OH_AVRange bitrateRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li><span class="hljs-comment">// 最大码率参数的取值范围同码率参数，故复用OH_AVCapability_GetEncoderBitrateRange获取取值范围。</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetEncoderBitrateRange</span>(capability, &amp;bitrateRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || bitrateRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 质量稳定码率因子取值范围为[0, 51]（同编码量化参数QP）。</span></li><li><span class="hljs-keyword">if</span> (sqrFactor &gt; <span class="hljs-number">51</span> || sqrFactor &lt; <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 3.（可选）调整待配置质量稳定码率因子参数。</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (maxBitrate &gt; bitrateRange.maxVal || maxBitrate &lt; bitrateRange.minVal) {</li><li>   <span class="hljs-comment">// 4.（可选）调整待配置最大码率参数。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 5. 配置编码参数。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE, bitrateMode) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_SQR_FACTOR, sqrFactor) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_MAX_BITRATE, maxBitrate)) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li><li>
</li><li><span class="hljs-comment">// 6.启动编码器，开始编码。</span></li><li>ret = <span class="hljs-built_in">OH_VideoEncoder_Prepare</span>(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>ret = <span class="hljs-built_in">OH_VideoEncoder_Start</span>(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 7.（可选）OH_VideoEncoder_SetParameter()在运行过程中动态配置质量稳定码率因子参数和最大码率参数。</span></li><li>OH_AVFormat *dynamicFormat = <span class="hljs-built_in">OH_AVFormat_Create</span>();</li><li><span class="hljs-comment">// SQR码控支持动态配置最大码率参数和质量稳定码率因子参数。</span></li><li>sqrFactor = <span class="hljs-number">25</span>; <span class="hljs-comment">// 更新质量稳定码率因子。</span></li><li>maxBitrate = <span class="hljs-number">10000000</span>; <span class="hljs-comment">// 更新最大码率参数。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetLongValue</span>(dynamicFormat, OH_MD_KEY_MAX_BITRATE, maxBitrate);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(dynamicFormat, OH_MD_KEY_SQR_FACTOR, sqrFactor);</li><li>ret = <span class="hljs-built_in">OH_VideoEncoder_SetParameter</span>(videoEnc, dynamicFormat);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(dynamicFormat);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="查询编码器支持复杂度范围">查询编码器支持复杂度范围<i class="anchor-icon anchor-icon-link" anchorid="查询编码器支持复杂度范围" tips="复制节点链接"></i></h3>          <p>复杂度等级决定了编码器使用的工具数量，但并非所有编码器都支持这一功能。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.9.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetEncoderComplexityRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编码器支持的复杂度等级范围。</td>        </tr>             </tbody></table></div>     </div>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 确认支持的编码复杂度范围。</span></li><li>OH_AVRange complexityRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetEncoderComplexityRange</span>(capability, &amp;complexityRange);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置正确的音频编解码参数">设置正确的音频编解码参数<i class="anchor-icon anchor-icon-link" anchorid="设置正确的音频编解码参数" tips="复制节点链接"></i></h3>          <p>在音频编解码场景中，需要设置采样率和通道数。对于音频编码，还需要设置码率。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.10.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetAudioSupportedSampleRateRanges</td>         <td class="cellrowborder" valign="top" width="50%">获取当前音频编解码器支持的采样率范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetAudioChannelCountRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前音频编解码器支持的通道数范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetEncoderBitrateRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编码器支持的码率范围。</td>        </tr>             </tbody></table></div>     </div>     <p>音频编解码参数查询示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> sampleRate = <span class="hljs-number">44100</span>;</li><li><span class="hljs-type">int32_t</span> channelCount = <span class="hljs-number">2</span>;</li><li><span class="hljs-type">int32_t</span> bitrate = <span class="hljs-number">261000</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置采样率是否支持。</span></li><li>OH_AVRange *sampleRateRanges = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">uint32_t</span> rangesNum = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetAudioSupportedSampleRateRanges</span>(capability, &amp;sampleRateRanges, &amp;rangesNum);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || sampleRateRanges == <span class="hljs-literal">nullptr</span> || rangesNum == <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-type">bool</span> isMatched = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; rangesNum; i++) {</li><li>   <span class="hljs-keyword">if</span> (sampleRate &gt;= sampleRateRanges[i].minVal &amp;&amp; sampleRate &lt;= sampleRateRanges[i].maxVal) {</li><li>      isMatched = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>   }</li><li>}</li><li><span class="hljs-keyword">if</span> (!isMatched) {</li><li>   <span class="hljs-comment">// 2.（可选）调整待配置采样率。</span></li><li>}</li><li><span class="hljs-comment">// 3. 获取通道数范围，判断待配置通道数参数是否在范围内。</span></li><li>OH_AVRange channelRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li>ret = <span class="hljs-built_in">OH_AVCapability_GetAudioChannelCountRange</span>(capability, &amp;channelRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || channelRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (channelCount &gt; channelRange.maxVal || channelCount &lt; channelRange.minVal ) {</li><li>   <span class="hljs-comment">// 4.（可选）调整待配置通道数。</span></li><li>}</li><li><span class="hljs-comment">// 5. 获取码率范围，判断待配置码率参数是否在范围内。</span></li><li>OH_AVRange bitrateRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li>ret = <span class="hljs-built_in">OH_AVCapability_GetEncoderBitrateRange</span>(capability, &amp;bitrateRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || bitrateRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (bitrate &gt; bitrateRange.maxVal || bitrate &lt; bitrateRange.minVal ) {</li><li>   <span class="hljs-comment">// 6.（可选）调整待配置码率值。</span></li><li>}</li><li><span class="hljs-comment">// 7. 配置编码参数。</span></li><li>OH_AVCodec *audioEnc = <span class="hljs-built_in">OH_AudioCodec_CreateByMime</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (audioEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_Create</span>();</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_SAMPLE_RATE, sampleRate) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_CHANNEL_COUNT, channelCount) ||</li><li>   !<span class="hljs-built_in">OH_AVFormat_SetLongValue</span>(format, OH_MD_KEY_BITRATE, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int64_t</span>&gt;(bitrate))) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AudioCodec_Configure</span>(audioEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="查询编解码档次和级别支持情况">查询编解码档次和级别支持情况<i class="anchor-icon anchor-icon-link" anchorid="查询编解码档次和级别支持情况" tips="复制节点链接"></i></h3>          <p>编解码标准包含多种编码工具，适用于不同的编码场景。对于特定应用场景，编解码标准按档次确定所需编码工具的开启与关闭情况（例如，H.264有基本档次、主档次和高档次）。详情参见 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcprofile" target="_blank">OH_AVCProfile</a>。</p>     <p>级别划分了编解码器所需的处理能力和存储空间。H.264有1到6.2的20个级别，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avclevel" target="_blank">OH_AVCLevel</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.11.4.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetSupportedProfiles</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编解码器支持的档次。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetSupportedLevelsForProfile</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编解码器在给定档次的情况下支持的级别信息。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_AreProfileAndLevelSupported</td>         <td class="cellrowborder" valign="top" width="50%">确认当前编解码器是否支持特定的档次和级别组合。</td>        </tr>             </tbody></table></div>     </div>     <p>确认待配置的档次是否支持，并查询该档次下支持的级别，示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_AVCProfile profile = AVC_PROFILE_MAIN;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置档次是否支持。</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> *profiles = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">uint32_t</span> profileNum = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetSupportedProfiles</span>(capability, &amp;profiles, &amp;profileNum);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || profiles == <span class="hljs-literal">nullptr</span> || profileNum == <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-type">bool</span> isMatched = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; profileNum; i++) {</li><li>   <span class="hljs-keyword">if</span> (profiles[i] == profile) {</li><li>      isMatched = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>   }</li><li>}</li><li><span class="hljs-comment">// 2. 查询待配置档次能支持的级别范围。</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> *levels = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">uint32_t</span> levelNum = <span class="hljs-number">0</span>;</li><li>ret = <span class="hljs-built_in">OH_AVCapability_GetSupportedLevelsForProfile</span>(capability, profile, &amp;levels, &amp;levelNum);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || levels == <span class="hljs-literal">nullptr</span> || levelNum == <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVCLevel maxLevel = <span class="hljs-built_in">static_cast</span>&lt;OH_AVCLevel&gt;(levels[<span class="hljs-number">0</span>]);</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">1</span>; i &lt; levelNum; i++) {</li><li>   OH_AVCLevel tmp = <span class="hljs-built_in">static_cast</span>&lt;OH_AVCLevel&gt;(levels[i]);</li><li>   <span class="hljs-keyword">if</span> (tmp &gt; maxLevel) {</li><li>      maxLevel = tmp;</li><li>   }</li><li>}</li><li><span class="hljs-comment">// 3.（可选）基于支持的最大级别做业务逻辑区分。</span></li><li><span class="hljs-keyword">if</span> (maxLevel &gt;= AVC_LEVEL_51) {</li><li>   <span class="hljs-comment">// level5.1以上，宽、高可配置3840x2160。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (maxLevel &gt;= AVC_LEVEL_4) {</li><li>   <span class="hljs-comment">// level4.0以上，宽、高可配1920x1080。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (maxLevel &gt;= AVC_LEVEL_31) {</li><li>   <span class="hljs-comment">// level3.1以上，宽、高可配1280x720。</span></li><li>} <span class="hljs-keyword">else</span> {</li><li>   <span class="hljs-comment">// 报错，不做编码。</span></li><li>}</li><li><span class="hljs-comment">// 4. 配置档次参数。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_PROFILE, profile)) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>     <p>已知需要的编码档次和级别组合，直接查询支持情况示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 1. 获取H.264编码器能力实例。</span></li><li>OH_AVCapability *capability = OH_AVCodec_GetCapability(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == nullptr) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 查询编码档次和级别是否支持。</span></li><li><span class="hljs-type">bool</span> isSupported = OH_AVCapability_AreProfileAndLevelSupported(capability, <span class="hljs-built_in">AVC_PROFILE_MAIN</span>, <span class="hljs-built_in">AVC_LEVEL_51</span>);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置正确的视频宽高">设置正确的视频宽高<i class="anchor-icon anchor-icon-link" anchorid="设置正确的视频宽高" tips="复制节点链接"></i></h3>          <p>视频编解码器对宽度和高度有对齐约束。例如，主流编解码器默认编解码像素格式为YUV420系列，UV分量在宽度和高度两个方向都会下采样为原始尺寸的一半，因此视频编解码的宽度和高度至少要按2对齐。其他因素也可能导致更严格的对齐约束。</p>     <p>视频编解码的宽高不仅会受帧级编解码能力限制，同时也会受协议级别对帧级能力的限制。以H.264为例，AVC_LEVEL_51限定最大每帧宏块数目为36864个。</p>     <p>根据视频高度计算最大视频宽度的公式如下。</p>     <p><span><img originheight="110" originwidth="781" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114422.16873612944578782552241842100393:50001231000000:2800:09A4CCC19C6C2E2AFC8DD0F2444B6A6BE98AAB15C30DF072322073138E226F42.png" width="781" height="110"></span></p>     <p>MaxMBsPerFrameLevelLimits表示协议限定的编解码器最大每帧宏块数，MaxMBsPerFrameSubmit表示编解码器上报的最大每帧宏块数，实际能力取这两者的最小值。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.12.7.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.12.7.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoWidthAlignment</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器的宽对齐。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoHeightAlignment</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器的高对齐。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoWidthRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器支持的宽的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoHeightRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器支持的高的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoWidthRangeForHeight</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器在给定高情况下的宽的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoHeightRangeForWidth</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器在给定宽情况下的高的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_IsVideoSizeSupported</td>         <td class="cellrowborder" valign="top" width="50%">校验当前视频编解码器是否支持给定的宽高组合。</td>        </tr>             </tbody></table></div>     </div>     <p>校验视频高度和宽度是否支持，示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">1920</span>;</li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">1080</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认视频宽高是否支持。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_IsVideoSizeSupported</span>(capability, width, height);</li><li><span class="hljs-keyword">if</span> (!isSupported) {</li><li>   <span class="hljs-comment">// 2. (可选) 按已知视频高或已知视频宽查询详细限制，并调整。</span></li><li>}</li></ol></pre></div></div>     <p>如果视频高度和视频宽度校验不支持或配置失败，可尝试以下方法确定正确的视频宽高范围。</p>     <p>已知视频宽度，可以按照以下示例找到正确的尺寸配置。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">width</span> = <span class="hljs-number">1920</span>;</li><li><span class="hljs-variable">OH_AVCapability</span> *<span class="hljs-variable">capability</span> = <span class="hljs-title function_">OH_AVCodec_GetCapability</span>(<span class="hljs-variable">OH_AVCODEC_MIMETYPE_VIDEO_AVC</span>, <span class="hljs-keyword">true</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">capability</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认视频宽符合宽对齐要求。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">widthAlignment</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoWidthAlignment</span>(<span class="hljs-variable">capability</span>, &amp;<span class="hljs-title class_">widthAlignment</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">widthAlignment</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">width</span> % <span class="hljs-variable">widthAlignment</span> != <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 2. (可选) 对齐视频宽。</span></li><li>   <span class="hljs-variable">width</span> = (<span class="hljs-variable">width</span> + <span class="hljs-variable">widthAlignment</span> - <span class="hljs-number">1</span>) / <span class="hljs-variable">widthAlignment</span> * <span class="hljs-variable">widthAlignment</span>;</li><li>}</li><li><span class="hljs-comment">// 3. 确认视频宽处在可支持宽范围内。</span></li><li><span class="hljs-variable">OH_AVRange</span> <span class="hljs-variable">widthRange</span> = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoWidthRange</span>(<span class="hljs-variable">capability</span>, &amp;<span class="hljs-title class_">widthRange</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">widthRange</span>.<span class="hljs-variable">maxVal</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">width</span> &lt; <span class="hljs-title class_">widthRange</span>.<span class="hljs-title class_">minVal</span> || <span class="hljs-title class_">width</span> &gt; <span class="hljs-variable">widthRange</span>.<span class="hljs-variable">maxVal</span>) {</li><li>   <span class="hljs-comment">// 4. (可选) 调整视频宽。</span></li><li>   <span class="hljs-variable">width</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">min</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">max</span>(<span class="hljs-title class_">width</span>, <span class="hljs-title class_">widthRange</span>.<span class="hljs-title class_">minVal</span>), <span class="hljs-title class_">widthRange</span>.<span class="hljs-title class_">maxVal</span>);</li><li>}</li><li><span class="hljs-comment">// 5. 基于视频宽，获取可选视频高的范围。</span></li><li><span class="hljs-variable">OH_AVRange</span> <span class="hljs-variable">heightRange</span> = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoHeightRangeForWidth</span>(<span class="hljs-variable">capability</span>, <span class="hljs-variable">width</span>, &amp;<span class="hljs-title class_">heightRange</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">heightRange</span>.<span class="hljs-variable">maxVal</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 6. 从可选高度范围中挑选合适的高度配置。</span></li></ol></pre></div></div>     <p>已知视频高度，可以按照以下示例找到正确的尺寸配置。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">height</span> = <span class="hljs-number">1080</span>;</li><li><span class="hljs-variable">OH_AVCapability</span> *<span class="hljs-variable">capability</span> = <span class="hljs-title function_">OH_AVCodec_GetCapability</span>(<span class="hljs-variable">OH_AVCODEC_MIMETYPE_VIDEO_AVC</span>, <span class="hljs-keyword">true</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">capability</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认视频高符合高对齐要求。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">heightAlignment</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoHeightAlignment</span>(<span class="hljs-variable">capability</span>, &amp;<span class="hljs-title class_">heightAlignment</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">heightAlignment</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">height</span> % <span class="hljs-variable">heightAlignment</span> != <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 2. (可选) 对齐视频高。</span></li><li>   <span class="hljs-variable">height</span> = (<span class="hljs-variable">height</span> + <span class="hljs-variable">heightAlignment</span> - <span class="hljs-number">1</span>) / <span class="hljs-variable">heightAlignment</span> * <span class="hljs-variable">heightAlignment</span>;</li><li>}</li><li><span class="hljs-comment">// 3. 确认视频高处在可支持高范围内。</span></li><li><span class="hljs-variable">OH_AVRange</span> <span class="hljs-variable">heightRange</span> = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoHeightRange</span>(<span class="hljs-variable">capability</span>, &amp;<span class="hljs-title class_">heightRange</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">heightRange</span>.<span class="hljs-variable">maxVal</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">height</span> &lt; <span class="hljs-title class_">heightRange</span>.<span class="hljs-title class_">minVal</span> || <span class="hljs-title class_">height</span> &gt; <span class="hljs-variable">heightRange</span>.<span class="hljs-variable">maxVal</span>) {</li><li>   <span class="hljs-comment">// 4. (可选) 调整视频高。</span></li><li>   <span class="hljs-variable">height</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">min</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">max</span>(<span class="hljs-title class_">height</span>, <span class="hljs-title class_">heightRange</span>.<span class="hljs-title class_">minVal</span>), <span class="hljs-title class_">heightRange</span>.<span class="hljs-title class_">maxVal</span>);</li><li>}</li><li><span class="hljs-comment">// 5. 基于视频高，获取可选视频宽的范围。</span></li><li><span class="hljs-variable">OH_AVRange</span> <span class="hljs-variable">widthRange</span> = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVCapability_GetVideoWidthRangeForHeight</span>(<span class="hljs-variable">capability</span>, <span class="hljs-variable">height</span>, &amp;<span class="hljs-title class_">widthRange</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span> || <span class="hljs-variable">widthRange</span>.<span class="hljs-variable">maxVal</span> &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 6. 从可选宽度范围中挑选合适的宽度配置。</span></li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置正确的视频帧率">设置正确的视频帧率<i class="anchor-icon anchor-icon-link" anchorid="设置正确的视频帧率" tips="复制节点链接"></i></h3>          <p>视频编解码的帧率受编解码器的每秒编解码能力和协议级别的每秒处理能力限制。例如，H.264的AVC_LEVEL_51限定最大每秒宏块数目为983040个。</p>     <p>根据视频的宽度和高度，计算最大帧率的公式如下。</p>     <p><span><img originheight="115" originwidth="797" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114422.67793827282127655371053634225298:50001231000000:2800:5102F08EEB119E1E28F4B6352297374D2977E1BE0B1BDA0CCF4570C92B543367.png" width="797" height="115"></span></p>     <p>MaxMBsPerSecondLevelLimits表示协议限定的编解码器最大每秒宏块数，MaxMBsPerSecondSubmit表示编解码器上报的最大每秒宏块数，实际能力取这两者的最小值。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.13.6.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.13.6.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoFrameRateRange</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器支持的帧率的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoFrameRateRangeForSize</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器在给定图像尺寸情况下的帧率的范围。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_AreVideoSizeAndFrameRateSupported</td>         <td class="cellrowborder" valign="top" width="50%">校验视频编解码器是否支持视频大小和帧率的特定组合。</td>        </tr>             </tbody></table></div>     </div>     <p>有帧率目标需求时，校验帧率是否在可选范围内。示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> frameRate = <span class="hljs-number">120</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 获取支持的帧率范围。</span></li><li>OH_AVRange frameRateRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetVideoFrameRateRange</span>(capability, &amp;frameRateRange);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || frameRateRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 判断是否在可选帧率范围内。</span></li><li><span class="hljs-type">bool</span> isSupported = frameRate &gt;= frameRateRange.minVal &amp;&amp; frameRate &lt;= frameRateRange.maxVal;</li></ol></pre></div></div>     <p>根据待配置的尺寸选择合适的帧率配置，示例代码如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int32_t</span> width = <span class="hljs-number">1920</span>;</li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int32_t</span> height = <span class="hljs-number">1080</span>;</li><li><span class="hljs-type">int32_t</span> frameRate = <span class="hljs-number">120</span>;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 确认待配置尺寸是否能达到理想帧率。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_AreVideoSizeAndFrameRateSupported</span>(capability, width, height, frameRate);</li><li><span class="hljs-keyword">if</span> (!isSupported) {</li><li>   <span class="hljs-comment">// 2. 基于待配置视频尺寸，查询支持的帧率范围，并基于查询到的帧率调整待配置帧率。</span></li><li>   OH_AVRange frameRateRange = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};</li><li>   <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetVideoFrameRateRangeForSize</span>(capability, width, height, &amp;frameRateRange);</li><li>   <span class="hljs-keyword">if</span> (ret != AV_ERR_OK || frameRateRange.maxVal &lt;= <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// 异常处理。</span></li><li>   }</li><li>   frameRate = std::<span class="hljs-built_in">min</span>(std::<span class="hljs-built_in">max</span>(frameRate, frameRateRange.minVal), frameRateRange.maxVal);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 3. 配置尺寸和帧率参数。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, width, height);</li><li><span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetDoubleValue</span>(format, OH_MD_KEY_FRAME_RATE, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">double</span>&gt;(frameRate))) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="设置正确的视频像素格式信息">设置正确的视频像素格式信息<i class="anchor-icon anchor-icon-link" anchorid="设置正确的视频像素格式信息" tips="复制节点链接"></i></h3>          <p>视频像素格式指示的编码输入图像或解码输出图像的像素排布方式，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avformat-h#oh_avpixelformat" target="_blank">OH_AVPixelFormat</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.14.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.14.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetVideoSupportedPixelFormats</td>         <td class="cellrowborder" valign="top" width="50%">获取当前视频编解码器支持的像素格式。</td>        </tr>             </tbody></table></div>     </div>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> OH_AVPixelFormat DEFAULT_PIXELFORMAT = AV_PIXEL_FORMAT_NV12;</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 获取当前视频编解码器支持的像素格式。</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> *pixFormats = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">uint32_t</span> pixFormatNum = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVCapability_GetVideoSupportedPixelFormats</span>(capability, &amp;pixFormats, &amp;pixFormatNum);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK || pixFormats == <span class="hljs-literal">nullptr</span> || pixFormatNum == <span class="hljs-number">0</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 2. 校验是否支持对应像素格式。</span></li><li><span class="hljs-type">bool</span> isMatched = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pixFormatNum; i++) {</li><li>   <span class="hljs-keyword">if</span> (pixFormats[i] == DEFAULT_PIXELFORMAT) {</li><li>      isMatched = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>   }</li><li>}</li><li><span class="hljs-keyword">if</span> (!isMatched) {</li><li>   <span class="hljs-comment">// 3. 替换其他像素格式输入或选择其他编解码器。</span></li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="查询编解码特性支持情况并获取特性属性信息">查询编解码特性支持情况并获取特性属性信息<i class="anchor-icon anchor-icon-link" anchorid="查询编解码特性支持情况并获取特性属性信息" tips="复制节点链接"></i></h3>          <p>编解码特性是指在特定编解码场景中使用的可选特性，例如视频编码场景的时域可分级编码、 低时延编解码等。具体请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcapability-h#oh_avcapabilityfeature" target="_blank">OH_AVCapabilityFeature</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.15.3.1.3.1.1" valign="top" width="50%">接口</th>         <th align="left" class="cellrowborder" id="mcps1.3.15.3.1.3.1.2" valign="top" width="50%">功能描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_IsFeatureSupported</td>         <td class="cellrowborder" valign="top" width="50%">确认当前编解码器是否支持给定的特性。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">OH_AVCapability_GetFeatureProperties</td>         <td class="cellrowborder" valign="top" width="50%">获取当前编解码器支持的指定特性的属性。</td>        </tr>             </tbody></table></div>     </div>     <p>查询H.264编码器是否支持长期参考帧特性，示例如下。</p>     <div _ngcontent-wog-c106="" class="highlight-div"><div _ngcontent-wog-c106="" class="highlight-div-header"><div _ngcontent-wog-c106="" class="highlight-div-header-left"><div _ngcontent-wog-c106="" class="handle-button expand-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wog-c106="" class="highlight-div-header-right"><div _ngcontent-wog-c106="" class="handle-button ai-button"></div><div _ngcontent-wog-c106="" class="handle-button line-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wog-c106="" class="handle-button theme-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wog-c106="" class="handle-button copy-button"><div _ngcontent-wog-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wog-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int32_t</span> NEEDED_LTR_NUM = <span class="hljs-number">2</span>;</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>);</li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-keyword">if</span> (capability == <span class="hljs-literal">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 1. 查询是否支持长期参考帧特性。</span></li><li><span class="hljs-type">bool</span> isSupported = <span class="hljs-built_in">OH_AVCapability_IsFeatureSupported</span>(capability,VIDEO_ENCODER_LONG_TERM_REFERENCE);</li><li><span class="hljs-keyword">if</span> (isSupported) {</li><li>   <span class="hljs-comment">// 2. 查询支持的长期参考帧个数。</span></li><li>   OH_AVFormat *properties = <span class="hljs-built_in">OH_AVCapability_GetFeatureProperties</span>(capability, VIDEO_ENCODER_LONG_TERM_REFERENCE);</li><li>   <span class="hljs-keyword">if</span> (properties == <span class="hljs-literal">nullptr</span>) {</li><li>      <span class="hljs-comment">// 异常处理。</span></li><li>   }</li><li>   <span class="hljs-type">int32_t</span> maxLTRCount = <span class="hljs-number">-1</span>;</li><li>   <span class="hljs-type">bool</span> ret = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(properties, OH_FEATURE_PROPERTY_KEY_VIDEO_ENCODER_MAX_LTR_FRAME_COUNT, &amp;maxLTRCount);</li><li>   <span class="hljs-keyword">if</span> (ret &amp;&amp; maxLTRCount &gt;= NEEDED_LTR_NUM) {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_VIDEO_ENCODER_LTR_FRAME_COUNT, NEEDED_LTR_NUM)) {</li><li>         <span class="hljs-comment">// 异常处理。</span></li><li>      }</li><li>   }</li><li>}</li><li><span class="hljs-comment">// 3. 编码器创建和配置。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_VideoEncoder_Configure</span>(videoEnc, format) != AV_ERR_OK) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>