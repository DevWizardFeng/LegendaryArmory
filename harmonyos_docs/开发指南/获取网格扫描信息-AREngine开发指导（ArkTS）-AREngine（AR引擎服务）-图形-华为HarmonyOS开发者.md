<h1 _ngcontent-mbd-c119="" class="doc-title ng-star-inserted" title="获取网格扫描信息"> 获取网格扫描信息 </h1>

<div _ngcontent-mbd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section19329542123512">概要<i class="anchor-icon anchor-icon-link" anchorid="section19329542123512" tips="复制节点链接"></i></h2>          <p>从5.1.0(18)开始，AR Engine支持获取网格扫描信息能力。</p>     <p>本章节介绍如何获取目标物体的网格（mesh）扫描数据信息，通过学习本章节，可以检测当前环境中的自由曲面，并在应用中处理这些曲面信息。</p>     <div class="fignone">      <span class="figcap"><b>图1 </b>环境网格扫描示意图</span>      <br><span><img originheight="657" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114356.56194034341623645917095382829566:50001231000000:2800:753BDF05D2ADF82392A6DEEF3A2FA925D23AD5538BB61DCFC7A071348ECC00FA.png" width="318" height="657"></span>     </div>     <p>本章节涉及的AR Engine能力如下：</p>     <ul>      <li>运动跟踪能力</li>      <li>环境跟踪能力（平面检测）</li>      <li>命中检测能力</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="section4701164061710">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section4701164061710" tips="复制节点链接"></i></h2>          <p>网格扫描主要依赖<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section81184417712" target="_blank">ARSceneMesh</a>，以下接口为AR网格扫描相关接口。详细接口和说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-arkts-api" target="_blank">AR Engine API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="49.94%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50.06%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section15211205153115" target="_blank">ARSceneMesh.getVertices</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取场景网格中的顶点坐标数据。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section4793111183211" target="_blank">ARSceneMesh.getVertexNormals</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取场景网格中的顶点法线坐标数据。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section19221187183218" target="_blank">ARSceneMesh.getTriangleIndices</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取场景网格中的三角形索引数据。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section625851110329" target="_blank">ARSceneMesh.release</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>释放环境网格数据对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section20353182861218" target="_blank">ARFrame.hitTest</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>根据相机投射光线，获取预览区域中的像素坐标（pixelX和pixelY）来确定射线方向，然后检测这个射线在平面或点云中是否有交点。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1864219177109" target="_blank">ARHitResult.getHitPose</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取交点位姿。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section727122311104" target="_blank">ARHitResult.getTrackable</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>获取被命中的可追踪对象。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section12541329171017" target="_blank">ARHitResult.createAnchor</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>在交点（intersection）创建一个锚点。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section1690193413100" target="_blank">ARHitResult.release</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>释放命中检测结果对象占用的内存。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section5278038164917" target="_blank">ARPose.getMatrix</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>将位姿数据转换为一个4x4的矩阵。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="49.94%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arengine#section22831038104913" target="_blank">ARPose.release</a></p></td>         <td class="cellrowborder" valign="top" width="50.06%">          <p>释放位姿对象占用的内存。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section528511529350">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section528511529350" tips="复制节点链接"></i></h2>          <p>AR Engine仅输出识别到的平面数据。为便于用户观察，开发者可使用AGP（Ark Graphics Platform）渲染引擎或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>绘制识别的平面。关于AGP的介绍可以查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkgraphics3d-overview" target="_blank">ArkGraphics 3D简介</a>和<a href="https://gitcode.com/openharmony/graphic_graphic_3d" target="_blank">AGP引擎</a>。</p>     <p>对于使用ArkTS的任何AR应用，首先需要创建一个AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>，用于管理AR Engine的系统状态。AR会话<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section12681656121519" target="_blank">ARViewContext</a>的创建可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-arsession">管理AR会话</a>章节。</p>    </div>    <div class="tiledSection">     <h3 id="section371615443814" class="firsth2">导入模块<i class="anchor-icon anchor-icon-link" anchorid="section371615443814" tips="复制节点链接"></i></h3>          <div class="p">      网格扫描能力所需要导入的模块如下：      <div _ngcontent-mbd-c106="" class="highlight-div"><div _ngcontent-mbd-c106="" class="highlight-div-header"><div _ngcontent-mbd-c106="" class="highlight-div-header-left"><div _ngcontent-mbd-c106="" class="handle-button expand-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbd-c106="" class="highlight-div-header-right"><div _ngcontent-mbd-c106="" class="handle-button ai-button"></div><div _ngcontent-mbd-c106="" class="handle-button line-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbd-c106="" class="handle-button theme-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbd-c106="" class="handle-button copy-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbd-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { arEngine, <span class="hljs-title class_">ARView</span>, arViewController } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AREngine'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span>, <span class="hljs-title class_">Scene</span>, <span class="hljs-title class_">Vec3</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics3D'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section104031814145815">定义变量<i class="anchor-icon anchor-icon-link" anchorid="section104031814145815" tips="复制节点链接"></i></h3>          <p id="ZH-CN_TOPIC_0000002329786834__p1151639175819">定义变量hitAnchorList存储放置物体处的锚点信息、hitPoseList存储放置物体处的位姿信息和statusBarHeight设备状态栏高度。</p>     <div class="p" id="ZH-CN_TOPIC_0000002329786834__p464319208490">      用户点击设备的坐标和显示预览流的坐标不一致，预览流的窗口略小于设备屏幕，因此需要减去设备状态栏高度以获取准确的点击坐标。      <div _ngcontent-mbd-c106="" class="highlight-div"><div _ngcontent-mbd-c106="" class="highlight-div-header"><div _ngcontent-mbd-c106="" class="highlight-div-header-left"><div _ngcontent-mbd-c106="" class="handle-button expand-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbd-c106="" class="highlight-div-header-right"><div _ngcontent-mbd-c106="" class="handle-button ai-button"></div><div _ngcontent-mbd-c106="" class="handle-button line-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbd-c106="" class="handle-button theme-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbd-c106="" class="handle-button copy-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbd-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" id="ZH-CN_TOPIC_0000002329786834__screen26151344631" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">frame</span>: arEngine.<span class="hljs-property">ARFrame</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hitAnchorList</span>: arEngine.<span class="hljs-property">ARAnchor</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">hitPoseList</span>: <span class="hljs-title class_">Vec3</span>[] = [];</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">statusBarHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section16190914161">显示预览流<i class="anchor-icon anchor-icon-link" anchorid="section16190914161" tips="复制节点链接"></i></h3>          <p>首先初始化AR会话和AR场景，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-arsession#section3391814131611">初始化AR会话和AR场景</a>章节。</p>     <div _ngcontent-mbd-c106="" class="highlight-div"><div _ngcontent-mbd-c106="" class="highlight-div-header"><div _ngcontent-mbd-c106="" class="highlight-div-header-left"><div _ngcontent-mbd-c106="" class="handle-button expand-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbd-c106="" class="highlight-div-header-right"><div _ngcontent-mbd-c106="" class="handle-button ai-button"></div><div _ngcontent-mbd-c106="" class="handle-button line-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbd-c106="" class="handle-button theme-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbd-c106="" class="handle-button copy-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">ARMeshBuilder</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-title function_">ARMesh</span>();</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ARMesh</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">arContext</span>?: <span class="hljs-title class_">arViewController</span>.<span class="hljs-title class_">ARViewContext</span> = <span class="hljs-variable">undefined</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">Context</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">RelativeContainer</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">arContext</span>) {</li><li>          <span class="hljs-title function_">ARView</span>({ <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">arContext</span> })</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">alignRules</span>({</li><li>              <span class="hljs-variable">center</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Center</span> },</li><li>              <span class="hljs-variable">middle</span>: { <span class="hljs-variable">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-variable">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">Center</span> }</li><li>            })</li><li>            .<span class="hljs-title function_">onClick</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">objectCollisionDetection</span>(<span class="hljs-variable">event</span>);</li><li>            })</li><li>        }</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onAppear</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initARView</span>();</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getAvoidArea</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onWillDisappear</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">stopARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onShown</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">resumeARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">onHidden</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">pauseARView</span>();</li><li>    })</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-keyword">true</span>)</li><li>    .<span class="hljs-title function_">hideBackButton</span>(<span class="hljs-keyword">true</span>)</li><li>    .<span class="hljs-title function_">hideToolBar</span>(<span class="hljs-keyword">true</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取用户点击坐标，获取碰撞检测结果</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">objectCollisionDetection</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">ClickEvent</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>: <span class="hljs-title class_">number</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(<span class="hljs-variable">event</span>.<span class="hljs-variable">windowX</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">y</span>: <span class="hljs-title class_">number</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(<span class="hljs-variable">event</span>.<span class="hljs-variable">windowY</span>) - <span class="hljs-variable">statusBarHeight</span>;</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">Get</span> <span class="hljs-variable">onclick</span> <span class="hljs-variable">position</span>, <span class="hljs-variable">x</span>: ${<span class="hljs-variable">x</span>} <span class="hljs-variable">y</span>: ${<span class="hljs-variable">y</span>}.`);</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARHitResult</span>[] = <span class="hljs-variable">frame</span>.<span class="hljs-title function_">hitTest</span>(<span class="hljs-variable">x</span>, <span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">The</span> <span class="hljs-variable">hitResult</span> <span class="hljs-variable">size</span> <span class="hljs-keyword">is</span>: ${<span class="hljs-variable">result</span>.<span class="hljs-variable">length</span>}.`);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable">result</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">result</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">hitResult</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARHitResult</span> = <span class="hljs-variable">result</span>[<span class="hljs-variable">i</span>];</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">distance</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">hitResult</span>.<span class="hljs-variable">distance</span>;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">distance</span> &lt;= <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">hitAnchor</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARAnchor</span> = <span class="hljs-variable">hitResult</span>.<span class="hljs-title function_">createAnchor</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pos</span>: <span class="hljs-title class_">Vec3</span> = <span class="hljs-variable">hitAnchor</span>.<span class="hljs-title function_">getPose</span>().<span class="hljs-variable">translation</span>;</li><li>
</li><li>        <span class="hljs-variable">hitPoseList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">pos</span>);</li><li>        <span class="hljs-variable">hitAnchorList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">hitAnchor</span>);</li><li>
</li><li>      }</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting hit result.'</span>);  <span class="hljs-comment">// 成功获取碰撞目标</span></li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">get</span> <span class="hljs-variable">hitResults</span>. <span class="hljs-variable">Code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initARView</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">Scene</span>.<span class="hljs-title function_">load</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable">async</span> (<span class="hljs-variable">scene</span>: <span class="hljs-title class_">Scene</span>) =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">viewContext</span>: <span class="hljs-title class_">arViewController</span>.<span class="hljs-title class_">ARViewContext</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">arViewController</span>.<span class="hljs-title function_">ARViewContext</span>();</li><li>      <span class="hljs-variable">viewContext</span>.<span class="hljs-variable">scene</span> = <span class="hljs-variable">scene</span>;</li><li>      <span class="hljs-variable">viewContext</span>.<span class="hljs-variable">callback</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ARViewCallbackImpl</span>();</li><li>      <span class="hljs-variable">viewContext</span>.<span class="hljs-variable">config</span> = {</li><li>        <span class="hljs-keyword">type</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARType</span>.<span class="hljs-title class_">WORLD</span>,</li><li>        <span class="hljs-variable">planeFindingMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARPlaneFindingMode</span>.<span class="hljs-title class_">HORIZONTAL_AND_VERTICAL</span>,</li><li>        <span class="hljs-variable">powerMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARPowerMode</span>.<span class="hljs-title class_">NORMAL</span>,</li><li>        <span class="hljs-variable">semanticMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARSemanticMode</span>.<span class="hljs-title class_">NONE</span>,</li><li>        <span class="hljs-variable">poseMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARPoseMode</span>.<span class="hljs-title class_">GRAVITY</span>,</li><li>        <span class="hljs-variable">depthMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARDepthMode</span>.<span class="hljs-title class_">AUTOMATIC</span>,</li><li>        <span class="hljs-variable">meshMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARMeshMode</span>.<span class="hljs-title class_">ENABLE</span>,  <span class="hljs-comment">// 开启mesh</span></li><li>        <span class="hljs-variable">focusMode</span>: <span class="hljs-title class_">arEngine</span>.<span class="hljs-title class_">ARFocusMode</span>.<span class="hljs-title class_">AUTO</span></li><li>      }</li><li>      <span class="hljs-variable">viewContext</span>.<span class="hljs-keyword">init</span>().<span class="hljs-title function_">then</span>(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">arContext</span> = <span class="hljs-variable">viewContext</span>;</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in initializing ARView.'</span>);</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-keyword">init</span> <span class="hljs-variable">ARView</span>. <span class="hljs-variable">Code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`);</li><li>      })</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 获取屏幕上减去状态栏的真实高度（预览流高度）</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getAvoidArea</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">avoidAreaType</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaType</span> = <span class="hljs-variable">window</span>.<span class="hljs-variable">AvoidAreaType</span>.<span class="hljs-variable">TYPE_SYSTEM</span>;</li><li>    <span class="hljs-variable">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>) =&gt; {</li><li>      <span class="hljs-comment">// 获取顶部状态栏高度</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">avoidArea1</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidArea</span> = <span class="hljs-variable">data</span>.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable">avoidAreaType</span>);</li><li>      <span class="hljs-variable">statusBarHeight</span> = <span class="hljs-variable">avoidArea1</span>.<span class="hljs-variable">topRect</span>.<span class="hljs-variable">height</span>;</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">The</span> <span class="hljs-variable">statusBarHeight</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">statusBarHeight</span>}.`);</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">obtain</span> <span class="hljs-variable">the</span> <span class="hljs-variable">window</span>. <span class="hljs-variable">Code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">stopARView</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">resumeARView</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">pauseARView</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section15735965114">获取mesh网格数据<i class="anchor-icon anchor-icon-link" anchorid="section15735965114" tips="复制节点链接"></i></h3>          <div class="p">      调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section9396615174614" target="_blank">ARViewCallback</a>，使用其中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arengine-api-arviewcontroller#section52341758194715" target="_blank">onFrameUpdate</a>方法进行帧数据更新，获取mesh网格数据。      <div _ngcontent-mbd-c106="" class="highlight-div"><div _ngcontent-mbd-c106="" class="highlight-div-header"><div _ngcontent-mbd-c106="" class="highlight-div-header-left"><div _ngcontent-mbd-c106="" class="handle-button expand-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbd-c106="" class="highlight-div-header-right"><div _ngcontent-mbd-c106="" class="handle-button ai-button"></div><div _ngcontent-mbd-c106="" class="handle-button line-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbd-c106="" class="handle-button theme-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbd-c106="" class="handle-button copy-button"><div _ngcontent-mbd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbd-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARViewCallbackImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">arViewController.ARViewCallback</span> {</li><li>  <span class="hljs-title function_">onAnchorAdd</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onAnchorUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">node</span>: <span class="hljs-title class_">Node</span>, <span class="hljs-attr">anchor</span>: arEngine.<span class="hljs-property">ARAnchor</span>): <span class="hljs-built_in">void</span> {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onFrameUpdate</span>(<span class="hljs-attr">ctx</span>: arViewController.<span class="hljs-property">ARViewContext</span>, <span class="hljs-attr">sysBootTs</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">planeVertices</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">vertexNormals</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">triangleIndices</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!ctx.<span class="hljs-property">session</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: arEngine.<span class="hljs-property">ARSession</span> | <span class="hljs-literal">undefined</span> = ctx.<span class="hljs-property">session</span>;</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      frame = session.<span class="hljs-title function_">getFrame</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">camera</span>: arEngine.<span class="hljs-property">ARCamera</span> = frame.<span class="hljs-title function_">getCamera</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneMesh</span>: arEngine.<span class="hljs-property">ARSceneMesh</span> = frame.<span class="hljs-title function_">acquireSceneMesh</span>();</li><li>
</li><li>      <span class="hljs-keyword">if</span> (camera.<span class="hljs-property">state</span> === arEngine.<span class="hljs-property">ARTrackingState</span>.<span class="hljs-property">TRACKING</span>) {</li><li>        planeVertices = <span class="hljs-title function_">arrayBufferFloat32ToNumber</span>(sceneMesh.<span class="hljs-title function_">getVertices</span>());</li><li>        triangleIndices = <span class="hljs-title function_">arrayBufferInt32ToNumber</span>(sceneMesh.<span class="hljs-title function_">getTriangleIndices</span>());</li><li>        vertexNormals = <span class="hljs-title function_">arrayBufferFloat32ToNumber</span>(sceneMesh.<span class="hljs-title function_">getVertexNormals</span>());</li><li>
</li><li>        <span class="hljs-comment">// 输出mesh数据</span></li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The mesh data planeVertices is: <span class="hljs-subst">${planeVertices}</span>, triangleIndices is: <span class="hljs-subst">${triangleIndices}</span>,</span></li><li><span class="hljs-string">          vertexNormals is: <span class="hljs-subst">${vertexNormals}</span>.`</span>);</li><li>      }</li><li>
</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to acquire depth information. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div>     </div>    </div>    <div class="tiledSection">     <h3 id="section7935247151110">获取网格扫描信息的自定义方法<i class="anchor-icon anchor-icon-link" anchorid="section7935247151110" tips="复制节点链接"></i></h3>          <p>自定义数据转换方法arrayBufferFloat32ToNumber及arrayBufferInt32ToNumber可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arengine-arraybuffer-info">数据类型转换说明</a>。</p>    </div>   </div>   <div></div></div>