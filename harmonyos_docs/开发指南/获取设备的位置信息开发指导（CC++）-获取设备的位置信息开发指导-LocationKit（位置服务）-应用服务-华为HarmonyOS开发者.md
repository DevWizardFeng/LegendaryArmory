<h1 _ngcontent-ekj-c119="" class="doc-title ng-star-inserted" title="获取设备的位置信息开发指导（C/C++）"> 获取设备的位置信息开发指导（C/C++） </h1>

<div _ngcontent-ekj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2><p>开发者可以调用OpenHarmony位置相关接口，监听设备的位置变化。</p> </div> <div class="tiledSection"><h2 id="函数说明">函数说明<i class="anchor-icon anchor-icon-link" anchorid="函数说明" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%"><p>名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>OH_Location_IsLocatingEnabled(bool* enabled)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>查询位置开关是否开启。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_Location_StartLocating(const Location_RequestConfig* requestConfig)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>启动定位并订阅位置变化。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>Location_ResultCode OH_Location_StopLocating(const Location_RequestConfig* requestConfig)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>停止定位并取消订阅位置变化。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationInfo_GetBasicInfo(Location_Info* location)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>从定位结果中获取基本信息，如经纬度、海拔、速度等信息。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationInfo_GetAdditionalInfo(Location_Info* location, char* additionalInfo, uint32_t length)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>从定位结果中获取附加信息。附加信息是一个JSON格式的字符串。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_Location_CreateRequestConfig(void)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建一个位置请求参数结构体实例。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_Location_DestroyRequestConfig(Location_RequestConfig* requestConfig)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁位置请求参数实例并回收内存。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationRequestConfig_SetUseScene(Location_RequestConfig* requestConfig, Location_UseScene useScene)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置发起定位时的用户活动场景。</p> <p>如果设置了useScene，则powerConsumptionScene无效。</p> <p>如果未设置useScene，且设置了powerConsumptionScene，则该参数生效。</p> <p>如果两个参数都不设置，则默认useScene为LOCATION_USE_SCENE_DAILY_LIFE_SERVICE,powerConsumptionScene参数无效。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationRequestConfig_SetPowerConsumptionScene(Location_RequestConfig* requestConfig, Location_PowerConsumptionScene powerConsumptionScene)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置发起定位时的功耗场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationRequestConfig_SetInterval(Location_RequestConfig* requestConfig, int interval)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置定位结果上报时间间隔。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>OH_LocationRequestConfig_SetCallback(Location_RequestConfig* requestConfig, Location_InfoCallback callback, void* userData)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>设置用于接收位置上报的回调函数。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2><ol><li><p>新建一个Native C++工程。</p> <p><span><img originheight="665" originwidth="1331" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114546.51387286860197113217811286041202:50001231000000:2800:D59329DF586ABAE11D2AB1156E1A7404C82E56EA3F302848D10305C789C48E86.png" width="920" height="459.6543951915853"></span></p> </li><li><p>获取设备的位置信息，需要有位置权限，位置权限申请的方法和步骤见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-permission-guidelines">申请位置权限开发指导</a>。</p> </li><li><p>CMakeLists.txt文件中引入动态依赖库。</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC libace_napi.z.so)</li><li>target_link_libraries(entry PUBLIC libhilog_ndk.z.so)</li><li>target_link_libraries(entry PUBLIC liblocation_ndk.so)</li></ol></pre></div></div> </li><li><p>在napi_init.cpp文件中编码，首先导入模块。</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"LocationKit/oh_location.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"LocationKit/oh_location_type.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span></li></ol></pre></div></div> </li><li><p>调用获取位置接口之前需要先判断位置开关是否打开。</p> <p>查询当前位置开关状态，返回结果为布尔值，true代表位置开关开启，false代表位置开关关闭，示例代码如下：</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">OhLocationIsEnabled</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li> {</li><li>     <span class="hljs-type">bool</span> isEnabled = <span class="hljs-literal">false</span>;</li><li>     <span class="hljs-type">int</span> resultCode = OH_Location_IsLocatingEnabled(&amp;isEnabled);</li><li>     napi_value result = <span class="hljs-literal">NULL</span>;</li><li>     napi_get_boolean(env, isEnabled, &amp;result);</li><li>     <span class="hljs-keyword">return</span> result;</li><li> }</li><li> <span class="hljs-comment">// 在Init函数中补充接口。</span></li><li> EXTERN_C_START</li><li> <span class="hljs-type">static</span> napi_value <span class="hljs-title function_">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></li><li> {</li><li>     napi_property_descriptor desc[] = {</li><li>         {<span class="hljs-string">"ohLocationIsEnabled"</span>, <span class="hljs-literal">NULL</span>, OhLocationIsEnabled, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, napi_default, <span class="hljs-literal">NULL</span>},</li><li>     };</li><li>     napi_define_properties(env, exports, <span class="hljs-keyword">sizeof</span>(desc) / <span class="hljs-keyword">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>     <span class="hljs-keyword">return</span> exports;</li><li> }</li><li> EXTERN_C_END</li></ol></pre></div></div> </li><li><p>定位位置变化。</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义一个请求参数</span></li><li><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Location_RequestConfig</span> *<span class="hljs-title">g_requestConfig</span> =</span> <span class="hljs-literal">NULL</span>;</li><li><span class="hljs-type">void</span> *mydata = <span class="hljs-literal">NULL</span>;</li><li>
</li><li><span class="hljs-comment">// 定义一个回调函数用来接收位置信息</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">reportLocation</span><span class="hljs-params">(Location_Info* location, <span class="hljs-type">void</span>* userData)</span></li><li>{</li><li>    Location_BasicInfo baseInfo = OH_LocationInfo_GetBasicInfo(location);</li><li>    <span class="hljs-type">char</span> additionalInfo[<span class="hljs-number">1024</span>] = <span class="hljs-string">""</span>;</li><li>    Location_ResultCode result = OH_LocationInfo_GetAdditionalInfo(location, additionalInfo, <span class="hljs-keyword">sizeof</span>(additionalInfo));</li><li>    <span class="hljs-keyword">if</span> (mydata == userdata) {</li><li>        OH_LOG_INFO(LOG_APP, <span class="hljs-string">"userData is mydata"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 订阅位置信息</span></li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">OhLocationStartLocating</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    <span class="hljs-keyword">if</span> (g_requestConfig == <span class="hljs-literal">NULL</span>) {</li><li>        g_requestConfig = OH_Location_CreateRequestConfig();</li><li>    }</li><li>    OH_LocationRequestConfig_SetUseScene(g_requestConfig, LOCATION_USE_SCENE_NAVIGATION);</li><li>    OH_LocationRequestConfig_SetInterval(g_requestConfig, <span class="hljs-number">1</span>);</li><li>    mydata = (<span class="hljs-type">void</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-string">"mydata"</span>)); <span class="hljs-comment">// 用户自定义任意类型，callback 透传返回</span></li><li>    OH_LocationRequestConfig_SetCallback(g_requestConfig, reportLocation, mydata);</li><li>    OH_Location_StartLocating(g_requestConfig);</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">0</span>;</li><li>    napi_value result = <span class="hljs-literal">NULL</span>;</li><li>    napi_create_int32(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">//取消订阅位置信息， g_requestConfig要和订阅时传入的对象保持一致</span></li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">OhLocationStopLocating</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></li><li>{</li><li>    OH_Location_StopLocating(g_requestConfig);</li><li>    <span class="hljs-keyword">if</span> (g_requestConfig != <span class="hljs-literal">NULL</span>) {</li><li>        OH_Location_DestroyRequestConfig(g_requestConfig);</li><li>        g_requestConfig = <span class="hljs-literal">NULL</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(mydata);</li><li>    mydata = <span class="hljs-literal">NULL</span>;</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-number">0</span>;</li><li>    napi_value result = <span class="hljs-literal">NULL</span>;</li><li>    napi_create_int32(env, ret, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 在Init函数中补充接口。</span></li><li>EXTERN_C_START</li><li><span class="hljs-type">static</span> napi_value <span class="hljs-title function_">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></li><li>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"ohLocationStartLocating"</span>, <span class="hljs-literal">NULL</span>, OhLocationStartLocating, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, napi_default, <span class="hljs-literal">NULL</span>},</li><li>        {<span class="hljs-string">"ohLocationStopLocating"</span>, <span class="hljs-literal">NULL</span>, OhLocationStopLocating, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, napi_default, <span class="hljs-literal">NULL</span>},</li><li>    };</li><li>    napi_define_properties(env, exports, <span class="hljs-keyword">sizeof</span>(desc) / <span class="hljs-keyword">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre></div></div> </li><li><p>在types/libentry路径下index.d.ts文件中引入Napi接口。</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li> export <span class="hljs-type">const</span> ohLocationIsEnabled: () =&gt; boolean;</li><li> export <span class="hljs-type">const</span> ohLocationStartLocating: () =&gt; number;</li><li> export <span class="hljs-type">const</span> ohLocationStopLocating: () =&gt; number;</li></ol></pre></div></div> </li><li><p>删除Index.ets中的已废弃函数。</p> <div _ngcontent-ekj-c106="" class="highlight-div"><div _ngcontent-ekj-c106="" class="highlight-div-header"><div _ngcontent-ekj-c106="" class="highlight-div-header-left"><div _ngcontent-ekj-c106="" class="handle-button expand-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekj-c106="" class="highlight-div-header-right"><div _ngcontent-ekj-c106="" class="handle-button ai-button"></div><div _ngcontent-ekj-c106="" class="handle-button line-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekj-c106="" class="handle-button theme-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekj-c106="" class="handle-button copy-button"><div _ngcontent-ekj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekj-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li>.<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));</li><li>})</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>