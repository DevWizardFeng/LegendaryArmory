<h1 _ngcontent-ude-c119="" class="doc-title ng-star-inserted" title="视频编码"> 视频编码 </h1>

<div _ngcontent-ude-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以调用本模块的Native API接口，完成视频编码，即将未压缩的视频数据压缩成视频码流。</p>    <p>具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>    <p>当前支持的编码能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#视频编码">AVCodec支持的格式</a>。</p>    <p>如果需要对HDRVivid视频进行编码，需要配置MimeType为H265 (OH_AVCODEC_MIMETYPE_VIDEO_HEVC)，本功能从API version 11开始支持。</p>    <p>视频编码支持以下能力：</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.1" valign="top" width="50%">支持的能力</th>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.2" valign="top" width="50%">使用简述</th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">运行时配置编码器参数，包括帧率、码率、QPMin/QPMax</td>        <td class="cellrowborder" valign="top" width="50%">通过调用OH_VideoEncoder_SetParameter()配置， 具体可参考下文中：Surface模式的步骤-9</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">随帧设置编码QPMin/QPMax</td>        <td class="cellrowborder" valign="top" width="50%">通过调用OH_VideoEncoder_RegisterParameterCallback()注册随帧参数回调时配置，具体可参考下文中：Surface模式的步骤-4</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">分层编码，LTR设置</td>        <td class="cellrowborder" valign="top" width="50%">具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding-temporal-scalability">时域可分层视频编码</a></td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">获取编码每帧平均量化参数（QPAverage）、平方误差（mseValue）</td>        <td class="cellrowborder" valign="top" width="50%">在配置回调函数OnNewOutputBuffer()时获取，具体可参考下文中：Surface模式的步骤-3</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">变分辨率</td>        <td class="cellrowborder" valign="top" width="50%">编码器支持输入图像分辨率发生变化。目前仅Surface模式支持且图像的宽、高不能超过OH_VideoEncoder_Configure接口配置的宽、高，具体可参考下文中：Surface模式的步骤-5</td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="限制约束">限制约束<i class="anchor-icon anchor-icon-link" anchorid="限制约束" tips="复制节点链接"></i></h2>          <ol>      <li>Buffer模式不支持10bit的图像数据。</li>      <li>由于硬件编码器资源有限，每个编码器在使用完毕后都必须调用OH_VideoEncoder_Destroy接口来销毁实例并释放资源。</li>      <li>Flush，Reset，Stop，Destroy在非回调线程中执行时，会等待所有回调执行完成后，将执行结果返回给开发者。</li>      <li>一旦调用Flush，Reset，Stop接口，会触发系统回收OH_AVBuffer，开发者不应对之前回调函数获取到的OH_AVBuffer继续进行操作。</li>      <li>Buffer模式和Surface模式使用方式一致的接口，所以只提供了Surface模式的示例。</li>      <li>在Buffer模式下，开发者通过输入回调函数OH_AVCodecOnNeedInputBuffer获取到OH_AVBuffer的指针实例后，必须通过调用OH_VideoEncoder_PushInputBuffer接口来通知系统该实例已被使用完毕。这样系统才能够将该实例里面的数据进行编码。如果开发者在调用OH_AVBuffer_GetNativeBuffer接口时获取到OH_NativeBuffer指针实例，并且该实例的生命周期超过了当前的OH_AVBuffer指针实例，那么需要进行一次数据的拷贝操作。在这种情况下，开发者需要自行管理新生成的OH_NativeBuffer实例的生命周期，确保其正确使用和释放。</li>      <li>为确保系统服务的持续可用性，当检测到应用存在异常实例占用行为时，系统将自动介入。开发者应注意：持续的实例管理不当可能导致进程被终止。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="surface输入与buffer输入">surface输入与buffer输入<i class="anchor-icon anchor-icon-link" anchorid="surface输入与buffer输入" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>两者的数据来源不同。</p></li>      <li>       <p>两者的适用场景不同：</p>       <ul>        <li>surface输入是指用OHNativeWindow来传递输入数据，可以与其他模块对接，例如相机模块。</li>        <li>buffer输入是指有一块预先分配好的内存区域，开发者需要将原始数据拷贝进这块内存区域中。更适用于从文件中读取视频数据等场景。</li>       </ul></li>      <li>       <p>在接口调用的过程中，两种方式的接口调用方式基本一致，但存在以下差异点：</p>       <ul>        <li>Buffer模式下，开发者通过OH_VideoEncoder_PushInputBuffer接口输入数据；Surface模式下，开发者应在编码器就绪前调用OH_VideoEncoder_GetSurface接口，获取OHNativeWindow用于传递视频数据。</li>        <li>Buffer模式下，开发者通过OH_AVBuffer中的attr传入结束flag，编码器读取到尾帧后，停止编码；Surface模式下，需要调用OH_VideoEncoder_NotifyEndOfStream接口通知编码器输入流结束。</li>       </ul></li>      <li>       <p>Surface模式的数据流转性能优于Buffer模式。</p></li>     </ol>     <p>两种模式的开发步骤详细说明请参考：<a href="/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式">Surface模式</a>和<a href="/consumer/cn/doc/harmonyos-guides/video-encoding#buffer模式">Buffer模式</a>。</p>    </div>    <div class="tiledSection">     <h2 id="状态机调用关系">状态机调用关系<i class="anchor-icon anchor-icon-link" anchorid="状态机调用关系" tips="复制节点链接"></i></h2>          <p>如下为状态机调用关系图：</p>     <p><span><img originheight="2505" originwidth="4128" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114431.40479946457251998628103005775520:50001231000000:2800:993E1B77692378689D15C59A3DF6B1074A1DFCF273A795C19D51EB94425B225D.png" width="920" height="558.2848837209302"></span></p>     <ol>      <li>       <p>有两种方式可以使编码器进入Initialized状态：</p>       <ul>        <li>初始创建编码器实例时，编码器处于Initialized状态。</li>        <li>任何状态下，调用OH_VideoEncoder_Reset接口，编码器将会移回Initialized状态。</li>       </ul></li>      <li>       <p>Initialized状态下，调用OH_VideoEncoder_Configure接口配置编码器，配置成功后编码器进入Configured状态。</p></li>      <li>       <p>Configured状态下，调用OH_VideoEncoder_Prepare()进入Prepared状态。</p></li>      <li>       <p>Prepared状态下，调用OH_VideoEncoder_Start接口使编码器进入Executing状态：</p>       <ul>        <li>处于Executing状态时，调用OH_VideoEncoder_Stop接口可以使编码器返回到Prepared状态。</li>       </ul></li>      <li>       <p>在极少数情况下，编码器可能会遇到错误并进入Error状态。编码器的错误传递，可以通过队列操作返回无效值或者抛出异常：</p>       <ul>        <li>Error状态下，可以调用OH_VideoEncoder_Reset接口将编码器移到Initialized状态；或者调用OH_VideoEncoder_Destroy接口移动到最后的Released状态。</li>       </ul></li>      <li>       <p>Executing 状态具有三个子状态：Flushed、Running和End-of-Stream：</p>       <ul>        <li>在调用了OH_VideoEncoder_Start接口之后，编码器立即进入Running子状态。</li>        <li>对于处于Executing状态的编码器，可以调用OH_VideoEncoder_Flush接口返回到Flushed子状态。</li>        <li>当待处理数据全部传递给编码器后，可以在input buffers队列中为最后一个入队的input buffer中添加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-info-h#oh_avcodecbufferflags" target="_blank">AVCODEC_BUFFER_FLAGS_EOS</a>标记，遇到这个标记时，编码器会转换为End-of-Stream子状态。在此状态下，编码器不再接受新的输入，但是仍然会继续生成输出，直到输出到达尾帧。</li>       </ul></li>      <li>       <p>使用完编码器后，必须调用OH_VideoEncoder_Destroy接口销毁编码器实例，使编码器进入Released状态。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h" target="_blank">API文档</a>。</p>     <p>如下为视频编码调用关系图：</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="3713" originwidth="4668" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114431.74694447597424644015738481166482:50001231000000:2800:CFA48918C62E248D122064CFD3AA5C25FFD13A0D4CA6CE5949816537D72C5191.png" width="920" height="731.7823479005998"></span></p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_venc.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="定义基础结构">定义基础结构<i class="anchor-icon anchor-icon-link" anchorid="定义基础结构" tips="复制节点链接"></i></h3>          <p>本部分示例代码按照C++17标准编写，仅作参考。开发者可以参考此部分，定义自己的buffer对象。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>编码器回调buffer的信息。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer): <span class="hljs-built_in">index</span>(index), <span class="hljs-built_in">buffer</span>(buffer), <span class="hljs-built_in">isValid</span>(<span class="hljs-literal">true</span>) {}</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint32_t</span> index, OH_AVFormat *parameter): <span class="hljs-built_in">index</span>(index), <span class="hljs-built_in">parameter</span>(parameter), <span class="hljs-built_in">isValid</span>(<span class="hljs-literal">true</span>) {}</li><li>    <span class="hljs-comment">// 回调buffer。</span></li><li>    OH_AVBuffer *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// Surface模式下，输入回调的随帧参数，需要注册随帧通路后使用。</span></li><li>    OH_AVFormat *parameter = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 回调buffer对应的index。</span></li><li>    <span class="hljs-type">uint32_t</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 判断当前buffer信息是否有效。</span></li><li>    <span class="hljs-type">bool</span> isValid = <span class="hljs-literal">true</span>;</li><li>};</li></ol></pre></div></div></li>      <li>       <p>编码输入输出队列。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodecBufferQueue</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-comment">// 将回调buffer的信息传入队列。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Enqueue</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">bufferInfo</span>);</li><li>        <span class="hljs-variable">cond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取回调buffer的信息。</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">Dequeue</span>(<span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">timeoutMs</span> = <span class="hljs-number">1000</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        (<span class="hljs-variable">void</span>)<span class="hljs-variable">cond_</span>.<span class="hljs-title function_">wait_for</span>(<span class="hljs-variable">lock</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-title class_">timeoutMs</span>), [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">bufferInfo</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空队列，之前的回调buffer设置为不可用。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Flush</span>()</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-keyword">while</span> (!<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>            <span class="hljs-comment">// Flush、Stop、Reset、Destroy操作之后，之前回调的buffer信息设置为无效。</span></li><li>            <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        }</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">mutex_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">cond_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;&gt; <span class="hljs-title class_">bufferQueue_</span>;</li><li>};</li></ol></pre></div></div></li>      <li>       <p>全局变量。</p>       <p>仅作参考，可以根据实际情况将其封装到对象中。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 视频帧宽度。</span></li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">320</span>;</li><li><span class="hljs-comment">// 视频帧高度。</span></li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">240</span>;</li><li><span class="hljs-comment">// 视频像素格式。</span></li><li> OH_AVPixelFormat pixelFormat = AV_PIXEL_FORMAT_NV12;</li><li><span class="hljs-comment">// 视频宽跨距。</span></li><li><span class="hljs-type">int32_t</span> widthStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 视频高跨距。</span></li><li><span class="hljs-type">int32_t</span> heightStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 编码器实例指针。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 编码器同步锁。</span></li><li>std::shared_mutex codecMutex;</li><li><span class="hljs-comment">// 编码器输入队列。</span></li><li>CodecBufferQueue inQueue;</li><li><span class="hljs-comment">// 编码器输出队列。</span></li><li>CodecBufferQueue outQueue;</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="surface模式">Surface模式<i class="anchor-icon anchor-icon-link" anchorid="surface模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Surface模式下视频编码的全流程，实现异步模式的数据轮转。此处以输入surface数据，编码成H.264格式为例。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建编码器实例。</p>       <p>开发者可以通过名称或媒体类型创建编码器。示例中的变量说明如下：</p>       <ul>        <li>videoEnc：视频编码器实例的指针；</li>        <li>capability：编解码器能力查询实例的指针；</li>        <li>OH_AVCODEC_MIMETYPE_VIDEO_AVC：AVC格式视频编解码器。</li>       </ul>       <p>创建方式示例如下：</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codec name创建编码器，应用有特殊需求，比如选择支持某种分辨率规格的编码器，可先查询capability，再根据codec name创建编码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-comment">// 创建硬件编码器实例。</span></li><li>OH_AVCapability *capability= <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>, HARDWARE);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *codecName = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByName</span>(codecName);</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过MIME TYPE创建编码器，只能创建系统推荐的特定编解码器。</span></li><li><span class="hljs-comment">// 只能创建硬件编码器。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_RegisterCallback()设置回调函数。</p>       <p>注册回调函数指针集合OH_AVCodecCallback，包括：</p>       <ul>        <li>OH_AVCodecOnError 编码器运行错误，返回的错误码详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcodeconerror" target="_blank">OH_AVCodecOnError</a>；</li>        <li>OH_AVCodecOnStreamChanged 码流信息变化，如格式变化等；</li>        <li>OH_AVCodecOnNeedInputBuffer 输入回调无作用，开发者通过获取的surface输入数据；</li>        <li>OH_AVCodecOnNewOutputBuffer 运行过程中产生了新的输出数据，即编码完成。</li>       </ul>       <p>回调函数的具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>       <p>示例如下所示：</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置OH_AVCodecOnError 回调函数，编码异常。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 回调的错误码由开发者判断处理。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)errorCode;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置OH_AVCodecOnStreamChanged 回调函数，编码数据流变化</span></li><li>static void <span class="hljs-built_in">OnStreamChanged</span>(OH_AVCodec *codec, OH_AVFormat *format, void *userData)</li><li>{</li><li>    (void)codec;</li><li>    (void)format;</li><li>    (void)userData;</li><li>    <span class="hljs-comment">// 可通过format获取到分辨率变化后的视频宽、高</span></li><li>    <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_PIC_WIDTH, &amp;width);</li><li>    <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_PIC_HEIGHT, &amp;height);</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置 OH_AVCodecOnNeedInputBuffer 回调函数，编码输入帧送入数据队列。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Surface模式下，该回调函数无作用，开发者通过获取的surface输入数据。</span></li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    (<span class="hljs-type">void</span>)index;</li><li>    (<span class="hljs-type">void</span>)buffer;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置 OH_AVCodecOnNewOutputBuffer 回调函数，编码完成帧送入输出队列。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNewOutputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 完成帧的数据buffer和对应的index送入outQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    outQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置异步回调，调用 OH_VideoEncoder_RegisterCallback()接口。</span></li><li><span class="hljs-variable">OH_AVCodecCallback</span> <span class="hljs-variable">cb</span> = {&amp;<span class="hljs-title class_">OnError</span>, &amp;<span class="hljs-title class_">OnStreamChanged</span>, &amp;<span class="hljs-title class_">OnNeedInputBuffer</span>, &amp;<span class="hljs-title class_">OnNewOutputBuffer</span>};</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_RegisterCallback</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">cb</span>, <span class="hljs-variable">nullptr</span>); <span class="hljs-comment">// nullptr:开发者执行回调所依赖的数据userData为空。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>在回调函数中，对数据队列进行操作时，需要注意多线程同步的问题。</p>        </div></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_RegisterParameterCallback()在Configure接口之前注册随帧通路回调。</p>       <p>详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding-temporal-scalability">时域可分层视频编码</a>。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 4.1 编码输入参数回调OH_VideoEncoder_OnNeedInputParameter实现</span></li><li> <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputParameter</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVFormat *parameter, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"> </span>{</li><li>     <span class="hljs-comment">// 输入帧parameter对应的index，送入InParameterIndexQueue队列</span></li><li>     <span class="hljs-comment">// 输入帧的数据parameter送入InParameterQueue队列</span></li><li>     <span class="hljs-comment">// 数据处理</span></li><li>     <span class="hljs-comment">// 随帧参数写入</span></li><li>     <span class="hljs-comment">// 配置OH_MD_KEY_VIDEO_ENCODER_QP_MAX 的值应大于等于OH_MD_KEY_VIDEO_ENCODER_QP_MIN</span></li><li>     <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(parameter, OH_MD_KEY_VIDEO_ENCODER_QP_MAX, <span class="hljs-number">30</span>);</li><li>     <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(parameter, OH_MD_KEY_VIDEO_ENCODER_QP_MIN, <span class="hljs-number">20</span>);</li><li>     inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, parameter));</li><li> }</li><li>
</li><li> <span class="hljs-comment">// 4.2 注册随帧参数回调</span></li><li> OH_VideoEncoder_OnNeedInputParameter inParaCb = OnNeedInputParameter;</li><li> <span class="hljs-built_in">OH_VideoEncoder_RegisterParameterCallback</span>(videoEnc, inParaCb, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// NULL:用户特定数据userData为空</span></li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Configure()配置编码器。</p>       <p>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">视频专有键值对</a>。</p>       <p>参数校验规则请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_configure" target="_blank">OH_VideoEncoder_Configure()参考文档</a>。</p>       <p>参数取值范围可以通过能力查询接口获取，具体示例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/obtain-supported-codecs">获取支持的编解码能力文档</a>。</p>       <p>目前支持的所有格式都必须配置以下选项：视频帧宽度、视频帧高度、视频像素格式。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置视频帧速率。</span></li><li><span class="hljs-variable">double</span> <span class="hljs-variable">frameRate</span> = <span class="hljs-number">30.0</span>;</li><li><span class="hljs-comment">// 配置视频YUV值范围标志。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">rangeFlag</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 配置视频原色。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">primary</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_ColorPrimary</span>::<span class="hljs-title class_">COLOR_PRIMARY_BT709</span>);</li><li><span class="hljs-comment">// 配置传输特性。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">transfer</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_TransferCharacteristic</span>::<span class="hljs-title class_">TRANSFER_CHARACTERISTIC_BT709</span>);</li><li><span class="hljs-comment">// 配置最大矩阵系数。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">matrix</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_MatrixCoefficient</span>::<span class="hljs-title class_">MATRIX_COEFFICIENT_IDENTITY</span>);</li><li><span class="hljs-comment">// 配置编码Profile。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">profile</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_AVCProfile</span>::<span class="hljs-title class_">AVC_PROFILE_HIGH</span>);</li><li><span class="hljs-comment">// 配置编码比特率模式。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">rateMode</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_VBR</span>);</li><li><span class="hljs-comment">// 配置关键帧的间隔，单位为毫秒。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">iFrameInterval</span> = <span class="hljs-number">1000</span>;</li><li><span class="hljs-comment">// 配置质量稳定码率因子。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">sqrFactor</span> = <span class="hljs-number">30</span>;</li><li><span class="hljs-comment">// 配置最大比特率，单位为bps。</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">maxBitRate</span> = <span class="hljs-number">20000000</span>;</li><li><span class="hljs-comment">// 配置比特率，单位为bps。</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">bitRate</span> = <span class="hljs-number">5000000</span>;</li><li><span class="hljs-comment">// 配置编码质量。</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">quality</span> = <span class="hljs-number">90</span>;</li><li>
</li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-variable">width</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-variable">height</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">pixelFormat</span>); <span class="hljs-comment">// 必须配置，</span></li><li>
</li><li><span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-variable">frameRate</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_RANGE_FLAG</span>, <span class="hljs-variable">rangeFlag</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_COLOR_PRIMARIES</span>, <span class="hljs-variable">primary</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_TRANSFER_CHARACTERISTICS</span>, <span class="hljs-variable">transfer</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_MATRIX_COEFFICIENTS</span>, <span class="hljs-variable">matrix</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_I_FRAME_INTERVAL</span>, <span class="hljs-variable">iFrameInterval</span>);</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">profile</span>);</li><li><span class="hljs-comment">//只有当OH_BitrateMode = BITRATE_MODE_CQ时，才需要配置OH_MD_KEY_QUALITY。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">rateMode</span> == <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_CQ</span>)) {</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_QUALITY</span>, <span class="hljs-variable">quality</span>);</li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">rateMode</span> == <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_SQR</span>)) {</li><li>    <span class="hljs-comment">// 只有当OH_BitrateMode = BITRATE_MODE_SQR时，才需要配置OH_MD_KEY_MAX_BITRATE和OH_MD_KEY_SQR_FACTOR。</span></li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_MAX_BITRATE</span>, <span class="hljs-variable">maxBitRate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_SQR_FACTOR</span>, <span class="hljs-variable">sqrFactor</span>);</li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">rateMode</span> == <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_CBR</span>) ||</li><li>           <span class="hljs-variable">rateMode</span> == <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int32_t</span>&gt;(<span class="hljs-variable">OH_BitrateMode</span>::<span class="hljs-title class_">BITRATE_MODE_VBR</span>)){</li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-variable">bitRate</span>);</li><li>}</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">rateMode</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>配置非必须参数错误时，会返回AV_ERR_INVALID_VAL错误码。但OH_VideoEncoder_Configure()不会失败，而是使用默认值继续执行。</p>        </div></div></div></li>      <li>       <p>获取surface。</p>       <p>获取编码器Surface模式的OHNativeWindow输入，获取surface需要在调用OH_VideoEncoder_Prepare接口之前完成。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取需要输入的surface，以进行编码。</span></li><li>OHNativeWindow *nativeWindow;</li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_GetSurface(videoEnc, &amp;nativeWindow);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 通过OHNativeWindow*变量类型，可通过生产者接口获取待填充数据地址。</span></li></ol></pre></div></div>       <p>OHNativeWindow*变量类型的使用方法请参考图形子系统 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-nativewindow" target="_blank">OHNativeWindow</a>。</p></li>      <li>       <p>调用OH_VideoEncoder_Prepare()编码器就绪。</p>       <p>该接口将在编码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_Prepare(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Start()启动编码器。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置待编码文件路径。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">outputFilePath</span> = <span class="hljs-string">"/*yourpath*.h264"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt; <span class="hljs-title class_">outputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt;();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">outputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">ate</span>);</li><li>}</li><li><span class="hljs-comment">// 启动编码器，开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）OH_VideoEncoder_SetParameter()在运行过程中动态配置编码器参数。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create();</li><li>
</li><li><span class="hljs-regexp">//</span> 支持动态请求IDR帧</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_REQUEST_I_FRAME, true);</li><li><span class="hljs-regexp">//</span> 支持动态重置比特率</li><li>int64_t bitRate = <span class="hljs-number">2000000</span>;</li><li>OH_AVFormat_SetLongValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_BITRATE, bitRate);</li><li><span class="hljs-regexp">//</span> 支持动态重置视频帧速率</li><li>double frameRate = <span class="hljs-number">60.0</span>;</li><li>OH_AVFormat_SetDoubleValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_FRAME_RATE, frameRate);</li><li><span class="hljs-regexp">//</span> 支持动态设置QP值</li><li>// 配置OH_MD_KEY_VIDEO_ENCODER_QP_MAX 的值应大于等于OH_MD_KEY_VIDEO_ENCODER_QP_MIN</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_ENCODER_QP_MAX, <span class="hljs-number">30</span>);</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_ENCODER_QP_MIN, <span class="hljs-number">20</span>);</li><li>
</li><li>int32_t ret = OH_VideoEncoder_SetParameter(videoEnc, <span class="hljs-keyword">format</span>);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-regexp">//</span> 异常处理</li><li>}</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>);</li></ol></pre></div></div></li>      <li>       <p>写入编码图像。</p>       <p>在之前的第6步中，开发者已经对OH_VideoEncoder_GetSurface接口返回的OHNativeWindow*类型变量进行配置。因为编码所需的数据，由配置的surface进行持续地输入，所以开发者无需对OnNeedInputBuffer回调函数进行处理，也无需使用OH_VideoEncoder_PushInputBuffer接口输入数据。</p>       <p>在变分辨率场景中，此规则也同样适用。</p></li>      <li>       <p>（可选）调用OH_VideoEncoder_PushInputParameter()通知编码器随帧参数配置输入完成。</p>       <p>在之前的第4步中，开发者已经注册随帧通路回调。</p>       <p>以下示例中：</p>       <ul>        <li>index：回调函数OnNeedInputParameter传入的参数，与buffer唯一对应的标识。</li>       </ul>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 值由开发者决定。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">isIFrame</span>;</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">parameter</span>, <span class="hljs-variable">OH_MD_KEY_REQUEST_I_FRAME</span>, <span class="hljs-variable">isIFrame</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_PushInputParameter</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_NotifyEndOfStream()通知编码器结束。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Surface模式：通知视频编码器输入流已结束，只能使用此接口进行通知。</span></li><li><span class="hljs-comment">// 不能像Buffer模式中将flag设为AVCODEC_BUFFER_FLAGS_EOS，再调用OH_VideoEncoder_PushInputBuffer接口通知编码器输入结束。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_NotifyEndOfStream(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_FreeOutputBuffer()释放编码帧。</p>       <p>以下示例中，bufferInfo的成员变量：</p>       <ul>        <li>index：回调函数OnNewOutputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>buffer：回调函数OnNewOutputBuffer传入的参数，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口得到共享内存地址的指针；</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">qpAverage</span> = <span class="hljs-number">20</span>;</li><li><span class="hljs-variable">double</span> <span class="hljs-variable">mseValue</span> = <span class="hljs-number">0.0</span>;</li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVBuffer_GetParameter</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODER_QP_AVERAGE</span>, &amp;<span class="hljs-title class_">qpAverage</span>);</li><li><span class="hljs-title function_">OH_AVFormat_GetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODER_MSE</span>, &amp;<span class="hljs-title class_">mseValue</span>);</li><li><span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li><li><span class="hljs-comment">// 获取编码后信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将编码完成帧数据buffer写入到对应输出文件中。</span></li><li><span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-title class_">write</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">char</span> *&gt;(<span class="hljs-title class_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>)), <span class="hljs-title class_">info</span>.<span class="hljs-title class_">size</span>);</li><li><span class="hljs-comment">// 释放已完成写入的数据，index为对应输出队列下标</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_FreeOutputBuffer</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Flush()刷新编码器。</p>       <p>调用OH_VideoEncoder_Flush接口后，编码器仍处于运行态，但会清除编码器中缓存的输入和输出数据及参数集如H.264格式的PPS/SPS。</p>       <p>此时需要调用OH_VideoEncoder_Start接口重新开始编码。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 刷新编码器videoEnc。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">flushRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Flush</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">flushRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-comment">// 重新开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">startRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">startRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Reset()重置编码器。</p>       <p>调用OH_VideoEncoder_Reset接口后，编码器将回到初始化的状态，需要调用OH_VideoEncoder_Configure接口和OH_VideoEncoder_Prepare接口重新配置。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 重置编码器videoEnc。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">resetRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Reset</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">resetRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-comment">// 重新配置编码器参数。</span></li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">configRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">configRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 编码器重新就绪。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">prepareRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Prepare</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">prepareRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Stop()停止编码器。</p>       <p>调用OH_VideoEncoder_Stop接口后，编码器保留了编码实例，释放输入输出buffer。开发者可以直接调用OH_VideoEncoder_Start接口继续编码，输入的第一个buffer需要携带参数集，从IDR帧开始送入。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 终止编码器videoEnc。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Stop</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Destroy()销毁编码器实例，释放资源。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ol>          <li>不能在回调函数中调用；</li>          <li>执行该步骤之后，需要开发者将videoEnc指向nullptr，防止野指针导致程序错误。</li>         </ol>        </div></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li><span class="hljs-comment">// 释放nativeWindow实例。</span></li><li><span class="hljs-keyword">if</span>(nativeWindow != <span class="hljs-literal">nullptr</span>){</li><li>    <span class="hljs-built_in">OH_NativeWindow_DestroyNativeWindow</span>(nativeWindow);</li><li>    nativeWindow = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-comment">// 调用OH_VideoEncoder_Destroy，注销编码器。</span></li><li>OH_AVErrCode ret = AV_ERR_OK;</li><li><span class="hljs-keyword">if</span> (videoEnc != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">OH_VideoEncoder_Destroy</span>(videoEnc);</li><li>    videoEnc = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>inQueue.<span class="hljs-built_in">Flush</span>();</li><li>outQueue.<span class="hljs-built_in">Flush</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="buffer模式">Buffer模式<i class="anchor-icon anchor-icon-link" anchorid="buffer模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Buffer模式下视频编码的全流程，实现异步模式的数据轮转。此处以输入YUV文件，编码成H.264格式为例。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建编码器实例。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codec name创建编码器，应用有特殊需求，比如选择支持某种分辨率规格的编码器，可先查询capability，再根据codec name创建编码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *codecName = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByName</span>(codecName);</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过MIME TYPE创建编码器，只能创建系统推荐的特定编解码器。</span></li><li><span class="hljs-comment">// 涉及创建多路编解码器时，优先创建硬件编码器实例，硬件资源不够时再创建软件编码器实例。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_RegisterCallback()设置回调函数。</p>       <p>注册回调函数指针集合OH_AVCodecCallback，包括：</p>       <ul>        <li>OH_AVCodecOnError 编码器运行错误，返回的错误码详情请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcodeconerror" target="_blank">OH_AVCodecOnError</a>；</li>        <li>OH_AVCodecOnStreamChanged 码流信息变化，如格式变化等；</li>        <li>OH_AVCodecOnNeedInputBuffer 运行过程中需要新的输入数据，即编码器已准备好，可以输入YUV/RGB数据；</li>        <li>OH_AVCodecOnNewOutputBuffer 运行过程中产生了新的输出数据，即编码完成。</li>       </ul>       <p>开发者可以通过处理该回调报告的信息，确保编码器正常运转。</p>       <p>回调函数的具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> isFirstFrame = <span class="hljs-literal">true</span>;</li><li><span class="hljs-type">int32_t</span> qpAverage = <span class="hljs-number">20</span>;</li><li><span class="hljs-type">double</span> mseValue = <span class="hljs-number">0.0</span>;</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 编码异常回调OH_AVCodecOnError实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 回调的错误码由开发者判断处理。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)errorCode;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 编码数据流变化回调OH_AVCodecOnStreamChanged实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnStreamChanged</span><span class="hljs-params">(OH_AVCodec *codec, OH_AVFormat *format, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Buffer模式下，该回调函数无作用。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)format;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 编码输入回调OH_AVCodecOnNeedInputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取视频宽跨距、高跨距。</span></li><li>    <span class="hljs-keyword">if</span> (isFirstFrame) {</li><li>        <span class="hljs-keyword">auto</span> format = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_VideoEncoder_GetInputDescription</span>(codec), OH_AVFormat_Destroy);</li><li>        <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>        }</li><li>        <span class="hljs-type">bool</span> ret = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_STRIDE, &amp;widthStride) &amp;&amp;</li><li>                   <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_SLICE_HEIGHT, &amp;heightStride);</li><li>        <span class="hljs-keyword">if</span> (!ret) {</li><li>             <span class="hljs-comment">// 异常处理。</span></li><li>        }</li><li>        isFirstFrame = <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 输入帧的数据buffer和对应的index送入inQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 编码输出回调OH_AVCodecOnNewOutputBuffer实现</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNewOutputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取视频帧的平均量化参数，平方误差</span></li><li>    OH_AVFormat *format = <span class="hljs-built_in">OH_AVBuffer_GetParameter</span>(buffer);</li><li>    <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_ENCODER_QP_AVERAGE, &amp;qpAverage);</li><li>    <span class="hljs-built_in">OH_AVFormat_GetDoubleValue</span>(format, OH_MD_KEY_VIDEO_ENCODER_MSE, &amp;mseValue);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(format);</li><li>    <span class="hljs-comment">// 完成帧的数据buffer和对应的index送入outQueue队列</span></li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    outQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置异步回调，调用OH_VideoEncoder_RegisterCallback接口。</span></li><li><span class="hljs-variable">OH_AVCodecCallback</span> <span class="hljs-variable">cb</span> = {&amp;<span class="hljs-title class_">OnError</span>, &amp;<span class="hljs-title class_">OnStreamChanged</span>, &amp;<span class="hljs-title class_">OnNeedInputBuffer</span>, &amp;<span class="hljs-title class_">OnNewOutputBuffer</span>};</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_RegisterCallback</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">cb</span>, <span class="hljs-variable">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>在回调函数中，对数据队列进行操作时，需要注意多线程同步的问题。</p>        </div></div></div></li>      <li>       <p>调用OH_VideoEncoder_Configure()配置编码器。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-variable">width</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-variable">height</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">pixelFormat</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-comment">// 配置编码器。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Prepare()编码器就绪。</p>       <p>该接口将在编码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_Prepare(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Start()启动编码器，进入运行态。</p>       <p>启动编码器后，回调函数将开始响应事件。所以，需要先配置输入文件、输出文件。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置待编码文件路径。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">inputFilePath</span> = <span class="hljs-string">"/*yourpath*.yuv"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">outputFilePath</span> = <span class="hljs-string">"/*yourpath*.h264"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ifstream</span>&gt; <span class="hljs-title class_">inputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ifstream</span>&gt;();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt; <span class="hljs-title class_">outputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt;();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">inputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">inputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">inputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-keyword">in</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span>);</li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">outputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">ate</span>);</li><li>}</li><li><span class="hljs-comment">// 启动编码器，开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）在运行过程中动态配置编码器参数。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create();</li><li>
</li><li><span class="hljs-regexp">//</span> 支持动态请求IDR帧</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_REQUEST_I_FRAME, true);</li><li><span class="hljs-regexp">//</span> 支持动态重置比特率</li><li>int64_t bitRate = <span class="hljs-number">2000000</span>;</li><li>OH_AVFormat_SetLongValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_BITRATE, bitRate);</li><li><span class="hljs-regexp">//</span> 支持动态重置视频帧速率</li><li>double frameRate = <span class="hljs-number">60.0</span>;</li><li>OH_AVFormat_SetDoubleValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_FRAME_RATE, frameRate);</li><li>
</li><li>int32_t ret = OH_VideoEncoder_SetParameter(videoEnc, <span class="hljs-keyword">format</span>);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-regexp">//</span> 异常处理</li><li>}</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_PushInputBuffer()写入编码图像。</p>       <p>送入输入队列进行编码，以下示例中：</p>       <ul>        <li>widthStride: 获取到的buffer数据的宽跨距。</li>        <li>heightStride：获取到的buffer数据的高跨距。</li>       </ul>       <p>bufferInfo的成员变量：</p>       <ul>        <li>buffer：回调函数OnNeedInputBuffer传入的参数，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口得到共享内存地址的指针；</li>        <li>index：回调函数OnNeedInputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入图像数据。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">frameSize</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">widthStride</span> == <span class="hljs-variable">width</span> &amp;&amp; <span class="hljs-variable">heightStride</span> == <span class="hljs-variable">height</span>) {</li><li>    <span class="hljs-variable">frameSize</span> = <span class="hljs-variable">width</span> * <span class="hljs-variable">height</span> * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// NV12像素格式下，每帧数据大小的计算公式</span></li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">capacity</span> = <span class="hljs-title function_">OH_AVBuffer_GetCapacity</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">frameSize</span> &gt; <span class="hljs-variable">capacity</span>) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>    }</li><li>    <span class="hljs-comment">// 处理文件流得到帧的长度，再将需要编码的数据写入到对应index的buffer中。</span></li><li>    <span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>       <span class="hljs-comment">// 异常处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">inputFile</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">inputFile</span>-&gt;<span class="hljs-title class_">is_open</span>()) {</li><li>        <span class="hljs-variable">inputFile</span>-&gt;<span class="hljs-title class_">read</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">char</span> *&gt;(<span class="hljs-title class_">addr</span>), <span class="hljs-title class_">frameSize</span>);</li><li>    }</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 如果跨距不等于宽，需要开发者按照跨距进行偏移，具体可参考以下示例。</span></li><li>}</li><li><span class="hljs-comment">// 配置buffer info信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">frameSize</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">pts</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 配置buffer 随帧信息。</span></li><li><span class="hljs-comment">// 值由开发者决定。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">isIFrame</span>;</li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">parameter</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVBuffer_GetParameter</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">parameter</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">parameter</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_REQUEST_I_FRAME</span>, <span class="hljs-variable">isIFrame</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">parameterRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetParameter</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, <span class="hljs-variable">parameter</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">parameterRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 送入编码输入队列进行编码，index为对应输入队列的下标。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">pushInputRet</span> = <span class="hljs-title function_">OH_VideoEncoder_PushInputBuffer</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">pushInputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <p>对跨距进行偏移，以NV12图像为例，示例如下：</p>       <p>以NV12图像为例，width、height、wStride、hStride图像排布参考下图：</p>       <ul>        <li>OH_MD_KEY_WIDTH表示width；</li>        <li>OH_MD_KEY_HEIGHT表示height；</li>        <li>OH_MD_KEY_VIDEO_STRIDE表示wStride；</li>        <li>OH_MD_KEY_VIDEO_SLICE_HEIGHT表示hStride。</li>       </ul>       <p><span><img originheight="1946" originwidth="3035" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114431.94989024066485050746324571632652:50001231000000:2800:5AD015B91F140B12B03655A2753BF5A4BC8582166907876DEE526FEFF6E50D9C.png" width="920" height="589.8912685337726"></span></p>       <p>添加头文件。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span>   <span class="hljs-comment">// 源内存区域的宽、高，由开发者自行设置。</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> width;</li><li>    <span class="hljs-type">int32_t</span> height;</li><li>};</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DstRect</span> <span class="hljs-comment">// 目标内存区域的宽跨距、高跨距，通过接口OH_VideoEncoder_GetInputDescription获取。</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> wStride;</li><li>    <span class="hljs-type">int32_t</span> hStride;</li><li>};</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SrcRect</span> <span class="hljs-comment">// 源内存区域的宽跨距、高跨距，由开发者自行设置。</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> wStride;</li><li>    <span class="hljs-type">int32_t</span> hStride;</li><li>};</li><li>
</li><li>Rect rect = {<span class="hljs-number">320</span>, <span class="hljs-number">240</span>};</li><li>DstRect dstRect = {<span class="hljs-number">320</span>, <span class="hljs-number">256</span>};</li><li>SrcRect srcRect = {<span class="hljs-number">320</span>, <span class="hljs-number">250</span>};</li><li><span class="hljs-type">uint8_t</span>* dst = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[dstRect.hStride * dstRect.wStride * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>]; <span class="hljs-comment">// 目标内存区域的指针。</span></li><li><span class="hljs-type">uint8_t</span>* src = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[srcRect.hStride * srcRect.wStride * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>]; <span class="hljs-comment">// 源内存区域的指针。</span></li><li><span class="hljs-type">uint8_t</span>* dstTemp = dst;</li><li><span class="hljs-type">uint8_t</span>* srcTemp = src;</li><li>rect.height = ((rect.height + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>)  * <span class="hljs-number">2</span> <span class="hljs-comment">// 避免height为奇数；</span></li><li>rect.width = ((rect.width + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>)  * <span class="hljs-number">2</span> <span class="hljs-comment">// 避免width为奇数；</span></li><li>
</li><li><span class="hljs-comment">// Y 将Y区域的源数据复制到另一个区域的目标数据中。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; rect.height; ++i) {</li><li>    <span class="hljs-comment">//将源数据的一行数据复制到目标数据的一行中。</span></li><li>    <span class="hljs-built_in">memcpy</span>(dstTemp, srcTemp, rect.width);</li><li>    <span class="hljs-comment">// 更新源数据和目标数据的指针，进行下一行的复制。每更新一次源数据和目标数据的指针都向下移动一个wStride。</span></li><li>    dstTemp += dstRect.wStride;</li><li>    srcTemp += srcRect.wStride;</li><li>}</li><li><span class="hljs-comment">// padding。</span></li><li><span class="hljs-comment">// 更新源数据和目标数据的指针，指针都向下移动一个padding。</span></li><li>dstTemp += (dstRect.hStride - rect.height) * dstRect.wStride;</li><li>srcTemp += (srcRect.hStride - rect.height) * srcRect.wStride;</li><li>rect.height &gt;&gt;= <span class="hljs-number">1</span>;</li><li><span class="hljs-comment">// UV 将UV区域的源数据复制到另一个区域的目标数据中。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; rect.height; ++i) {</li><li>    <span class="hljs-built_in">memcpy</span>(dstTemp, srcTemp, rect.width);</li><li>    dstTemp += dstRect.wStride;</li><li>    srcTemp += srcRect.wStride;</li><li>}</li><li>
</li><li><span class="hljs-keyword">delete</span>[] dst;</li><li>dst = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-keyword">delete</span>[] src;</li><li>src = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div>       <p>硬件编码在处理buffer数据时（推送数据前），需要开发者拷贝宽、高对齐后的图像数据到输入回调的AVbuffer中。</p>       <p>一般需要获取数据的宽、高、跨距、像素格式来保证编码输入数据被正确的处理。</p>       <p>具体实现请参考：<a href="/consumer/cn/doc/harmonyos-guides/video-encoding#buffer模式">Buffer模式</a>的步骤3-调用OH_VideoEncoder_RegisterCallback接口设置回调函数来获取数据的宽、高、跨距、像素格式。</p></li>      <li>       <p>通知编码器结束。</p>       <p>以下示例中，bufferInfo的成员变量：</p>       <ul>        <li>index：回调函数OnNeedInputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>buffer：回调函数OnNeedInputBuffer传入的参数，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口得到共享内存地址的指针;</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <p>与“步骤-8. 写入编码图像”一样，使用同一个接口OH_VideoEncoder_PushInputBuffer，通知编码器输入结束，需要将flag标识成AVCODEC_BUFFER_FLAGS_EOS。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">pts</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_EOS</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">pushInputRet</span> = <span class="hljs-title function_">OH_VideoEncoder_PushInputBuffer</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">pushInputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_FreeOutputBuffer()释放编码帧。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-ude-c106="" class="highlight-div"><div _ngcontent-ude-c106="" class="highlight-div-header"><div _ngcontent-ude-c106="" class="highlight-div-header-left"><div _ngcontent-ude-c106="" class="handle-button expand-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ude-c106="" class="highlight-div-header-right"><div _ngcontent-ude-c106="" class="handle-button ai-button"></div><div _ngcontent-ude-c106="" class="handle-button line-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ude-c106="" class="handle-button theme-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ude-c106="" class="handle-button copy-button"><div _ngcontent-ude-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ude-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 获取编码后信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">getBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">getBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将编码完成帧数据buffer写入到对应输出文件中。</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-title class_">is_open</span>()) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-title class_">write</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">char</span> *&gt;(<span class="hljs-title class_">addr</span>), <span class="hljs-title class_">info</span>.<span class="hljs-title class_">size</span>);</li><li>}</li><li><span class="hljs-comment">// 释放已完成写入的数据，index为对应输出队列的下标。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">freeOutputRet</span> = <span class="hljs-title function_">OH_VideoEncoder_FreeOutputBuffer</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">freeOutputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>     </ol>     <p>后续流程（包括刷新、重置、停止和销毁编码器）与Surface模式一致，请参考<a href="/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式">Surface模式</a>的步骤14-17。</p>    </div>   </div>   <div></div></div>