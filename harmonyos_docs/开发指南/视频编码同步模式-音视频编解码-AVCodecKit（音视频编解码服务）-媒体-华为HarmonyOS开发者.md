<h1 _ngcontent-kmd-c119="" class="doc-title ng-star-inserted" title="视频编码同步模式"> 视频编码同步模式 </h1>

<div _ngcontent-kmd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 20开始，支持视频编码同步模式。</p>    <p>开发者可以调用本模块的Native API接口，完成同步模式的视频编码。</p>    <p>当前支持的编码能力，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#视频编码">AVCodec支持的格式</a>。</p>    <p>视频编码的限制约束、支持的能力、状态机调用关系请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding">视频编码</a>。</p>    <div class="tiledSection">     <h2 id="适用场景">适用场景<i class="anchor-icon anchor-icon-link" anchorid="适用场景" tips="复制节点链接"></i></h2>          <p>通常情况下，推荐使用异步模式。若需要主动请求buffer去送帧，则可以采用同步模式。</p>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h" target="_blank">VideoEncoder</a>。</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="4424" originwidth="5096" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114432.30560039083537063266360832373674:50001231000000:2800:B914BC80F2D1F633FC0D0C9AD021E9379C00DCC93EB34967F445E0257282AC5A.png" width="920" height="798.6813186813187"></span></p>    </div>    <div class="tiledSection">     <h3 id="在cmake脚本中链接动态库" class="firsth2">在CMake脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_venc.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="定义基础结构">定义基础结构<i class="anchor-icon anchor-icon-link" anchorid="定义基础结构" tips="复制节点链接"></i></h3>          <p>本部分示例代码按照C++17标准编写，仅作参考。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videoencoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_averrors.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>全局变量（仅作参考，可以根据实际情况将其封装到对象中）。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 视频帧宽度。</span></li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">320</span>;</li><li><span class="hljs-comment">// 视频帧高度。</span></li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">240</span>;</li><li><span class="hljs-comment">// 视频宽跨距。</span></li><li><span class="hljs-type">int32_t</span> widthStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 视频高跨距。</span></li><li><span class="hljs-type">int32_t</span> heightStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 视频像素格式。</span></li><li>OH_AVPixelFormat pixelFormat = AV_PIXEL_FORMAT_NV12;</li><li><span class="hljs-comment">// 编码器同步锁。</span></li><li>std::shared_mutex codecMutex;</li><li><span class="hljs-comment">// 编码器实例指针。</span></li><li>OH_AVCodec *videoEnc = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 编码输出。</span></li><li><span class="hljs-type">bool</span> outputDone = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// 编码输入。</span></li><li><span class="hljs-type">bool</span> inputDone = <span class="hljs-literal">false</span>;</li><li>std::unique_ptr&lt;std::ifstream&gt; inFile_;</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="surface模式">Surface模式<i class="anchor-icon anchor-icon-link" anchorid="surface模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Surface模式下视频编码的全流程，实现同步模式的数据轮转。此处以输入surface数据，编码成H.264格式为例。</p>     <ol>      <li>       <p>创建编码器实例。</p>       <p>通过名称创建编码器。示例中的变量说明如下：</p>       <ul>        <li>videoEnc：视频编码器实例的指针。</li>        <li>capability：编码器能力查询实例的指针。</li>        <li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#变量" target="_blank">OH_AVCODEC_MIMETYPE_VIDEO_AVC</a>：AVC格式视频编解码器。</li>       </ul>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建硬件编码器实例。</span></li><li>OH_AVCapability *capability= <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>, HARDWARE);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByName</span>(name);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create videoEnc failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Configure()配置编码器。</p>       <ul>        <li>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">媒体数据键值对</a>。</li>        <li>参数校验规则请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_configure" target="_blank">OH_VideoEncoder_Configure()</a>。</li>        <li>参数取值范围可以通过能力查询接口获取，具体示例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/obtain-supported-codecs">获取支持的编解码能力</a>。</li>       </ul>       <p>目前支持的所有格式都必须配置以下选项：视频帧宽度、视频帧高度、视频像素格式。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>auto format = std::shared_ptr&lt;OH_AVFormat&gt;(OH_AVFormat_Create(), OH_AVFormat_Destroy);</li><li><span class="hljs-keyword">if</span> (format == nullptr) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_WIDTH, width); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_HEIGHT, height); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_PIXEL_FORMAT, pixelFormat);<span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_ENABLE_SYNC_MODE, <span class="hljs-number">1</span>); <span class="hljs-comment">// 同步模式配置。</span></li><li><span class="hljs-comment">// 配置编码器。</span></li><li>OH_AVErrCode ret = OH_VideoEncoder_Configure(videoEnc, format.<span class="hljs-keyword">get</span>());</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ol>          <li>要使能视频编码同步模式，必须将OH_MD_KEY_ENABLE_SYNC_MODE配置为1。</li>          <li>同步模式在调用OH_VideoEncoder_Configure接口前不能调用OH_VideoEncoder_RegisterCallback或OH_VideoEncoder_RegisterParameterCallback接口，否则为异步模式。</li>          <li>不支持Surface模式的随帧通路的同步模式。</li>         </ol>        </div></div></div></li>      <li>       <p>设置surface。</p>       <p>示例中的变量说明如下：</p>       <ul>        <li>nativeWindow：获取方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式">视频编码Surface模式</a>的“步骤-6：设置surface”。</li>       </ul>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取需要输入的surface，以进行编码。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_GetSurface(videoEnc, &amp;nativeWindow);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Prepare()编码器就绪。</p>       <p>该接口将在编码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_Prepare(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Start()启动编码器。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置待编码文件路径。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">outputFilePath</span> = <span class="hljs-string">"/*yourpath*.h264"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt; <span class="hljs-title class_">outputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt;();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">outputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">ate</span>);</li><li>}</li><li><span class="hljs-comment">// 启动编码器，开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并释放编码帧。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_queryoutputbuffer" target="_blank">OH_VideoEncoder_QueryOutputBuffer</a>接口获取下一个可用的输出缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_getoutputbuffer" target="_blank">OH_VideoEncoder_GetOutputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_freeoutputbuffer" target="_blank">OH_VideoEncoder_FreeOutputBuffer</a>接口释放编码帧。</li>       </ul>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EncoderOutput</span><span class="hljs-params">(OH_AVCodec *videoEnc, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoEncoder_QueryOutputBuffer</span>(videoEnc, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoEncoder_GetOutputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>        </li><li>            <span class="hljs-comment">// 获取编码后信息。</span></li><li>            OH_AVCodecBufferAttr info;</li><li>            OH_AVErrCode getBufferRet = <span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (getBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (info.flags &amp; AVCODEC_BUFFER_FLAGS_EOS) {</li><li>                outputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>
</li><li>            <span class="hljs-comment">// 将编码完成帧数据buffer写入到对应输出文件中。</span></li><li>            <span class="hljs-type">uint8_t</span> *addr = <span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) {</li><li>               <span class="hljs-comment">// 异常处理</span></li><li>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (outputFile != <span class="hljs-literal">nullptr</span> &amp;&amp; outputFile-&gt;<span class="hljs-built_in">is_open</span>()) {</li><li>                outputFile-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(addr), info.size);</li><li>            }</li><li>            <span class="hljs-comment">// 释放已完成写入的数据，index为对应输出队列下标。</span></li><li>            OH_AVErrCode freeOutputRet = <span class="hljs-built_in">OH_VideoEncoder_FreeOutputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (freeOutputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_STREAM_CHANGED: {</li><li>            <span class="hljs-keyword">auto</span> format = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_VideoEncoder_GetOutputDescription</span>(videoEnc), OH_AVFormat_Destroy);</li><li>            <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-comment">// 获取新宽高。</span></li><li>            <span class="hljs-type">bool</span> getIntRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_WIDTH, &amp;width) &amp;&amp;</li><li>                             <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_HEIGHT, &amp;height);</li><li>            <span class="hljs-keyword">if</span> (!getIntRet) {</li><li>                 <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编码器出帧处理循环。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li> <span class="hljs-type">int64_t</span> timeoutUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 单位：微秒（us），负值：无限等待；0：立即退出；正值：等待指定时长后退出。</span></li><li>
</li><li> <span class="hljs-keyword">while</span> (!outputDone &amp;&amp; result) {</li><li>     <span class="hljs-keyword">if</span> (!outputDone ) {</li><li>         result = <span class="hljs-built_in">EncoderOutput</span>(videoEnc, timeoutUs);</li><li>     }</li><li> }</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_NotifyEndOfStream()通知编码器结束。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Surface模式：通知视频编码器输入流已结束，只能使用此接口进行通知。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoEncoder_NotifyEndOfStream(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Flush()刷新编码器。</p>       <p>调用OH_VideoEncoder_Flush接口后，编码器仍处于运行态，但会清除编码器中缓存的输入和输出数据及参数集如H.264格式的PPS/SPS。</p>       <p>此时需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_start" target="_blank">OH_VideoEncoder_Start</a>接口重新开始编码。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecMutex来避免调用Flush接口，状态切换后，编码线程还在跑会退出循环的问题。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 刷新编码器videoEnc。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">flushRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Flush</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">flushRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 重新开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">startRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">startRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Reset()重置编码器。</p>       <p>调用OH_VideoEncoder_Reset接口后，编码器回到初始化的状态，需要调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_configure" target="_blank">OH_VideoEncoder_Configure</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_prepare" target="_blank">OH_VideoEncoder_Prepare</a>重新配置。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 重置编码器videoEnc。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">resetRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Reset</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">resetRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 重新配置编码器参数。</span></li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">configRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">videoEnc</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">configRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 编码器重新就绪。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">prepareRet</span> = <span class="hljs-title function_">OH_VideoEncoder_Prepare</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">prepareRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>编码器回到初始化的状态，调用OH_VideoEncoder_Configure接口重新配置编码器参数时，同步模式需要重新配置OH_MD_KEY_ENABLE_SYNC_MODE为1，否则为异步模式。</p>        </div></div></div></li>      <li>       <p>（可选）调用OH_VideoEncoder_Stop()停止编码器。</p>       <p>调用OH_VideoEncoder_Stop接口后，编码器保留了编码实例，释放输入输出buffer。开发者可以直接调用OH_VideoEncoder_Start接口继续编码，输入的第一个buffer需要携带参数集，从IDR帧开始送入。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 终止编码器videoEnc。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Stop</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Destroy()销毁编码器实例，释放资源。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 注销编码器。</span></li><li><span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>OH_AVErrCode ret = AV_ERR_OK;</li><li><span class="hljs-keyword">if</span> (videoEnc != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">OH_VideoEncoder_Destroy</span>(videoEnc);</li><li>    videoEnc = <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>执行该步骤之后，需要开发者将videoEnc指向nullptr，防止野指针导致程序错误。</p>        </div></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="buffer模式">Buffer模式<i class="anchor-icon anchor-icon-link" anchorid="buffer模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Buffer模式下视频编码的全流程，实现同步模式的数据轮转。此处以输入YUV文件，编码成H.264格式为例。</p>     <ol>      <li>       <p>创建编码器实例。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecname创建编码器，应用有特殊需求，比如选择支持某种分辨率规格的编码器，可先查询capability，再根据codec name创建编码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">true</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoEnc = <span class="hljs-built_in">OH_VideoEncoder_CreateByName</span>(name);</li><li><span class="hljs-keyword">if</span> (videoEnc == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create videoEnc failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Configure()配置编码器。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>auto format = std::shared_ptr&lt;OH_AVFormat&gt;(OH_AVFormat_Create(), OH_AVFormat_Destroy);</li><li><span class="hljs-keyword">if</span> (format == nullptr) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_WIDTH, width); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_HEIGHT, height); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_PIXEL_FORMAT, pixelFormat);<span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_ENABLE_SYNC_MODE, <span class="hljs-number">1</span>); <span class="hljs-comment">// 同步模式配置。</span></li><li><span class="hljs-comment">// 配置编码器。</span></li><li>OH_AVErrCode ret = OH_VideoEncoder_Configure(videoEnc, format.<span class="hljs-keyword">get</span>());</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ol>          <li>要使能视频编码同步模式，必须将OH_MD_KEY_ENABLE_SYNC_MODE配置为1。</li>          <li>同步模式在调用OH_VideoEncoder_Configure接口前不能调用OH_VideoEncoder_RegisterCallback或OH_VideoEncoder_RegisterParameterCallback接口，否则为异步模式。</li>         </ol>        </div></div></div></li>      <li>       <p>调用OH_VideoEncoder_Prepare()编码器就绪。</p>       <p>该接口将在编码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li>ret = OH_VideoEncoder_Prepare(videoEnc);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoEncoder_Start()启动编码器。</p>       <p>配置输入文件、输出文件。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置待编码文件路径。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">inputFilePath</span> = <span class="hljs-string">"/*yourpath*.yuv"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string_view</span> <span class="hljs-title class_">outputFilePath</span> = <span class="hljs-string">"/*yourpath*.h264"</span>;</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ifstream</span>&gt; <span class="hljs-title class_">inputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ifstream</span>&gt;();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt; <span class="hljs-title class_">outputFile</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">ofstream</span>&gt;();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">inputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">inputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">inputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-keyword">in</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span>);</li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-keyword">open</span>(<span class="hljs-title class_">outputFilePath</span>.<span class="hljs-title class_">data</span>(), <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">binary</span> | <span class="hljs-variable">std</span>::<span class="hljs-variable">ios</span>::<span class="hljs-title class_">ate</span>);</li><li>}</li><li><span class="hljs-comment">// 启动编码器，开始编码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Start</span>(<span class="hljs-variable">videoEnc</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并写入码流至编码器</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_queryinputbuffer" target="_blank">OH_VideoEncoder_QueryInputBuffer</a>接口获取下一个可用的输入缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_getinputbuffer" target="_blank">OH_VideoEncoder_GetInputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>将需要编码的数据写入该缓冲区（buffer）后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_pushinputbuffer" target="_blank">OH_VideoEncoder_PushInputBuffer</a>接口将其送入编码输入队列进行编码。当所有待处理数据全部传递给编码器后，需要将flag标识成AVCODEC_BUFFER_FLAGS_EOS，通知编码器输入结束。</li>       </ul>       <p>示例中的变量size、offset、pts、frameData、flags说明与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EncoderInput</span><span class="hljs-params">(OH_AVCodec *videoEnc, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoEncoder_QueryInputBuffer</span>(videoEnc, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoEncoder_GetInputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>
</li><li>            <span class="hljs-comment">// 写入图像数据。</span></li><li>            <span class="hljs-type">int32_t</span> frameSize = <span class="hljs-number">0</span>;</li><li>            <span class="hljs-type">bool</span> isFirstFrame = <span class="hljs-literal">true</span>;</li><li>            <span class="hljs-comment">// 获取视频宽跨距和高跨距。</span></li><li>            <span class="hljs-keyword">if</span> (isFirstFrame) {</li><li>                <span class="hljs-keyword">auto</span> format = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_VideoEncoder_GetInputDescription</span>(videoEnc), OH_AVFormat_Destroy);</li><li>                <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>                    <span class="hljs-comment">// 异常处理。</span></li><li>                }</li><li>                <span class="hljs-type">bool</span> getIntRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_STRIDE, &amp;widthStride) &amp;&amp;</li><li>                                 <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_SLICE_HEIGHT, &amp;heightStride);</li><li>                 <span class="hljs-keyword">if</span> (!getIntRet) {</li><li>                     <span class="hljs-comment">// 异常处理。</span></li><li>                 }</li><li>                isFirstFrame = <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (widthStride == width &amp;&amp; heightStride == height) {</li><li>                frameSize = width * height * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// NV12像素格式下，每帧数据大小的计算公式。</span></li><li>                <span class="hljs-comment">// 处理文件流得到帧的长度，再将需要编码的数据写入到对应index的buffer中。</span></li><li>                <span class="hljs-type">uint8_t</span> *addr = <span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(buffer);</li><li>                <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) {</li><li>                   <span class="hljs-comment">// 异常处理</span></li><li>                   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>                }</li><li>                <span class="hljs-keyword">if</span> (inputFile != <span class="hljs-literal">nullptr</span> &amp;&amp; inputFile-&gt;<span class="hljs-built_in">is_open</span>()) {</li><li>                    inputFile-&gt;<span class="hljs-built_in">read</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(addr), frameSize);</li><li>                }</li><li>            } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-comment">// 如果跨距不等于宽，开发者需要按照跨距进行偏移，详情请参考视频编码Buffer模式“步骤-8. 写入编码图像”。</span></li><li>            }</li><li>
</li><li>            <span class="hljs-comment">// 配置buffer info信息。</span></li><li>            OH_AVCodecBufferAttr info;</li><li>            info.size = frameSize;</li><li>            info.offset = <span class="hljs-number">0</span>;</li><li>            info.pts = <span class="hljs-number">0</span>;</li><li>            OH_AVErrCode setBufferRet = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (setBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 送入编码输入队列进行编码，index为对应输入队列的下标。</span></li><li>            OH_AVErrCode pushInputRet = <span class="hljs-built_in">OH_VideoEncoder_PushInputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (pushInputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (inFile_-&gt;<span class="hljs-built_in">eof</span>()) {</li><li>                inputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并释放编码帧。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_queryoutputbuffer" target="_blank">OH_VideoEncoder_QueryOutputBuffer</a>接口获取下一个可用的输出缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_getoutputbuffer" target="_blank">OH_VideoEncoder_GetOutputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_freeoutputbuffer" target="_blank">OH_VideoEncoder_FreeOutputBuffer</a>接口释放编码帧。</li>       </ul>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">EncoderOutput</span><span class="hljs-params">(OH_AVCodec *videoEnc, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoEncoder_QueryOutputBuffer</span>(videoEnc, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoEncoder_GetOutputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>        </li><li>            <span class="hljs-comment">// 获取编码后信息。</span></li><li>            OH_AVCodecBufferAttr info;</li><li>            OH_AVErrCode getBufferRet = <span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (getBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 将编码完成帧数据buffer写入到对应输出文件中。</span></li><li>            <span class="hljs-type">uint8_t</span> *addr = <span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) {</li><li>               <span class="hljs-comment">// 异常处理</span></li><li>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (outputFile != <span class="hljs-literal">nullptr</span> &amp;&amp; outputFile-&gt;<span class="hljs-built_in">is_open</span>()) {</li><li>                outputFile-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(addr), info.size);</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (info.flags &amp; AVCODEC_BUFFER_FLAGS_EOS) {</li><li>                outputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 释放已完成处理的信息，index为对应buffer队列的下标。</span></li><li>            OH_AVErrCode freeOutputRet = <span class="hljs-built_in">OH_VideoEncoder_FreeOutputBuffer</span>(videoEnc, index);</li><li>            <span class="hljs-keyword">if</span> (freeOutputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_STREAM_CHANGED: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编码器送帧/出帧处理循环。</p>       <div _ngcontent-kmd-c106="" class="highlight-div"><div _ngcontent-kmd-c106="" class="highlight-div-header"><div _ngcontent-kmd-c106="" class="highlight-div-header-left"><div _ngcontent-kmd-c106="" class="handle-button expand-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmd-c106="" class="highlight-div-header-right"><div _ngcontent-kmd-c106="" class="handle-button ai-button"></div><div _ngcontent-kmd-c106="" class="handle-button line-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmd-c106="" class="handle-button theme-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmd-c106="" class="handle-button copy-button"><div _ngcontent-kmd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li><span class="hljs-type">int64_t</span> timeoutUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 单位：微秒（us），负值：无限等待；0：立即退出；正值：等待指定时长后退出。</span></li><li>
</li><li><span class="hljs-keyword">while</span> (!outputDone &amp;&amp; result) {</li><li>    <span class="hljs-keyword">if</span> (!inputDone) {</li><li>        result = <span class="hljs-built_in">EncoderInput</span>(videoEnc, timeoutUs);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!outputDone) {</li><li>        result = <span class="hljs-built_in">EncoderOutput</span>(videoEnc, timeoutUs);</li><li>    }</li><li>}</li></ol></pre></div></div></li>     </ol>     <p>后续流程（包括刷新、重置、停止和销毁编码器）与Surface模式基本一致，请参考<a href="/consumer/cn/doc/harmonyos-guides/synchronous-video-encoding#surface模式">Surface模式</a>的步骤9-12。</p>    </div>   </div>   <div></div></div>