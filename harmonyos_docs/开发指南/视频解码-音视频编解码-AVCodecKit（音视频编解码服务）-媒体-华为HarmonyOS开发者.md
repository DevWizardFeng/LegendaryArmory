<h1 _ngcontent-dcv-c119="" class="doc-title ng-star-inserted" title="视频解码"> 视频解码 </h1>

<div _ngcontent-dcv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以调用本模块的Native API接口，完成视频解码，即将媒体数据解码成YUV文件或送显。</p>    <p>具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>    <p>当前支持的解码能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#视频解码">AVCodec支持的格式</a>。</p>    <p>如果需要对HDRVivid视频进行解码，需要配置MimeType为H265 (OH_AVCODEC_MIMETYPE_VIDEO_HEVC)，本功能从API version 11开始支持。</p>    <p>通过视频解码，应用可以实现以下重点能力，包括：</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.1" valign="top" width="50%">支持的能力</th>        <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.2" valign="top" width="50%">使用简述</th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">变分辨率</td>        <td class="cellrowborder" valign="top" width="50%">解码器支持输入码流分辨率发生变化，发生变化后会触发OH_VideoDecoder_RegisterCallback接口设置的回调函数OnStreamChanged()。具体可参考下文中：Surface模式步骤-3或Buffer模式步骤-3</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">动态切换surface</td>        <td class="cellrowborder" valign="top" width="50%">通过调用OH_VideoDecoder_SetSurface接口配置，仅Surface模式支持。具体可参考下文中：Surface模式步骤-6</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">低时延解码</td>        <td class="cellrowborder" valign="top" width="50%">通过调用OH_VideoDecoder_Configure接口配置，具体可参考下文中：Surface模式的步骤-5或Buffer模式步骤-5</td>       </tr>           </tbody></table></div>    </div>    <div class="tiledSection">     <h2 id="限制约束">限制约束<i class="anchor-icon anchor-icon-link" anchorid="限制约束" tips="复制节点链接"></i></h2>          <ol>      <li>Flush，Reset，Stop之后，重新Start时，需要重新传PPS/SPS。具体示例请参考<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">Surface模式</a>“步骤-13：调用OH_VideoDecoder_Flush()”。</li>      <li>Flush，Reset，Stop，Destroy在非回调线程中执行时，会等待所有回调执行完成后，将执行结果返回给开发者。</li>      <li>由于硬件解码器资源有限，每个解码器在使用完毕后都必须调用OH_VideoDecoder_Destroy接口来销毁实例并释放资源。</li>      <li>视频解码输入码流仅支持AnnexB格式，且支持的AnnexB格式支持多slice，要求同一帧的多个slice一次送入解码器。</li>      <li>在调用Flush，Reset，Stop的过程中，开发者不应对之前回调函数获取到的OH_AVBuffer继续进行操作。</li>      <li>DRM解密能力在<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">Surface模式</a>下既支持非安全视频通路，也支持安全视频通路，在<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式">Buffer模式</a>下仅支持非安全视频通路。</li>      <li>Buffer模式和Surface模式使用方式一致的接口，所以只提供了Surface模式的示例。</li>      <li>在Buffer模式下，开发者通过输出回调函数OH_AVCodecOnNewOutputBuffer获取到OH_AVBuffer的指针实例后，必须通过调用OH_VideoDecoder_FreeOutputBuffer接口来通知系统该实例已被使用完毕。这样系统才能够将后续解码的数据写入到相应的位置。如果开发者在调用OH_AVBuffer_GetNativeBuffer接口时获取到OH_NativeBuffer指针实例，并且该实例的生命周期超过了当前的OH_AVBuffer指针实例，那么需要进行一次数据的拷贝操作。在这种情况下，开发者需要自行管理新生成的OH_NativeBuffer实例的生命周期，确保其正确使用和释放。</li>      <li>为确保系统服务的持续可用性，当检测到应用存在异常实例占用行为时，系统将自动介入。开发者应注意：持续的实例管理不当可能导致进程被终止。</li>     </ol>    </div>    <div class="tiledSection">     <h2 id="surface输出与buffer输出">surface输出与buffer输出<i class="anchor-icon anchor-icon-link" anchorid="surface输出与buffer输出" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>两者数据的输出方式不同。</p></li>      <li>       <p>两者的适用场景不同：</p>       <ul>        <li>surface输出是指用OHNativeWindow来传递输出数据，可以与其他模块对接，例如XComponent。</li>        <li>buffer输出是指经过解码的数据会以共享内存的方式输出。</li>       </ul></li>      <li>       <p>在接口调用的过程中，两种方式的接口调用方式基本一致，但存在以下差异点：</p>       <ul>        <li>在Surface模式下，可选择调用OH_VideoDecoder_FreeOutputBuffer接口丢弃输出帧（不送显）；在Buffer模式下，应用必须调用OH_VideoDecoder_FreeOutputBuffer接口释放数据。</li>        <li>Surface模式下，应用在解码器就绪前，必须调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_setsurface" target="_blank">OH_VideoDecoder_SetSurface</a>接口设置OHNativeWindow。启动后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbuffer" target="_blank">OH_VideoDecoder_RenderOutputBuffer</a>接口显示并释放解码帧，或调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbufferattime" target="_blank">OH_VideoDecoder_RenderOutputBufferAtTime</a>接口在指定时间点显示并释放解码帧。如需实现音画同步或者控制显示速度，建议优先调用OH_VideoDecoder_RenderOutputBufferAtTime接口送显。</li>        <li>输出回调传出的buffer，在Buffer模式下，可以获取共享内存的地址和数据信息；在Surface模式下，只能获取buffer的数据信息。</li>       </ul></li>      <li>       <p>Surface模式的数据流转性能优于Buffer模式。</p></li>     </ol>     <p>两种模式的开发步骤详细说明请参考：<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">Surface模式</a>和<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式">Buffer模式</a>。</p>    </div>    <div class="tiledSection">     <h2 id="状态机调用关系">状态机调用关系<i class="anchor-icon anchor-icon-link" anchorid="状态机调用关系" tips="复制节点链接"></i></h2>          <p>如下为状态机调用关系图：</p>     <p><span><img originheight="2505" originwidth="4128" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114435.53411241319474495129412149396440:50001231000000:2800:7E028FB6745233222DB5CAA9E830FDAE314804ABE2CB02708FBE77AEEED97FE8.png" width="920" height="558.2848837209302"></span></p>     <ol>      <li>       <p>有两种方式可以使解码器进入Initialized状态：</p>       <ul>        <li>初始创建解码器实例时，解码器处于Initialized状态。</li>        <li>任何状态下，调用OH_VideoDecoder_Reset接口，解码器将会移回Initialized状态。</li>       </ul></li>      <li>       <p>Initialized状态下，调用OH_VideoDecoder_Configure接口配置解码器，配置成功后解码器进入Configured状态。</p></li>      <li>       <p>Configured状态下，调用OH_VideoDecoder_Prepare接口进入Prepared状态。</p></li>      <li>       <p>Prepared状态下，调用OH_VideoDecoder_Start接口使解码器进入Executing状态：</p>       <ul>        <li>处于Executing状态时，调用OH_VideoDecoder_Stop接口可以使解码器返回到Prepared状态。</li>       </ul></li>      <li>       <p>在极少数情况下，解码器可能会遇到错误并进入Error状态。解码器的错误传递，可以通过队列操作返回无效值或者抛出异常：</p>       <ul>        <li>Error状态下，可以调用解码器OH_VideoDecoder_Reset接口将解码器移到Initialized状态；或者调用OH_VideoDecoder_Destroy接口移动到最后的Released状态。</li>       </ul></li>      <li>       <p>Executing状态具有三个子状态：Flushed、Running和End-of-Stream：</p>       <ul>        <li>在调用了OH_VideoDecoder_Start接口之后，解码器立即进入Running子状态。</li>        <li>对于处于Executing状态的解码器，可以调用OH_VideoDecoder_Flush接口返回到Flushed子状态。</li>        <li>当待处理数据全部传递给解码器后，在input buffers队列中为最后一个入队的input buffer中添加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-info-h#oh_avcodecbufferflags" target="_blank">AVCODEC_BUFFER_FLAGS_EOS</a>标记，遇到这个标记时，解码器会转换为End-of-Stream子状态。在此状态下，解码器不再接受新的输入，但是仍然会继续生成输出，直到输出到达尾帧。</li>       </ul></li>      <li>       <p>使用完解码器后，必须调用OH_VideoDecoder_Destroy接口销毁解码器实例，使解码器进入Released状态。</p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h" target="_blank">API文档</a>。</p>     <p>如下为视频解码调用关系图：</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="4425" originwidth="5097" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114436.10854770418795398012741138985957:50001231000000:2800:32366D5EC3BBE3037C12750F14091D0483923EDA7DA56272B576BD03F62750CC.png" width="920" height="798.7051206592114"></span></p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="定义基础结构">定义基础结构<i class="anchor-icon anchor-icon-link" anchorid="定义基础结构" tips="复制节点链接"></i></h3>          <p>本部分示例代码按照C++17标准编写，仅作参考。开发者可以参考此部分，定义自己的buffer对象。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>解码器回调buffer的信息。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer): <span class="hljs-built_in">index</span>(index), <span class="hljs-built_in">buffer</span>(buffer), <span class="hljs-built_in">isValid</span>(<span class="hljs-literal">true</span>) {}</li><li>    <span class="hljs-comment">// 回调buffer。</span></li><li>    OH_AVBuffer *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 回调buffer对应的index。</span></li><li>    <span class="hljs-type">uint32_t</span> index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// 判断当前buffer信息是否有效。</span></li><li>    <span class="hljs-type">bool</span> isValid = <span class="hljs-literal">true</span>;</li><li>};</li></ol></pre></div></div></li>      <li>       <p>解码输入输出队列。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodecBufferQueue</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-comment">// 将回调buffer的信息传入队列。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Enqueue</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">bufferInfo</span>);</li><li>        <span class="hljs-variable">cond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 获取回调buffer的信息。</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">Dequeue</span>(<span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">timeoutMs</span> = <span class="hljs-number">1000</span>)</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        (<span class="hljs-variable">void</span>)<span class="hljs-variable">cond_</span>.<span class="hljs-title function_">wait_for</span>(<span class="hljs-variable">lock</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-title class_">timeoutMs</span>), [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>        <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">bufferInfo</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空队列，之前的回调buffer设置为不可用。</span></li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Flush</span>()</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>        <span class="hljs-keyword">while</span> (!<span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">empty</span>()) {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">front</span>();</li><li>            <span class="hljs-comment">// Flush、Stop、Reset、Destroy操作之后，之前回调的buffer信息设置为无效。</span></li><li>            <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">bufferQueue_</span>.<span class="hljs-title function_">pop</span>();</li><li>        }</li><li>    }</li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">mutex_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">cond_</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;&gt; <span class="hljs-title class_">bufferQueue_</span>;</li><li>};</li></ol></pre></div></div></li>      <li>       <p>全局变量。</p>       <p>仅作参考，可以根据实际情况将其封装到对象中。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 视频帧宽度。</span></li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">320</span>;</li><li><span class="hljs-comment">// 视频帧高度。</span></li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">240</span>;</li><li><span class="hljs-comment">// 视频像素格式。</span></li><li> OH_AVPixelFormat pixelFormat = AV_PIXEL_FORMAT_NV12;</li><li><span class="hljs-comment">// 视频宽跨距。</span></li><li><span class="hljs-type">int32_t</span> widthStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 视频高跨距。</span></li><li><span class="hljs-type">int32_t</span> heightStride = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// 解码器实例指针。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 解码器同步锁。</span></li><li>std::shared_mutex codecMutex;</li><li><span class="hljs-comment">// 解码器输入队列。</span></li><li>CodecBufferQueue inQueue;</li><li><span class="hljs-comment">// 解码器输出队列。</span></li><li>CodecBufferQueue outQueue;</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="surface模式">Surface模式<i class="anchor-icon anchor-icon-link" anchorid="surface模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Surface模式下视频解码的全流程，实现异步模式的数据轮转。此处以输入H.264码流文件，解码送显输出为例。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建解码器实例。</p>       <p>开发者可以通过名称或媒体类型创建解码器。示例中的变量说明如下：</p>       <ul>        <li>videoDec：视频解码器实例的指针；</li>        <li>capability：解码器能力查询实例的指针；</li>        <li>OH_AVCODEC_MIMETYPE_VIDEO_AVC：AVC格式视频编解码器。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecname创建解码器，应用有特殊需求，比如选择支持某种分辨率规格的解码器，可先查询capability，再根据codec name创建解码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>);</li><li><span class="hljs-comment">// 创建硬件解码器实例。</span></li><li>OH_AVCapability *capability= <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>, HARDWARE);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name);</li></ol></pre></div></div>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过MIME TYPE创建解码器，只能创建系统推荐的特定编解码器。</span></li><li><span class="hljs-comment">// 涉及创建多路编解码器时，优先创建硬件解码器实例，硬件资源不够时再创建软件解码器实例。</span></li><li><span class="hljs-comment">// 软/硬解：创建H.264解码器实例。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-comment">// 软/硬解：创建H.265解码器实例。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_RegisterCallback()设置回调函数。</p>       <p>注册回调函数指针集合OH_AVCodecCallback，包括：</p>       <ul>        <li>OH_AVCodecOnError 解码器运行错误，返回的错误码详情请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcodeconerror" target="_blank">OH_AVCodecOnError</a>；</li>        <li>OH_AVCodecOnStreamChanged 码流信息变化，如码流宽、高变化；</li>        <li>OH_AVCodecOnNeedInputBuffer 运行过程中需要新的输入数据，即解码器已准备好，可以输入数据；</li>        <li>OH_AVCodecOnNewOutputBuffer 运行过程中产生了新的输出数据，即解码完成。</li>       </ul>       <p>开发者可以通过处理该回调报告的信息，确保解码器正常运转。</p>       <p>回调函数的具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 解码异常回调OH_AVCodecOnError实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 回调的错误码由开发者判断处理。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)errorCode;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码数据流变化回调OH_AVCodecOnStreamChanged实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnStreamChanged</span><span class="hljs-params">(OH_AVCodec *codec, OH_AVFormat *format, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 可通过format获取到变化后的视频宽、高等。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    <span class="hljs-type">bool</span> ret = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_PIC_WIDTH, &amp;width) &amp;&amp;</li><li>               <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_VIDEO_PIC_HEIGHT, &amp;height);</li><li>    <span class="hljs-keyword">if</span> (!ret) {</li><li>         <span class="hljs-comment">// 异常处理。</span></li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码输入回调OH_AVCodecOnNeedInputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 输入帧的数据buffer和对应的index送入inQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    inQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码输出回调OH_AVCodecOnNewOutputBuffer实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNewOutputBuffer</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *buffer, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 完成帧的数据buffer和对应的index送入outQueue队列。</span></li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    outQueue.<span class="hljs-built_in">Enqueue</span>(std::<span class="hljs-built_in">make_shared</span>&lt;CodecBufferInfo&gt;(index, buffer));</li><li>}</li><li><span class="hljs-comment">// 配置异步回调，调用 OH_VideoDecoder_RegisterCallback 接口。</span></li><li>OH_AVCodecCallback cb = {&amp;OnError, &amp;OnStreamChanged, &amp;OnNeedInputBuffer, &amp;OnNewOutputBuffer};</li><li><span class="hljs-comment">// 配置异步回调。</span></li><li>OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoDecoder_RegisterCallback</span>(videoDec, cb, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// nullptr:开发者执行回调所依赖的数据userData为空。</span></li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ol>          <li>在回调函数中，对数据队列进行操作时，需要注意多线程同步的问题。</li>          <li>播放视频时，若视频码流的SPS中包含颜色信息，解码器会把这些信息（RangeFlag、ColorPrimary、MatrixCoefficient、TransferCharacteristic）通过OH_AVCodecOnStreamChanged接口中的OH_AVFormat返回。</li>          <li>视频解码的Surface模式下，内部数据默认是走HEBC（High Efficiency Bandwidth Compression，高效带宽压缩），无法获取到widthStride和heightStride的值。</li>         </ol>        </div></div></div></li>      <li>       <p>（可选）OH_VideoDecoder_SetDecryptionConfig设置解密配置。在获取到DRM信息（参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>开发步骤第4步），完成DRM许可证申请后，通过此接口进行解密配置。此接口需在Prepare前调用。在Surface模式下，DRM解密能力既支持安全视频通路，也支持非安全视频通路。DRM相关接口详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-drm" target="_blank">DRM API文档</a>。</p>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysystem.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysession.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_err.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_common.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_drm.so)</li></ol></pre></div></div>       <p>根据DRM码流要求的内容保护级别和硬件设备支持的内容保护级别创建对应的通路。</p>       <p>如果DRM码流要求的内容保护级别是硬件级保护，则推荐使用安全视频通路，示例如下：</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据DRM信息创建指定的DRM系统, 以创建"com.wiseplay.drm"为例</span></li><li>MediaKeySystem *system = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;system);</li><li><span class="hljs-keyword">if</span> (system == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key system failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建解密会话，如果使用安全视频通路，应创建CONTENT_PROTECTION_LEVEL_HW_CRYPTO及其以上内容保护级别的MediaKeySession；</span></li><li>MediaKeySession *session = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_HW_CRYPTO;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(system, &amp;contentProtectionLevel, &amp;session);</li><li><span class="hljs-keyword">if</span> (ret != DRM_OK) {</li><li>    <span class="hljs-comment">// 如创建失败，请查看DRM接口文档及日志信息</span></li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key session failed."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (session == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"media key session is nullptr."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取许可证请求、设置许可证响应等</span></li><li>
</li><li><span class="hljs-comment">// 设置解密配置, 即将解密会话、安全视频通路标志设置到解码器中</span></li><li><span class="hljs-comment">// 如果DRM解决方案支持安全视频通路，在使用安全视频通路时，需将secureVideoPath设置为true，并在此之前须创建安全解码器</span></li><li><span class="hljs-comment">// 即在步骤3使用OH_VideoDecoder_CreateByName函数、参数为解码器名称后拼接.secure（如“[CodecName].secure”）创建安全解码器</span></li><li><span class="hljs-type">bool</span> secureVideoPath = <span class="hljs-literal">true</span>;</li><li>ret = <span class="hljs-built_in">OH_VideoDecoder_SetDecryptionConfig</span>(videoDec, session, secureVideoPath);</li></ol></pre></div></div>       <p>如果DRM码流要求的内容保护级别是软件级保护，则推荐使用非安全视频通路，示例如下：</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据DRM信息创建指定的DRM系统，以创建"com.wiseplay.drm"为例。</span></li><li>MediaKeySystem *system = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;system);</li><li><span class="hljs-keyword">if</span> (system == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key system failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建解密会话，如果使用安全视频通路，应创建CONTENT_PROTECTION_LEVEL_HW_CRYPTO及其以上内容保护级别的MediaKeySession；</span></li><li><span class="hljs-comment">// 如果使用非安全视频通路，应创建CONTENT_PROTECTION_LEVEL_SW_CRYPTO及以上内容保护级别的MediaKeySession。</span></li><li>MediaKeySession *session = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_SW_CRYPTO;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(system, &amp;contentProtectionLevel, &amp;session);</li><li><span class="hljs-keyword">if</span> (ret != DRM_OK) {</li><li>    <span class="hljs-comment">// 如创建失败，请查看DRM接口文档及日志信息。</span></li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key session failed."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (session == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"media key session is nullptr."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取许可证请求、设置许可证响应等。</span></li><li>
</li><li><span class="hljs-comment">// 设置解密配置，即将解密会话、安全视频通路标志设置到解码器中。</span></li><li><span class="hljs-comment">// 如果DRM解决方案支持安全视频通路，在使用安全视频通路时，需将secureVideoPath设置为true，并在此之前须创建安全解码器。</span></li><li><span class="hljs-comment">// 即在步骤2使用OH_VideoDecoder_CreateByName函数、参数为解码器名称后拼接.secure（如“[CodecName].secure”）创建安全解码器。</span></li><li><span class="hljs-type">bool</span> secureVideoPath = <span class="hljs-literal">false</span>;</li><li>ret = <span class="hljs-built_in">OH_VideoDecoder_SetDecryptionConfig</span>(videoDec, session, secureVideoPath);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Configure()配置解码器。</p>       <p>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">视频专有键值对</a>。</p>       <p>参数校验规则请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configure" target="_blank">OH_VideoDecoder_Configure() 参考文档</a>。</p>       <p>参数取值范围可以通过能力查询接口获取，具体示例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/obtain-supported-codecs">获取支持的编解码能力</a>。</p>       <p>目前支持的所有格式都必须配置以下选项：视频帧宽度、视频帧高度。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>auto format = std::shared_ptr&lt;OH_AVFormat&gt;(OH_AVFormat_Create(), OH_AVFormat_Destroy);</li><li><span class="hljs-keyword">if</span> (format == nullptr) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_WIDTH, width); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_HEIGHT, height); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_PIXEL_FORMAT, pixelFormat);</li><li><span class="hljs-comment">// 可选，配置低时延解码。</span></li><li><span class="hljs-comment">// 若平台支持，当使能OH_MD_KEY_VIDEO_ENABLE_LOW_LATENCY接口时，视频解码器将按照解码序输出帧。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_VIDEO_ENABLE_LOW_LATENCY, <span class="hljs-number">1</span>);</li><li><span class="hljs-comment">// 配置解码器。</span></li><li>OH_AVErrCode ret = OH_VideoDecoder_Configure(videoDec, format.<span class="hljs-keyword">get</span>());</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>设置surface。</p>       <p>本例中的nativeWindow，有两种方式获取：</p>       <p>6.1 如果解码后直接显示，则从XComponent组件获取。</p>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_window/external_window.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_window.so)</li></ol></pre></div></div>       <p>6.1.1 在ArkTS侧，通过xComponentController组件的getXComponentSurfaceId接口获取XComponent对应的surface的ID。详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines">自定义渲染 (XComponent)</a>。</p>       <p>6.1.2 在Native侧，调用OH_NativeWindow_CreateNativeWindowFromSurfaceId接口创建出NativeWindow实例。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>OHNativeWindow* nativeWindow;</li><li><span class="hljs-comment">// 基于步骤1.1中获取的surfaceId创建对应的nativeWindow实例。</span></li><li><span class="hljs-built_in">OH_NativeWindow_CreateNativeWindowFromSurfaceId</span>(surfaceId, &amp;nativeWindow);</li></ol></pre></div></div>       <p>6.2 如果解码后接OpenGL后处理，则从NativeImage获取，获取方式请参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-image-guidelines">NativeImage</a>。</p>       <p>Surface模式，开发者可以在解码过程中执行该步骤，即动态切换surface。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置surface。</span></li><li><span class="hljs-comment">// 配置送显窗口参数。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_SetSurface(videoDec, nativeWindow);  <span class="hljs-comment">// nativeWindow通过以上两种方式获取。</span></li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 配置视频与显示屏匹配模式（缓冲区按原比例缩放，使得缓冲区的较小边与窗口匹配，较长边超出窗口的部分被视为透明）。</span></li><li>OH_NativeWindow_NativeWindowSetScalingModeV2(nativeWindow, OH_SCALING_MODE_SCALE_CROP_V2);</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>若应用对1号和2号解码器均通过调用OH_VideoDecoder_SetSurface接口绑定至同一个NativeWindow。在2号解码器处于Running状态时，1号解码器调用OH_VideoDecoder_Destroy接口后，会导致2号解码器的视频播放画面卡住。</p>         <p>可以采用以下方案进行更改：</p>         <ol>          <li>等1号解码器完全释放后，再调用OH_VideoDecoder_Start接口启动2号解码器；</li>          <li>1号解码器用surface1，2号解码器先调用OH_ConsumerSurface_Create接口创建临时surface，等1号解码器释放后，再调用OH_VideoDecoder_SetSurface接口将2号解码器绑定至surface1上，详情请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/parallel-decoding-nativewindow">创建视频解码器和NativeWindow初始化并行</a>。</li>         </ol>        </div></div></div></li>      <li>       <p>调用OH_VideoDecoder_Prepare()解码器就绪。</p>       <p>该接口将在解码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Prepare(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Start()启动解码器。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 启动解码器，开始解码。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Start(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）OH_VideoDecoder_SetParameter()动态配置解码器surface参数。</p>       <p>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">视频专有键值对</a>。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 配置显示旋转角度。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_ROTATION</span>, <span class="hljs-number">90</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_SetParameter</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AVCencInfo_SetAVBuffer()，设置cencInfo。</p>       <p>若当前播放的节目是DRM加密节目，应用自行实现媒体解封装功能而非使用系统<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">解封装</a>功能时，需调用OH_AVCencInfo_SetAVBuffer()将cencInfo设置到AVBuffer，这样AVBuffer携带待解密的数据以及cencInfo，以实现AVBuffer中媒体数据的解密。当应用使用系统<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">解封装</a>功能时，则无需调用此接口。</p>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_cencinfo.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avcencinfo.so)</li></ol></pre></div></div>       <p>使用示例：</p>       <ul>        <li>buffer：回调函数OnNeedInputBuffer传入的参数。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint32_t</span> keyIdLen = DRM_KEY_ID_SIZE;</li><li><span class="hljs-type">uint8_t</span> keyId[] = {</li><li>    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x96</span>,</li><li>    <span class="hljs-number">0xcf</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x28</span>};</li><li><span class="hljs-type">uint32_t</span> ivLen = DRM_KEY_IV_SIZE;</li><li><span class="hljs-type">uint8_t</span> iv[] = {</li><li>    <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xde</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x3e</span>,</li><li>    <span class="hljs-number">0x52</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x95</span>};</li><li><span class="hljs-type">uint32_t</span> encryptedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> skippedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> firstEncryptedOffset = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> subsampleCount = <span class="hljs-number">1</span>;</li><li>DrmSubsample subsamples[<span class="hljs-number">1</span>] = { {<span class="hljs-number">0x10</span>, <span class="hljs-number">0x16</span>} };</li><li><span class="hljs-comment">// 创建CencInfo实例。</span></li><li>OH_AVCencInfo *cencInfo = <span class="hljs-built_in">OH_AVCencInfo_Create</span>();</li><li><span class="hljs-keyword">if</span> (cencInfo == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置解密算法。</span></li><li>OH_AVErrCode errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAlgorithm</span>(cencInfo, DRM_ALG_CENC_AES_CTR);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置KeyId和Iv。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetKeyIdAndIv</span>(cencInfo, keyId, keyIdLen, iv, ivLen);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置Sample信息。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetSubsampleInfo</span>(cencInfo, encryptedBlockCount, skippedBlockCount, firstEncryptedOffset,</li><li>    subsampleCount, subsamples);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置模式：KeyId、Iv和SubSamples已被设置。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetMode</span>(cencInfo, DRM_CENC_INFO_KEY_IV_SUBSAMPLES_SET);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将CencInfo设置到AVBuffer中。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAVBuffer</span>(cencInfo, buffer);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 销毁CencInfo实例。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_Destroy</span>(cencInfo);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_PushInputBuffer()写入解码码流。</p>       <p>送入输入队列进行解码，以下示例中：</p>       <ul>        <li>size、offset、pts、frameData：输入尺寸、偏移量、时间戳、帧数据等字段信息，获取方式可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>“步骤-9：开始解封装，循环获取sample”；</li>        <li>flags：缓冲区标记的类别，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-info-h#oh_avcodecbufferflags" target="_blank">OH_AVCodecBufferFlags</a>。</li>       </ul>       <p>bufferInfo的成员变量：</p>       <ul>        <li>buffer：回调函数OnNeedInputBuffer传入的参数，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口获取输入码流虚拟地址；</li>        <li>index：回调函数OnNeedInputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入码流数据。</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">capacity</span> = <span class="hljs-title function_">OH_AVBuffer_GetCapacity</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">size</span> &gt; <span class="hljs-variable">capacity</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">addr</span>, <span class="hljs-variable">frameData</span>, <span class="hljs-variable">size</span>);</li><li><span class="hljs-comment">// 配置帧数据的输入尺寸、偏移量、时间戳等字段信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">size</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">offset</span> = <span class="hljs-variable">offset</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">pts</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">flags</span>;</li><li><span class="hljs-comment">// info信息写入buffer。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 送入解码输入队列进行解码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">pushInputRet</span> = <span class="hljs-title function_">OH_VideoDecoder_PushInputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">pushInputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_RenderOutputBuffer()/OH_VideoDecoder_RenderOutputBufferAtTime()显示并释放解码帧，</p>       <p>或调用OH_VideoDecoder_FreeOutputBuffer()释放解码帧。</p>       <p>以下示例中，bufferInfo的成员变量：</p>       <ul>        <li>index：回调函数OnNewOutputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>buffer：回调函数OnNewOutputBuffer传入的参数，Surface模式开发者无法通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口获取图像虚拟地址；</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 获取解码后信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">getBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">getBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 值由开发者决定。</span></li><li><span class="hljs-variable">bool</span> <span class="hljs-variable">isRender</span>;</li><li><span class="hljs-variable">bool</span> <span class="hljs-variable">isNeedRenderAtTime</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">AV_ERR_OK</span>;</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">isRender</span>) {</li><li>    <span class="hljs-comment">// 显示并释放已完成处理的信息，index为对应buffer队列的下标。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">isNeedRenderAtTime</span>){</li><li>        <span class="hljs-comment">// 获取系统绝对时间，renderTimestamp由开发者结合业务指定显示时间。</span></li><li>        <span class="hljs-variable">int64_t</span> <span class="hljs-variable">renderTimestamp</span> =</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">nanoseconds</span>&gt;(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-variable">high_resolution_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title class_">count</span>();</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_RenderOutputBufferAtTime</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>, <span class="hljs-variable">renderTimestamp</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_RenderOutputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li>    }</li><li>
</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 释放已完成处理的信息。</span></li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_FreeOutputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ol>          <li>如果要获取buffer的属性，如pixel_format、stride等可通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-external-window-h#oh_nativewindow_nativewindowhandleopt" target="_blank">OH_NativeWindow_NativeWindowHandleOpt</a>接口获取。</li>          <li>显示并释放解码帧时，推荐优先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbufferattime" target="_blank">OH_VideoDecoder_RenderOutputBufferAtTime</a>接口。</li>         </ol>        </div></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Flush()刷新解码器。</p>       <p>调用OH_VideoDecoder_Flush接口后，解码器仍处于运行态，但会清除解码器中缓存的输入和输出数据及参数集如H.264格式的PPS/SPS。</p>       <p>此时需要调用OH_VideoDecoder_Start接口重新开始解码。</p>       <p>以下示例中：</p>       <ul>        <li>xpsData、xpsSize：PPS/SPS信息，获取方式可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 刷新解码器videoDec。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">flushRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Flush</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">flushRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-comment">// 重新开始解码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">startRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Start</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">startRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 重传PPS/SPS。</span></li><li><span class="hljs-comment">// 配置帧数据PPS/SPS信息。</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理</span></li><li>}</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">capacity</span> = <span class="hljs-title function_">OH_AVBuffer_GetCapacity</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">xpsSize</span> &gt; <span class="hljs-variable">capacity</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">addr</span>, <span class="hljs-variable">xpsData</span>, <span class="hljs-variable">xpsSize</span>);</li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">AVCODEC_BUFFER_FLAG_CODEC_DATA</span>;</li><li><span class="hljs-comment">// info信息写入buffer。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将帧数据推送到解码器中，index为对应buffer队列的下标。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">pushInputRet</span> = <span class="hljs-title function_">OH_VideoDecoder_PushInputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">pushInputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>Flush之后，重新调用OH_VideoDecoder_Start接口时，需要重新传PPS/SPS。</p>        </div></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Reset()重置解码器。</p>       <p>调用OH_VideoDecoder_Reset接口后，解码器回到初始化的状态，需要调用OH_VideoDecoder_Configure接口、OH_VideoDecoder_SetSurface接口和OH_VideoDecoder_Prepare接口重新配置。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 重置解码器videoDec。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">resetRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Reset</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">resetRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-comment">// 重新配置解码器参数。</span></li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">configRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Configure</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">configRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// Surface模式重新配置surface，而Buffer模式不需要配置surface。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setRet</span> = <span class="hljs-title function_">OH_VideoDecoder_SetSurface</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">nativeWindow</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 解码器重新就绪。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">prepareRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Prepare</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">prepareRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Stop()停止解码器。</p>       <p>调用OH_VideoDecoder_Stop()后，解码器保留了解码实例，释放输入输出buffer。开发者可以直接调用OH_VideoDecoder_Start接口继续解码，输入的第一个buffer需要携带参数集，从IDR帧开始送入。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 终止解码器videoDec。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_Stop</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Flush</span>();</li><li><span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Flush</span>();</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Destroy()销毁解码器实例，释放资源。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ol>          <li>不能在回调函数中调用；</li>          <li>执行该步骤之后，需要开发者将videoDec指向nullptr，防止野指针导致程序错误。</li>         </ol>        </div></div></div>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li><span class="hljs-comment">// 释放nativeWindow实例。</span></li><li><span class="hljs-keyword">if</span>(nativeWindow != <span class="hljs-literal">nullptr</span>){</li><li>    <span class="hljs-built_in">OH_NativeWindow_DestroyNativeWindow</span>(nativeWindow);</li><li>    nativeWindow = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li><span class="hljs-comment">// 调用OH_VideoDecoder_Destroy，注销解码器。</span></li><li>OH_AVErrCode ret = AV_ERR_OK;</li><li><span class="hljs-keyword">if</span> (videoDec != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">OH_VideoDecoder_Destroy</span>(videoDec);</li><li>    videoDec = <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>inQueue.<span class="hljs-built_in">Flush</span>();</li><li>outQueue.<span class="hljs-built_in">Flush</span>();</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="buffer模式">Buffer模式<i class="anchor-icon anchor-icon-link" anchorid="buffer模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Buffer模式下视频解码的全流程，实现异步模式的数据轮转。此处以输入H.264码流文件，解码成YUV文件为例。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建解码器实例。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecname创建解码器，应用有特殊需求，比如选择支持某种分辨率规格的解码器，可先查询capability，再根据codec name创建解码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name);</li></ol></pre></div></div>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过MIME TYPE创建解码器，只能创建系统推荐的特定编解码器。</span></li><li><span class="hljs-comment">// 涉及创建多路编解码器时，优先创建硬件解码器实例，硬件资源不够时再创建软件解码器实例。</span></li><li><span class="hljs-comment">// 软/硬解：创建H.264解码器。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC);</li><li><span class="hljs-comment">// 硬解：创建H.265解码器。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_RegisterCallback()设置回调函数。</p>       <p>注册回调函数指针集合OH_AVCodecCallback，包括：</p>       <ul>        <li>OH_AVCodecOnError 解码器运行错误，返回的错误码详情请参见：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcodeconerror" target="_blank">OH_AVCodecOnError</a>；</li>        <li>OH_AVCodecOnStreamChanged 码流信息变化，如码流宽、高变化；</li>        <li>OH_AVCodecOnNeedInputBuffer 运行过程中需要新的输入数据，即解码器已准备好，可以输入数据；</li>        <li>OH_AVCodecOnNewOutputBuffer 运行过程中产生了新的输出数据，即解码完成。</li>       </ul>       <p>开发者可以通过处理该回调报告的信息，确保解码器正常运转。</p>       <p>回调函数的具体实现可参考<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">示例工程</a>。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">cropTop</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">cropBottom</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">cropLeft</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">cropRight</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-variable">bool</span> <span class="hljs-variable">isFirstFrame</span> = <span class="hljs-keyword">true</span>;</li><li><span class="hljs-comment">// 解码异常回调OH_AVCodecOnError实现。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnError</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">int32_t</span> <span class="hljs-variable">errorCode</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>)</li><li>{</li><li>    <span class="hljs-comment">// 回调的错误码由开发者判断处理。</span></li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">errorCode</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">userData</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码数据流变化回调OH_AVCodecOnStreamChanged实现。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnStreamChanged</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可选，开发者需要获取视频宽、高、跨距等时可配置。</span></li><li>    <span class="hljs-comment">// 可通过format获取到变化后的视频宽、高、跨距等。</span></li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">userData</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_PIC_WIDTH</span>, &amp;<span class="hljs-title class_">width</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_PIC_HEIGHT</span>, &amp;<span class="hljs-title class_">height</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_STRIDE</span>, &amp;<span class="hljs-title class_">widthStride</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_SLICE_HEIGHT</span>, &amp;<span class="hljs-title class_">heightStride</span>) &amp;&amp;</li><li>               <span class="hljs-comment">// 获取裁剪矩形信息可选。</span></li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_TOP</span>, &amp;<span class="hljs-title class_">cropTop</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_BOTTOM</span>, &amp;<span class="hljs-title class_">cropBottom</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_LEFT</span>, &amp;<span class="hljs-title class_">cropLeft</span>) &amp;&amp;</li><li>               <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_RIGHT</span>, &amp;<span class="hljs-title class_">cropRight</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">ret</span>) {</li><li>         <span class="hljs-comment">// 异常处理。</span></li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码输入回调OH_AVCodecOnNeedInputBuffer实现。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnNeedInputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">buffer</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>)</li><li>{</li><li>    <span class="hljs-comment">// 输入帧的数据buffer和对应的index送入inQueue队列。</span></li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">userData</span>;</li><li>    <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Enqueue</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>));</li><li>}</li><li>
</li><li><span class="hljs-comment">// 解码输出回调OH_AVCodecOnNewOutputBuffer实现。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnNewOutputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> *<span class="hljs-variable">codec</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span>, <span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">buffer</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">userData</span>)</li><li>{</li><li>    <span class="hljs-comment">// 可选，开发者需要获取视频宽、高、跨距等时可配置。</span></li><li>    <span class="hljs-comment">// 获取视频宽、高、跨距。</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">isFirstFrame</span>) {</li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_VideoDecoder_GetOutputDescription</span>(<span class="hljs-title class_">codec</span>), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>        }</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_PIC_WIDTH</span>, &amp;<span class="hljs-title class_">width</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_PIC_HEIGHT</span>, &amp;<span class="hljs-title class_">height</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_STRIDE</span>, &amp;<span class="hljs-title class_">widthStride</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_SLICE_HEIGHT</span>, &amp;<span class="hljs-title class_">heightStride</span>) &amp;&amp;</li><li>                   <span class="hljs-comment">// 获取裁剪矩形信息可选。</span></li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_TOP</span>, &amp;<span class="hljs-title class_">cropTop</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_BOTTOM</span>, &amp;<span class="hljs-title class_">cropBottom</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_LEFT</span>, &amp;<span class="hljs-title class_">cropLeft</span>) &amp;&amp;</li><li>                   <span class="hljs-title function_">OH_AVFormat_GetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_VIDEO_CROP_RIGHT</span>, &amp;<span class="hljs-title class_">cropRight</span>);</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">ret</span>) {</li><li>             <span class="hljs-comment">// 异常处理。</span></li><li>        }</li><li>        <span class="hljs-variable">isFirstFrame</span> = <span class="hljs-keyword">false</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 完成帧的数据buffer和对应的index送入outQueue队列。</span></li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">userData</span>;</li><li>    <span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Enqueue</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt;(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>));</li><li>}</li><li><span class="hljs-comment">// 配置异步回调，调用OH_VideoDecoder_RegisterCallback接口。</span></li><li><span class="hljs-variable">OH_AVCodecCallback</span> <span class="hljs-variable">cb</span> = {&amp;<span class="hljs-title class_">OnError</span>, &amp;<span class="hljs-title class_">OnStreamChanged</span>, &amp;<span class="hljs-title class_">OnNeedInputBuffer</span>, &amp;<span class="hljs-title class_">OnNewOutputBuffer</span>};</li><li><span class="hljs-comment">// 配置异步回调。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_RegisterCallback</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">cb</span>, <span class="hljs-variable">nullptr</span>); <span class="hljs-comment">// nullptr:开发者执行回调所依赖的数据userData为空。</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>在回调函数中，对数据队列进行操作时，需要注意多线程同步的问题。</p>        </div></div></div></li>      <li>       <p>（可选）OH_VideoDecoder_SetDecryptionConfig设置解密配置。在获取到DRM信息（参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>开发步骤第4步），完成DRM许可证申请后，通过此接口进行解密配置。此接口需在Prepare前调用。在Buffer模式下，DRM解密能力仅支持非安全视频通路。DRM相关接口详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-drm" target="_blank">DRM API文档</a>。</p>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysystem.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysession.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_err.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_common.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_drm.so)</li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据DRM信息创建指定的DRM系统，以创建"com.wiseplay.drm"为例。</span></li><li>MediaKeySystem *system = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;system);</li><li><span class="hljs-keyword">if</span> (system == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key system failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建解密会话。</span></li><li><span class="hljs-comment">// 使用非安全视频通路，应创建CONTENT_PROTECTION_LEVEL_SW_CRYPTO及以上内容保护级别的MediaKeySession。</span></li><li>MediaKeySession *session = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_SW_CRYPTO;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(system, &amp;contentProtectionLevel, &amp;session);</li><li><span class="hljs-keyword">if</span> (ret != DRM_OK) {</li><li>    <span class="hljs-comment">// 如创建失败，请查看DRM接口文档及日志信息。</span></li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key session failed."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (session == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"media key session is nullptr."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 获取许可证请求、设置许可证响应等。</span></li><li><span class="hljs-comment">// 设置解密配置，即将解密会话、安全视频通路标志设置到解码器中。</span></li><li><span class="hljs-type">bool</span> secureVideoPath = <span class="hljs-literal">false</span>;</li><li>ret = <span class="hljs-built_in">OH_VideoDecoder_SetDecryptionConfig</span>(videoDec, session, secureVideoPath);</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Configure()配置解码器。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-variable">width</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-variable">height</span>); <span class="hljs-comment">// 必须配置。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">pixelFormat</span>);</li><li><span class="hljs-comment">// 配置解码器。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_Configure</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Prepare()解码器就绪。</p>       <p>该接口将在解码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Prepare(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Start()启动解码器。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-rust" data-highlighted="yes"><ol class="linenums"><li>std::unique_ptr&lt;std::ofstream&gt; outputFile = std::make_unique&lt;std::ofstream&gt;();</li><li><span class="hljs-keyword">if</span> (outputFile != nullptr) {</li><li>    outputFile<span class="hljs-punctuation">-&gt;</span><span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"/*yourpath*.yuv"</span>, std::ios::out | std::ios::binary | std::ios::ate);</li><li>}</li><li><span class="hljs-comment">// 启动解码器，开始解码。</span></li><li>OH_AVErrCode ret = <span class="hljs-title function_ invoke__">OH_VideoDecoder_Start</span>(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）OH_VideoDecoder_SetParameter()动态配置解码器参数。</p>       <p>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">视频专有键值对</a>。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 配置帧率。</span></li><li><span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-number">30.0</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_SetParameter</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AVCencInfo_SetAVBuffer()，设置cencInfo。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <p>使用示例：</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uint32_t</span> keyIdLen = DRM_KEY_ID_SIZE;</li><li><span class="hljs-type">uint8_t</span> keyId[] = {</li><li>    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x96</span>,</li><li>    <span class="hljs-number">0xcf</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x28</span>};</li><li><span class="hljs-type">uint32_t</span> ivLen = DRM_KEY_IV_SIZE;</li><li><span class="hljs-type">uint8_t</span> iv[] = {</li><li>    <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xde</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x3e</span>,</li><li>    <span class="hljs-number">0x52</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x95</span>};</li><li><span class="hljs-type">uint32_t</span> encryptedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> skippedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> firstEncryptedOffset = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> subsampleCount = <span class="hljs-number">1</span>;</li><li>DrmSubsample subsamples[<span class="hljs-number">1</span>] = { {<span class="hljs-number">0x10</span>, <span class="hljs-number">0x16</span>} };</li><li><span class="hljs-comment">// 创建CencInfo实例。</span></li><li>OH_AVCencInfo *cencInfo = <span class="hljs-built_in">OH_AVCencInfo_Create</span>();</li><li><span class="hljs-keyword">if</span> (cencInfo == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置解密算法。</span></li><li>OH_AVErrCode errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAlgorithm</span>(cencInfo, DRM_ALG_CENC_AES_CTR);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置KeyId和Iv。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetKeyIdAndIv</span>(cencInfo, keyId, keyIdLen, iv, ivLen);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置Sample信息。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetSubsampleInfo</span>(cencInfo, encryptedBlockCount, skippedBlockCount, firstEncryptedOffset,</li><li>    subsampleCount, subsamples);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置模式：KeyId、Iv和SubSamples已被设置。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetMode</span>(cencInfo, DRM_CENC_INFO_KEY_IV_SUBSAMPLES_SET);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将CencInfo设置到AVBuffer中。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAVBuffer</span>(cencInfo, buffer);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 销毁CencInfo实例。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_Destroy</span>(cencInfo);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_PushInputBuffer()写入解码码流。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">inQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入码流数据。</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">capacity</span> = <span class="hljs-title function_">OH_AVBuffer_GetCapacity</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">size</span> &gt; <span class="hljs-variable">capacity</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">addr</span>, <span class="hljs-variable">frameData</span>, <span class="hljs-variable">size</span>);</li><li><span class="hljs-comment">// 配置帧数据的输入尺寸、偏移量、时间戳等字段信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">size</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">offset</span> = <span class="hljs-variable">offset</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">pts</span>;</li><li><span class="hljs-variable">info</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">flags</span>;</li><li><span class="hljs-comment">// info信息写入buffer。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 送入解码输入队列进行解码，index为对应buffer队列的下标。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">pushInputRet</span> = <span class="hljs-title function_">OH_VideoDecoder_PushInputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">pushInputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_FreeOutputBuffer()释放解码帧。</p>       <p>以下示例中，bufferInfo的成员变量：</p>       <ul>        <li>index：回调函数OnNewOutputBuffer传入的参数，与buffer唯一对应的标识；</li>        <li>buffer： 回调函数OnNewOutputBuffer传入的参数，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getaddr" target="_blank">OH_AVBuffer_GetAddr</a>接口获取图像虚拟地址；</li>        <li>isValid：bufferInfo中存储的buffer实例是否有效。</li>       </ul>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">CodecBufferInfo</span>&gt; <span class="hljs-title class_">bufferInfo</span> = <span class="hljs-variable">outQueue</span>.<span class="hljs-title function_">Dequeue</span>();</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span> == <span class="hljs-variable">nullptr</span> || !<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">isValid</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 获取解码后信息。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">info</span>;</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">getBufferRet</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>, &amp;<span class="hljs-title class_">info</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">getBufferRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将解码完成数据data写入到对应输出文件中。</span></li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">addr</span> = <span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">buffer</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">addr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>   <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">outputFile</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-title class_">is_open</span>()) {</li><li>    <span class="hljs-variable">outputFile</span>-&gt;<span class="hljs-title class_">write</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">char</span> *&gt;(<span class="hljs-title class_">addr</span>), <span class="hljs-title class_">info</span>.<span class="hljs-title class_">size</span>);</li><li>}</li><li><span class="hljs-comment">// Buffer模式，释放已完成写入的数据，index为对应buffer队列的下标。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">freeOutputRet</span> = <span class="hljs-title function_">OH_VideoDecoder_FreeOutputBuffer</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">bufferInfo</span>-&gt;<span class="hljs-title class_">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">freeOutputRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <p>NV12/NV21图像如果需要依次将Y、U、V三个分量拷贝至另一块buffer中，以NV12图像为例，按行拷贝示例如下：</p>       <p>以NV12图像为例，width、height、wStride、hStride图像排布参考下图：</p>       <ul>        <li>OH_MD_KEY_VIDEO_PIC_WIDTH表示width；</li>        <li>OH_MD_KEY_VIDEO_PIC_HEIGHT表示height；</li>        <li>OH_MD_KEY_VIDEO_STRIDE表示wStride；</li>        <li>OH_MD_KEY_VIDEO_SLICE_HEIGHT表示hStride。</li>       </ul>       <p><span><img originheight="2022" originwidth="2723" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114436.14961085568449384555326946261288:50001231000000:2800:12C12F84FDB65582A1E0E1EF1E66CF9CA65D5BCAED986DED923045C823788196.png" width="920" height="683.1582813073816"></span></p>       <p>添加头文件。</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-dcv-c106="" class="highlight-div"><div _ngcontent-dcv-c106="" class="highlight-div-header"><div _ngcontent-dcv-c106="" class="highlight-div-header-left"><div _ngcontent-dcv-c106="" class="handle-button expand-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dcv-c106="" class="highlight-div-header-right"><div _ngcontent-dcv-c106="" class="handle-button ai-button"></div><div _ngcontent-dcv-c106="" class="handle-button line-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dcv-c106="" class="handle-button theme-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dcv-c106="" class="handle-button copy-button"><div _ngcontent-dcv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dcv-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 源内存区域的宽、高，通过回调函数OnStreamChanged或接口OH_VideoDecoder_GetOutputDescription获取。</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> width;</li><li>    <span class="hljs-type">int32_t</span> height;</li><li>};</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DstRect</span> <span class="hljs-comment">// 目标内存区域的宽跨距、高跨距，由开发者自行设置。</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> wStride;</li><li>    <span class="hljs-type">int32_t</span> hStride;</li><li>};</li><li><span class="hljs-comment">// 源内存区域的宽跨距、高跨距，通过回调函数OnStreamChanged或接口OH_VideoDecoder_GetOutputDescription获取。</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SrcRect</span></li><li>{</li><li>    <span class="hljs-type">int32_t</span> wStride;</li><li>    <span class="hljs-type">int32_t</span> hStride;</li><li>};</li><li>
</li><li>Rect rect = {<span class="hljs-number">320</span>, <span class="hljs-number">240</span>};</li><li>DstRect dstRect = {<span class="hljs-number">320</span>, <span class="hljs-number">240</span>};</li><li>SrcRect srcRect = {<span class="hljs-number">320</span>, <span class="hljs-number">256</span>};</li><li><span class="hljs-type">uint8_t</span>* dst = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[dstRect.hStride * dstRect.wStride * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>]; <span class="hljs-comment">// 目标内存区域的指针。</span></li><li><span class="hljs-type">uint8_t</span>* src = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[srcRect.hStride * srcRect.wStride * <span class="hljs-number">3</span> / <span class="hljs-number">2</span>]; <span class="hljs-comment">// 源内存区域的指针。</span></li><li><span class="hljs-type">uint8_t</span>* dstTemp = dst;</li><li><span class="hljs-type">uint8_t</span>* srcTemp = src;</li><li>rect.height = ((rect.height + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>)  * <span class="hljs-number">2</span> <span class="hljs-comment">// 避免height为奇数；</span></li><li>rect.width = ((rect.width + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>)  * <span class="hljs-number">2</span> <span class="hljs-comment">// 避免width为奇数；</span></li><li>
</li><li><span class="hljs-comment">// Y 将Y区域的源数据复制到另一个区域的目标数据中。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; rect.height; ++i) {</li><li>    <span class="hljs-comment">//将源数据的一行数据复制到目标数据的一行中。</span></li><li>    <span class="hljs-built_in">memcpy</span>(dstTemp, srcTemp, rect.width);</li><li>    <span class="hljs-comment">// 更新源数据和目标数据的指针，进行下一行的复制。每更新一次源数据和目标数据的指针都向下移动一个wStride。</span></li><li>    dstTemp += dstRect.wStride;</li><li>    srcTemp += srcRect.wStride;</li><li>}</li><li><span class="hljs-comment">// padding。</span></li><li><span class="hljs-comment">// 更新源数据和目标数据的指针，指针都向下移动一个padding。</span></li><li>dstTemp += (dstRect.hStride - rect.height) * dstRect.wStride;</li><li>srcTemp += (srcRect.hStride - rect.height) * srcRect.wStride;</li><li>rect.height &gt;&gt;= <span class="hljs-number">1</span>;</li><li><span class="hljs-comment">// UV 将UV区域的源数据复制到另一个区域的目标数据中。</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-type">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; rect.height; ++i) {</li><li>    <span class="hljs-built_in">memcpy</span>(dstTemp, srcTemp, rect.width);</li><li>    dstTemp += dstRect.wStride;</li><li>    srcTemp += srcRect.wStride;</li><li>}</li><li>
</li><li><span class="hljs-keyword">delete</span>[] dst;</li><li>dst = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-keyword">delete</span>[] src;</li><li>src = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div>       <p>硬件解码在处理buffer数据时（释放数据前），输出回调开发者收到的AVbuffer是宽、高对齐后的图像数据。</p>       <p>一般需要获取数据的宽、高、跨距、像素格式来保证解码输出数据被正确的处理。</p>       <p>具体实现请参考：<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#buffer模式">Buffer模式</a>的步骤3-调用OH_VideoDecoder_RegisterCallback()设置回调函数来获取数据的宽、高、跨距、像素格式。</p></li>     </ol>     <p>后续流程（包括刷新、重置、停止和销毁解码器）与Surface模式基本一致，请参考<a href="/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">Surface模式</a>的步骤13-16。</p>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/BasicFeature/Media/AVCodec" target="_blank">基于AVCodec能力的视频编解码</a></li>     </ul>    </div>   </div>   <div></div></div>