<h1 _ngcontent-pyc-c119="" class="doc-title ng-star-inserted" title="视频解码同步模式"> 视频解码同步模式 </h1>

<div _ngcontent-pyc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API version 20开始，支持视频解码同步模式。</p>    <p>开发者可以调用本模块的Native API接口，完成同步模式的视频解码。</p>    <p>当前支持的解码能力，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#视频解码">AVCodec支持的格式</a>。</p>    <p>视频解码的限制约束、支持的能力、状态机调用关系请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding">视频解码</a>。</p>    <div class="tiledSection">     <h2 id="适用场景">适用场景<i class="anchor-icon anchor-icon-link" anchorid="适用场景" tips="复制节点链接"></i></h2>          <p>通常情况下，推荐使用异步模式。若需要主动请求buffer去送帧，则可以采用同步模式。</p>    </div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h" target="_blank">VideoDecoder</a>。</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="4425" originwidth="5097" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114437.54430411936368309857382456230537:50001231000000:2800:FD56B07A51CAAAEEAD6F240B064619E11F930C909B5E24596297A16777CEEC83.png" width="920" height="798.7051206592114"></span></p>    </div>    <div class="tiledSection">     <h3 id="在cmake脚本中链接动态库" class="firsth2">在CMake脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在cmake脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="定义基础结构">定义基础结构<i class="anchor-icon anchor-icon-link" anchorid="定义基础结构" tips="复制节点链接"></i></h3>          <p>本部分示例代码按照C++17标准编写，仅作参考。</p>     <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_averrors.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;native_buffer/native_buffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>全局变量（仅作参考，可以根据实际情况将其封装到对象中）。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 视频帧宽度。</span></li><li><span class="hljs-type">int32_t</span> width = <span class="hljs-number">320</span>;</li><li><span class="hljs-comment">// 视频帧高度。</span></li><li><span class="hljs-type">int32_t</span> height = <span class="hljs-number">240</span>;</li><li><span class="hljs-comment">// 视频像素格式。</span></li><li>OH_AVPixelFormat pixelFormat = AV_PIXEL_FORMAT_NV12;</li><li><span class="hljs-comment">// 解码器同步锁。</span></li><li>std::shared_mutex codecMutex;</li><li><span class="hljs-comment">// 解码器实例指针。</span></li><li>OH_AVCodec *videoDec = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-comment">// 解码输出。</span></li><li><span class="hljs-type">bool</span> outputDone = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// 解码输入。</span></li><li><span class="hljs-type">bool</span> inputDone = <span class="hljs-literal">false</span>;</li><li>std::unique_ptr&lt;std::ifstream&gt; inFile_;</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="surface模式">Surface模式<i class="anchor-icon anchor-icon-link" anchorid="surface模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Surface模式下视频解码的全流程，实现同步模式的数据轮转。此处以输入H.264码流文件，解码送显输出为例。</p>     <ol>      <li>       <p>创建解码器实例。</p>       <p>通过名称创建解码器。示例中的变量说明如下：</p>       <ul>        <li>videoDec：视频解码器实例的指针。</li>        <li>capability：解码器能力查询实例的指针。</li>        <li>OH_AVCODEC_MIMETYPE_VIDEO_AVC：AVC格式视频编解码器。</li>       </ul>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建硬件解码器实例。</span></li><li>OH_AVCapability *capability= <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>, HARDWARE);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name);</li><li><span class="hljs-keyword">if</span> (videoDec == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create videoDec failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Configure()配置解码器。</p>       <ul>        <li>详细可配置选项的说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-codecbase#媒体数据键值对" target="_blank">媒体数据键值对</a>。</li>        <li>参数校验规则请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configure" target="_blank">OH_VideoDecoder_Configure()</a>。</li>        <li>参数取值范围可以通过能力查询接口获取，具体示例请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/obtain-supported-codecs">获取支持的编解码能力</a>。</li>       </ul>       <p>目前支持的所有格式都必须配置以下选项：视频帧宽度、视频帧高度。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>auto format = std::shared_ptr&lt;OH_AVFormat&gt;(OH_AVFormat_Create(), OH_AVFormat_Destroy);</li><li><span class="hljs-keyword">if</span> (format == nullptr) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_WIDTH, width); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_HEIGHT, height); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_PIXEL_FORMAT, pixelFormat);</li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_ENABLE_SYNC_MODE, <span class="hljs-number">1</span>); <span class="hljs-comment">// 同步模式配置。</span></li><li><span class="hljs-comment">// 配置解码器。</span></li><li>OH_AVErrCode ret = OH_VideoDecoder_Configure(videoDec, format.<span class="hljs-keyword">get</span>());</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ol>          <li>要使能视频解码同步模式，必须将OH_MD_KEY_ENABLE_SYNC_MODE配置为1。</li>          <li>同步模式在调用OH_VideoDecoder_Configure接口前不能调用OH_VideoDecoder_RegisterCallback接口，否则为异步模式。</li>         </ol>        </div></div></div></li>      <li>       <p>设置surface。</p>       <p>示例中的变量说明如下：</p>       <ul>        <li>nativeWindow：获取方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式">视频解码Surface模式</a>的“步骤-6：设置surface”。</li>       </ul>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置surface。</span></li><li><span class="hljs-comment">// 配置送显窗口参数。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_SetSurface(videoDec, nativeWindow);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Prepare()解码器就绪。</p>       <p>该接口将在解码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Prepare(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Start()启动解码器。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 启动解码器，开始解码。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Start(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并写入码流至解码器。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_queryinputbuffer" target="_blank">OH_VideoDecoder_QueryInputBuffer</a>接口获取下一个可用的输入缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_getinputbuffer" target="_blank">OH_VideoDecoder_GetInputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>将待解码数据写入该缓冲区（buffer）后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_pushinputbuffer" target="_blank">OH_VideoDecoder_PushInputBuffer</a>接口提交至解码器进行解码。当所有待处理数据全部传递给解码器后，需要将flag标识成AVCODEC_BUFFER_FLAGS_EOS，通知解码器输入结束。</li>       </ul>       <p>送入输入队列进行解码，示例中的变量说明如下：</p>       <ul>        <li>size、offset、pts、frameData：输入尺寸、偏移量、时间戳、帧数据等字段信息，获取方式可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer#开发步骤">媒体数据解析</a>“步骤-9：开始解封装，循环获取sample”。</li>        <li>flags：缓冲区标记的类别，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-info-h#oh_avcodecbufferflags" target="_blank">OH_AVCodecBufferFlags</a>。</li>       </ul>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DecoderInput</span><span class="hljs-params">(OH_AVCodec *videoDec, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoDecoder_QueryInputBuffer</span>(videoDec, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoDecoder_GetInputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 写入码流数据。</span></li><li>            <span class="hljs-type">uint8_t</span> *addr = <span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) {</li><li>               <span class="hljs-comment">// 异常处理。</span></li><li>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// buffer数据填充。</span></li><li>            <span class="hljs-type">int32_t</span> capacity = <span class="hljs-built_in">OH_AVBuffer_GetCapacity</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (size &gt; capacity) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-built_in">memcpy</span>(addr, frameData, size);</li><li>
</li><li>            OH_AVCodecBufferAttr info;</li><li>            <span class="hljs-comment">// buffer属性配置。</span></li><li>            <span class="hljs-comment">// 配置帧数据的输入尺寸、偏移量、时间戳等字段信息。</span></li><li>            info.size = size;</li><li>            info.offset = offset;</li><li>            info.pts = pts;</li><li>            <span class="hljs-keyword">if</span> (inFile_-&gt;<span class="hljs-built_in">eof</span>()) {</li><li>                info.flags = AVCODEC_BUFFER_FLAGS_EOS;</li><li>            } <span class="hljs-keyword">else</span> {</li><li>                info.flags = flags;</li><li>            }</li><li>            OH_AVErrCode setBufferRet = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (setBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            OH_AVErrCode pushInputRet = <span class="hljs-built_in">OH_VideoDecoder_PushInputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (pushInputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (inFile_-&gt;<span class="hljs-built_in">eof</span>()) {</li><li>                inputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer显示并释放解码帧。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_queryoutputbuffer" target="_blank">OH_VideoDecoder_QueryOutputBuffer</a>接口获取下一个可用的输出缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_getoutputbuffer" target="_blank">OH_VideoDecoder_GetOutputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>根据开发者设置的isRender标志决定后续操作：若无需送显，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_freeoutputbuffer" target="_blank">OH_VideoDecoder_FreeOutputBuffer</a>接口释放解码帧。若需送显，则可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbuffer" target="_blank">OH_VideoDecoder_RenderOutputBuffer</a>接口显示并自动释放解码帧，或调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbufferattime" target="_blank">OH_VideoDecoder_RenderOutputBufferAtTime</a>接口在指定时间点显示并释放解码帧。</li>       </ul>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DecoderOutput</span><span class="hljs-params">(OH_AVCodec *videoDec, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoDecoder_QueryOutputBuffer</span>(videoDec, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoDecoder_GetOutputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>        </li><li>            <span class="hljs-comment">// 获取解码后信息。</span></li><li>            OH_AVCodecBufferAttr info;</li><li>            OH_AVErrCode getBufferRet = <span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (getBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (info.flags &amp; AVCODEC_BUFFER_FLAGS_EOS) {</li><li>                outputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            </li><li>            <span class="hljs-comment">// 解码输出数据处理。</span></li><li>            <span class="hljs-comment">// 值由开发者决定。</span></li><li>            <span class="hljs-type">bool</span> isRender;</li><li>            <span class="hljs-type">bool</span> isNeedRenderAtTime;</li><li>            OH_AVErrCode result = AV_ERR_OK;</li><li>            <span class="hljs-keyword">if</span> (isRender) {</li><li>                <span class="hljs-comment">// 显示并释放已完成处理的信息，index为对应buffer队列的下标。</span></li><li>                <span class="hljs-keyword">if</span> (isNeedRenderAtTime){</li><li>                    <span class="hljs-comment">// 获取系统绝对时间，renderTimestamp由开发者结合业务指定显示时间。</span></li><li>                    <span class="hljs-type">int64_t</span> renderTimestamp =</li><li>                        std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::nanoseconds&gt;(std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>().<span class="hljs-built_in">time_since_epoch</span>()).<span class="hljs-built_in">count</span>();</li><li>                    result = <span class="hljs-built_in">OH_VideoDecoder_RenderOutputBufferAtTime</span>(videoDec, index, renderTimestamp);</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                    result = <span class="hljs-built_in">OH_VideoDecoder_RenderOutputBuffer</span>(videoDec, index);</li><li>                }</li><li>            } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-comment">// 释放已完成处理的信息。</span></li><li>                result = <span class="hljs-built_in">OH_VideoDecoder_FreeOutputBuffer</span>(videoDec, index);</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (result != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_STREAM_CHANGED: {</li><li>            <span class="hljs-keyword">auto</span> format = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_VideoDecoder_GetOutputDescription</span>(videoDec), OH_AVFormat_Destroy);</li><li>            <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-comment">// 获取新宽高。</span></li><li>            <span class="hljs-type">bool</span> getIntRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_PIC_WIDTH, &amp;width) &amp;&amp;</li><li>                             <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_PIC_HEIGHT, &amp;height);</li><li>            <span class="hljs-keyword">if</span> (!getIntRet) {</li><li>                 <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>解码器送帧/出帧处理循环。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li><span class="hljs-type">int64_t</span> timeoutUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 单位：微秒（us），负值：无限等待；0：立即退出；正值：指定时间后结束后退出。</span></li><li>
</li><li><span class="hljs-keyword">while</span> (!outputDone &amp;&amp; result) {</li><li>    <span class="hljs-keyword">if</span> (!inputDone) {</li><li>        result = <span class="hljs-built_in">DecoderInput</span>(videoDec, timeoutUs);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!outputDone) {</li><li>        result = <span class="hljs-built_in">DecoderOutput</span>(videoDec, timeoutUs);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Flush()刷新解码器。</p>       <p>调用OH_VideoDecoder_Flush接口后，解码器仍处于运行态，但会清除解码器中缓存的输入和输出数据及参数集如H.264格式的PPS/SPS。</p>       <p>此时需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_start" target="_blank">OH_VideoDecoder_Start</a>接口重新开始解码。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecMutex来避免调用Flush接口，状态切换后，解码线程还在跑会退出循环的问题。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-comment">// 刷新解码器videoDec。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_Flush</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 重新开始解码。</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_Start</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Reset()重置解码器。</p>       <p>调用OH_VideoDecoder_Reset接口后，解码器回到初始化的状态，需要调用接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configure" target="_blank">OH_VideoDecoder_Configure</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_setsurface" target="_blank">OH_VideoDecoder_SetSurface</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_prepare" target="_blank">OH_VideoDecoder_Prepare</a>重新配置。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 重置解码器videoDec。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">resetRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Reset</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">resetRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 重新配置解码器参数。</span></li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">format</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">OH_AVFormat</span>&gt;(<span class="hljs-title class_">OH_AVFormat_Create</span>(), <span class="hljs-title class_">OH_AVFormat_Destroy</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">configRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Configure</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">format</span>.<span class="hljs-title function_">get</span>());</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">configRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Surface模式需要重新配置surface，而Buffer模式不需要配置surface。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">setRet</span> = <span class="hljs-title function_">OH_VideoDecoder_SetSurface</span>(<span class="hljs-variable">videoDec</span>, <span class="hljs-variable">nativeWindow</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">setRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 解码器重新就绪。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">prepareRet</span> = <span class="hljs-title function_">OH_VideoDecoder_Prepare</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">prepareRet</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>解码器回到初始化的状态，调用OH_VideoDecoder_Configure接口重新配置解码器参数时，同步模式需要重新配置OH_MD_KEY_ENABLE_SYNC_MODE为1，否则为异步模式。</p>        </div></div></div></li>      <li>       <p>（可选）调用OH_VideoDecoder_Stop()停止解码器。</p>       <p>调用OH_VideoDecoder_Stop()后，解码器保留解码实例，释放输入输出buffer。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 终止解码器videoDec。</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">codecMutex</span>);</li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_Stop</span>(<span class="hljs-variable">videoDec</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Destroy()销毁解码器实例，释放资源。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用OH_VideoDecoder_Destroy，注销解码器。</span></li><li><span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>OH_AVErrCode ret = AV_ERR_OK;</li><li><span class="hljs-keyword">if</span> (videoDec != <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">OH_VideoDecoder_Destroy</span>(videoDec);</li><li>    videoDec = <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>执行该步骤之后，需要开发者将videoDec指向nullptr，防止野指针导致程序错误。</p>        </div></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="buffer模式">Buffer模式<i class="anchor-icon anchor-icon-link" anchorid="buffer模式" tips="复制节点链接"></i></h3>          <p>参考以下示例代码，可以完成Buffer模式下视频解码的全流程，实现同步模式的数据轮转。此处以输入H.264码流文件，解码成YUV文件为例。</p>     <ol>      <li>       <p>创建解码器实例。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codecname创建解码器，应用有特殊需求，比如选择支持某种分辨率规格的解码器，可先查询capability，再根据codec name创建解码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_VIDEO_AVC, <span class="hljs-literal">false</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *videoDec = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name);</li><li><span class="hljs-keyword">if</span> (videoDec == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create videoDec failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Configure()配置解码器。</p>       <p>与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li>auto format = std::shared_ptr&lt;OH_AVFormat&gt;(OH_AVFormat_Create(), OH_AVFormat_Destroy);</li><li><span class="hljs-keyword">if</span> (format == nullptr) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 写入format。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_WIDTH, width); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_HEIGHT, height); <span class="hljs-comment">// 必须配置。</span></li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_PIXEL_FORMAT, pixelFormat);</li><li>OH_AVFormat_SetIntValue(format.<span class="hljs-keyword">get</span>(), OH_MD_KEY_ENABLE_SYNC_MODE, <span class="hljs-number">1</span>); <span class="hljs-comment">// 同步模式配置。</span></li><li><span class="hljs-comment">// 配置解码器。</span></li><li>OH_AVErrCode ret = OH_VideoDecoder_Configure(videoDec, format.<span class="hljs-keyword">get</span>());</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <ol>          <li>要使能视频解码同步模式，必须将OH_MD_KEY_ENABLE_SYNC_MODE配置为1。</li>          <li>同步模式在调用OH_VideoDecoder_Configure接口前不能调用OH_VideoDecoder_RegisterCallback接口，否则为异步模式。</li>         </ol>        </div></div></div></li>      <li>       <p>调用OH_VideoDecoder_Prepare()解码器就绪。</p>       <p>该接口将在解码器运行前进行一些数据的准备工作。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_VideoDecoder_Prepare(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_VideoDecoder_Start()启动解码器。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-rust" data-highlighted="yes"><ol class="linenums"><li>std::unique_ptr&lt;std::ofstream&gt; outputFile = std::make_unique&lt;std::ofstream&gt;();</li><li><span class="hljs-keyword">if</span> (outputFile != nullptr) {</li><li>    outputFile<span class="hljs-punctuation">-&gt;</span><span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"/*yourpath*.yuv"</span>, std::ios::out | std::ios::binary | std::ios::ate);</li><li>}</li><li><span class="hljs-comment">// 启动解码器，开始解码。</span></li><li>OH_AVErrCode ret = <span class="hljs-title function_ invoke__">OH_VideoDecoder_Start</span>(videoDec);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并写入码流至解码器。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_queryinputbuffer" target="_blank">OH_VideoDecoder_QueryInputBuffer</a>接口获取下一个可用的输入缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_getinputbuffer" target="_blank">OH_VideoDecoder_GetInputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>将待解码数据写入该缓冲区（buffer）后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_pushinputbuffer" target="_blank">OH_VideoDecoder_PushInputBuffer</a>接口提交至解码器进行解码。当所有待处理数据全部传递给解码器后，需要将flag标识成AVCODEC_BUFFER_FLAGS_EOS，通知解码器输入结束。</li>       </ul>       <p>示例中的变量size、offset、pts、frameData、flags说明与Surface模式相同，此处不再赘述。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DecoderInput</span><span class="hljs-params">(OH_AVCodec *videoDec, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoDecoder_QueryInputBuffer</span>(videoDec, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoDecoder_GetInputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// 写入码流数据。</span></li><li>            <span class="hljs-type">uint8_t</span> *addr = <span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">nullptr</span>) {</li><li>               <span class="hljs-comment">// 异常处理。</span></li><li>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-comment">// buffer数据填充。</span></li><li>            <span class="hljs-type">int32_t</span> capacity = <span class="hljs-built_in">OH_AVBuffer_GetCapacity</span>(buffer);</li><li>            <span class="hljs-keyword">if</span> (size &gt; capacity) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-built_in">memcpy</span>(addr, frameData, size);</li><li>
</li><li>            OH_AVCodecBufferAttr info;</li><li>            <span class="hljs-comment">// buffer属性配置。</span></li><li>            <span class="hljs-comment">// 配置帧数据的输入尺寸、偏移量、时间戳等字段信息。</span></li><li>            info.size = size;</li><li>            info.offset = offset;</li><li>            info.pts = pts;</li><li>            <span class="hljs-keyword">if</span> (inFile_-&gt;<span class="hljs-built_in">eof</span>()) {</li><li>                info.flags = AVCODEC_BUFFER_FLAGS_EOS;</li><li>            } <span class="hljs-keyword">else</span> {</li><li>                info.flags = flags;</li><li>            }</li><li>            OH_AVErrCode setBufferRet = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (setBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            OH_AVErrCode pushInputRet = <span class="hljs-built_in">OH_VideoDecoder_PushInputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (pushInputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (inFile_-&gt;<span class="hljs-built_in">eof</span>()) {</li><li>                inputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>获取可用buffer并释放解码帧。</p>       <ul>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_queryoutputbuffer" target="_blank">OH_VideoDecoder_QueryOutputBuffer</a>接口获取下一个可用的输出缓冲区（buffer）的索引（index）。</li>        <li>根据获取的索引（index），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_getoutputbuffer" target="_blank">OH_VideoDecoder_GetOutputBuffer</a>接口获取对应的缓冲区（buffer）实例。</li>        <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_freeoutputbuffer" target="_blank">OH_VideoDecoder_FreeOutputBuffer</a>接口释放解码帧。</li>       </ul>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DecoderOutput</span><span class="hljs-params">(OH_AVCodec *videoDec, <span class="hljs-type">int64_t</span> timeoutUs)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    <span class="hljs-type">int32_t</span> cropTop = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> cropBottom = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> cropLeft = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> cropRight = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> widthStride = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int32_t</span> heightStride = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(codecMutex)</span></span>;</li><li>
</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_VideoDecoder_QueryOutputBuffer</span>(videoDec, &amp;index, timeoutUs);</li><li>    <span class="hljs-keyword">switch</span> (ret) {</li><li>        <span class="hljs-keyword">case</span> AV_ERR_OK: {</li><li>            OH_AVBuffer *buffer = <span class="hljs-built_in">OH_VideoDecoder_GetOutputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>        </li><li>            <span class="hljs-comment">// 获取解码后信息。</span></li><li>            OH_AVCodecBufferAttr info;</li><li>            OH_AVErrCode getBufferRet = <span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(buffer, &amp;info);</li><li>            <span class="hljs-keyword">if</span> (getBufferRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (info.flags &amp; AVCODEC_BUFFER_FLAGS_EOS) {</li><li>                outputDone = <span class="hljs-number">1</span>;</li><li>            }</li><li>            </li><li>            <span class="hljs-comment">// 释放已完成处理的信息，index为对应buffer队列的下标。</span></li><li>            OH_AVErrCode freeOutputRet = <span class="hljs-built_in">OH_VideoDecoder_FreeOutputBuffer</span>(videoDec, index);</li><li>            <span class="hljs-keyword">if</span> (freeOutputRet != AV_ERR_OK) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_TRY_AGAIN_LATER: {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">case</span> AV_ERR_STREAM_CHANGED: {</li><li>            <span class="hljs-keyword">auto</span> format = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_VideoDecoder_GetOutputDescription</span>(videoDec), OH_AVFormat_Destroy);</li><li>            <span class="hljs-keyword">if</span> (format == <span class="hljs-literal">nullptr</span>) {</li><li>                <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-comment">// 获取到变化后的视频宽、高、跨距。</span></li><li>            <span class="hljs-type">bool</span> getIntRet = <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_PIC_WIDTH, &amp;width) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_PIC_HEIGHT, &amp;height) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_STRIDE, &amp;widthStride) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_SLICE_HEIGHT, &amp;heightStride) &amp;&amp;</li><li>                       <span class="hljs-comment">// 获取裁剪矩形信息可选。</span></li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_CROP_TOP, &amp;cropTop) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_CROP_BOTTOM, &amp;cropBottom) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_CROP_LEFT, &amp;cropLeft) &amp;&amp;</li><li>                       <span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format.<span class="hljs-built_in">get</span>(), OH_MD_KEY_VIDEO_CROP_RIGHT, &amp;cropRight);</li><li>            <span class="hljs-keyword">if</span> (!getIntRet) {</li><li>                 <span class="hljs-comment">// 异常处理。</span></li><li>            }</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">default</span>: {</li><li>            <span class="hljs-comment">// 异常处理。</span></li><li>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>解码器送帧/出帧处理循环。</p>       <div _ngcontent-pyc-c106="" class="highlight-div"><div _ngcontent-pyc-c106="" class="highlight-div-header"><div _ngcontent-pyc-c106="" class="highlight-div-header-left"><div _ngcontent-pyc-c106="" class="handle-button expand-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyc-c106="" class="highlight-div-header-right"><div _ngcontent-pyc-c106="" class="handle-button ai-button"></div><div _ngcontent-pyc-c106="" class="handle-button line-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyc-c106="" class="handle-button theme-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyc-c106="" class="handle-button copy-button"><div _ngcontent-pyc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;</li><li><span class="hljs-type">int64_t</span> timeoutUs = <span class="hljs-number">0</span>; <span class="hljs-comment">// 单位：微秒（us），负值：无限等待；0：立即退出；正值：等待指定时长后退出。</span></li><li>
</li><li><span class="hljs-keyword">while</span> (!outputDone &amp;&amp; result) {</li><li>    <span class="hljs-keyword">if</span> (!inputDone) {</li><li>        result = <span class="hljs-built_in">DecoderInput</span>(videoDec, timeoutUs);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!outputDone) {</li><li>        result = <span class="hljs-built_in">DecoderOutput</span>(videoDec, timeoutUs);</li><li>    }</li><li>}</li></ol></pre></div></div></li>     </ol>     <p>后续流程（包括刷新、重置停止和销毁解码器）与Surface模式基本一致，请参考<a href="/consumer/cn/doc/harmonyos-guides/synchronous-video-decoding#surface模式">Surface模式</a>的步骤9-12。</p>    </div>   </div>   <div></div></div>