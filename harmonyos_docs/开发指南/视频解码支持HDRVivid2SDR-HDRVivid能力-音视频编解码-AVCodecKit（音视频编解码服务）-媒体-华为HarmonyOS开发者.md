<h1 _ngcontent-dsh-c119="" class="doc-title ng-star-inserted" title="视频解码支持HDRVivid2SDR"> 视频解码支持HDRVivid2SDR </h1>

<div _ngcontent-dsh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在视频分享或者编辑场景时，开发者有时需要将HDR Vivid视频转换为SDR视频，可以调用AVCodec能力实现该功能。</p> <p><span><img height="50.8725" originheight="150" originwidth="1532" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114449.33976402740918363255159345097951:50001231000000:2800:97C0C561689C11D6E53BC1B5640340C918FE57CF08C7C5E7290A62BB8253D8E3.png" title="点击放大" width="523.6875"></span></p> <div class="tiledSection"><h2 id="section189714375125">限制约束<i class="anchor-icon anchor-icon-link" anchorid="section189714375125" tips="复制节点链接"></i></h2><ol><li>目前仅硬件解码器支持该能力。</li><li>目前仅Surface模式支持该能力。Surface模式和Buffer模式输出差异可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding" target="_blank">视频解码</a>。</li><li>目前使能该能力时，不支持码流分辨率变化，会通过回调函数OH_AVCodecOnError()报告错误码<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-averrors-h#oh_averrcode" target="_blank">AV_ERR_UNSUPPORT</a>。</li><li>在成功调用OH_VideoDecoder_Configure接口后，以及在启动OH_VideoDecoder_Start接口前，必须要先调用OH_VideoDecoder_Prepare接口。</li><li>调用OH_VideoDecoder_Reset接口之后，解码器将回到初始状态，需要重新调用OH_VideoDecoder_Configure、OH_VideoDecoder_Prepare和OH_VideoDecoder_SetSurface接口。</li><li>通过配置OH_MD_KEY_VIDEO_DECODER_OUTPUT_COLOR_SPACE，支持在解码后输出SDR图像，目前输入仅支持为HDR Vivid的码流，输出仅支持配置为OH_COLORSPACE_BT709_LIMIT。</li></ol> </div> <div class="tiledSection"><h3 id="section1151820124146" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="section1151820124146" tips="复制节点链接"></i></h3><div _ngcontent-dsh-c106="" class="highlight-div"><div _ngcontent-dsh-c106="" class="highlight-div-header"><div _ngcontent-dsh-c106="" class="highlight-div-header-left"><div _ngcontent-dsh-c106="" class="handle-button expand-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dsh-c106="" class="highlight-div-header-right"><div _ngcontent-dsh-c106="" class="handle-button ai-button"></div><div _ngcontent-dsh-c106="" class="handle-button line-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dsh-c106="" class="handle-button theme-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dsh-c106="" class="handle-button copy-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dsh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avsource.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_vdec.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li></ol></pre></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p> </div></div></div> <div class="tiledSection"><h3 id="section26542451788">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section26542451788" tips="复制节点链接"></i></h3><ol><li>添加头文件。<div _ngcontent-dsh-c106="" class="highlight-div"><div _ngcontent-dsh-c106="" class="highlight-div-header"><div _ngcontent-dsh-c106="" class="highlight-div-header-left"><div _ngcontent-dsh-c106="" class="handle-button expand-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dsh-c106="" class="highlight-div-header-right"><div _ngcontent-dsh-c106="" class="handle-button ai-button"></div><div _ngcontent-dsh-c106="" class="handle-button line-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dsh-c106="" class="handle-button theme-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dsh-c106="" class="handle-button copy-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_videodecoder.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div> </li><li>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdr-vivid-video-player" target="_blank">HDR Vivid视频播放</a>，添加头文件和解析文件，查询文件是否为HDR Vivid视频。<p>如果非HDR Vivid视频，则参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding" target="_blank">视频解码</a>进行解码处理，此处不再赘述。</p> <p>如果判断为HDR Vivid视频，则继续执行以下步骤。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果输入源非HDR Vivid视频，会通过回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_avcodeconerror" target="_blank">OH_AVCodecOnError()</a>报告错误码<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-averrors-h#oh_averrcode" target="_blank">AV_ERR_VIDEO_UNSUPPORTED_COLOR_SPACE_CONVERSION</a>。</p> </div></div></div> </li><li>创建解码器实例。<p>查询系统支持的解码器能力，根据查询结果基于name创建硬解码器。</p> <p>示例中的变量说明如下：</p> <ul><li>videoDec：视频解码器实例的指针。</li><li>capability：解码器能力查询实例的指针。</li><li>OH_AVCODEC_MIMETYPE_VIDEO_HEVC：HEVC格式视频编解码器。</li></ul> <div _ngcontent-dsh-c106="" class="highlight-div"><div _ngcontent-dsh-c106="" class="highlight-div-header"><div _ngcontent-dsh-c106="" class="highlight-div-header-left"><div _ngcontent-dsh-c106="" class="handle-button expand-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dsh-c106="" class="highlight-div-header-right"><div _ngcontent-dsh-c106="" class="handle-button ai-button"></div><div _ngcontent-dsh-c106="" class="handle-button line-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dsh-c106="" class="handle-button theme-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dsh-c106="" class="handle-button copy-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dsh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//3.1 获取指定硬件的视频HEVC解码器能力实例。</span></li><li>OH_AVCapability *<span class="">capability</span> = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC, <span class="hljs-literal">false</span>, HARDWARE)<span class="">; </span></li><li><span class="hljs-keyword">if</span> (<span class="">capability</span> == <span class="hljs-literal">nullptr</span>){ </li><li> <span class="hljs-comment">// 异常处理。</span></li><li>} </li><li><span class="hljs-comment">// 3.2 获取HEVC硬件解码器名称。</span></li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="">name</span> = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability)<span class="">; </span></li><li><span class="hljs-comment">// 3.3 创建HEVC硬件解码实例。</span></li><li>OH_AVCodec *<span class="">videoDec</span> = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name)<span class="">; </span></li></ol></pre></div></div> <div class="p"><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>由于目前仅硬件解码器支持该能力，因此必须根据解码器name进行创建。</p> </div></div></div> </div> </li><li>调用OH_VideoDecoder_RegisterCallback()设置回调函数。<p>具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdr-vivid-video-player#section182234161516" target="_blank">HDR Vivid视频播放-HDR Vivid视频解码</a> 中的“步骤3：配置异步回调函数”</p> </li><li>调用OH_VideoDecoder_Configure()配置解码器。<p>需配置项：视频帧宽度、视频帧高度、视频像素格式、指定输出为SDR。具体示例如下：</p> <ul><li>DEFAULT_WIDTH：320像素宽度；</li><li>DEFAULT_HEIGHT：240像素高度；</li><li>DEFAULT_PIXELFORMAT： 像素格式，因为示例需要保存的YUV文件像素格式是NV12，所以设置为 AV_PIXEL_FORMAT_NV12。<div _ngcontent-dsh-c106="" class="highlight-div"><div _ngcontent-dsh-c106="" class="highlight-div-header"><div _ngcontent-dsh-c106="" class="highlight-div-header-left"><div _ngcontent-dsh-c106="" class="handle-button expand-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dsh-c106="" class="highlight-div-header-right"><div _ngcontent-dsh-c106="" class="handle-button ai-button"></div><div _ngcontent-dsh-c106="" class="handle-button line-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dsh-c106="" class="handle-button theme-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dsh-c106="" class="handle-button copy-button"><div _ngcontent-dsh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dsh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>// 视频帧宽度。</li><li>int32_t <span class="">width</span> = <span class="hljs-number">320</span><span class="">; </span></li><li><span class="hljs-regexp">//</span> 视频帧高度。</li><li>int32_t <span class="">height</span> = <span class="hljs-number">240</span><span class="">;</span></li><li><span class="hljs-regexp">//</span> 视频像素格式。</li><li>constexpr OH_AVPixelFormat <span class="">DEFAULT_PIXELFORMAT</span> = AV_PIXEL_FORMAT_NV12<span class="">;</span></li><li>OH_AVFormat *<span class=""><span class="hljs-keyword">format</span></span> = OH_AVFormat_Create()<span class="">;</span></li><li><span class="hljs-regexp">//</span> <span class="hljs-number">5.1</span> 配置视频宽、高、像素格式。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_WIDTH, width)<span class="">;</span></li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_HEIGHT, height)<span class="">;</span></li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_PIXEL_FORMAT, DEFAULT_PIXELFORMAT)<span class="">;</span></li><li><span class="hljs-regexp">//</span> <span class="hljs-number">5.2</span> 指定输出为SDR视频。</li><li>OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_DECODER_OUTPUT_COLOR_SPACE, OH_COLORSPACE_BT709_LIMIT)<span class="">;</span></li><li><span class="hljs-regexp">//</span> <span class="hljs-number">5.3</span> 配置解码器。</li><li>int32_t <span class="">ret</span> = OH_VideoDecoder_Configure(videoDec, <span class="hljs-keyword">format</span>)<span class="">;</span></li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-regexp">//</span> 异常处理。</li><li>}</li><li>OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>)<span class="">;</span></li></ol></pre></div></div> </li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>通过配置OH_MD_KEY_VIDEO_DECODER_OUTPUT_COLOR_SPACE，支持在解码后输出SDR图像，目前输入仅支持为HDR Vivid的码流，输出仅支持配置为OH_COLORSPACE_BT709_LIMIT。</p> </div></div></div> </li><li>后续步骤具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>。</li></ol> </div> </div> <div></div></div>