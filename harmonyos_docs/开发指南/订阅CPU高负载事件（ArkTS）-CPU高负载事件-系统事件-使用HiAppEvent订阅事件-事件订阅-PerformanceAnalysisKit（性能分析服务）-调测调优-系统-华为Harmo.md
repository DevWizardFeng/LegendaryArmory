<h1 _ngcontent-yxd-c119="" class="doc-title ng-star-inserted" title="订阅CPU高负载事件（ArkTS）"> 订阅CPU高负载事件（ArkTS） </h1>

<div _ngcontent-yxd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section5732184611513">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section5732184611513" tips="复制节点链接"></i></h2><p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent (应用事件打点)ArkTS API文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>addWatcher(watcher: Watcher): AppEventPackageHolder</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>添加应用事件观察者，以添加对应用事件的订阅。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>removeWatcher(watcher: Watcher): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>移除应用事件观察者，以移除对应用事件的订阅。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section97331461659">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section97331461659" tips="复制节点链接"></i></h2><p>以实现应用内多线程执行死循环生成的CPU高负载事件订阅为例，说明开发步骤。</p> </div> <ol><li><p>编辑工程中的“entry &gt; src &gt; main &gt; ets  &gt; entryability &gt; EntryAbility.ets”文件，可以在例如onCreate函数中添加系统事件的订阅，示例代码如下：</p> <div _ngcontent-yxd-c106="" class="highlight-div"><div _ngcontent-yxd-c106="" class="highlight-div-header"><div _ngcontent-yxd-c106="" class="highlight-div-header-left"><div _ngcontent-yxd-c106="" class="handle-button expand-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yxd-c106="" class="highlight-div-header-right"><div _ngcontent-yxd-c106="" class="handle-button ai-button"></div><div _ngcontent-yxd-c106="" class="handle-button line-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yxd-c106="" class="handle-button theme-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yxd-c106="" class="handle-button copy-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>   <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>   <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>   <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了崩溃事件</span></li><li>   <span class="hljs-attr">appEventFilters</span>: [</li><li>     {</li><li>       <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>       <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">CPU_USAGE_HIGH</span>]</li><li>     }</li><li>   ],</li><li>   <span class="hljs-comment">// 开发者可以自行实现订阅实时回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>   <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>       <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>       hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>         <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo)}</span>`</span>);</li><li>       }</li><li>     }</li><li>   }</li><li> });</li></ol></pre></div></div> </li><li><p>工程中添加“entry &gt; src &gt; main &gt; ets  &gt; workers&gt; worker.ets”文件，构造一个死循环，接收到主线程的消息后触发CPU高负载事件，完整示例代码如下：</p> <div _ngcontent-yxd-c106="" class="highlight-div"><div _ngcontent-yxd-c106="" class="highlight-div-header"><div _ngcontent-yxd-c106="" class="highlight-div-header-left"><div _ngcontent-yxd-c106="" class="handle-button expand-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yxd-c106="" class="highlight-div-header-right"><div _ngcontent-yxd-c106="" class="handle-button ai-button"></div><div _ngcontent-yxd-c106="" class="handle-button line-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yxd-c106="" class="handle-button theme-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yxd-c106="" class="handle-button copy-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> workerPort = worker.<span class="hljs-property">workerPort</span>;</li><li>workerPort.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {</li><li>  <span class="hljs-title function_">eatCpu</span>();</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">eatCpu</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">val</span>:<span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</li><li>    val++; </li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><p>工程中添加“entry &gt; src &gt; main &gt; ets  &gt; tester&gt; CpuTester.ets”文件，在CpuTester 类中的start方法中开启多个线程的死循环，以触发多线程的CPU高负载事件，完整示例代码如下：</p> <div _ngcontent-yxd-c106="" class="highlight-div"><div _ngcontent-yxd-c106="" class="highlight-div-header"><div _ngcontent-yxd-c106="" class="highlight-div-header-left"><div _ngcontent-yxd-c106="" class="handle-button expand-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yxd-c106="" class="highlight-div-header-right"><div _ngcontent-yxd-c106="" class="handle-button ai-button"></div><div _ngcontent-yxd-c106="" class="handle-button line-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yxd-c106="" class="handle-button theme-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yxd-c106="" class="handle-button copy-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yxd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CpuTester</span> {</li><li>  <span class="hljs-attr">workerInstance</span>: worker.<span class="hljs-property">ThreadWorker</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/worker.ets'</span>);</li><li>  <span class="hljs-title function_">start</span>(<span class="hljs-params">threadNum: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; threadNum; index++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span> = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'entry/ets/workers/worker.ets'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerInstance</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'msg'</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><p>编辑工程中的“entry &gt; src &gt; main &gt; ets  &gt; pages &gt; Index.ets”文件，添加“CPU加压”按钮并在其onClick函数构造多线程执行死循环，以触发CPU高负载事件，完整示例代码如下：</p> <div _ngcontent-yxd-c106="" class="highlight-div"><div _ngcontent-yxd-c106="" class="highlight-div-header"><div _ngcontent-yxd-c106="" class="highlight-div-header-left"><div _ngcontent-yxd-c106="" class="handle-button expand-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yxd-c106="" class="highlight-div-header-right"><div _ngcontent-yxd-c106="" class="handle-button ai-button"></div><div _ngcontent-yxd-c106="" class="handle-button line-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yxd-c106="" class="handle-button theme-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yxd-c106="" class="handle-button copy-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yxd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">CpuTester</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../tester/CpuTester'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">enable</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">threadNum</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;</li><li>
</li><li>  <span class="hljs-attr">cpuTester</span>: <span class="hljs-title class_">CpuTester</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CpuTester</span>();</li><li>
</li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>() {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'CPU加压'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)</li><li>        .<span class="hljs-title function_">margin</span>(<span class="hljs-number">12</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">enabled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">enable</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cpuTester</span>.<span class="hljs-title function_">start</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">threadNum</span>)<span class="">;</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">enable</span> = <span class="hljs-literal">false</span>;</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><p>点击DevEco Studio界面中的运行按钮，运行应用工程，然后在应用界面中点击“CPU加压”按钮，触发CPU高负载事件。应用保持在前台且屏幕处于亮屏状态，五到十分钟之后可以在Log窗口看到对系统事件数据的处理日志：</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>CPU高负载事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/power-detection#section5832932213" target="_blank">抓取次数存在限制</a>。</p> <p>开发者如果未抓取到CPU高负载事件external_log日志，可以尝试重启测试设备重新抓取。</p> </div></div></div> <div class="p"><div _ngcontent-yxd-c106="" class="highlight-div"><div _ngcontent-yxd-c106="" class="highlight-div-header"><div _ngcontent-yxd-c106="" class="highlight-div-header-left"><div _ngcontent-yxd-c106="" class="handle-button expand-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yxd-c106="" class="highlight-div-header-right"><div _ngcontent-yxd-c106="" class="handle-button ai-button"></div><div _ngcontent-yxd-c106="" class="handle-button line-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yxd-c106="" class="handle-button theme-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yxd-c106="" class="handle-button copy-button"><div _ngcontent-yxd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yxd-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent eventInfo={"domain":"OS","eventType":1,"name":"CPU_USAGE_HIGH","params":{"begin_time":1723725541352,"bundle_name":"com.xpower.test","bundle_version":"1.0.0","end_time":1723725843413,"external_log":["/data/storage/el2/log/hiappevent/CPU_USAGE_HIGH_1723725950017_0.log","/data/storage/el2/log/hiappevent/CPU_USAGE_HIGH_1723725950197_0.log"],"fault_type":1,"foreground":false,"log_over_limit":false,"threads":[{"name":"com.xpower.test","tid":60677,"usage":0.070805000000000007},{"name":"WorkerThread","tid":60856,"usage":7.4353600000000002},{"name":"WorkerThread","tid":60855,"usage":7.4645099999999998},{"name":"WorkerThread","tid":60854,"usage":7.4120400000000002},{"name":"WorkerThread","tid":60853,"usage":7.4770099999999999}],"time":1723725949836,"usage":25}}</li></ol></pre></div></div> </div> </li></ol> </div> <div></div></div>