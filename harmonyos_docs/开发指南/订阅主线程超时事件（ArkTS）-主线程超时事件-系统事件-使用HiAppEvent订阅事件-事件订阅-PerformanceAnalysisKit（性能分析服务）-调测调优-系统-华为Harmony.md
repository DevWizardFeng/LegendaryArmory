<h1 _ngcontent-hhs-c119="" class="doc-title ng-star-inserted" title="订阅主线程超时事件（ArkTS）"> 订阅主线程超时事件（ArkTS） </h1>

<div _ngcontent-hhs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本文介绍如何使用HiAppEvent提供的ArkTS接口订阅主线程超时事件。接口的详细使用说明（参数限制、取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent (应用事件打点)ArkTS API文档</a>。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">addWatcher(watcher: Watcher): AppEventPackageHolder</td>         <td class="cellrowborder" valign="top" width="50%">添加应用事件观察者，以添加对应用事件的订阅。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">removeWatcher(watcher: Watcher): void</td>         <td class="cellrowborder" valign="top" width="50%">移除应用事件观察者，以移除对应用事件的订阅。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加事件观察者" class="firsth2">添加事件观察者<i class="anchor-icon anchor-icon-link" anchorid="添加事件观察者" tips="复制节点链接"></i></h3>          <p>以主线程超时事件订阅为例，说明开发步骤。</p>     <ol>      <li>       <p>新建一个ArkTS应用工程，编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，导入依赖模块，示例代码如下：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li> <span class="hljs-keyword">import</span> { buffer, util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span></li><li> <span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，可在onCreate、onForeground等生命周期接口中添加系统事件的订阅（结合业务需求，在合适的位置添加订阅方法），示例代码如下：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>   <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>   <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>   <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了主线程超时事件</span></li><li>   <span class="hljs-attr">appEventFilters</span>: [</li><li>     {</li><li>       <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>       <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">MAIN_THREAD_JANK</span>]</li><li>     }</li><li>   ],</li><li>   <span class="hljs-comment">// 开发者可以自行实现订阅实时回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>   <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>       <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>       hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>         <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.domain=<span class="hljs-subst">${eventInfo.domain}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.name=<span class="hljs-subst">${eventInfo.name}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.eventType=<span class="hljs-subst">${eventInfo.eventType}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时事件发生的时间戳</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.time=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'time'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时应用的版本信息</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.bundle_version=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'bundle_version'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时应用的包名</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.bundle_name=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'bundle_name'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时应用的pid、uid</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.pid=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'pid'</span>]}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.uid=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'uid'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取主线程处理开始和结束时间</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.begin_time=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'begin_time'</span>]}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.end_time=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'end_time'</span>]}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.log_over_limit=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'log_over_limit'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时事件时，任务执行的开始时间（主线程超时采集堆栈参数）</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.app_start_jiffies_time=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'app_start_jiffies_time'</span>])}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到生成的主线程超时日志文件中，打印最多次的调用栈（主线程超时采集堆栈参数）</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.heaviest_stack=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'heaviest_stack'</span>]}</span>`</span>);</li><li>
</li><li>         <span class="hljs-comment">// 开发者可以获取到主线程超时事件发生时的故障日志文件</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.external_log=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'external_log'</span>])}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以通过以下方式移动文件到新的目录</span></li><li>         <span class="hljs-keyword">let</span> <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">String</span>(eventInfo.<span class="hljs-property">params</span>[<span class="hljs-string">'external_log'</span>]);</li><li>         <span class="hljs-comment">// 自定义的新的存储路径</span></li><li>         <span class="hljs-keyword">let</span> <span class="hljs-attr">targetPath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;</li><li>         <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">".txt"</span>)) {</li><li>           targetPath= <span class="hljs-string">"/data/storage/el2/base/mainThreadJank.txt"</span>;</li><li>         } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">".trace"</span>)) {</li><li>           targetPath= <span class="hljs-string">"/data/storage/el2/base/mainThreadJank.trace"</span>;</li><li>         }</li><li>         fs.<span class="hljs-title function_">copyFileSync</span>(path.<span class="hljs-title function_">toString</span>(), targetPath.<span class="hljs-title function_">toString</span>());</li><li>       }</li><li>     }</li><li>   }</li><li> });</li></ol></pre></div></div></li>      <li>       <p>该步骤用于模拟主线程超时采样栈事件。</p>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages&gt; Index.ets”文件，示例代码如下：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-meta">@Entry</span></li><li>  <span class="hljs-meta">@Component</span></li><li>  struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"timeOut350"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> t = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>              <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - t &lt;= <span class="hljs-number">350</span>) {}</li><li>            })</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>       <p>（可选）该步骤用于模拟自定义主线程超时参数，并触发主线程超时事件场景。</p>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages&gt; Index.ets”文件，本示例中设置一个customSample的Button控件，在onClick中实现自定义设置采样栈参数代码，示例代码如下：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>  <span class="hljs-comment">//模拟超时事件函数定义，示例代码：</span></li><li>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">wait150ms</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> t = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - t &lt;= <span class="hljs-number">150</span>){</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">wait500ms</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> t = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - t &lt;= <span class="hljs-number">500</span>){</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Entry</span></li><li>  <span class="hljs-meta">@Component</span></li><li>  struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-comment">//自定义设置采样栈参数按钮</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"customSample"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-comment">// 在按钮点击函数中进行事件打点，以记录按钮点击事件</span></li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, hiAppEvent.<span class="hljs-property">ParamType</span>&gt; = {</li><li>                <span class="hljs-comment">// 事件类型定义， 0-默认值，1-只采样栈 2-只收集trace</span></li><li>                <span class="hljs-string">"log_type"</span>: <span class="hljs-string">"1"</span>,</li><li>                <span class="hljs-comment">// 超时时间 &amp; 采样间隔</span></li><li>                <span class="hljs-string">"sample_interval"</span>: <span class="hljs-string">"100"</span>,</li><li>                <span class="hljs-comment">// 忽略启动开始时间</span></li><li>                <span class="hljs-string">"ignore_startup_time"</span>: <span class="hljs-string">"11"</span>,</li><li>                <span class="hljs-comment">// 采样次数</span></li><li>                <span class="hljs-string">"sample_count"</span>: <span class="hljs-string">"21"</span>,</li><li>                <span class="hljs-comment">// 事件上报次数定义</span></li><li>                <span class="hljs-string">"report_times_per_app"</span>: <span class="hljs-string">"3"</span></li><li>              };</li><li>              hiAppEvent.<span class="hljs-title function_">setEventConfig</span>(hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">MAIN_THREAD_JANK</span>, params).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent success to set event params.`</span>)</li><li>              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent err.code: <span class="hljs-subst">${err.code}</span>, err.message: <span class="hljs-subst">${err.message}</span>`</span>)</li><li>              });</li><li>            })</li><li>          <span class="hljs-comment">//触发150ms超时事件按钮</span></li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"timeOut150"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-title function_">wait150ms</span>();</li><li>            })</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>       <p>该步骤可用于模拟主线程超时采样trace事件。</p>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages&gt; Index.ets”文件，添加按钮并在其onClick函数触发主线程超时采集trace功能，具体如下：</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>启动主线程超时检测抓取trace的功能的前提是开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#nolog版本">nolog版本</a>并且关闭开发者模式。</p>        </div></div></div>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-meta">@Entry</span></li><li>  <span class="hljs-meta">@Component</span></li><li>  struct <span class="hljs-title class_">Index</span> {</li><li>    <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>      <span class="hljs-title class_">RelativeContainer</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Button</span>(<span class="hljs-string">"timeOut500"</span>, { <span class="hljs-attr">stateEffect</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>})</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'75%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>            .<span class="hljs-title function_">margin</span>(<span class="hljs-number">15</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">let</span> t = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>              <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - t &lt;= <span class="hljs-number">500</span>) {}</li><li>            })</li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>  }</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>默认情况下，由于应用启动过程本身较为耗时，系统将在<strong>应用启动10s后再进行测试，开始主线程超时事件检测</strong>；</p>         <p>若开发者使用setEventConfig接口设置自定义设置采样栈参数，系统将<strong>在开发者设定的ignore_startup_time时间后，开始主线程超时事件检测</strong>。</p>        </div></div></div>       <p>主线程超时触发的条件：在检测任务的间隔内，检测到连续两次超时事件后，才会开启采集堆栈。</p>       <p>用户可以连续快速点击2~3次触发超时的按钮，以触发主线程超时事件。</p></li>     </ol>    </div>    <div class="tiledSection">     <h3 id="验证观察者是否订阅到主线程超时事件">验证观察者是否订阅到主线程超时事件<i class="anchor-icon anchor-icon-link" anchorid="验证观察者是否订阅到主线程超时事件" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>主线程超时事件上报后，系统会回调应用的onReceive函数，可以在Log窗口看到对系统事件数据的处理日志：</p>       <p>主线程超时事件采样栈示例：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li> HiAppEvent eventInfo.domain=OS</li><li> HiAppEvent eventInfo.name=MAIN_THREAD_JANK</li><li> HiAppEvent eventInfo.eventType=1</li><li> HiAppEvent eventInfo.params.time=1717593620518</li><li> HiAppEvent eventInfo.params.bundle_version=1.0.0</li><li> HiAppEvent eventInfo.params.bundle_name=com.example.main_thread_jank</li><li> HiAppEvent eventInfo.params.pid=40986</li><li> HiAppEvent eventInfo.params.uid=20020150</li><li> HiAppEvent eventInfo.params.begin_time=1717593620016</li><li> HiAppEvent eventInfo.params.end_time=1717593620518</li><li> HiAppEvent eventInfo.params.external_log=["/data/storage/el2/log/watchdog/MAIN_THREAD_JANK_20240613211739_40986.XXX"]</li><li> HiAppEvent eventInfo.params.log_over_limit=false</li><li> HiAppEvent eventInfo.params.app_start_jiffies_time=XXXX</li><li> HiAppEvent eventInfo.params.heaviest_stack=XXXX</li></ol></pre></div></div>       <p>主线程超时事件采样trace，与采样栈的结果大致相同，不同的地方：</p>       <div _ngcontent-hhs-c106="" class="highlight-div"><div _ngcontent-hhs-c106="" class="highlight-div-header"><div _ngcontent-hhs-c106="" class="highlight-div-header-left"><div _ngcontent-hhs-c106="" class="handle-button expand-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hhs-c106="" class="highlight-div-header-right"><div _ngcontent-hhs-c106="" class="handle-button ai-button"></div><div _ngcontent-hhs-c106="" class="handle-button line-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hhs-c106="" class="handle-button theme-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hhs-c106="" class="handle-button copy-button"><div _ngcontent-hhs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hhs-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>栈：</li><li>  采样栈增加两个参数：app_start_jiffies_time和heaviest_stack。</li><li>  external_log=["/data/storage/el2/log/watchdog/MAIN_THREAD_JANK_yyyyMMDDHHmmss_xxxx.txt"]。xxxx：代表进程pid</li><li>
</li><li>trace：</li><li>  external_log=["/data/storage/el2/log/watchdog/MAIN_THREAD_JANK_unix时间戳_xxxx.trace"]。xxxx：代表进程pid</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>