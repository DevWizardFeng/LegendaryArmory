<h1 _ngcontent-gox-c119="" class="doc-title ng-star-inserted" title="订阅启动耗时事件（ArkTS）"> 订阅启动耗时事件（ArkTS） </h1>

<div _ngcontent-gox-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section9799154210491">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section9799154210491" tips="复制节点链接"></i></h2></div> <p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent (应用事件打点)ArkTS API文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>addWatcher(watcher: Watcher): AppEventPackageHolder</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>添加应用事件观察者，以添加对应用事件的订阅。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>removeWatcher(watcher: Watcher): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>移除应用事件观察者，以移除对应用事件的订阅。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section4293172453212">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section4293172453212" tips="复制节点链接"></i></h2></div> <p>以实现对用户运行应用工程生成的启动耗时事件订阅为例，说明开发步骤。</p> <ol><li><p>编辑工程中的“entry &gt; src &gt; main &gt; ets  &gt; entryability &gt; EntryAbility.ets”文件，在onCreate函数中添加系统事件的订阅，示例代码如下：</p> <div _ngcontent-gox-c106="" class="highlight-div"><div _ngcontent-gox-c106="" class="highlight-div-header"><div _ngcontent-gox-c106="" class="highlight-div-header-left"><div _ngcontent-gox-c106="" class="handle-button expand-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gox-c106="" class="highlight-div-header-right"><div _ngcontent-gox-c106="" class="handle-button ai-button"></div><div _ngcontent-gox-c106="" class="handle-button line-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gox-c106="" class="handle-button theme-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gox-c106="" class="handle-button copy-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gox-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>   <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>   <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>   <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了启动耗时事件</span></li><li>   <span class="hljs-attr">appEventFilters</span>: [</li><li>     {</li><li>       <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>       <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_LAUNCH</span>]</li><li>     }</li><li>   ],</li><li>   <span class="hljs-comment">// 开发者可以自行实现订阅回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>   <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>       <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>       hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>         <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo)}</span>`</span>);</li><li>       }</li><li>     }</li><li>   }</li><li> });</li></ol></pre></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ul><li>系统在监控应用启动时，依赖多个系统内部事件的记录。若这些事件在完成应用启动的5秒内全部上报，系统将立即生成APP_LAUNCH事件，并通过回调函数将事件内容传递给应用；若非关键事件存在缺失，系统将在5秒后根据实际接收到的事件生成APP_LAUNCH事件。</li><li>单设备上的所有应用在24小时内最多可以累计上报2000次APP_LAUNCH事件。若在一次启动流程中，涉及多个同一依赖事件的触发（如在启动过程中调用多次<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-uiabilitycontext#startability-1" target="_blank">startAbility</a>），会导致实际可上报的启动耗时事件数量少于理论上限。</li><li>启动完成前（如应用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-profiler-launch-case" target="_blank">首帧绘制</a>前）终止启动不会生成APP_LAUNCH事件。</li><li>在订阅APP_LAUNCH事件后，应用启动完成生成APP_LAUNCH事件触发回调的过程中，若应用出现退出或崩溃，onReceive回调接口可能不会被触发，从而导致事件回调处理失败。当应用重新启动时，回调函数会将之前未完成回调的事件内容传递给应用，导致onReceive回调<strong>可能在一次应用启动过程中被多次调用</strong>。</li><li><strong>不建议在onReceive中执行任何关键业务逻辑</strong>（例如移除事件观察者、资源释放等操作），否则可能导致业务代码重复执行、资源被多次释放，从而引发程序错误甚至应用崩溃。</li><li>建议开发者将 onReceive 仅用于事件的接收和简单记录。</li></ul> </div></div></div> </li><li><p>点击DevEco Studio界面中的运行按钮，运行应用工程，添加系统事件订阅者，退出应用，再次点击桌面应用图标，触发一次启动耗时事件。</p> </li><li><p>应用工程再次启动可以在Log窗口看到对系统事件数据的处理日志：</p> <div _ngcontent-gox-c106="" class="highlight-div"><div _ngcontent-gox-c106="" class="highlight-div-header"><div _ngcontent-gox-c106="" class="highlight-div-header-left"><div _ngcontent-gox-c106="" class="handle-button expand-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gox-c106="" class="highlight-div-header-right"><div _ngcontent-gox-c106="" class="handle-button ai-button"></div><div _ngcontent-gox-c106="" class="handle-button line-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gox-c106="" class="handle-button theme-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gox-c106="" class="handle-button copy-button"><div _ngcontent-gox-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gox-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent onReceive: domain=OS</li><li>HiAppEvent eventName=APP_LAUNCH</li><li>HiAppEvent eventInfo={"domain":"OS","name":"APP_LAUNCH","eventType":4,"params":{"animation_finish_time":662,"bundle_name":"com.example.myapplication","bundle_version":"1.0.0","extend_time":0,"icon_input_time":1709367533224,"process_name":"com.example.myapplication","start_type":0,"time":1709367533901}}</li></ol></pre></div></div> </li></ol> </div> <div></div></div>