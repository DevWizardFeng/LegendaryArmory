<h1 _ngcontent-hqx-c119="" class="doc-title ng-star-inserted" title="订阅崩溃事件（ArkTS）"> 订阅崩溃事件（ArkTS） </h1>

<div _ngcontent-hqx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本文介绍如何使用HiAppEvent提供的ArkTS接口订阅应用崩溃事件。接口的详细使用说明（参数限制、取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent (应用事件打点)ArkTS API文档</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>使用ArkTS接口可以订阅JsError和NativeCrash两种崩溃事件。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">addWatcher(watcher: Watcher): AppEventPackageHolder</td>         <td class="cellrowborder" valign="top" width="50%">添加应用事件观察者，以添加对应用事件的订阅。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">removeWatcher(watcher: Watcher): void</td>         <td class="cellrowborder" valign="top" width="50%">移除应用事件观察者，以移除对应用事件的订阅。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加事件观察者" class="firsth2">添加事件观察者<i class="anchor-icon anchor-icon-link" anchorid="添加事件观察者" tips="复制节点链接"></i></h3>          <p><strong>建议在应用启动后、执行业务逻辑前添加事件观察者，以确保能够订阅到崩溃事件。</strong></p>     <p>以订阅用户点击按钮触发崩溃生成的崩溃事件为例，说明开发步骤。</p>     <ol>      <li>       <p>DevEco Studio新建Native C++模板工程，编辑“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，导入依赖模块。示例代码如下：</p>       <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, deviceInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，在onCreate函数中设置事件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events#崩溃事件自定义参数设置">崩溃事件自定义参数</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events#崩溃日志规格自定义参数设置">崩溃日志规格自定义参数</a>，示例代码如下：</p>       <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-comment">// 构建崩溃事件的自定义参数</span></li><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, hiAppEvent.<span class="hljs-property">ParamType</span>&gt; = {</li><li>   <span class="hljs-string">"test_data"</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">//test_data为自定义数据，开发者可根据实际需求自定义params参数。</span></li><li> };</li><li> <span class="hljs-comment">// 开发者可以设置崩溃事件的自定义参数</span></li><li> hiAppEvent.<span class="hljs-title function_">setEventParam</span>(params, hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>, hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_CRASH</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>   hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent success to set event param`</span>);</li><li> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>   hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li> });</li><li>
</li><li> <span class="hljs-keyword">if</span> (deviceInfo.<span class="hljs-property">sdkApiVersion</span> &gt;= <span class="hljs-number">20</span>) {  <span class="hljs-comment">// API Version 20及以后版本，支持设置崩溃日志配置参数</span></li><li>   <span class="hljs-comment">// 构建崩溃日志规格自定义参数</span></li><li>   <span class="hljs-keyword">let</span> <span class="hljs-attr">crashConfigParams</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, hiAppEvent.<span class="hljs-property">ParamType</span>&gt; = {</li><li>     <span class="hljs-string">"extend_pc_lr_printing"</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 使能扩展打印pc和lr寄存器附近的内存值</span></li><li>     <span class="hljs-string">"log_file_cutoff_sz_bytes"</span>: <span class="hljs-number">1024000</span>, <span class="hljs-comment">// 截断崩溃日志到1000KB</span></li><li>     <span class="hljs-string">"simplify_vma_printing"</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 使能精简打印maps</span></li><li>   };</li><li>   <span class="hljs-comment">// 开发者可以设置崩溃日志配置参数</span></li><li>   hiAppEvent.<span class="hljs-title function_">setEventConfig</span>(hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_CRASH</span>, crashConfigParams).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent success to set event config.`</span>);</li><li>   }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>   });</li><li> }</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，在 onCreate 函数中订阅系统事件。示例代码如下：</p>       <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">let</span> <span class="hljs-attr">watcher</span>: hiAppEvent.<span class="hljs-property">Watcher</span> = {</li><li>   <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>   <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>   <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了崩溃事件</span></li><li>   <span class="hljs-attr">appEventFilters</span>: [</li><li>     {</li><li>       <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>       <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_CRASH</span>]</li><li>     }</li><li>   ],</li><li>   <span class="hljs-comment">// 开发者可以自行实现订阅实时回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>   <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>       <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>       hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>         <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.domain=<span class="hljs-subst">${eventInfo.domain}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.name=<span class="hljs-subst">${eventInfo.name}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.eventType=<span class="hljs-subst">${eventInfo.eventType}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件发生的时间戳</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.time=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'time'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件发生的崩溃类型</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.crash_type=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'crash_type'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃应用的前后台状态</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.foreground=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'foreground'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃应用的版本信息</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.bundle_version=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'bundle_version'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃应用的包名</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.bundle_name=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'bundle_name'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃应用的进程id</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.pid=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'pid'</span>]}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.uid=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'uid'</span>]}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.uuid=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'uuid'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件发生的异常类型、异常原因和异常调用栈</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.exception=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'exception'</span>])}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件发生时日志信息</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.hilog.size=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'hilog'</span>].length}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件发生时的崩溃日志文件</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.external_log=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo.params[<span class="hljs-string">'external_log'</span>])}</span>`</span>);</li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.log_over_limit=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'log_over_limit'</span>]}</span>`</span>);</li><li>         <span class="hljs-comment">// 开发者可以获取到崩溃事件的自定义数据test_data</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.test_data=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'test_data'</span>]}</span>`</span>);</li><li>       }</li><li>     }</li><li>   }</li><li> };</li><li> hiAppEvent.<span class="hljs-title function_">addWatcher</span>(watcher);</li></ol></pre></div></div></li>      <li>       <p>构造崩溃场景</p>       <ul>        <li>         <p>构造NativeCrash类型崩溃</p>         <p>编辑工程中的“entry &gt; src &gt; main &gt; cpp &gt; napi_init.cpp”文件，Add方法中增加如下代码：</p>         <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> *p = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int</span> a = *p; <span class="hljs-comment">// 空指针解引用，程序会在此处崩溃</span></li></ol></pre></div></div>         <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加按钮并在其onClick函数中构造崩溃场景，以触发崩溃事件。示例代码如下：</p>         <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">"NativeCrash"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>  <span class="hljs-comment">// 在按钮点击函数中调用napi_init.cpp中Add方法触发NativeCrash类型崩溃事件</span></li><li>  testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);</li><li>})</li></ol></pre></div></div></li>        <li>         <p>构造JsError类型崩溃</p>         <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加按钮并在其onClick函数中构造崩溃场景，以触发崩溃事件。示例代码如下：</p>         <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">"JsError"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">()=&gt;</span>{</li><li>  <span class="hljs-comment">// 在按钮点击函数中构造一个JsError类型崩溃，触发应用崩溃事件</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">object</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">""</span>);</li><li>})</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>点击DevEco Studio界面的运行按钮，启动应用工程。在应用界面中点击“NativeCrash”或“JsError”按钮，触发崩溃事件。系统根据崩溃类型生成相应的日志并进行回调。</p></li>     </ol>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>JsError通过进程内采集故障信息触发回调，速度快，而NativeCrash采取进程外采集故障信息，平均耗时约2秒，具体受业务线程数量和进程间通信影响。开发者可订阅崩溃事件，故障信息采集完成后异步上报，不阻塞当前业务。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="验证观察者是否订阅到崩溃事件">验证观察者是否订阅到崩溃事件<i class="anchor-icon anchor-icon-link" anchorid="验证观察者是否订阅到崩溃事件" tips="复制节点链接"></i></h3>          <p>在应用主动捕获崩溃异常和未主动捕获崩溃异常的场景下，崩溃事件的回调时机不同，需在不同时间验证是否订阅到崩溃事件。</p>     <p><strong>应用未主动捕获崩溃异常场景</strong></p>     <p>若应用未主动捕获崩溃异常，系统处理崩溃后应用将退出。<strong>应用下次启动时</strong>，HiAppEvent将崩溃事件上报给已注册的监听，完成回调。</p>     <p>若应用无法启动或长时间未启动，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/fault-log-extension-app-events-arkts">使用FaultLogExtensionAbility订阅事件</a>回调重写的函数，进行延迟上报。</p>     <p><strong>应用主动捕获崩溃异常场景</strong></p>     <p>若应用主动捕获崩溃异常，崩溃事件将在<strong>应用退出前</strong>回调，例如以下两种情况：</p>     <ol>      <li>       <p>异常处理中未主动退出，应用崩溃后将不会退出。</p>       <p>采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-errormanager#errormanageronerror" target="_blank">errorManger.on</a>方法捕获异常会导致JsError类型的崩溃事件在应用退出前回调。若应用主动注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cppcrash-guidelines#系统处理的崩溃信号">崩溃信号</a>处理函数但未主动退出，会导致NativeCrash类型的崩溃事件在应用退出前回调。</p></li>      <li>       <p>异常处理耗时过长，导致应用退出延迟。</p></li>     </ol>     <p>在开发调试阶段，HiAppEvent上报事件完成回调后，可以在DevEco Studio的HiLog窗口查看JsError类型崩溃事件内容。NativeCrash类型崩溃事件内容略有不同，具体参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events#事件字段说明">崩溃事件字段说明</a>。JsError类型崩溃事件内容样例如下：</p>     <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent onReceive: domain=OS</li><li>HiAppEvent eventName=APP_CRASH</li><li>HiAppEvent eventInfo.domain=OS</li><li>HiAppEvent eventInfo.name=APP_CRASH</li><li>HiAppEvent eventInfo.eventType=1</li><li>HiAppEvent eventInfo.params.time=1711440614001</li><li>HiAppEvent eventInfo.params.crash_type=JsError</li><li>HiAppEvent eventInfo.params.foreground=true</li><li>HiAppEvent eventInfo.params.bundle_version=1.0.0</li><li>HiAppEvent eventInfo.params.bundle_name=com.example.myapplication</li><li>HiAppEvent eventInfo.params.pid=2043</li><li>HiAppEvent eventInfo.params.uid=20010043</li><li>HiAppEvent eventInfo.params.uuid=b1e953ba0022c112e4502e28e8b3ad6d95cf3c87bae74068038f03b38ce7f66a</li><li>HiAppEvent eventInfo.params.exception={"message":"Unexpected Text in JSON","name":"SyntaxError","stack":"at anonymous (entry/src/main/ets/pages/Index.ets:55:34)"}</li><li>HiAppEvent eventInfo.params.hilog.size=90</li><li>HiAppEvent eventInfo.params.external_log=["/data/storage/el2/log/hiappevent/APP_CRASH_1711440614112_2043.log"]</li><li>HiAppEvent eventInfo.params.log_over_limit=false</li><li>HiAppEvent eventInfo.params.test_data=100</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="移除事件观察者">移除事件观察者<i class="anchor-icon anchor-icon-link" anchorid="移除事件观察者" tips="复制节点链接"></i></h3>          <div _ngcontent-hqx-c106="" class="highlight-div"><div _ngcontent-hqx-c106="" class="highlight-div-header"><div _ngcontent-hqx-c106="" class="highlight-div-header-left"><div _ngcontent-hqx-c106="" class="handle-button expand-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqx-c106="" class="highlight-div-header-right"><div _ngcontent-hqx-c106="" class="handle-button ai-button"></div><div _ngcontent-hqx-c106="" class="handle-button line-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqx-c106="" class="handle-button theme-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqx-c106="" class="handle-button copy-button"><div _ngcontent-hqx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqx-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 移除该应用事件观察者以取消订阅事件</span></li><li>hiAppEvent.<span class="hljs-title function_">removeWatcher</span>(watcher);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="从faultlogger接口迁移崩溃事件">从Faultlogger接口迁移崩溃事件<i class="anchor-icon anchor-icon-link" anchorid="从faultlogger接口迁移崩溃事件" tips="复制节点链接"></i></h2>          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger" target="_blank">@ohos.faultLogger (故障日志获取)</a>接口从API version 18开始废弃使用, 不再维护。后续版本推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent</a>订阅崩溃事件。该章节指导开发者从Faultlogger接口迁移至hiAppEvent接口，来订阅崩溃事件。</p>     <p>在Faultlogger的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faulttype" target="_blank">FaultType</a>里定义的CPP_CRASH和JS_CRASH都属于崩溃故障类型。</p>     <p>在hiAppEvent的hiAppEvent.addWatcher接口中设置事件名称为hiAppEvent.event.APP_CRASH、事件领域为hiAppEvent.domain.OS，可以订阅崩溃事件。</p>     <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events#params字段说明">hiAppEvent.AppEventInfo.params</a>中的crash_type字段可以区分具体是哪种崩溃事件。</p>     <p>两者对应关系如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.7.1.3.1.1" valign="top" width="50%">Faultlogger.FaultType</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.7.1.3.1.2" valign="top" width="50%">hiAppEvent.AppEventInfo.params.crash_type</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">CPP_CRASH</td>         <td class="cellrowborder" valign="top" width="50%">NativeCrash</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">JS_CRASH</td>         <td class="cellrowborder" valign="top" width="50%">JsError</td>        </tr>             </tbody></table></div>     </div>     <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faultloginfo" target="_blank">FaultLogInfo</a>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events#params字段说明">hiAppEvent.AppEventInfo.params</a>的对应关系如下：</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.7.9.1.4.1.1" valign="top" width="33.33333333333333%">Faultlogger.FaultLogInfo</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.9.1.4.1.2" valign="top" width="33.33333333333333%">hiAppEvent.AppEventInfo.params</th>         <th align="left" class="cellrowborder" id="mcps1.3.7.9.1.4.1.3" valign="top" width="33.33333333333333%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">pid</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">pid</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">uid</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">uid</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">type</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">crash_type</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">类型不同，Faultlogger中是故障类型枚举，hiAppEvent中是字符串类型。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">timestamp</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">time</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">module</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">bundle_name</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">fullLog</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">external_log</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">fullLog为故障日志全文。external_log为故障日志文件应用沙箱路径，访问该路径的文件，可以得到故障日志全文。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">reason</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">external_log文件内容中的Reason字段</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">无</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="33.33333333333333%">summary</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">external_log文件内容中的一部分</td>         <td class="cellrowborder" valign="top" width="33.33333333333333%">CPP_CRASH的summary对应external_log文件内容中的Fault thread info字段；JS_CRASH的summary对应external_log文件内容中的Error name、Error message、 Stacktrace、HybridStack字段。</td>        </tr>             </tbody></table></div>     </div>     <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faultloggerquery9" target="_blank">FaultLogger.query(使用callback回调)</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-faultlogger#faultloggerquery9-1" target="_blank">FaultLogger.query(使用Promise回调)</a>都可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventaddwatcher" target="_blank">hiAppEvent.addWatcher</a>实现相同功能。</p>     <p>查阅<a href="/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events-arkts#开发步骤">开发步骤</a>和<a href="/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events-arkts#验证观察者是否订阅到崩溃事件">验证观察者是否订阅到崩溃事件</a>，了解使用hiAppEvent订阅崩溃事件（ArkTS）的具体步骤。</p>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitee.com/harmonyos_samples/exception-handling" target="_blank">应用异常处理</a></li>     </ul>    </div>   </div>   <div></div></div>