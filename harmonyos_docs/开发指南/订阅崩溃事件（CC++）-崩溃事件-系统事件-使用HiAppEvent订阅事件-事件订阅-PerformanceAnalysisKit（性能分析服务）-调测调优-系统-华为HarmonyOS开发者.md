<h1 _ngcontent-fxh-c119="" class="doc-title ng-star-inserted" title="订阅崩溃事件（C/C++）"> 订阅崩溃事件（C/C++） </h1>

<div _ngcontent-fxh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本文介绍如何使用HiAppEvent提供的C/C++接口订阅应用崩溃事件。详细使用说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hiappevent-h" target="_blank">HiAppEvent C API文档</a>。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>使用C/C++接口订阅JsError和NativeCrash崩溃事件。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiAppEvent_AddWatcher(HiAppEvent_Watcher *watcher)</td>         <td class="cellrowborder" valign="top" width="50%">添加应用事件观察者，以添加对应用事件的订阅。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">int OH_HiAppEvent_RemoveWatcher(HiAppEvent_Watcher *watcher)</td>         <td class="cellrowborder" valign="top" width="50%">移除应用事件观察者，以移除对应用事件的订阅。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="添加事件观察者" class="firsth2">添加事件观察者<i class="anchor-icon anchor-icon-link" anchorid="添加事件观察者" tips="复制节点链接"></i></h3>          <p><strong>在应用启动后，在执行业务逻辑前添加事件观察者，以确保订阅到崩溃事件。否则，应用可能因崩溃而退出，无法订阅崩溃事件。</strong></p>     <p>以用户点击按钮触发崩溃事件为例，开发步骤如下：</p>     <ol>      <li>       <p>获取示例工程的依赖项jsoncpp。</p>       <p>参考<a href="https://github.com/open-source-parsers/jsoncpp" target="_blank">三方开源库jsoncpp代码仓</a>README中<strong>Amalgamated source</strong>部分，获取jsoncpp.cpp、json.h和json-forwards.h三个文件。</p></li>      <li>       <p>新建Native C++工程，并将上述文件导入到新建工程，目录结构如下。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="yml prettyprint linenums hljs language-yaml" hw-language="yml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">entry:</span></li><li>  <span class="hljs-attr">src:</span></li><li>    <span class="hljs-attr">main:</span></li><li>      <span class="hljs-attr">cpp:</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">json.h</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">json-forwards.h</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">types:</span></li><li>            <span class="hljs-attr">libentry:</span></li><li>              <span class="hljs-bullet">-</span> <span class="hljs-string">index.d.ts</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">CMakeLists.txt</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">napi_init.cpp</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">jsoncpp.cpp</span></li><li>      <span class="hljs-attr">ets:</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">entryability:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">EntryAbility.ets</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">pages:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">Index.ets</span></li></ol></pre></div></div></li>      <li>       <p>在"CMakeLists.txt"文件中，添加源文件和动态库。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li># 新增jsoncpp<span class="hljs-selector-class">.cpp</span>(解析订阅事件中的json字符串)源文件</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp jsoncpp.cpp)</li><li># 新增动态库依赖libhiappevent_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>和libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(日志输出)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libhiappevent_ndk.z.so)</li></ol></pre></div></div></li>      <li>       <p>在"napi_init.cpp"文件中，导入依赖文件，并定义LOG_TAG。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"json/json.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hiappevent/hiappevent.h"</span></span></li><li>
</li><li><span class="hljs-meta">#<span class="hljs-keyword">undef</span> LOG_TAG</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"testTag"</span></span></li></ol></pre></div></div></li>      <li>       <p>订阅系统事件。</p>       <ul>        <li>         <p>onReceive类型观察者</p>         <p>在"napi_init.cpp"文件中，定义onReceive类型观察者的方法：</p>         <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//定义一个变量，缓存创建的观察者指针。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">HiAppEvent_Watcher</span> *<span class="hljs-variable">systemEventWatcher</span>;</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnReceive</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">domain</span>, <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> <span class="hljs-variable">HiAppEvent_AppEventGroup</span> *<span class="hljs-variable">appEventGroups</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">groupLen</span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">groupLen</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">appEventGroups</span>[<span class="hljs-title class_">i</span>].<span class="hljs-title class_">infoLen</span>; ++<span class="hljs-title class_">j</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">domain</span>);</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">name</span>);</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span>, <span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-keyword">type</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">strcmp</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">domain</span>, <span class="hljs-variable">DOMAIN_OS</span>) == <span class="hljs-number">0</span> &amp;&amp;</li><li>                <span class="hljs-title function_">strcmp</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">name</span>, <span class="hljs-variable">EVENT_APP_CRASH</span>) == <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Value</span> <span class="hljs-title class_">params</span>;</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Reader</span> <span class="hljs-title class_">reader</span>(<span class="hljs-variable">Json</span>::<span class="hljs-variable">Features</span>::<span class="hljs-title class_">strictMode</span>());</li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">FastWriter</span> <span class="hljs-title class_">writer</span>;</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">reader</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">appEventGroups</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">appEventInfos</span>[<span class="hljs-variable">j</span>].<span class="hljs-variable">params</span>, <span class="hljs-variable">params</span>)) {</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">time</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"time"</span>].<span class="hljs-title function_">asInt64</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">crashType</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"crash_type"</span>].<span class="hljs-title function_">asString</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">foreground</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"foreground"</span>].<span class="hljs-title function_">asBool</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">bundleVersion</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"bundle_version"</span>].<span class="hljs-title function_">asString</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">bundleName</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"bundle_name"</span>].<span class="hljs-title function_">asString</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">pid</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"pid"</span>].<span class="hljs-title function_">asInt</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">uid</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"uid"</span>].<span class="hljs-title function_">asInt</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">uuid</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"uuid"</span>].<span class="hljs-title function_">asString</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">exception</span> = <span class="hljs-variable">writer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">params</span>[<span class="hljs-string">"exception"</span>]);</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">hilogSize</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"hilog"</span>].<span class="hljs-title function_">size</span>();</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">externalLog</span> = <span class="hljs-variable">writer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">params</span>[<span class="hljs-string">"external_log"</span>]);</li><li>                    <span class="hljs-variable">auto</span> <span class="hljs-variable">logOverLimit</span> = <span class="hljs-variable">params</span>[<span class="hljs-string">"log_over_limit"</span>].<span class="hljs-title function_">asBool</span>();</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.time=%{public}lld"</span>, <span class="hljs-variable">time</span>);</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.crash_type=%{public}s"</span>, <span class="hljs-variable">crashType</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.foreground=%{public}d"</span>, <span class="hljs-variable">foreground</span>);</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.bundle_version=%{public}s"</span>, <span class="hljs-variable">bundleVersion</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.bundle_name=%{public}s"</span>, <span class="hljs-variable">bundleName</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.pid=%{public}d"</span>, <span class="hljs-variable">pid</span>);</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.uid=%{public}d"</span>, <span class="hljs-variable">uid</span>);</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.uuid=%{public}s"</span>, <span class="hljs-variable">uuid</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.exception=%{public}s"</span>, <span class="hljs-variable">exception</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.hilog.size=%{public}d"</span>, <span class="hljs-variable">hilogSize</span>);</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.external_log=%{public}s"</span>, <span class="hljs-variable">externalLog</span>.<span class="hljs-title function_">c_str</span>());</li><li>                    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.log_over_limit=%{public}d"</span>, <span class="hljs-variable">logOverLimit</span>);</li><li>                }</li><li>            }</li><li>        }</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">RegisterWatcher</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-comment">// 开发者自定义观察者名称，系统根据名称识别不同的观察者。</span></li><li>    <span class="hljs-variable">systemEventWatcher</span> = <span class="hljs-title function_">OH_HiAppEvent_CreateWatcher</span>(<span class="hljs-string">"onReceiverWatcher"</span>);</li><li>    <span class="hljs-comment">// 订阅的事件为EVENT_APP_CRASH。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">names</span>[] = {<span class="hljs-variable">EVENT_APP_CRASH</span>};</li><li>    <span class="hljs-comment">// 此处开发者订阅了系统事件EVENT_APP_CRASH。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetAppEventFilter</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">DOMAIN_OS</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">names</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 开发者通过调用OH_HiAppEvent_SetWatcherOnReceive函数设置已实现的回调函数，观察者接收到事件后会触发OnReceive回调。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetWatcherOnReceive</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">OnReceive</span>);</li><li>    <span class="hljs-comment">// 启动观察者以监听事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_AddWatcher</span>(<span class="hljs-variable">systemEventWatcher</span>);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>        <li>         <p>onTrigger类型观察者</p>         <p>在"napi_init.cpp"文件中，定义OnTrigger类型观察者：</p>         <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//定义一个变量，用来缓存创建的观察者指针。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">HiAppEvent_Watcher</span> *<span class="hljs-variable">systemEventWatcher</span>;</li><li>
</li><li><span class="hljs-comment">// 开发者需要实现一个回调函数`OnTake`来获取已监听事件，其中`events`指针仅在该函数内有效。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnTake</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-keyword">const</span> *<span class="hljs-variable">events</span>, <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">eventLen</span>) {</li><li>    <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Reader</span> <span class="hljs-title class_">reader</span>(<span class="hljs-variable">Json</span>::<span class="hljs-variable">Features</span>::<span class="hljs-title class_">strictMode</span>());</li><li>    <span class="hljs-variable">Json</span>::<span class="hljs-title class_">FastWriter</span> <span class="hljs-title class_">writer</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">eventLen</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Value</span> <span class="hljs-title class_">eventInfo</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">reader</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">events</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">eventInfo</span>)) {</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">domain</span> =  <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"domain_"</span>].<span class="hljs-title function_">asString</span>();</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">name</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"name_"</span>].<span class="hljs-title function_">asString</span>();</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"type_"</span>].<span class="hljs-title function_">asInt</span>();</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span>, <span class="hljs-variable">domain</span>.<span class="hljs-title function_">c_str</span>());</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span>, <span class="hljs-variable">name</span>.<span class="hljs-title function_">c_str</span>());</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span>, <span class="hljs-keyword">type</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">domain</span> ==  <span class="hljs-variable">DOMAIN_OS</span> &amp;&amp; <span class="hljs-variable">name</span> == <span class="hljs-variable">EVENT_APP_CRASH</span>) {</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">time</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"time"</span>].<span class="hljs-title function_">asInt64</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">crashType</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"crash_type"</span>].<span class="hljs-title function_">asString</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">foreground</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"foreground"</span>].<span class="hljs-title function_">asBool</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">bundleVersion</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"bundle_version"</span>].<span class="hljs-title function_">asString</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">bundleName</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"bundle_name"</span>].<span class="hljs-title function_">asString</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">pid</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"pid"</span>].<span class="hljs-title function_">asInt</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">uid</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"uid"</span>].<span class="hljs-title function_">asInt</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">uuid</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"uuid"</span>].<span class="hljs-title function_">asString</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">exception</span> = <span class="hljs-variable">writer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"exception"</span>]);</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">hilogSize</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"hilog"</span>].<span class="hljs-title function_">size</span>();</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">externalLog</span> = <span class="hljs-variable">writer</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"external_log"</span>]);</li><li>                <span class="hljs-variable">auto</span> <span class="hljs-variable">logOverLimit</span> = <span class="hljs-variable">eventInfo</span>[<span class="hljs-string">"log_over_limit"</span>].<span class="hljs-title function_">asBool</span>();</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.time=%{public}lld"</span>, <span class="hljs-variable">time</span>);</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.crash_type=%{public}s"</span>, <span class="hljs-variable">crashType</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.foreground=%{public}d"</span>, <span class="hljs-variable">foreground</span>);</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.bundle_version=%{public}s"</span>, <span class="hljs-variable">bundleVersion</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.bundle_name=%{public}s"</span>, <span class="hljs-variable">bundleName</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.pid=%{public}d"</span>, <span class="hljs-variable">pid</span>);</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.uid=%{public}d"</span>, <span class="hljs-variable">uid</span>);</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.uuid=%{public}s"</span>, <span class="hljs-variable">uuid</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.exception=%{public}s"</span>, <span class="hljs-variable">exception</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.hilog.size=%{public}d"</span>, <span class="hljs-variable">hilogSize</span>);</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.external_log=%{public}s"</span>, <span class="hljs-variable">externalLog</span>.<span class="hljs-title function_">c_str</span>());</li><li>                <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LogType</span>::<span class="hljs-title class_">LOG_APP</span>, <span class="hljs-string">"HiAppEvent eventInfo.params.log_over_limit=%{public}d"</span>, <span class="hljs-variable">logOverLimit</span>);</li><li>            }</li><li>        }</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 开发者应实现订阅回调函数，用以对获取的事件打点数据进行自定义处理。</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">OnTrigger</span>(<span class="hljs-variable">int</span> <span class="hljs-variable">row</span>, <span class="hljs-variable">int</span> <span class="hljs-variable">size</span>) {</li><li>    <span class="hljs-comment">// 接收回调后，获取指定数量的事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_TakeWatcherData</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">row</span>, <span class="hljs-variable">OnTake</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">RegisterWatcher</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-comment">// 开发者自定义观察者名称，系统根据不同的名称来识别不同的观察者。</span></li><li>    <span class="hljs-variable">systemEventWatcher</span> = <span class="hljs-title function_">OH_HiAppEvent_CreateWatcher</span>(<span class="hljs-string">"onTriggerWatcher"</span>);</li><li>    <span class="hljs-comment">// 设置订阅的事件为EVENT_APP_CRASH。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">names</span>[] = {<span class="hljs-variable">EVENT_APP_CRASH</span>};</li><li>    <span class="hljs-comment">// 开发者订阅感兴趣的事件，此处订阅了系统事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetAppEventFilter</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">DOMAIN_OS</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">names</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 开发者设置已实现的回调函数，需OH_HiAppEvent_SetTriggerCondition设置的条件满足方可触发。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetWatcherOnTrigger</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">OnTrigger</span>);</li><li>    <span class="hljs-comment">// 设置订阅触发回调的条件：当设置新增事件打点数量为1时，触发onTrigger回调。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetTriggerCondition</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">// 启动观察者以监听订阅的事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_AddWatcher</span>(<span class="hljs-variable">systemEventWatcher</span>);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>       </ul></li>      <li>       <p>将RegisterWatcher注册为ArkTS接口。</p>       <p>在"napi_init.cpp"文件中，将RegisterWatcher注册为ArkTS接口：</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"registerWatcher"</span>, <span class="hljs-literal">nullptr</span>, RegisterWatcher, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div>       <p>在"index.d.ts"文件中，定义ArkTS接口：</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerWatcher</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>      <li>       <p>在"EntryAbility.ets"文件的onCreate()函数中添加接口调用。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入依赖模块</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span></li><li>
</li><li><span class="hljs-comment">// 在onCreate()函数中新增接口调用</span></li><li><span class="hljs-comment">// 启动时，注册系统事件观察者</span></li><li>testNapi.<span class="hljs-title function_">registerWatcher</span>();</li></ol></pre></div></div></li>      <li>       <p>在"Index.ets"文件中，新增按钮触发崩溃事件。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">"appCrash"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">""</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>点击运行按钮，启动应用工程。在应用界面中点击“appCrash”按钮，触发崩溃事件。系统生成相应的崩溃日志并进行回调。</p></li>     </ol>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>JsError通过进程内采集故障信息触发回调，速度快。NativeCrash采取进程外采集故障信息，平均耗时约2秒，具体受业务线程数量和进程间通信影响。订阅崩溃事件后，故障信息采集完成会异步上报，不阻塞当前业务。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="验证观察者是否订阅到崩溃事件">验证观察者是否订阅到崩溃事件<i class="anchor-icon anchor-icon-link" anchorid="验证观察者是否订阅到崩溃事件" tips="复制节点链接"></i></h3>          <p>在应用未主动捕获崩溃异常和主动捕获崩溃异常的两种场景中，崩溃事件的回调时机不同。开发者需要在每种情况下验证是否订阅到崩溃事件。</p>     <p><strong>应用未主动捕获崩溃异常场景</strong></p>     <p>若应用未主动捕获崩溃异常，则系统处理崩溃后应用将退出。<strong>应用下次启动时</strong>，HiAppEvent将崩溃事件上报给已注册的监听，完成回调。</p>     <p>从API version 21开始，若应用无法启动或长时间未启动，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/fault-log-extension-app-events-arkts">使用FaultLogExtensionAbility订阅事件</a>回调重写的函数，进行延迟上报。</p>     <p><strong>应用主动捕获崩溃异常场景</strong></p>     <p>若应用主动捕获崩溃异常，HiAppEvent事件将在<strong>应用退出前</strong>触发回调，例如：</p>     <ol>      <li>       <p>异常处理中未主动退出的应用崩溃后不会退出。</p>       <p>采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-errormanager#errormanageronerror" target="_blank">errorManger.on</a>方法捕获异常会导致JsError类型的崩溃事件在应用退出前触发回调。若应用注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cppcrash-guidelines#系统处理的崩溃信号">崩溃信号</a>处理函数但未主动退出，会导致NativeCrash类型的崩溃事件在应用退出前触发回调。</p></li>      <li>       <p>异常处理耗时过长，会导致应用退出延迟。</p></li>     </ol>     <p>在开发调试阶段，HiAppEvent上报事件完成回调后，可在DevEco Studio的HiLog窗口查看订阅的崩溃事件内容。</p>     <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent eventInfo.domain=OS</li><li>HiAppEvent eventInfo.name=APP_CRASH</li><li>HiAppEvent eventInfo.eventType=1</li><li>HiAppEvent eventInfo.params.time=1502032265088</li><li>HiAppEvent eventInfo.params.crash_type=JsError</li><li>HiAppEvent eventInfo.params.foreground=1</li><li>HiAppEvent eventInfo.params.bundle_version=1.0.0</li><li>HiAppEvent eventInfo.params.bundle_name=com.example.myapplication</li><li>HiAppEvent eventInfo.params.pid=19237</li><li>HiAppEvent eventInfo.params.uid=20010043</li><li>HiAppEvent eventInfo.params.uuid=cc0f062e1b28c1fd2c817fafab5e8ca3207925b4bdd87c43ed23c60029659e01</li><li>HiAppEvent eventInfo.params.exception={"message":"Unexpected Text in JSON","name":"SyntaxError","stack":"at anonymous (entry/src/main/ets/pages/Index.ets:16:11)"}</li><li>HiAppEvent eventInfo.params.hilog.size=110</li><li>HiAppEvent eventInfo.params.external_log=["/data/storage/el2/log/hiappevent/APP_CRASH_1502032265211_19237.log"]</li><li>HiAppEvent eventInfo.params.log_over_limit=0</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="移除并销毁事件观察者">移除并销毁事件观察者<i class="anchor-icon anchor-icon-link" anchorid="移除并销毁事件观察者" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>移除事件观察者。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>static napi_value <span class="hljs-built_in">RemoveWatcher</span>(napi_env env, napi_callback_info info) {</li><li>    <span class="hljs-comment">// 使观察者停止监听事件</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_RemoveWatcher</span>(systemEventWatcher);</li><li>    return {};</li><li>}</li></ol></pre></div></div></li>      <li>       <p>销毁事件观察者。</p>       <div _ngcontent-fxh-c106="" class="highlight-div"><div _ngcontent-fxh-c106="" class="highlight-div-header"><div _ngcontent-fxh-c106="" class="highlight-div-header-left"><div _ngcontent-fxh-c106="" class="handle-button expand-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fxh-c106="" class="highlight-div-header-right"><div _ngcontent-fxh-c106="" class="handle-button ai-button"></div><div _ngcontent-fxh-c106="" class="handle-button line-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fxh-c106="" class="handle-button theme-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fxh-c106="" class="handle-button copy-button"><div _ngcontent-fxh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fxh-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">DestroyWatcher</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// 销毁创建的观察者，并置systemEventWatcher为nullptr。</span></li><li>    <span class="hljs-built_in">OH_HiAppEvent_DestroyWatcher</span>(systemEventWatcher);</li><li>    systemEventWatcher = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>