<h1 _ngcontent-gjc-c119="" class="doc-title ng-star-inserted" title="订阅应用终止事件（ArkTS）"> 订阅应用终止事件（ArkTS） </h1>

<div _ngcontent-gjc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="应用终止事件规格说明">应用终止事件规格说明<i class="anchor-icon anchor-icon-link" anchorid="应用终止事件规格说明" tips="复制节点链接"></i></h2>          <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-app-killed-events">应用终止事件介绍</a>。</p>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">HiAppEvent</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.1" valign="top" width="50%">接口名</th>         <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">addWatcher(watcher: Watcher): AppEventPackageHolder</td>         <td class="cellrowborder" valign="top" width="50%">添加应用事件观察者，以添加对应用事件的订阅。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">removeWatcher(watcher: Watcher): void</td>         <td class="cellrowborder" valign="top" width="50%">移除应用事件观察者，以移除对应用事件的订阅。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>为确保开发阶段顺利接收事件回调，建议采用以下方案：创建新的Native C++工程，在ArkTs代码中实现订阅，搭配C++代码的故障注入代码构造故障以触发应用终止事件。</p>     <ol>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，导入依赖模块：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiAppEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，在onCreate函数中添加系统事件的订阅，示例代码如下：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>  <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>  <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了应用终止事件</span></li><li>  <span class="hljs-attr">appEventFilters</span>: [</li><li>    {</li><li>      <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>      <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_KILLED</span>]</li><li>    }</li><li>  ],</li><li>  <span class="hljs-comment">// 开发者可以自行实现订阅实时回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>  <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>      <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>        <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.domain=<span class="hljs-subst">${eventInfo.domain}</span>`</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.name=<span class="hljs-subst">${eventInfo.name}</span>`</span>);</li><li>        <span class="hljs-comment">// 开发者可以获取到应用终止事件发生的时间戳</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.time=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'time'</span>]}</span>`</span>);</li><li>        <span class="hljs-comment">// 开发者可以获取到应用的前后台状态</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.foreground=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'foreground'</span>]}</span>`</span>);</li><li>        <span class="hljs-comment">// 开发者可以获取到应用终止事件发生的原因</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo.params.reason=<span class="hljs-subst">${eventInfo.params[<span class="hljs-string">'reason'</span>]}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>});</li></ol></pre></div></div></li>      <li>       <p>以下为故障注入功能，需要使用C++代码实现，编辑"napi_init.cpp"，新增以下代码：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">NativeLeak</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> leak_size_per_time = <span class="hljs-number">500000</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {</li><li>        <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(leak_size_per_time + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-keyword">if</span> (!p) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-built_in">memset</span>(p, <span class="hljs-string">'a'</span>, leak_size_per_time);</li><li>        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">10</span>));</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Leak</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(NativeLeak)</span></span>;</li><li>    t1.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编辑"napi_init.cpp"文件，将Leak注册为ArkTS接口：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"leak"</span>, <span class="hljs-literal">nullptr</span>, Leak, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }, <span class="hljs-comment">// 新增这行</span></li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>编辑"index.d.ts"文件，定义ArkTS接口：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">leak</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre></div></div></li>      <li>       <p>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，在build下增加OnClick功能，并调用Leak接口的示例代码：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Start To Leak'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> != <span class="hljs-string">'Leaking'</span>) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Leaking'</span>;</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Start leaking'</span>);</li><li>              testNapi.<span class="hljs-title function_">leak</span>();</li><li>            }</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>点击DevEco Studio界面中的运行按钮，运行应用工程，点击屏幕中间的“Start To Leak”按钮，等待2-3分钟，待触发RssThresholdKiller类型的管控终止。</p></li>      <li>       <p>应用被终止后，重新打开应用，会触发终止事件上报，系统会回调应用的onReceive函数，可以在Log窗口看到对系统事件数据的处理日志。</p>       <p>应用终止事件采样栈示例：</p>       <div _ngcontent-gjc-c106="" class="highlight-div"><div _ngcontent-gjc-c106="" class="highlight-div-header"><div _ngcontent-gjc-c106="" class="highlight-div-header-left"><div _ngcontent-gjc-c106="" class="handle-button expand-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gjc-c106="" class="highlight-div-header-right"><div _ngcontent-gjc-c106="" class="handle-button ai-button"></div><div _ngcontent-gjc-c106="" class="handle-button line-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gjc-c106="" class="handle-button theme-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gjc-c106="" class="handle-button copy-button"><div _ngcontent-gjc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gjc-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>HiAppEvent eventInfo.domain=OS</li><li>HiAppEvent eventInfo.name=APP_KILLED</li><li>HiAppEvent eventInfo.params.time=1717597063727</li><li>HiAppEvent eventInfo.params.reason="RssThresholdKiller"</li><li>HiAppEvent eventInfo.params.foreground=true</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>