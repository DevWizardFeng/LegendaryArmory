<h1 _ngcontent-kpg-c119="" class="doc-title ng-star-inserted" title="订阅音频卡顿事件（ArkTS）"> 订阅音频卡顿事件（ArkTS） </h1>

<div _ngcontent-kpg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section14952204401813">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section14952204401813" tips="复制节点链接"></i></h2><p>API接口的具体使用说明（参数使用限制、具体取值范围等）请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@ohos.hiviewdfx.hiAppEvent (应用事件打点)ArkTS API文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>addWatcher(watcher: Watcher): AppEventPackageHolder</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>添加应用事件观察者，以添加对应用事件的订阅。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>removeWatcher(watcher: Watcher): void</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>移除应用事件观察者，以移除对应用事件的订阅。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section20245185961814">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section20245185961814" tips="复制节点链接"></i></h2><p>以实现对应用音频播放触发丢帧生成的音频卡顿事件订阅为例，说明开发步骤。</p> <ol><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; entryability &gt; EntryAbility.ets”文件，在onCreate函数中添加系统事件的订阅。<div _ngcontent-kpg-c106="" class="highlight-div"><div _ngcontent-kpg-c106="" class="highlight-div-header"><div _ngcontent-kpg-c106="" class="highlight-div-header-left"><div _ngcontent-kpg-c106="" class="handle-button expand-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpg-c106="" class="highlight-div-header-right"><div _ngcontent-kpg-c106="" class="handle-button ai-button"></div><div _ngcontent-kpg-c106="" class="handle-button line-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpg-c106="" class="handle-button theme-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpg-c106="" class="handle-button copy-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpg-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>hiAppEvent.<span class="hljs-title function_">addWatcher</span>({</li><li>   <span class="hljs-comment">// 开发者可以自定义观察者名称，系统会使用名称来标识不同的观察者</span></li><li>   <span class="hljs-attr">name</span>: <span class="hljs-string">"watcher"</span>,</li><li>   <span class="hljs-comment">// 开发者可以订阅感兴趣的系统事件，此处是订阅了应用音频卡顿事件</span></li><li>   <span class="hljs-attr">appEventFilters</span>: [</li><li>     {</li><li>       <span class="hljs-attr">domain</span>: hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>,</li><li>       <span class="hljs-attr">names</span>: [hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">AUDIO_JANK_FRAME</span>]</li><li>     }</li><li>   ],</li><li>   <span class="hljs-comment">// 开发者可以自行实现订阅实时回调函数，以便对订阅获取到的事件数据进行自定义处理</span></li><li>   <span class="hljs-attr">onReceive</span>: <span class="hljs-function">(<span class="hljs-params">domain: <span class="hljs-built_in">string</span>, appEventGroups: <span class="hljs-built_in">Array</span>&lt;hiAppEvent.AppEventGroup&gt;</span>) =&gt;</span> {</li><li>     hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent onReceive: domain=<span class="hljs-subst">${domain}</span>`</span>);</li><li>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventGroup <span class="hljs-keyword">of</span> appEventGroups) {</li><li>       <span class="hljs-comment">// 开发者可以根据事件集合中的事件名称区分不同的系统事件</span></li><li>       hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventName=<span class="hljs-subst">${eventGroup.name}</span>`</span>);</li><li>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> eventInfo <span class="hljs-keyword">of</span> eventGroup.<span class="hljs-property">appEventInfos</span>) {</li><li>         <span class="hljs-comment">// 开发者可以对事件集合中的事件数据进行自定义处理，此处是将事件数据打印在日志中</span></li><li>         hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent eventInfo=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(eventInfo)}</span>`</span>);</li><li>       }</li><li>     }</li><li>   }</li><li> });</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加一个模拟写入音频数据的回调函数normalCallback，在该回调中模拟卡顿主动返回INVALID（不送数据）来触发卡顿故障事件。<div _ngcontent-kpg-c106="" class="highlight-div"><div _ngcontent-kpg-c106="" class="highlight-div-header"><div _ngcontent-kpg-c106="" class="highlight-div-header-left"><div _ngcontent-kpg-c106="" class="handle-button expand-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpg-c106="" class="highlight-div-header-right"><div _ngcontent-kpg-c106="" class="handle-button ai-button"></div><div _ngcontent-kpg-c106="" class="handle-button line-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpg-c106="" class="handle-button theme-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpg-c106="" class="handle-button copy-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> g_invalidCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalCallback</span>(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (g_invalidCount &gt; <span class="hljs-number">0</span>) {</li><li>    g_invalidCount--;</li><li>    <span class="hljs-keyword">return</span> audio.<span class="hljs-property">AudioDataCallbackResult</span>.<span class="hljs-property">INVALID</span>;</li><li>  }</li><li>  <span class="hljs-comment">//在此添加写数据逻辑</span></li><li>  <span class="hljs-keyword">return</span> audio.<span class="hljs-property">AudioDataCallbackResult</span>.<span class="hljs-property">VALID</span>;</li><li>}</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加一个卡顿触发按钮，改变INVALID返回次数，模拟相应音频卡顿。<div _ngcontent-kpg-c106="" class="highlight-div"><div _ngcontent-kpg-c106="" class="highlight-div-header"><div _ngcontent-kpg-c106="" class="highlight-div-header-left"><div _ngcontent-kpg-c106="" class="handle-button expand-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpg-c106="" class="highlight-div-header-right"><div _ngcontent-kpg-c106="" class="handle-button ai-button"></div><div _ngcontent-kpg-c106="" class="handle-button line-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpg-c106="" class="handle-button theme-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpg-c106="" class="handle-button copy-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li>Row() {</li><li>  Button(<span class="hljs-string">"卡顿"</span>).onClick(<span class="hljs-keyword">async</span> () =&gt; {</li><li>    g_invalidCount = <span class="hljs-number">30</span>;</li><li>  })</li><li>}</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，在创建AudioRender实例时，进行耗时操作回调<div _ngcontent-kpg-c106="" class="highlight-div"><div _ngcontent-kpg-c106="" class="highlight-div-header"><div _ngcontent-kpg-c106="" class="highlight-div-header-left"><div _ngcontent-kpg-c106="" class="handle-button expand-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpg-c106="" class="highlight-div-header-right"><div _ngcontent-kpg-c106="" class="handle-button ai-button"></div><div _ngcontent-kpg-c106="" class="handle-button line-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpg-c106="" class="handle-button theme-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpg-c106="" class="handle-button copy-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>audio.<span class="hljs-title function_">createAudioRenderer</span>(audioRendererOptions, <span class="hljs-function">(<span class="hljs-params">err, renderer</span>) =&gt;</span> { <span class="hljs-comment">// 创建AudioRenderer实例</span></li><li>  <span class="hljs-keyword">if</span> (!err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: creating AudioRenderer success`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span> = renderer;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span> !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'writeData'</span>, normalCallback);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: creating AudioRenderer failed, error: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>});</li></ol></pre></div></div> </li><li>AudioRender正常播放时，点击卡顿按钮，即可触发耗时回调，触发音频卡顿事件。</li><li>每次音频卡顿触发后，可以在Log窗口看到对系统事件数据的处理日志。<div _ngcontent-kpg-c106="" class="highlight-div"><div _ngcontent-kpg-c106="" class="highlight-div-header"><div _ngcontent-kpg-c106="" class="highlight-div-header-left"><div _ngcontent-kpg-c106="" class="handle-button expand-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpg-c106="" class="highlight-div-header-right"><div _ngcontent-kpg-c106="" class="handle-button ai-button"></div><div _ngcontent-kpg-c106="" class="handle-button line-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpg-c106="" class="handle-button theme-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpg-c106="" class="handle-button copy-button"><div _ngcontent-kpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">08</span>-<span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">08.827</span>   <span class="hljs-number">41672</span>-<span class="hljs-number">41672</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">onReceive555</span>: <span class="hljs-title class_">domain</span>=<span class="hljs-variable">OS</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">08.827</span>   <span class="hljs-number">41672</span>-<span class="hljs-number">41672</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventName</span>=<span class="hljs-variable">AUDIO_JANK_FRAME</span></li><li><span class="hljs-number">08</span>-<span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">06</span>:<span class="hljs-number">08.827</span>   <span class="hljs-number">41672</span>-<span class="hljs-number">41672</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>={<span class="hljs-string">"domain"</span>:<span class="hljs-string">"OS"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"AUDIO_JANK_FRAME"</span>,<span class="hljs-string">"eventType"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"bundle_name"</span>:<span class="hljs-string">"com.samples.audio"</span>,<span class="hljs-string">"bundle_version"</span>:<span class="hljs-string">"1.0.0"</span>,<span class="hljs-string">"fault_type"</span>:<span class="hljs-string">"application"</span>,<span class="hljs-string">"happen_time"</span>:<span class="hljs-number">3240511783</span>,<span class="hljs-string">"max_frame_time"</span>:<span class="hljs-number">260</span>,<span class="hljs-string">"process_name"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"time"</span>:<span class="hljs-number">1755587168818</span>}}</li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>