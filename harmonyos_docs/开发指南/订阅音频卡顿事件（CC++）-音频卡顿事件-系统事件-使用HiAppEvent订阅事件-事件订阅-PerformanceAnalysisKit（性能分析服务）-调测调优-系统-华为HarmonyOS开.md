<h1 _ngcontent-kpn-c119="" class="doc-title ng-star-inserted" title="订阅音频卡顿事件（C/C++）"> 订阅音频卡顿事件（C/C++） </h1>

<div _ngcontent-kpn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section3680125943018">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section3680125943018" tips="复制节点链接"></i></h2><p>本文介绍如何使用HiAppEvent提供的C/C++接口订阅音频卡顿事件。详细使用说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hiappevent-h" target="_blank">HiAppEvent C API文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="50%"><p>接口名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>int OH_HiAppEvent_AddWatcher(HiAppEvent_Watcher *watcher)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>添加应用事件观察者，以添加对应用事件的订阅。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>int OH_HiAppEvent_RemoveWatcher(HiAppEvent_Watcher *watcher)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>移除应用事件观察者，以移除对应用事件的订阅。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section172267326311">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section172267326311" tips="复制节点链接"></i></h2><ol><li>获取示例工程的依赖项jsoncpp。<p>参考<a href="https://github.com/open-source-parsers/jsoncpp" target="_blank">三方开源库jsoncpp代码仓</a>README中<strong>Amalgamated source</strong>部分，获取jsoncpp.cpp、json.h和json-forwards.h三个文件。</p> </li><li>新建Native C++工程，并将上述文件导入到新建工程，目录结构如下。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">entry:</span></li><li>  <span class="hljs-attr">src:</span></li><li>    <span class="hljs-attr">main:</span></li><li>      <span class="hljs-attr">cpp:</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">json.h</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">json-forwards.h</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">types:</span></li><li>            <span class="hljs-attr">libentry:</span></li><li>              <span class="hljs-bullet">-</span> <span class="hljs-string">index.d.ts</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">CMakeLists.txt</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">napi_init.cpp</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-string">jsoncpp.cpp</span></li><li>      <span class="hljs-attr">ets:</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">entryability:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">EntryAbility.ets</span></li><li>        <span class="hljs-bullet">-</span> <span class="hljs-attr">pages:</span></li><li>            <span class="hljs-bullet">-</span> <span class="hljs-string">Index.ets</span></li></ol></pre></div></div> </li><li>在“CMakeLists.txt”文件中，添加源文件和动态库。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># 新增jsoncpp<span class="hljs-selector-class">.cpp</span>(解析订阅事件中的json字符串)源文件</li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp jsoncpp.cpp)</li><li># 新增动态库依赖libhiappevent_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>和libhilog_ndk<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span>(日志输出)</li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libhiappevent_ndk.z.so)</li></ol></pre></div></div> </li><li>在“napi_init.cpp”文件中，导入依赖文件，并定义LOG_TAG。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">include</span></span></span><span class="hljs-meta"> </span><span class=""><span class="hljs-meta"><span class="hljs-string">"napi/native_api.h"</span></span></span></li><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">include</span></span></span><span class="hljs-meta"> </span><span class=""><span class="hljs-meta"><span class="hljs-string">"json/json.h"</span></span></span></li><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">include</span></span></span><span class="hljs-meta"> </span><span class=""><span class="hljs-meta"><span class="hljs-string">"hilog/log.h"</span></span></span></li><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">include</span></span></span><span class="hljs-meta"> </span><span class=""><span class="hljs-meta"><span class="hljs-string">"hiappevent/hiappevent.h"</span></span></span></li><li>
</li><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">undef</span></span></span><span class="hljs-meta"> LOG_TAG</span></li><li><span class="hljs-meta">#</span><span class=""><span class="hljs-meta"><span class="hljs-keyword">define</span></span></span><span class="hljs-meta"> LOG_TAG </span><span class=""><span class="hljs-meta"><span class="hljs-string">"testTag"</span></span></span></li></ol></pre></div></div> </li><li>订阅系统事件。<ul><li>onReceive类型观察者<div class="p">在“napi_init.cpp”文件中，定义onReceive类型观察者的方法：<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">//</span></span><span class=""><span class="hljs-comment">定义变量，用来缓存创建的观察者的指针。</span></span></li><li><span class=""><span class="hljs-keyword">static</span> </span><span class="hljs-variable">HiAppEvent_Watcher</span> *<span class="hljs-variable">systemEventWatcher</span><span class="">; </span></li><li>
</li><li><span class=""><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> </span><span class=""><span class="hljs-title function_">OnReceive</span></span><span class="">(</span><span class=""><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> </span>*<span class="hljs-variable">domain</span><span class="">, <span class="hljs-keyword">const</span> <span class="hljs-variable">struct</span> </span><span class="hljs-variable">HiAppEvent_AppEventGroup</span> *<span class="hljs-variable">appEventGroups</span><span class="">, </span><span class="hljs-variable">uint32_t</span> <span class="hljs-variable">groupLen</span><span class="">) {</span></li><li>    <span class=""><span class="hljs-keyword">for</span> </span><span class="">(</span><span class=""><span class="hljs-variable">int</span> </span><span class="hljs-variable">i</span> = <span class=""><span class="hljs-number">0</span></span><span class="">; </span><span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">groupLen</span><span class="">; </span>++<span class="hljs-title class_">i</span><span class="">) </span><span class="">{</span></li><li>        <span class=""><span class="hljs-keyword">for</span> </span><span class="">(</span><span class=""><span class="hljs-variable">int</span> </span><span class="hljs-variable">j</span> = <span class=""><span class="hljs-number">0</span></span><span class="">; </span><span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">appEventGroups</span><span class="">[</span><span class="hljs-title class_">i</span><span class="">]</span>.<span class=""><span class="hljs-title class_">infoLen</span></span><span class="">; </span>++<span class="hljs-title class_">j</span><span class="">) </span><span class="">{</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-variable">domain</span></span><span class="">)</span><span class="">;</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-variable">name</span></span><span class="">)</span><span class="">;</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span></span><span class="">, </span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-keyword">type</span></span><span class="">)</span><span class="">;</span></li><li><span class="">            <span class="hljs-keyword">if</span> </span><span class="">(</span><span class=""><span class="hljs-title function_">strcmp</span></span><span class="">(</span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-variable">domain</span></span><span class="">, </span><span class=""><span class="hljs-variable">DOMAIN_OS</span></span><span class="">) </span>== <span class=""><span class="hljs-number">0</span> </span>&amp;&amp; </li><li>                <span class=""><span class="hljs-title function_">strcmp</span></span><span class="">(</span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-variable">name</span></span><span class="">, </span><span class=""><span class="hljs-variable">EVENT_AUDIO_JANK_FRAME</span></span><span class="">) </span>== <span class=""><span class="hljs-number">0</span></span><span class="">) </span><span class="">{</span></li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Value</span> <span class="hljs-title class_">params</span><span class="">;</span></li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Reader</span> <span class="hljs-title class_">reader</span><span class="">(</span><span class="hljs-variable">Json</span>::<span class="hljs-variable">Features</span>::<span class=""><span class="hljs-title class_">strictMode</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                <span class="hljs-variable">Json</span>::<span class="hljs-title class_">FastWriter</span> <span class="hljs-title class_">writer</span><span class="">;</span></li><li><span class="">                <span class="hljs-keyword">if</span> </span><span class="">(</span><span class="hljs-variable">reader</span>.<span class=""><span class="hljs-title function_">parse</span></span><span class="">(</span><span class="hljs-variable">appEventGroups</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span>.<span class=""><span class="hljs-variable">appEventInfos</span></span><span class="">[</span><span class="hljs-variable">j</span><span class="">]</span>.<span class=""><span class="hljs-variable">params</span></span><span class="">, </span><span class="hljs-variable">params</span><span class="">)</span><span class="">) </span><span class="">{</span></li><li>                    <span class=""><span class="hljs-variable">auto</span> </span><span class="hljs-variable">time</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                    <span class="hljs-variable">auto</span> </span><span class="hljs-variable">bundleVersion</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"bundle_version"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                    <span class="hljs-variable">auto</span> </span><span class="hljs-variable">bundleName</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"bundle_name"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                    <span class="hljs-variable">auto</span> </span><span class="hljs-variable">faultType</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"fault_type"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                    <span class="hljs-variable">auto</span> </span><span class="hljs-variable">happenTime</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"happen_time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                    <span class="hljs-variable">auto</span> </span><span class="hljs-variable">maxFrameTime</span> = <span class="hljs-variable">params</span><span class="">[</span><span class=""><span class="hljs-string">"max_frame_time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li>                    </li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">time</span><span class="">)</span><span class="">;</span></li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.bundle_version=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">bundleVersion</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.bundle_name=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">bundleName</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.fault_type=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">faultType</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.happen_time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">happenTime</span><span class="">)</span><span class="">;</span></li><li>                    <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.max_frame_time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">maxFrameTime</span><span class="">)</span><span class="">;</span></li><li>                <span class="">}</span></li><li>            <span class="">}</span></li><li>        <span class="">}</span></li><li>    <span class="">}</span></li><li><span class="">}</span></li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">RegisterWatcher</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-comment">// 开发者自定义观察者名称，系统根据观察者名称名称识别不同的观察者。</span></li><li>    <span class="hljs-variable">systemEventWatcher</span> = <span class="hljs-title function_">OH_HiAppEvent_CreateWatcher</span>(<span class="hljs-string">"onReceiverWatcher"</span>);</li><li>    <span class="hljs-comment">// 订阅的事件为AUDIO_JANK_FRAME。</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">names</span>[] = {<span class="hljs-variable">EVENT_AUDIO_JANK_FRAME</span>};</li><li>    <span class="hljs-comment">// 此处开发者订阅了系统事件AUDIO_JANK_FRAME。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetAppEventFilter</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">DOMAIN_OS</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">names</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// 开发者通过调用OH_HiAppEvent_SetWatcherOnReceive函数设置已实现的回调函数，观察者接收到事件后会触发OnReceive回调。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_SetWatcherOnReceive</span>(<span class="hljs-variable">systemEventWatcher</span>, <span class="hljs-variable">OnReceive</span>);</li><li>    <span class="hljs-comment">// 启动观察者以监听事件。</span></li><li>    <span class="hljs-title function_">OH_HiAppEvent_AddWatcher</span>(<span class="hljs-variable">systemEventWatcher</span>);</li><li>    <span class="hljs-keyword">return</span> {};</li><li>}</li></ol></pre></div></div> </div> </li><li>onTrigger类型观察者<p>在“napi_init.cpp”文件中，定义OnTrigger类型观察者：</p> <div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者可以自行实现获取已监听到事件的回调函数，其中</span></span><span class=""><span class="hljs-comment">events</span></span><span class=""><span class="hljs-comment">指针指向内容仅在该函数内有效。</span></span></li><li><span class=""><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> </span><span class=""><span class="hljs-title function_">OnTake</span></span><span class="">(</span><span class=""><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> </span>*<span class=""><span class="hljs-keyword">const</span> </span>*<span class="hljs-variable">events</span><span class="">, </span><span class="hljs-variable">uint32_t</span> <span class="hljs-variable">eventLen</span><span class="">) {</span></li><li>    <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Reader</span> <span class="hljs-title class_">reader</span><span class="">(</span><span class="hljs-variable">Json</span>::<span class="hljs-variable">Features</span>::<span class=""><span class="hljs-title class_">strictMode</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>    <span class="hljs-variable">Json</span>::<span class="hljs-title class_">FastWriter</span> <span class="hljs-title class_">writer</span><span class="">;</span></li><li><span class="">    <span class="hljs-keyword">for</span> </span><span class="">(</span><span class=""><span class="hljs-variable">int</span> </span><span class="hljs-variable">i</span> = <span class=""><span class="hljs-number">0</span></span><span class="">; </span><span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">eventLen</span><span class="">; </span>++<span class="hljs-title class_">i</span><span class="">) </span><span class="">{</span></li><li>        <span class="hljs-variable">Json</span>::<span class="hljs-title class_">Value</span> <span class="hljs-title class_">eventInfo</span><span class="">;</span></li><li><span class="">        <span class="hljs-keyword">if</span> </span><span class="">(</span><span class="hljs-variable">reader</span>.<span class=""><span class="hljs-title function_">parse</span></span><span class="">(</span><span class="hljs-variable">events</span><span class="">[</span><span class="hljs-variable">i</span><span class="">]</span><span class="">, </span><span class="hljs-variable">eventInfo</span><span class="">)</span><span class="">) </span><span class="">{</span></li><li>            <span class=""><span class="hljs-variable">auto</span> </span><span class="hljs-variable">domain</span> =  <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"domain_"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">            <span class="hljs-variable">auto</span> </span><span class="hljs-variable">name</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"name_"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">            <span class="hljs-variable">auto</span> </span><span class="hljs-keyword">type</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"type_"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt</span></span><span class="">()</span><span class="">;</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.domain=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">domain</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.name=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">name</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>            <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.eventType=%{public}d"</span></span><span class="">, </span><span class="hljs-keyword">type</span><span class="">)</span><span class="">;</span></li><li><span class="">            <span class="hljs-keyword">if</span> </span><span class="">(</span><span class="hljs-variable">domain</span> ==  <span class=""><span class="hljs-variable">DOMAIN_OS</span> </span>&amp;&amp; <span class="hljs-variable">name</span> == <span class=""><span class="hljs-variable">EVENT_AUDIO_JANK_FRAME</span></span><span class="">) </span><span class="">{</span></li><li>                <span class=""><span class="hljs-variable">auto</span> </span><span class="hljs-variable">time</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                <span class="hljs-variable">auto</span> </span><span class="hljs-variable">bundleVersion</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"bundle_version"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                <span class="hljs-variable">auto</span> </span><span class="hljs-variable">bundleName</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"bundle_name"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                <span class="hljs-variable">auto</span> </span><span class="hljs-variable">faultType</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"fault_type"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asString</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                <span class="hljs-variable">auto</span> </span><span class="hljs-variable">happenTime</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"happen_time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li><span class="">                <span class="hljs-variable">auto</span> </span><span class="hljs-variable">maxFrameTime</span> = <span class="hljs-variable">eventInfo</span><span class="">[</span><span class=""><span class="hljs-string">"max_frame_time"</span></span><span class="">]</span>.<span class=""><span class="hljs-title function_">asInt64</span></span><span class="">()</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">time</span><span class="">)</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.bundle_version=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">bundleVersion</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.bundle_name=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">bundleName</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.fault_type=%{public}s"</span></span><span class="">, </span><span class="hljs-variable">faultType</span>.<span class=""><span class="hljs-title function_">c_str</span></span><span class="">()</span><span class="">)</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.happen_time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">happenTime</span><span class="">)</span><span class="">;</span></li><li>                <span class=""><span class="hljs-title function_">OH_LOG_INFO</span></span><span class="">(</span><span class="hljs-variable">LogType</span>::<span class=""><span class="hljs-title class_">LOG_APP</span></span><span class="">, </span><span class=""><span class="hljs-string">"HiAppEvent eventInfo.params.max_frame_time=%{public}ld"</span></span><span class="">, </span><span class="hljs-variable">maxFrameTime</span><span class="">)</span><span class="">;</span></li><li>            <span class="">}</span></li><li>        <span class="">}</span></li><li>    <span class="">}</span></li><li><span class="">}</span></li><li>
</li><li><span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者可以自行实现订阅回调函数，以便对获取到的事件打点数据进行自定义处理。</span></span></li><li><span class=""><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> </span><span class=""><span class="hljs-title function_">OnTrigger</span></span><span class="">(</span><span class=""><span class="hljs-variable">int</span> </span><span class="hljs-variable">row</span><span class="">, <span class="hljs-variable">int</span> </span><span class="hljs-variable">size</span><span class="">) {</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">接收回调后，获取指定数量的已接收事件。</span></span></li><li>    <span class=""><span class="hljs-title function_">OH_HiAppEvent_TakeWatcherData</span></span><span class="">(</span><span class="hljs-variable">systemEventWatcher</span><span class="">, </span><span class="hljs-variable">row</span><span class="">, </span><span class=""><span class="hljs-variable">OnTake</span></span><span class="">)</span><span class="">;</span></li><li><span class="">}</span></li><li>
</li><li><span class=""><span class="hljs-keyword">static</span> </span><span class="hljs-variable">napi_value</span> <span class=""><span class="hljs-title function_">RegisterWatcher</span></span><span class="">(</span><span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span><span class="">, </span><span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span><span class="">) {</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者自定义观察者名称，系统根据不同的名称来识别不同的观察者。</span></span></li><li>    <span class="hljs-variable">systemEventWatcher</span> = <span class=""><span class="hljs-title function_">OH_HiAppEvent_CreateWatcher</span></span><span class="">(</span><span class=""><span class="hljs-string">"onTriggerWatcher"</span></span><span class="">)</span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">设置订阅的事件为</span></span><span class=""><span class="hljs-comment">EVENT_AUDIO_JANK_FRAME</span></span><span class=""><span class="hljs-comment">。</span></span></li><li>    <span class=""><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span> </span>*<span class="hljs-variable">names</span><span class="">[] </span>= <span class="">{</span><span class=""><span class="hljs-variable">EVENT_AUDIO_JANK_FRAME</span></span><span class="">}</span><span class="">;</span></li><li>    </li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者订阅感兴趣的事件，此处订阅了系统事件。</span></span></li><li>    <span class=""><span class="hljs-title function_">OH_HiAppEvent_SetAppEventFilter</span></span><span class="">(</span><span class="hljs-variable">systemEventWatcher</span><span class="">, </span><span class=""><span class="hljs-variable">DOMAIN_OS</span></span><span class="">, </span><span class=""><span class="hljs-number">0</span></span><span class="">, </span><span class="hljs-variable">names</span><span class="">, </span><span class=""><span class="hljs-number">1</span></span><span class="">)</span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者设置已实现的回调函数，需</span></span><span class=""><span class="hljs-comment">OH_HiAppEvent_SetTriggerCondition</span></span><span class=""><span class="hljs-comment">设置的条件满足方可触发。</span></span></li><li>    <span class=""><span class="hljs-title function_">OH_HiAppEvent_SetWatcherOnTrigger</span></span><span class="">(</span><span class="hljs-variable">systemEventWatcher</span><span class="">, </span><span class=""><span class="hljs-variable">OnTrigger</span></span><span class="">)</span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">开发者可以设置订阅触发回调的条件，此处是设置新增事件打点数量为</span></span><span class=""><span class="hljs-comment">1</span></span><span class=""><span class="hljs-comment">个时，触发</span></span><span class=""><span class="hljs-comment">onTrigger</span></span><span class=""><span class="hljs-comment">回调。</span></span></li><li>    <span class=""><span class="hljs-title function_">OH_HiAppEvent_SetTriggerCondition</span></span><span class="">(</span><span class="hljs-variable">systemEventWatcher</span><span class="">, </span><span class=""><span class="hljs-number">1</span></span><span class="">, </span><span class=""><span class="hljs-number">0</span></span><span class="">, </span><span class=""><span class="hljs-number">0</span></span><span class="">)</span><span class="">;</span></li><li>    <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">使观察者开始监听订阅的事件。</span></span></li><li>    <span class=""><span class="hljs-title function_">OH_HiAppEvent_AddWatcher</span></span><span class="">(</span><span class="hljs-variable">systemEventWatcher</span><span class="">)</span><span class="">;</span></li><li><span class="">    <span class="hljs-keyword">return</span> </span><span class="">{}</span><span class="">;</span></li><li><span class="">}</span></li></ol></pre></div></div> </li></ul> </li><li>将RegisterWatcher注册为ArkTS接口。<p>在“napi_init.cpp”文件中，将RegisterWatcher注册为ArkTS接口：</p> <div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"registerWatcher"</span>, <span class="hljs-literal">nullptr</span>, RegisterWatcher, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li><span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li><span class="hljs-keyword">return</span> exports;</li><li>}</li></ol></pre></div></div> <p>在“index.d.ts”文件中，定义ArkTS接口：</p> <div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">registerWatcher</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;</li></ol></pre></div></div> </li><li>在“EntryAbility.ets”文件的onCreate()函数中添加接口调用。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入依赖模块</span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-comment">// 在onCreate()函数中新增接口调用</span></li><li><span class="hljs-comment">// 启动时，注册系统事件观察者</span></li><li>testNapi.<span class="hljs-title function_">registerWatcher</span>();</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加一个模拟写入音频数据回调函数normalCallback，在该回调中模拟卡顿主动返回INVALID（不送数据）来触发卡顿故障事件。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> g_invalidCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalCallback</span>(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (g_invalidCount &gt; <span class="hljs-number">0</span>) {</li><li>    g_invalidCount--;</li><li>    <span class="hljs-keyword">return</span> audio.<span class="hljs-property">AudioDataCallbackResult</span>.<span class="hljs-property">INVALID</span>;</li><li>  }</li><li>  <span class="hljs-comment">//在此添加写数据逻辑</span></li><li>  <span class="hljs-keyword">return</span> audio.<span class="hljs-property">AudioDataCallbackResult</span>.<span class="hljs-property">VALID</span>;</li><li>}</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，添加一个卡顿触发按钮，改变INVALID返回次数，模拟相应音频卡顿。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li>Row() {</li><li>  Button(<span class="hljs-string">"卡顿"</span>).onClick(<span class="hljs-keyword">async</span> () =&gt; {</li><li>    g_invalidCount = <span class="hljs-number">30</span>;</li><li>  })</li><li>}</li></ol></pre></div></div> </li><li>编辑工程中的“entry &gt; src &gt; main &gt; ets &gt; pages &gt; Index.ets”文件，在创建AudioRender实例时，进行耗时操作回调<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>audio.<span class="hljs-title function_">createAudioRenderer</span>(audioRendererOptions, <span class="hljs-function">(<span class="hljs-params">err, renderer</span>) =&gt;</span> { <span class="hljs-comment">// 创建AudioRenderer实例</span></li><li>  <span class="hljs-keyword">if</span> (!err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: creating AudioRenderer success`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span> = renderer;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span> !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderModel</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'writeData'</span>, normalCallback);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${TAG}</span>: creating AudioRenderer failed, error: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>});</li></ol></pre></div></div> </li><li>AudioRender正常播放时，点击卡顿按钮，即可触发耗时回调，触发音频卡顿事件。</li><li>每次音频卡顿触发后，可以在Log窗口看到对系统事件数据的处理日志。<div _ngcontent-kpn-c106="" class="highlight-div"><div _ngcontent-kpn-c106="" class="highlight-div-header"><div _ngcontent-kpn-c106="" class="highlight-div-header-left"><div _ngcontent-kpn-c106="" class="handle-button expand-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kpn-c106="" class="highlight-div-header-right"><div _ngcontent-kpn-c106="" class="handle-button ai-button"></div><div _ngcontent-kpn-c106="" class="handle-button line-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kpn-c106="" class="handle-button theme-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kpn-c106="" class="handle-button copy-button"><div _ngcontent-kpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">domain</span>=<span class="hljs-variable">OS</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">name</span>=<span class="hljs-variable">AUDIO_JANK_FRAME</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">eventType</span>=<span class="hljs-number">1</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">time</span>=<span class="hljs-number">1762739184665</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">bundle_version</span>=<span class="hljs-number">1.0</span><span class="hljs-number">.0</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">bundle_name</span>=<span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">fault_type</span>=<span class="hljs-variable">application</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">happen_time</span>=<span class="hljs-number">176273918</span></li><li><span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">09</span>:<span class="hljs-number">46</span>:<span class="hljs-number">24.677</span>   <span class="hljs-number">49499</span>-<span class="hljs-number">49847</span>   <span class="hljs-title class_">A00000</span>/<span class="hljs-variable">com</span>.<span class="hljs-variable">sam</span>...<span class="hljs-variable">audio</span>/<span class="hljs-variable">testTag</span>  <span class="hljs-variable">com</span>.<span class="hljs-variable">samples</span>.<span class="hljs-variable">audio</span>     <span class="hljs-variable">I</span>     <span class="hljs-variable">HiAppEvent</span> <span class="hljs-variable">eventInfo</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">max_frame_time</span>=<span class="hljs-number">220</span></li></ol></pre></div></div> </li></ol> </div> </div> <div></div></div>