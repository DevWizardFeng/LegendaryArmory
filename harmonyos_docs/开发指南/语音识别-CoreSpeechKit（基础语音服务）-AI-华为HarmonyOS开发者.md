<h1 _ngcontent-xcw-c119="" class="doc-title ng-star-inserted" title="语音识别"> 语音识别 </h1>

<div _ngcontent-xcw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>将一段中文音频信息（中文、中文语境下的英文；短语音模式不超过60s，长语音模式不超过8h）转换为文本，音频信息可以为PCM音频文件或者实时语音。</p>    <div class="tiledSection">     <h2 id="section1384112112520">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1384112112520" tips="复制节点链接"></i></h2>          <p>手机/平板等设备在无网状态下，为听障人士或不方便收听音频场景提供音频转文本能力。</p>    </div>    <div class="tiledSection">     <h2 id="section2020122517405">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section2020122517405" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.1" valign="top" width="50%">          <p>AI能力</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.3.2.1.3.1.2" valign="top" width="50%">          <p>约束</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">          <p>语音识别</p></td>         <td class="cellrowborder" valign="top" width="50%">          <ul>           <li>支持的语种类型：中文普通话。</li>           <li>支持的模型类型：离线。</li>           <li>语音时长：短语音模式不超过60s，长语音模式不超过8h。</li>          </ul></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section174753641217">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section174753641217" tips="复制节点链接"></i></h2>          <ol>      <li><span>在使用语音识别时，将实现语音识别相关的类添加至工程。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { speechRecognizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreSpeechKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>       <p></p></li>      <li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section53411946183318" target="_blank">createEngine</a>方法，对引擎进行初始化，并创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section153101728203110" target="_blank">SpeechRecognitionEngine</a>实例。</span>       <p></p>       <p>createEngine方法提供了两种调用形式，当前以其中一种作为示例，其他方式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer" target="_blank">API参考</a>。</p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">asrEngine</span>: speechRecognizer.<span class="hljs-property">SpeechRecognitionEngine</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'123456'</span>;</li><li><span class="hljs-comment">// 创建引擎，通过callback形式返回</span></li><li><span class="hljs-comment">// 设置创建引擎参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">extraParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = {<span class="hljs-string">"locate"</span>: <span class="hljs-string">"CN"</span>, <span class="hljs-string">"recognizerMode"</span>: <span class="hljs-string">"short"</span>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">initParamsInfo</span>: speechRecognizer.<span class="hljs-property">CreateEngineParams</span> = {</li><li>  <span class="hljs-attr">language</span>: <span class="hljs-string">'zh-CN'</span>,</li><li>  <span class="hljs-attr">online</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-attr">extraParams</span>: extraParam</li><li>};</li><li><span class="hljs-comment">// 调用createEngine方法</span></li><li>speechRecognizer.<span class="hljs-title function_">createEngine</span>(initParamsInfo, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, speechRecognitionEngine: speechRecognizer.SpeechRecognitionEngine</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in creating engine.'</span>);</li><li>    <span class="hljs-comment">// 接收创建引擎的实例</span></li><li>    asrEngine = speechRecognitionEngine;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create engine. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>  }</li><li>});</li></ol></pre></div></div>       <p></p></li>      <li><span>得到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section153101728203110" target="_blank">SpeechRecognitionEngine</a>实例对象后，实例化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section845815011389" target="_blank">RecognitionListener</a>对象，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section1745872517348" target="_blank">setListener</a>方法设置回调，用来接收语音识别相关的回调信息。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建回调对象</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">setListener</span>: speechRecognizer.<span class="hljs-property">RecognitionListener</span> = {</li><li>  <span class="hljs-comment">// 开始识别成功回调</span></li><li>  <span class="hljs-title function_">onStart</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, eventMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onStart, sessionId: <span class="hljs-subst">${sessionId}</span> eventMessage: <span class="hljs-subst">${eventMessage}</span>`</span>);</li><li>  },</li><li>  <span class="hljs-comment">// 事件回调</span></li><li>  <span class="hljs-title function_">onEvent</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, eventCode: <span class="hljs-built_in">number</span>, eventMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onEvent, sessionId: <span class="hljs-subst">${sessionId}</span> eventCode: <span class="hljs-subst">${eventCode}</span> eventMessage: <span class="hljs-subst">${eventMessage}</span>`</span>);</li><li>  },</li><li>  <span class="hljs-comment">// 识别结果回调，包括中间结果和最终结果</span></li><li>  <span class="hljs-title function_">onResult</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, result: speechRecognizer.SpeechRecognitionResult</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onResult, sessionId: <span class="hljs-subst">${sessionId}</span> result: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);</li><li>  },</li><li>  <span class="hljs-comment">// 识别完成回调</span></li><li>  <span class="hljs-title function_">onComplete</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, eventMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onComplete, sessionId: <span class="hljs-subst">${sessionId}</span> eventMessage: <span class="hljs-subst">${eventMessage}</span>`</span>);</li><li>  },</li><li>  <span class="hljs-comment">// 错误回调，错误码通过本方法返回</span></li><li>  <span class="hljs-comment">// 返回错误码1002200002，开始识别失败，重复启动startListening方法时触发</span></li><li>  <span class="hljs-comment">// 更多错误码请参考</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-corespeech" target="_blank"><span class="hljs-comment">错误码参考</span></a></li><li>  <span class="hljs-title function_">onError</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span>, errorCode: <span class="hljs-built_in">number</span>, errorMessage: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onError, sessionId: <span class="hljs-subst">${sessionId}</span> errorCode: <span class="hljs-subst">${errorCode}</span> errorMessage: <span class="hljs-subst">${errorMessage}</span>`</span>);</li><li>  },</li><li>}</li><li><span class="hljs-comment">// 设置回调</span></li><li>asrEngine.<span class="hljs-title function_">setListener</span>(setListener);</li></ol></pre></div></div>       <p></p></li>      <li><span>分别为音频文件转文字和麦克风转文字功能设置开始识别的相关参数，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section140216144119" target="_blank">startListening</a>方法，开始识别。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">startListeningForRecording</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">audioParam</span>: speechRecognizer.<span class="hljs-property">AudioInfo</span> = { <span class="hljs-attr">audioType</span>: <span class="hljs-string">'pcm'</span>, <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span>, <span class="hljs-attr">soundChannel</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">sampleBit</span>: <span class="hljs-number">16</span> }<span class="hljs-comment">// audioInfo参数配置请参考</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section85771521101910" target="_blank"><span class="hljs-comment">AudioInfo</span></a></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">extraParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = {</li><li>    <span class="hljs-string">"recognitionMode"</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-string">"vadBegin"</span>: <span class="hljs-number">2000</span>,</li><li>    <span class="hljs-string">"vadEnd"</span>: <span class="hljs-number">3000</span>,</li><li>    <span class="hljs-string">"maxAudioDuration"</span>: <span class="hljs-number">20000</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">recognizerParams</span>: speechRecognizer.<span class="hljs-property">StartParams</span> = {</li><li>    <span class="hljs-attr">sessionId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,</li><li>    <span class="hljs-attr">audioInfo</span>: audioParam,</li><li>    <span class="hljs-attr">extraParams</span>: extraParam</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startListening start'</span>);</li><li>  asrEngine.<span class="hljs-title function_">startListening</span>(recognizerParams);</li><li>};</li></ol></pre></div></div>       <p></p></li>      <li><span>传入音频流，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section72131731149" target="_blank">writeAudio</a>方法，开始写入音频流。读取音频文件时，开发者需预先准备一个pcm格式音频文件。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>();</li><li><span class="hljs-comment">// 可以通过如下方式获取音频流：1、通过录音获取音频流；2、从音频文件中读取音频流</span></li><li><span class="hljs-comment">// 两种方式示例均已实现:</span><a class="typescript " href="#section56481271497"><span class="hljs-comment">demo参考</span></a></li><li><span class="hljs-comment">// 写入音频流，音频流长度仅支持640或1280</span></li><li>asrEngine.<span class="hljs-title function_">writeAudio</span>(sessionId, uint8Array);</li></ol></pre></div></div>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>1. 如需通过录音获取音频流，请打开麦克风权限，参考<a href="/consumer/cn/doc/harmonyos-guides/speechrecognizer-guide#li1723555443715">步骤10</a>配置相关权限。</p>         <p>2. 如需从音频文件中读取音频流，请在项目中的main\resources\resfile路径下存放pcm文件。</p>        </div></div></div>       <p></p></li>      <li><span>（可选）当需要查询语音识别服务支持的语种信息，可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section813761871119" target="_blank">listLanguages</a>方法。</span>       <p></p>       <div class="p">        listLanguages方法提供了两种调用形式，当前以其中一种作为示例，其他方式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer" target="_blank">API参考</a>。        <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置查询相关的参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">languageQuery</span>: speechRecognizer.<span class="hljs-property">LanguageQuery</span> = {</li><li>  <span class="hljs-attr">sessionId</span>: sessionId</li><li>};</li><li><span class="hljs-comment">// 调用listLanguages方法</span></li><li>asrEngine.<span class="hljs-title function_">listLanguages</span>(languageQuery).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in listing languages.`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to list languages. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>});</li></ol></pre></div></div>       </div>       <p></p></li>      <li><span>（可选）当需要结束识别时，可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section14433919171116" target="_blank">finish</a>方法。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 结束识别</span></li><li>asrEngine.<span class="hljs-title function_">finish</span>(sessionId);</li></ol></pre></div></div>       <p></p></li>      <li><span>（可选）当需要取消识别时，可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section3235541759" target="_blank">cancel</a>方法。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 取消识别</span></li><li>asrEngine.<span class="hljs-title function_">cancel</span>(sessionId);</li></ol></pre></div></div>       <p></p></li>      <li><span>（可选）当需要释放语音识别引擎资源时，可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section444415855615" target="_blank">shutdown</a>方法。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放识别引擎资源</span></li><li>asrEngine.<span class="hljs-title function_">shutdown</span>();</li></ol></pre></div></div>       <p></p></li>      <li id="li1723555443715"><span>需要在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file" target="_blank">module.json5配置文件</a>中添加ohos.permission.MICROPHONE权限，确保麦克风使用正常。详细步骤可查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>章节。</span>       <p></p>       <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span> : <span class="hljs-string">"ohos.permission.MICROPHONE"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:reason"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>:<span class="hljs-string">"inuse"</span></li><li>    }</li><li>  }</li><li>],</li><li><span class="hljs-comment">// ...</span></li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section56481271497">开发实例<i class="anchor-icon anchor-icon-link" anchorid="section56481271497" tips="复制节点链接"></i></h2>          <p>点击按钮，将一段音频信息转换为文本。</p>    </div>    <div class="tiledSection">     <h3 id="section76570131150" class="firsth2">Index.ets<i class="anchor-icon anchor-icon-link" anchorid="section76570131150" tips="复制节点链接"></i></h3>          <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">speechRecognizer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreSpeechKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">fileIo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">PromptAction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-package">FileCapturer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./FileCapturer'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span> = <span class="hljs-string">'AsrDemo'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">asrEngine</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">SpeechRecognitionEngine</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">createCount</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">voiceInfo</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"123456"</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sessionId2</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"1234567"</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">generatedText</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"Default Text"</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>()</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">promptAction</span>: <span class="hljs-title class_">PromptAction</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">getPromptAction</span>();</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">mFileCapturer</span>: <span class="hljs-title class_">FileCapturer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">FileCapturer</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Scroll</span>() {</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">Row</span>() {</li><li>            <span class="hljs-title function_">Column</span>() {</li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span>)</li><li>                .<span class="hljs-title function_">fontColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.color.ohos_id_color_text_secondary'</span>))</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">constraintSize</span>({ <span class="hljs-variable">minHeight</span>: <span class="hljs-number">100</span> })</li><li>            .<span class="hljs-title function_">border</span>({ <span class="hljs-variable">width</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">radius</span>: <span class="hljs-number">5</span> })</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#d3d3d3'</span>)</li><li>            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)</li><li>            .<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">Start</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">20</span>, <span class="hljs-variable">right</span>: <span class="hljs-number">20</span>, <span class="hljs-variable">top</span>: <span class="hljs-number">20</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>          <span class="hljs-title function_">Button</span>() {</li><li>            <span class="hljs-title function_">Text</span>(<span class="hljs-string">"CreateEngineByCallback"</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          }</li><li>          .<span class="hljs-keyword">type</span>(<span class="hljs-variable">ButtonType</span>.<span class="hljs-variable">Capsule</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#0x317AE7"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable">async</span> () =&gt; {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-title function_">createByCallback</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">createCount</span>++;</li><li>            <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">CreateAsrEngine</span>：<span class="hljs-variable">createCount</span>:${<span class="hljs-keyword">this</span>.<span class="hljs-variable">createCount</span>}`);</li><li>            <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">500</span>);</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setListener</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>              <span class="hljs-variable">message</span>: <span class="hljs-string">'CreateEngine succeeded!'</span>,</li><li>              <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>            });</li><li>          })</li><li>
</li><li>          <span class="hljs-title function_">Button</span>() {</li><li>            <span class="hljs-title function_">Text</span>(<span class="hljs-string">"startRecording"</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          }</li><li>          .<span class="hljs-keyword">type</span>(<span class="hljs-variable">ButtonType</span>.<span class="hljs-variable">Capsule</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#0x317AE7"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-title function_">startRecording</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>              <span class="hljs-variable">message</span>: <span class="hljs-string">'start Recording'</span>,</li><li>              <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>            });</li><li>          })</li><li>
</li><li>          <span class="hljs-title function_">Button</span>() {</li><li>            <span class="hljs-title function_">Text</span>(<span class="hljs-string">"audioToText"</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          }</li><li>          .<span class="hljs-keyword">type</span>(<span class="hljs-variable">ButtonType</span>.<span class="hljs-variable">Capsule</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#0x317AE7"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-title function_">audioToText</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>              <span class="hljs-variable">message</span>: <span class="hljs-string">'start audioToText'</span>,</li><li>              <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>            });</li><li>          })</li><li>
</li><li>          <span class="hljs-title function_">Button</span>() {</li><li>            <span class="hljs-title function_">Text</span>(<span class="hljs-string">"queryLanguagesCallback"</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          }</li><li>          .<span class="hljs-keyword">type</span>(<span class="hljs-variable">ButtonType</span>.<span class="hljs-variable">Capsule</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#0x317AE7"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-keyword">try</span>{</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">queryLanguagesCallback</span>();</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: <span class="hljs-string">'queryLanguages succeeded!'</span>,</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>              });</li><li>            } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">query</span> <span class="hljs-variable">language</span> <span class="hljs-variable">information</span>. <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: <span class="hljs-string">'queryLanguages failed!'</span>,</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>              });</li><li>            }</li><li>          })</li><li>
</li><li>          <span class="hljs-title function_">Button</span>() {</li><li>            <span class="hljs-title function_">Text</span>(<span class="hljs-string">"shutdown"</span>)</li><li>              .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          }</li><li>          .<span class="hljs-keyword">type</span>(<span class="hljs-variable">ButtonType</span>.<span class="hljs-variable">Capsule</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">"#0x317AA7"</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"80%"</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">margin</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-comment">// 释放引擎</span></li><li>            <span class="hljs-keyword">try</span>{</li><li>              <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">shutdown</span>();</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">The</span> <span class="hljs-variable">engine</span> <span class="hljs-variable">has</span> <span class="hljs-variable">been</span> <span class="hljs-variable">released</span>.`</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: <span class="hljs-string">'shutdown succeeded!'</span>,</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>              });</li><li>            } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">release</span> <span class="hljs-variable">engine</span>. <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">promptAction</span>.<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: <span class="hljs-string">'shutdown failed!'</span>,</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">2000</span></li><li>              });</li><li>            }</li><li>          })</li><li>        }</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// 创建引擎，通过callback形式返回</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">createByCallback</span>() {</li><li>    <span class="hljs-comment">// 设置创建引擎参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">extraParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt; = {<span class="hljs-string">"locate"</span>: <span class="hljs-string">"CN"</span>, <span class="hljs-string">"recognizerMode"</span>: <span class="hljs-string">"short"</span>};</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">initParamsInfo</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">CreateEngineParams</span> = {</li><li>      <span class="hljs-variable">language</span>: <span class="hljs-string">'zh-CN'</span>,</li><li>      <span class="hljs-variable">online</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-variable">extraParams</span>: <span class="hljs-title class_">extraParam</span></li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 调用createEngine方法</span></li><li>    <span class="hljs-variable">speechRecognizer</span>.<span class="hljs-title function_">createEngine</span>(<span class="hljs-variable">initParamsInfo</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">speechRecognitionEngine</span>:</li><li>      <span class="hljs-variable">speechRecognizer</span>.<span class="hljs-variable">SpeechRecognitionEngine</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable">err</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'succeeded in creating engine.'</span>);</li><li>        <span class="hljs-comment">// 接收创建引擎的实例</span></li><li>        <span class="hljs-variable">asrEngine</span> = <span class="hljs-variable">speechRecognitionEngine</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// 无法创建引擎时返回错误码1002200001，原因：语种不支持、模式不支持、初始化超时、资源不存在等导致创建引擎失败</span></li><li>        <span class="hljs-comment">// 无法创建引擎时返回错误码1002200006，原因：引擎正在忙碌中，一般多个应用同时调用语音识别引擎时触发</span></li><li>        <span class="hljs-comment">// 无法创建引擎时返回错误码1002200008，原因：引擎已被销毁</span></li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">create</span> <span class="hljs-variable">engine</span>. <span class="hljs-variable">Message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 查询语种信息，以callback形式返回</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">queryLanguagesCallback</span>() {</li><li>    <span class="hljs-comment">// 设置查询相关参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">languageQuery</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">LanguageQuery</span> = {</li><li>      <span class="hljs-variable">sessionId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sessionId</span></li><li>    };</li><li>    <span class="hljs-comment">// 调用listLanguages方法</span></li><li>    <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">listLanguages</span>(<span class="hljs-variable">languageQuery</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">languages</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable">err</span>) {</li><li>        <span class="hljs-comment">// 接收目前支持的语种信息</span></li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">succeeded</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">listing</span> <span class="hljs-variable">languages</span>, <span class="hljs-variable">result</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">languages</span>)}`);</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">languages</span> <span class="hljs-variable">result</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">languages</span>)}`</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">create</span> <span class="hljs-variable">engine</span>. <span class="hljs-variable">Message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`);</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">create</span> <span class="hljs-variable">engine</span>. <span class="hljs-variable">Message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`</li><li>      }</li><li>    });</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">startListeningForRecording</span>() {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">audioParam</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">AudioInfo</span> = { <span class="hljs-variable">audioType</span>: <span class="hljs-string">'pcm'</span>, <span class="hljs-variable">sampleRate</span>: <span class="hljs-number">16000</span>, <span class="hljs-variable">soundChannel</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">sampleBit</span>: <span class="hljs-number">16</span> } <span class="hljs-comment">// audioInfo参数配置请参考</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/hms-ai-speechrecognizer#section85771521101910" target="_blank"><span class="hljs-comment">AudioInfo</span></a></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">extraParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt; = {</li><li>      <span class="hljs-string">"recognitionMode"</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-string">"vadBegin"</span>: <span class="hljs-number">2000</span>,</li><li>      <span class="hljs-string">"vadEnd"</span>: <span class="hljs-number">3000</span>,</li><li>      <span class="hljs-string">"maxAudioDuration"</span>: <span class="hljs-number">20000</span></li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">recognizerParams</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">StartParams</span> = {</li><li>      <span class="hljs-variable">sessionId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sessionId</span>,</li><li>      <span class="hljs-variable">audioInfo</span>: <span class="hljs-title class_">audioParam</span>,</li><li>      <span class="hljs-variable">extraParams</span>: <span class="hljs-title class_">extraParam</span></li><li>    }</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'startListening start'</span>);</li><li>    <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">startListening</span>(<span class="hljs-variable">recognizerParams</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 写音频流</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">audioToText</span>() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setListener</span>();</li><li>      <span class="hljs-comment">// Set the parameters related to the start of identification.</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">audioParam</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">AudioInfo</span> = { <span class="hljs-variable">audioType</span>: <span class="hljs-string">'pcm'</span>, <span class="hljs-variable">sampleRate</span>: <span class="hljs-number">16000</span>, <span class="hljs-variable">soundChannel</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">sampleBit</span>: <span class="hljs-number">16</span> }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">recognizerParams</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">StartParams</span> = {</li><li>        <span class="hljs-variable">sessionId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sessionId2</span>,</li><li>        <span class="hljs-variable">audioInfo</span>: <span class="hljs-title class_">audioParam</span></li><li>      }</li><li>      <span class="hljs-comment">// Invoke the start recognition method.</span></li><li>      <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">startListening</span>(<span class="hljs-variable">recognizerParams</span>);</li><li>
</li><li>      <span class="hljs-comment">// Get Audio from File</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span>: <span class="hljs-title class_">ArrayBuffer</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">ctx</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">Context</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">filenames</span>: <span class="hljs-title class_">string</span>[] = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">listFileSync</span>(<span class="hljs-variable">ctx</span>.<span class="hljs-variable">resourceDir</span>);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">filenames</span>.<span class="hljs-variable">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'length is null'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">filePath</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">ctx</span>.<span class="hljs-variable">resourceDir</span> + <span class="hljs-string">'/'</span> + <span class="hljs-variable">filenames</span>[<span class="hljs-number">0</span>];</li><li>      (<span class="hljs-keyword">this</span>.<span class="hljs-variable">mFileCapturer</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">FileCapturer</span>).<span class="hljs-title function_">setFilePath</span>(<span class="hljs-variable">filePath</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">mFileCapturer</span>.<span class="hljs-keyword">init</span>((<span class="hljs-variable">dataBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span>) =&gt; {</li><li>        <span class="hljs-variable">data</span> = <span class="hljs-variable">dataBuffer</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">uint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">data</span>);</li><li>        <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">writeAudio</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">sessionId2</span>, <span class="hljs-variable">uint8Array</span>);</li><li>      });</li><li>      <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">mFileCapturer</span>.<span class="hljs-title function_">start</span>();</li><li>      <span class="hljs-variable">asrEngine</span>?.<span class="hljs-title function_">finish</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">sessionId</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">mFileCapturer</span>.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">Message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 麦克风语音转文本</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">startRecording</span>() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">startListeningForRecording</span>();</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = `<span class="hljs-variable">Message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`;</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 睡眠</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-variable">ms</span>: <span class="hljs-title class_">number</span>):<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">new</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-variable">resolve</span> =&gt; <span class="hljs-title function_">setTimeout</span>(<span class="hljs-variable">resolve</span>, <span class="hljs-variable">ms</span>));</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 设置回调</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">setListener</span>() {</li><li>    <span class="hljs-comment">// 创建回调对象</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">setListener</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">RecognitionListener</span> = {</li><li>      <span class="hljs-comment">// 开始识别成功回调</span></li><li>      <span class="hljs-variable">onStart</span>: (<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">eventMessage</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = <span class="hljs-string">''</span>;</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onStart</span>, <span class="hljs-variable">sessionId</span>: ${<span class="hljs-variable">sessionId</span>} <span class="hljs-variable">eventMessage</span>: ${<span class="hljs-variable">eventMessage</span>}`);</li><li>      },</li><li>      <span class="hljs-comment">// 事件回调</span></li><li>      <span class="hljs-title function_">onEvent</span>(<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">eventCode</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">eventMessage</span>: <span class="hljs-title class_">string</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onEvent</span>, <span class="hljs-variable">sessionId</span>: ${<span class="hljs-variable">sessionId</span>} <span class="hljs-variable">eventCode</span>: ${<span class="hljs-variable">eventCode</span>} <span class="hljs-variable">eventMessage</span>: ${<span class="hljs-variable">eventMessage</span>}`);</li><li>      },</li><li>      <span class="hljs-comment">// 识别结果回调，包括中间结果和最终结果</span></li><li>      <span class="hljs-variable">onResult</span>: (<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">result</span>: <span class="hljs-title class_">speechRecognizer</span>.<span class="hljs-title class_">SpeechRecognitionResult</span>) =&gt; {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onResult</span>, <span class="hljs-variable">sessionId</span>: ${<span class="hljs-variable">sessionId</span>} <span class="hljs-variable">result</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">result</span>)}`);</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">generatedText</span> = <span class="hljs-variable">result</span>.<span class="hljs-variable">result</span>;</li><li>      },</li><li>      <span class="hljs-comment">// 识别完成回调</span></li><li>      <span class="hljs-title function_">onComplete</span>(<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">eventMessage</span>: <span class="hljs-title class_">string</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onComplete</span>, <span class="hljs-variable">sessionId</span>: ${<span class="hljs-variable">sessionId</span>} <span class="hljs-variable">eventMessage</span>: ${<span class="hljs-variable">eventMessage</span>}`);</li><li>      },</li><li>      <span class="hljs-comment">// 错误回调，错误码通过本方法返回</span></li><li>      <span class="hljs-comment">// 返回错误码1002200002，开始识别失败，重复启动startListening方法时触发</span></li><li>      <span class="hljs-comment">// 更多错误码请参考</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-corespeech" target="_blank"><span class="hljs-comment">错误码参考</span></a></li><li>      <span class="hljs-title function_">onError</span>(<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">errorCode</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">errorMessage</span>: <span class="hljs-title class_">string</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onError</span>, <span class="hljs-variable">sessionId</span>: ${<span class="hljs-variable">sessionId</span>} <span class="hljs-variable">errorCode</span>: ${<span class="hljs-variable">errorCode</span>} <span class="hljs-variable">errorMessage</span>: ${<span class="hljs-variable">errorMessage</span>}`);</li><li>      },</li><li>    }</li><li>    <span class="hljs-comment">// 设置回调</span></li><li>    <span class="hljs-variable">asrEngine</span>.<span class="hljs-title function_">setListener</span>(<span class="hljs-variable">setListener</span>);</li><li>  };</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section1045195118313">FileCapturer.ets<i class="anchor-icon anchor-icon-link" anchorid="section1045195118313" tips="复制节点链接"></i></h3>          <p>添加FileCapturer.ets文件用于pcm文件音频流。</p>     <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'FileCapturer'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">SEND_SIZE</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1280</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * File collector tool</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileCapturer</span> {</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Whether the audio is being written</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mIsWriting</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * File Path</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mFilePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Open File Object</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mFile</span>: fileIo.<span class="hljs-property">File</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Indicates whether the file can be read.</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mIsReadFile</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Audio Data Callback Method</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mDataCallBack</span>: (<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> ) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Setting the File Path</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">filePath</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setFilePath</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mFilePath</span> = filePath;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-attr">dataCallBack</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span> = dataCallBack;</li><li>    <span class="hljs-keyword">if</span> (!fileIo.<span class="hljs-title function_">accessSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mFilePath</span>)) {</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"init start "</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">start</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsWriting</span> || <span class="hljs-literal">null</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsWriting</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsReadFile</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mFile</span> = fileIo.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mFilePath</span>, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">buf</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-variable constant_">SEND_SIZE</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">while</span> (<span class="hljs-variable constant_">SEND_SIZE</span> == fileIo.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mFile</span>.<span class="hljs-property">fd</span>, buf, {</li><li>        <span class="hljs-attr">offset</span>: offset</li><li>      }) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsReadFile</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mDataCallBack</span>(buf);</li><li>        ++count;</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">40</span>);</li><li>        offset = offset + <span class="hljs-variable constant_">SEND_SIZE</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"read file error "</span> + e);</li><li>    } <span class="hljs-keyword">finally</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != <span class="hljs-variable language_">this</span>.<span class="hljs-property">mFile</span>) {</li><li>        fileIo.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mFile</span>);</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsWriting</span> = <span class="hljs-literal">false</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">stop</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsReadFile</span> = <span class="hljs-literal">false</span>;</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"read file error "</span> + e);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mDataCallBack</span> = <span class="hljs-literal">null</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsReadFile</span> = <span class="hljs-literal">false</span>;</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"read file error "</span> + e);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms));</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="section201614530319">EntryAbility.ets<i class="anchor-icon anchor-icon-link" anchorid="section201614530319" tips="复制节点链接"></i></h3>          <p>在EntryAbility.ets文件中添加麦克风权限。</p>     <div _ngcontent-xcw-c106="" class="highlight-div"><div _ngcontent-xcw-c106="" class="highlight-div-header"><div _ngcontent-xcw-c106="" class="highlight-div-header-left"><div _ngcontent-xcw-c106="" class="handle-button expand-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xcw-c106="" class="highlight-div-header-right"><div _ngcontent-xcw-c106="" class="handle-button ai-button"></div><div _ngcontent-xcw-c106="" class="handle-button line-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xcw-c106="" class="handle-button theme-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xcw-c106="" class="handle-button copy-button"><div _ngcontent-xcw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xcw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript " data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-attr">windowStage</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageCreate'</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, [<span class="hljs-string">'ohos.permission.MICROPHONE'</span>]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'data:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'data permissions:'</span> + data.<span class="hljs-property">permissions</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'data authResults:'</span> + data.<span class="hljs-property">authResults</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'errCode: '</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">'errMessage: '</span> + err.<span class="hljs-property">message</span>);</li><li>    });</li><li>
</li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content. Data: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) ?? <span class="hljs-string">''</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>