<h1 _ngcontent-yur-c119="" class="doc-title ng-star-inserted" title="资源泄漏事件介绍"> 资源泄漏事件介绍 </h1>

<div _ngcontent-yur-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div> <div class="tiledSection"><h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2><p>资源泄漏是指句柄、线程或内存等资源在应用运行过程中未被正确释放，导致资源长期占用且无法被其他应用使用。如果某一类资源耗尽，系统可能出现卡死或重启等异常情况。</p> <p>本文面向开发者介绍资源泄漏事件各字段的含义和规格。如需了解如何使用HiAppEvent接口订阅系统资源泄漏事件，请参考以下文档。目前提供ArkTs和C/C++两种接口。</p> <ul><li><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events-arkts">订阅资源泄漏事件（ArkTS）</a></p>  </li><li><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events-ndk">订阅资源泄漏事件（C/C++）</a></p>  </li></ul> </div>  <div class="tiledSection"><h2 id="检测原理">检测原理<i class="anchor-icon anchor-icon-link" anchorid="检测原理" tips="复制节点链接"></i></h2><p>检测原理详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines" target="_blank">资源泄漏检测</a>。</p> </div>  <div class="tiledSection"><h2 id="自定义规格设置">自定义规格设置<i class="anchor-icon anchor-icon-link" anchorid="自定义规格设置" tips="复制节点链接"></i></h2></div>  <div class="tiledSection"><h3 id="接口说明" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.1" valign="top" width="50%">接口名</th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">setEventConfig(name: string, config: Record&lt;string, ParamType&gt;): Promise&lt;void&gt;</td> <td class="cellrowborder" valign="top" width="50%"><p>设置资源泄漏日志规格参数，name应为资源泄漏事件名称常量hiappevent.event.RESOURCE_OVERLIMIT。<strong>仅支持js内存泄漏类型。</strong></p> <p><strong>说明</strong>：从API version 20开始，支持该接口。</p> </td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="参数设置">参数设置<i class="anchor-icon anchor-icon-link" anchorid="参数设置" tips="复制节点链接"></i></h3><p>开发者可以使用HiAppEvent提供的接口，在Record&lt;string, ParamType&gt;中设置RESOURCE_OVERLIMIT的日志和回调事件规格。具体参数说明如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.1" valign="top" width="25%">参数名</th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.2" valign="top" width="25%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.3" valign="top" width="25%">必填</th> <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.5.1.4" valign="top" width="25%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%">js_heap_logtype</td> <td class="cellrowborder" valign="top" width="25%">string</td> <td class="cellrowborder" valign="top" width="25%">否</td> <td class="cellrowborder" valign="top" width="25%"><p>event：应用发生oom时，不传递堆快照。</p> <p>event_rawheap：应用发生oom时，系统生成并传递堆快照</p> <p><strong>注意</strong>：当前仅接收以上二值，如果传入其他内容，方法将调用失败，不会产生任何效果。</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>即使参数js_heap_logtype设置为是event_rawheap，也不能保证生成堆快照文件。这是因为生成堆快照时，应用可能因性能问题触发冻屏而提前退出。</p>  </div></div></div> <p>参数配置示例：</p> <div _ngcontent-yur-c106="" class="highlight-div"><div _ngcontent-yur-c106="" class="highlight-div-header"><div _ngcontent-yur-c106="" class="highlight-div-header-left"><div _ngcontent-yur-c106="" class="handle-button expand-button"><div _ngcontent-yur-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yur-c106="" class="highlight-div-header-right"><div _ngcontent-yur-c106="" class="handle-button ai-button"></div><div _ngcontent-yur-c106="" class="handle-button line-button"><div _ngcontent-yur-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yur-c106="" class="handle-button theme-button"><div _ngcontent-yur-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yur-c106="" class="handle-button copy-button"><div _ngcontent-yur-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yur-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">configParams</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, hiAppEvent.<span class="hljs-property">ParamType</span>&gt; = {</li><li>    <span class="hljs-string">"js_heap_logtype"</span>: <span class="hljs-string">"event"</span>, <span class="hljs-comment">// 仅获取事件</span></li><li>    <span class="hljs-comment">// "js_heap_logtype": "event_rawheap", // 同时获取堆快照</span></li><li>};</li><li>
</li><li>hiAppEvent.<span class="hljs-title function_">setEventConfig</span>(hiappEvent.<span class="hljs-property">event</span>.<span class="hljs-property">RESOURCE_OVERLIMIT</span>, configParams);</li></ol></pre></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"> <p>应用调用setEventConfig接口时，每次调用的内容只会在当前应用生命周期内生效。应用重启后，需要重新通过setEventConfig接口设置。</p>  <p>在同一个应用生命周期内，可以多次调用setEventConfig，以最后一次成功调用的值为准。</p>  <p>开发者在调试以及自测试过程中，单日内触发oom次数过多，可能会遇到无法收到hiappevent回传js内存泄漏事件的情况，可以通过将系统时间往后调一天进行规避。</p>  </div></div></div> </div>  <div class="tiledSection"><h2 id="params字段说明">params字段说明<i class="anchor-icon anchor-icon-link" anchorid="params字段说明" tips="复制节点链接"></i></h2><p>资源泄漏事件信息中params属性的详细说明如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.3.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.6.3.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">time</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">事件触发时间，单位：ms。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">bundle_version</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">string</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">应用版本。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">bundle_name</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">string</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">应用名称。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">pid</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">应用的进程ID。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">uid</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">应用的用户ID。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">resource_type</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">string</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">资源类型，取值范围详见resource_type属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">memory</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">object</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory或js_heap专有）内存信息，详见memory属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">fd</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">object</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为fd专有）文件描述符信息，详见fd属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">thread</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">object</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为thread专有）线程信息，详见thread属性。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">external_log</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">string[]</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">故障日志文件路径。<strong>为避免目录空间超限（限制参考log_over_limit），导致新生成的日志文件写入失败，请在日志文件处理完后及时删除。</strong></td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">log_over_limit</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">boolean</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">生成的故障日志文件与已存在的日志文件总大小是否超过2GB上限。true表示超过上限，日志写入失败；false表示未超过上限。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="resource_type字段说明" class="firsth2">resource_type字段说明<i class="anchor-icon anchor-icon-link" anchorid="resource_type字段说明" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.1" valign="top" width="50%">取值</th> <th align="left" class="cellrowborder" id="mcps1.3.7.2.1.3.1.2" valign="top" width="50%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">pss_memory</td> <td class="cellrowborder" valign="top" width="50%">pss内存泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">ion_memory</td> <td class="cellrowborder" valign="top" width="50%">ion内存泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">gpu_memory</td> <td class="cellrowborder" valign="top" width="50%">gpu内存泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">js_heap</td> <td class="cellrowborder" valign="top" width="50%">js内存泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">fd</td> <td class="cellrowborder" valign="top" width="50%">句柄泄漏。</td> </tr> <tr><td class="cellrowborder" valign="top" width="50%">thread</td> <td class="cellrowborder" valign="top" width="50%">线程泄漏。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="memory字段说明">memory字段说明<i class="anchor-icon anchor-icon-link" anchorid="memory字段说明" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.2.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.8.2.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.8.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">rss</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）进程实际占用内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">vss</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）进程向系统申请的虚拟内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">pss</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）进程实际使用的物理内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">ion</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）进程实际使用的ION内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">gpu</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）进程实际使用的GPU内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">sys_free_mem</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）空闲内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">sys_avail_mem</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）可用内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">sys_total_mem</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为pss_memory、ion_memory、gpu_memory专有）总内存大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">limit_size</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为js_heap专有）基线大小，单位：KB。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">live_object_size</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">（resource_type为js_heap专有）实际使用内存大小，单位：KB。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="fd字段说明">fd字段说明<i class="anchor-icon anchor-icon-link" anchorid="fd字段说明" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">num</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">fd总数量。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">top_fd_type</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">string</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">使用最多的fd类型。</td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%">top_fd_num</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">使用最多的fd类型的数量。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h3 id="thread字段说明">thread字段说明<i class="anchor-icon anchor-icon-link" anchorid="thread字段说明" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.2.1.4.1.1" valign="top" width="33.33333333333333%">名称</th> <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.4.1.2" valign="top" width="33.33333333333333%">类型</th> <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.4.1.3" valign="top" width="33.33333333333333%">说明</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%">num</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">number</td> <td class="cellrowborder" valign="top" width="33.33333333333333%">thread总数量。</td> </tr>  </tbody></table></div> </div> </div>  <div class="tiledSection"><h2 id="自定义params参数">自定义params参数<i class="anchor-icon anchor-icon-link" anchorid="自定义params参数" tips="复制节点链接"></i></h2><p>当前资源泄漏事件上报<strong>js内存泄漏</strong>事件信息，可能无法满足开发者的个性化需求，因此提供事件setEventParam方法，自定义事件上报信息。</p> </div>  <div class="tiledSection"><h3 id="接口说明-1" class="firsth2">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明-1" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.1" valign="top" width="50%">接口名</th> <th align="left" class="cellrowborder" id="mcps1.3.12.2.1.3.1.2" valign="top" width="50%">描述</th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%">setEventParam(params: Record&lt;string, ParamType&gt;, domain: string, name?: string): Promise&lt;void&gt;</td> <td class="cellrowborder" valign="top" width="50%"><p>事件自定义参数设置方法。</p> <p><strong>说明</strong>：从API version 20开始，支持该接口。</p> </td> </tr>  </tbody></table></div> </div> </div> </div> <div></div></div>