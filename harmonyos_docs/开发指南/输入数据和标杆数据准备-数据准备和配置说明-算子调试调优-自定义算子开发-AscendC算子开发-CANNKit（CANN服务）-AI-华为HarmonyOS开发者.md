<h1 _ngcontent-cpo-c119="" class="doc-title ng-star-inserted" title="输入数据和标杆数据准备"> 输入数据和标杆数据准备 </h1>

<div _ngcontent-cpo-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>使用AscendC调测工具进行算子调测前，必须提供算子的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-commissioning-tools">输入数据和标杆数据</a>。</p> <ul><li>输入数据（input数据）：固定shape算子运行时的输入数据，bin格式。</li><li>标杆数据（golden数据）：根据输入数据计算出来的真值数据，用于与输出数据进行精度比对，bin格式。</li></ul> <p>本章节提供多种方式来准备数据，开发者可以根据实际情况选择合适的方式。</p> <ul><li><strong>方式1：采用外部提供的input/golden数据。</strong><p>开发者采用外部数据源进行算子调测，一般适合首次调测场景。</p> <p>在算子信息json配置文件中，将gen_data配为false，data_file配为输入数据、标杆数据对应的路径（必须为绝对路径），示例如下。</p> <div _ngcontent-cpo-c106="" class="highlight-div"><div _ngcontent-cpo-c106="" class="highlight-div-header"><div _ngcontent-cpo-c106="" class="highlight-div-header-left"><div _ngcontent-cpo-c106="" class="handle-button expand-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpo-c106="" class="highlight-div-header-right"><div _ngcontent-cpo-c106="" class="handle-button ai-button"></div><div _ngcontent-cpo-c106="" class="handle-button line-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpo-c106="" class="handle-button theme-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpo-c106="" class="handle-button copy-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpo-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"gen_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/input_data_q.bin"</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/golden_data_out.bin"</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> <p>若外部提供的数据是.pt文件，需要转换为.bin文件，以PyTorch为例：</p> <div _ngcontent-cpo-c106="" class="highlight-div"><div _ngcontent-cpo-c106="" class="highlight-div-header"><div _ngcontent-cpo-c106="" class="highlight-div-header-left"><div _ngcontent-cpo-c106="" class="handle-button expand-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpo-c106="" class="highlight-div-header-right"><div _ngcontent-cpo-c106="" class="handle-button ai-button"></div><div _ngcontent-cpo-c106="" class="handle-button line-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpo-c106="" class="handle-button theme-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpo-c106="" class="handle-button copy-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpo-c106="" class="highlight-scroll-div"><pre class="python prettyprint linenums hljs language-python" hw-language="python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> torch </li><li>model = torch.load(<span class="hljs-string">'model.pt'</span>)   <span class="hljs-comment"># 加载.pt文件</span></li><li>torch.save(model, <span class="hljs-string">'model.bin'</span>)   <span class="hljs-comment"># 将模型参数保存为二进制文件</span></li></ol></pre></div></div> </li><li><strong>方式2：采用已生成过的input/golden数据，无需重新生成。</strong><p>当开发者需要多次重跑，建议直接使用历史生成的数据，避免重复生成，导致调测耗时过长。</p> <p>在算子信息json配置文件中，将gen_data配为false，data_file配为输入数据、标杆数据对应的bin文件名（不含路径信息，默认在当前路径下查找数据文件），示例如下。</p> <div _ngcontent-cpo-c106="" class="highlight-div"><div _ngcontent-cpo-c106="" class="highlight-div-header"><div _ngcontent-cpo-c106="" class="highlight-div-header-left"><div _ngcontent-cpo-c106="" class="handle-button expand-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpo-c106="" class="highlight-div-header-right"><div _ngcontent-cpo-c106="" class="handle-button ai-button"></div><div _ngcontent-cpo-c106="" class="handle-button line-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpo-c106="" class="handle-button theme-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpo-c106="" class="handle-button copy-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpo-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"gen_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"input_data_q.bin"</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>        <span class="hljs-punctuation">{</span></li><li>            <span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"golden_data_out.bin"</span></li><li>        <span class="hljs-punctuation">}</span></li><li>    <span class="hljs-punctuation">]</span></li><li><span class="hljs-punctuation">}</span></li></ol></pre></div></div> </li><li><strong>方式3：采用工具随机生成input数据。</strong><p>开发者未准备任何数据，可采用工具随机生成的input数据，生成的bin数据文件默认在当前路径下的对应算子的data文件夹中。该场景下没有golden数据，因此不支持精度比对。</p> <p>在算子信息json配置文件中，将gen_data配为true，data_script配为空字符串或null，data_file配为输入数据、标杆数据对应的bin文件名（不含路径信息，默认在当前路径下查找数据文件），示例如下。</p> <div _ngcontent-cpo-c106="" class="highlight-div"><div _ngcontent-cpo-c106="" class="highlight-div-header"><div _ngcontent-cpo-c106="" class="highlight-div-header-left"><div _ngcontent-cpo-c106="" class="handle-button expand-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpo-c106="" class="highlight-div-header-right"><div _ngcontent-cpo-c106="" class="handle-button ai-button"></div><div _ngcontent-cpo-c106="" class="handle-button line-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpo-c106="" class="handle-button theme-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpo-c106="" class="handle-button copy-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpo-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"data_script"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>       </li><li><span class="hljs-attr">"gen_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li> <span class="hljs-comment">// ... </span></li><li><span class="hljs-attr">"shape"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">16384</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li><span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sample.bin"</span><span class="hljs-punctuation">,</span></li></ol></pre></div></div> </li><li><strong>方式4：采用脚本生成input/golden数据。</strong><p>开发者自行准备数据生成脚本（一般是.py文件），同时配置算子信息json配置文件。</p> <p>将gen_data配为true，data_script配为数据生成脚本路径（以FlashAttentionScore算子为例），data_file配为输入数据、标杆数据对应的bin文件名（不含路径信息，默认在当前路径下查找数据文件），示例如下。</p> <div _ngcontent-cpo-c106="" class="highlight-div"><div _ngcontent-cpo-c106="" class="highlight-div-header"><div _ngcontent-cpo-c106="" class="highlight-div-header-left"><div _ngcontent-cpo-c106="" class="handle-button expand-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cpo-c106="" class="highlight-div-header-right"><div _ngcontent-cpo-c106="" class="handle-button ai-button"></div><div _ngcontent-cpo-c106="" class="handle-button line-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cpo-c106="" class="handle-button theme-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cpo-c106="" class="handle-button copy-button"><div _ngcontent-cpo-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cpo-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"data_script"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${fa_case_dir}/flash_attention_score_golden.py"</span><span class="hljs-punctuation">,</span>       </li><li><span class="hljs-attr">"gen_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span></li><li> <span class="hljs-comment">// ... </span></li><li><span class="hljs-attr">"data_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sample.bin"</span><span class="hljs-punctuation">,</span></li></ol></pre></div></div> <p>生成数据时，会调用该脚本，并固定传入以下参数：</p> <p>sys.argv[1]：输入的算子json配置文件。</p> <p>sys.argv[2]：输出bin文件路径（工作路径下的data文件夹，例如debug_workspace/FlashAttentionScore/data/）。</p> <ul><li>开发者需要根据输入的sys.argv[1]读取算子json配置文件内容，获取生成数据所需的算子shape信息、数据文件的文件名，并在脚本中适配生成的文件名。</li><li>开发者需要根据输入的sys.argv[2]设置存放input/output数据文件的路径，将生成的文件保存到该路径下。</li></ul> </li></ul> </div> <div></div></div>