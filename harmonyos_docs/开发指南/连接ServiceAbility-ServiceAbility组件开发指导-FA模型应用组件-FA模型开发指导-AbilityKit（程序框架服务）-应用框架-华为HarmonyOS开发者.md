<h1 _ngcontent-ygj-c119="" class="doc-title ng-star-inserted" title="连接ServiceAbility"> 连接ServiceAbility </h1>

<div _ngcontent-ygj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>如果ServiceAbility需要与PageAbility或其他应用的ServiceAbility进行交互，则须创建用于连接的Connection。ServiceAbility支持其他Ability通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-ability-featureability#featureabilityconnectability7" target="_blank">connectAbility()</a>方法与其进行连接。PageAbility的connectAbility()方法定义在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-ability-featureability" target="_blank">featureAbility</a>中，ServiceAbility的connectAbility()方法定义在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-ability-particleability" target="_blank">particleAbility</a>中。连接ServiceAbility的规则详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/component-startup-rules-fa">组件启动规则</a>章节。在使用connectAbility()处理回调时，需要传入目标Service的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">Want</a>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions" target="_blank">IAbilityConnection</a>的实例。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions" target="_blank">IAbilityConnection</a>提供了以下方法供开发者实现。</p>    <p><strong>表1</strong> IAbilityConnection接口说明</p>    <div class="tablenoborder">     <div class="tbBox"><table class="layoutFixed idpTab">      <thead>       <tr>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.1" valign="top" width="50%">接口名</th>        <th align="left" class="cellrowborder" id="mcps1.3.3.1.3.1.2" valign="top" width="50%">描述</th>       </tr>      </thead>             <tbody><tr>        <td class="cellrowborder" valign="top" width="50%">onConnect()</td>        <td class="cellrowborder" valign="top" width="50%">用于处理连接Service成功的回调。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">onDisconnect()</td>        <td class="cellrowborder" valign="top" width="50%">用来处理Service异常死亡的回调。</td>       </tr>       <tr>        <td class="cellrowborder" valign="top" width="50%">onFailed()</td>        <td class="cellrowborder" valign="top" width="50%">用来处理连接Service失败的回调。</td>       </tr>           </tbody></table></div>    </div>    <p>PageAbility创建连接本地ServiceAbility回调实例的代码以及连接本地ServiceAbility的示例代码如下：</p>    <div _ngcontent-ygj-c106="" class="highlight-div"><div _ngcontent-ygj-c106="" class="highlight-div-header"><div _ngcontent-ygj-c106="" class="highlight-div-header-left"><div _ngcontent-ygj-c106="" class="handle-button expand-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ygj-c106="" class="highlight-div-header-right"><div _ngcontent-ygj-c106="" class="handle-button ai-button"></div><div _ngcontent-ygj-c106="" class="handle-button line-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ygj-c106="" class="handle-button theme-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ygj-c106="" class="handle-button copy-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ygj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> featureAbility <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.ability.featureAbility'</span>;</li><li><span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">Want</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.Want'</span>;</li><li><span class="hljs-keyword">import</span> promptAction <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.promptAction'</span>;</li><li><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;</li><li><span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;</li></ol></pre></div></div>    <div _ngcontent-ygj-c106="" class="highlight-div"><div _ngcontent-ygj-c106="" class="highlight-div-header"><div _ngcontent-ygj-c106="" class="highlight-div-header-left"><div _ngcontent-ygj-c106="" class="handle-button expand-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ygj-c106="" class="highlight-div-header-right"><div _ngcontent-ygj-c106="" class="handle-button ai-button"></div><div _ngcontent-ygj-c106="" class="handle-button line-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ygj-c106="" class="handle-button theme-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ygj-c106="" class="handle-button copy-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ygj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'PageServiceAbility'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">domain</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PageServiceAbility</span> {</li><li>  <span class="hljs-comment">//...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">//...</span></li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-number">0</span> }) {</li><li>        <span class="hljs-title class_">ListItem</span>() {</li><li>          <span class="hljs-title class_">Row</span>() {</li><li>            <span class="hljs-comment">//...</span></li><li>          }</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: common.<span class="hljs-property">ConnectOptions</span> = {</li><li>              <span class="hljs-attr">onConnect</span>: <span class="hljs-function">(<span class="hljs-params">element, proxy</span>) =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnectLocalService onConnectDone element:`</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(element));</li><li>                <span class="hljs-keyword">if</span> (proxy === <span class="hljs-literal">null</span>) {</li><li>                  promptAction.<span class="hljs-title function_">showToast</span>({</li><li>                    <span class="hljs-attr">message</span>: <span class="hljs-string">'connect_service_failed_toast'</span></li><li>                  });</li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>                <span class="hljs-keyword">let</span> data = rpc.<span class="hljs-property">MessageParcel</span>.<span class="hljs-title function_">create</span>();</li><li>                <span class="hljs-keyword">let</span> reply = rpc.<span class="hljs-property">MessageParcel</span>.<span class="hljs-title function_">create</span>();</li><li>                <span class="hljs-keyword">let</span> option = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageOption</span>();</li><li>                data.<span class="hljs-title function_">writeInterfaceToken</span>(<span class="hljs-string">'connect.test.token'</span>);</li><li>                proxy.<span class="hljs-title function_">sendRequest</span>(<span class="hljs-number">0</span>, data, reply, option);</li><li>                promptAction.<span class="hljs-title function_">showToast</span>({</li><li>                  <span class="hljs-attr">message</span>: <span class="hljs-string">'connect_service_success_toast'</span></li><li>                });</li><li>              },</li><li>              <span class="hljs-attr">onDisconnect</span>: <span class="hljs-function">(<span class="hljs-params">element</span>) =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnectLocalService onDisconnectDone element:<span class="hljs-subst">${element}</span>`</span>);</li><li>                promptAction.<span class="hljs-title function_">showToast</span>({</li><li>                  <span class="hljs-attr">message</span>: <span class="hljs-string">'disconnect_service_success_toast'</span></li><li>                });</li><li>              },</li><li>              <span class="hljs-attr">onFailed</span>: <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnectLocalService onFailed errCode:<span class="hljs-subst">${code}</span>`</span>);</li><li>                promptAction.<span class="hljs-title function_">showToast</span>({</li><li>                  <span class="hljs-attr">message</span>: <span class="hljs-string">'connect_service_failed_toast'</span></li><li>                });</li><li>              }</li><li>            };</li><li>
</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">request</span>: <span class="hljs-title class_">Want</span> = {</li><li>              <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.samples.famodelabilitydevelop'</span>,</li><li>              <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'com.samples.famodelabilitydevelop.ServiceAbility'</span>,</li><li>            };</li><li>            <span class="hljs-keyword">let</span> connId = featureAbility.<span class="hljs-title function_">connectAbility</span>(request, option);</li><li>            hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onConnectLocalService onFailed errCode:<span class="hljs-subst">${connId}</span>`</span>);</li><li>          })</li><li>        }</li><li>        <span class="hljs-comment">//...</span></li><li>      }</li><li>      <span class="hljs-comment">//...</span></li><li>    }</li><li>    <span class="hljs-comment">//...</span></li><li>  }</li><li>}</li></ol></pre></div></div>    <p>同时，Service侧也需要在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-ability-connectoptions#onconnect" target="_blank">onConnect()</a>时返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#iremoteobject" target="_blank">IRemoteObject</a>，从而定义与Service进行通信的接口。onConnect()需要返回一个IRemoteObject对象。系统提供了IRemoteObject的默认实现，开发者可以通过继承<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#remoteobject" target="_blank">rpc.RemoteObject</a>来创建自定义的实现类。</p>    <p>Service侧把自身的实例返回给调用侧的示例代码如下：</p>    <div _ngcontent-ygj-c106="" class="highlight-div"><div _ngcontent-ygj-c106="" class="highlight-div-header"><div _ngcontent-ygj-c106="" class="highlight-div-header-left"><div _ngcontent-ygj-c106="" class="handle-button expand-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ygj-c106="" class="highlight-div-header-right"><div _ngcontent-ygj-c106="" class="handle-button ai-button"></div><div _ngcontent-ygj-c106="" class="handle-button line-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ygj-c106="" class="handle-button theme-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ygj-c106="" class="handle-button copy-button"><div _ngcontent-ygj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ygj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Want</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.Want'</span>;</li><li><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;</li><li><span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'[Sample_FAModelAbilityDevelop]'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">domain</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xFF00</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstServiceAbilityStub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">des: <span class="hljs-built_in">Object</span></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> des === <span class="hljs-string">'string'</span>) {</li><li>      <span class="hljs-variable language_">super</span>(des);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onRemoteRequest</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageParcel</span>, <span class="hljs-attr">reply</span>: rpc.<span class="hljs-property">MessageParcel</span>, <span class="hljs-attr">option</span>: rpc.<span class="hljs-property">MessageOption</span>): <span class="hljs-built_in">boolean</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'ServiceAbility onRemoteRequest called'</span>);</li><li>    <span class="hljs-keyword">if</span> (code === <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-built_in">string</span> = data.<span class="hljs-title function_">readString</span>();</li><li>      hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ServiceAbility string=<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>);</li><li>      <span class="hljs-keyword">let</span> result = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-built_in">string</span>).<span class="hljs-title function_">sort</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ServiceAbility result=<span class="hljs-subst">${result}</span>`</span>);</li><li>      reply.<span class="hljs-title function_">writeString</span>(result);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(domain, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'ServiceAbility unknown request code'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li><li><span class="hljs-comment">//...</span></li></ol></pre></div></div>   </div>   <div></div></div>