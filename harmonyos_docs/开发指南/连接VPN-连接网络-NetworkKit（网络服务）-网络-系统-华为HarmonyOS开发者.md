<h1 _ngcontent-qap-c119="" class="doc-title ng-star-inserted" title="连接VPN"> 连接VPN </h1>

<div _ngcontent-qap-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>VPN，即虚拟专用网络（Virtual Private Network），是在公用网络上建立专用网络的一种技术。在VPN网络中，任意两个节点间的连接并非依赖传统专用网络所需要的端到端的物理链路，而是构建在公用网络服务商提供的平台（如Internet）之上的逻辑网络。用户数据在这一逻辑链路中进行传输。</p>     <p>HarmonyOS为开发者提供了用于创建VPN的API解决方案。当前提供三方VPN能力主要用于创建虚拟网卡及配置VPN路由信息，连接隧道过程及内部连接的协议需要应用内部自行实现。本文将指导您如何开发自己的VPN客户端。</p>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <ul>        <li>为了保证应用的运行效率，所有API调用都是异步的，对于异步调用的API均提供了Promise的方式，以下示例均采用Promise方式，更多方式可以查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-vpnextension" target="_blank">API参考</a>。</li>        <li>完整的JS API说明以及示例代码请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-vpnextension" target="_blank">VPN扩展应用API</a>。</li>        <li>使用该功能需要<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all#ohospermissioninternet">ohos.permission.INTERNET</a>权限。</li>       </ul>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="vpn应用的显示体验">VPN应用的显示体验<i class="anchor-icon anchor-icon-link" anchorid="vpn应用的显示体验" tips="复制节点链接"></i></h2>          <p>借助系统提供的VPN Extension接口开发者可以构建支持不同协议的VPN服务。HarmonyOS系统提供了界面 (UI) 使用户可以了解当前VPN应用服务的启动和连接：</p>     <ul>      <li>在VPN应用首次启动连接之前，系统会显示VPN连接授权对话框。该对话框会提示用户是否信任该VPN应用并接受VPN连接请求。</li>      <li>当VPN启动连接成功时，状态栏显示一个VPN (钥匙) 图标以提醒用户VPN处于连接状态。</li>     </ul>     <p>为了使用户可以方便的查看和配置，您的VPN应用还需要提供以下界面：</p>     <ul>      <li>用于手动启动和停止连接的控件。</li>      <li>当VPN启动连接时，在通知栏显示VPN应用的连接状态或提供网络统计信息 (如连接时长、流量等) 。点击该通知能够将您的VPN应用调入前台。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="创建vpn-extension-ability" class="firsth2">创建VPN Extension Ability<i class="anchor-icon anchor-icon-link" anchorid="创建vpn-extension-ability" tips="复制节点链接"></i></h3>          <p>如果想使您的应用支持VPN能力，首先您需要创建一个继承于VpnExtensionAbility的extensionAbilities。</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 举例：在应用的module.json5中定义MyVpnExtAbility。</span></li><li><span class="hljs-string">"extensionAbilities"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"MyVpnExtAbility"</span>,</li><li>    <span class="hljs-string">"description"</span>: <span class="hljs-string">"vpnservice"</span>,</li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"vpn"</span>,</li><li>    <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/serviceextability/MyVpnExtAbility.ts"</span></li><li>  }</li><li>]</li></ol></pre></div></div>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>如果DevEco Studio工具提示不能识别"type": "vpn"，需要您手动在SDK的toolchains\modulecheck\module.json文件中，给extensionAbilities对应的type枚举添加"vpn"定义，并清除build缓存和重启DevEco Studio工具。</p>      </div></div></div>     <p>接下来您需要在创建的VpnExtensionAbility中实现VPN的配置、启动和停止操作：</p>     <ul>      <li>建立一个VPN的网络隧道，以UDP隧道为例（参考本文下方VPN Demo示例工程文件<a href="https://gitcode.com/openharmony/applications_app_samples/blob/master/code/DocsSample/NetWork_Kit/NetWorkKit_NetManager/VPNControl_Case/entry/src/main/cpp/napi_init.cpp" target="_blank">napi_init</a>的UdpConnect()方法）；</li>      <li>通过VpnConnection.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-vpnextension#protect" target="_blank">protect</a>保护前一步建立的UDP隧道；</li>      <li>构建VPN Config参数，参考<a href="/consumer/cn/doc/harmonyos-guides/net-vpnextension#vpn-config参数说明">VPN Config参数说明</a>；</li>      <li>通过VpnConnection.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-vpnextension#create" target="_blank">create</a>建立VPN网络连接；</li>      <li>处理虚拟网卡的数据，如：读写操作。</li>     </ul>    </div>    <div class="tiledSection">     <h3 id="启动vpn-extension-ability">启动VPN Extension Ability<i class="anchor-icon anchor-icon-link" anchorid="启动vpn-extension-ability" tips="复制节点链接"></i></h3>          <p>当VPN应用启动VPN连接时，需要调用startVpnExtensionAbility接口，携带需要启动的VpnExtensionAbility信息，其中bundleName需要与您的VPN应用bundleName一致，abilityName为您在前面创建的VpnExtensionAbility名。您可参考如下示例：</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { vpnExtension } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>  <span class="hljs-attr">deviceId</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">"com.example.myvpndemo"</span>,</li><li>  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">"MyVpnExtAbility"</span>,</li><li>};</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"btn click"</span>)</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Start Extension'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          vpnExtension.<span class="hljs-title function_">startVpnExtensionAbility</span>(want);</li><li>        }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">45</span>).<span class="hljs-title function_">margin</span>(<span class="hljs-number">16</span>)</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>如果您的VPN应用未获取用户信任，系统将弹出VPN连接的授权对话框，当获取用户授权后，系统将自动调用并启动您实现的VPN Extension Ability的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-vpnextensionability#vpnextensionabilityoncreate" target="_blank">onCreate</a>方法将被调用。</p>     <p>目前系统仅支持启动一个VPN连接服务，当VPN已经启动时应用新调用启动接口会收到系统拒绝错误，此时建议您的应用可以提醒用户先断开当前已经激活的VPN应用连接。</p>    </div>    <div class="tiledSection">     <h3 id="停止vpn-extension-ability">停止VPN Extension Ability<i class="anchor-icon anchor-icon-link" anchorid="停止vpn-extension-ability" tips="复制节点链接"></i></h3>          <p>当VPN应用需要停止VPN连接时，需要调用stopVpnExtensionAbility接口，携带需要停止的VpnExtensionAbility信息。系统会对调用方做权限校验，stopVpnExtensionAbility的调用方应用必须获取了用户的VPN信任授权，且只允许停止应用自己启动的VpnExtensionAbility，所以接口传入的参数中bundleName需要与您的VPN应用bundleName一致，abilityName为指定停止VPN的VpnExtensionAbility名。</p>     <p>您可参考如下示例：</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { vpnExtension } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>  <span class="hljs-attr">deviceId</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">"com.example.myvpndemo"</span>,</li><li>  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">"MyVpnExtAbility"</span>,</li><li>};</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"btn click"</span>)</li><li>        })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Start Extension'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          vpnExtension.<span class="hljs-title function_">startVpnExtensionAbility</span>(want);</li><li>        }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">45</span>).<span class="hljs-title function_">margin</span>(<span class="hljs-number">16</span>)</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Stop Extension'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"btn end"</span>)</li><li>          vpnExtension.<span class="hljs-title function_">stopVpnExtensionAbility</span>(want);</li><li>        }).<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">45</span>).<span class="hljs-title function_">margin</span>(<span class="hljs-number">16</span>)</li><li>
</li><li>      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>     <p>stopVpnExtensionAbility后，您的VPN Extension Ability的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-vpnextensionability#vpnextensionabilityondestroy" target="_blank">onDestroy</a>方法将被调用，您可在此时destroy vpn连接。</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { vpnExtension, <span class="hljs-title class_">VpnExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: vpnExtension.<span class="hljs-property">VpnExtensionContext</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVpnExtAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">VpnExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-title class_">VpnConnection</span>: vpnExtension.<span class="hljs-property">VpnConnection</span> = vpnExtension.<span class="hljs-title function_">createVpnConnection</span>(context);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"vpn createVpnConnection: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title class_">VpnConnection</span>));</li><li>    <span class="hljs-title class_">VpnConnection</span>.<span class="hljs-title function_">destroy</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"destroy success."</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"destroy fail"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="生成vpn-id">生成VPN Id<i class="anchor-icon anchor-icon-link" anchorid="生成vpn-id" tips="复制节点链接"></i></h3>          <p>创建新的VPN时，应生成一个VPN Id作为VPN的唯一标识。</p>     <p>可参考如下示例：</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { vpnExtension, <span class="hljs-title class_">VpnExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VpnTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">VpnExtensionAbility</span> {</li><li>  <span class="hljs-attr">vpnId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>
</li><li>  <span class="hljs-title function_">getVpnId</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> vpnConnection = vpnExtension.<span class="hljs-title function_">createVpnConnection</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    vpnConnection?.<span class="hljs-title function_">generateVpnId</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (data) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">vpnId</span> = data;</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="断开vpn">断开VPN<i class="anchor-icon anchor-icon-link" anchorid="断开vpn" tips="复制节点链接"></i></h3>          <p>若需断开VPN，可参考如下示例：</p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { vpnExtension, <span class="hljs-title class_">VpnExtensionAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VpnTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">VpnExtensionAbility</span> {</li><li>  <span class="hljs-attr">vpnId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'test_vpn_id'</span></li><li>  <span class="hljs-attr">vpnConnection</span>: vpnExtension.<span class="hljs-property">VpnConnection</span> | <span class="hljs-literal">undefined</span></li><li>
</li><li>  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vpnConnection</span> = vpnExtension.<span class="hljs-title function_">createVpnConnection</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vpnConnection</span>?.<span class="hljs-title function_">destroy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vpnId</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="服务生命周期">服务生命周期<i class="anchor-icon anchor-icon-link" anchorid="服务生命周期" tips="复制节点链接"></i></h2>          <p>为了保障设备的网络连接，当系统观察到VPN相关应用出现异常时会主动停止VPN连接：</p>     <ul>      <li>当调用startVpnExtensionAbility接口的应用进程退出时。</li>      <li>当VPN服务进程销毁时。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="vpn-config参数说明">VPN Config参数说明<i class="anchor-icon anchor-icon-link" anchorid="vpn-config参数说明" tips="复制节点链接"></i></h2>          <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.6.1.1" valign="top" width="20%">名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.6.1.2" valign="top" width="20%">类型</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.6.1.3" valign="top" width="20%">只读</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.6.1.4" valign="top" width="20%">可选</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.2.1.6.1.5" valign="top" width="20%">说明</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="20%">addresses</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#linkaddress" target="_blank">LinkAddress</a>&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">VPN虚拟网卡的IP地址。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">routes</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#routeinfo" target="_blank">RouteInfo</a>&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">VPN虚拟网卡的路由信息(目前最多可配置1024条路由)。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">dnsAddresses</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;string&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">DNS服务器地址信息。配置DNS服务器地址后，VPN启动状态下，被代理的应用上网时，使用配置的DNS服务器进行DNS查询。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">searchDomains</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;string&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">DNS的搜索域列表。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">mtu</td>         <td class="cellrowborder" valign="top" width="20%">number</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">最大传输单元MTU值(单位：字节)。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">isIPv4Accepted</td>         <td class="cellrowborder" valign="top" width="20%">boolean</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">是否支持IPV4，默认值为true。true：支持IPV4；false：不支持IPV4。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">isIPv6Accepted</td>         <td class="cellrowborder" valign="top" width="20%">boolean</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">是否支持IPV6，默认值为false。true：支持IPV6；false：不支持IPV6。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">isInternal</td>         <td class="cellrowborder" valign="top" width="20%">boolean</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">是否支持内置VPN，默认值为false。true：支持内置VPN；false：不支持内置VPN。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">isBlocking</td>         <td class="cellrowborder" valign="top" width="20%">boolean</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">是否阻塞模式，默认值为false。true：是阻塞模式；false：不是阻塞模式。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">trustedApplications</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;string&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">          <p>受信任的应用信息列表，以string类型表示的包名。配置此列表后，仅列表中的应用数据才能根据routes被VPN代理。</p>          <p>注：trustedApplications和blockedApplications列表不能同时配置。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="20%">blockedApplications</td>         <td class="cellrowborder" valign="top" width="20%">Array&lt;string&gt;</td>         <td class="cellrowborder" valign="top" width="20%">否</td>         <td class="cellrowborder" valign="top" width="20%">是</td>         <td class="cellrowborder" valign="top" width="20%">          <p>被阻止的应用信息列表，string类型表示的包名。当配置该列表后，该列表中的应用数据不会被VPN代理，其他应用可以根据routes配置被VPN代理。</p>          <p>注：trustedApplications和blockedApplications列表不能同时配置。</p></td>        </tr>             </tbody></table></div>     </div>     <p><strong>示例：</strong></p>     <div _ngcontent-qap-c106="" class="highlight-div"><div _ngcontent-qap-c106="" class="highlight-div-header"><div _ngcontent-qap-c106="" class="highlight-div-header-left"><div _ngcontent-qap-c106="" class="handle-button expand-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qap-c106="" class="highlight-div-header-right"><div _ngcontent-qap-c106="" class="handle-button ai-button"></div><div _ngcontent-qap-c106="" class="handle-button line-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qap-c106="" class="handle-button theme-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qap-c106="" class="handle-button copy-button"><div _ngcontent-qap-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qap-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { vpnExtension } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">vpnConfig</span>: vpnExtension.<span class="hljs-property">VpnConfig</span> = {</li><li>  <span class="hljs-comment">// 配置VPN虚拟网卡的IP地址。</span></li><li>  <span class="hljs-attr">addresses</span>: [{</li><li>    <span class="hljs-attr">address</span>: {</li><li>      <span class="hljs-attr">address</span>: <span class="hljs-string">'192.x.x.5'</span>,</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span></li><li>    },</li><li>    <span class="hljs-attr">prefixLength</span>: <span class="hljs-number">24</span></li><li>  }],</li><li>  <span class="hljs-comment">// 配置路由参数。</span></li><li>  <span class="hljs-attr">routes</span>: [{</li><li>    <span class="hljs-comment">// VPN虚拟网卡接口名固定为“vpn-tun”。</span></li><li>    <span class="hljs-attr">interface</span>: <span class="hljs-string">'vpn-tun'</span>,</li><li>    <span class="hljs-attr">destination</span>: {</li><li>      <span class="hljs-attr">address</span>: {</li><li>        <span class="hljs-attr">address</span>: <span class="hljs-string">'10.x.x.8'</span>,</li><li>        <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>        <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span></li><li>      },</li><li>      <span class="hljs-attr">prefixLength</span>: <span class="hljs-number">24</span></li><li>    },</li><li>    <span class="hljs-attr">gateway</span>: {</li><li>      <span class="hljs-attr">address</span>: <span class="hljs-string">'10.x.x.5'</span>,</li><li>      <span class="hljs-attr">family</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span></li><li>    },</li><li>    <span class="hljs-attr">hasGateway</span>: <span class="hljs-literal">false</span>,</li><li>    <span class="hljs-attr">isDefaultRoute</span>: <span class="hljs-literal">false</span>,</li><li>  }],</li><li>  <span class="hljs-comment">// 配置最大传输单元值。</span></li><li>  <span class="hljs-attr">mtu</span>: <span class="hljs-number">1400</span>,</li><li>  <span class="hljs-comment">// 配置VPN使用的DNS服务器。</span></li><li>  <span class="hljs-attr">dnsAddresses</span>: [<span class="hljs-string">'223.x.x.5'</span>, <span class="hljs-string">'223.x.x.6'</span>],</li><li>  <span class="hljs-comment">// VPN生效白名单的应用。</span></li><li>  <span class="hljs-attr">trustedApplications</span>: [<span class="hljs-string">'com.test.browser'</span>],</li><li>  <span class="hljs-comment">// 不生效VPN黑名单的应用。</span></li><li>  <span class="hljs-attr">blockedApplications</span>: [<span class="hljs-string">'com.test.games'</span>],</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: vpnExtension.<span class="hljs-property">VpnExtensionContext</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">vpnCreate</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">VpnConnection</span>: vpnExtension.<span class="hljs-property">VpnConnection</span> = vpnExtension.<span class="hljs-title function_">createVpnConnection</span>(context);</li><li>  <span class="hljs-title class_">VpnConnection</span>.<span class="hljs-title function_">create</span>(vpnConfig).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"vpn create "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>  })</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="vpn-demo示例">VPN Demo示例<i class="anchor-icon anchor-icon-link" anchorid="vpn-demo示例" tips="复制节点链接"></i></h2>          <p>HarmonyOS开源项目包含一个名为<a href="https://gitcode.com/openharmony/applications_app_samples/tree/master/code/DocsSample/NetWork_Kit/NetWorkKit_NetManager/VPNControl_Case" target="_blank">VPN</a>的示例应用。此应用展示了如何设置和连接 VPN 服务。</p>    </div>   </div>   <div></div></div>