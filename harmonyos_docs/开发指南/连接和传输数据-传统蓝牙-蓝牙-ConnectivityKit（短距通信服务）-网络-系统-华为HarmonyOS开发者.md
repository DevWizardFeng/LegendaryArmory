<h1 _ngcontent-pqf-c119="" class="doc-title ng-star-inserted" title="连接和传输数据"> 连接和传输数据 </h1>

<div _ngcontent-pqf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本指南主要提供了基于串口通信协议（Serial Port Profile，SPP）实现设备间连接和传输数据的开发指导。当两个设备间进行SPP通信交互时，依据设备功能的不同，可区分为客户端与服务端，本指南将分别介绍客户端与服务端的实现方法。</p>    </div>    <div class="tiledSection">     <h2 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h2>          <p>客户端获取到服务端的设备地址后，即可向服务端特定的UUID发起连接。服务端设备地址可以通过查找设备流程获取，详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/br-discovery-development-guide">查找设备</a>。待两端连接成功后，可向服务端发送数据或者接收服务端的数据。</p>     <p>服务端需要支持客户端连接的UUID服务，保持连接状态监听即可。待两端连接成功后，即可接收客户端数据或者向客户端发送数据。</p>     <p>客户端和服务端都可以主动断开连接，应用需要根据实际场景决定由哪一端执行断开操作。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="申请蓝牙权限" class="firsth2">申请蓝牙权限<i class="anchor-icon anchor-icon-link" anchorid="申请蓝牙权限" tips="复制节点链接"></i></h3>          <p>需要申请权限ohos.permission.ACCESS_BLUETOOTH。如何配置和申请权限，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>    </div>    <div class="tiledSection">     <h3 id="导入所需api模块">导入所需API模块<i class="anchor-icon anchor-icon-link" anchorid="导入所需api模块" tips="复制节点链接"></i></h3>          <p>导入socket和错误码模块。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="客户端">客户端<i class="anchor-icon anchor-icon-link" anchorid="客户端" tips="复制节点链接"></i></h3>          <p><strong>1. 发起连接</strong></p>     <p>客户端通过查找设备流程搜索到目标设备后，即可发起连接。需要连接的UUID服务，必须与服务端创建socket时构造的UUID服务一致。在连接过程中，蓝牙子系统会去查询服务端是否支持该UUID服务，若不支持，则会连接失败。因此应用需要确保目标设备是否支持需要的UUID服务，否则发起的是无效连接。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设备地址可以通过查找设备流程获取</span></li><li><span class="hljs-keyword">let</span> peerDevice = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-comment">// 定义客户端socket id</span></li><li><span class="hljs-keyword">let</span> clientNumber = -<span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// 配置连接参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: socket.<span class="hljs-property">SppOptions</span> = {</li><li>  <span class="hljs-attr">uuid</span>: <span class="hljs-string">'00009999-0000-1000-8000-00805F9B34FB'</span>, <span class="hljs-comment">// 需要连接的服务端UUID服务，确保服务端支持</span></li><li>  <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,</li><li>  <span class="hljs-attr">type</span>: socket.<span class="hljs-property">SppType</span>.<span class="hljs-property">SPP_RFCOMM</span></li><li>};</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect '</span> + peerDevice);</li><li>socket.<span class="hljs-title function_">sppConnect</span>(peerDevice, option, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startConnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect clientNumber: '</span> + num);</li><li>    clientNumber = num;</li><li>  }</li><li>});</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect after '</span> + peerDevice);</li></ol></pre></div></div>     <p><strong>2. 传输数据</strong></p>     <p><strong>2.1 发送数据</strong></p>     <p>待客户端和服务端连接建立成功后，即可向服务端发送数据。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是客户端发起连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li><span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>data[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span>;</li><li>data[<span class="hljs-number">1</span>] = <span class="hljs-number">4</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  socket.<span class="hljs-title function_">sppWrite</span>(clientNumber, arrayBuffer);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>2.2 接收数据</strong></p>     <p>待客户端和服务端连接建立成功后，即可接收服务端的数据。通过订阅读取数据接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-socket#socketonsppread" target="_blank">socket.on('sppRead')</a>实现。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是客户端发起连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义接收数据的回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sppRead'</span>, clientNumber, read);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readData errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 断开连接</strong></p>     <p>当应用不再需要已建立的连接时，可以通过客户端主动断开连接。需要先取消读取数据的订阅，再断开连接。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是客户端发起连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义接收数据的回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 取消接收数据订阅</span></li><li>  socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sppRead'</span>, clientNumber, read);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'off sppRead errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 从client端断开连接</span></li><li>  socket.<span class="hljs-title function_">sppCloseClientSocket</span>(clientNumber);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="服务端">服务端<i class="anchor-icon anchor-icon-link" anchorid="服务端" tips="复制节点链接"></i></h3>          <p><strong>1. 创建服务端套接字</strong></p>     <p>服务端需通过创建套接字的方式，在蓝牙子系统中注册指定的UUID服务。该UUID服务的名称无限制，可使用应用名称。当客户端发起连接请求时，会携带一个UUID以表示所需连接的服务。只有服务端与客户端的UUID一致时，连接才能成功建立。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义服务端socket id</span></li><li><span class="hljs-keyword">let</span> serverNumber = -<span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// 配置监听参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: socket.<span class="hljs-property">SppOptions</span> = {</li><li>  <span class="hljs-attr">uuid</span>: <span class="hljs-string">'00009999-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,</li><li>  <span class="hljs-attr">type</span>: socket.<span class="hljs-property">SppType</span>.<span class="hljs-property">SPP_RFCOMM</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 创建服务端监听socket，将在蓝牙子系统中注册该UUID服务</span></li><li>socket.<span class="hljs-title function_">sppListen</span>(<span class="hljs-string">"demonstration"</span>, option, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppListen errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'sppListen serverNumber: '</span> + num);</li><li>    serverNumber = num;</li><li>  }</li><li>});</li></ol></pre></div></div>     <p><strong>2. 监听客户端连接</strong></p>     <p>创建好服务端套接字后，服务端即可监听连接。待收到客户端连接后，会获取到标识此次客户端的socket id，此时也表示服务端和客户端的连接已建立成功。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> serverNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是创建服务端套接字时，异步callback获取到的服务端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义客户端socket id</span></li><li><span class="hljs-keyword">let</span> clientNumber = -<span class="hljs-number">1</span>;</li><li>
</li><li>socket.<span class="hljs-title function_">sppAccept</span>(serverNumber, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'accept errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'accept clientNumber: '</span> + num);</li><li>    clientNumber = num;</li><li>  }</li><li>});</li></ol></pre></div></div>     <p><strong>3. 传输数据</strong></p>     <p><strong>3.1 发送数据</strong></p>     <p>待服务端和客户端的连接建立成功后，即可向客户端发送数据。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是服务端监听连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>data[<span class="hljs-number">0</span>] = <span class="hljs-number">9</span>;</li><li>data[<span class="hljs-number">1</span>] = <span class="hljs-number">8</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  socket.<span class="hljs-title function_">sppWrite</span>(clientNumber, arrayBuffer);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppWrite errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3.2 接收数据</strong></p>     <p>待服务端和客户端的连接建立成功后，即可接收客户端的数据。通过订阅读取数据接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-socket#socketonsppread" target="_blank">socket.on('sppRead')</a>实现。</p>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是服务端监听连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义接收数据的回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sppRead'</span>, clientNumber, read);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readData errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>4. 断开连接</strong></p>     <p>当应用不再需要已建立的连接时，可以通过服务端主动断开连接。</p>     <ul>      <li>需要先取消读取数据的订阅，再断开连接。</li>     </ul>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是服务端监听连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义接收数据的回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 取消订阅</span></li><li>  socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sppRead'</span>, clientNumber, read);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'off sppRead errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 从server断开连接</span></li><li>  socket.<span class="hljs-title function_">sppCloseClientSocket</span>(clientNumber);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>5. 删除服务端套接字</strong></p>     <p>当应用不再需要该服务端套接字时，需要主动关闭创建时获取到的套接字，蓝牙子系统会删除此前注册的UUID服务。如果此时客户端发起连接，就会连接失败。</p>     <ul>      <li>应用也可以通过删除套接字时，实现断开连接。在此之前，需要先取消读取数据的订阅。</li>     </ul>     <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> clientNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是服务端监听连接时，异步callback获取到的客户端socket id，此处是伪代码id</span></li><li><span class="hljs-keyword">let</span> serverNumber = <span class="hljs-number">1</span>; <span class="hljs-comment">// 注意：该值需要的是创建服务端套接字时，异步callback获取到的服务端socket id，此处是伪代码id</span></li><li>
</li><li><span class="hljs-comment">// 定义接收数据的回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) {</li><li>  <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 取消订阅</span></li><li>  socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sppRead'</span>, clientNumber, read);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'off sppRead errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 若应用不再需要此能力，则主动删除</span></li><li>  socket.<span class="hljs-title function_">sppCloseServerSocket</span>(serverNumber);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="客户端-1" class="firsth2">客户端<i class="anchor-icon anchor-icon-link" anchorid="客户端-1" tips="复制节点链接"></i></h3>          <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SppClientManager</span> {</li><li>  <span class="hljs-comment">// 定义客户端的socket id</span></li><li>  <span class="hljs-attr">clientNumber</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// 发起连接</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startConnect</span>(<span class="hljs-attr">peerDevice</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// 配置连接参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: socket.<span class="hljs-property">SppOptions</span> = {</li><li>      <span class="hljs-attr">uuid</span>: <span class="hljs-string">'00009999-0000-1000-8000-00805F9B34FB'</span>, <span class="hljs-comment">// 需要连接的服务端UUID服务，确保服务端支持</span></li><li>      <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-attr">type</span>: socket.<span class="hljs-property">SppType</span>.<span class="hljs-property">SPP_RFCOMM</span></li><li>    };</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect '</span> + peerDevice);</li><li>    socket.<span class="hljs-title function_">sppConnect</span>(peerDevice, option, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startConnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect clientNumber: '</span> + num);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> = num;</li><li>      }</li><li>    });</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startConnect after '</span> + peerDevice);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 发送数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">sendData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'sendData '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>    data[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span>;</li><li>    data[<span class="hljs-number">1</span>] = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      socket.<span class="hljs-title function_">sppWrite</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, arrayBuffer);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppWrite errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 定义接收数据的回调函数</span></li><li>  read = <span class="hljs-function">(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 接收数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">readData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 发起订阅</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sppRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">read</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readData errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 断开连接</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stopConnect</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'closeSppClient '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 取消接收数据订阅</span></li><li>      socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sppRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">read</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'off sppRead errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 从client端断开连接</span></li><li>      socket.<span class="hljs-title function_">sppCloseClientSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'stopConnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> sppClientManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SppClientManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> sppClientManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">SppClientManager</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="服务端-1">服务端<i class="anchor-icon anchor-icon-link" anchorid="服务端-1" tips="复制节点链接"></i></h3>          <div _ngcontent-pqf-c106="" class="highlight-div"><div _ngcontent-pqf-c106="" class="highlight-div-header"><div _ngcontent-pqf-c106="" class="highlight-div-header-left"><div _ngcontent-pqf-c106="" class="handle-button expand-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pqf-c106="" class="highlight-div-header-right"><div _ngcontent-pqf-c106="" class="handle-button ai-button"></div><div _ngcontent-pqf-c106="" class="handle-button line-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pqf-c106="" class="handle-button theme-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pqf-c106="" class="handle-button copy-button"><div _ngcontent-pqf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pqf-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { socket } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SppServerManager</span> {</li><li>  <span class="hljs-attr">serverNumber</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-attr">clientNumber</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// 创建服务端监听socket</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startListen</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'startListen'</span>);</li><li>
</li><li>    <span class="hljs-comment">// 配置监听参数</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">option</span>: socket.<span class="hljs-property">SppOptions</span> = {</li><li>      <span class="hljs-attr">uuid</span>: <span class="hljs-string">'00009999-0000-1000-8000-00805F9B34FB'</span>,</li><li>      <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-attr">type</span>: socket.<span class="hljs-property">SppType</span>.<span class="hljs-property">SPP_RFCOMM</span></li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 创建服务端监听socket，将在蓝牙子系统中注册该UUID服务</span></li><li>    socket.<span class="hljs-title function_">sppListen</span>(<span class="hljs-string">"demonstration"</span>, option, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppListen errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'sppListen serverNumber: '</span> + num);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span> = num;</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 监听连接请求，等待连接</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">accept</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'accept '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span> == -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid serverNumber'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    socket.<span class="hljs-title function_">sppAccept</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span>, <span class="hljs-function">(<span class="hljs-params">err, num: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'accept errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'accept clientNumber: '</span> + num);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> = num;</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 发送数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">sendData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'sendData serverNumber: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span> + <span class="hljs-string">' clientNumber: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>    data[<span class="hljs-number">0</span>] = <span class="hljs-number">9</span>;</li><li>    data[<span class="hljs-number">1</span>] = <span class="hljs-number">8</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      socket.<span class="hljs-title function_">sppWrite</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, arrayBuffer);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppWrite errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 定义接收数据的回调函数</span></li><li>  read = <span class="hljs-function">(<span class="hljs-params">dataBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(dataBuffer);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'client data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 接收数据</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">readData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 发起订阅</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sppRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">read</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readData errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 停止连接</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stopConnect</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'stopConnect'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 取消订阅</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span> == -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid clientNumber'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sppRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">read</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'off sppRead errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 从server断开连接</span></li><li>      socket.<span class="hljs-title function_">sppCloseClientSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">clientNumber</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'stopConnect errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 删除能力</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">closeSppServer</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'closeSppServer'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 若应用不再需要此能力，则主动删除</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span> == -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'invalid serverNumber'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      socket.<span class="hljs-title function_">sppCloseServerSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverNumber</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sppCloseServerSocket errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> sppServerManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SppServerManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> sppServerManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">SppServerManager</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>