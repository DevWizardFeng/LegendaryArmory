<h1 _ngcontent-lvc-c119="" class="doc-title ng-star-inserted" title="连接和传输数据"> 连接和传输数据 </h1>

<div _ngcontent-lvc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本指南主要提供了基于通用属性协议（Generic Attribute Profile，GATT）实现BLE设备间连接和传输数据的开发指导。当两个设备间进行GATT通信交互时，依据设备功能的不同，可区分为GATT客户端和GATT服务端，本指南将分别介绍客户端与服务端的实现方法。</p>     <p>GATT是低功耗蓝牙（BLE）的核心协议，定义了基于服务（Service）、特征值（Characteristic）和描述符（Descriptor）进行蓝牙通信和传输数据的机制。相关术语介绍请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/terminology">Connectivity Kit术语</a>。</p>    </div>    <div class="tiledSection">     <h2 id="实现原理">实现原理<i class="anchor-icon anchor-icon-link" anchorid="实现原理" tips="复制节点链接"></i></h2>          <p>客户端获取到服务端的设备地址后，即可向服务端发起连接。服务端设备地址可以通过BLE扫描流程获取。待两端连接成功后，即可向服务端发起服务查询、读写特征值和接收通知等操作，从而实现向服务端发送数据或者接收服务端数据的功能。</p>     <p>服务端需要发送BLE广播才能被客户端发现。服务端需要支持客户端需要连接的服务，等待客户端的连接请求即可。待两端连接成功后，即可接收客户端的读写特征值和发送通知等操作，从而实现接收客户端数据或者向客户端发送数据的功能。</p>     <p>客户端的BLE扫描和服务端的BLE广播流程，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ble-development-guide">查找设备</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="申请蓝牙权限" class="firsth2">申请蓝牙权限<i class="anchor-icon anchor-icon-link" anchorid="申请蓝牙权限" tips="复制节点链接"></i></h3>          <p>需要申请权限ohos.permission.ACCESS_BLUETOOTH。如何配置和申请权限，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>    </div>    <div class="tiledSection">     <h3 id="导入所需api模块">导入所需API模块<i class="anchor-icon anchor-icon-link" anchorid="导入所需api模块" tips="复制节点链接"></i></h3>          <p>导入ble、constant和错误码模块。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble, constant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="客户端">客户端<i class="anchor-icon anchor-icon-link" anchorid="客户端" tips="复制节点链接"></i></h3>          <p><strong>1. 创建客户端实例</strong></p>     <p>客户端通过查找设备流程搜索到目标设备后，即可构造客户端实例，后续所有操作都基于该客户端实例。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>2. 订阅连接状态变化事件</strong></p>     <p>通过订阅连接状态变化事件，可以获取实时的GATT连接状态。整个连接过程会涉及多种状态的跃迁，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_CONNECTED</a>表示已连接，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_DISCONNECTED</a>表示已断连。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">clientConnectStateChanged</span>(<span class="hljs-params">state: ble.BLEConnectionChangeState</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth connect state changed'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">connectState</span>: ble.<span class="hljs-property">ProfileConnectionState</span> = state.<span class="hljs-property">state</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>  gattClient.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEConnectionStateChange'</span>, clientConnectStateChanged);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 发起连接</strong></p>     <p>通过创建的客户端实例，直接发起连接即可。通过连接状态变化事件判断是否已连接成功。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>    gattClient.<span class="hljs-title function_">connect</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>4. 服务发现</strong></p>     <p>服务发现是获取服务端支持的所有服务能力集合的过程。客户端需要根据服务发现结果，判断服务端是否存在应用需要的服务能力。</p>     <ul>      <li>后续的读写特征值、读写描述符等操作都需要在服务发现操作完成后进行，否则会失败。</li>      <li>后续的读写等操作中指定的特征值或描述符必须包含在服务能力集合中，否则会失败。</li>     </ul>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>  <span class="hljs-comment">// 此处是伪代码，需要连接上后，才可以调用</span></li><li>  gattClient.<span class="hljs-title function_">getServices</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">Array</span>&lt;ble.GattService&gt;</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'getServices successfully:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>5. 传输数据</strong></p>     <p>传输数据通过操作服务端的特征值或者描述符实现。</p>     <p><strong>5.1 读取或写入特征值</strong></p>     <p>读取特征值操作，可以获取服务端特征值的数据内容。</p>     <p>写入特征值操作，可以更新服务端特征值的数据内容。</p>     <p>相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readcharacteristicvalue" target="_blank">readCharacteristicValue</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue</a>。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptors</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLEDescriptor</span>&gt; = [];</li><li><span class="hljs-keyword">let</span> bufferDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> descV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferDesc);</li><li>descV[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-string">'00008888-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorValue</span>: bufferDesc</li><li>};</li><li>descriptors[<span class="hljs-number">0</span>] = descriptor;</li><li><span class="hljs-keyword">let</span> bufferCCC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> cccV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferCCC);</li><li>cccV[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">characteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicValue</span>: bufferCCC,</li><li>  <span class="hljs-attr">descriptors</span>:descriptors</li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>
</li><li><span class="hljs-comment">// 读取特征值</span></li><li><span class="hljs-keyword">try</span> {</li><li>  gattClient.<span class="hljs-title function_">readCharacteristicValue</span>(characteristic).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">outData: ble.BLECharacteristic</span>) =&gt;</span> {</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 写入特征值</span></li><li><span class="hljs-keyword">try</span> {</li><li>  gattClient.<span class="hljs-title function_">writeCharacteristicValue</span>(characteristic, ble.<span class="hljs-property">GattWriteType</span>.<span class="hljs-property">WRITE</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'writeCharacteristicValue success'</span>);</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>5.2 读取或写入描述符</strong></p>     <p>读取描述符操作，可以获取服务端描述符的数据内容。</p>     <p>写入描述符操作，可以更新服务端描述符的数据内容。</p>     <p>相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readdescriptorvalue" target="_blank">readDescriptorValue</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue</a>。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li><span class="hljs-keyword">let</span> bufferDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> descV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferDesc);</li><li>descV[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-string">'00008888-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorValue</span>: bufferDesc</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>
</li><li><span class="hljs-comment">// 读取描述符</span></li><li><span class="hljs-keyword">try</span> {</li><li>  gattClient.<span class="hljs-title function_">readDescriptorValue</span>(descriptor).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">outData: ble.BLEDescriptor</span>) =&gt;</span> {</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 写入描述符</span></li><li><span class="hljs-keyword">try</span> {</li><li>  gattClient.<span class="hljs-title function_">writeDescriptorValue</span>(descriptor, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>5.3 接收服务端特征值变化通知或指示</strong></p>     <p>当服务端特征值的数据内容发生变化时，客户端可以通过接收服务端的特征值变化通知或者指示来实现更新数据。该服务端特征值需包含蓝牙标准协议定义的Client Characteristic Configuration描述符UUID（00002902-0000-1000-8000-00805f9b34fb），才能支持通知或者指示能力。</p>     <p>客户端收到服务端通知时，不需要回复确认；客户端收到服务端指示时，需要回复确认，蓝牙子系统会实现该操作，应用无需关注。</p>     <ul>      <li>先订阅服务端特征值变化事件，详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onblecharacteristicchange" target="_blank">on('BLECharacteristicChange')</a>。</li>      <li>再使能服务端特征值变化通知或者指示能力，应用根据实际场景选择一种方式即可。相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication</a>。</li>     </ul>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-comment">// 定义服务端特征值变化事件</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">characteristicChange</span>(<span class="hljs-params">characteristicChangeReq: ble.BLECharacteristic</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">serviceUuid</span>: <span class="hljs-built_in">string</span> = characteristicChangeReq.<span class="hljs-property">serviceUuid</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-built_in">string</span> = characteristicChangeReq.<span class="hljs-property">characteristicUuid</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(characteristicChangeReq.<span class="hljs-property">characteristicValue</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptors</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLEDescriptor</span>&gt; = [];</li><li><span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> descV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>descV[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-string">'00002902-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorValue</span>: arrayBuffer</li><li>};</li><li>descriptors[<span class="hljs-number">0</span>] = descriptor;</li><li><span class="hljs-keyword">let</span> arrayBufferC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">characteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicValue</span>: arrayBufferC,</li><li>  <span class="hljs-attr">descriptors</span>:descriptors</li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li>
</li><li><span class="hljs-comment">// 发起订阅</span></li><li><span class="hljs-keyword">try</span> {</li><li>    gattClient.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLECharacteristicChange'</span>, characteristicChange);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 通知和指示，2选1即可</span></li><li><span class="hljs-comment">// 设置特征值变化通知能力</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// enable入参: true表示启用，false表示禁用</span></li><li>  gattClient.<span class="hljs-title function_">setCharacteristicChangeNotification</span>(characteristic, <span class="hljs-literal">true</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'setCharacteristicChangeNotification callback failed'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setCharacteristicChangeNotification callback successful'</span>);</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 设置特征值变化指示能力</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// enable入参: true表示启用，false表示禁用</span></li><li>  gattClient.<span class="hljs-title function_">setCharacteristicChangeIndication</span>(characteristic, <span class="hljs-literal">true</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'setCharacteristicChangeIndication callback failed'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setCharacteristicChangeIndication callback successful'</span>);</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>6. 断开连接</strong></p>     <p>当应用不再需要已建立的连接时，需主动断开连接。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 此处是伪代码</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(device);</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起断连</span></li><li>  gattClient.<span class="hljs-title function_">disconnect</span>();</li><li>
</li><li>  <span class="hljs-comment">// 如果应用不再使用此gattClient，则需要close，gattClient实例将不能再使用</span></li><li>  gattClient.<span class="hljs-title function_">close</span>()</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="服务端">服务端<i class="anchor-icon anchor-icon-link" anchorid="服务端" tips="复制节点链接"></i></h3>          <p><strong>1. 创建服务端实例</strong></p>     <p>构造服务端实例，后续所有操作都基于该服务端实例。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>2. 添加服务</strong></p>     <p>添加应用需要的服务，将在蓝牙子系统中注册指定的UUID服务。客户端会发起服务查询，判断服务端是否支持特定的服务。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建descriptors</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptors</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLEDescriptor</span>&gt; = [];</li><li><span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> descV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);</li><li>descV[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-string">'00002902-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">descriptorValue</span>: arrayBuffer};</li><li>descriptors[<span class="hljs-number">0</span>] = descriptor;</li><li>
</li><li><span class="hljs-comment">// 创建characteristics</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">characteristics</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLECharacteristic</span>&gt; = [];</li><li><span class="hljs-keyword">let</span> arrayBufferC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> cccV = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBufferC);</li><li>cccV[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">characteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicValue</span>: arrayBufferC,</li><li>  <span class="hljs-attr">descriptors</span>:descriptors</li><li>};</li><li>characteristics[<span class="hljs-number">0</span>] = characteristic;</li><li>
</li><li><span class="hljs-comment">// 创建gattService</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattService</span>: ble.<span class="hljs-property">GattService</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>:<span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">isPrimary</span>: <span class="hljs-literal">true</span>,</li><li>  <span class="hljs-attr">characteristics</span>:characteristics,</li><li>  <span class="hljs-attr">includeServices</span>:[]</li><li>};</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>  gattServer.<span class="hljs-title function_">addService</span>(gattService);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>3. 订阅连接状态变化事件</strong></p>     <p>通过订阅连接状态变化事件，可以获取实时的GATT连接状态以及客户端的设备地址。整个连接过程涉及多种状态的跃迁，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_CONNECTED</a>表示已连接，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_DISCONNECTED</a>表示已断连。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerConnectStateChanged</span>(<span class="hljs-params">state: ble.BLEConnectionChangeState</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'bluetooth connect state changed'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">connectState</span>: ble.<span class="hljs-property">ProfileConnectionState</span> = state.<span class="hljs-property">state</span>;</li><li>  <span class="hljs-keyword">let</span> device = state.<span class="hljs-property">deviceId</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>  gattServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-title class_">ServerConnectStateChanged</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>4. 传输数据</strong></p>     <p>传输数据可以通过客户端读写特征值数据内容、读写描述符数据内容、主动发送特征值数据内容变化通知或指示实现。</p>     <p><strong>4.1 订阅特征值读取或写入事件</strong></p>     <p>通过订阅特征值读取或写入事件，获取客户端的操作请求，相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#oncharacteristicread" target="_blank">on('characteristicRead')</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#oncharacteristicwrite" target="_blank">on('characteristicWrite')</a>。</p>     <ul>      <li>收到读取特征值请求时，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#sendresponse" target="_blank">sendResponse</a>进行回复对应特征值的数据内容。</li>      <li>收到写入特征值请求时，可保存客户端写入的特征值数据内容。根据写入请求<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#characteristicwriterequest" target="_blank">CharacteristicWriteRequest</a>的needRsp判断是否需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#sendresponse" target="_blank">sendResponse</a>进行回复。</li>     </ul>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li><span class="hljs-keyword">let</span> arrayBufferCCC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> cccValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBufferCCC);</li><li>cccValue[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-comment">// 定义特征值读取回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">readCharacteristicReq</span>(<span class="hljs-params">characteristicReadRequest: ble.CharacteristicReadRequest</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = characteristicReadRequest.<span class="hljs-property">deviceId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = characteristicReadRequest.<span class="hljs-property">transId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = characteristicReadRequest.<span class="hljs-property">offset</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-built_in">string</span> = characteristicReadRequest.<span class="hljs-property">characteristicUuid</span>;</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>    <span class="hljs-attr">deviceId</span>: deviceId,</li><li>    <span class="hljs-attr">transId</span>: transId,</li><li>    <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">offset</span>: offset,</li><li>    <span class="hljs-attr">value</span>:arrayBufferCCC <span class="hljs-comment">// 传入服务端对应特征值的数据内容，此处是伪代码</span></li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    gattServer.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义特征值写入回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeCharacteristicReq</span>(<span class="hljs-params">characteristicWriteRequest: ble.CharacteristicWriteRequest</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = characteristicWriteRequest.<span class="hljs-property">deviceId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = characteristicWriteRequest.<span class="hljs-property">transId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = characteristicWriteRequest.<span class="hljs-property">offset</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">needRsp</span>: <span class="hljs-built_in">boolean</span> = characteristicWriteRequest.<span class="hljs-property">needRsp</span>;</li><li>  <span class="hljs-keyword">if</span> (!needRsp) { <span class="hljs-comment">// 判断是否需要回复客户端</span></li><li>      <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">Uint8Array</span> =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(characteristicWriteRequest.<span class="hljs-property">value</span>); <span class="hljs-comment">// 可保存写入的数据内容</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-built_in">string</span> = characteristicWriteRequest.<span class="hljs-property">characteristicUuid</span>;</li><li>  cccValue[<span class="hljs-number">0</span>] = value[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>    <span class="hljs-attr">deviceId</span>: deviceId,</li><li>    <span class="hljs-attr">transId</span>: transId,</li><li>    <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">offset</span>: offset,</li><li>    <span class="hljs-attr">value</span>:arrayBufferCCC</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    gattServer.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 订阅特征值读取事件</span></li><li>gattServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicRead'</span>, readCharacteristicReq);</li><li>
</li><li><span class="hljs-comment">// 订阅特征值写入事件</span></li><li>gattServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicWrite'</span>, writeCharacteristicReq);</li></ol></pre></div></div>     <p><strong>4.2 订阅描述符读取或写入事件</strong></p>     <p>通过订阅描述符读取或写入事件，获取客户端的操作请求，相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#ondescriptorread" target="_blank">on('descriptorRead')</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#ondescriptorwrite" target="_blank">on('descriptorWrite')</a>。</p>     <ul>      <li>收到读取描述符请求时，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#sendresponse" target="_blank">sendResponse</a>进行回复对应描述符的数据内容。</li>      <li>收到写入描述符请求时，可保存客户端写入的描述符数据内容。根据写入请求<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#descriptorwriterequest" target="_blank">DescriptorWriteRequest</a>的needRsp判断是否需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#sendresponse" target="_blank">sendResponse</a>进行回复。</li>     </ul>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>
</li><li><span class="hljs-comment">// 定义描述符读取回调函数</span></li><li><span class="hljs-keyword">let</span> arrayBufferDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> descValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBufferDesc);</li><li>descValue[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">readDescriptorReq</span>(<span class="hljs-params">descriptorReadRequest: ble.DescriptorReadRequest</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = descriptorReadRequest.<span class="hljs-property">deviceId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = descriptorReadRequest.<span class="hljs-property">transId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = descriptorReadRequest.<span class="hljs-property">offset</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-built_in">string</span> = descriptorReadRequest.<span class="hljs-property">descriptorUuid</span>;</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>    <span class="hljs-attr">deviceId</span>: deviceId,</li><li>    <span class="hljs-attr">transId</span>: transId,</li><li>    <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">offset</span>: offset,</li><li>    <span class="hljs-attr">value</span>:arrayBufferDesc</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    gattServer.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义描述符写入回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeDescriptorReq</span>(<span class="hljs-params">descriptorWriteRequest: ble.DescriptorWriteRequest</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = descriptorWriteRequest.<span class="hljs-property">deviceId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = descriptorWriteRequest.<span class="hljs-property">transId</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = descriptorWriteRequest.<span class="hljs-property">offset</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isPrepared</span>: <span class="hljs-built_in">boolean</span> = descriptorWriteRequest.<span class="hljs-property">isPrepared</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">needRsp</span>: <span class="hljs-built_in">boolean</span> = descriptorWriteRequest.<span class="hljs-property">needRsp</span>;</li><li>  <span class="hljs-keyword">if</span> (!needRsp) { <span class="hljs-comment">// 判断是否需要回复客户端</span></li><li>      <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(descriptorWriteRequest.<span class="hljs-property">value</span>); <span class="hljs-comment">// 可保存写入的数据内容</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptorUuid</span>: <span class="hljs-built_in">string</span> = descriptorWriteRequest.<span class="hljs-property">descriptorUuid</span>;</li><li>  descValue[<span class="hljs-number">0</span>] = value[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>    <span class="hljs-attr">deviceId</span>: deviceId,</li><li>    <span class="hljs-attr">transId</span>: transId,</li><li>    <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">offset</span>: offset,</li><li>    <span class="hljs-attr">value</span>:arrayBufferDesc</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    gattServer.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 订阅描述符读取事件</span></li><li>gattServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorRead'</span>, readDescriptorReq);</li><li>
</li><li><span class="hljs-comment">// 订阅描述符写入事件</span></li><li>gattServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorWrite'</span>, writeDescriptorReq);</li></ol></pre></div></div>     <p><strong>4.3 发送特征值变化通知或指示</strong></p>     <p>当服务端的特征值数据内容发生变化时，可以通过通知或者指示主动知会到客户端，相关API请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristicchanged" target="_blank">notifyCharacteristicChanged</a>。</p>     <p>发送通知时，不需要客户端回复确认；发送指示时，需要客户端回复确认。应用根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristic" target="_blank">NotifyCharacteristic</a>的confirm参数决定发送哪种类型。</p>     <ul>      <li>该特征值需包含蓝牙标准协议定义的Client Characteristic Configuration描述符UUID（00002902-0000-1000-8000-00805f9b34fb），才支持通知或者指示能力。</li>      <li>使用通知或者指示能力需要使能。客户端可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication</a>使能该能力，应用根据实际场景选择一种方式即可。</li>     </ul>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>; <span class="hljs-comment">// 该设备地址表示客户端地址，可以通过连接状态变化事件中获取</span></li><li><span class="hljs-keyword">let</span> arrayBufferC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">notifyCharacter</span>: ble.<span class="hljs-property">NotifyCharacteristic</span> = {</li><li>  <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>  <span class="hljs-attr">characteristicValue</span>: arrayBufferC,</li><li>  <span class="hljs-attr">confirm</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 决定发送通知还是指示</span></li><li>};</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>  <span class="hljs-comment">// 发送变更通知或指示</span></li><li>  gattServer.<span class="hljs-title function_">notifyCharacteristicChanged</span>(device, notifyCharacter, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'notifyCharacteristicChanged callback failed'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'notifyCharacteristicChanged callback successful'</span>);</li><li>    }</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p><strong>5. 关闭服务端实例</strong></p>     <p>当应用不再需要创建的服务端实例时，需要主动关闭，并释放相关资源。例如：删除已添加的服务，取消已订阅事件。</p>     <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>();</li><li>  gattServer.<span class="hljs-title function_">removeService</span>(<span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>); <span class="hljs-comment">// 删除此前注册的服务</span></li><li>  gattServer.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 应用不再使用此gattServer，则需要close</span></li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="客户端-1" class="firsth2">客户端<i class="anchor-icon anchor-icon-link" anchorid="客户端-1" tips="复制节点链接"></i></h3>          <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble, constant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'GattClientManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GattClientManager</span> {</li><li>  <span class="hljs-attr">device</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">gattClient</span>: ble.<span class="hljs-property">GattClientDevice</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">connectState</span>: ble.<span class="hljs-property">ProfileConnectionState</span> = constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_DISCONNECTED</span>;</li><li>  <span class="hljs-attr">myServiceUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-attr">myCharacteristicUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-comment">// 标准协议描述符Client Characteristic Configuration，用于特征值变化通知或指示</span></li><li>  <span class="hljs-attr">myFirstDescriptorUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00002902-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-comment">// 自定义描述符</span></li><li>  <span class="hljs-attr">mySecondDescriptorUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00008888-0000-1000-8000-00805F9B34FB'</span>;</li><li>
</li><li>  <span class="hljs-attr">myService</span>: ble.<span class="hljs-property">GattService</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">myCharacteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">myFirstDescriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">mySecondDescriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>
</li><li>  <span class="hljs-attr">foundService</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">foundChar</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">foundFirstDes</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">foundSecondDes</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-comment">// 构造BLEDescriptor</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initDescriptor</span>(<span class="hljs-attr">des</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-title class_">ArrayBuffer</span>): ble.<span class="hljs-property">BLEDescriptor</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>      <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>,</li><li>      <span class="hljs-attr">descriptorUuid</span>: des,</li><li>      <span class="hljs-attr">descriptorValue</span>: value</li><li>    };</li><li>    <span class="hljs-keyword">return</span> descriptor;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 构造BLECharacteristic</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initCharacteristic</span>(<span class="hljs-attr">isWrite</span>: <span class="hljs-built_in">boolean</span>): ble.<span class="hljs-property">BLECharacteristic</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptors</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLEDescriptor</span>&gt; = [];</li><li>    <span class="hljs-keyword">let</span> charBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">if</span> (isWrite) {</li><li>      <span class="hljs-keyword">let</span> charValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(charBuffer);</li><li>      charValue[<span class="hljs-number">0</span>] = <span class="hljs-number">21</span>;</li><li>      charValue[<span class="hljs-number">1</span>] = <span class="hljs-number">22</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>      <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>,</li><li>      <span class="hljs-attr">characteristicValue</span>: charBuffer,</li><li>      <span class="hljs-attr">descriptors</span>: descriptors</li><li>    };</li><li>    <span class="hljs-keyword">return</span> characteristic;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">logCharacteristic</span>(<span class="hljs-params">char: ble.BLECharacteristic</span>) {</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-string">'logCharacteristic uuid:'</span> + char.<span class="hljs-property">characteristicUuid</span> + <span class="hljs-string">', value: '</span>;</li><li>    <span class="hljs-keyword">let</span> value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(char.<span class="hljs-property">characteristicValue</span>);</li><li>    message += <span class="hljs-string">'logCharacteristic value: '</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; char.<span class="hljs-property">characteristicValue</span>.<span class="hljs-property">byteLength</span>; i++) {</li><li>      message += value[i] + <span class="hljs-string">' '</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, message);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">logDescriptor</span>(<span class="hljs-params">des: ble.BLEDescriptor</span>) {</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-string">'logDescriptor uuid:'</span> + des.<span class="hljs-property">descriptorUuid</span> + <span class="hljs-string">', value: '</span>;</li><li>    <span class="hljs-keyword">let</span> value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(des.<span class="hljs-property">descriptorValue</span>);</li><li>    message += <span class="hljs-string">'logDescriptor value: '</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; des.<span class="hljs-property">descriptorValue</span>.<span class="hljs-property">byteLength</span>; i++) {</li><li>      message += value[i] + <span class="hljs-string">' '</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, message);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkService</span>(<span class="hljs-params">services: <span class="hljs-built_in">Array</span>&lt;ble.GattService&gt;</span>) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; services.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">if</span> (services[i].<span class="hljs-property">serviceUuid</span> != <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>) {</li><li>        <span class="hljs-keyword">continue</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">myService</span> = services[i];</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundService</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; services[i].<span class="hljs-property">characteristics</span>.<span class="hljs-property">length</span>; j++) {</li><li>        <span class="hljs-keyword">if</span> (services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">characteristicUuid</span> != <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>) {</li><li>          <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logCharacteristic</span>(services[i].<span class="hljs-property">characteristics</span>[j]);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span> = services[i].<span class="hljs-property">characteristics</span>[j];</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundChar</span> = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">descriptors</span>.<span class="hljs-property">length</span>; k++) {</li><li>          <span class="hljs-keyword">if</span> (services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">descriptors</span>[k].<span class="hljs-property">descriptorUuid</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptorUuid</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptor</span>= services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">descriptors</span>[k];</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundFirstDes</span> = <span class="hljs-literal">true</span>;</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">descriptors</span>[k].<span class="hljs-property">descriptorUuid</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptorUuid</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptor</span> = services[i].<span class="hljs-property">characteristics</span>[j].<span class="hljs-property">descriptors</span>[k];</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundSecondDes</span> = <span class="hljs-literal">true</span>;</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'foundService: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundService</span> + <span class="hljs-string">', foundChar: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundChar</span> +</li><li>      <span class="hljs-string">', foundFirDes: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundFirstDes</span> + <span class="hljs-string">', foundSecDes: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">foundSecondDes</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 1. 定义连接状态变化回调函数</span></li><li>  onGattClientStateChange = <span class="hljs-function">(<span class="hljs-params">stateInfo: ble.BLEConnectionChangeState</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> state = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">switch</span> (stateInfo.<span class="hljs-property">state</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:</li><li>        state = <span class="hljs-string">'DISCONNECTED'</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</li><li>        state = <span class="hljs-string">'CONNECTING'</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:</li><li>        state = <span class="hljs-string">'CONNECTED'</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:</li><li>        state = <span class="hljs-string">'DISCONNECTING'</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        state = <span class="hljs-string">'undefined'</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onGattClientStateChange: device='</span> + stateInfo.<span class="hljs-property">deviceId</span> + <span class="hljs-string">', state='</span> + state);</li><li>    <span class="hljs-keyword">if</span> (stateInfo.<span class="hljs-property">deviceId</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> = stateInfo.<span class="hljs-property">state</span>;</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 2. client端主动连接时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startConnect</span>(<span class="hljs-params">peerDevice: <span class="hljs-built_in">string</span></span>) { <span class="hljs-comment">// 对端设备一般通过ble查找设备获取到</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_DISCONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'startConnect failed'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'startConnect '</span> + peerDevice);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span> = peerDevice;</li><li>    <span class="hljs-comment">// 2.1 使用device构造gattClient，后续的交互都需要使用该实例</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> = ble.<span class="hljs-title function_">createGattClientDevice</span>(peerDevice);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 2.2 订阅连接状态</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEConnectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onGattClientStateChange</span>);</li><li>
</li><li>      <span class="hljs-comment">// 2.3 发起连接</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">connect</span>();</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 3. client端连接成功后，需要进行服务发现</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">discoverServices</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'discoverServices'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> serverService = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">getServices</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkService</span>(serverService); <span class="hljs-comment">// 要确保server端的服务内容有业务所需要的服务</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">myService</span> !== <span class="hljs-string">'undefined'</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Service: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myService</span>));</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span> !== <span class="hljs-string">'undefined'</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logCharacteristic</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptor</span> !== <span class="hljs-string">'undefined'</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptor</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptor</span> !== <span class="hljs-string">'undefined'</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptor</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 4. 在确保拿到了server端的服务结果后，读取server端特定服务的特征值时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">readCharacteristicValue</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundChar</span>) { <span class="hljs-comment">// 要确保server端有对应的characteristic</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server characteristic does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> characteristic = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCharacteristic</span>(<span class="hljs-literal">false</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'readCharacteristicValue'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">readCharacteristicValue</span>(characteristic).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">outData: ble.BLECharacteristic</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span> = outData;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logCharacteristic</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 5. 在确保拿到了server端的服务结果后，写入server端特定服务的特征值时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">writeCharacteristicValue</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundChar</span>) { <span class="hljs-comment">// 要确保server端有对应的characteristic</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server characteristic does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> characteristic = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCharacteristic</span>(<span class="hljs-literal">true</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'writeCharacteristicValue'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">writeCharacteristicValue</span>(characteristic, ble.<span class="hljs-property">GattWriteType</span>.<span class="hljs-property">WRITE</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'writeCharacteristicValue success'</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 6. 在确保拿到了server端的服务结果后，读取server端特定服务的描述符时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">readDescriptorValue</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundSecondDes</span>) { <span class="hljs-comment">// 要确保server端有对应的descriptor</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server descriptor does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> descBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">let</span> descriptor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptorUuid</span>, descBuffer);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'readDescriptorValue'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">readDescriptorValue</span>(descriptor).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">outData: ble.BLEDescriptor</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logDescriptor</span>(outData);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 7. 在确保拿到了server端的服务结果后，写入server端特定服务的描述符时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">writeDescriptorValue</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundSecondDes</span>) { <span class="hljs-comment">// 要确保server端有对应的descriptor</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server descriptor does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> descBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> descValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(descBuffer);</li><li>    descValue[<span class="hljs-number">0</span>] = <span class="hljs-number">41</span>;</li><li>    descValue[<span class="hljs-number">1</span>] = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-keyword">let</span> descriptor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptorUuid</span>, descBuffer);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'writeDescriptorValue'</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">writeDescriptorValue</span>(descriptor, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'writeDescriptorValue success'</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 8. 定义特征值变化回调函数</span></li><li>  onCharacteristicChange = <span class="hljs-function">(<span class="hljs-params">char: ble.BLECharacteristic</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onCharacteristicChange: uuid: '</span> + char.<span class="hljs-property">characteristicUuid</span> + <span class="hljs-string">', value: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(char.<span class="hljs-property">characteristicValue</span>)));</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span> = char;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logCharacteristic</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 9. 使能或禁用接收服务端端特征值内容变更通知的能力时调用，一般通知或者指示，二选一</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title class_">Notify</span>(<span class="hljs-attr">enable</span>: <span class="hljs-built_in">boolean</span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundFirstDes</span>) { <span class="hljs-comment">// 要确保server端有对应的client configuration descriptor</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server client configuration descriptor does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Notify '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span> + <span class="hljs-string">' enable: '</span> + enable);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 订阅特征值变化</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLECharacteristicChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicChange</span>);</li><li>      <span class="hljs-comment">// 设置特征值变化通知能力，enable: true表示启用，false表示禁用</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">setCharacteristicChangeNotification</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span>, enable, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'setCharacteristicChangeNotification callback failed'</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setCharacteristicChangeNotification callback successful'</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 10. 使能或禁用接收服务端端特征值内容变更指示的能力时调用，一般通知或者指示，二选一</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title class_">Indicate</span>(<span class="hljs-attr">enable</span>: <span class="hljs-built_in">boolean</span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">foundFirstDes</span>) { <span class="hljs-comment">// 要确保server端有对应的client configuration descriptor</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'server client configuration descriptor does not exist'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Indicate '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span> + <span class="hljs-string">' enable: '</span> + enable);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 订阅特征值变化</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLECharacteristicChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicChange</span>);</li><li>      <span class="hljs-comment">// 设置特征值变化指示能力，enable: true表示启用，false表示禁用</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">setCharacteristicChangeIndication</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristic</span>, enable, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'setCharacteristicChangeIndication callback failed'</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setCharacteristicChangeIndication callback successful'</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 11.client端主动断开时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">stopConnect</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectState</span> != constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'gattClient does not exist or state not connected'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'stopConnect '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// 11.1 断开连接</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'BLEConnectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onGattClientStateChange</span>); <span class="hljs-comment">// 11.2 取消订阅连接状态</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'BLECharacteristicChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicChange</span>); <span class="hljs-comment">// 11.3 取消订阅特征值变化</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattClient</span>.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 11.4 如果应用不再使用此gattClient，则需要close</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> gattClientManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GattClientManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gattClientManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">GattClientManager</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="服务端-1">服务端<i class="anchor-icon anchor-icon-link" anchorid="服务端-1" tips="复制节点链接"></i></h3>          <div _ngcontent-lvc-c106="" class="highlight-div"><div _ngcontent-lvc-c106="" class="highlight-div-header"><div _ngcontent-lvc-c106="" class="highlight-div-header-left"><div _ngcontent-lvc-c106="" class="handle-button expand-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lvc-c106="" class="highlight-div-header-right"><div _ngcontent-lvc-c106="" class="handle-button ai-button"></div><div _ngcontent-lvc-c106="" class="handle-button line-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lvc-c106="" class="handle-button theme-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lvc-c106="" class="handle-button copy-button"><div _ngcontent-lvc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lvc-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { ble, constant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'GattServerManager'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GattServerManager</span> {</li><li>  device = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">gattServer</span>: ble.<span class="hljs-property">GattServer</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-attr">connectState</span>: ble.<span class="hljs-property">ProfileConnectionState</span> = constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_DISCONNECTED</span>;</li><li>  <span class="hljs-attr">myServiceUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-attr">myCharacteristicUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-comment">// 标准协议描述符Client Characteristic Configuration，用于特征值变化通知或指示</span></li><li>  <span class="hljs-attr">myFirstDescriptorUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00002902-0000-1000-8000-00805F9B34FB'</span>;</li><li>  <span class="hljs-comment">// 自定义描述符</span></li><li>  <span class="hljs-attr">mySecondDescriptorUuid</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'00008888-0000-1000-8000-00805F9B34FB'</span>;</li><li>
</li><li>  charBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>  charValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span>);</li><li>
</li><li>  firDescBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>  firDescValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescBuffer</span>);</li><li>
</li><li>  secDescBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>  secDescValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescBuffer</span>);</li><li>
</li><li>  <span class="hljs-comment">// 构造BLEDescriptor</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initDescriptor</span>(<span class="hljs-attr">des</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-title class_">ArrayBuffer</span>): ble.<span class="hljs-property">BLEDescriptor</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptor</span>: ble.<span class="hljs-property">BLEDescriptor</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>      <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>,</li><li>      <span class="hljs-attr">descriptorUuid</span>: des,</li><li>      <span class="hljs-attr">descriptorValue</span>: value</li><li>    };</li><li>    <span class="hljs-keyword">return</span> descriptor;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 构造BLECharacteristic</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initCharacteristic</span>(): ble.<span class="hljs-property">BLECharacteristic</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">descriptors</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLEDescriptor</span>&gt; = [];</li><li>    <span class="hljs-comment">// 默认Client Characteristic Configuration描述符没有使能特征值变化通知或者指示能力</span></li><li>    descriptors[<span class="hljs-number">0</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptorUuid</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescBuffer</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescValue</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">31</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescValue</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">32</span>;</li><li>    descriptors[<span class="hljs-number">1</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initDescriptor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mySecondDescriptorUuid</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescBuffer</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">charValue</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">charValue</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristic</span>: ble.<span class="hljs-property">BLECharacteristic</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>      <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>,</li><li>      <span class="hljs-attr">characteristicValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span>,</li><li>      <span class="hljs-attr">descriptors</span>: descriptors</li><li>    };</li><li>    <span class="hljs-keyword">return</span> characteristic;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 1. 定义连接状态变化回调函数</span></li><li>  onGattServerStateChange = <span class="hljs-function">(<span class="hljs-params">stateInfo: ble.BLEConnectionChangeState</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> state = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">switch</span> (stateInfo.<span class="hljs-property">state</span>) {</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:</li><li>        state = <span class="hljs-string">'DISCONNECTED'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</li><li>        state = <span class="hljs-string">'CONNECTING'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:</li><li>        state = <span class="hljs-string">'CONNECTED'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:</li><li>        state = <span class="hljs-string">'DISCONNECTING'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-attr">default</span>:</li><li>        state = <span class="hljs-string">'undefined'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onGattServerStateChange: device='</span> + stateInfo.<span class="hljs-property">deviceId</span> + <span class="hljs-string">', state='</span> + state);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span> = stateInfo.<span class="hljs-property">deviceId</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 2. 定义读取特征值请求回调函数</span></li><li>  onCharacteristicRead = <span class="hljs-function">(<span class="hljs-params">charReq: ble.CharacteristicReadRequest</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = charReq.<span class="hljs-property">deviceId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = charReq.<span class="hljs-property">transId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = charReq.<span class="hljs-property">offset</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'receive characteristicRead: uuid: '</span> + charReq.<span class="hljs-property">characteristicUuid</span> + <span class="hljs-string">', value: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">charValue</span>));</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>      <span class="hljs-attr">deviceId</span>: deviceId,</li><li>      <span class="hljs-attr">transId</span>: transId,</li><li>      <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0表示成功</span></li><li>      <span class="hljs-attr">offset</span>: offset,</li><li>      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 检查client configuration descriptor的通知能力是否使能</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkDescriptorNotification</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">const</span> notify = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> notifyValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(notify);</li><li>    notifyValue.<span class="hljs-title function_">set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]); <span class="hljs-comment">// 使能client configuration descriptor notification的值</span></li><li>    <span class="hljs-keyword">return</span> notifyValue.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span> value === buffer[index]);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 检查client configuration descriptor的指示能力是否使能</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">checkDescriptorIndication</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">const</span> notify = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">let</span> notifyValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(notify);</li><li>    notifyValue.<span class="hljs-title function_">set</span>([<span class="hljs-number">2</span>, <span class="hljs-number">0</span>]); <span class="hljs-comment">// 使能client configuration descriptor indication的值</span></li><li>    <span class="hljs-keyword">return</span> notifyValue.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">value, index</span>) =&gt;</span> value === buffer[index]);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 3. 定义写入特征值请求回调函数</span></li><li>  onCharacteristicWrite = <span class="hljs-function">(<span class="hljs-params">charReq: ble.CharacteristicWriteRequest</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = charReq.<span class="hljs-property">deviceId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = charReq.<span class="hljs-property">transId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = charReq.<span class="hljs-property">offset</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span> = charReq.<span class="hljs-property">value</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">charValue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(charReq.<span class="hljs-property">value</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'receive characteristicWrite: uuid: '</span> + charReq.<span class="hljs-property">characteristicUuid</span> + <span class="hljs-string">', needRsp='</span> + charReq.<span class="hljs-property">needRsp</span> + <span class="hljs-string">', value: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">charValue</span>));</li><li>    <span class="hljs-keyword">if</span> (!charReq.<span class="hljs-property">needRsp</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> rspBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>      <span class="hljs-attr">deviceId</span>: deviceId,</li><li>      <span class="hljs-attr">transId</span>: transId,</li><li>      <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0表示成功</span></li><li>      <span class="hljs-attr">offset</span>: offset,</li><li>      <span class="hljs-attr">value</span>: rspBuffer</li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendCharacterChange</span>(); <span class="hljs-comment">// 此处特征值变化了，模拟主动发送变化通知或者指示</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 4. 定义读取描述符请求回调函数</span></li><li>  onDescriptorRead = <span class="hljs-function">(<span class="hljs-params">desReq: ble.DescriptorReadRequest</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = desReq.<span class="hljs-property">deviceId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = desReq.<span class="hljs-property">transId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = desReq.<span class="hljs-property">offset</span>;</li><li>    <span class="hljs-keyword">let</span> tmpBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">if</span> (desReq.<span class="hljs-property">descriptorUuid</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptorUuid</span>) {</li><li>      tmpBuffer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescBuffer</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      tmpBuffer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescBuffer</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> tmpValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(tmpBuffer);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'receive descriptorRead: '</span> + desReq.<span class="hljs-property">descriptorUuid</span> + <span class="hljs-string">', tmpValue: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(tmpValue));</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>      <span class="hljs-attr">deviceId</span>: deviceId,</li><li>      <span class="hljs-attr">transId</span>: transId,</li><li>      <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0表示成功</span></li><li>      <span class="hljs-attr">offset</span>: offset,</li><li>      <span class="hljs-attr">value</span>: tmpBuffer</li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 5. 定义写入描述符请求回调函数</span></li><li>  onDescriptorWrite = <span class="hljs-function">(<span class="hljs-params">desReq: ble.DescriptorWriteRequest</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = desReq.<span class="hljs-property">deviceId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">transId</span>: <span class="hljs-built_in">number</span> = desReq.<span class="hljs-property">transId</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span> = desReq.<span class="hljs-property">offset</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'receive descriptorWrite: uuid: '</span> + desReq.<span class="hljs-property">descriptorUuid</span> + <span class="hljs-string">', needRsp: '</span>+ desReq.<span class="hljs-property">needRsp</span> + <span class="hljs-string">', value: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(desReq.<span class="hljs-property">value</span>)));</li><li>    <span class="hljs-keyword">if</span> (desReq.<span class="hljs-property">descriptorUuid</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">myFirstDescriptorUuid</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescBuffer</span> = desReq.<span class="hljs-property">value</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescValue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(desReq.<span class="hljs-property">value</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescBuffer</span> = desReq.<span class="hljs-property">value</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">secDescValue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(desReq.<span class="hljs-property">value</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!desReq.<span class="hljs-property">needRsp</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> rspBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">serverResponse</span>: ble.<span class="hljs-property">ServerResponse</span> = {</li><li>      <span class="hljs-attr">deviceId</span>: deviceId,</li><li>      <span class="hljs-attr">transId</span>: transId,</li><li>      <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0表示成功</span></li><li>      <span class="hljs-attr">offset</span>: offset,</li><li>      <span class="hljs-attr">value</span>: rspBuffer</li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">sendResponse</span>(serverResponse);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 6. server端注册服务时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">registerServer</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristics</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">BLECharacteristic</span>&gt; = [];</li><li>    <span class="hljs-keyword">let</span> characteristic = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCharacteristic</span>();</li><li>    characteristics.<span class="hljs-title function_">push</span>(characteristic);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">gattService</span>: ble.<span class="hljs-property">GattService</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>      <span class="hljs-attr">isPrimary</span>: <span class="hljs-literal">true</span>,</li><li>      <span class="hljs-attr">characteristics</span>: characteristics</li><li>    };</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'registerServer '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span> = ble.<span class="hljs-title function_">createGattServer</span>(); <span class="hljs-comment">// 6.1 构造gattServer，后续的交互都需要使用该实例</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">addService</span>(gattService); <span class="hljs-comment">// 6.2 注册服务</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onGattServerStateChange</span>); <span class="hljs-comment">// 6.3 订阅连接状态</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicRead</span>); <span class="hljs-comment">// 6.4 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicWrite'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicWrite</span>); <span class="hljs-comment">// 6.5 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onDescriptorRead</span>); <span class="hljs-comment">// 6.6 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorWrite'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onDescriptorWrite</span>); <span class="hljs-comment">// 6.7 订阅特征值读事件</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 7. 特征值内容发生变化时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">sendCharacterChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'sendCharacterChange: uuid: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span> + <span class="hljs-string">', value: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span>)));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkDescriptorNotification</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescValue</span>)) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">notifyCharacter</span>: ble.<span class="hljs-property">NotifyCharacteristic</span> = {</li><li>        <span class="hljs-attr">serviceUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>,</li><li>        <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">myCharacteristicUuid</span>,</li><li>        <span class="hljs-attr">characteristicValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span>,</li><li>        <span class="hljs-attr">confirm</span>: <span class="hljs-literal">false</span></li><li>      };</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'sendCharacterChange notification'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">notifyCharacteristicChanged</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>, notifyCharacter, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'notifyCharacteristicChanged notification callback failed'</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'notifyCharacteristicChanged notification callback successful'</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkDescriptorIndication</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">firDescValue</span>)) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">notifyCharacter</span>: ble.<span class="hljs-property">NotifyCharacteristic</span> = {</li><li>        <span class="hljs-attr">serviceUuid</span>: <span class="hljs-string">'00001810-0000-1000-8000-00805F9B34FB'</span>,</li><li>        <span class="hljs-attr">characteristicUuid</span>: <span class="hljs-string">'00001820-0000-1000-8000-00805F9B34FB'</span>,</li><li>        <span class="hljs-attr">characteristicValue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">charBuffer</span>,</li><li>        <span class="hljs-attr">confirm</span>: <span class="hljs-literal">true</span></li><li>      };</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'sendCharacterChange indication'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>?.<span class="hljs-title function_">notifyCharacteristicChanged</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>, notifyCharacter, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'notifyCharacteristicChanged indication callback failed'</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'notifyCharacteristicChanged indication callback successful'</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'notification/indication is disabled'</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 8. server端删除服务，不再使用时调用</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">unRegisterServer</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'no gattServer'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'unRegisterServer '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">removeService</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myServiceUuid</span>); <span class="hljs-comment">// 8.1 删除服务</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onGattServerStateChange</span>) <span class="hljs-comment">// 8.2 取消订阅连接状态</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicRead</span>); <span class="hljs-comment">// 8.3 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'characteristicWrite'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onCharacteristicWrite</span>); <span class="hljs-comment">// 8.4 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorRead'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onDescriptorRead</span>); <span class="hljs-comment">// 8.5 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'descriptorWrite'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onDescriptorWrite</span>); <span class="hljs-comment">// 8.6 订阅特征值读事件</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gattServer</span>.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 8.7 如果应用不再使用此gattServer，则需要close</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> gattServerManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GattServerManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> gattServerManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">GattServerManager</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>