<h1 _ngcontent-vdi-c119="" class="doc-title ng-star-inserted" title="适配相机旋转角度(ArkTS)"> 适配相机旋转角度(ArkTS) </h1>

<div _ngcontent-vdi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>屏幕处于不同的屏幕状态时，原始图像需旋转不同的角度，以确保图像在合适的方向显示，效果如图所示。</p> <p><span><img height="268.47380000000004" originheight="434" originwidth="645" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114442.01144097310388613824884189894322:50001231000000:2800:B81F04AA195D7F6CF5D4A31143FEED7F3B8B8B999E59A6E92CEDB45126D78C05.png" title="点击放大" width="399"></span></p> <p>本开发指导将指导开发者在预览、拍照、录像等不同场景下，如何适配相机的旋转角度。</p> <ul><li>在预览时，图像旋转角度与屏幕显示旋转角度（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display</a>.rotation）相关。具体开发指导：<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">创建会话</a> &gt; <a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section1819315424275">预览</a></li><li>在拍照、录像时，图像旋转角度与设备重力方向（即<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817">设备旋转角度</a>）相关。<p>拍照开发指导：<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">创建会话</a> &gt; <a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817">计算设备旋转角度</a> &gt; <a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section959315464278">拍照</a></p> <p>录像开发指导：<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">创建会话</a> &gt; <a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817">计算设备旋转角度</a> &gt; <a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section12502114915275">录像</a></p> </li></ul> <p>详细的API参考说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-camera" target="_blank">Camera API文档</a>。</p> <div class="tiledSection"><h2 id="section93374563371">创建会话<i class="anchor-icon anchor-icon-link" anchorid="section93374563371" tips="复制节点链接"></i></h2><ol><li>导入相机等相关模块。<div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-keyword">import</span></span> { camera } <span class=""><span class="hljs-keyword">from</span></span> <span class=""><span class="hljs-string">'@kit.CameraKit'</span></span>; </li><li><span class=""><span class="hljs-keyword">import</span></span> { <span class="hljs-title class_">BusinessError</span> } <span class=""><span class="hljs-keyword">from</span></span> <span class=""><span class="hljs-string">'@kit.BasicServicesKit'</span></span>;</li></ol></pre></div></div> </li><li>创建Session会话。<p>相机使用预览等功能前，均需创建相机会话，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager" target="_blank">CameraManager</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createsession11" target="_blank">createSession</a>方法创建一个会话，创建会话时需指定创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#scenemode11" target="_blank">SceneMode</a>为NORMAL_PHOTO或NORMAL_VIDEO，创建的session处于拍照或者录像模式。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createPhotoSession</span>(<span class="hljs-params">cameraManager: camera.CameraManager</span>): camera.<span class="hljs-property">Session</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: camera.<span class="hljs-property">Session</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    session = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">PhotoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> session;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">createVideoSession</span>(<span class="hljs-params">cameraManager: camera.CameraManager</span>): camera.<span class="hljs-property">Session</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">session</span>: camera.<span class="hljs-property">Session</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    session = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${err}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> session;</li><li>}</li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1819315424275">预览<i class="anchor-icon anchor-icon-link" anchorid="section1819315424275" tips="复制节点链接"></i></h2><p>完成<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">会话创建</a>后，开发者可根据实际需求，配置输出流。</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput" target="_blank">PreviewOutput</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getpreviewrotation12" target="_blank">getPreviewRotation</a>接口，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section11826104333019">预览旋转角度</a>。<p>displayRotation：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section106421042912">显示设备的屏幕旋转角度</a>，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#displaygetdefaultdisplaysync9" target="_blank">display.getDefaultDisplaySync</a>获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display</a>对象并读取其rotation属性值，并将对应角度填入。</p> <p>例：Display.rotation = 1，表示显示设备屏幕顺时针旋转为90°，此处displayRotation填入90。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>; </li><li>
</li><li><span class="hljs-keyword">let</span> initDisplayRotation = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">rotation</span>;</li><li><span class="hljs-keyword">let</span> imageRotation = initDisplayRotation * camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_90</span>;</li></ol></pre></div></div> <div class="p">该接口需要在session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">commitConfig</a>完成配流后调用，如果存在异步执行的情况，previewOutput未添加到session里或者已调用的session.release，导致两者关系未绑定，此时调用getPreviewRotation，则会调用失败，并抛出错误码<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-camera#section7400201-相机服务异常" target="_blank">CameraErrorCode.SERVICE_FATAL_ERROR</a>。<div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPreviewRotation</span>(<span class="hljs-params">previewOutput: camera.PreviewOutput, imageRotation : camera.ImageRotation</span>): camera.<span class="hljs-property">ImageRotation</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewRotation</span>: camera.<span class="hljs-property">ImageRotation</span> = camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    previewRotation = previewOutput.<span class="hljs-title function_">getPreviewRotation</span>(imageRotation);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Preview rotation is: <span class="hljs-subst">${previewRotation}</span>`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The previewOutput.getPreviewRotation call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> previewRotation;</li><li>}</li></ol></pre></div></div> </div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput" target="_blank">PreviewOutput</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#setpreviewrotation12" target="_blank">setPreviewRotation</a>，设置图像的预览旋转角度。<p>该接口需要在session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">commitConfig</a>完成配流后调用，如果多次调用，以最新调用设置的图像预览旋转角度为准。</p> <ul><li>previewRotation：预览旋转角度，取上一步<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getpreviewrotation12" target="_blank">getPreviewRotation</a>的返回值。</li><li>isDisplayLocked：可选入参，默认为false。当设置为false，即屏幕方向未锁定，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section11826104333019">预览旋转角度</a>将根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section1283585910517">相机镜头角度</a>+<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section106421042912">屏幕显示旋转角度</a>的值计算；当设置为true，Surface旋转锁定，不跟随窗口变化，旋转角度仅取相机镜头角度计算。</li></ul> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setPreviewRotation</span>(<span class="hljs-params">previewOutput: camera.PreviewOutput, previewRotation : camera.ImageRotation, isDisplayLocked: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    previewOutput.<span class="hljs-title function_">setPreviewRotation</span>(previewRotation, isDisplayLocked);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The previewOutput.setPreviewRotation call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div> </li></ol> <div class="p"><strong>预览流旋转接口完整示例：</strong><div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;   </li><li>
</li><li><span class="hljs-comment">// previewOutput是创建的预览输出</span></li><li><span class="hljs-keyword">let</span> initDisplayRotation = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">rotation</span>;</li><li><span class="hljs-keyword">let</span> initPreviewRotation = previewOutput.<span class="hljs-title function_">getPreviewRotation</span>(initDisplayRotation * camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_90</span>);</li><li>previewOutput.<span class="hljs-title function_">setPreviewRotation</span>(initPreviewRotation, <span class="hljs-literal">false</span>);</li><li>display.<span class="hljs-title function_">off</span>(<span class="hljs-string">'change'</span>);</li><li>display.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  initDisplayRotation = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">rotation</span>;</li><li>  <span class="hljs-keyword">let</span> imageRotation = initDisplayRotation * camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_90</span>;</li><li>  <span class="hljs-keyword">let</span> previewRotation = previewOutput.<span class="hljs-title function_">getPreviewRotation</span>(imageRotation);</li><li>  previewOutput.<span class="hljs-title function_">setPreviewRotation</span>(previewRotation, <span class="hljs-literal">false</span>);</li><li>});</li></ol></pre></div></div> </div> </div> <div class="tiledSection"><h2 id="section959315464278">拍照<i class="anchor-icon anchor-icon-link" anchorid="section959315464278" tips="复制节点链接"></i></h2><p>完成<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">会话创建</a>后，开发者可根据实际需求，配置输出流。拍照的旋转角度与重力方向（即设备旋转角度）相关。</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput" target="_blank">PhotoOutput</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#getphotorotation12" target="_blank">getPhotoRotation</a>可以获取到拍照旋转角度。<p>该接口需要在session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">commitConfig</a>完成配流后调用。</p> <p>deviceDegree：设备旋转角度。获取方式请见<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817">计算设备旋转角度</a>。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPhotoRotation</span>(<span class="hljs-params">photoOutput: camera.PhotoOutput, deviceDegree: <span class="hljs-built_in">number</span></span>): camera.<span class="hljs-property">ImageRotation</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">photoRotation</span>: camera.<span class="hljs-property">ImageRotation</span> = camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    photoRotation = photoOutput.<span class="hljs-title function_">getPhotoRotation</span>(deviceDegree); </li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Photo rotation is: </span><span class=""><span class="hljs-string"><span class="hljs-subst">${photoRotation}</span></span></span><span class="hljs-string">`</span>); </li><li>  } <span class="hljs-keyword">catch</span> (error) {  </li><li>    <span class="hljs-comment">// 失败返回错误码error.code并处理 </span></li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;   </li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The photoOutput.getPhotoRotation call failed. error code: </span><span class=""><span class="hljs-string"><span class="hljs-subst">${err.code}</span></span></span><span class="hljs-string">`</span>); </li><li>  }</li><li>  <span class="hljs-keyword">return</span> photoRotation; </li><li>}</li></ol></pre></div></div> </li><li>应用将拍照角度写入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#photocapturesetting" target="_blank">PhotoCaptureSetting</a>.rotation。</li><li>其余参数的配置及拍照，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-shooting" target="_blank">拍照开发指导</a>。</li></ol> </div> <div class="tiledSection"><h2 id="section12502114915275">录像<i class="anchor-icon anchor-icon-link" anchorid="section12502114915275" tips="复制节点链接"></i></h2><p>完成<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section93374563371">会话创建</a>后，开发者可根据实际需求，配置输出流。录像的旋转角度与重力方向（即设备旋转角度）相关。</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput" target="_blank">VideoOutput</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#getvideorotation12" target="_blank">getVideoRotation</a>可以获取到录像的旋转角度。<p>该接口需要在session调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">commitConfig</a>完成配流后调用。</p> <p>deviceDegree：设备旋转角度。获取方式请见<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817">计算设备旋转角度</a>。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getVideoRotation</span>(<span class="hljs-params">videoOutput: camera.VideoOutput, deviceDegree: <span class="hljs-built_in">number</span></span>): camera.<span class="hljs-property">ImageRotation</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoRotation</span>: camera.<span class="hljs-property">ImageRotation</span> = camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoRotation = videoOutput.<span class="hljs-title function_">getVideoRotation</span>(deviceDegree);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Video rotation is: <span class="hljs-subst">${videoRotation}</span>`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// 失败返回错误码error.code并处理</span></li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The videoOutput.getVideoRotation call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> videoRotation;</li><li>}</li></ol></pre></div></div> </li><li>将录像的旋转角度写入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#avmetadata11" target="_blank">AVMetadata</a>.videoOrientation。</li><li>其余参数的配置及启动录像，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording" target="_blank">录像开发指导</a>。</li></ol> </div> <div class="tiledSection"><h2 id="section2034473052817">计算设备旋转角度<i class="anchor-icon anchor-icon-link" anchorid="section2034473052817" tips="复制节点链接"></i></h2><p>当前可通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-sensor#gravity9-1" target="_blank">once(type: SensorId.GRAVITY, callback: Callback&lt;GravityResponse&gt;)</a>获取一次重力传感器在x、y、z三个方向上的数据，计算得出设备旋转角度deviceDegree，示例如下所示。</p> <p>如果无法获得重力传感器数据，需要申请重力传感器权限ohos.permission.ACCELEROMETER。权限申请请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>，如何获取传感器数据请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/sensor-guidelines" target="_blank">传感器开发指导</a>。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Decimal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { sensor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.SensorServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">getDeviceDegree</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getRealData</span>(<span class="hljs-params">data: sensor.GravityResponse</span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">getDeviceDegree</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> x = data.<span class="hljs-property">x</span>;</li><li>  <span class="hljs-keyword">let</span> y = data.<span class="hljs-property">y</span>;</li><li>  <span class="hljs-keyword">let</span> z = data.<span class="hljs-property">z</span>;</li><li>  <span class="hljs-keyword">if</span> ((x * x + y * y) * <span class="hljs-number">3</span> &lt; z * z) {</li><li>    <span class="hljs-keyword">return</span> getDeviceDegree;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">sd</span>: <span class="hljs-title class_">Decimal</span> = <span class="hljs-title class_">Decimal</span>.<span class="hljs-title function_">atan2</span>(y, -x);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">sc</span>: <span class="hljs-title class_">Decimal</span> = <span class="hljs-title class_">Decimal</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Number</span>(sd) / <span class="hljs-number">3.141592653589</span> * <span class="hljs-number">180</span>);</li><li>      getDeviceDegree = <span class="hljs-number">90</span> - <span class="hljs-title class_">Number</span>(sc);</li><li>      getDeviceDegree = getDeviceDegree &gt;= <span class="hljs-number">0</span> ? getDeviceDegree % <span class="hljs-number">360</span> : getDeviceDegree % <span class="hljs-number">360</span> + <span class="hljs-number">360</span>;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`decimal failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> getDeviceDegree;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getGravity</span>(<span class="hljs-params"></span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: sensor.<span class="hljs-property">Sensor</span>[];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    data = <span class="hljs-keyword">await</span> sensor.<span class="hljs-title function_">getSensorList</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getSensorList failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 异常场景下返回默认值</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {</li><li>    <span class="hljs-keyword">if</span> (data[i].<span class="hljs-property">sensorId</span> === sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">GRAVITY</span>) {</li><li>      isSupported = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (isSupported === <span class="hljs-literal">true</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>        sensor.<span class="hljs-title function_">once</span>(sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">GRAVITY</span>, <span class="hljs-function">(<span class="hljs-params">data: sensor.GravityResponse</span>) =&gt;</span> {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">getRealData</span>(data));</li><li>        });</li><li>      })</li><li>      <span class="hljs-keyword">return</span> promise;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>        sensor.<span class="hljs-title function_">once</span>(sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">ACCELEROMETER</span>, <span class="hljs-function">(<span class="hljs-params">data: sensor.AccelerometerResponse</span>) =&gt;</span> {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">getRealData</span>(data <span class="hljs-keyword">as</span> sensor.<span class="hljs-property">GravityResponse</span>));</li><li>        });</li><li>      })</li><li>      <span class="hljs-keyword">return</span> promise;</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`gePromise failed, error: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 异常场景下返回默认值</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取当前设备旋转角度</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentDeviceDegree</span>(<span class="hljs-params"></span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  getDeviceDegree = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getGravity</span>(); <span class="hljs-comment">// 调用使用await</span></li><li>  <span class="hljs-keyword">return</span> getDeviceDegree;</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section617944310217">视频通话送远端场景<i class="anchor-icon anchor-icon-link" anchorid="section617944310217" tips="复制节点链接"></i></h2><p>两个设备之间进行视频通话，存在设备间持握方向不一致问题，建议<strong>在本端将画面转正</strong>，再通过网络发送到对端，画面转正参考<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section339313511321">自绘制场景预览角度的归一化处理</a>。</p> </div> <div class="tiledSection"><h2 id="section1742053719176">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section1742053719176" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section732372019415" class="firsth2">指定XComponent的大小，防止旋转后图像拉伸变形<i class="anchor-icon anchor-icon-link" anchorid="section732372019415" tips="复制节点链接"></i></h3><p>图像显示出现拉伸或压缩等变形，是因为图像分辨率与XComponent的宽高比不匹配。以应用层下发的1920*1080(16:9)竖屏和横屏为例，器件出图均是按照4:3比例出一张RAW图，在此基础上，根据应用层下发的16:9比例进行裁切，提供数据给应用层。因此，无论手机持握方向如何变化，应用层接收的数据始终是16:9比例的图片。具体图示如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.1" valign="top" width="26.162616261626166%"><p>设备和镜头方向</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.2" valign="top" width="59.71597159715971%"><p>处理过程示意图</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.3.1.4.1.3" valign="top" width="14.12141214121412%"><p>XComponent布局</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26.162616261626166%"><p><strong>设备条件：</strong></p> <p><span style="color: rgb(29,29,26);">手机竖屏、充电</span><span style="color: rgb(29,29,26);">口</span><span style="color: rgb(29,29,26);">向下。</span></p> <p><span style="color: rgb(29,29,26);">使用后置相机拍摄。</span></p> <p><strong>可得：</strong></p> <ul><li><span style="color: rgb(29,29,26);">后置相机镜头角度 </span><span style="color: rgb(29,29,26);">= 90°</span></li><li><span style="color: rgb(29,29,26);">屏幕旋转角度 </span><span style="color: rgb(29,29,26);">= </span><span style="color: rgb(29,29,26);">0°</span><span style="color: rgb(29,29,26);">，</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> <span style="color: rgb(29,29,26);">= </span><span style="color: rgb(29,29,26);">0</span></li><li><strong>图像预览旋转角度 </strong><strong>= </strong><strong>0°+90° = 90°</strong></li></ul> </td> <td class="cellrowborder" valign="top" width="59.71597159715971%"><p><span><img height="226.12653841384136" originheight="436" originwidth="1013" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114442.56369187298164458867540071771105:50001231000000:2800:E52344CB2DCD6723E9A56C8D2A4A81FA687EF13E158BD98095C582319F5B3034.png" title="点击放大" width="525.3869386938693"></span></p> </td> <td class="cellrowborder" valign="top" width="14.12141214121412%"><p>出图与最终成像有90度夹角，布局宽高与图像宽高交换。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26.162616261626166%"><p><strong>设备条件：</strong></p> <p><span style="color: rgb(29,29,26);">手机横屏、充电</span><span style="color: rgb(29,29,26);">口</span><span style="color: rgb(29,29,26);">向右。</span></p> <p><span style="color: rgb(29,29,26);">使用后置相机拍摄。</span></p> <p><strong>可得：</strong></p> <ul><li><span style="color: rgb(29,29,26);">后置相机镜头角度 </span><span style="color: rgb(29,29,26);">= 90°</span></li><li><span style="color: rgb(29,29,26);">屏幕旋转角度 </span><span style="color: rgb(29,29,26);">= </span><span style="color: rgb(29,29,26);">270°</span><span style="color: rgb(29,29,26);">，</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> <span style="color: rgb(29,29,26);">= </span><span style="color: rgb(29,29,26);">3</span></li><li><strong>图像预览旋转角度 </strong><strong>= </strong><strong>270°+90° = 360°</strong><strong> = 0°</strong></li></ul> </td> <td class="cellrowborder" valign="top" width="59.71597159715971%"><p><span><img height="218.16400747630317" originheight="436" originwidth="1050" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114442.32471522072943348833105351584129:50001231000000:2800:FA855096A89F9B207CD012DB20E4FDB4F7AE7F1683F8546057485D27933A64C2.png" title="点击放大" width="525.3869386938693"></span></p> </td> <td class="cellrowborder" valign="top" width="14.12141214121412%"><p>出图与最终成像有0度夹角，布局与图像宽高比一致。</p> </td> </tr>  </tbody></table></div> </div> <p>从上图可以看出，当手机从竖屏转换为横屏时，图像始终保持16:9的输出比例，但镜头与屏幕显示方向之间的夹角从90度变为0度。如果布局保持9:16不变，那么16:9的图像数据放置在9:16的空间内显示，会导致图像形变。因此，为确保图像显示正常，横屏时需要将布局的宽高比调整为16:9。</p> <p>首先，将XComponent的宽度和高度作为状态变量进行监听，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onwindowsizechange7" target="_blank">Window.on('windowSizeChange')</a>监听窗口的变化，根据屏幕旋转角度（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#属性" target="_blank">Display.rotation</a> ）与相机镜头角度（CameraDevice.cameraOrientation）之间的角度来确定布局的宽高比，以确保布局能跟随窗口实时调整。</p> <p>具体的实现方法如下，在需要进行横竖屏切换的页面中，通常建议在aboutToAppear中执行窗口变化的监听。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { bundleManager } from <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { display } from <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { common } from <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { BusinessError, deviceInfo  } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// ....</span></li><li>let previewOutput : camera.PreviewOutput; <span class="hljs-comment">// 根据具体使用场景创建的预览输出流</span></li><li>let cameraDevice : camera.CameraDevice; <span class="hljs-comment">// 根据使用诉求选择符合的相机设备</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-meta">@State</span> mXComponentWidth: number = <span class="hljs-number">1280</span>;</li><li>  <span class="hljs-meta">@State</span> mXComponentHeight: number = <span class="hljs-number">720</span>;</li><li>  <span class="hljs-meta">@State</span> mRotate: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@State</span> mConfigRatio: number = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>;</li><li>  <span class="hljs-keyword">private</span> targetVersion: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> mWindowHeight = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> mWindowWidth = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-keyword">private</span> windowClass = (<span class="hljs-keyword">this</span>.getUIContext().getHostContext() <span class="hljs-keyword">as</span> common.UIAbilityContext).windowStage.getMainWindowSync();</li><li>  getBundleInfoForSelf() { <span class="hljs-comment">// 获取应用的编译版本</span></li><li>    let bundleFlags = bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION | bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_METADATA;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      bundleManager.getBundleInfoForSelf(bundleFlags).then((<span class="hljs-keyword">data</span>) =&gt; {</li><li>        console.info(`getBundleInfoForSelf successfully. Data: ${<span class="hljs-keyword">data</span>.targetVersion}`);</li><li>        <span class="hljs-keyword">this</span>.targetVersion = <span class="hljs-keyword">data</span>.targetVersion;</li><li>      }).<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>        console.error(`getBundleInfoForSelf failed ${err}`);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let message = (err <span class="hljs-keyword">as</span> BusinessError).message;</li><li>      console.error(`getBundleInfoForSelf failed ${message}`);</li><li>    }</li><li>  }</li><li>
</li><li>  isIsolateForSpecialType(): boolean { <span class="hljs-comment">// 兼容平板API14之前的设备</span></li><li>    <span class="hljs-keyword">return</span> deviceInfo.deviceType == <span class="hljs-string">"tablet"</span> &amp;&amp; <span class="hljs-keyword">this</span>.targetVersion &lt;= <span class="hljs-number">50000013</span>;</li><li>  }</li><li>
</li><li>  aboutToAppear(): void {</li><li>    <span class="hljs-keyword">this</span>.updateXComponentSize();</li><li>    <span class="hljs-keyword">this</span>.getBundleInfoForSelf();</li><li>    <span class="hljs-keyword">this</span>.windowClass.on(<span class="hljs-string">'windowSizeChange'</span>, (size) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.mWindowWidth = size.width;</li><li>      <span class="hljs-keyword">this</span>.mWindowHeight = size.height;</li><li>      <span class="hljs-keyword">this</span>.updateXComponentSize();</li><li>    });</li><li>    let rotation : number = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      rotation = display.getDefaultDisplaySync().rotation;</li><li>      <span class="hljs-keyword">this</span>.mRotate = rotation * camera.ImageRotation.ROTATION_90;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      console.error(`Failed to <span class="hljs-keyword">get</span> display rotation: ${err.code}, ${err.message}`);</li><li>      <span class="hljs-keyword">this</span>.mRotate = <span class="hljs-number">0</span>;</li><li>    }</li><li>    display.on(<span class="hljs-string">'change'</span>, () =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mRotate!= rotation * camera.ImageRotation.ROTATION_90) {</li><li>        <span class="hljs-keyword">this</span>.mRotate= rotation * camera.ImageRotation.ROTATION_90; <span class="hljs-comment">// 获取屏幕旋转角度</span></li><li>        <span class="hljs-keyword">this</span>.updateXComponentSize();</li><li>        let imageRotation = <span class="hljs-keyword">this</span>.getImageRotation();</li><li>        <span class="hljs-keyword">if</span> (!imageRotation) {</li><li>          console.error(`current <span class="hljs-keyword">get</span> image rotation <span class="hljs-keyword">is</span> undefined`);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        let previewRotation = previewOutput.getPreviewRotation(imageRotation); <span class="hljs-comment">// previewOutput是创建的预览流</span></li><li>        previewOutput.setPreviewRotation(previewRotation, <span class="hljs-literal">false</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>  getImageRotation() : camera.ImageRotation | undefined {</li><li>    let displayRotation : number= <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      displayRotation = display.getDefaultDisplaySync().rotation</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      console.error(`Failed to <span class="hljs-keyword">get</span> display rotation: ${err.code}, ${err.message}`);</li><li>      <span class="hljs-keyword">return</span> undefined;</li><li>    }</li><li>    let imageRotation = displayRotation * camera.ImageRotation.ROTATION_90;</li><li>    <span class="hljs-keyword">return</span> imageRotation;</li><li>  }</li><li>  updateXComponentSize(): void {</li><li>    let angleDiff = (<span class="hljs-keyword">this</span>.mRotate+ cameraDevice?.cameraOrientation) % <span class="hljs-number">360</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isIsolateForSpecialType()) { <span class="hljs-comment">// 如果设备为平板设备，且使用的API版本＜14，应进入此逻辑。</span></li><li>    <span class="hljs-keyword">if</span> (angleDiff === <span class="hljs-number">90</span> || angleDiff=== <span class="hljs-number">270</span>) {</li><li>    <span class="hljs-keyword">this</span>.mXComponentWidth = <span class="hljs-keyword">this</span>.mConfigRatio * <span class="hljs-keyword">this</span>.mWindowHeight;</li><li>    <span class="hljs-keyword">this</span>.mXComponentHeight = <span class="hljs-keyword">this</span>.mWindowHeight;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.mXComponentWidth = <span class="hljs-keyword">this</span>.mWindowWidth;</li><li>    <span class="hljs-keyword">this</span>.mXComponentHeight = <span class="hljs-keyword">this</span>.mConfigRatio * <span class="hljs-keyword">this</span>.mWindowWidth; <span class="hljs-comment">//1920 *1080</span></li><li>  }</li><li>  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 如果使用API版本≥14，或是API14以下的非平板设备，应进入此逻辑。</span></li><li>    <span class="hljs-keyword">if</span> (angleDiff === <span class="hljs-number">90</span> || angleDiff=== <span class="hljs-number">270</span>) {</li><li>      <span class="hljs-keyword">this</span>.mXComponentWidth = <span class="hljs-keyword">this</span>.mWindowWidth;</li><li>      <span class="hljs-keyword">this</span>.mXComponentHeight = <span class="hljs-keyword">this</span>.mConfigRatio * <span class="hljs-keyword">this</span>.mWindowWidth; <span class="hljs-comment">//1920 *1080</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.mXComponentWidth = <span class="hljs-keyword">this</span>.mConfigRatio * <span class="hljs-keyword">this</span>.mWindowHeight;</li><li>      <span class="hljs-keyword">this</span>.mXComponentHeight = <span class="hljs-keyword">this</span>.mWindowHeight;</li><li>    }</li><li>  }</li><li>  }</li><li>
</li><li>  async aboutToDisAppear(): Promise&lt;void&gt; {</li><li>    display.off(<span class="hljs-string">'change'</span>);</li><li>    <span class="hljs-keyword">this</span>.windowClass.off(<span class="hljs-string">'windowSizeChange'</span>);</li><li>    <span class="hljs-comment">// 解注册</span></li><li>  }</li><li>  build() {</li><li>    <span class="hljs-comment">// 根据使用诉求补充界面处理逻辑。</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p></p> <p>除了指定XComponent的宽高外，还可以通过设置XComponent的renderFit来实现图片的自适应大小显示、居中裁剪显示等效果。具体详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-renderfit#renderfit" target="_blank">RenderFit介绍</a>。</p> </div> <div class="tiledSection"><h3 id="section339313511321">自绘制场景预览角度的归一化处理<i class="anchor-icon anchor-icon-link" anchorid="section339313511321" tips="复制节点链接"></i></h3><p>在自绘制场景中，对于后置摄像头，可以通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getpreviewrotation12" target="_blank">getPreviewRotation</a>获取旋转角度，将图像转正；对于前置摄像头，由于存在水平镜像和垂直镜像的差异，为了简化操作，需先对前置摄像头的图像角度进行归一化处理后，再将图像转正，并根据业务需求决定是否进行镜像处理。</p> <p>pixelMap处理方式：</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">camera</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>; </li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">display</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">previewOutputReceiver</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PreviewOutput</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>; <span class="hljs-comment">// 回调流定义</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">curCameraPosition</span> = <span class="hljs-variable">camera</span>.<span class="hljs-variable">CameraPosition</span>.<span class="hljs-variable">CAMERA_POSITION_FRONT</span>; <span class="hljs-comment">//  相机设备的位置定义，此处以前置为例。</span></li><li><span class="hljs-comment">//.....</span></li><li><span class="hljs-variable">function</span>  <span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable">receiver</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageReceiver</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, () =&gt; { <span class="hljs-comment">// imageRecevier回调</span></li><li>    <span class="hljs-comment">// 获取图像</span></li><li>    <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">readNextImage</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">nextImage</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> || <span class="hljs-variable">nextImage</span> === <span class="hljs-variable">undefined</span>) {</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'readNextImage failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 解析图像内容</span></li><li>      <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">imgComponent</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> || <span class="hljs-variable">imgComponent</span> === <span class="hljs-variable">undefined</span>) {</li><li>          <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getComponent failed'</span>);</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">width</span> = <span class="hljs-variable">nextImage</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span>; <span class="hljs-comment">// 获取图片的宽</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = <span class="hljs-variable">nextImage</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>; <span class="hljs-comment">// 获取图片的高</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">stride</span> = <span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">rowStride</span>; <span class="hljs-comment">// 获取图片的stride</span></li><li>          <span class="hljs-comment">// stride与width一致</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">stride</span> == <span class="hljs-variable">width</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>              <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>              <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>, <span class="hljs-comment">//此处以NV21为例</span></li><li>            })</li><li>            <span class="hljs-title function_">updatePixelMap</span>(<span class="hljs-variable">pixelMap</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-comment">// stride与width不一致</span></li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">dstBufferSize</span> = <span class="hljs-variable">width</span> * <span class="hljs-variable">height</span> * <span class="hljs-number">1.5</span> <span class="hljs-comment">// 以NV21为例（YUV_420_SP格式的图片）YUV_420_SP内存计算公式：长x宽+(长x宽)/2</span></li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">dstArr</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">dstBufferSize</span>)</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">height</span> * <span class="hljs-number">1.5</span>; <span class="hljs-title class_">j</span>++) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">srcBuf</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">stride</span>, <span class="hljs-variable">width</span>)</li><li>              <span class="hljs-variable">dstArr</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">srcBuf</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">width</span>)</li><li>            }</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">dstArr</span>.<span class="hljs-variable">buffer</span>, {</li><li>              <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>              <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>, <span class="hljs-comment">// 此处以NV21为例</span></li><li>            });</li><li>            <span class="hljs-title function_">updatePixelMap</span>(<span class="hljs-variable">pixelMap</span>);</li><li>          }</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'byteBuffer is null'</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 确保当前buffer没有在使用的情况下，可进行资源释放。</span></li><li>        <span class="hljs-comment">// 如果对buffer进行异步操作，需要在异步操作结束后再释放该资源（nextImage.release()）。</span></li><li>        <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">release</span>();</li><li>        <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'image process done'</span>);</li><li>      })</li><li>    })</li><li>  })</li><li>}</li></ol></pre></div></div> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>  <span class=""><span class="hljs-title function_">updatePixelMap</span></span><span class="">(</span><span class=""><span class="hljs-params">pixelMap</span></span><span class=""><span class="hljs-params">: </span></span><span class=""><span class="hljs-params">image</span></span><span class=""><span class="hljs-params">.</span></span><span class=""><span class="hljs-params">PixelMap</span></span><span class="">)</span><span class="">: </span><span class=""><span class="hljs-title class_">Promise</span></span><span class="">&lt;</span><span class=""><span class="hljs-keyword">void</span></span><span class="">&gt;</span> <span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">rotation </span><span class="">: </span><span class="">number </span><span class="">= </span><span class=""><span class="hljs-number">0</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">try</span> <span class="">{</span></li><li>    <span class="">rotation </span><span class="">= </span><span class="">display</span><span class="">.</span><span class=""><span class="hljs-title function_">getDefaultDisplaySync</span></span><span class="">()</span><span class="">.</span><span class=""><span class="hljs-property">rotation</span> </span><span class="">* </span><span class="">camera</span><span class="">.</span><span class=""><span class="hljs-property">ImageRotation</span></span><span class="">.</span><span class=""><span class="hljs-property">ROTATION_90</span></span><span class="">;</span></li><li>  <span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>    <span class="hljs-keyword">const</span> <span class="">err </span><span class="">= </span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">;</span></li><li>    <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to get display rotation: </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">err</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">.</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">err</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">.</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>    <span class="hljs-keyword">return</span><span class="">;</span></li><li>  <span class="">}</span></li><li>  <span class="hljs-keyword">let</span> <span class="">angle </span><span class="">= </span><span class="">previewOutputReceiver</span><span class="">?.</span><span class=""><span class="hljs-title function_">getPreviewRotation</span></span><span class="">(</span><span class="">rotation</span><span class="">)</span><span class="">;</span></li><li>  <span class="hljs-keyword">if</span> <span class="">(</span><span class="">angle </span><span class="">=== </span><span class="hljs-literal">undefined</span><span class="">) </span><span class="">{</span></li><li>    <span class="hljs-keyword">return</span><span class="">;</span></li><li>  <span class="">}</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">在</span></span><span class=""><span class="hljs-comment">display.on</span></span><span class=""><span class="hljs-comment">中对该</span></span><span class=""><span class="hljs-comment">previewOutput</span></span><span class=""><span class="hljs-comment">设置过</span></span><span class=""><span class="hljs-comment">setPreviewRotation</span></span><span class=""><span class="hljs-comment">，此处可以不执行。</span></span></li><li>  <span class="">previewOutputReceiver</span><span class="">?.</span><span class=""><span class="hljs-title function_">setPreviewRotation</span></span><span class="">(</span><span class="">angle</span><span class="">)</span><span class="">;</span></li><li>  <span class="hljs-keyword">if</span> <span class="">(</span><span class="">curCameraPosition </span><span class="">=== </span><span class="">camera</span><span class="">.</span><span class=""><span class="hljs-property">CameraPosition</span></span><span class="">.</span><span class=""><span class="hljs-property">CAMERA_POSITION_FRONT</span></span><span class="">) </span><span class="">{</span></li><li>    <span class="hljs-keyword">if</span> <span class="">(</span><span class="">rotation </span><span class="">===</span><span class=""><span class="hljs-number">90</span> </span><span class="">|| </span><span class="">rotation </span><span class="">=== </span><span class=""><span class="hljs-number">270</span></span><span class="">) </span><span class="">{</span></li><li>      <span class="">angle </span><span class="">= </span><span class="">(</span><span class="">angle </span><span class="">+ </span><span class=""><span class="hljs-number">180</span> </span><span class="">) </span><span class="">% </span><span class=""><span class="hljs-number">360</span></span><span class="">;</span></li><li>    <span class="">}</span></li><li>    <span class="hljs-keyword">await</span> <span class="">pixelMap</span><span class="">.</span><span class=""><span class="hljs-title function_">rotate</span></span><span class="">(</span><span class="">angle</span><span class="">)</span><span class="">;</span></li><li>    <span class="hljs-keyword">await</span> <span class="">pixelMap</span><span class="">.</span><span class=""><span class="hljs-title function_">flip</span></span><span class="">(</span><span class="hljs-literal">true</span><span class="">, </span><span class="hljs-literal">false</span><span class="">)</span><span class="">;</span></li><li>  <span class="">} </span><span class="hljs-keyword">else</span> <span class="">{</span></li><li>    <span class="hljs-keyword">await</span> <span class="">pixelMap</span><span class="">.</span><span class=""><span class="hljs-title function_">rotate</span></span><span class="">(</span><span class="">angle</span><span class="">)</span><span class="">;</span></li><li>  <span class="">}</span></li><li><span class="">}</span></li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section188745567294">适配一多设备<i class="anchor-icon anchor-icon-link" anchorid="section188745567294" tips="复制节点链接"></i></h3><p>为了适配一多设备，主要分为以下几步：</p> <ol><li>根据屏幕比例选择合适的预览分辨率。</li><li>根据确定的预览分辨率，通过宽/高得到新的比例。</li><li>根据上一步的比例计算XComponent宽高，可参考<a href="/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section732372019415">指定XComponent的大小，防止旋转后图像拉伸变形</a>，将mConfigRatio应用于布局宽高的计算。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在适配折叠屏设备时，每次折叠屏镜头变更都需要重新获取屏幕比例。</p> </div></div></div> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">mConfigRatio</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>; <span class="hljs-comment">// 设置分辨率比例初始值，此处以16:9宽高比为例。</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">reConfigType</span> : <span class="hljs-title class_">number</span> = <span class="hljs-number">720</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">previewProfileObj</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Profile</span> = {</li><li>  <span class="hljs-variable">format</span>: <span class="hljs-number">1003</span>,</li><li>  <span class="hljs-variable">size</span>: {</li><li>    <span class="hljs-variable">width</span>: <span class="hljs-number">1280</span>,</li><li>    <span class="hljs-variable">height</span>: <span class="hljs-number">720</span></li><li>  }</li><li>};</li><li><span class="hljs-comment">// 根据屏幕初步计算比例，长边/短边</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getConfigRation</span>(<span class="hljs-variable">cameraDevice</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraDevice</span>, <span class="hljs-variable">cameraManager</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraManager</span>) : <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">previewProfile</span> = <span class="hljs-title function_">getSurfaceSize</span>(<span class="hljs-variable">cameraDevice</span>, <span class="hljs-variable">mConfigRatio</span>, <span class="hljs-variable">cameraManager</span>); <span class="hljs-comment">// 获取最接近的分辨率</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">previewProfile</span> === <span class="hljs-variable">undefined</span> || <span class="hljs-variable">previewProfile</span>.<span class="hljs-variable">size</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>  }</li><li>  <span class="hljs-variable">mConfigRatio</span> = <span class="hljs-variable">previewProfile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span> / <span class="hljs-variable">previewProfile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>; <span class="hljs-comment">// 以新的比例重新计算显示宽高</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">mConfigRatio</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 获取最接近屏幕的分辨率</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getSurfaceSize</span>(<span class="hljs-variable">cameraDevice</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraDevice</span>, <span class="hljs-variable">configRatio</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">cameraManager</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraManager</span>): <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Profile</span> | <span class="hljs-title class_">undefined</span> {</li><li>  <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">previewProfiles</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">configRatio</span>}`);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">cameraOutputCapability</span> =</li><li>    <span class="hljs-variable">cameraManager</span>.<span class="hljs-title function_">getSupportedOutputCapability</span>(<span class="hljs-variable">cameraDevice</span>, <span class="hljs-variable">camera</span>.<span class="hljs-variable">SceneMode</span>.<span class="hljs-variable">NORMAL_PHOTO</span>); <span class="hljs-comment">// 此处以NORMAL_PHOTO为例</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getPreviewProfile</span>(<span class="hljs-variable">cameraOutputCapability</span>, <span class="hljs-variable">configRatio</span>);</li><li>}</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getPreviewProfile</span>(<span class="hljs-variable">cameraOutputCapability</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraOutputCapability</span>, <span class="hljs-variable">configRatio</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Profile</span> | <span class="hljs-title class_">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">previewProfiles</span> = <span class="hljs-variable">cameraOutputCapability</span>.<span class="hljs-variable">previewProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">previewProfiles</span>.<span class="hljs-variable">length</span> &lt; <span class="hljs-number">1</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">undefined</span>;</li><li>  }</li><li>  <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">previewProfiles</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">foramt</span>: ${<span class="hljs-variable">previewProfileObj</span>.<span class="hljs-variable">format</span>} <span class="hljs-variable">configRatio</span> = ${<span class="hljs-variable">configRatio</span>}`);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">optimalSize</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Profile</span>|<span class="hljs-title class_">undefined</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">minDiff</span> = <span class="hljs-variable">Number</span>.<span class="hljs-variable">MAX_VALUE</span>;</li><li>  <span class="hljs-comment">// 计算屏幕的宽高比</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">previewProfiles</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">format</span> !== <span class="hljs-variable">previewProfileObj</span>.<span class="hljs-variable">format</span>) {</li><li>      <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ratio</span> = <span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span> / <span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>; <span class="hljs-comment">//1088*1080</span></li><li>    <span class="hljs-comment">// 检查宽高比是否匹配</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">ratio</span> - <span class="hljs-variable">configRatio</span>) &gt; <span class="hljs-number">0.2</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 0.2的误差可自行调整</span></li><li>    <span class="hljs-comment">// 选择最接近的分辨率</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> - <span class="hljs-variable">reConfigType</span>) &lt; <span class="hljs-title class_">minDiff</span>) {</li><li>      <span class="hljs-variable">optimalSize</span> = <span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>];</li><li>      <span class="hljs-variable">minDiff</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> - <span class="hljs-variable">reConfigType</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 如果没有找到合适的分辨率，选择第一个</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">optimalSize</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-variable">minDiff</span> = <span class="hljs-variable">Number</span>.<span class="hljs-variable">MAX_VALUE</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">previewProfiles</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">format</span> !== <span class="hljs-variable">previewProfileObj</span>.<span class="hljs-variable">format</span>) {</li><li>        <span class="hljs-keyword">continue</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> - <span class="hljs-variable">reConfigType</span>) &lt; <span class="hljs-title class_">minDiff</span>) { <span class="hljs-comment">// 720</span></li><li>        <span class="hljs-variable">optimalSize</span> = <span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>];</li><li>        <span class="hljs-variable">minDiff</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">previewProfiles</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> - <span class="hljs-variable">reConfigType</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">optimalSize</span>;</li><li>}</li></ol></pre></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section165619291913">拍照无法镜像<i class="anchor-icon anchor-icon-link" anchorid="section165619291913" tips="复制节点链接"></i></h3><p>通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#photocapturesetting" target="_blank">PhotoCaptureSetting</a>中的mirror属性改变拍照镜像。</p> <div _ngcontent-vdi-c106="" class="highlight-div"><div _ngcontent-vdi-c106="" class="highlight-div-header"><div _ngcontent-vdi-c106="" class="highlight-div-header-left"><div _ngcontent-vdi-c106="" class="handle-button expand-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vdi-c106="" class="highlight-div-header-right"><div _ngcontent-vdi-c106="" class="handle-button ai-button"></div><div _ngcontent-vdi-c106="" class="handle-button line-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vdi-c106="" class="handle-button theme-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vdi-c106="" class="handle-button copy-button"><div _ngcontent-vdi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vdi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//this.photoOutput是拍照输出output, this.getDeviceDegree是重力角度</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">photoSettings</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoCaptureSetting</span> = {</li><li>  <span class="hljs-variable">quality</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">QualityLevel</span>.<span class="hljs-title class_">QUALITY_LEVEL_HIGH</span>,</li><li>  <span class="hljs-variable">mirror</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">photoOutput</span>?.<span class="hljs-title class_">isMirrorSupported</span>() <span class="hljs-comment">// 设置拍照镜像，true表示镜像，false表示非镜像</span></li><li>};</li><li><span class="hljs-comment">// ... 省略获取代码</span></li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">photoRotation</span> = <span class="hljs-title function_">getPhotoRotation</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">photoOutput</span>!!,<span class="hljs-keyword">this</span>.<span class="hljs-variable">getDeviceDegree</span>)</li><li><span class="hljs-variable">photoSettings</span>.<span class="hljs-variable">rotation</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">photoRotation</span> <span class="hljs-comment">//指定拍照旋转角度</span></li></ol></pre></div></div> </div> </div> <div></div></div>