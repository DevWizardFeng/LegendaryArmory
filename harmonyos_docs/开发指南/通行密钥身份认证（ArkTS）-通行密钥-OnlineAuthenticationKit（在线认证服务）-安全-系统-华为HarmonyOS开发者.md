<h1 _ngcontent-pgw-c119="" class="doc-title ng-star-inserted" title="通行密钥身份认证（ArkTS）"> 通行密钥身份认证（ArkTS） </h1>

<div _ngcontent-pgw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1891506162020">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1891506162020" tips="复制节点链接"></i></h2>          <p>通行密钥服务主要接口如下表。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="60.050000000000004%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="39.95%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-passkey-api#section1122315266414" target="_blank">getClientCapabilities</a>(context: common.Context): Promise&lt;Map&lt;ClientCapability, boolean&gt;&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>查询当前设备/版本支持的认证能力列表</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-passkey-api#section36194215542" target="_blank">getPlatformAuthenticators</a>(context: common.Context): Promise&lt;Array&lt;AuthenticatorMetadata&gt;&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>查询当前设备/版本支持的平台认证器能力列表（人脸、指纹、PIN码）</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-passkey-api#section1447385117810" target="_blank">register</a>(context: common.Context, options: CredentialCreationOptions, tokenBinding?: TokenBinding): Promise&lt;PublicKeyAttestationCredential&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>进行通行密钥的注册</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/onlineauthentication-passkey-api#section193521359131510" target="_blank">authenticate</a>(context: common.Context, options: CredentialRequestOptions, tokenBinding?: TokenBinding): Promise&lt;PublicKeyAssertionCredential&gt;</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>进行通行密钥的认证</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section941210361404">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section941210361404" tips="复制节点链接"></i></h2>          <p>通行密钥服务提供基于FIDO2标准协议的FIDO客户端实现，这里仅演示FIDO客户端相关API的使用，涉及应用服务器及FIDO服务器的相关处理由开发者自行实现，请参考<a href="https://fidoalliance.org/passkeys/" target="_blank">FIDO2标准协议</a>（见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/onlineauthentication-website-disclaimer">网站链接免责声明</a>）。</p>     <ol>      <li>需要业务方自行根据FIDO2标准协议部署FIDO服务器。</li>      <li>导入相关模块。       <div _ngcontent-pgw-c106="" class="highlight-div"><div _ngcontent-pgw-c106="" class="highlight-div-header"><div _ngcontent-pgw-c106="" class="highlight-div-header-left"><div _ngcontent-pgw-c106="" class="handle-button expand-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgw-c106="" class="highlight-div-header-right"><div _ngcontent-pgw-c106="" class="handle-button ai-button"></div><div _ngcontent-pgw-c106="" class="handle-button line-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgw-c106="" class="handle-button theme-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgw-c106="" class="handle-button copy-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="">{ </span><span class=""><span class="hljs-title class_">BusinessError</span> </span><span class="">} </span><span class="hljs-keyword">from</span> <span class=""><span class="hljs-string">'@kit.BasicServicesKit'</span></span><span class="">;</span></li><li><span class="hljs-keyword">import</span> <span class="">{ </span><span class=""><span class="hljs-title class_">UIContext</span> </span><span class="">} </span><span class="hljs-keyword">from</span> <span class=""><span class="hljs-string">'@kit.ArkUI'</span></span></li><li><span class="hljs-keyword">import</span> <span class="">{ </span><span class="">common </span><span class="">} </span><span class="hljs-keyword">from</span> <span class=""><span class="hljs-string">'@kit.AbilityKit'</span></span><span class="">;</span></li><li><span class="hljs-keyword">import</span> <span class="">{ </span><span class="">fido2 </span><span class="">} </span><span class="hljs-keyword">from</span> <span class=""><span class="hljs-string">'@kit.OnlineAuthenticationKit'</span></span><span class="">;</span></li></ol></pre></div></div></li>      <li>注册通行密钥。       <ol>        <li>获取能力信息，调用getClientCapabilities接口获取认证能力列表，并且调用getPlatformAuthenticators接口获取平台认证器能力信息。         <div _ngcontent-pgw-c106="" class="highlight-div"><div _ngcontent-pgw-c106="" class="highlight-div-header"><div _ngcontent-pgw-c106="" class="highlight-div-header-left"><div _ngcontent-pgw-c106="" class="handle-button expand-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgw-c106="" class="highlight-div-header-right"><div _ngcontent-pgw-c106="" class="handle-button ai-button"></div><div _ngcontent-pgw-c106="" class="handle-button line-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgw-c106="" class="handle-button theme-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgw-c106="" class="handle-button copy-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-attr">uiContext1</span></span><span class="">: </span><span class=""><span class="hljs-title class_">UIContext</span> </span><span class="">= </span><span class="hljs-variable language_">this</span><span class="">.</span><span class=""><span class="hljs-title function_">getUIContext</span></span><span class="">()</span><span class="">;</span></li><li><span class=""><span class="hljs-attr">uiContext</span></span><span class="">: </span><span class="">common</span><span class="">.</span><span class=""><span class="hljs-property">UIAbilityContext</span> </span><span class="">= </span><span class="hljs-variable language_">this</span><span class="">.</span><span class=""><span class="hljs-property">uiContext1</span></span><span class="">.</span><span class=""><span class="hljs-title function_">getHostContext</span></span><span class="">() </span><span class="hljs-keyword">as</span> <span class="">common</span><span class="">.</span><span class=""><span class="hljs-property">UIAbilityContext</span></span><span class="">;</span> <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">使用</span></span><span class=""><span class="hljs-comment">uiContext</span></span><span class=""><span class="hljs-comment">需要获取页面</span></span><span class=""><span class="hljs-comment">UIAbility</span></span><span class=""><span class="hljs-comment">的</span></span><span class=""><span class="hljs-comment">Context</span></span><span class=""><span class="hljs-comment">，一个页面获取一次即可</span></span></li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取</span></span><span class=""><span class="hljs-comment">认证能力列表</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">clientCapabilities</span></span><span class="">: </span><span class=""><span class="hljs-title class_">Map</span></span><span class="">&lt;</span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">ClientCapability</span></span><span class="">, </span><span class=""><span class="hljs-built_in">boolean</span></span><span class="">&gt;</span><span class=""> = </span><span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">getClientCapabilities</span></span><span class="">(<span class="hljs-variable language_">this</span>.</span><span class=""><span class="hljs-property">uiContext</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">info</span></span><span class="">(</span><span class=""><span class="hljs-string">"Succeeded in doing getClientCapabilities."</span></span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call getClientCapabilities error code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取平台认证器能力</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">platformAuthenticators</span></span><span class="">: </span><span class=""><span class="hljs-title class_">Array</span></span><span class="">&lt;</span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">AuthenticatorMetadata</span></span><span class="">&gt;</span><span class=""> =</span></li><li>    <span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">getPlatformAuthenticators</span></span><span class="">(</span><span class=""><span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">info</span></span><span class="">(</span><span class=""><span class="hljs-string">"Succeeded in doing getPlatformAuthenticators."</span></span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call getPlatformAuthenticators error code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li></ol></pre></div></div></li>        <li>访问FIDO服务器，获取注册报文，调用register接口进行注册。         <div _ngcontent-pgw-c106="" class="highlight-div"><div _ngcontent-pgw-c106="" class="highlight-div-header"><div _ngcontent-pgw-c106="" class="highlight-div-header-left"><div _ngcontent-pgw-c106="" class="handle-button expand-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgw-c106="" class="highlight-div-header-right"><div _ngcontent-pgw-c106="" class="handle-button ai-button"></div><div _ngcontent-pgw-c106="" class="handle-button line-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgw-c106="" class="handle-button theme-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgw-c106="" class="handle-button copy-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// pkOptions</span></span><span class=""><span class="hljs-comment">为应用从</span></span><span class=""><span class="hljs-comment">FIDO</span></span><span class=""><span class="hljs-comment">服务端获取的注册报文</span></span><span class=""><span class="hljs-comment">, credentialCreationOp</span></span><span class=""><span class="hljs-comment">为应用组装注册信息</span></span></li><li><span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">credentialCreationOp</span></span><span class="">: </span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">CredentialCreationOptions</span> </span><span class="">= </span><span class="">{</span></li><li>  <span class=""><span class="hljs-attr">publicKey</span></span><span class="">: </span><span class="">pkOptions</span></li><li><span class="">}</span><span class="">;</span></li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">调用</span></span><span class=""><span class="hljs-comment">register进行通行密钥注册</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">publicKeyAttestationCredential</span></span><span class="">: </span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">PublicKeyAttestationCredential</span> </span><span class="">=</span></li><li>    <span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">register</span></span><span class="">(</span><span class=""><span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span></span><span class="">, </span><span class="">credentialCreationOp</span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call register error code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li></ol></pre></div></div></li>        <li>应用使用注册结果（publicKeyAttestationCredential）组装注册响应报文，发送至FIDO服务端进行验证，获取注册结果报文。</li>       </ol></li>      <li>使用通行密钥进行身份认证。       <ol>        <li>获取能力信息，调用getClientCapabilities接口获取认证能力列表，并且调用getPlatformAuthenticators接口获取平台认证器能力信息。         <div _ngcontent-pgw-c106="" class="highlight-div"><div _ngcontent-pgw-c106="" class="highlight-div-header"><div _ngcontent-pgw-c106="" class="highlight-div-header-left"><div _ngcontent-pgw-c106="" class="handle-button expand-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgw-c106="" class="highlight-div-header-right"><div _ngcontent-pgw-c106="" class="handle-button ai-button"></div><div _ngcontent-pgw-c106="" class="handle-button line-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgw-c106="" class="handle-button theme-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgw-c106="" class="handle-button copy-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">使用</span></span><span class=""><span class="hljs-comment">uiContext</span></span><span class=""><span class="hljs-comment">需要获取页面</span></span><span class=""><span class="hljs-comment">UIAbility</span></span><span class=""><span class="hljs-comment">的</span></span><span class=""><span class="hljs-comment">Context</span></span><span class=""><span class="hljs-comment">，一个页面获取一次即可</span></span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">uiContext</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取</span></span><span class=""><span class="hljs-comment">认证能力列表</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">clientCapabilities</span></span><span class="">: </span><span class=""><span class="hljs-title class_">Map</span></span><span class="">&lt;</span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">ClientCapability</span></span><span class="">, </span><span class=""><span class="hljs-built_in">boolean</span></span><span class="">&gt;</span><span class=""> = </span><span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">getClientCapabilities</span></span><span class="">(</span><span class=""><span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">info</span></span><span class="">(</span><span class=""><span class="hljs-string">"Succeeded in doing getClientCapabilities."</span></span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call getClientCapabilities error code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">获取平台认证器能力</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">platformAuthenticators</span></span><span class="">: </span><span class=""><span class="hljs-title class_">Array</span></span><span class="">&lt;</span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">AuthenticatorMetadata</span></span><span class="">&gt;</span><span class=""> =</span></li><li>    <span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">getPlatformAuthenticators</span></span><span class="">(</span><span class=""><span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">info</span></span><span class="">(</span><span class=""><span class="hljs-string">"Succeeded in doing getPlatformAuthenticators."</span></span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call getPlatformAuthenticators error code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li></ol></pre></div></div></li>        <li>访问FIDO服务器，获取认证报文，调用authenticate接口进行认证。         <div _ngcontent-pgw-c106="" class="highlight-div"><div _ngcontent-pgw-c106="" class="highlight-div-header"><div _ngcontent-pgw-c106="" class="highlight-div-header-left"><div _ngcontent-pgw-c106="" class="handle-button expand-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pgw-c106="" class="highlight-div-header-right"><div _ngcontent-pgw-c106="" class="handle-button ai-button"></div><div _ngcontent-pgw-c106="" class="handle-button line-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pgw-c106="" class="handle-button theme-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pgw-c106="" class="handle-button copy-button"><div _ngcontent-pgw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pgw-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// authPub</span></span><span class=""><span class="hljs-comment">为应用从</span></span><span class=""><span class="hljs-comment">FIDO</span></span><span class=""><span class="hljs-comment">服务端获取的认证报文，</span></span><span class=""><span class="hljs-comment">authCredentialRequestOptions</span></span><span class=""><span class="hljs-comment">为应用组装的认证信息</span></span></li><li><span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">authCredentialRequestOptions</span></span><span class="">: </span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">CredentialRequestOptions</span> </span><span class="">= </span><span class="">{</span></li><li>  <span class=""><span class="hljs-attr">publicKey</span></span><span class="">: </span><span class="">authPub</span><span class="">,</span></li><li>  <span class=""><span class="hljs-attr">mediation</span></span><span class="">: </span><span class=""><span class="hljs-string">"optional"</span> </span><span class="hljs-keyword">as</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">CredentialMediationRequirement</span></span></li><li><span class="">}</span></li><li>
</li><li><span class="hljs-keyword">try</span> <span class="">{</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">调用</span></span><span class=""><span class="hljs-comment">authenticate</span></span><span class=""><span class="hljs-comment">接口进行认证</span></span></li><li>  <span class="hljs-keyword">let</span> <span class=""><span class="hljs-attr">pkAssertionCredential</span></span><span class="">: </span><span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-property">PublicKeyAssertionCredential</span> </span><span class="">=</span></li><li>    <span class="hljs-keyword">await</span> <span class="">fido2</span><span class="">.</span><span class=""><span class="hljs-title function_">authenticate</span></span><span class="">(</span><span class=""><span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span></span><span class="">, </span><span class="">authCredentialRequestOptions</span><span class="">)</span><span class="">;</span></li><li><span class="">} </span><span class="hljs-keyword">catch</span> <span class="">(</span><span class="">error</span><span class="">) </span><span class="">{</span></li><li>  <span class="hljs-keyword">let</span> <span class="">message </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">message</span></span><span class="">;</span></li><li>  <span class="hljs-keyword">let</span> <span class="">code </span><span class="">= </span><span class="">(</span><span class="">error </span><span class="hljs-keyword">as</span> <span class=""><span class="hljs-title class_">BusinessError</span></span><span class="">)</span><span class="">.</span><span class=""><span class="hljs-property">code</span></span><span class="">;</span></li><li>  <span class=""><span class="hljs-variable language_">console</span></span><span class="">.</span><span class=""><span class="hljs-title function_">error</span></span><span class="">(</span><span class=""><span class="hljs-string">`Failed to call authenticateerror code is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">code</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">, message is </span></span><span class=""><span class="hljs-string"><span class="hljs-subst">${</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">message</span></span></span><span class=""><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class=""><span class="hljs-string">`</span></span><span class="">)</span><span class="">;</span></li><li>  <span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></span></li><li><span class="">}</span></li></ol></pre></div></div></li>        <li>应用使用认证结果（pkAssertionCredential）组装认证响应报文，发送至FIDO服务端进行验证，获取认证结果报文。</li>       </ol></li>     </ol>    </div>   </div>   <div></div></div>