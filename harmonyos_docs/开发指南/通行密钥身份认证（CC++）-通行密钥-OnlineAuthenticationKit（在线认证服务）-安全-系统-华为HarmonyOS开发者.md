<h1 _ngcontent-kel-c119="" class="doc-title ng-star-inserted" title="通行密钥身份认证（C/C++）"> 通行密钥身份认证（C/C++） </h1>

<div _ngcontent-kel-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section775718226239">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section775718226239" tips="复制节点链接"></i></h2>          <p>通行密钥服务主要接口如下表。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.1" valign="top" width="60.050000000000004%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.3.1.2" valign="top" width="39.95%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p>FIDO2_ErrorCode <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/passkey#ga3745265749b2776403960fbeece3de77" target="_blank">HMS_FIDO2_getClientCapability</a>(FIDO2_CapabilityArray ** capability)</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>查询当前设备/版本支持的认证能力列表</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p>FIDO2_ErrorCode <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/passkey#ga18b569cb28a659f4282acbb64e198195" target="_blank">HMS_FIDO2_getPlatformAuthenticator</a>(FIDO2_AuthenticatorMetadataArray **authenticators)</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>查询当前设备/版本支持的平台认证器能力列表（人脸、指纹、PIN码）</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p>FIDO2_ErrorCode <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/passkey#gaaaed812197e7dc4d5f9a3354d5349665" target="_blank">HMS_FIDO2_register</a>(const FIDO2_CredentialCreationOptions options, const FIDO2_TokenBinding tokenBinding, const char * origin, FIDO2_PublicKeyAttestationCredential ** publicKeyAttestationCredential )</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>进行通行密钥的注册</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="60.050000000000004%">          <p>FIDO2_ErrorCode <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/passkey#gaac4365229064efc78dc25dceb7c932a3" target="_blank">HMS_FIDO2_authenticate</a>(const FIDO2_CredentialRequestOptions options, const FIDO2_TokenBinding tokenBinding, const char *origin, FIDO2_PublicKeyAssertionCredential **publicKeyAssertionCredential)</p></td>         <td class="cellrowborder" valign="top" width="39.95%">          <p>进行通行密钥的认证</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section148821850144210">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section148821850144210" tips="复制节点链接"></i></h2>          <p>通行密钥服务提供基于FIDO2标准协议的FIDO客户端实现，这里仅演示FIDO客户端相关API的使用，涉及应用服务器及FIDO服务器的相关处理由开发者自行实现，这里不做介绍，请参考<a href="https://fidoalliance.org/passkeys/" target="_blank">FIDO2标准协议</a>（见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/onlineauthentication-website-disclaimer">网站链接免责声明</a>）。</p>     <div class="p">      在CMake脚本中链接相关动态库。      <div _ngcontent-kel-c106="" class="highlight-div"><div _ngcontent-kel-c106="" class="highlight-div-header"><div _ngcontent-kel-c106="" class="highlight-div-header-left"><div _ngcontent-kel-c106="" class="handle-button expand-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kel-c106="" class="highlight-div-header-right"><div _ngcontent-kel-c106="" class="handle-button ai-button"></div><div _ngcontent-kel-c106="" class="handle-button line-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kel-c106="" class="handle-button theme-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kel-c106="" class="handle-button copy-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kel-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(projectName libfido2_ndk.z.so)</li></ol></pre></div></div>     </div>     <ol>      <li>需要业务方自行根据FIDO2标准协议部署FIDO服务器。</li>      <li>注册通行密钥。       <ol>        <li>获取能力信息，调用HMS_FIDO2_getClientCapability接口获取认证能力列表，并且调用HMS_FIDO2_getPlatformAuthenticator接口获取平台认证器能力信息。         <div _ngcontent-kel-c106="" class="highlight-div"><div _ngcontent-kel-c106="" class="highlight-div-header"><div _ngcontent-kel-c106="" class="highlight-div-header-left"><div _ngcontent-kel-c106="" class="handle-button expand-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kel-c106="" class="highlight-div-header-right"><div _ngcontent-kel-c106="" class="handle-button ai-button"></div><div _ngcontent-kel-c106="" class="handle-button line-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kel-c106="" class="handle-button theme-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kel-c106="" class="handle-button copy-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kel-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"OnlineAuthenticationKit/fido2_api.h"</span></span></li><li>
</li><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">TestGetClientCapability</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取认证能力列表</span></li><li>    FIDO2_CapabilityArray *capability = <span class="hljs-literal">NULL</span>;</li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_getClientCapability</span>(&amp;capability);</li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_CapabilityArray_Destroy</span>(capability);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS; </li><li>}</li><li>
</li><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">GetPlatformAuthenticator</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取平台认证器能力</span></li><li>    FIDO2_AuthenticatorMetadataArray *authenticators = <span class="hljs-literal">NULL</span>;</li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_getPlatformAuthenticator</span>(&amp;authenticators); </li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_AuthenticatorMetadataArray_Destroy</span>(authenticators);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS;</li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务器，获取注册报文，调用HMS_FIDO2_register接口进行注册。         <div _ngcontent-kel-c106="" class="highlight-div"><div _ngcontent-kel-c106="" class="highlight-div-header"><div _ngcontent-kel-c106="" class="highlight-div-header-left"><div _ngcontent-kel-c106="" class="handle-button expand-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kel-c106="" class="highlight-div-header-right"><div _ngcontent-kel-c106="" class="handle-button ai-button"></div><div _ngcontent-kel-c106="" class="handle-button line-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kel-c106="" class="handle-button theme-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kel-c106="" class="handle-button copy-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kel-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">TestReg</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 初始化注册参数，init方法必须调用</span></li><li>    FIDO2_CredentialCreationOptions options;</li><li>    <span class="hljs-built_in">HMS_FIDO2_initCreationOptions</span>(&amp;options);</li><li>
</li><li>    <span class="hljs-comment">// FIDO服务器返回的注册报文，具体报文内容由业务方传入</span></li><li>    FIDO2_PublicKeyCredentialCreationOptions publicKey;  </li><li>
</li><li>    <span class="hljs-comment">// 业务方组装注册信息，包含是否需要用户介入以及注册报文</span></li><li>    options.mediation = FIDO2_CONDITIONAL;</li><li>    options.publicKey = publicKey; </li><li>
</li><li>    <span class="hljs-comment">// 初始化tokenBinding参数，业务方可不赋值，但init方法必须调用</span></li><li>    FIDO2_TokenBinding tokenBinding;</li><li>    <span class="hljs-built_in">HMS_FIDO2_initTokenBinding</span>(&amp;tokenBinding);</li><li>
</li><li>    <span class="hljs-comment">// 测试origin，具体内容由业务方设置</span></li><li>    <span class="hljs-type">char</span> *origin = <span class="hljs-string">"http://www.fidotest.com"</span>; </li><li>
</li><li>    <span class="hljs-comment">// 调用HMS_FIDO2_register进行通行密钥注册</span></li><li>    FIDO2_PublicKeyAttestationCredential* publicKeyAttestationCredential = <span class="hljs-literal">NULL</span>; </li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_register</span>(options, tokenBinding, origin, &amp;publicKeyAttestationCredential);</li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_PublicKeyAttestationCredential_Destroy</span>(publicKeyAttestationCredential);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS;</li><li>}</li></ol></pre></div></div></li>        <li>应用使用注册结果（publicKeyAttestationCredential）组装注册响应报文，发送至FIDO服务端进行验证，获取注册结果报文。</li>       </ol></li>      <li>使用通行密钥进行身份认证。       <ol>        <li>获取能力信息，调用HMS_FIDO2_getClientCapability接口获取认证能力列表，并且调用HMS_FIDO2_getPlatformAuthenticator接口获取平台认证器能力信息。         <div _ngcontent-kel-c106="" class="highlight-div"><div _ngcontent-kel-c106="" class="highlight-div-header"><div _ngcontent-kel-c106="" class="highlight-div-header-left"><div _ngcontent-kel-c106="" class="handle-button expand-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kel-c106="" class="highlight-div-header-right"><div _ngcontent-kel-c106="" class="handle-button ai-button"></div><div _ngcontent-kel-c106="" class="handle-button line-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kel-c106="" class="handle-button theme-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kel-c106="" class="handle-button copy-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kel-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"OnlineAuthenticationKit/fido2_api.h"</span></span></li><li>
</li><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">TestGetClientCapability</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取认证能力列表</span></li><li>    FIDO2_CapabilityArray *capability = <span class="hljs-literal">NULL</span>;</li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_getClientCapability</span>(&amp;capability);</li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_CapabilityArray_Destroy</span>(capability);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS; </li><li>}</li><li>
</li><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">GetPlatformAuthenticator</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 获取平台认证器能力</span></li><li>    FIDO2_AuthenticatorMetadataArray *authenticators = <span class="hljs-literal">NULL</span>;</li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_getPlatformAuthenticator</span>(&amp;authenticators); </li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_AuthenticatorMetadataArray_Destroy</span>(authenticators);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS;</li><li>}</li></ol></pre></div></div></li>        <li>访问FIDO服务器，获取认证报文，调用HMS_FIDO2_authenticate接口进行认证。         <div _ngcontent-kel-c106="" class="highlight-div"><div _ngcontent-kel-c106="" class="highlight-div-header"><div _ngcontent-kel-c106="" class="highlight-div-header-left"><div _ngcontent-kel-c106="" class="handle-button expand-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kel-c106="" class="highlight-div-header-right"><div _ngcontent-kel-c106="" class="handle-button ai-button"></div><div _ngcontent-kel-c106="" class="handle-button line-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kel-c106="" class="handle-button theme-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kel-c106="" class="handle-button copy-button"><div _ngcontent-kel-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kel-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">FIDO2_ErrorCode <span class="hljs-title">TestAuth</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 初始化认证参数，init方法必须调用</span></li><li>    FIDO2_CredentialRequestOptions options;</li><li>    <span class="hljs-built_in">HMS_FIDO2_initRequestOptions</span>(&amp;options);</li><li>
</li><li>    <span class="hljs-comment">// FIDO服务器返回的认证报文，具体报文内容由业务方传入</span></li><li>    FIDO2_PublicKeyCredentialRequestOptions publicKey;  </li><li>
</li><li>    <span class="hljs-comment">// 业务方组装注册信息，包含是否需要用户介入以及注册报文</span></li><li>    options.mediation = FIDO2_CONDITIONAL;</li><li>    options.publicKey = publicKey; </li><li>
</li><li>    <span class="hljs-comment">// 初始化tokenBinding参数，业务方可不赋值，但init方法必须调用</span></li><li>    FIDO2_TokenBinding tokenBinding;</li><li>    <span class="hljs-built_in">HMS_FIDO2_initTokenBinding</span>(&amp;tokenBinding);</li><li>
</li><li>    <span class="hljs-comment">// 测试origin，具体内容由业务方设置</span></li><li>    <span class="hljs-type">char</span> *origin = <span class="hljs-string">"http://www.fidotest.com"</span>; </li><li>
</li><li>    <span class="hljs-comment">// 调用HMS_FIDO2_authenticate进行通行密钥认证</span></li><li>    FIDO2_PublicKeyAssertionCredential *assertionCredential = <span class="hljs-literal">NULL</span>;</li><li>    FIDO2_ErrorCode ret = <span class="hljs-built_in">HMS_FIDO2_authenticate</span>(options, tokenBinding, origin, &amp;assertionCredential);</li><li>
</li><li>    <span class="hljs-comment">// 业务根据错误码判断异常类型，进行相应处理，详见错误码参考</span></li><li>    <span class="hljs-keyword">if</span> (ret != FIDO2_SUCCESS) {</li><li>        <span class="hljs-built_in">HMS_FIDO2_PublicKeyAssertionCredential_Destroy</span>(assertionCredential);</li><li>        <span class="hljs-keyword">return</span> ret;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> FIDO2_SUCCESS;</li><li>}</li></ol></pre></div></div></li>        <li>应用使用认证结果（assertionCredential）组装认证响应报文，发送至FIDO服务端进行验证，获取认证结果报文。</li>       </ol></li>     </ol>    </div>   </div>   <div></div></div>