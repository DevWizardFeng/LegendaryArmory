<h1 _ngcontent-aot-c119="" class="doc-title ng-star-inserted" title="通过XComponent接入无障碍"> 通过XComponent接入无障碍 </h1>

<div _ngcontent-aot-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>通过XComponent接入的三方平台，NDK提供了对接无障碍的接口函数，实现三方平台的组件在ArkUI中的无障碍能力。</p>    <p>首先，需要使用XComponent的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-xcomponent-h#oh_nativexcomponent_getnativeaccessibilityprovider" target="_blank">OH_NativeXComponent_GetNativeAccessibilityProvider</a>获得无障碍接入provider。然后，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_accessibilityproviderregistercallback" target="_blank">OH_ArkUI_AccessibilityProviderRegisterCallback</a>注册接入无障碍所需的回调函数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/accessibility-arkui-accessibilityprovidercallbacks" target="_blank">ArkUI_AccessibilityProviderCallbacks</a>，三方应用需要按照接口要求实现回调函数供无障碍系统调用。</p>    <p>三方应用需要按照要求适配无障碍系统发出的操作<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#arkui_accessibility_actiontype" target="_blank">Action</a>，以及针对组件交互行为发送无障碍事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#arkui_accessibilityeventtype" target="_blank">Event</a>到无障碍子系统，实现无障碍辅助应用的交互体验。</p>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <ul>       <li>无障碍能力：指开发者能够创建可访问的应用界面，满足视觉、听觉、运动和认知障碍等用户需求的能力。</li>       <li>实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_accessibilityproviderregistercallback" target="_blank">OH_ArkUI_AccessibilityProviderRegisterCallback</a>回调查询接口时，查询到的每个无障碍节点信息通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_addandgetaccessibilityelementinfo" target="_blank">OH_ArkUI_AddAndGetAccessibilityElementInfo</a>创建分配element内存，并将其加入到指定的elementList中。</li>       <li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_sendaccessibilityasyncevent" target="_blank">OH_ArkUI_SendAccessibilityAsyncEvent</a>发送事件时，需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_createaccessibilityeventinfo" target="_blank">OH_ArkUI_CreateAccessibilityEventInfo</a>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/i-arkui-accessibility-arkui-accessibilityeventinfo" target="_blank">ArkUI_AccessibilityEventInfo</a>，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_createaccessibilityelementinfo" target="_blank">OH_ArkUI_CreateAccessibilityElementInfo</a>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkui-accessibility-arkui-accessibilityelementinfo" target="_blank">ArkUI_AccessibilityElementInfo</a>，使用结束后，需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_destoryaccessibilityeventinfo" target="_blank">OH_ArkUI_DestoryAccessibilityEventInfo</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#oh_arkui_destoryaccessibilityelementinfo" target="_blank">OH_ArkUI_DestoryAccessibilityElementInfo</a>销毁函数释放内存。</li>       <li>回调函数打印日志时，携带输入的requestId，用于关联一次交互过程相关的日志，便于索引查询整个流程，协助问题定位。</li>      </ul>     </div></div></div>    <div class="tiledSection">     <h2 id="对接无障碍">对接无障碍<i class="anchor-icon anchor-icon-link" anchorid="对接无障碍" tips="复制节点链接"></i></h2>          <p>以下示例提供了对接无障碍能力的实现方法。对接完成后，在开启无障碍功能时，可使XComponent中的三方绘制组件接入，实现无障碍交互。</p>     <p>1.按照自定义渲染（XComponent）的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines#使用oh_arkui_surfaceholder管理surface生命周期">使用OH_ArkUI_SurfaceHolder管理Surface生命周期</a>场景创建前置工程。</p>     <p>2.根据接口定义实现回调函数。</p>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">FindAccessibilityNodeInfosById</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, ArkUI_AccessibilitySearchMode mode, <span class="hljs-type">int32_t</span> requestId, ArkUI_AccessibilityElementInfoList* elementList)</span></li><li>{</li><li>    <span class="hljs-comment">// 根据mode搜集查询element信息列表</span></li><li>    <span class="hljs-keyword">if</span> (elementList == nullptr) {</li><li>        <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_FAILED;</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 调用三方平台的接口搜索查询获得mode符合条件的节点</span></li><li>    <span class="hljs-comment">//...</span></li><li>    <span class="hljs-comment">// nodes为查询节点结果</span></li><li>    <span class="hljs-type">int</span> size = <span class="hljs-keyword">sizeof</span>(nodes) / <span class="hljs-keyword">sizeof</span>(nodes[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {</li><li>        <span class="hljs-comment">// 获取element结构</span></li><li>        element = OH_ArkUI_AddAndGetAccessibilityElementInfo(elementList);</li><li>        <span class="hljs-comment">// 设置element成员内容</span></li><li>        OH_ArkUI_AccessibilityElementInfoSetElementId(element, nodes[i].id);</li><li>        OH_ArkUI_AccessibilityElementInfoSetComponentType(element, nodes[i].type);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">FindNextFocusAccessibilityNode</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, ArkUI_AccessibilityFocusType focusType, <span class="hljs-type">int32_t</span> requestId, ArkUI_AccessibilityElementInfo* elementinfo)</span></li><li>{</li><li>    <span class="hljs-comment">// 根据mode搜集查询element信息列表，参考接口说明实现</span></li><li>    <span class="hljs-keyword">if</span> (elementinfo == nullptr) {</li><li>        <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_FAILED;</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 调用三方平台自身的接口搜索查询获得符合条件的节点</span></li><li>    <span class="hljs-comment">//...</span></li><li>    <span class="hljs-comment">// node为查询节点结果</span></li><li>    <span class="hljs-comment">// 设置element成员内容</span></li><li>    OH_ArkUI_AccessibilityElementInfoSetElementId(element, nodes[i].id);</li><li>    OH_ArkUI_AccessibilityElementInfoSetComponentType(element, nodes[i].type);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">FindAccessibilityNodeInfosByText</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *text, <span class="hljs-type">int32_t</span> requestId, ArkUI_AccessibilityElementInfoList* elementList)</span></li><li>{</li><li>    <span class="hljs-keyword">if</span> (elementList == nullptr) {</li><li>        <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_FAILED;</li><li>    }</li><li>    </li><li>    ArkUI_AccessibilityElementInfo *elementInfo = OH_ArkUI_AddAndGetAccessibilityElementInfo(elementList);</li><li>    </li><li>    <span class="hljs-comment">// 需要三方平台自身设置elementInfo组件属性</span></li><li>    </li><li>    <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>        <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_FAILED;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_SUCCESS;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="c prettyprint linenums hljs language-c" hw-language="c" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">FindFocusedAccessibilityNode</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, ArkUI_AccessibilityFocusType focusType, <span class="hljs-type">int32_t</span> requestId, ArkUI_AccessibilityElementInfo *elementInfo)</span></li><li>{</li><li>    <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>        <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_FAILED;</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 需要三方平台自身设置elementInfo组件属性</span></li><li>    </li><li>    <span class="hljs-keyword">return</span> OH_NATIVEXCOMPONENT_RESULT_SUCCESS;</li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">ExecuteAccessibilityAction</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, ArkUI_Accessibility_ActionType action, ArkUI_AccessibilityActionArguments *actionArguments, <span class="hljs-type">int32_t</span> requestId)</span></li><li>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 获取action argument内容，结合action判断当前需要进行的操作处理</span></li><li>    <span class="hljs-type">char</span>* actionArgumentValue;</li><li>    OH_ArkUI_FindAccessibilityActionArgumentByKey(actionArguments, key.c_str(), &amp;actionArgumentValue);</li><li>    </li><li>    <span class="hljs-comment">// 针对指定组件节点进行操作</span></li><li>    ret = doAction(elementId, action, actionArgumentValue);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 判断当前处理操作类型，返回对应的event结果。每个不同的操作有对应不同的event。参考：ArkUI_AccessibilityEventType定义</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 明确当前上报事件的组件节点为node</span></li><li>    <span class="hljs-comment">// 1.调用OH_ArkUI_CreateAccessibilityEventInfo创建ArkUI_AccessibilityEventInfo</span></li><li>    ArkUI_AccessibilityEventInfo *eventInfo = OH_ArkUI_CreateAccessibilityEventInfo();</li><li>    <span class="hljs-keyword">if</span> (eventInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, LOG_PRINT_TEXT, <span class="hljs-string">"[requestId: %{public}d]DispatchTouchEventCB: Unable to create accessibility eventInfo"</span>, requestId);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 2.调用OH_ArkUI_CreateAccessibilityElementInfo创建ArkUI_AccessibilityElementInfo</span></li><li>    ArkUI_AccessibilityElementInfo *elementInfo = OH_ArkUI_CreateAccessibilityElementInfo();</li><li>    <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, LOG_PRINT_TEXT, <span class="hljs-string">"[requestId: %{public}d]DispatchTouchEventCB: Unable to create accessibility elementInfo"</span>, requestId);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 3.填写element内容</span></li><li>    <span class="hljs-comment">// 设置element成员内容</span></li><li>    OH_ArkUI_AccessibilityElementInfoSetElementId(element, nodes[i].id);</li><li>    OH_ArkUI_AccessibilityElementInfoSetComponentType(element, nodes[i].type);</li><li> </li><li>    OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, LOG_PRINT_TEXT, <span class="hljs-string">"[requestId: %{public}d]DispatchTouchEventCB: send accessibility event"</span>, requestId);</li><li>    <span class="hljs-comment">// 4.eventType根据当前Action设置</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    SendAccessibilityAsyncEvent(eventInfo, elementInfo, eventType);</li><li>    <span class="hljs-comment">// 5.销毁eventInfo，elementInfo内存</span></li><li>    OH_ArkUI_DestoryAccessibilityElementInfo(elementInfo);</li><li>    OH_ArkUI_DestoryAccessibilityEventInfo(eventInfo);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">FillEvent</span><span class="hljs-params">(ArkUI_AccessibilityEventInfo *eventInfo, ArkUI_AccessibilityElementInfo *elementInfo, ArkUI_AccessibilityEventType eventType)</span></li><li>{</li><li>    <span class="hljs-keyword">if</span> (eventInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_TEXT, <span class="hljs-string">"eventInfo is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_TEXT, <span class="hljs-string">"elementInfo is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    OH_ArkUI_AccessibilityEventSetEventType(eventInfo, eventType);</li><li>    </li><li>    OH_ArkUI_AccessibilityEventSetElementInfo(eventInfo, elementInfo);</li><li>    </li><li>}</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">SendAccessibilityAsyncEvent</span><span class="hljs-params">(ArkUI_AccessibilityEventInfo *eventInfo, ArkUI_AccessibilityElementInfo *elementInfo, ArkUI_AccessibilityEventType eventType)</span></li><li>{</li><li>    <span class="hljs-comment">// 1.填写event内容</span></li><li>    FillEvent(eventInfo, elementInfo, ArkUI_AccessibilityEventType::ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_PAGE_STATE_UPDATE);</li><li>    <span class="hljs-comment">// 2.callback</span></li><li>    <span class="hljs-keyword">auto</span> callback = [](<span class="hljs-type">int32_t</span> errorCode){</li><li>         OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, LOG_PRINT_TEXT, <span class="hljs-string">"result: %{public}d"</span>, errorCode);</li><li>    };</li><li>    <span class="hljs-comment">// 3. 调用接口发送事件给OH侧</span></li><li>    OH_ArkUI_SendAccessibilityAsyncEvent(provider_, eventInfo, callback);</li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">ClearFocusedFocusAccessibilityNode</span><span class="hljs-params">()</span></li><li>{</li><li>    <span class="hljs-comment">// 找到当前获焦的组件，并清除焦点状态。</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 无障碍焦点状态</span></li><li>    node.accessibilityFocused = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// 组件焦点状态</span></li><li>    node.focused = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> <span class="hljs-title function_">GetAccessibilityNodeCursorPosition</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> elementId, <span class="hljs-type">int32_t</span> requestId, <span class="hljs-type">int32_t</span>* index)</span></li><li>{</li><li>    <span class="hljs-comment">// 获取文本组件光标位置，并返回</span></li><li>    <span class="hljs-comment">// 查找对应组件节点node</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    *index = node.cursorPosition;</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div>     <p>3.使用XComponent句柄注册无障碍回调函数。</p>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span> <span class="hljs-title function_">PluginRender::RegisterAccessibility</span><span class="hljs-params">(OH_NativeXComponent* nativeXComponent)</span></li><li>{</li><li>    <span class="hljs-comment">//...</span></li><li>    <span class="hljs-comment">//1.获取provider实例，定义”provider_“提供给函数返回</span></li><li>    <span class="hljs-type">int32_t</span> ret = OH_NativeXComponent_GetNativeAccessibilityProvider(nativeXComponent, &amp;provider_);</li><li>    <span class="hljs-keyword">if</span> (provider_ == nullptr) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">//2.注册回调函数，如下相关回调注册函数FindAccessibilityNodeInfosById等，需三方实现函数注册。</span></li><li>    accessibilityProviderCallbacks_ = new ArkUI_AccessibilityProviderCallbacks();</li><li>    accessibilityProviderCallbacks_-&gt;findAccessibilityNodeInfosById = FindAccessibilityNodeInfosById;</li><li>    accessibilityProviderCallbacks_-&gt;findAccessibilityNodeInfosByText = FindAccessibilityNodeInfosByText;</li><li>    accessibilityProviderCallbacks_-&gt;findFocusedAccessibilityNode = FindFocusedAccessibilityNode;</li><li>    accessibilityProviderCallbacks_-&gt;findNextFocusAccessibilityNode = FindNextFocusAccessibilityNode;</li><li>    accessibilityProviderCallbacks_-&gt;executeAccessibilityAction = ExecuteAccessibilityAction;</li><li>    accessibilityProviderCallbacks_-&gt;clearFocusedFocusAccessibilityNode = ClearFocusedFocusAccessibilityNode;</li><li>    accessibilityProviderCallbacks_-&gt;getAccessibilityNodeCursorPosition = GetAccessibilityNodeCursorPosition;</li><li>    ret = OH_ArkUI_AccessibilityProviderRegisterCallback(provider_, accessibilityProviderCallbacks_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li></ol></pre></div></div>     <p>4.组件发生变化时，主动发送事件。参考事件定义<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-accessibility-h#arkui_accessibilityeventtype" target="_blank">ArkUI_AccessibilityEventType</a>说明。</p>     <p>如果因为Touch事件导致页面变化，需要发送页面变化事件ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_PAGE_STATE_UPDATE以及获焦组件位置变化事件ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_FOCUS_NODE_UPDATE给无障碍子系统。</p>     <div _ngcontent-aot-c106="" class="highlight-div"><div _ngcontent-aot-c106="" class="highlight-div-header"><div _ngcontent-aot-c106="" class="highlight-div-header-left"><div _ngcontent-aot-c106="" class="handle-button expand-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aot-c106="" class="highlight-div-header-right"><div _ngcontent-aot-c106="" class="handle-button ai-button"></div><div _ngcontent-aot-c106="" class="handle-button line-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aot-c106="" class="handle-button theme-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aot-c106="" class="handle-button copy-button"><div _ngcontent-aot-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aot-c106="" class="highlight-scroll-div"><pre class="C prettyprint linenums hljs language-C" hw-language="C" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义一个函数DispatchTouchEventCB()，响应触摸事件时触发该回调</span></li><li><span class="hljs-type">void</span> <span class="hljs-title function_">DispatchTouchEventCB</span><span class="hljs-params">(OH_NativeXComponent *component, <span class="hljs-type">void</span> *window)</span></li><li>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// 获取XComponent的id</span></li><li>    <span class="hljs-type">char</span> idStr[OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>] = { <span class="hljs-string">'\0'</span> };</li><li>    <span class="hljs-type">uint64_t</span> idSize = OH_XCOMPONENT_ID_LEN_MAX + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> (OH_NativeXComponent_GetXComponentId(component, idStr, &amp;idSize) != OH_NATIVEXCOMPONENT_RESULT_SUCCESS) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>,</li><li>            <span class="hljs-string">"DispatchTouchEventCB: Unable to get XComponent id"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 判断当前是否已注册无障碍provider</span></li><li>    <span class="hljs-keyword">if</span> (provider_ != nullptr) {</li><li>        </li><li>        <span class="hljs-comment">// 需判断当前Touch事件是否引起了页面变化和当前获焦组件的位置变化。若引起变化，则需要上报无障碍事件，通知无障碍服务以及辅助应用。</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// 明确当前上报事件的组件节点为node</span></li><li>        <span class="hljs-comment">// 1.调用OH_ArkUI_CreateAccessibilityEventInfo创建ArkUI_AccessibilityEventInfo</span></li><li>        ArkUI_AccessibilityEventInfo *eventInfo = OH_ArkUI_CreateAccessibilityEventInfo();</li><li>        <span class="hljs-keyword">if</span> (eventInfo == nullptr) {</li><li>            OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>,</li><li>            <span class="hljs-string">"DispatchTouchEventCB: Unable to create accessibility eventInfo"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 2.调用OH_ArkUI_CreateAccessibilityElementInfo创建ArkUI_AccessibilityElementInfo</span></li><li>        ArkUI_AccessibilityElementInfo *elementInfo = OH_ArkUI_CreateAccessibilityElementInfo();</li><li>        <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>            OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>,</li><li>            <span class="hljs-string">"DispatchTouchEventCB: Unable to create accessibility elementInfo"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 3.填写element内容</span></li><li>        <span class="hljs-comment">// 设置element成员内容</span></li><li>        OH_ArkUI_AccessibilityElementInfoSetElementId(element, nodes[i].id);</li><li>        OH_ArkUI_AccessibilityElementInfoSetComponentType(element, nodes[i].type);</li><li>        <span class="hljs-comment">// ...</span></li><li>        </li><li>        OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"Callback"</span>,</li><li>            <span class="hljs-string">"DispatchTouchEventCB: send accessibility event"</span>);</li><li>        <span class="hljs-comment">// 4.发送页面更新事件</span></li><li>        SendAccessibilityAsyncEvent(eventInfo, elementInfo, ArkUI_AccessibilityEventType::ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_PAGE_STATE_UPDATE);</li><li>        <span class="hljs-comment">// 5.如当前处理引起了获焦组件的位置变化，发送获焦位置变化事件</span></li><li>        SendAccessibilityAsyncEvent(eventInfo, elementInfo, ArkUI_AccessibilityEventType::ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_FOCUS_NODE_UPDATE);</li><li>        <span class="hljs-comment">// 6.销毁eventInfo，elementInfo内存</span></li><li>        OH_ArkUI_DestoryAccessibilityElementInfo(elementInfo);</li><li>        OH_ArkUI_DestoryAccessibilityEventInfo(eventInfo);</li><li>    }</li><li>    </li><li>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">id</span><span class="hljs-params">(idStr)</span>;</li><li>    PluginRender *render = PluginRender::GetInstance(id);</li><li>    <span class="hljs-keyword">if</span> (render != nullptr) {</li><li>        <span class="hljs-comment">// 封装OnTouchEvent方法</span></li><li>        render-&gt;OnTouchEvent(component, window);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">FillEvent</span><span class="hljs-params">(ArkUI_AccessibilityEventInfo *eventInfo, ArkUI_AccessibilityElementInfo *elementInfo, ArkUI_AccessibilityEventType eventType)</span></li><li>{</li><li>    <span class="hljs-keyword">if</span> (eventInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_TEXT, <span class="hljs-string">"eventInfo is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (elementInfo == nullptr) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_TEXT, <span class="hljs-string">"elementInfo is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 1.设置事件类型</span></li><li>    OH_ArkUI_AccessibilityEventSetEventType(eventInfo, eventType);</li><li>    <span class="hljs-comment">// 2.设置发送事件的节点组件信息</span></li><li>    OH_ArkUI_AccessibilityEventSetElementInfo(eventInfo, elementInfo);</li><li>    </li><li>}</li><li><span class="hljs-type">void</span> <span class="hljs-title function_">SendAccessibilityAsyncEvent</span><span class="hljs-params">(ArkUI_AccessibilityEventInfo *eventInfo, ArkUI_AccessibilityElementInfo *elementInfo, ArkUI_AccessibilityEventType eventType)</span></li><li>{</li><li>    <span class="hljs-comment">// 1.填写event内容</span></li><li>    FillEvent(eventInfo, elementInfo, ArkUI_AccessibilityEventType::ARKUI_ACCESSIBILITY_NATIVE_EVENT_TYPE_PAGE_STATE_UPDATE);</li><li>    <span class="hljs-comment">// 2.设置创建callback函数，获取发送事件结果</span></li><li>    <span class="hljs-keyword">auto</span> callback = [](<span class="hljs-type">int32_t</span> errorCode){</li><li>         OH_LOG_Print(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, LOG_PRINT_TEXT, <span class="hljs-string">"result: %{public}d"</span>, errorCode);</li><li>    };</li><li>    <span class="hljs-comment">// 3. 调用接口发送事件给无障碍子系统</span></li><li>    OH_ArkUI_SendAccessibilityAsyncEvent(provider_, eventInfo, callback);</li><li>}</li></ol></pre></div></div>     <p>5.对接成功后，可开启无障碍功能。</p>     <p><span><img originheight="604" originwidth="416" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114748.81260479083611750276887370216662:50001231000000:2800:634B88B8E994E6FB0F73FF70E607DEEFA770FDD304DF998E8FE7955F4632A5D1.png" width="416" height="604"></span></p>    </div>   </div>   <div></div></div>