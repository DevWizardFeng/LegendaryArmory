<h1 _ngcontent-hpd-c119="" class="doc-title ng-star-inserted" title="通过关系型数据库实现数据持久化 (ArkTS)"> 通过关系型数据库实现数据持久化 (ArkTS) </h1>

<div _ngcontent-hpd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>关系型数据库基于SQLite组件，适用于存储包含复杂关系数据的场景，比如一个班级的学生信息，需要包括姓名、学号、各科成绩等，又或者公司的雇员信息，需要包括姓名、工号、职位等，由于数据之间有较强的对应关系，复杂程度比键值型数据更高，此时需要使用关系型数据库来持久化保存数据。</p>     <p>大数据量场景下查询数据可能会导致耗时长甚至应用卡死，如有相关操作可参考文档<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/batch-database-operations-guide">批量数据写数据库场景</a>，且有建议如下：</p>     <ul>      <li>单次查询数据量不超过5000条。</li>      <li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>中查询。</li>      <li>拼接SQL语句尽量简洁。</li>      <li>合理地分批次查询。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="基本概念">基本概念<i class="anchor-icon anchor-icon-link" anchorid="基本概念" tips="复制节点链接"></i></h2>          <ul>      <li>       <p><strong>谓词</strong>：数据库中用来代表数据实体的性质、特征或者数据实体之间关系的词项，主要用来定义数据库的操作条件。</p></li>      <li>       <p><strong>结果集</strong>：指用户查询之后的结果集合，可以对数据进行访问。结果集提供了灵活的数据访问方式，可以更方便地拿到用户想要的数据。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>          <p>关系型数据库对应用提供通用的操作接口，底层使用SQLite作为持久化存储引擎，支持SQLite具有的数据库特性，包括但不限于事务、索引、视图、触发器、外键、参数化查询和预编译SQL语句。</p>     <p><strong>图1</strong> 关系型数据库运作机制</p>     <p><span><img originheight="550" originwidth="385" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114741.31673934603382440486585311061435:50001231000000:2800:C09CFA81A786B79CED56BDE6B5620C2016C0FC60B4C0302D18C5F0210ACEF734.jpg" width="385" height="550"></span></p>    </div>    <div class="tiledSection">     <h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2>          <ul>      <li>       <p>系统默认日志方式是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-terminology#wal模式">WAL</a>（Write Ahead Log）模式，系统默认落盘方式是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-terminology#full模式">FULL模式</a>。</p></li>      <li>       <p>数据库中常驻有4个读连接和1个写连接。读连接会动态扩充，无可用读连接时，会创建新的读连接执行读操作。写连接不会动态扩充，无可用写连接时，会等待连接释放后执行写操作。</p></li>      <li>       <p>为保证数据的准确性，数据库同一时间只能支持一个写操作。</p></li>      <li>       <p>当应用被卸载完成后，设备上的相关数据库文件及临时文件会被自动清除。</p></li>      <li>       <p>ArkTS侧支持的基本数据类型：number、string、二进制类型数据、boolean。</p></li>      <li>       <p>为保证插入并读取数据成功，建议一条数据不要超过2M。超出该大小，插入成功，读取失败。</p></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>以下是关系型数据库持久化功能的相关接口，大部分为异步接口。异步接口均有callback和Promise两种返回形式，下表均以callback形式为例，更多接口及使用方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore" target="_blank">关系型数据库</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.5.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">getRdbStore(context: Context, config: StoreConfig, callback: AsyncCallback&lt;RdbStore&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">获得一个RdbStore，操作关系型数据库，用户可以根据自己的需求配置RdbStore的参数，然后通过RdbStore调用相关接口可以执行相关的数据操作。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">createTransaction(options?: TransactionOptions): Promise&lt;Transaction&gt;</td>         <td class="cellrowborder" valign="top" width="50%">创建一个事务对象并开始事务。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">execute(sql: string, args?: Array&lt;ValueType&gt;):Promise&lt;ValueType&gt;</td>         <td class="cellrowborder" valign="top" width="50%">执行包含指定参数的SQL语句。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">querySql(sql: string, bindArgs?: Array&lt;ValueType&gt;):Promise&lt;ResultSet&gt;</td>         <td class="cellrowborder" valign="top" width="50%">根据指定SQL语句查询数据库中的数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">insert(table: string, values: ValuesBucket, conflict?: ConflictResolution): Promise&lt;number&gt;</td>         <td class="cellrowborder" valign="top" width="50%">向目标表中插入一行数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">update(values: ValuesBucket, predicates: RdbPredicates, callback: AsyncCallback&lt;number&gt;):void</td>         <td class="cellrowborder" valign="top" width="50%">根据predicates的指定实例对象更新数据库中的数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">delete(predicates: RdbPredicates, callback: AsyncCallback&lt;number&gt;):void</td>         <td class="cellrowborder" valign="top" width="50%">根据predicates的指定实例对象从数据库中删除数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">query(predicates: RdbPredicates, columns: Array&lt;string&gt;, callback: AsyncCallback&lt;ResultSet&gt;):void</td>         <td class="cellrowborder" valign="top" width="50%">根据指定条件查询数据库中的数据。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">deleteRdbStore(context: Context, name: string, callback: AsyncCallback&lt;void&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">删除数据库。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">isTokenizerSupported(tokenizer: Tokenizer): boolean</td>         <td class="cellrowborder" valign="top" width="50%">判断当前平台是否支持传入的分词器（将文本分解为更小单元的工具，这些单元可以是单词、子词、字符或者其他语言片段）。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>因Stage模型、FA模型的差异，个别示例代码提供了在两种模型下的对应示例；示例代码未区分模型或没有对应注释说明时默认在两种模型下均适用。</p>     <p>关系型数据库操作或者存储过程中，有可能会因为各种原因发生非预期的数据库异常情况（抛出14800011），此时需要对数据库进行重建并恢复数据，以保障正常的应用开发，具体可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-backup-and-restore#关系型数据库异常重建">关系型数据库异常重建</a>。</p>     <ol>      <li>       <p>使用关系型数据库实现数据持久化，需要获取一个RdbStore，其中包括建库、建表、升降级等操作。示例代码如下所示：</p>       <p>Stage模型示例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>; <span class="hljs-comment">// 导入模块</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-comment">// 此处示例在Ability中实现，使用者也可以在其他合理场景中使用</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-comment">// 若希望使用分词器，可调用isTokenizerSupported检查希望使用的分词器是否支持当前平台。</span></li><li>    <span class="hljs-keyword">let</span> tokenType = relationalStore.<span class="hljs-property">Tokenizer</span>.<span class="hljs-property">ICU_TOKENIZER</span>;</li><li>    <span class="hljs-keyword">let</span> tokenTypeSupported = relationalStore.<span class="hljs-title function_">isTokenizerSupported</span>(tokenType);</li><li>    <span class="hljs-keyword">if</span> (!tokenTypeSupported) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`ICU_TOKENIZER is not supported on this platform.`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>      <span class="hljs-comment">// 数据库文件名</span></li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">'RdbTest.db'</span>,</li><li>      <span class="hljs-comment">// 数据库安全级别</span></li><li>      <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span>,</li><li>      <span class="hljs-comment">// 可选参数，指定数据库是否加密，默认不加密</span></li><li>      <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-comment">// 可选参数，数据库自定义路径。默认在本应用沙箱目录下创建RdbStore实例。</span></li><li>      <span class="hljs-attr">customDir</span>: <span class="hljs-string">'customDir/subCustomDir'</span>,</li><li>      <span class="hljs-comment">// 可选参数，指定数据库是否以只读方式打开。默认为false，表示数据库可读可写。为true时，只允许从数据库读取数据，不允许对数据库进行写操作，否则会返回错误码801。</span></li><li>      <span class="hljs-attr">isReadOnly</span>: <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-comment">// 可选参数，指定用户在全文搜索场景(FTS)下使用哪种分词器。默认在FTS下仅支持英文分词，不支持其他语言分词。</span></li><li>      <span class="hljs-attr">tokenizer</span>: tokenType</li><li>    };</li><li>
</li><li>    <span class="hljs-comment">// 判断数据库版本，如果不匹配则需进行升降级操作</span></li><li>    <span class="hljs-comment">// 假设当前数据库版本为3，表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, IDENTITY)</span></li><li>    <span class="hljs-comment">// 建表Sql语句, IDENTITY为bigint类型，sql中指定类型为UNLIMITED INT</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SQL_CREATE_TABLE</span> =</li><li>      <span class="hljs-string">'CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB, IDENTITY UNLIMITED INT)'</span>;</li><li>
</li><li>    relationalStore.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable constant_">STORE_CONFIG</span>, <span class="hljs-keyword">async</span> (err, store) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting RdbStore.'</span>);</li><li>      <span class="hljs-keyword">let</span> storeVersion = store.<span class="hljs-property">version</span>;</li><li>      <span class="hljs-comment">// 当数据库创建时，数据库默认版本为0</span></li><li>      <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-variable constant_">SQL_CREATE_TABLE</span>); <span class="hljs-comment">// 创建数据表，以便后续调用insert接口插入数据</span></li><li>          storeVersion = <span class="hljs-number">3</span>;</li><li>          <span class="hljs-comment">// 设置数据库的版本，入参为大于0的整数</span></li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        }</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 如果数据库版本不为0且和当前数据库版本不匹配，需要进行升降级操作</span></li><li>      <span class="hljs-comment">// 当前数据库存在并且版本为1，数据库需要从1版本升级到2版本</span></li><li>      <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-comment">// version = 1：表结构：EMPLOYEE (NAME, SALARY, CODES, ADDRESS) =&gt; version = 2：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS)</span></li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-string">'ALTER TABLE EMPLOYEE ADD COLUMN AGE INTEGER'</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Upgrade store version from 1 to 2 success."</span>)</li><li>          storeVersion = <span class="hljs-number">2</span>;</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        }</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 当前数据库存在并且版本为2，数据库需要从2版本升级到3版本</span></li><li>      <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-comment">// version = 2：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS) =&gt; version = 3：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES)</span></li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-string">'ALTER TABLE EMPLOYEE DROP COLUMN ADDRESS'</span>);</li><li>          storeVersion = <span class="hljs-number">3</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Upgrade store version from 2 to 3 success."</span>)</li><li>        } <span class="hljs-keyword">catch</span> (e) {</li><li>          <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        }</li><li>      }</li><li>      store.<span class="hljs-property">version</span> = storeVersion;</li><li>      <span class="hljs-comment">// 请确保获取到RdbStore实例，完成数据表创建后，再进行数据库的增、删、改、查等操作</span></li><li>    });</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>FA模型示例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>; <span class="hljs-comment">// 导入模块</span></li><li><span class="hljs-keyword">import</span> { featureAbility } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> context = featureAbility.<span class="hljs-title function_">getContext</span>();</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">'RdbTest.db'</span>, <span class="hljs-comment">// 数据库文件名</span></li><li>  <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S3</span> <span class="hljs-comment">// 数据库安全级别</span></li><li>};</li><li>
</li><li><span class="hljs-comment">// 假设当前数据库版本为3，表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, IDENTITY)</span></li><li><span class="hljs-comment">// 建表Sql语句，IDENTITY为bigint类型，sql中指定类型为UNLIMITED INT</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SQL_CREATE_TABLE</span> =</li><li>  <span class="hljs-string">'CREATE TABLE IF NOT EXISTS EMPLOYEE (ID INTEGER PRIMARY KEY AUTOINCREMENT, NAME TEXT NOT NULL, AGE INTEGER, SALARY REAL, CODES BLOB, IDENTITY UNLIMITED INT)'</span>;</li><li>
</li><li>relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">STORE_CONFIG</span>, <span class="hljs-keyword">async</span> (err, store) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to get RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in getting RdbStore.'</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> storeVersion = store.<span class="hljs-property">version</span>;</li><li>  <span class="hljs-comment">// 当数据库创建时，数据库默认版本为0</span></li><li>  <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-variable constant_">SQL_CREATE_TABLE</span>); <span class="hljs-comment">// 创建数据表，以便后续调用insert接口插入数据</span></li><li>      <span class="hljs-comment">// 设置数据库的版本，入参为大于0的整数</span></li><li>      storeVersion = <span class="hljs-number">3</span>;</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 如果数据库版本不为0且和当前数据库版本不匹配，需要进行升降级操作</span></li><li>  <span class="hljs-comment">// 当前数据库存在并且版本为1，数据库需要从1版本升级到2版本</span></li><li>  <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">1</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// version = 1：表结构：EMPLOYEE (NAME, SALARY, CODES, ADDRESS) =&gt; version = 2：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS)</span></li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-string">'ALTER TABLE EMPLOYEE ADD COLUMN AGE INTEGER'</span>);</li><li>      storeVersion = <span class="hljs-number">2</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Upgrade store version from 1 to 2 success."</span>)</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 当前数据库存在并且版本为2，数据库需要从2版本升级到3版本</span></li><li>  <span class="hljs-keyword">if</span> (storeVersion === <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// version = 2：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES, ADDRESS) =&gt; version = 3：表结构：EMPLOYEE (NAME, AGE, SALARY, CODES)</span></li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-string">'ALTER TABLE EMPLOYEE DROP COLUMN ADDRESS'</span>);</li><li>      storeVersion = <span class="hljs-number">3</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Upgrade store version from 2 to 3 success."</span>)</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">const</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to execute sql. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>  store.<span class="hljs-property">version</span> = storeVersion;</li><li>  <span class="hljs-comment">// 请确保获取到RdbStore实例，完成数据表创建后，再进行数据库的增、删、改、查等操作</span></li><li>});</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>           <p>应用创建的数据库与其上下文（Context）有关，即使使用同样的数据库名称，但不同的应用上下文，会产生多个数据库，例如每个UIAbility都有各自的上下文。</p></li>          <li>           <p>当应用首次获取数据库（调用getRdbStore）后，在应用沙箱内会产生对应的数据库文件。使用数据库的过程中，在与数据库文件相同的目录下可能会产生以-wal和-shm结尾的临时文件。此时若开发者希望移动数据库文件到其它地方使用查看，则需要同时移动这些临时文件，当应用被卸载完成后，其在设备上产生的数据库文件及临时文件也会被移除。</p></li>          <li>           <p>错误码的详细介绍请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-universal" target="_blank">通用错误码</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-data-rdb" target="_blank">关系型数据库错误码</a>。</p></li>         </ul>        </div></div></div></li>      <li>       <p>获取到RdbStore，完成数据表创建后，调用insert()接口插入数据。示例代码如下所示：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> value1 = <span class="hljs-string">'Lisa'</span>;</li><li><span class="hljs-keyword">let</span> value2 = <span class="hljs-number">18</span>;</li><li><span class="hljs-keyword">let</span> value3 = <span class="hljs-number">100.5</span>;</li><li><span class="hljs-keyword">let</span> value4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);</li><li><span class="hljs-keyword">let</span> value5 = <span class="hljs-title class_">BigInt</span>(<span class="hljs-string">'15822401018187971961171'</span>);</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">valueBucket</span>: relationalStore.<span class="hljs-property">ValuesBucket</span> = {</li><li>  <span class="hljs-attr">NAME</span>: value1,</li><li>  <span class="hljs-attr">AGE</span>: value2,</li><li>  <span class="hljs-attr">SALARY</span>: value3,</li><li>  <span class="hljs-attr">CODES</span>: value4,</li><li>  <span class="hljs-attr">IDENTITY</span>: value5,</li><li>};</li><li>
</li><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> rowId = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">insert</span>(<span class="hljs-string">'EMPLOYEE'</span>, valueBucket);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in inserting data. rowId:<span class="hljs-subst">${rowId}</span>`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to insert data. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>关系型数据库没有显式的flush操作实现持久化，数据插入即保存在持久化文件。</p>        </div></div></div></li>      <li>       <p>根据谓词指定的实例对象，对数据进行修改或删除。</p>       <p>调用update()方法修改数据，调用delete()方法删除数据。示例代码如下所示：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> value6 = <span class="hljs-string">'Rose'</span>;</li><li><span class="hljs-keyword">let</span> value7 = <span class="hljs-number">22</span>;</li><li><span class="hljs-keyword">let</span> value8 = <span class="hljs-number">200.5</span>;</li><li><span class="hljs-keyword">let</span> value9 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);</li><li><span class="hljs-keyword">let</span> value10 = <span class="hljs-title class_">BigInt</span>(<span class="hljs-string">'15822401018187971967863'</span>);</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">valueBucket2</span>: relationalStore.<span class="hljs-property">ValuesBucket</span> = {</li><li>  <span class="hljs-attr">NAME</span>: value6,</li><li>  <span class="hljs-attr">AGE</span>: value7,</li><li>  <span class="hljs-attr">SALARY</span>: value8,</li><li>  <span class="hljs-attr">CODES</span>: value9,</li><li>  <span class="hljs-attr">IDENTITY</span>: value10,</li><li>};</li><li>
</li><li><span class="hljs-comment">// 修改数据</span></li><li><span class="hljs-keyword">let</span> predicates1 = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>); <span class="hljs-comment">// 创建表'EMPLOYEE'的predicates</span></li><li>predicates1.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'NAME'</span>, <span class="hljs-string">'Lisa'</span>); <span class="hljs-comment">// 匹配表'EMPLOYEE'中'NAME'为'Lisa'的字段</span></li><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  (store <span class="hljs-keyword">as</span> relationalStore.<span class="hljs-property">RdbStore</span>).<span class="hljs-title function_">update</span>(valueBucket2, predicates1, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, rows: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to update data. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>     <span class="hljs-keyword">return</span>;</li><li>   }</li><li>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in updating data. row count: <span class="hljs-subst">${rows}</span>`</span>);</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-comment">// 删除数据</span></li><li>predicates1 = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>predicates1.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'NAME'</span>, <span class="hljs-string">'Lisa'</span>);</li><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  (store <span class="hljs-keyword">as</span> relationalStore.<span class="hljs-property">RdbStore</span>).<span class="hljs-title function_">delete</span>(predicates1, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, rows: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete data. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Delete rows: <span class="hljs-subst">${rows}</span>`</span>);</li><li>  })</li><li>}</li></ol></pre></div></div></li>      <li>       <p>根据谓词指定的查询条件查找数据。</p>       <p>调用query()方法查找数据，返回一个ResultSet结果集。示例代码如下所示：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> predicates2 = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>predicates2.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'NAME'</span>, <span class="hljs-string">'Rose'</span>);</li><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  (store <span class="hljs-keyword">as</span> relationalStore.<span class="hljs-property">RdbStore</span>).<span class="hljs-title function_">query</span>(predicates2, [<span class="hljs-string">'ID'</span>, <span class="hljs-string">'NAME'</span>, <span class="hljs-string">'AGE'</span>, <span class="hljs-string">'SALARY'</span>, <span class="hljs-string">'IDENTITY'</span>], <span class="hljs-function">(<span class="hljs-params">err: BusinessError, resultSet</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query data. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ResultSet column names: <span class="hljs-subst">${resultSet.columnNames}</span>, column count: <span class="hljs-subst">${resultSet.columnCount}</span>`</span>);</li><li>    <span class="hljs-comment">// resultSet是一个数据集合的游标，默认指向第-1个记录，有效的数据从0开始。</span></li><li>    <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>()) {</li><li>      <span class="hljs-keyword">const</span> id = resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'ID'</span>));</li><li>      <span class="hljs-keyword">const</span> name = resultSet.<span class="hljs-title function_">getString</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'NAME'</span>));</li><li>      <span class="hljs-keyword">const</span> age = resultSet.<span class="hljs-title function_">getLong</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'AGE'</span>));</li><li>      <span class="hljs-keyword">const</span> salary = resultSet.<span class="hljs-title function_">getDouble</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'SALARY'</span>));</li><li>      <span class="hljs-keyword">const</span> identity = resultSet.<span class="hljs-title function_">getValue</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'IDENTITY'</span>));</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`id=<span class="hljs-subst">${id}</span>, name=<span class="hljs-subst">${name}</span>, age=<span class="hljs-subst">${age}</span>, salary=<span class="hljs-subst">${salary}</span>, identity=<span class="hljs-subst">${identity}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 释放数据集的内存</span></li><li>    resultSet.<span class="hljs-title function_">close</span>();</li><li>  })</li><li>}</li></ol></pre></div></div>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>当应用完成查询数据操作，不再使用结果集（ResultSet）时，请及时调用close方法关闭结果集，释放系统为其分配的内存。</p>        </div></div></div>       <p>当前RDB还支持进行FTS全文检索，可以根据中文或者英文进行文本检索，针对中文分词器支持ICU分词器。</p>       <p>以中文关键字检索为例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-comment">// 创建全文检索表</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SQL_CREATE_TABLE</span> = <span class="hljs-string">'CREATE VIRTUAL TABLE IF NOT EXISTS example USING fts4(name, content, tokenize=icu zh_CN)'</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">execute</span>(<span class="hljs-variable constant_">SQL_CREATE_TABLE</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in creating fts table.'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to creating fts table. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>  }</li><li>}</li><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> resultSet = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">querySql</span>(<span class="hljs-string">'SELECT name FROM example WHERE example MATCH ?'</span>, [<span class="hljs-string">'测试'</span>]);</li><li>    <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>()) {</li><li>      <span class="hljs-keyword">const</span> name = resultSet.<span class="hljs-title function_">getValue</span>(resultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'name'</span>));</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`name=<span class="hljs-subst">${name}</span>`</span>);</li><li>    }</li><li>    resultSet.<span class="hljs-title function_">close</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Query failed. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>.`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使用事务对象执行数据的插入、删除和更新操作。</p>       <p>调用createTransaction方法创建事务对象并执行相应操作。</p>       <p>支持配置的事务类型有DEFERRED、IMMEDIATE和EXCLUSIVE，默认为DEFERRED。</p>       <p>具体信息请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#createtransaction14" target="_blank">关系型数据库</a>。</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-comment">// 创建事务对象</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> transaction = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">createTransaction</span>();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 使用事务对象插入数据</span></li><li>      <span class="hljs-keyword">const</span> rowId = <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">insert</span>(</li><li>        <span class="hljs-string">'EMPLOYEE'</span>,</li><li>        {</li><li>          <span class="hljs-attr">NAME</span>: <span class="hljs-string">'Lisa'</span>,</li><li>          <span class="hljs-attr">AGE</span>: <span class="hljs-number">18</span>,</li><li>          <span class="hljs-attr">SALARY</span>: <span class="hljs-number">100.5</span>,</li><li>          <span class="hljs-attr">CODES</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])</li><li>        },</li><li>        relationalStore.<span class="hljs-property">ConflictResolution</span>.<span class="hljs-property">ON_CONFLICT_REPLACE</span></li><li>      );</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Insert is successful, rowId = <span class="hljs-subst">${rowId}</span>`</span>);</li><li>
</li><li>      <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>      predicates.<span class="hljs-title function_">equalTo</span>(<span class="hljs-string">'NAME'</span>, <span class="hljs-string">'Lisa'</span>);</li><li>      <span class="hljs-comment">// 使用事务对象更新数据</span></li><li>      <span class="hljs-keyword">const</span> rows = <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">update</span>(</li><li>        {</li><li>          <span class="hljs-attr">NAME</span>: <span class="hljs-string">'Rose'</span>,</li><li>          <span class="hljs-attr">AGE</span>: <span class="hljs-number">22</span>,</li><li>          <span class="hljs-attr">SALARY</span>: <span class="hljs-number">200.5</span>,</li><li>          <span class="hljs-attr">CODES</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])</li><li>        },</li><li>        predicates,</li><li>        relationalStore.<span class="hljs-property">ConflictResolution</span>.<span class="hljs-property">ON_CONFLICT_REPLACE</span></li><li>      );</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Updated row count: <span class="hljs-subst">${rows}</span>`</span>);</li><li>
</li><li>      <span class="hljs-comment">// 使用事务对象删除数据</span></li><li>      <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">execute</span>(<span class="hljs-string">'DELETE FROM EMPLOYEE WHERE age = ? OR age = ?'</span>, [<span class="hljs-number">21</span>, <span class="hljs-number">20</span>]);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`execute delete success`</span>);</li><li>
</li><li>      <span class="hljs-comment">// 提交事务</span></li><li>      <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">commit</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Transaction commit success.'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-comment">// 执行失败回滚事务</span></li><li>      <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">rollback</span>();</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Transaction execute failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`createTransaction failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>在同路径下备份数据库。关系型数据库支持手动备份和自动备份（仅系统应用可用）两种方式，具体可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-backup-and-restore#关系型数据库备份">关系型数据库备份</a>。</p>       <p>此处以手动备份为例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-comment">// "Backup.db"为备份数据库文件名，默认在RdbStore同路径下备份。也可指定路径：customDir + "backup.db"</span></li><li>  (store <span class="hljs-keyword">as</span> relationalStore.<span class="hljs-property">RdbStore</span>).<span class="hljs-title function_">backup</span>(<span class="hljs-string">"Backup.db"</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to backup RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in backing up RdbStore.`</span>);</li><li>  })</li><li>}</li></ol></pre></div></div></li>      <li>       <p>从备份数据库中恢复数据。关系型数据库支持两种方式：恢复手动备份数据和恢复自动备份数据（仅系统应用可用），具体可见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-backup-and-restore#关系型数据库数据恢复">关系型数据库数据恢复</a>。</p>       <p>此处以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#restore" target="_blank">restore</a>接口恢复手动备份数据为例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (store !== <span class="hljs-literal">undefined</span>) {</li><li>  (store <span class="hljs-keyword">as</span> relationalStore.<span class="hljs-property">RdbStore</span>).<span class="hljs-title function_">restore</span>(<span class="hljs-string">"Backup.db"</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to restore RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in restoring RdbStore.`</span>);</li><li>  })</li><li>}</li></ol></pre></div></div></li>      <li>       <p>删除数据库。</p>       <p>调用deleteRdbStore()方法，删除数据库及数据库相关文件。示例代码如下：</p>       <p>Stage模型示例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">'RdbTest.db'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li> <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in deleting RdbStore.'</span>);</li><li>});</li></ol></pre></div></div>       <p>FA模型示例：</p>       <div _ngcontent-hpd-c106="" class="highlight-div"><div _ngcontent-hpd-c106="" class="highlight-div-header"><div _ngcontent-hpd-c106="" class="highlight-div-header-left"><div _ngcontent-hpd-c106="" class="handle-button expand-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hpd-c106="" class="highlight-div-header-right"><div _ngcontent-hpd-c106="" class="handle-button ai-button"></div><div _ngcontent-hpd-c106="" class="handle-button line-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hpd-c106="" class="handle-button theme-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hpd-c106="" class="handle-button copy-button"><div _ngcontent-hpd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hpd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>relationalStore.<span class="hljs-title function_">deleteRdbStore</span>(context, <span class="hljs-string">'RdbTest.db'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in deleting RdbStore.'</span>);</li><li>});</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/HarmonyOS_Samples/guide-snippets/tree/HarmonyOS-feature-20250915/ArkData/RelationalStore/DataSyncAndPersistence" target="_blank"> 通过关系型数据库实现数据持久化和跨设备数据同步 (ArkTS)</a></li>     </ul>    </div>   </div>   <div></div></div>