<h1 _ngcontent-tqp-c119="" class="doc-title ng-star-inserted" title="通过用户首选项实现数据持久化 (ArkTS)"> 通过用户首选项实现数据持久化 (ArkTS) </h1>

<div _ngcontent-tqp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="场景介绍">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="场景介绍" tips="复制节点链接"></i></h2>          <p>用户首选项(Preferences)为应用提供Key-Value键值型的数据处理能力，支持应用持久化轻量级数据，并对其修改和查询。当用户有轻量级的键值型数据需要存储时，可以采用Preferences来进行存储。一般适用于保存用户的个性化设置，例如字体大小、是否开启夜间模式等。</p>    </div>    <div class="tiledSection">     <h2 id="运作机制">运作机制<i class="anchor-icon anchor-icon-link" anchorid="运作机制" tips="复制节点链接"></i></h2>          <p>如图所示，用户程序通过ArkTS接口调用用户首选项读写对应的数据文件。开发者可以将用户首选项持久化文件的内容加载到Preferences实例，每个文件唯一对应到一个Preferences实例，系统会通过静态容器将该实例存储在内存中，直到主动从内存中移除该实例或删除该文件。</p>     <p>应用首选项的持久化文件保存在应用沙箱内部，可以通过context获取其路径。具体请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径">获取应用文件路径</a>。</p>     <p><strong>图1</strong> 用户首选项运作机制</p>     <p><span><img originheight="865" originwidth="1383" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114727.72863909207541289563430872722308:50001231000000:2800:75FB81D3829C44B185AF4974781987DF53A8BAAFAAF35138A5FF85EF42EB1192.jpg" width="920" height="575.4157628344179"></span></p>    </div>    <div class="tiledSection">     <h2 id="存储模式说明">存储模式说明<i class="anchor-icon anchor-icon-link" anchorid="存储模式说明" tips="复制节点链接"></i></h2>          <p>用户首选项默认使用XML格式进行存储，从API version 18开始，可选择GSKV存储模式。</p>    </div>    <div class="tiledSection">     <h3 id="xml存储" class="firsth2">XML存储<i class="anchor-icon anchor-icon-link" anchorid="xml存储" tips="复制节点链接"></i></h3>          <p>XML存储指的是数据会以XML的形式存储到文件中，该模式的优点是通用性强，支持跨平台。当选择该模式时，首选项对数据的操作主要发生在内存中，开发者可以在需要的时候再调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences#flush" target="_blank">flush</a>接口进行数据持久化。针对单进程、小数据量场景，推荐使用该存储模式。</p>    </div>    <div class="tiledSection">     <h3 id="gskv存储">GSKV存储<i class="anchor-icon anchor-icon-link" anchorid="gskv存储" tips="复制节点链接"></i></h3>          <p>GSKV是从API version 18起提供的一种存储模式，数据以二进制的形式存储在文件中，该模式的优点是支持多进程并发读写。当选择该模式时，首选项对数据的操作会实时落盘。针对多进程并发场景，推荐使用该存储模式。</p>    </div>    <div class="tiledSection">     <h2 id="约束限制">约束限制<i class="anchor-icon anchor-icon-link" anchorid="约束限制" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="首选项通用限制" class="firsth2">首选项通用限制<i class="anchor-icon anchor-icon-link" anchorid="首选项通用限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>Key键为string类型，要求非空且长度不超过1024个字节。</p></li>      <li>       <p>如果Value值为string类型，请使用UTF-8编码格式，可以为空，不为空时长度不超过16MB。</p></li>      <li>       <p>当调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences#preferencesremovepreferencesfromcache" target="_blank">removePreferencesFromCache</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences#preferencesdeletepreferences" target="_blank">deletePreferences</a>后，订阅的数据变更会主动取消订阅，重新<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences#preferencesgetpreferences" target="_blank">getPreferences</a>后需要重新订阅数据变更。</p></li>      <li>       <p>不允许deletePreferences与其他接口多线程、多进程并发调用，否则可能会发生不可预期行为。</p></li>      <li>       <p>不支持数据加密存储。如果需要进行数据加密，应用应该先将数据进行加密，然后将密文通过Uint8Array类型存储到Preferences中。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="xml模式约束限制">XML模式约束限制<i class="anchor-icon anchor-icon-link" anchorid="xml模式约束限制" tips="复制节点链接"></i></h3>          <ul>      <li>       <p>XML模式（首选项的默认模式）无法保证进程并发安全，会有文件损坏和数据丢失的风险，不支持在多进程场景下使用。</p></li>      <li>       <p>当存储的数据中包含非UTF-8格式的字符串时，请使用Uint8Array类型存储，否则会造成持久化文件出现格式错误造成文件损坏。</p></li>      <li>       <p>内存会随着存储数据量的增大而增大，所以存储的数据量应该是轻量级的，建议存储的数据不超过50MB。数据量较大时，在使用同步接口创建Preferences对象和持久化数据时会成为耗时操作，不建议在主线程中使用，否则可能会出现appfreeze问题。</p></li>     </ul>    </div>    <div class="tiledSection">     <h3 id="gskv模式约束限制">GSKV模式约束限制<i class="anchor-icon anchor-icon-link" anchorid="gskv模式约束限制" tips="复制节点链接"></i></h3>          <ul>      <li>GSKV模式不支持跨平台，使用该模式前需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences#preferencesisstoragetypesupported18" target="_blank">isStorageTypeSupported</a>接口判断当前平台是否支持该模式。</li>     </ul>    </div>    <div class="tiledSection">     <h2 id="接口说明">接口说明<i class="anchor-icon anchor-icon-link" anchorid="接口说明" tips="复制节点链接"></i></h2>          <p>以下是用户首选项持久化功能的相关接口，更多接口及使用方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-preferences" target="_blank">用户首选项</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.10.3.1.3.1.1" valign="top" width="50%">接口名称</th>         <th align="left" class="cellrowborder" id="mcps1.3.10.3.1.3.1.2" valign="top" width="50%">描述</th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="50%">getPreferencesSync(context: Context, options: Options): Preferences</td>         <td class="cellrowborder" valign="top" width="50%">获取Preferences实例。该接口存在异步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">putSync(key: string, value: ValueType): void</td>         <td class="cellrowborder" valign="top" width="50%">将数据写入Preferences实例，可通过flush将Preferences实例持久化。该接口存在异步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">hasSync(key: string): boolean</td>         <td class="cellrowborder" valign="top" width="50%">检查Preferences实例是否包含名为给定Key的存储键值对，true表示包含，false表示不包含。给定的Key值不能为空。该接口存在异步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">getSync(key: string, defValue: ValueType): ValueType</td>         <td class="cellrowborder" valign="top" width="50%">获取键对应的值，如果值为null或非默认值类型，将返回默认数据defValue。该接口存在异步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">deleteSync(key: string): void</td>         <td class="cellrowborder" valign="top" width="50%">从Preferences实例中删除名为给定Key的存储键值对。该接口存在异步接口。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">flush(callback: AsyncCallback&lt;void&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">将当前Preferences实例的数据异步存储到用户首选项持久化文件中。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">on(type: 'change', callback: Callback&lt;string&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">订阅数据变更，订阅的数据发生变更后，在执行flush方法后，触发callback回调。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">off(type: 'change', callback?: Callback&lt;string&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">取消订阅数据变更。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">deletePreferences(context: Context, options: Options, callback: AsyncCallback&lt;void&gt;): void</td>         <td class="cellrowborder" valign="top" width="50%">从内存中移除指定的Preferences实例。若Preferences实例有对应的持久化文件，则同时删除其持久化文件。</td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="50%">isStorageTypeSupported(type: StorageType): boolean</td>         <td class="cellrowborder" valign="top" width="50%">判断当前平台是否支持希望使用的存储模式。true表示支持，false表示不支持。</td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>导入@kit.ArkData模块。</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { preferences } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;</li></ol></pre></div></div></li>      <li>       <p>（可选）选择存储模式。</p>       <p>该步骤为可选步骤。首选项默认使用XML模式存储数据，从API version 18开始，新增提供并支持使用GSKV存储模式。</p>       <p>在选择GSKV存储模式之前，需要使用isStorageTypeSupported()接口判断当前平台是否支持GSKV模式。</p>       <p>若接口返回false，则说明当前平台不支持GSKV模式，请使用XML模式进行数据存储。</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-keyword">let</span> isGskvSupported = preferences.<span class="hljs-title function_">isStorageTypeSupported</span>(preferences.<span class="hljs-property">StorageType</span>.<span class="hljs-property">GSKV</span>);</li><li> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Is gskv supported on this platform: "</span> + isGskvSupported);</li></ol></pre></div></div></li>      <li>       <p>获取Preferences实例。</p>       <p>针对默认的XML存储模式，使用getPreferencesSync()方法获取Preferences实例。</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dataPreferences</span>: preferences.<span class="hljs-property">Preferences</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: preferences.<span class="hljs-property">Options</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">'myStore'</span> };</li><li>    dataPreferences = preferences.<span class="hljs-title function_">getPreferencesSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, options);</li><li>  }</li><li>}</li></ol></pre></div></div>       <p>针对GSKV存储模式，使用getPreferencesSync()方法获取Preferences实例。</p>       <p>若希望使用GSKV存储模式且当前平台支持该模式，可以通过以下方式获取GSKV存储模式的Preferences实例。需要注意的是，当选择某一存储模式后，不允许再对存储模式进行切换。</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">dataPreferences</span>: preferences.<span class="hljs-property">Preferences</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: preferences.<span class="hljs-property">Options</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">'myStore'</span>, <span class="hljs-attr">storageType</span>: preferences.<span class="hljs-property">StorageType</span>.<span class="hljs-property">GSKV</span> };</li><li>    dataPreferences = preferences.<span class="hljs-title function_">getPreferencesSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, options);</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>写入数据。</p>       <p>使用putSync()方法将数据写入Preferences实例中。</p>       <p>针对默认存储模式（XML存储模式），在写入数据后，如有需要，可使用flush()方法将Preferences实例的数据存储到持久化文件。</p>       <p>针对GSKV存储模式，在写入数据后，数据会实时持久化到文件中。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>当对应的键已经存在时，putSync()方法会覆盖其值。可以使用hasSync()方法检查是否存在对应键值对。</p>        </div></div></div>       <p>示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">if</span> (dataPreferences.<span class="hljs-title function_">hasSync</span>(<span class="hljs-string">'startup'</span>)) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The key 'startup' is contained."</span>);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The key 'startup' does not contain."</span>);</li><li>  <span class="hljs-comment">// 此处以此键值对不存在时写入数据为例</span></li><li>  dataPreferences.<span class="hljs-title function_">putSync</span>(<span class="hljs-string">'startup'</span>, <span class="hljs-string">'auto'</span>);</li><li>  <span class="hljs-comment">// 在XML模式下，当字符串包含非UTF-8格式的字符时，需要将字符串转为Uint8Array类型再存储，长度均不超过16 * 1024 * 1024个字节。</span></li><li>  <span class="hljs-keyword">let</span> uInt8Array1 = <span class="hljs-keyword">new</span> util.<span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encodeInto</span>(<span class="hljs-string">"~！@#￥%……&amp;*（）——+？"</span>);</li><li>  dataPreferences.<span class="hljs-title function_">putSync</span>(<span class="hljs-string">'uInt8'</span>, uInt8Array1);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>读取数据。</p>       <p>使用getSync()方法获取数据，即指定键对应的值。如果值为null或非默认值类型，则返回默认数据。</p>       <p>示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> val = dataPreferences.<span class="hljs-title function_">getSync</span>(<span class="hljs-string">'startup'</span>, <span class="hljs-string">'default'</span>);</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The 'startup' value is "</span> + val);</li><li><span class="hljs-keyword">let</span> uInt8Array2 : preferences.<span class="hljs-property">ValueType</span> = dataPreferences.<span class="hljs-title function_">getSync</span>(<span class="hljs-string">'uInt8'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">0</span>));</li><li><span class="hljs-comment">// 将获取到的Uint8Array转换为字符串</span></li><li><span class="hljs-keyword">let</span> textDecoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>);</li><li>val = textDecoder.<span class="hljs-title function_">decodeToString</span>(uInt8Array2 <span class="hljs-keyword">as</span> <span class="hljs-title class_">Uint8Array</span>);</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"The 'uInt8' value is "</span> + val);</li></ol></pre></div></div></li>      <li>       <p>删除数据。</p>       <p>使用deleteSync()方法删除指定键值对，示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>dataPreferences.<span class="hljs-title function_">deleteSync</span>(<span class="hljs-string">'startup'</span>);</li></ol></pre></div></div></li>      <li>       <p>数据持久化。</p>       <p>应用存入数据到Preferences实例后，可以使用flush()方法实现数据持久化。示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>dataPreferences.<span class="hljs-title function_">flush</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to flush. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in flushing.'</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>订阅数据变更。</p>       <p>应用订阅数据变更需要指定observer作为回调方法。</p>       <p>针对首选项的默认存储模式（XML存储模式），订阅的Key值发生变更后，当执行flush()方法时，触发observer回调。</p>       <p>示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">observer</span> = (<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The key'</span> + key + <span class="hljs-string">'changed.'</span>);</li><li>}</li><li>dataPreferences.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, observer);</li><li><span class="hljs-comment">// 数据产生变更，由'auto'变为'manual'</span></li><li>dataPreferences.<span class="hljs-title function_">put</span>(<span class="hljs-string">'startup'</span>, <span class="hljs-string">'manual'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to put the value of 'startup'. Code:<span class="hljs-subst">${err.code}</span>,message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in putting the value of 'startup'."</span>);</li><li>  <span class="hljs-keyword">if</span> (dataPreferences !== <span class="hljs-literal">null</span>) {</li><li>    dataPreferences.<span class="hljs-title function_">flush</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to flush. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in flushing.'</span>);</li><li>    })</li><li>  }</li><li>})</li></ol></pre></div></div>       <p>针对GSKV存储模式，订阅的Key值发生变更后（无需调用flush），observer被触发回调。</p>       <p>示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-title function_">observer</span> = (<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt; {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'The key'</span> + key + <span class="hljs-string">'changed.'</span>);</li><li>}</li><li>dataPreferences.<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, observer);</li><li><span class="hljs-comment">// 数据产生变更，由'auto'变为'manual'</span></li><li>dataPreferences.<span class="hljs-title function_">put</span>(<span class="hljs-string">'startup'</span>, <span class="hljs-string">'manual'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to put the value of 'startup'. Code:<span class="hljs-subst">${err.code}</span>,message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Succeeded in putting the value of 'startup'."</span>);</li><li>})</li></ol></pre></div></div></li>      <li>       <p>删除指定文件。</p>       <p>使用deletePreferences()方法从内存中移除指定文件对应的Preferences实例及其数据。若该Preference存在对应的持久化文件，则一并删除，包括指定文件及其备份文件、损坏文件。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <ul>          <li>           <p>调用该接口后，应用不允许再使用该Preferences实例进行数据操作，否则会出现数据一致性问题。</p></li>          <li>           <p>成功删除后，数据及文件将不可恢复。</p></li>          <li>           <p>在GSKV模式中，该接口不支持与其他接口并发调用（包括多进程），否则会出现不可预期行为。</p></li>         </ul>        </div></div></div>       <p>示例代码如下所示：</p>       <div _ngcontent-tqp-c106="" class="highlight-div"><div _ngcontent-tqp-c106="" class="highlight-div-header"><div _ngcontent-tqp-c106="" class="highlight-div-header-left"><div _ngcontent-tqp-c106="" class="handle-button expand-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tqp-c106="" class="highlight-div-header-right"><div _ngcontent-tqp-c106="" class="handle-button ai-button"></div><div _ngcontent-tqp-c106="" class="handle-button line-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tqp-c106="" class="handle-button theme-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tqp-c106="" class="handle-button copy-button"><div _ngcontent-tqp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tqp-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>preferences.<span class="hljs-title function_">deletePreferences</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, options, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to delete preferences. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in deleting preferences.'</span>);</li><li>})</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="示例代码">示例代码<i class="anchor-icon anchor-icon-link" anchorid="示例代码" tips="复制节点链接"></i></h2>          <ul>      <li><a href="https://gitcode.com/HarmonyOS_Samples/preferences" target="_blank">首选项</a></li>     </ul>    </div>   </div>   <div></div></div>