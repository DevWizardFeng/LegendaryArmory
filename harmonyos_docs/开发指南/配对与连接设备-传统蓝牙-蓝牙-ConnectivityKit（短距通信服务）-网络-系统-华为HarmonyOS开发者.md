<h1 _ngcontent-qve-c119="" class="doc-title ng-star-inserted" title="配对与连接设备"> 配对与连接设备 </h1>

<div _ngcontent-qve-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="简介">简介<i class="anchor-icon anchor-icon-link" anchorid="简介" tips="复制节点链接"></i></h2>          <p>本指南主要提供了主动配对设备和连接设备可用profile能力的开发指导。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="申请蓝牙权限" class="firsth2">申请蓝牙权限<i class="anchor-icon anchor-icon-link" anchorid="申请蓝牙权限" tips="复制节点链接"></i></h3>          <p>需要申请权限ohos.permission.ACCESS_BLUETOOTH。如何配置和申请权限，具体操作请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization">向用户申请授权</a>。</p>    </div>    <div class="tiledSection">     <h3 id="导入所需api模块">导入所需API模块<i class="anchor-icon anchor-icon-link" anchorid="导入所需api模块" tips="复制节点链接"></i></h3>          <p>导入connection、a2dp、 hfp、 hid、baseProfile、constant和错误码模块。</p>     <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { connection, a2dp, hfp, hid, baseProfile, constant, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="订阅配对状态变化事件">订阅配对状态变化事件<i class="anchor-icon anchor-icon-link" anchorid="订阅配对状态变化事件" tips="复制节点链接"></i></h3>          <p>通过订阅配对状态变化事件，可以获取实时的配对状态。在整个配对过程中，涉及多种状态的跃迁，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#bondstate" target="_blank">BOND_STATE_BONDED</a>表示已配对。</p>     <p>应用主动发起配对其他设备，或者其他设备主动配对本机设备，都可以通过此事件获取配对情况。</p>     <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 定义配对状态变化函数回调</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onReceiveEvent</span>(<span class="hljs-params">data: connection.BondStateParam</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pair result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起订阅</span></li><li>  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bondStateChange'</span>, onReceiveEvent);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="发起配对">发起配对<i class="anchor-icon anchor-icon-link" anchorid="发起配对" tips="复制节点链接"></i></h3>          <p>若目标设备的配对状态是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#bondstate" target="_blank">BOND_STATE_INVALID</a>，则可以主动配对目标设备。</p>     <ul>      <li>目标设备可以通过发现设备流程获取，详情请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/br-discovery-development-guide">传统蓝牙查找设备</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ble-development-guide">低功耗蓝牙查找设备</a>。</li>     </ul>     <p>配对过程中，系统会弹出对话框。不同配对类型，对话框样式可能不一样，其中“确认配对密钥（Confirm Passkey）”模式如下图1。若用户同意授权，才能配对成功。</p>     <p><span><img originheight="249" originwidth="392" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211115104.21545782393161050941011775706336:50001231000000:2800:59A6F84736C5B694967791A16FFE1F1DF083C9CF9FA480235F8A27C39358DA4D.png" width="392" height="249"></span></p>     <p><strong>图1</strong> 蓝牙配对请求对话框</p>     <p>蓝牙设备的实际MAC地址属于用户的隐私信息，在发现设备过程中，蓝牙子系统会给每个蓝牙外设分配一个虚拟MAC地址，并保存该虚拟MAC地址与外设实际MAC地址的映射关系。</p>     <p>若开发者不知道目标设备的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-common#bluetoothaddresstype" target="_blank">地址类型</a>，推荐使用API version 20及以前的配对方式发起配对，详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectionpairdevice" target="_blank">connection.pairDevice</a>。</p>     <ul>      <li>此配对方式不需要关注目标设备的MAC地址类型。</li>     </ul>     <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过发现设备流程获取目标设备地址</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'11:22:33:44:55:66'</span>;</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-comment">// 发起配对</span></li><li>  connection.<span class="hljs-title function_">pairDevice</span>(device).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pairDevice'</span>);</li><li>  }, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'pairDevice: errCode:'</span> + error.<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage:'</span> + error.<span class="hljs-property">message</span>);</li><li>  });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startPair: errCode:'</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage:'</span> + err.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>     <p>若开发者已知目标设备的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-common#bluetoothaddresstype" target="_blank">地址类型</a>，推荐使用API version 21开始支持的配对方式发起配对，详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectionpairdevice21" target="_blank">connection.pairDevice</a>。</p>     <ul>      <li>此配对方式需要同时指定目标设备的MAC地址和地址类型。</li>     </ul>     <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="js prettyprint linenums hljs language-javascript" hw-language="js" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">btAddr</span>: common.<span class="hljs-property">BluetoothAddress</span> = {</li><li>    <span class="hljs-string">"address"</span>: <span class="hljs-string">'11:22:33:44:55:66'</span>, <span class="hljs-comment">// 目标设备的实际MAC地址或虚拟MAC地址</span></li><li>    <span class="hljs-string">"addressType"</span>: common.<span class="hljs-property">BluetoothAddressType</span>.<span class="hljs-property">REAL</span>, <span class="hljs-comment">// 相应的地址类型</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 发起配对</span></li><li>    connection.<span class="hljs-title function_">pairDevice</span>(btAddr).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pairDevice'</span>);</li><li>    }, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'pairDevice: errCode:'</span> + error.<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage:'</span> + error.<span class="hljs-property">message</span>);</li><li>    });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startPair: errCode:'</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage:'</span> + err.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="连接已配对设备的profile">连接已配对设备的profile<i class="anchor-icon anchor-icon-link" anchorid="连接已配对设备的profile" tips="复制节点链接"></i></h3>          <p>若应用配对完目标设备后，可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectionconnectallowedprofiles16" target="_blank">connectAllowedProfiles</a>，发起连接该设备支持的profile能力（只包括A2DP、HFP和HID）。若应用需要使用SPP连接，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/spp-development-guide">连接和传输数据</a>。</p>     <ul>      <li>蓝牙子系统会在配对过程中查询和保存目标设备支持的所有profile能力。</li>      <li>配对完成后，应用可以主动查询目标设备的profile能力，需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-connection#connectiongetremoteprofileuuids12" target="_blank">getRemoteProfileUuids</a>。若存在应用需要的能力，则可以在配对完成后30s内，发起连接目标设备的profile。</li>     </ul>     <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设备地址是已配对的设备</span></li><li><span class="hljs-keyword">let</span> device = <span class="hljs-string">'XX:XX:XX:XX:XX:XX'</span>;</li><li>
</li><li><span class="hljs-comment">// 创建A2DP/HFP/HID实例</span></li><li><span class="hljs-keyword">let</span> a2dpSrc = a2dp.<span class="hljs-title function_">createA2dpSrcProfile</span>();</li><li><span class="hljs-keyword">let</span> hfpAg = hfp.<span class="hljs-title function_">createHfpAgProfile</span>();</li><li><span class="hljs-keyword">let</span> hidHost = hid.<span class="hljs-title function_">createHidHostProfile</span>();</li><li>
</li><li><span class="hljs-comment">// 定义A2DP连接状态变化回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onA2dpConnectStateChange</span>(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`A2DP State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义HFP连接状态变化回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onHfpConnectStateChange</span>(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`HFP State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 定义HID连接状态变化回调函数</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onHidConnectStateChange</span>(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`HID State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// 建议判断目标设备的profile能力是否存在A2DP/HFP/HID</span></li><li>    <span class="hljs-comment">// 订阅A2DP/HFP/HID连接状态变化事件</span></li><li>    a2dpSrc.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, onA2dpConnectStateChange);</li><li>    hfpAg.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, onHfpConnectStateChange);</li><li>    hidHost.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, onHidConnectStateChange);</li><li>
</li><li>    <span class="hljs-comment">// 发起连接profile</span></li><li>    connection.<span class="hljs-title function_">connectAllowedProfiles</span>(device).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connectAllowedProfiles'</span>);</li><li>    }, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode:'</span> + error.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + error.<span class="hljs-property">message</span>);</li><li>    });</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode:'</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + err.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-qve-c106="" class="highlight-div"><div _ngcontent-qve-c106="" class="highlight-div-header"><div _ngcontent-qve-c106="" class="highlight-div-header-left"><div _ngcontent-qve-c106="" class="handle-button expand-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qve-c106="" class="highlight-div-header-right"><div _ngcontent-qve-c106="" class="handle-button ai-button"></div><div _ngcontent-qve-c106="" class="handle-button line-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qve-c106="" class="handle-button theme-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qve-c106="" class="handle-button copy-button"><div _ngcontent-qve-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qve-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { connection, a2dp, hfp, hid, baseProfile, constant } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PairDeviceManager</span> {</li><li>  <span class="hljs-attr">device</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">pairState</span>: connection.<span class="hljs-property">BondState</span> = connection.<span class="hljs-property">BondState</span>.<span class="hljs-property">BOND_STATE_INVALID</span>;</li><li>  a2dpSrc = a2dp.<span class="hljs-title function_">createA2dpSrcProfile</span>();</li><li>  hfpAg = hfp.<span class="hljs-title function_">createHfpAgProfile</span>();</li><li>  hidHost = hid.<span class="hljs-title function_">createHidHostProfile</span>();</li><li>
</li><li>  <span class="hljs-comment">// 定义配对状态变化回调函数</span></li><li>  onBondStateEvent = <span class="hljs-function">(<span class="hljs-params">data: connection.BondStateParam</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pair result: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>    <span class="hljs-keyword">if</span> (data &amp;&amp; data.<span class="hljs-property">deviceId</span> == <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pairState</span> = data.<span class="hljs-property">state</span>; <span class="hljs-comment">// 保存目标设备的配对状态</span></li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 发起配对，设备地址可以通过查找设备流程获取</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">startPair</span>(<span class="hljs-params">device: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span> = device;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 发起订阅配对状态变化事件</span></li><li>      connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bondStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onBondStateEvent</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bondStateChange errCode: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">code</span> + <span class="hljs-string">', errMessage: '</span> + (err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 发起配对</span></li><li>      connection.<span class="hljs-title function_">pairDevice</span>(device).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'pairDevice'</span>);</li><li>      }, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'pairDevice: errCode:'</span> + error.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + error.<span class="hljs-property">message</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'startPair: errCode:'</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + err.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 定义A2DP连接状态变化回调函数</span></li><li>  onA2dpConnectStateChange = <span class="hljs-function">(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`A2DP State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 定义HFP连接状态变化回调函数</span></li><li>  onHfpConnectStateChange = <span class="hljs-function">(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`HFP State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 定义HID连接状态变化回调函数</span></li><li>  onHidConnectStateChange = <span class="hljs-function">(<span class="hljs-params">data: baseProfile.StateChangeParam</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`HID State: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// 发起连接</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">device: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> uuids = <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">getRemoteProfileUuids</span>(device);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device: '</span> + device + <span class="hljs-string">' remoteUuids: '</span>+ <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uuids));</li><li>      <span class="hljs-keyword">let</span> allowedProfiles = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-comment">// 若存在应用需要的profile，则监听对应的profile连接状态</span></li><li>      <span class="hljs-keyword">if</span> (uuids.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">uuid</span> =&gt;</span> uuid == constant.<span class="hljs-property">ProfileUuids</span>.<span class="hljs-property">PROFILE_UUID_A2DP_SINK</span>.<span class="hljs-title function_">toLowerCase</span>())) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device supports a2dp'</span>);</li><li>        allowedProfiles++;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">a2dpSrc</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onA2dpConnectStateChange</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (uuids.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">uuid</span> =&gt;</span> uuid == constant.<span class="hljs-property">ProfileUuids</span>.<span class="hljs-property">PROFILE_UUID_HFP_HF</span>.<span class="hljs-title function_">toLowerCase</span>())) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device supports hfp'</span>);</li><li>        allowedProfiles++;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hfpAg</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onHfpConnectStateChange</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (uuids.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">uuid</span> =&gt;</span> uuid == constant.<span class="hljs-property">ProfileUuids</span>.<span class="hljs-property">PROFILE_UUID_HID</span>.<span class="hljs-title function_">toLowerCase</span>()) ||</li><li>        uuids.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">uuid</span> =&gt;</span> uuid == constant.<span class="hljs-property">ProfileUuids</span>.<span class="hljs-property">PROFILE_UUID_HOGP</span>.<span class="hljs-title function_">toLowerCase</span>())) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'device supports hid'</span>);</li><li>        allowedProfiles++;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hidHost</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onHidConnectStateChange</span>);</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (allowedProfiles &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// 若存在可用的profile，则发起连接</span></li><li>        connection.<span class="hljs-title function_">connectAllowedProfiles</span>(device).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'connectAllowedProfiles'</span>);</li><li>        }, <span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode:'</span> + error.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + error.<span class="hljs-property">message</span>);</li><li>        });</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'errCode:'</span> + err.<span class="hljs-property">code</span> + <span class="hljs-string">',errMessage'</span> + err.<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> pairDeviceManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PairDeviceManager</span>();</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> pairDeviceManager <span class="hljs-keyword">as</span> <span class="hljs-title class_">PairDeviceManager</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>