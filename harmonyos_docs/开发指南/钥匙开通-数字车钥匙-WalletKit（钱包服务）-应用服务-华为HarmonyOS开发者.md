<h1 _ngcontent-wlp-c119="" class="doc-title ng-star-inserted" title="钥匙开通"> 钥匙开通 </h1>

<div _ngcontent-wlp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>钥匙开通分为添加钥匙和激活钥匙两步，整体交互流程图如下。相关接口定义请参照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-arkts" target="_blank">钱包服务API</a>。</p>    <p><span><img originheight="787" originwidth="751" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.66368459429197012193400039373314:50001231000000:2800:534B9F80E3347F245FBF54325E1798C1FA739B3FC24ADDDCEBF4FDC78649B604.png" width="751" height="787"></span></p>    <ol>     <li>车主APP调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口检查当前设备车钥匙的开通情况。</li>     <li>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-error-code#section5732174019224" target="_blank">1010220501 查询卡券不存在</a>，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section20458166124611" target="_blank">canAddPass</a>接口检查当前设备是否支持添加车钥匙。</li>     <li>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口或是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section20458166124611" target="_blank">canAddPass</a>接口返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-error-code#section205478194408" target="_blank">1010200003 访问钱包的前置环境没有准备好</a>，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section139341726154718" target="_blank">initWalletEnvironment</a>接口初始化钱包开通车钥匙的同意协议或是登录账号等必要条件，引导用户跳转钱包App完成应用初始化。</li>     <li>车主APP调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section5251175451917" target="_blank">queryPassDeviceInfo</a>接口查询设备类型，指定目标设备标识，提升安全性。</li>     <li>车主服务器预置模板后申请钥匙卡片以及JWE数据，参考<a href="/consumer/cn/doc/harmonyos-guides/wallet-carkey-operation#section5585115171117">车主服务器开发</a>。</li>     <li>用户主动发起开卡时，车主APP跳转钱包应用，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section596313613472" target="_blank">addPass</a>接口携带上述流程中生成的编码后的JWE数据，开通车钥匙到钱包。</li>     <li>卡片激活的过程中钱包服务器需要和DK业务管理服务进行交互的包括：设备的认证（和车钥匙管理台交换证书信息）、获取请求个人化数据时的token（用于向车钥匙管理台请求Applet个人化数据）、以及最后的请求Applet个人化数据，最后写入安全芯片，参考<a href="/consumer/cn/doc/harmonyos-guides/wallet-carkey-operation#section19676155018507">车主服务器激活卡片</a>。</li>     <li>车主APP可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section18261142114710" target="_blank">viewPass</a>接口跳转钱包查看已开通的车钥匙详情页。</li>    </ol>    <div class="tiledSection">     <h2 id="section1730146193613">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1730146193613" tips="复制节点链接"></i></h2>          <ol>      <li><span>车主APP使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations">创建Wallet Kit服务</a>时注册的服务号和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section129511211195" target="_blank">申请钥匙卡片</a>时定义的卡券唯一标识，车主APP调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口检查当前设备车钥匙的开通情况。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations"><span class="hljs-comment">创建Wallet Kit服务</span></a><span class="hljs-comment">时注册的服务号</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">passType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section129511211195" target="_blank"><span class="hljs-comment">申请钥匙卡片</span></a><span class="hljs-comment">时定义的卡券唯一标识</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">serialNumber</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">queryPass</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">passType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">passType</span>,</li><li>      <span class="hljs-attr">serialNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">serialNumber</span></li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">queryPass</span>(passStr).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in querying pass, result: <span class="hljs-subst">${result}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query pass, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-error-code#section5732174019224" target="_blank">1010220501 查询卡券不存在</a>，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section20458166124611" target="_blank">canAddPass</a>接口检查当前设备是否支持添加车钥匙。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations"><span class="hljs-comment">创建Wallet Kit服务</span></a><span class="hljs-comment">时注册的服务号</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">passType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// 目标设备类型 phone: 手机</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">canAddPass</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">passType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">passType</span>,</li><li>      <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetDeviceType</span></li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">canAddPass</span>(passStr).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in checking addPass, result:<span class="hljs-subst">${result}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to check addPass, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>如果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section375194074718" target="_blank">queryPass</a>接口或是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section20458166124611" target="_blank">canAddPass</a>接口返回<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-error-code#section205478194408" target="_blank">1010200003 访问钱包的前置环境没有准备好</a>，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section139341726154718" target="_blank">initWalletEnvironment</a>接口初始化钱包开通车钥匙的同意协议或是登录账号等必要条件，引导用户跳转钱包App完成应用初始化。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// 目标设备类型 phone: 手机</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initWalletEnvironment</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetDeviceType</span></li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">initWalletEnvironment</span>(passStr).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in initiating walletEnvironment`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to initiate walletEnvironment, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>车主APP调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section5251175451917" target="_blank">queryPassDeviceInfo</a>接口查询设备类型，指定目标设备标识。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations"><span class="hljs-comment">创建Wallet Kit服务</span></a><span class="hljs-comment">时注册的服务号</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">passType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// 目标设备类型 phone: 手机</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">queryPassDeviceInfo</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">passType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">passType</span>,</li><li>      <span class="hljs-attr">targetDeviceType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetDeviceType</span></li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">queryPassDeviceInfo</span>(passStr).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in querying passDeviceInfo, result:<span class="hljs-subst">${result}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to query passDeviceInfo, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>车主服务器预置模板后申请钥匙卡片以及JWE数据，参考<a href="/consumer/cn/doc/harmonyos-guides/wallet-carkey-operation#section5585115171117">车主服务器开发</a>。</span></li>      <li><span>用户主动发起开卡时，车主APP跳转钱包应用，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section596313613472" target="_blank">addPass</a>接口携带上述流程中生成的编码后的JWE数据，开通车钥匙到钱包。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// 参考</span><a href="/consumer/cn/doc/harmonyos-guides/wallet-carkey-operation#section5585115171117"><span class="hljs-comment">车主服务器开发</span></a><span class="hljs-comment">生成的JWE数据</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">jweContent</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addPass</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">jweContent</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">jweContent</span></li><li>    });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">addPass</span>(passStr).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in adding pass, result:<span class="hljs-subst">${result}</span>`</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to add pass, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>      <li><span>卡片激活的过程中钱包服务器需要和DK业务管理服务进行交互的包括：设备的认证（和车钥匙管理台交换证书信息）、获取请求个人化数据时的token（用于向车钥匙管理台请求Applet个人化数据）、以及最后的请求Applet个人化数据，最后写入安全芯片，参考<a href="/consumer/cn/doc/harmonyos-guides/wallet-carkey-operation#section19676155018507">车主服务器激活卡片</a>。</span></li>      <li><span>车主APP可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-walletpass#section18261142114710" target="_blank">viewPass</a>接口跳转钱包查看已开通的车钥匙详情页。</span>       <p></p>       <div _ngcontent-wlp-c106="" class="highlight-div"><div _ngcontent-wlp-c106="" class="highlight-div-header"><div _ngcontent-wlp-c106="" class="highlight-div-header-left"><div _ngcontent-wlp-c106="" class="handle-button expand-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wlp-c106="" class="highlight-div-header-right"><div _ngcontent-wlp-c106="" class="handle-button ai-button"></div><div _ngcontent-wlp-c106="" class="handle-button line-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wlp-c106="" class="handle-button theme-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wlp-c106="" class="handle-button copy-button"><div _ngcontent-wlp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wlp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { walletPass } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.WalletKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">walletPassClient</span>: walletPass.<span class="hljs-property">WalletPassClient</span> = <span class="hljs-keyword">new</span> walletPass.<span class="hljs-title class_">WalletPassClient</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations"><span class="hljs-comment">创建Wallet Kit服务</span></a><span class="hljs-comment">时注册的服务号</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">passType</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// </span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section129511211195" target="_blank"><span class="hljs-comment">申请钥匙卡片</span></a><span class="hljs-comment">时定义的卡券唯一标识</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">serialNumber</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">viewPass</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> passStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({</li><li>      <span class="hljs-attr">passType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">passType</span>,</li><li>      <span class="hljs-attr">serialNumber</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">serialNumber</span></li><li>    });</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletPassClient</span>.<span class="hljs-title function_">viewPass</span>(passStr);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in viewing pass`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to view pass, code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// your application UI</span></li><li>  }</li><li>}</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section5585115171117">车主服务器开发<i class="anchor-icon anchor-icon-link" anchorid="section5585115171117" tips="复制节点链接"></i></h2>          <ol>      <li><span>使用Intellij IDEA打开<a href="https://gitcode.com/harmonyos_samples/wallet-kit-sample-code-severdemo-java" target="_blank">钱包服务-服务端卡片开通</a>的示例代码，没有请先下载Intellij IDEA的当前最新版本。示例代码和工具下载完成后，目录结构如下，我们需要关注下图框出来几个文件：</span>       <p></p>       <p><span><img originheight="565" originwidth="423" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.06631689958658498312737015870990:50001231000000:2800:B7D24F385228DA49D10CB3AD8F155830612F422EBA646CCEE279AEB8CCF44614.png" width="423" height="565"></span></p>       <p></p></li>      <li><span>打开resources/release.config.properties文件，替换真实的应用数据。</span>       <p></p>       <p><span><img originheight="308" originwidth="907" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.40000916185274192791198122554152:50001231000000:2800:DDC1FAF678F0D3DD425CD9EC1905CA42C2F731496CC7B5B62DE9B741A92D8B92.png" width="907" height="308"></span></p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.5.2.2.2.2.1.3.1.1" valign="top" width="24.63%">            <p>需替换的参数</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.5.2.2.2.2.1.3.1.2" valign="top" width="75.37%">            <p>参数说明</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="24.63%">            <p>gw.appid</p></td>           <td class="cellrowborder" rowspan="2" valign="top" width="75.37%">            <p><span><img height="332.1675" originheight="893" originwidth="1404" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.54087876099951513566181186655990:50001231000000:2800:1677321B25989762B1164D69F92373F4F4B3FA85EF47B13D97B66DD4A58566D8.png" title="点击放大" width="523.6875"></span></p>            <p></p>            <p><a href="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html" target="_blank">AppGallery Connect</a>平台申请的Client ID和Client Secret分别填入gw.appid和gw.appid.secret</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top">            <p>gw.appid.secret</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.63%">            <p>walletServerBaseUrl</p></td>           <td class="cellrowborder" valign="top" width="75.37%">            <p>固定填入服务器基地址：https://wallet-passentrust-drcn.cloud.huawei.com.cn/hmspass</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="24.63%">            <p>servicePrivateKey</p></td>           <td class="cellrowborder" valign="top" width="75.37%">            <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations#li69221528123212">创建Wallet Kit服务</a>步骤5生成的私钥</p></td>          </tr>                 </tbody></table></div>       </div>       <p></p></li>      <li><span>打开resources/data/StdCarKeyModel.json文件，替换真实的应用数据，详细见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section37263211548" target="_blank">预置模板</a>的请求参数。</span>       <p></p>       <p><span><img originheight="861" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.35520341852606283346921458523477:50001231000000:2800:C68A4FFA8BF5DD3CE13DE692F233ED5210A37E4E498FCB340952BD81D7F43700.png" width="506" height="861"></span></p>       <p></p>       <p></p></li>      <li><span>打开stdcarkey/StdCarKeyModelTest.java文件，运行createStdCarKeyModel方法，可看到控制台如下输出，详细见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section37263211548" target="_blank">预置模板</a>的响应参数。</span>       <p></p>       <p><span><img height="114.7125" originheight="405" originwidth="1842" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.70770877248170626008480476014672:50001231000000:2800:13E50224A8816EB0860D1F06C9A17EF50925BB5E77C5A4BA4314930ED4A43820.png" title="点击放大" width="523.6875"></span></p>       <p></p>       <p></p></li>      <li><span>打开resources/data/StdCarKeyInstance.json文件，替换真实的应用数据，详细见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section129511211195" target="_blank">申请钥匙卡片</a>的请求参数。</span></li>      <li><span>打开stdcarkey/StdCarKeyInstanceTest.java文件，运行addStdCarKeyInstance方法，可看到控制台如下输出，详细见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-carkey#section129511211195" target="_blank">申请钥匙卡片</a>的响应参数。</span>       <p></p>       <p><span><img height="153.615" originheight="540" originwidth="1836" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.34581289109966743063677532559352:50001231000000:2800:29E7A32B66D721CC536EB595B095749A0F61662944C8E539B6AE85E6754D5CDF.png" title="点击放大" width="523.6875"></span></p>       <p></p>       <p></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section19676155018507">车主服务器激活卡片<i class="anchor-icon anchor-icon-link" anchorid="section19676155018507" tips="复制节点链接"></i></h2>          <ol>      <li><span>使用 Intellij IDEA打开<a href="https://gitcode.com/harmonyos_samples/wallet-kit-sample-code-severdemo-nfc-java" target="_blank">钱包服务-服务端卡片激活</a>的示例代码。示例代码和工具下载完成后，解决工程配置等问题后，Constants类中替换SERVER_PUBLIC_KEY和SERVER_SECRET_KEY为您在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/wallet-preparations#li69221528123212">创建Wallet Kit服务</a>步骤5生成的公钥和私钥，直接打开PassesController这个类。</span></li>      <li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-public#section113578586311" target="_blank">设备认证</a>对应类中的register方法，通过此方法进行设备认证。</span>       <p></p>       <p><span><img height="55.86" originheight="117" originwidth="1081" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.58184165068273473084270644896421:50001231000000:2800:E1DBD81F95CA14DEBE8EB07512F3888CCFD2A61341B03DA5753486FFCC84A11A.png" title="点击放大" width="523.6875"></span></p>       <p></p></li>      <li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-public#section257714144308" target="_blank">获取个人化数据Token</a>对应类中的requestToken方法，通过此方法获取个人化数据Token。</span>       <p></p>       <p><span><img height="47.88" originheight="99" originwidth="1079" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.97975705457448695021370034110789:50001231000000:2800:4C69E6B80DDC5937BE08495A633DB17B6B7D4566DFF8D59EEA014F341722C9E1.png" title="点击放大" width="523.6875"></span></p>       <p></p></li>      <li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/wallet-rest-api-public#section178319716389" target="_blank">获取个人化数据</a>对应类中的getPersonalInfo方法，重点看dealWithPersonalizeDataRequest中的getDevicePassData这个方法，查看ICCECarKeyDevicePassUnit的generatePassData方法，通过这些方法获取个人化数据。再深入打开里面的getPersonalizeData方法，根据此接口的说明进行生成。</span>       <p></p>       <p><span><img height="277.305" originheight="561" originwidth="1059" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114604.77761694015210553611731988634005:50001231000000:2800:81E2BA666C6370B0554EFA7CFE26AB13B8DEA26E2AE553279E610FCE96258BA5.png" title="点击放大" width="523.6875"></span></p>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>