<h1 _ngcontent-nfd-c119="" class="doc-title ng-star-inserted" title="长时任务开发指导（TaskPool）"> 长时任务开发指导（TaskPool） </h1>

<div _ngcontent-nfd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>此处提供使用TaskPool进行长时任务的开发指导，以定期采集传感器数据为例。</p>  <div class="tiledSection"><h2 id="使用taskpool进行传感器数据监听">使用TaskPool进行传感器数据监听<i class="anchor-icon anchor-icon-link" anchorid="使用taskpool进行传感器数据监听" tips="复制节点链接"></i></h2><ol><li><p>导入所需的模块。</p>  <div _ngcontent-nfd-c106="" class="highlight-div"><div _ngcontent-nfd-c106="" class="highlight-div-header"><div _ngcontent-nfd-c106="" class="highlight-div-header-left"><div _ngcontent-nfd-c106="" class="handle-button expand-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nfd-c106="" class="highlight-div-header-right"><div _ngcontent-nfd-c106="" class="handle-button ai-button"></div><div _ngcontent-nfd-c106="" class="handle-button line-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nfd-c106="" class="handle-button theme-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nfd-c106="" class="handle-button copy-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nfd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-keyword">import</span> { sensor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.SensorServiceKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, emitter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div>  </li><li><p>定义长时任务，内部监听sensor数据，并通过emitter注册销毁通知。</p>  <div _ngcontent-nfd-c106="" class="highlight-div"><div _ngcontent-nfd-c106="" class="highlight-div-header"><div _ngcontent-nfd-c106="" class="highlight-div-header-left"><div _ngcontent-nfd-c106="" class="handle-button expand-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nfd-c106="" class="highlight-div-header-right"><div _ngcontent-nfd-c106="" class="handle-button ai-button"></div><div _ngcontent-nfd-c106="" class="handle-button line-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nfd-c106="" class="handle-button theme-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nfd-c106="" class="handle-button copy-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nfd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SensorListener</span>(<span class="hljs-params"></span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  sensor.<span class="hljs-title function_">on</span>(sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">ACCELEROMETER</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>    emitter.<span class="hljs-title function_">emit</span>({ <span class="hljs-attr">eventId</span>: <span class="hljs-number">0</span> }, { <span class="hljs-attr">data</span>: data });</li><li>  }, { <span class="hljs-attr">interval</span>: <span class="hljs-number">1000000000</span> });</li><li>
</li><li>  emitter.<span class="hljs-title function_">on</span>({ <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span> }, <span class="hljs-function">() =&gt;</span> {</li><li>    sensor.<span class="hljs-title function_">off</span>(sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">ACCELEROMETER</span>)</li><li>    emitter.<span class="hljs-title function_">off</span>(<span class="hljs-number">1</span>)</li><li>  })</li><li>}</li></ol></pre></div></div>  </li><li><p>给sensor添加ohos.permission.ACCELEROMETER权限。</p>  <div _ngcontent-nfd-c106="" class="highlight-div"><div _ngcontent-nfd-c106="" class="highlight-div-header"><div _ngcontent-nfd-c106="" class="highlight-div-header-left"><div _ngcontent-nfd-c106="" class="handle-button expand-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nfd-c106="" class="highlight-div-header-right"><div _ngcontent-nfd-c106="" class="handle-button ai-button"></div><div _ngcontent-nfd-c106="" class="handle-button line-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nfd-c106="" class="handle-button theme-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nfd-c106="" class="handle-button copy-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nfd-c106="" class="highlight-scroll-div"><pre class="json prettyprint linenums hljs language-json" hw-language="json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module.json5</span></li><li><span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.ACCELEROMETER"</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span></li></ol></pre></div></div>  </li><li><p>宿主线程定义注册及销毁的行为。</p>  <ul><li>注册：发起长时任务，并通过emitter接收监听数据。</li><li>销毁：发送取消传感器监听的事件，并结束长时任务。</li></ul>  <div _ngcontent-nfd-c106="" class="highlight-div"><div _ngcontent-nfd-c106="" class="highlight-div-header"><div _ngcontent-nfd-c106="" class="highlight-div-header-left"><div _ngcontent-nfd-c106="" class="handle-button expand-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nfd-c106="" class="highlight-div-header-right"><div _ngcontent-nfd-c106="" class="handle-button ai-button"></div><div _ngcontent-nfd-c106="" class="handle-button line-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nfd-c106="" class="handle-button theme-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nfd-c106="" class="handle-button copy-button"><div _ngcontent-nfd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nfd-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  sensorTask?: taskpool.<span class="hljs-property">LongTask</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Add listener"</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">sensorTask</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">LongTask</span>(<span class="hljs-title class_">SensorListener</span>);</li><li>          emitter.<span class="hljs-title function_">on</span>({ <span class="hljs-attr">eventId</span>: <span class="hljs-number">0</span> }, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// Do something here</span></li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Receive ACCELEROMETER data: {<span class="hljs-subst">${data.data?.x}</span>, <span class="hljs-subst">${data.data?.y}</span>, <span class="hljs-subst">${data.data?.z}</span>}`</span>);</li><li>          });</li><li>          taskpool.<span class="hljs-title function_">execute</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sensorTask</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Add listener of ACCELEROMETER success"</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>            <span class="hljs-comment">// Process error</span></li><li>          })</li><li>        })</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Delete listener"</span>)</li><li>        .<span class="hljs-title function_">id</span>(<span class="hljs-string">'HelloWorld'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          emitter.<span class="hljs-title function_">emit</span>({ <span class="hljs-attr">eventId</span>: <span class="hljs-number">1</span> });</li><li>          emitter.<span class="hljs-title function_">off</span>(<span class="hljs-number">0</span>);</li><li>          <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sensorTask</span> != <span class="hljs-literal">undefined</span>) {</li><li>            taskpool.<span class="hljs-title function_">terminateTask</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sensorTask</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"sensorTask is undefined."</span>);</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre></div></div>  </li></ol> </div> </div> <div></div></div>