<h1 _ngcontent-kxn-c119="" class="doc-title ng-star-inserted" title="随路格式转换"> 随路格式转换 </h1>

<div _ngcontent-kxn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section25394mcpsimp">功能说明<i class="anchor-icon anchor-icon-link" anchorid="section25394mcpsimp" tips="复制节点链接"></i></h2><p>随路格式转换数据搬运，适用于在搬运时进行格式转换。</p> </div> <div class="tiledSection"><h2 id="section25397mcpsimp">函数原型<i class="anchor-icon anchor-icon-link" anchorid="section25397mcpsimp" tips="复制节点链接"></i></h2><ul><li>源操作数为GlobalTensor，目的操作数为LocalTensor（只支持ND2NZ格式转换）<div _ngcontent-kxn-c106="" class="highlight-div"><div _ngcontent-kxn-c106="" class="highlight-div-header"><div _ngcontent-kxn-c106="" class="highlight-div-header-left"><div _ngcontent-kxn-c106="" class="handle-button expand-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kxn-c106="" class="highlight-div-header-right"><div _ngcontent-kxn-c106="" class="handle-button ai-button"></div><div _ngcontent-kxn-c106="" class="handle-button line-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kxn-c106="" class="handle-button theme-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kxn-c106="" class="handle-button copy-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kxn-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt; </li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">DataCopy</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; dstLocal, <span class="hljs-type">const</span> GlobalTensor&lt;T&gt;&amp; srcGlobal, <span class="hljs-type">const</span> Nd2NzParams&amp; intriParams)</span></span>;</li></ol></pre></div></div> <p>该原型接口支持的数据通路和数据类型如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>数据通路和数据类型（源操作数为GlobalTensor，目的操作数为LocalTensor）</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.2.4.1.1" valign="top" width="18.15%"><p>支持型号</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.2.4.1.2" valign="top" width="23.799999999999997%"><p>数据通路</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.2.1.3.2.4.1.3" valign="top" width="58.050000000000004%"><p>源操作数和目的操作数的数据类型 (两者保持一致)</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18.15%"><p>Kirin9020系列处理器</p> </td> <td class="cellrowborder" valign="top" width="23.799999999999997%"><p>GM-&gt;A1/B1</p> </td> <td class="cellrowborder" valign="top" width="58.050000000000004%"><p>int8_t/uint8_t/int16_t/uint16_t/int32_t/uint32_t/half/float</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18.15%"><p>KirinX90系列处理器</p> </td> <td class="cellrowborder" valign="top" width="23.799999999999997%"><p>GM-&gt;A1/B1</p> </td> <td class="cellrowborder" valign="top" width="58.050000000000004%"><p>int8_t/uint8_t/int16_t/uint16_t/int32_t/uint32_t/half/float</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用该接口时需要预留8K的Unified Buffer空间，作为接口的临时数据存放区。</p> </div></div></div> </li></ul> <ul><li>源操作数为LocalTensor，目的操作数为LocalTensor<div class="p">支持ND2NZ格式转换：<div _ngcontent-kxn-c106="" class="highlight-div"><div _ngcontent-kxn-c106="" class="highlight-div-header"><div _ngcontent-kxn-c106="" class="highlight-div-header-left"><div _ngcontent-kxn-c106="" class="handle-button expand-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kxn-c106="" class="highlight-div-header-right"><div _ngcontent-kxn-c106="" class="handle-button ai-button"></div><div _ngcontent-kxn-c106="" class="handle-button line-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kxn-c106="" class="handle-button theme-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kxn-c106="" class="handle-button copy-button"><div _ngcontent-kxn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kxn-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 支持ND2NZ格式转换</span></li><li><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;    </li><li><span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">DataCopy</span><span class="hljs-params">(<span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; dstLocal, <span class="hljs-type">const</span> LocalTensor&lt;T&gt;&amp; srcGlobal, <span class="hljs-type">const</span> Nd2NzParams&amp; intriParams)</span></span>;</li></ol></pre></div></div> </div> <p>该原型接口支持的数据通路和数据类型如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>数据通路和数据类型（源操作数为LocalTensor，目的操作数为LocalTensor）</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.2.4.1.1" valign="top" width="16.64%"><p>支持型号</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.2.4.1.2" valign="top" width="28.199999999999996%"><p>数据通路</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.3.2.4.1.3" valign="top" width="55.16%"><p>源操作数和目的操作数的数据类型 (两者保持一致)</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="16.64%"><p>Kirin9020系列处理器</p> </td> <td class="cellrowborder" valign="top" width="28.199999999999996%"><p>VECIN / VECCALC / VECOUT -&gt; TSCM</p> </td> <td class="cellrowborder" valign="top" width="55.16%"><p>int8_t/uint8_t/int16_t/uint16_t/int32_t/uint32_t/half/float</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="16.64%"><p>KirinX90系列处理器</p> </td> <td class="cellrowborder" valign="top" width="28.199999999999996%"><p>VECIN / VECCALC / VECOUT -&gt; TSCM</p> </td> <td class="cellrowborder" valign="top" width="55.16%"><p>int8_t/uint8_t/int16_t/uint16_t/int32_t/uint32_t/half/float</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>当前Kirin9020通用核只考虑32Byte对齐的情形，后续根据需要增强接口。</p> </div></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section25670mcpsimp">参数说明<i class="anchor-icon anchor-icon-link" anchorid="section25670mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>接口参数说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.1" valign="top" width="15%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.2" valign="top" width="10%"><p>输入/输出</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.2.2.4.1.3" valign="top" width="75%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="15%"><p>dstLocal, dstGlobal</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输出</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>目的操作数，类型为LocalTensor或GlobalTensor。支持的数据类型为：half/int16_t/uint16_t/float/int32_t/uint32_t/int8_t/uint8_t。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>srcLocal, srcGlobal</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>源操作数，类型为LocalTensor或GlobalTensor。支持的数据类型为：half/int16_t/uint16_t/float/int32_t/uint32_t/int8_t/uint8_t。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15%"><p>intriParams</p> </td> <td class="cellrowborder" valign="top" width="10%"><p>输入</p> </td> <td class="cellrowborder" valign="top" width="75%"><p>搬运参数，类型为Nd2NzParams/Nz2NdParamsFull/DataCopyCO12DstParams。</p> </td> </tr>  </tbody></table></div> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表4 </b>Nd2NzParams结构体参数定义</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.2.3.1.1" valign="top" width="18%"><p>参数名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.2.3.1.2" valign="top" width="82%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="18%"><p>ndNum</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>传输nd矩阵的数目，取值范围：ndNum∈[0, 4095]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>nValue</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>nd矩阵的行数，取值范围：nValue∈[0, 16384]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>dValue</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>nd矩阵的列数，取值范围：dValue∈[0, 65535]。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>srcNdMatrixStride</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>源操作数相邻nd矩阵起始地址间的偏移，取值范围：srcNdMatrixStride∈[0, 65535]，单位：element。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>srcDValue</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>源操作数同一nd矩阵的相邻行起始地址间的偏移，取值范围：srcDValue∈[1, 65535]，单位：element。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>dstNzC0Stride</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>ND转换到NZ格式后，源操作数中的一行会转换为目的操作数的多行。dstNzC0Stride表示，目的nz矩阵中，来自源操作数同一行的多行数据相邻行起始地址间的偏移，取值范围：dstNzC0Stride∈[1, 16384]，单位：C0_SIZE（32B）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>dstNzNStride</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>目的nz矩阵中，Z型矩阵相邻行起始地址之间的偏移。取值范围：dstNzNStride∈[1, 16384]，单位：C0_SIZE（32B）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="18%"><p>dstNzMatrixStride</p> </td> <td class="cellrowborder" valign="top" width="82%"><p>目的nz矩阵中，相邻nz矩阵起始地址间的偏移，取值范围：dstNzMatrixStride∈[1, 65535]，单位：element。</p> </td> </tr>  </tbody></table></div> </div> <p>ND2NZ转换示意图如下，样例中参数设置值和解释说明如下。</p> <ul><li>ndNum = 2，表示传输nd矩阵的数目为2 (nd矩阵1为A1~A2 + B1~B2, nd矩阵2为C1~C2 + D1~D2)。</li><li>nValue = 2，nd矩阵的行数，也就是矩阵的高度为2。</li><li>dValue = 24，nd矩阵的列数，也就是矩阵的宽度为24个元素。</li><li>srcNdMatrixStride = 144，表达相邻nd矩阵起始地址间的偏移，即为A1~C1的距离，即为9个datablock，9 * 16 = 144个元素。</li><li>srcDValue = 48，表示一行的所含元素个数，即为A1到B1的距离，即为3个datablock，3 * 16 = 48个元素</li><li>dstNzC0Stride = 11。ND转换到NZ格式后，源操作数中的一行会转换为目的操作数的多行，例如src中A1和A2为1行，dst中A1和A2被分为2行。多行数据起始地址之间的偏移就是A1和A2在dst中的偏移，偏移为11个datablock。</li><li>dstNzNStride = 2，表达dst中一个ndMatrix, src的第x行和第x+1行之间的偏移，即A1和B1之间的距离，即为2个datablock。</li><li>dstNzMatrixStride = 96，表达dst中第x个ndMatrix的起点和第x+1个ndMatrix的起点的偏移，即A1和C1之间的距离，即为6个datablock，6 * 16 = 96个元素。</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>Nd2Nz转换示意图</span><br><span><img height="323.19" originheight="1158" originwidth="1900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114328.24673754110496265780750907609421:50001231000000:2800:CFE0208FF23A5C77094CC615D3E8D93D4FC5B3895AA872E5E6DA0E3A52B89DEE.png" title="点击放大" width="530.6700000000001"></span></div> </div> <div class="tiledSection"><h2 id="section25939mcpsimp">支持的型号<i class="anchor-icon anchor-icon-link" anchorid="section25939mcpsimp" tips="复制节点链接"></i></h2><p>Kirin9020系列处理器</p> <p>KirinX90系列处理器</p> </div> </div> <div></div></div>