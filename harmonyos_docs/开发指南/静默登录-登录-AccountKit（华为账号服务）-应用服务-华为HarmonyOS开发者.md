<h1 _ngcontent-agp-c119="" class="doc-title ng-star-inserted" title="静默登录"> 静默登录 </h1>

<div _ngcontent-agp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1891072032716">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section1891072032716" tips="复制节点链接"></i></h2>          <p>在应用卸载重装、用户换机等场景，如登录的华为账号与应用重装、换机前一致，应用可通过Account Kit提供的静默登录方式即不需要用户点击登录/注册按钮，即可获取用户的身份标识UnionID/OpenID，完成用户的静默登录。</p>    </div>    <div class="tiledSection">     <h2 id="section196763415210">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section196763415210" tips="复制节点链接"></i></h2>          <p>静默登录能力支持Phone、Tablet、PC/2in1设备。并且从5.1.0(18)版本开始，新增支持Wearable设备；从5.1.1(19)版本开始，新增支持TV设备。</p>    </div>    <div class="tiledSection">     <h2 id="section646711158318">业务流程<i class="anchor-icon anchor-icon-link" anchorid="section646711158318" tips="复制节点链接"></i></h2>          <p><span><img height="296.2575" originheight="653" originwidth="1151" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114605.95695934699656001298237709784302:50001231000000:2800:DA91F93FC5B00F20D556B7626FC74EF91173E598EAB184D0C0E76D4B4A675B83.png" title="点击放大" width="523.6875"></span></p>     <p>流程说明：</p>     <ol>      <li>调用登录API阶段（序号1-3）：       <ol>        <li>用户使用华为账号登录过应用，应用卸载重装、用户换机后再进入应用时，应用传<span style="color: rgb(63,63,63);">forceLogin = false</span>等参数调用登录API。</li>        <li>如华为账号已登录，且API调用成功，应用能获取到Authorization Code等登录结果。注意：如华为账号未登录，应用会获取到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-error-code#section539558125020" target="_blank">1001502001 用户未登录华为账号</a>错误码，再根据需要自行处理。</li>       </ol></li>      <li>用户关联应用账号阶段（序号4-13）：       <ol>        <li>应用服务端通过Authorization Code获取到Access Token，再使用Access Token调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-token-info#section2520125725115" target="_blank">解析凭证接口</a>获取用户相关信息。通过Authorization Code凭证获取用户信息可以有效避免黑客通过数据遍历、身份伪造、重放攻击等手段导致的安全风险。</li>        <li>应用服务端将业务登录凭证SessionId、UnionID/OpenID传给应用，应用获取到UnionID/OpenID可用于判断华为账号是否登录等功能。</li>        <li>应用对用户身份标识UnionID/OpenID、业务登录凭证SessionId信息进行安全认证后完成静默登录。</li>       </ol></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section1960510134011">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section1960510134011" tips="复制节点链接"></i></h2>          <p>静默登录关键接口如下表所示，具体API说明详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication" target="_blank">API参考</a>。</p>     <div class="tablenoborder">      <div class="tbBox"><table class="layoutFixed idpTab">       <thead>        <tr>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.1" valign="top" width="58.35%">          <p>接口名</p></th>         <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.3.1.2" valign="top" width="41.65%">          <p>描述</p></th>        </tr>       </thead>               <tbody><tr>         <td class="cellrowborder" valign="top" width="58.35%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section7843123616411" target="_blank">createLoginWithHuaweiIDRequest</a>(): <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section42261825935" target="_blank">LoginWithHuaweiIDRequest</a></p></td>         <td class="cellrowborder" valign="top" width="41.65%">          <p>创建账号登录请求。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section42261825935" target="_blank">LoginWithHuaweiIDRequest</a>中的forceLogin参数用来控制当用户未登录华为账号时，是否强制拉起华为账号登录界面，静默登录场景设置为false。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="58.35%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section9716526428" target="_blank">constructor</a>(context?: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-common#context" target="_blank">common.Context</a>)</p></td>         <td class="cellrowborder" valign="top" width="41.65%">          <p>创建登录请求Controller。</p></td>        </tr>        <tr>         <td class="cellrowborder" valign="top" width="58.35%">          <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section3975181884311" target="_blank">executeRequest</a>(request: <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section3118182610348" target="_blank">AuthenticationRequest</a>): Promise&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section2697164193515" target="_blank">AuthenticationResponse</a>&gt;</p></td>         <td class="cellrowborder" valign="top" width="41.65%">          <p>通过Promise方式执行登录操作。</p></td>        </tr>             </tbody></table></div>     </div>    </div>    <div class="tiledSection">     <h2 id="section10603152501119">开发前提<i class="anchor-icon anchor-icon-link" anchorid="section10603152501119" tips="复制节点链接"></i></h2>          <p>在进行代码开发前，请确保已按照“开发准备”章节中的指导完成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-sign-fingerprints">配置签名和指纹</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-client-id">配置Client ID</a>。此场景无需申请账号权限。</p>    </div>    <div class="tiledSection">     <h2 id="section96832214375">客户端开发<i class="anchor-icon anchor-icon-link" anchorid="section96832214375" tips="复制节点链接"></i></h2>         </div>    <ol>     <li>导入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication" target="_blank">authentication</a>模块及相关公共模块。      <div _ngcontent-agp-c106="" class="highlight-div"><div _ngcontent-agp-c106="" class="highlight-div-header"><div _ngcontent-agp-c106="" class="highlight-div-header-left"><div _ngcontent-agp-c106="" class="handle-button expand-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-agp-c106="" class="highlight-div-header-right"><div _ngcontent-agp-c106="" class="handle-button ai-button"></div><div _ngcontent-agp-c106="" class="handle-button line-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-agp-c106="" class="handle-button theme-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-agp-c106="" class="handle-button copy-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-agp-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { authentication } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AccountKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>     <li>创建登录请求并设置参数。      <div _ngcontent-agp-c106="" class="highlight-div"><div _ngcontent-agp-c106="" class="highlight-div-header"><div _ngcontent-agp-c106="" class="highlight-div-header-left"><div _ngcontent-agp-c106="" class="handle-button expand-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-agp-c106="" class="highlight-div-header-right"><div _ngcontent-agp-c106="" class="handle-button ai-button"></div><div _ngcontent-agp-c106="" class="handle-button line-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-agp-c106="" class="handle-button theme-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-agp-c106="" class="handle-button copy-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-agp-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-comment">// </span></span><span class=""><span class="hljs-comment">创建登录请求，并设置参数</span></span></li><li><span class=""><span class="hljs-keyword">const</span> loginRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createLoginWithHuaweiIDRequest</span>();</span></li><li><span class=""><span class="hljs-comment">// false表示静默登录</span></span></li><li><span class="">loginRequest</span><span class="">.<span class="hljs-property">forceLogin</span> = <span class="hljs-literal">false</span>;</span></li><li><span class="hljs-comment">// 用于防跨站点请求伪造</span></li><li><span class="">loginRequest</span><span class="">.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();</span></li></ol></pre></div></div></li>     <li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section620452019185" target="_blank">AuthenticationController</a>对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-authentication#section3975181884311" target="_blank">executeRequest</a>方法执行登录请求，并处理登录结果，获取到Authorization Code及ID Token。之后将Authorization Code传给应用服务端处理，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-phone-unionid-login#section4355919132013">客户端与服务端交互开发</a>的开发步骤a和b。应用可以通过公开的网址获取到华为账号服务器发布的公钥，对签名和ID Token中的必要信息进行验证，以证明其没有被篡改过。解析ID Token可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/account-faq-12#section6924154019588">ID Token解析与验证</a>。      <div _ngcontent-agp-c106="" class="highlight-div"><div _ngcontent-agp-c106="" class="highlight-div-header"><div _ngcontent-agp-c106="" class="highlight-div-header-left"><div _ngcontent-agp-c106="" class="handle-button expand-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-agp-c106="" class="highlight-div-header-right"><div _ngcontent-agp-c106="" class="handle-button ai-button"></div><div _ngcontent-agp-c106="" class="handle-button line-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-agp-c106="" class="handle-button theme-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-agp-c106="" class="handle-button copy-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-agp-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 执行登录请求</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>();</li><li>  controller.<span class="hljs-title function_">executeRequest</span>(loginRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response: authentication.LoginWithHuaweiIDResponse</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> loginWithHuaweiIDResponse = response <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">LoginWithHuaweiIDResponse</span>;</li><li>    <span class="hljs-keyword">const</span> state = loginWithHuaweiIDResponse.<span class="hljs-property">state</span>;</li><li>    <span class="hljs-keyword">if</span> (state &amp;&amp; loginRequest.<span class="hljs-property">state</span> !== state) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to login. The state is different, response state: <span class="hljs-subst">${state}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in logging in.'</span>);</li><li>    <span class="hljs-keyword">const</span> loginWithHuaweiIDCredential = loginWithHuaweiIDResponse?.<span class="hljs-property">data</span>;</li><li>    <span class="hljs-keyword">const</span> code = loginWithHuaweiIDCredential?.<span class="hljs-property">authorizationCode</span>;</li><li>    <span class="hljs-comment">// 开发者处理code</span></li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title function_">dealAllError</span>(error);</li><li>  })</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-title function_">dealAllError</span>(error);</li><li>}</li></ol></pre></div></div>      <p></p>      <div _ngcontent-agp-c106="" class="highlight-div"><div _ngcontent-agp-c106="" class="highlight-div-header"><div _ngcontent-agp-c106="" class="highlight-div-header-left"><div _ngcontent-agp-c106="" class="handle-button expand-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-agp-c106="" class="highlight-div-header-right"><div _ngcontent-agp-c106="" class="handle-button ai-button"></div><div _ngcontent-agp-c106="" class="handle-button line-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-agp-c106="" class="handle-button theme-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-agp-c106="" class="handle-button copy-button"><div _ngcontent-agp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-agp-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 错误处理</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">dealAllError</span>(<span class="hljs-params">error: BusinessError</span>): <span class="hljs-built_in">void</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`Failed to login. Code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  <span class="hljs-comment">// 在应用登录涉及UI交互场景下，建议按照如下错误码指导提示用户</span></li><li>  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_LOGIN_OUT</span>) {</li><li>    <span class="hljs-comment">// 用户未登录华为账号，请登录华为账号并重试或者尝试使用其他方式登录</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_NETWORK_ERROR</span>) {</li><li>    <span class="hljs-comment">// 网络异常，请检查当前网络状态并重试或者尝试使用其他方式登录</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_INTERNAL_ERROR</span>) {</li><li>    <span class="hljs-comment">// 登录失败，请尝试使用其他方式登录</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_USER_CANCEL</span>) {</li><li>    <span class="hljs-comment">// 用户取消授权</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_SYSTEM_SERVICE</span>) {</li><li>    <span class="hljs-comment">// 系统服务异常，请稍后重试或者尝试使用其他方式登录</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">ERROR_CODE_REQUEST_REFUSE</span>) {</li><li>    <span class="hljs-comment">// 重复请求，应用无需处理</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// 应用登录失败，请尝试使用其他方式登录</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {</li><li>  <span class="hljs-comment">// 账号未登录</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_LOGIN_OUT</span> = <span class="hljs-number">1001502001</span>,</li><li>  <span class="hljs-comment">// 网络错误</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_NETWORK_ERROR</span> = <span class="hljs-number">1001502005</span>,</li><li>  <span class="hljs-comment">// 内部错误</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_INTERNAL_ERROR</span> = <span class="hljs-number">1001502009</span>,</li><li>  <span class="hljs-comment">// 用户取消授权</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_USER_CANCEL</span> = <span class="hljs-number">1001502012</span>,</li><li>  <span class="hljs-comment">// 系统服务异常</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_SYSTEM_SERVICE</span> = <span class="hljs-number">12300001</span>,</li><li>  <span class="hljs-comment">// 重复请求</span></li><li>  <span class="hljs-variable constant_">ERROR_CODE_REQUEST_REFUSE</span> = <span class="hljs-number">1001500002</span></li><li>}</li></ol></pre></div></div></li>    </ol>    <div class="tiledSection">     <h2 id="section58561134191217">服务端开发<i class="anchor-icon anchor-icon-link" anchorid="section58561134191217" tips="复制节点链接"></i></h2>          <ol>      <li>应用服务端使用Client ID、Client Secret、Authorization Code调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-obtain-user-token#section1085901313579" target="_blank">获取用户级凭证接口</a>向华为账号服务器请求获取Access Token、Refresh Token。</li>      <li>使用Access Token调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-token-info#section2520125725115" target="_blank">解析凭证接口</a>获取用户的UnionID。       <p><strong>Access Token过期处理</strong></p>       <div class="p">        由于Access Token的有效期仅为60分钟，当Access Token失效或者即将失效时（可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-get-token-info#section1737691991515" target="_blank">REST API错误码</a>判断），可以使用Refresh Token（有效期180天）通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-obtain-refresh-token#section1085901313579" target="_blank">刷新用户级凭证接口</a>向华为账号服务器请求获取新的Access Token。        <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">          <ol>           <li>当Access Token失效时，若应用不使用Refresh Token向华为账号服务器请求获取新的Access Token，账号的授权信息将会失效，导致使用Access Token的功能都会失败。</li>           <li>当Access Token非正常失效（如修改密码、退出账号、删除设备）时，应用可重新登录授权获取Authorization Code，向华为账号服务器请求获取新的Access Token。</li>          </ol>         </div></div></div>       </div>       <p><strong>Refresh Token过期处理</strong></p>       <p>由于Refresh Token的有效期为180天，当Refresh Token失效后（可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/account-api-obtain-refresh-token#section1394417423453" target="_blank">REST API错误码</a>判断），应用服务端需要通知客户端，重新调用授权接口，请求用户重新授权。</p></li>      <li>应用在自己的用户体系通过查询获取的UnionID判断该用户是否已关联。如已关联，则完成用户登录；如未关联，则创建新用户，绑定UnionID，完成用户登录。</li>     </ol>    </div>   </div>   <div></div></div>