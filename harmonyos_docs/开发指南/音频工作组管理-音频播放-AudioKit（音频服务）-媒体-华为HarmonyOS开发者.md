<h1 _ngcontent-eil-c119="" class="doc-title ng-star-inserted" title="音频工作组管理"> 音频工作组管理 </h1>

<div _ngcontent-eil-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>音频工作组是一套通过标记来帮助系统识别应用内音频关键线程的接口，系统通过应用提供的关键音频线程以及工作组运行信息可以让音频线程的运行状态更加健康。</p>    <div class="tiledSection">     <h2 id="使用说明">使用说明<i class="anchor-icon anchor-icon-link" anchorid="使用说明" tips="复制节点链接"></i></h2>          <p>对于播放音频类应用，开发者需要先创建音频工作组，再将工作组运行信息的周期性告知系统。当工作结束后，需要对音频工作组进行清理。</p>    </div>    <div class="tiledSection">     <h3 id="创建音频工作组示例" class="firsth2">创建音频工作组示例<i class="anchor-icon anchor-icon-link" anchorid="创建音频工作组示例" tips="复制节点链接"></i></h3>          <p>开发者在使用OH_AudioWorkgroup的API前，需要先用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audio-resource-manager-h#oh_audiomanager_getaudioresourcemanager" target="_blank">OH_AudioManager_GetAudioResourceManager</a>获取OH_AudioResourceManager实例。</p>     <div _ngcontent-eil-c106="" class="highlight-div"><div _ngcontent-eil-c106="" class="highlight-div-header"><div _ngcontent-eil-c106="" class="highlight-div-header-left"><div _ngcontent-eil-c106="" class="handle-button expand-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eil-c106="" class="highlight-div-header-right"><div _ngcontent-eil-c106="" class="handle-button ai-button"></div><div _ngcontent-eil-c106="" class="handle-button line-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eil-c106="" class="handle-button theme-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eil-c106="" class="handle-button copy-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eil-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ohaudio/native_audio_resource_manager.h&gt;</span></span></li><li>
</li><li>OH_AudioResourceManager *resMgr;</li><li><span class="hljs-built_in">OH_AudioManager_GetAudioResourceManager</span>(&amp;resMgr);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="创建音频工作组并将关键线程加入音频工作组">创建音频工作组并将关键线程加入音频工作组<i class="anchor-icon anchor-icon-link" anchorid="创建音频工作组并将关键线程加入音频工作组" tips="复制节点链接"></i></h3>          <p>开发者先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audio-resource-manager-h#oh_audioresourcemanager_createworkgroup" target="_blank">OH_AudioResourceManager_CreateWorkgroup</a>创建一个新的音频工作组，再使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audio-resource-manager-h#oh_audioworkgroup_addcurrentthread" target="_blank">OH_AudioWorkgroup_AddCurrentThread</a>将关键线程加入音频工作组。</p>     <div _ngcontent-eil-c106="" class="highlight-div"><div _ngcontent-eil-c106="" class="highlight-div-header"><div _ngcontent-eil-c106="" class="highlight-div-header-left"><div _ngcontent-eil-c106="" class="handle-button expand-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eil-c106="" class="highlight-div-header-right"><div _ngcontent-eil-c106="" class="handle-button ai-button"></div><div _ngcontent-eil-c106="" class="handle-button line-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eil-c106="" class="handle-button theme-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eil-c106="" class="handle-button copy-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eil-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span></li><li>
</li><li><span class="hljs-type">int32_t</span> tokenId;</li><li>OH_AudioWorkgroup *grp = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-built_in">OH_AudioResourceManager_CreateWorkgroup</span>(resMgr, <span class="hljs-string">"workgroup"</span>, &amp;grp);</li><li><span class="hljs-built_in">OH_AudioWorkgroup_AddCurrentThread</span>(grp, &amp;tokenId);</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="通知系统音频工作组的开始与结束">通知系统音频工作组的开始与结束<i class="anchor-icon anchor-icon-link" anchorid="通知系统音频工作组的开始与结束" tips="复制节点链接"></i></h3>          <p>当音频工作组开始一个工作周期时，开发者可以通知系统任务的开始时间和预期完成时间。在音频工作组完成当前周期内的工作时，开发者应再次通知系统任务已结束。</p>     <div _ngcontent-eil-c106="" class="highlight-div"><div _ngcontent-eil-c106="" class="highlight-div-header"><div _ngcontent-eil-c106="" class="highlight-div-header-left"><div _ngcontent-eil-c106="" class="handle-button expand-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eil-c106="" class="highlight-div-header-right"><div _ngcontent-eil-c106="" class="handle-button ai-button"></div><div _ngcontent-eil-c106="" class="handle-button line-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eil-c106="" class="handle-button theme-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eil-c106="" class="handle-button copy-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eil-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span> intervalMs = <span class="hljs-number">20</span>;</li><li><span class="hljs-type">bool</span> threadShouldRun = <span class="hljs-literal">true</span>;</li><li>
</li><li><span class="hljs-keyword">while</span> (threadShouldRun) {</li><li>  <span class="hljs-keyword">auto</span> now = std::chrono::system_clock::<span class="hljs-built_in">now</span>().<span class="hljs-built_in">time_since_epoch</span>();</li><li>  <span class="hljs-keyword">auto</span> startTimeMs = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(now).<span class="hljs-built_in">count</span>();</li><li>
</li><li>  <span class="hljs-built_in">OH_AudioWorkgroup_Start</span>(grp, startTimeMs, startTimeMs + intervalMs);</li><li>  </li><li>  <span class="hljs-comment">// 应用音频数据处理。</span></li><li>
</li><li>  <span class="hljs-built_in">OH_AudioWorkgroup_Stop</span>(grp);</li><li>}</li></ol></pre></div></div>    </div>    <div class="tiledSection">     <h3 id="工作组任务结束后进行清理">工作组任务结束后进行清理<i class="anchor-icon anchor-icon-link" anchorid="工作组任务结束后进行清理" tips="复制节点链接"></i></h3>          <div _ngcontent-eil-c106="" class="highlight-div"><div _ngcontent-eil-c106="" class="highlight-div-header"><div _ngcontent-eil-c106="" class="highlight-div-header-left"><div _ngcontent-eil-c106="" class="handle-button expand-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-eil-c106="" class="highlight-div-header-right"><div _ngcontent-eil-c106="" class="handle-button ai-button"></div><div _ngcontent-eil-c106="" class="handle-button line-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-eil-c106="" class="handle-button theme-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-eil-c106="" class="handle-button copy-button"><div _ngcontent-eil-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-eil-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 当线程已经不需要接入分组时，将其从工作组中移除。</span></li><li><span class="hljs-built_in">OH_AudioWorkgroup_RemoveThread</span>(grp, tokenId);</li><li>
</li><li><span class="hljs-built_in">OH_AudioResourceManager_ReleaseWorkgroup</span>(resMgr, grp);</li><li>grp = <span class="hljs-literal">nullptr</span>;</li></ol></pre></div></div>    </div>   </div>   <div></div></div>