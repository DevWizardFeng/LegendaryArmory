<h1 _ngcontent-who-c119="" class="doc-title ng-star-inserted" title="音频录制流管理"> 音频录制流管理 </h1>

<div _ngcontent-who-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>对于录制音频类的应用，开发者需要关注该应用的音频流的状态以做出相应的操作，比如监听到状态为结束时，及时提示用户录制已结束。</p>    <div class="tiledSection">     <h2 id="读取或监听应用内音频流状态变化">读取或监听应用内音频流状态变化<i class="anchor-icon anchor-icon-link" anchorid="读取或监听应用内音频流状态变化" tips="复制节点链接"></i></h2>          <p>参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-audiocapturer-for-recording">使用AudioCapturer开发音频录制功能</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-f#audiocreateaudiocapturer8" target="_blank">audio.createAudioCapturer</a>，完成AudioCapturer的创建，然后可以通过以下两种方式查看音频流状态的变化：</p>     <ul>      <li>       <p>方法1：直接查看AudioCapturer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiocapturer#属性" target="_blank">state</a>：</p>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">audioCapturerState</span>: audio.<span class="hljs-property">AudioState</span> = audioCapturer.<span class="hljs-property">state</span>;</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Current state is: <span class="hljs-subst">${audioCapturerState }</span>`</span>)</li></ol></pre></div></div></li>      <li>       <p>方法2：注册stateChange监听AudioCapturer的状态变化：</p>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioCapturer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">capturerState: audio.AudioState</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`State change to: <span class="hljs-subst">${capturerState}</span>`</span>)</li><li>});</li></ol></pre></div></div></li>     </ul>     <p>获取state后可对照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#audiostate8" target="_blank">AudioState</a>来进行相应的操作，比如显示录制结束的提示等。</p>    </div>    <div class="tiledSection">     <h2 id="读取或监听所有录制流的变化">读取或监听所有录制流的变化<i class="anchor-icon anchor-icon-link" anchorid="读取或监听所有录制流的变化" tips="复制节点链接"></i></h2>          <p>如果部分应用需要查询获取所有音频流的变化信息，可以通过AudioStreamManager读取或监听所有音频流的变化。</p>     <p>如下为音频流管理调用关系图：</p>     <p><span><img originheight="704" originwidth="1872" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114431.25051885410132658071090919177593:50001231000000:2800:869BB1CAE7D19081D9BA365D3A3D29FBF947EB05B67A42619DB354B3CF8C3AC7.png" width="920" height="345.98290598290595"></span></p>     <p>在进行应用开发的过程中，开发者需要先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiomanager#getstreammanager9" target="_blank">getStreamManager</a>创建AudioStreamManager实例，进而通过该实例管理音频流。</p>     <p>详细API含义可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager" target="_blank">AudioStreamManager</a>。</p>    </div>    <div class="tiledSection">     <h2 id="开发步骤及注意事项">开发步骤及注意事项<i class="anchor-icon anchor-icon-link" anchorid="开发步骤及注意事项" tips="复制节点链接"></i></h2>          <ol>      <li>       <p>创建AudioStreamManager实例。</p>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> audioManager = audio.<span class="hljs-title function_">getAudioManager</span>();</li><li><span class="hljs-keyword">let</span> audioStreamManager = audioManager.<span class="hljs-title function_">getStreamManager</span>();</li></ol></pre></div></div></li>      <li>       <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#onaudiocapturerchange9" target="_blank">on('audioCapturerChange')</a>监听音频录制流更改事件。 如果音频流监听应用需要在音频录制流状态变化、设备变化时获取通知，可以订阅该事件。</p>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioStreamManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'audioCapturerChange'</span>, <span class="hljs-function">(<span class="hljs-params">AudioCapturerChangeInfoArray: audio.AudioCapturerChangeInfoArray</span>) =&gt;</span>  {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-title class_">AudioCapturerChangeInfoArray</span>.<span class="hljs-property">length</span>; i++) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`## CapChange on is called for element <span class="hljs-subst">${i}</span> ##`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`StreamId for <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].streamId}</span>`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Source for <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].capturerInfo.source}</span>`</span>);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Flag  <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].capturerInfo.capturerFlags}</span>`</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">devDescriptor</span>: audio.<span class="hljs-property">AudioDeviceDescriptors</span> = <span class="hljs-title class_">AudioCapturerChangeInfoArray</span>[i].<span class="hljs-property">deviceDescriptors</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-title class_">AudioCapturerChangeInfoArray</span>[i].<span class="hljs-property">deviceDescriptors</span>.<span class="hljs-property">length</span>; j++) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Id: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].id}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Type: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].deviceType}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Role: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].deviceRole}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].name}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Address: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].address}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SampleRates: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].sampleRates[<span class="hljs-number">0</span>]}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ChannelCounts <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].channelCounts[<span class="hljs-number">0</span>]}</span>`</span>);</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ChannelMask: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].channelMasks}</span>`</span>);</li><li>    }</li><li>  }</li><li>});</li></ol></pre></div></div></li>      <li>       <p>（可选）使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#offaudiocapturerchange9" target="_blank">off('audioCapturerChange')</a>取消监听音频录制流变化。</p>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li>audioStreamManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'audioCapturerChange'</span>);</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'CapturerChange Off is called'</span>);</li></ol></pre></div></div></li>      <li>       <p>（可选）使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#getcurrentaudiocapturerinfoarray9" target="_blank">getCurrentAudioCapturerInfoArray</a>获取当前音频录制流的信息。该接口可获取音频录制流唯一ID、音频采集器信息以及音频录制设备信息。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>对所有音频流状态进行监听的应用需要<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions">声明权限</a>ohos.permission.USE_BLUETOOTH，否则无法获得实际的设备名称和设备地址信息，查询到的设备名称和设备地址（蓝牙设备的相关属性）将为空字符串。</p>         <p>从API version 20开始，通常在音频录制启动前调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiostreammanager#isrecordingavailable20" target="_blank">isRecordingAvailable</a>，判断当前传入的音频采集器信息中音源类型的录制是否可以启动成功。</p>        </div></div></div>       <div _ngcontent-who-c106="" class="highlight-div"><div _ngcontent-who-c106="" class="highlight-div-header"><div _ngcontent-who-c106="" class="highlight-div-header-left"><div _ngcontent-who-c106="" class="handle-button expand-button"><div _ngcontent-who-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-who-c106="" class="highlight-div-header-right"><div _ngcontent-who-c106="" class="handle-button ai-button"></div><div _ngcontent-who-c106="" class="handle-button line-button"><div _ngcontent-who-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-who-c106="" class="handle-button theme-button"><div _ngcontent-who-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-who-c106="" class="handle-button copy-button"><div _ngcontent-who-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-who-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentAudioCapturerInfoArray</span>(<span class="hljs-params"></span>){</li><li>  <span class="hljs-keyword">await</span> audioStreamManager.<span class="hljs-title function_">getCurrentAudioCapturerInfoArray</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">AudioCapturerChangeInfoArray: audio.AudioCapturerChangeInfoArray</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'getCurrentAudioCapturerInfoArray  Get Promise Called '</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">AudioCapturerChangeInfoArray</span> != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-title class_">AudioCapturerChangeInfoArray</span>.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`StreamId for <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].streamId}</span>`</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Source for <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].capturerInfo.source}</span>`</span>);</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Flag  <span class="hljs-subst">${i}</span> is: <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].capturerInfo.capturerFlags}</span>`</span>);</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-title class_">AudioCapturerChangeInfoArray</span>[i].<span class="hljs-property">deviceDescriptors</span>.<span class="hljs-property">length</span>; j++) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Id: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].id}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Type: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].deviceType}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Role: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].deviceRole}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].name}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Address: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].address}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`SampleRates: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].sampleRates[<span class="hljs-number">0</span>]}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ChannelCounts <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].channelCounts[<span class="hljs-number">0</span>]}</span>`</span>);</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ChannelMask: <span class="hljs-subst">${i}</span> : <span class="hljs-subst">${AudioCapturerChangeInfoArray[i].deviceDescriptors[j].channelMasks}</span>`</span>);</li><li>        }</li><li>      }</li><li>    }</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Invoke getCurrentAudioCapturerInfoArray failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>