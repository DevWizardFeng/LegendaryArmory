<h1 _ngcontent-mqd-c119="" class="doc-title ng-star-inserted" title="音频解码"> 音频解码 </h1>

<div _ngcontent-mqd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>开发者可以调用本模块的Native API接口，完成音频解码，即将媒体数据解码为PCM码流。</p>    <p>当前支持的解码能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#音频解码">AVCodec支持的格式</a>。</p>    <p><strong>适用场景</strong></p>    <ul>     <li>      <p>音频播放</p>      <p>在播放音频之前，需要先解码音频，再将数据输送到硬件扬声器播放。</p></li>     <li>      <p>音频渲染</p>      <p>在对音频文件进行音效处理之前，需要先解码再由音频处理模块进行音频渲染。</p></li>     <li>      <p>音频编辑</p>      <p>音频编辑（如调整单个声道的播放倍速等）需要基于PCM码流进行，所以需要先将音频文件解码。</p></li>    </ul>    <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">      <p>通过MP3音频编码流程生成的码流无法直接通过MP3音频解码流程进行解码。建议通过（PCM码流-&gt;MP3音频编码-&gt;封装-&gt;解封装-&gt;MP3音频解码）流程进行。</p>     </div></div></div>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-audiocodec-h" target="_blank">API文档</a>。</p>     <p>参考以下示例代码，完成音频解码的全流程，包括：创建解码器、设置解码参数（采样率/码率/声道数等）、开始、刷新、重置、销毁资源。</p>     <p>在应用开发过程中，开发者应按一定顺序调用方法，执行对应操作，否则系统可能会抛出异常或生成其他未定义的行为。具体顺序可参考下列开发步骤及对应说明。</p>     <p>如下为音频解码调用关系图：</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="3377" originwidth="4445" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114428.86157923249801091902852893209962:50001231000000:2800:8DBA7B8E2843441F95F287B328B5FCB6923C424A4E07562DE88D521AF041B377.png" width="920" height="698.9516310461192"></span></p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_acodec.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，此处由开发者根据实际工程目录自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>添加头文件。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_audiocodec.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/native_audio_channel_layout.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li></ol></pre></div></div></li>      <li>       <p>创建解码器实例对象，OH_AVCodec *为解码器实例指针。</p>       <p>应用可以通过媒体类型或编解码器名称创建解码器。</p>       <p>方法一：通过 Mimetype 创建解码器。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置判定是否为编码；设置false表示当前是解码。</span></li><li><span class="hljs-type">bool</span> isEncoder = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// 通过 Mimetype 创建解码器。</span></li><li>OH_AVCodec *audioDec_ = <span class="hljs-built_in">OH_AudioCodec_CreateByMime</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, isEncoder);</li></ol></pre></div></div>       <p>方法二：通过 codec name 创建解码器。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过 codec name 创建解码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">false</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *audioDec_ = <span class="hljs-built_in">OH_AudioCodec_CreateByName</span>(name);</li></ol></pre></div></div>       <p>添加头文件和命名空间:</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span></li><li><span class="hljs-comment">// c++标准库命名空间。</span></li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li></ol></pre></div></div>       <p>示例代码：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化队列。</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ADecBufferSignal</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    std::mutex inMutex_;</li><li>    std::mutex outMutex_;</li><li>    std::mutex startMutex_;</li><li>    std::condition_variable inCond_;</li><li>    std::condition_variable outCond_;</li><li>    std::condition_variable startCond_;</li><li>    std::queue&lt;<span class="hljs-type">uint32_t</span>&gt; inQueue_;</li><li>    std::queue&lt;<span class="hljs-type">uint32_t</span>&gt; outQueue_;</li><li>    std::queue&lt;OH_AVBuffer *&gt; inBufferQueue_;</li><li>    std::queue&lt;OH_AVBuffer *&gt; outBufferQueue_;</li><li>};</li><li>ADecBufferSignal *signal_;</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_RegisterCallback()注册回调函数。</p>       <p>注册回调函数指针集合OH_AVCodecCallback，包括：</p>       <ul>        <li>OH_AVCodecOnError：解码器运行错误。</li>        <li>OH_AVCodecOnStreamChanged：码流信息变化回调，包括采样率变化、声道数变化、音频采样格式变化，支持检测此变化的解码格式有：Audio Vivid，AAC，FLAC，MP3，VORBIS。(API version 15开始支持)</li>        <li>OH_AVCodecOnNeedInputBuffer：运行过程中需要新的输入数据，即解码器已准备好，可以输入数据。</li>        <li>OH_AVCodecOnNewOutputBuffer：运行过程中产生了新的输出数据，即解码完成。</li>       </ul>       <p>开发者可以通过处理该回调报告的信息，确保解码器正常运转。</p>       <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">         <p>回调中不建议进行耗时操作。</p>        </div></div></div>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// OH_AVCodecOnError回调函数的实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)errorCode;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li><li><span class="hljs-comment">// OH_AVCodecOnStreamChanged回调函数的实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnOutputFormatChanged</span><span class="hljs-params">(OH_AVCodec *codec, OH_AVFormat *format, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>    <span class="hljs-comment">// 解码输出参数变化后的回调处理，应用根据实际情况进行处理。</span></li><li>    <span class="hljs-type">int32_t</span> sampleRate;</li><li>    <span class="hljs-type">int32_t</span> channelCount;</li><li>    <span class="hljs-type">int32_t</span> sampleFormat;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_AUD_SAMPLE_RATE, &amp;sampleRate)) {</li><li>        <span class="hljs-comment">// 判断采样率是否发生变化，进行对应处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_AUD_CHANNEL_COUNT, &amp;channelCount)) {</li><li>        <span class="hljs-comment">// 判断声道数是否发生变化，进行对应处理。</span></li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(format, OH_MD_KEY_AUDIO_SAMPLE_FORMAT, &amp;sampleFormat)) {</li><li>        <span class="hljs-comment">// 判断音频采样格式是否发生变化，进行对应处理。</span></li><li>    }</li><li>}</li><li><span class="hljs-comment">// OH_AVCodecOnNeedInputBuffer回调函数的实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnInputBufferAvailable</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *data, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    ADecBufferSignal *signal = <span class="hljs-built_in">static_cast</span>&lt;ADecBufferSignal *&gt;(userData);</li><li>    <span class="hljs-function">unique_lock&lt;mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(signal-&gt;inMutex_)</span></span>;</li><li>    signal-&gt;inQueue_.<span class="hljs-built_in">push</span>(index);</li><li>    signal-&gt;inBufferQueue_.<span class="hljs-built_in">push</span>(data);</li><li>    signal-&gt;inCond_.<span class="hljs-built_in">notify_all</span>();</li><li>    <span class="hljs-comment">// 解码输入码流送入inBufferQueue_队列。</span></li><li>}</li><li><span class="hljs-comment">// OH_AVCodecOnNewOutputBuffer回调函数的实现。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnOutputBufferAvailable</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVBuffer *data, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    (<span class="hljs-type">void</span>)codec;</li><li>    ADecBufferSignal *signal = <span class="hljs-built_in">static_cast</span>&lt;ADecBufferSignal *&gt;(userData);</li><li>    <span class="hljs-function">unique_lock&lt;mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(signal-&gt;outMutex_)</span></span>;</li><li>    signal-&gt;outQueue_.<span class="hljs-built_in">push</span>(index);</li><li>    signal-&gt;outBufferQueue_.<span class="hljs-built_in">push</span>(data);</li><li>    signal-&gt;outCond_.<span class="hljs-built_in">notify_all</span>();</li><li>    <span class="hljs-comment">// 将对应输出buffer的 index 送入outQueue_队列。</span></li><li>    <span class="hljs-comment">// 将对应解码完成的数据data送入outBufferQueue_队列。</span></li><li>}</li></ol></pre></div></div>       <p>配置回调：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>signal_ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ADecBufferSignal</span>();</li><li>OH_AVCodecCallback cb_ = {&amp;OnError, &amp;OnOutputFormatChanged, &amp;OnInputBufferAvailable, &amp;OnOutputBufferAvailable};</li><li><span class="hljs-comment">// 配置异步回调。</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioCodec_RegisterCallback</span>(audioDec_, cb_, signal_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）OH_AudioCodec_SetDecryptionConfig设置解密配置。</p>       <p>当获取到DRM信息(参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>开发步骤第4步)后，通过此接口进行解密配置。</p>       <p>DRM相关接口详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-drm" target="_blank">DRM API文档</a>。</p>       <p>此接口需在Prepare前调用。</p>       <p>添加头文件:</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysystem.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysession.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_err.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_common.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库:</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_drm.so)</li></ol></pre></div></div>       <p>使用示例:</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据DRM信息创建指定的DRM系统, 以创建"com.wiseplay.drm"为例。</span></li><li>MediaKeySystem *system = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;system);</li><li><span class="hljs-keyword">if</span> (system == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key system failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建解密会话。</span></li><li>MediaKeySession *session = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_SW_CRYPTO;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(system, &amp;contentProtectionLevel, &amp;session);</li><li><span class="hljs-keyword">if</span> (ret != DRM_OK) {</li><li>    <span class="hljs-comment">// 如创建失败，请查看DRM接口文档及日志信息。</span></li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key session failed."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (session == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"media key session is nullptr."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 获取许可证请求、设置许可证响应等。</span></li><li><span class="hljs-comment">// 设置解密配置, 即将解密会话、安全通路标志(当前音频解密不支持安全通路，应设置为false)设置到解码器中。</span></li><li><span class="hljs-type">bool</span> secureAudio = <span class="hljs-literal">false</span>;</li><li>ret = <span class="hljs-built_in">OH_AudioCodec_SetDecryptionConfig</span>(audioDec_, session, secureAudio);</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Configure()配置解码器。</p>       <p>配置选项key值说明：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.1" valign="top" width="10%">key</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.2" valign="top" width="10%">描述</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.3" valign="top" width="10%">AAC</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.4" valign="top" width="10%">Flac</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.5" valign="top" width="10%">Vorbis</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.6" valign="top" width="10%">MPEG(MP3)</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.7" valign="top" width="10%">G711mu</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.8" valign="top" width="10%">AMR(amrnb、amrwb)</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.9" valign="top" width="10%">APE</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.3.1.11.1.10" valign="top" width="10%">G711a</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUD_SAMPLE_RATE</td>           <td class="cellrowborder" valign="top" width="10%">采样率</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUD_CHANNEL_COUNT</td>           <td class="cellrowborder" valign="top" width="10%">声道数</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_MAX_INPUT_SIZE</td>           <td class="cellrowborder" valign="top" width="10%">最大输入长度</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AAC_IS_ADTS</td>           <td class="cellrowborder" valign="top" width="10%">是否adts</td>           <td class="cellrowborder" valign="top" width="10%">可选，默认1</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUDIO_SAMPLE_FORMAT</td>           <td class="cellrowborder" valign="top" width="10%">输出音频流格式</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（默认SAMPLE_S16LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（默认SAMPLE_S16LE）</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_BITRATE</td>           <td class="cellrowborder" valign="top" width="10%">码率</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_IDENTIFICATION_HEADER</td>           <td class="cellrowborder" valign="top" width="10%">ID Header</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和Codec_Config二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_SETUP_HEADER</td>           <td class="cellrowborder" valign="top" width="10%">Setup Header</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和Codec_Config二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_CODEC_CONFIG</td>           <td class="cellrowborder" valign="top" width="10%">编解码器特定数据</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和上述ID和Setup二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>                 </tbody></table></div>       </div>       <p>各音频解码类型参数范围说明：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.5.1.4.1.1" valign="top" width="33.33333333333333%">音频解码类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.5.1.4.1.2" valign="top" width="33.33333333333333%">采样率(Hz)</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.5.1.4.1.3" valign="top" width="33.33333333333333%">声道数</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AAC</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Flac</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Vorbis</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、176400、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">MPEG(MP3)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">G711mu</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AMR(amrnb)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AMR(amrwb)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">16000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">APE</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、176400、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">G711a</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~6</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Opus</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、12000、16000、24000、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Audio Vivid</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">32000、44100、48000、96000、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~16</td>          </tr>                 </tbody></table></div>       </div>       <p>API20新增<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcapability-h#oh_avcapability_getaudiosupportedsamplerateranges" target="_blank">采样率范围</a>能力查询，以下几种音频解码类型支持对范围内的任意采样率进行解码（API20之后）：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.7.1.3.1.1" valign="top" width="50%">音频解码类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.8.2.5.7.1.3.1.2" valign="top" width="50%">采样率(Hz)</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="50%">Flac</td>           <td class="cellrowborder" valign="top" width="50%">8000 ~ 384000</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">Vorbis</td>           <td class="cellrowborder" valign="top" width="50%">8000 ~ 192000</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="50%">APE</td>           <td class="cellrowborder" valign="top" width="50%">1 ~ 2147483647</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置音频采样率（必须）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_SAMPLERATE = <span class="hljs-number">44100</span>;</li><li><span class="hljs-comment">// 配置音频码率（可选）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_BITRATE = <span class="hljs-number">32000</span>;</li><li><span class="hljs-comment">// 配置音频声道数（必须）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_CHANNEL_COUNT = <span class="hljs-number">2</span>;</li><li><span class="hljs-comment">// 配置最大输入长度（可选）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_MAX_INPUT_SIZE = <span class="hljs-number">1152</span>;</li><li><span class="hljs-comment">// 配置是否为ADTS解码（aac解码时可选）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_AAC_TYPE = <span class="hljs-number">1</span>;</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_Create</span>();</li><li><span class="hljs-comment">// 写入format。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_SAMPLE_RATE, DEFAULT_SAMPLERATE);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_BITRATE, DEFAULT_BITRATE);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_CHANNEL_COUNT, DEFAULT_CHANNEL_COUNT);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_MAX_INPUT_SIZE, DEFAULT_MAX_INPUT_SIZE);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AAC_IS_ADTS, DEFAULT_AAC_TYPE);</li><li><span class="hljs-comment">// 配置解码器。</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioCodec_Configure</span>(audioDec_, format);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Prepare()，解码器就绪。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioCodec_Prepare</span>(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Start()启动解码器，进入运行态。</p>       <p>添加头文件：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ifstream</span> <span class="hljs-variable">inputFile_</span>;</li><li><span class="hljs-variable">ofstream</span> <span class="hljs-variable">outFile_</span>;</li><li>
</li><li><span class="hljs-comment">// 根据实际使用情况填写输入文件路径。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>* <span class="hljs-variable">inputFilePath</span> = <span class="hljs-string">"/"</span>;</li><li><span class="hljs-comment">// 根据实际使用情况填写输出文件路径。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>* <span class="hljs-variable">outputFilePath</span> = <span class="hljs-string">"/"</span>;</li><li><span class="hljs-comment">// 打开待解码二进制文件路径。</span></li><li><span class="hljs-variable">inputFile_</span>.<span class="hljs-keyword">open</span>(<span class="hljs-variable">inputFilePath</span>, <span class="hljs-variable">ios</span>::<span class="hljs-keyword">in</span> | <span class="hljs-title class_">ios</span>::<span class="hljs-title class_">binary</span>);</li><li><span class="hljs-comment">// 配置解码文件输出路径。</span></li><li><span class="hljs-variable">outFile_</span>.<span class="hljs-keyword">open</span>(<span class="hljs-variable">outputFilePath</span>, <span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-title class_">ios</span>::<span class="hljs-title class_">binary</span>);</li><li><span class="hljs-comment">// 开始解码。</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Start</span>(<span class="hljs-variable">audioDec_</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AVCencInfo_SetAVBuffer()，设置cencInfo。</p>       <p>若当前播放的节目是DRM加密节目，且由上层应用做<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">媒体解封装</a>，则须调用OH_AVCencInfo_SetAVBuffer()将cencInfo设置给AVBuffer，以实现AVBuffer中媒体数据的解密。</p>       <p>添加头文件：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_cencinfo.h&gt;</span></span></li></ol></pre></div></div>       <p>在 CMake 脚本中链接动态库：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avcencinfo.so)</li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> buffer = signal_-&gt;inBufferQueue_.<span class="hljs-built_in">front</span>();</li><li><span class="hljs-type">uint32_t</span> keyIdLen = DRM_KEY_ID_SIZE;</li><li><span class="hljs-type">uint8_t</span> keyId[] = {</li><li>    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x96</span>,</li><li>    <span class="hljs-number">0xcf</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x28</span>};</li><li><span class="hljs-type">uint32_t</span> ivLen = DRM_KEY_IV_SIZE;</li><li><span class="hljs-type">uint8_t</span> iv[] = {</li><li>    <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xde</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x3e</span>,</li><li>    <span class="hljs-number">0x52</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x95</span>};</li><li><span class="hljs-type">uint32_t</span> encryptedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> skippedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> firstEncryptedOffset = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> subsampleCount = <span class="hljs-number">1</span>;</li><li>DrmSubsample subsamples[<span class="hljs-number">1</span>] = { {<span class="hljs-number">0x10</span>, <span class="hljs-number">0x16</span>} };</li><li><span class="hljs-comment">// 创建CencInfo实例。</span></li><li>OH_AVCencInfo *cencInfo = <span class="hljs-built_in">OH_AVCencInfo_Create</span>();</li><li><span class="hljs-keyword">if</span> (cencInfo == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置解密算法。</span></li><li>OH_AVErrCode errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAlgorithm</span>(cencInfo, DRM_ALG_CENC_AES_CTR);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置KeyId和Iv。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetKeyIdAndIv</span>(cencInfo, keyId, keyIdLen, iv, ivLen);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置Sample信息。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetSubsampleInfo</span>(cencInfo, encryptedBlockCount, skippedBlockCount, firstEncryptedOffset,</li><li>    subsampleCount, subsamples);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置模式：KeyId、Iv和SubSamples已被设置。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetMode</span>(cencInfo, DRM_CENC_INFO_KEY_IV_SUBSAMPLES_SET);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将CencInfo设置到AVBuffer中。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAVBuffer</span>(cencInfo, buffer);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 销毁CencInfo实例。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_Destroy</span>(cencInfo);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_PushInputBuffer()，写入待解码的数据。</p>       <p>需开发者填充完整的输入数据后调用。</p>       <p>结束时需要将flags标识为AVCODEC_BUFFER_FLAGS_EOS。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">inQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">buffer</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">inBufferQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">size</span>;</li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">pts</span>;</li><li><span class="hljs-comment">// size是待解码数据的每帧帧长度。pts是每帧的时间戳，用于指示音频应该何时被播放。</span></li><li><span class="hljs-comment">// size和pts的获取来源：音视频资源文件或者待解码的数据流。</span></li><li><span class="hljs-comment">// 若是解码音视频资源文件，则需从解封装OH_AVDemuxer_ReadSampleBuffer的buffer中获取。</span></li><li><span class="hljs-comment">// 若是解码数据流，则需要从数据流的提供者获取。</span></li><li><span class="hljs-comment">// 此处为了介绍解码功能以测试文件中保存的size和pts为示例。</span></li><li><span class="hljs-variable">inputFile_</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(&amp;<span class="hljs-title class_">size</span>), <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">size</span>));</li><li><span class="hljs-variable">inputFile_</span>.<span class="hljs-title function_">read</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(&amp;<span class="hljs-title class_">pts</span>), <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">pts</span>));</li><li><span class="hljs-variable">inputFile_</span>.<span class="hljs-title function_">read</span>((<span class="hljs-variable">char</span> *)<span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">buffer</span>), <span class="hljs-variable">size</span>);</li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">attr</span> = {<span class="hljs-number">0</span>};</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">inputFile_</span>.<span class="hljs-title function_">eof</span>()) {</li><li>    <span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_EOS</span>;</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span> = <span class="hljs-variable">size</span>;</li><li>    <span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> = <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>;</li><li>}</li><li><span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">pts</span>;</li><li><span class="hljs-title function_">OH_AVBuffer_SetBufferAttr</span>(<span class="hljs-variable">buffer</span>, &amp;<span class="hljs-title class_">attr</span>);</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_PushInputBuffer</span>(<span class="hljs-variable">audioDec_</span>, <span class="hljs-variable">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_FreeOutputBuffer()，释放解码后的数据。</p>       <p>在取走解码PCM码流后，就应及时调用OH_AudioCodec_FreeOutputBuffer()进行释放。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">outQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">data</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">outBufferQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">data</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理</span></li><li>}</li><li><span class="hljs-comment">// 获取buffer attributes。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">attr</span> = {<span class="hljs-number">0</span>};</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">attr</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将解码完成数据data写入到对应输出文件中。</span></li><li><span class="hljs-variable">outFile_</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">data</span>)), <span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>);</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_FreeOutputBuffer</span>(<span class="hljs-variable">audioDec_</span>, <span class="hljs-variable">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>    <span class="hljs-comment">// 结束。</span></li><li>}</li></ol></pre></div></div>       <p>从API version 11开始，Audio Vivid新增获取元数据。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">uint32_t</span> <span class="hljs-variable">index</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">outQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-variable">OH_AVBuffer</span> *<span class="hljs-variable">data</span> = <span class="hljs-variable">signal_</span>-&gt;<span class="hljs-title class_">outBufferQueue_</span>.<span class="hljs-title class_">front</span>();</li><li><span class="hljs-comment">// 获取buffer attributes。</span></li><li><span class="hljs-variable">OH_AVCodecBufferAttr</span> <span class="hljs-variable">attr</span> = {<span class="hljs-number">0</span>};</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVBuffer_GetBufferAttr</span>(<span class="hljs-variable">data</span>, &amp;<span class="hljs-title class_">attr</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将解码完成数据data写入到对应输出文件中。</span></li><li><span class="hljs-variable">outFile_</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-title function_">OH_AVBuffer_GetAddr</span>(<span class="hljs-variable">data</span>)), <span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>);</li><li>
</li><li><span class="hljs-comment">// API version 11开始提供 获取audio vivid 元数据。</span></li><li><span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVBuffer_GetParameter</span>(<span class="hljs-variable">data</span>);</li><li><span class="hljs-variable">uint8_t</span> *<span class="hljs-variable">metadata</span> = <span class="hljs-variable">nullptr</span>;</li><li><span class="hljs-variable">size_t</span> <span class="hljs-variable">metaSize</span>;</li><li><span class="hljs-title function_">OH_AVFormat_GetBuffer</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUDIO_VIVID_METADATA</span>, &amp;<span class="hljs-title class_">metadata</span>, &amp;<span class="hljs-title class_">metaSize</span>);</li><li>
</li><li><span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_FreeOutputBuffer</span>(<span class="hljs-variable">audioDec_</span>, <span class="hljs-variable">index</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>    <span class="hljs-comment">// 结束。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AudioCodec_Flush()刷新解码器。</p>       <p>调用OH_AudioCodec_Flush()后，解码器仍处于运行态，但会将当前队列清空，将已解码的数据释放。</p>       <p>此时需要调用OH_AudioCodec_Start()重新开始解码。</p>       <p>使用情况：</p>       <ul>        <li>在文件EOS之后，需要调用刷新。</li>        <li>在执行过程中遇到可继续执行的错误时（即OH_AudioCodec_IsValid 为true）调用。</li>       </ul>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 刷新解码器 audioDec_。</span></li><li>int32_t ret = OH_AudioCodec_Flush(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 重新开始解码。</span></li><li>ret = OH_AudioCodec_Start(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AudioCodec_Reset()重置解码器。</p>       <p>调用OH_AudioCodec_Reset()后，解码器回到初始化的状态，需要调用OH_AudioCodec_Configure()重新配置，然后调用OH_AudioCodec_Start()重新开始解码。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 重置解码器 audioDec_。</span></li><li>int32_t ret = OH_AudioCodec_Reset(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 重新配置解码器参数。</span></li><li>ret = OH_AudioCodec_Configure(audioDec_, format);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Stop()停止解码器。</p>       <p>停止后，可以通过调用OH_AudioCodec_Start()重新进入已启动状态（started），但需要注意的是，如果编解码器之前已输入数据，则需要重新输入编解码器数据。</p>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 终止解码器 audioDec_。</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioCodec_Stop</span>(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Destroy()销毁解码器实例，释放资源。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>不要重复销毁解码器</p>        </div></div></div>       <div _ngcontent-mqd-c106="" class="highlight-div"><div _ngcontent-mqd-c106="" class="highlight-div-header"><div _ngcontent-mqd-c106="" class="highlight-div-header-left"><div _ngcontent-mqd-c106="" class="handle-button expand-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mqd-c106="" class="highlight-div-header-right"><div _ngcontent-mqd-c106="" class="handle-button ai-button"></div><div _ngcontent-mqd-c106="" class="handle-button line-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mqd-c106="" class="handle-button theme-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mqd-c106="" class="handle-button copy-button"><div _ngcontent-mqd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mqd-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用OH_AudioCodec_Destroy, 注销解码器。</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioCodec_Destroy</span>(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> {</li><li>    audioDec_ = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 不可重复destroy。</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>