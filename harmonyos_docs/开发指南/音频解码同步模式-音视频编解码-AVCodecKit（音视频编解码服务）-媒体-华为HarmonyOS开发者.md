<h1 _ngcontent-jek-c119="" class="doc-title ng-star-inserted" title="音频解码同步模式"> 音频解码同步模式 </h1>

<div _ngcontent-jek-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>从API 20开始，支持音频解码同步模式。</p>    <p>开发者可以调用本模块的Native API接口，完成同步模式的音频解码，即将媒体数据解码为PCM码流。</p>    <p>支持的解码能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#音频解码">AVCodec支持的格式</a>。</p>    <p><strong>适用场景</strong></p>    <p>通常推荐使用异步模式，详细内容请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-decoding">音频解码</a>。若需要主动请求buffer去送帧，则可以使用同步模式。</p>    <p>将音视频文件解码为PCM码流，通常需要以下步骤：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">媒体数据解析</a> -&gt; 音频解码。</p>    <p>本指南描述音频解码过程：输入音频帧和解码出PCM码流。</p>    <div class="tiledSection">     <h2 id="开发指导">开发指导<i class="anchor-icon anchor-icon-link" anchorid="开发指导" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-audiocodec-h" target="_blank">AudioCodec</a>。</p>     <p>参考以下示例代码，完成音频解码的全流程，包括：创建解码器、设置解码参数（采样率/码率/声道数等）、开始/刷新/重置/销毁资源。</p>     <p>在应用开发过程中，开发者应按顺序调用方法，执行操作，否则系统可能会抛出异常或生成其他未定义的行为。具体顺序可参考下列开发步骤及对应说明。</p>     <p>音频编解码同步模式调用关系图如下所示：</p>     <ul>      <li>       <p>虚线表示可选。</p></li>      <li>       <p>实线表示必选。</p></li>     </ul>     <p><span><img originheight="1290" originwidth="1975" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211114430.02744141125110941349549037131649:50001231000000:2800:6F6CA85F52253A7A9C30A7A31A8D551DFAC482D5C9402231C37BE46FAE129079.png" width="920" height="600.9113924050632"></span></p>    </div>    <div class="tiledSection">     <h3 id="在-cmake-脚本中链接动态库" class="firsth2">在 CMake 脚本中链接动态库<i class="anchor-icon anchor-icon-link" anchorid="在-cmake-脚本中链接动态库" tips="复制节点链接"></i></h3>          <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_codecbase.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_core.so)</li><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_acodec.so)</li></ol></pre></div></div>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p>上述'sample'字样仅为示例，开发者需根据实际工程目录进行自定义。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h3>          <ol>      <li>       <p>添加头文件和命名空间。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_audiocodec.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/native_audio_channel_layout.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcapability.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avcodec_base.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avformat.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_avbuffer.h&gt;</span></span></li><li>
</li><li><span class="hljs-comment">// c++标准库命名空间。</span></li><li><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;</li></ol></pre></div></div></li>      <li>       <p>创建解码器实例对象，OH_AVCodec *为解码器实例指针。</p>       <p>应用可以通过媒体类型或编解码器名称创建解码器。</p>       <p>方法一：通过Mimetype创建解码器。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>// 通过Mimetype创建解码器，这里示例创建的是AAC编码格式，第二个入参设置<span class="hljs-literal">false</span>表示当前是解码。</li><li>OH_AVCodec *audioDec_ = OH_AudioCodec_CreateByMime(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">false</span>);</li></ol></pre></div></div>       <p>方法二：通过codec name创建解码器。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 通过codec name创建解码器。</span></li><li>OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapability</span>(OH_AVCODEC_MIMETYPE_AUDIO_AAC, <span class="hljs-literal">false</span>);</li><li><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>OH_AVCodec *audioDec_ = <span class="hljs-built_in">OH_AudioCodec_CreateByName</span>(name);</li></ol></pre></div></div></li>      <li>       <p>（可选）OH_AudioCodec_SetDecryptionConfig设置解密配置。</p>       <p>当获取到DRM信息（参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">音视频解封装</a>开发步骤第4步）后，通过此接口进行解密配置。</p>       <p>DRM相关接口详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-drm" target="_blank">DRM</a>。</p>       <p>此接口需在Prepare前调用。</p>       <p>添加头文件：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysystem.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_mediakeysession.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_err.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/drm_framework/native_drm_common.h&gt;</span></span></li></ol></pre></div></div>       <p>在CMake脚本中链接动态库：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_drm.so)</li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 根据DRM信息创建指定的DRM系统, 以创建"com.wiseplay.drm"为例。</span></li><li>MediaKeySystem *system = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_MediaKeySystem_Create</span>(<span class="hljs-string">"com.wiseplay.drm"</span>, &amp;system);</li><li><span class="hljs-keyword">if</span> (system == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key system failed"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 创建解密会话。</span></li><li>MediaKeySession *session = <span class="hljs-literal">nullptr</span>;</li><li>DRM_ContentProtectionLevel contentProtectionLevel = CONTENT_PROTECTION_LEVEL_SW_CRYPTO;</li><li>ret = <span class="hljs-built_in">OH_MediaKeySystem_CreateMediaKeySession</span>(system, &amp;contentProtectionLevel, &amp;session);</li><li><span class="hljs-keyword">if</span> (ret != DRM_OK) {</li><li>    <span class="hljs-comment">// 如果创建失败，请查看DRM接口文档及日志信息。</span></li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"create media key session failed."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">if</span> (session == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"media key session is nullptr."</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// 获取许可证请求、设置许可证响应等。</span></li><li><span class="hljs-comment">// 设置解密信息。将解密会话设置到解码器中。当前音频解密不支持安全解码器，设置为false。</span></li><li><span class="hljs-type">bool</span> secureAudio = <span class="hljs-literal">false</span>;</li><li>ret = <span class="hljs-built_in">OH_AudioCodec_SetDecryptionConfig</span>(audioDec_, session, secureAudio);</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Configure()配置解码器。</p>       <p>配置选项key值说明：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.1" valign="top" width="10%">key</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.2" valign="top" width="10%">描述</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.3" valign="top" width="10%">AAC</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.4" valign="top" width="10%">Flac</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.5" valign="top" width="10%">Vorbis</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.6" valign="top" width="10%">MPEG</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.7" valign="top" width="10%">G711mu</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.8" valign="top" width="10%">AMR(amrnb、amrwb)</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.9" valign="top" width="10%">APE</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.3.1.11.1.10" valign="top" width="10%">G711a</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_ENABLE_SYNC_MODE</td>           <td class="cellrowborder" valign="top" width="10%">同步模式配置,打开同步模式时，必须配置为1</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>           <td class="cellrowborder" valign="top" width="10%">同步模式必须</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUD_SAMPLE_RATE</td>           <td class="cellrowborder" valign="top" width="10%">采样率</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUD_CHANNEL_COUNT</td>           <td class="cellrowborder" valign="top" width="10%">声道数</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>           <td class="cellrowborder" valign="top" width="10%">必须</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_MAX_INPUT_SIZE</td>           <td class="cellrowborder" valign="top" width="10%">最大输入长度</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AAC_IS_ADTS</td>           <td class="cellrowborder" valign="top" width="10%">是否adts</td>           <td class="cellrowborder" valign="top" width="10%">可选，默认1</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_AUDIO_SAMPLE_FORMAT</td>           <td class="cellrowborder" valign="top" width="10%">输出音频流格式</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（默认SAMPLE_S16LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选（SAMPLE_S16LE，SAMPLE_F32LE）</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选（默认SAMPLE_S16LE）</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_BITRATE</td>           <td class="cellrowborder" valign="top" width="10%">码率</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_IDENTIFICATION_HEADER</td>           <td class="cellrowborder" valign="top" width="10%">ID Header</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和Codec_Config二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_SETUP_HEADER</td>           <td class="cellrowborder" valign="top" width="10%">Setup Header</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和Codec_Config二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="10%">OH_MD_KEY_CODEC_CONFIG</td>           <td class="cellrowborder" valign="top" width="10%">编解码器特定数据</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">必须（和上述ID和Setup二选一）</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">-</td>           <td class="cellrowborder" valign="top" width="10%">可选</td>           <td class="cellrowborder" valign="top" width="10%">-</td>          </tr>                 </tbody></table></div>       </div>       <p>以下各音频解码类型参数范围说明：</p>       <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.5.1.4.1.1" valign="top" width="33.33333333333333%">音频解码类型</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.5.1.4.1.2" valign="top" width="33.33333333333333%">采样率(Hz)</th>           <th align="left" class="cellrowborder" id="mcps1.3.10.2.4.5.1.4.1.3" valign="top" width="33.33333333333333%">声道数</th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AAC</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Flac</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Vorbis</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、176400、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~8</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">MPEG(MP3)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">G711mu</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AMR(amrnb)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">AMR(amrwb)</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">16000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">APE</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000、64000、88200、96000、176400、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">G711a</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、11025、12000、16000、22050、24000、32000、44100、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~6</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Opus</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">8000、12000、16000、24000、48000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~2</td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="33.33333333333333%">Audio Vivid</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">32000、44100、48000、96000、192000</td>           <td class="cellrowborder" valign="top" width="33.33333333333333%">1~16</td>          </tr>                 </tbody></table></div>       </div>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置音频采样率（必须）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_SAMPLERATE = <span class="hljs-number">44100</span>;</li><li><span class="hljs-comment">// 配置音频声道数（必须）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_CHANNEL_COUNT = <span class="hljs-number">2</span>;</li><li><span class="hljs-comment">// 配置是否为ADTS解码（aac解码时可选）。</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> DEFAULT_AAC_TYPE = <span class="hljs-number">1</span>;</li><li>OH_AVFormat *format = <span class="hljs-built_in">OH_AVFormat_Create</span>();</li><li><span class="hljs-comment">// 写入format。</span></li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_SAMPLE_RATE, DEFAULT_SAMPLERATE);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AUD_CHANNEL_COUNT, DEFAULT_CHANNEL_COUNT);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_AAC_IS_ADTS, DEFAULT_AAC_TYPE);</li><li><span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_ENABLE_SYNC_MODE, <span class="hljs-number">1</span>); <span class="hljs-comment">// 同步模式配置。</span></li><li><span class="hljs-comment">// 配置解码器。</span></li><li>OH_AVErrCode ret = <span class="hljs-built_in">OH_AudioCodec_Configure</span>(audioDec_, format);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Prepare()，解码器就绪。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_AudioCodec_Prepare(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Start()启动解码器，进入运行态。</p>       <p>添加头文件：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span></li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ifstream</span> <span class="hljs-variable">inputFile_</span>;</li><li><span class="hljs-variable">ofstream</span> <span class="hljs-variable">outFile_</span>;</li><li>
</li><li><span class="hljs-comment">// 根据实际使用情况填写输入文件路径。为便于演示音频解码功能，此处输入文件包含音频帧及相关信息，而非可直接播放的音频文件。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>* <span class="hljs-variable">inputFilePath</span> = <span class="hljs-string">"/"</span>;</li><li><span class="hljs-comment">// 根据实际使用情况填写输出文件路径。本指南仅演示音频解码功能，解码后的PCM数据保存到文件中，未作进一步处理。</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">char</span>* <span class="hljs-variable">outputFilePath</span> = <span class="hljs-string">"/"</span>;</li><li><span class="hljs-comment">// 打开待解码二进制文件路径。</span></li><li><span class="hljs-variable">inputFile_</span>.<span class="hljs-keyword">open</span>(<span class="hljs-variable">inputFilePath</span>, <span class="hljs-variable">ios</span>::<span class="hljs-keyword">in</span> | <span class="hljs-title class_">ios</span>::<span class="hljs-title class_">binary</span>);</li><li><span class="hljs-comment">// 配置解码文件输出路径。</span></li><li><span class="hljs-variable">outFile_</span>.<span class="hljs-keyword">open</span>(<span class="hljs-variable">outputFilePath</span>, <span class="hljs-variable">ios</span>::<span class="hljs-title class_">out</span> | <span class="hljs-title class_">ios</span>::<span class="hljs-title class_">binary</span>);</li><li><span class="hljs-comment">// 开始解码。</span></li><li><span class="hljs-variable">OH_AVErrCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Start</span>(<span class="hljs-variable">audioDec_</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AVCencInfo_SetAVBuffer()，设置cencInfo。</p>       <p>如果当前播放的节目是DRM加密节目，并且由上层应用进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer">媒体数据解析</a>，则需要调用OH_AVCencInfo_SetAVBuffer()将cencInfo设置给AVBuffer，以实现媒体数据的解密。</p>       <p>添加头文件：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/player_framework/native_cencinfo.h&gt;</span></span></li></ol></pre></div></div>       <p>在CMake脚本中链接动态库：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="cmake prettyprint linenums hljs language-scss" hw-language="cmake" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">target_link_libraries</span>(sample PUBLIC libnative_media_avcencinfo.so)</li></ol></pre></div></div>       <p>使用示例：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">auto</span> buffer = signal_-&gt;inBufferQueue_.<span class="hljs-built_in">front</span>();</li><li><span class="hljs-type">uint32_t</span> keyIdLen = DRM_KEY_ID_SIZE;</li><li><span class="hljs-type">uint8_t</span> keyId[] = {</li><li>    <span class="hljs-number">0xd4</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xc8</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x96</span>,</li><li>    <span class="hljs-number">0xcf</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x28</span>};</li><li><span class="hljs-type">uint32_t</span> ivLen = DRM_KEY_IV_SIZE;</li><li><span class="hljs-type">uint8_t</span> iv[] = {</li><li>    <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xde</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x3e</span>,</li><li>    <span class="hljs-number">0x52</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x95</span>};</li><li><span class="hljs-type">uint32_t</span> encryptedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> skippedBlockCount = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> firstEncryptedOffset = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">uint32_t</span> subsampleCount = <span class="hljs-number">1</span>;</li><li>DrmSubsample subsamples[<span class="hljs-number">1</span>] = { {<span class="hljs-number">0x10</span>, <span class="hljs-number">0x16</span>} };</li><li><span class="hljs-comment">// 创建CencInfo实例。</span></li><li>OH_AVCencInfo *cencInfo = <span class="hljs-built_in">OH_AVCencInfo_Create</span>();</li><li><span class="hljs-keyword">if</span> (cencInfo == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置解密算法。</span></li><li>OH_AVErrCode errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAlgorithm</span>(cencInfo, DRM_ALG_CENC_AES_CTR);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置KeyId和Iv。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetKeyIdAndIv</span>(cencInfo, keyId, keyIdLen, iv, ivLen);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置Sample信息。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetSubsampleInfo</span>(cencInfo, encryptedBlockCount, skippedBlockCount, firstEncryptedOffset,</li><li>    subsampleCount, subsamples);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 设置模式：KeyId、Iv和SubSamples已被设置。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetMode</span>(cencInfo, DRM_CENC_INFO_KEY_IV_SUBSAMPLES_SET);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 将CencInfo设置到AVBuffer中。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_SetAVBuffer</span>(cencInfo, buffer);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 销毁CencInfo实例。</span></li><li>errNo = <span class="hljs-built_in">OH_AVCencInfo_Destroy</span>(cencInfo);</li><li><span class="hljs-keyword">if</span> (errNo != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>同步模式调用，写入待解码的数据，获取解码的输出。</p>       <p>读取数据：</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// size是待解码数据的每帧帧长度。pts是每帧的时间戳，用于指示音频应该何时被播放。</span></li><li><span class="hljs-comment">// size和pts的获取来源：音视频资源文件或者待解码的数据流。</span></li><li><span class="hljs-comment">// 如果是解码音视频资源文件，则需要从解封装OH_AVDemuxer_ReadSampleBuffer的buffer中获取。</span></li><li><span class="hljs-comment">// 如果是解码数据流，则需要从数据流的提供者获取。</span></li><li><span class="hljs-comment">// 此处为了介绍解码功能以测试文件中保存的size和pts为示例。</span></li><li><span class="hljs-type">bool</span> DecoderFillInputBuffer(OH_AVBuffer *buffer, ifstream &amp;inputFile)</li><li>{</li><li>    OH_AVCodecBufferAttr attr;</li><li>    memset(&amp;attr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(attr));</li><li>    attr.flags = <span class="hljs-built_in">AVCODEC_BUFFER_FLAGS_EOS</span>;</li><li>    <span class="hljs-type">bool</span> finished = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">do</span> {</li><li>        int64_t size;</li><li>        inputFile.read(reinterpret_cast&lt;<span class="hljs-type">char</span> *&gt;(&amp;size), <span class="hljs-keyword">sizeof</span>(size));</li><li>        <span class="hljs-keyword">if</span> (inputFile.eof() || inputFile.gcount() != <span class="hljs-keyword">sizeof</span>(size)) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        inputFile.read(reinterpret_cast&lt;<span class="hljs-type">char</span> *&gt;(&amp;attr.pts), <span class="hljs-keyword">sizeof</span>(attr.pts));</li><li>        <span class="hljs-keyword">if</span> (inputFile.gcount() != <span class="hljs-keyword">sizeof</span>(attr.pts)) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        attr.size = static_cast&lt;int32_t&gt;(size);</li><li>        <span class="hljs-keyword">if</span> (attr.size &gt; <span class="hljs-number">0</span>) {</li><li>            inputFile.read((<span class="hljs-type">char</span> *)OH_AVBuffer_GetAddr(buffer), attr.size);</li><li>            attr.flags = <span class="hljs-built_in">AVCODEC_BUFFER_FLAGS_NONE</span>;</li><li>            finished = <span class="hljs-literal">false</span>;</li><li>        }</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    OH_AVBuffer_SetBufferAttr(buffer, &amp;attr);</li><li>    <span class="hljs-keyword">return</span> finished;</li><li>}</li><li><span class="hljs-type">bool</span> InputOneFrame(OH_AVCodec *codec, ifstream &amp;inputFile)</li><li>{</li><li>    uint32_t index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">bool</span> finished = <span class="hljs-literal">true</span>;</li><li>    OH_AVErrCode ret = OH_AudioCodec_QueryInputBuffer(codec, &amp;index, <span class="hljs-number">20000</span>); <span class="hljs-comment">// 20000us</span></li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-built_in">AV_ERR_TRY_AGAIN_LATER</span>) {</li><li>        <span class="hljs-comment">// 超时，异常处理，设置的超时时间过短或输入输出buffer没有消耗/释放导致解码阻塞。</span></li><li>        <span class="hljs-keyword">return</span> finished;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>        <span class="hljs-keyword">return</span> finished;</li><li>    }</li><li>    OH_AVBuffer *inputBuf = OH_AudioCodec_GetInputBuffer(codec, index);</li><li>    <span class="hljs-keyword">if</span> (inputBuf == nullptr) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>        <span class="hljs-keyword">return</span> finished;</li><li>    }</li><li>    finished = DecoderFillInputBuffer(inputBuf, inputFile);</li><li>    OH_AudioCodec_PushInputBuffer(codec, index);</li><li>    <span class="hljs-keyword">return</span> finished;</li><li>}</li></ol></pre></div></div>       <p>需开发者填充完整的输入数据后调用。</p>       <p>结束时需要将flags标识为AVCODEC_BUFFER_FLAGS_EOS。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">bool</span> inputFinished = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">for</span> (;;) {</li><li>    <span class="hljs-keyword">if</span> (!inputFinished) {</li><li>        inputFinished = <span class="hljs-built_in">InputOneFrame</span>(audioDec_, inputFile_);</li><li>    }</li><li>    <span class="hljs-type">uint32_t</span> index;</li><li>    OH_AVErrCode ret = <span class="hljs-built_in">OH_AudioCodec_QueryOutputBuffer</span>(audioDec_, &amp;index, <span class="hljs-number">20000</span>); <span class="hljs-comment">// 20000us</span></li><li>    <span class="hljs-keyword">if</span> (ret == AV_ERR_TRY_AGAIN_LATER) {</li><li>        <span class="hljs-comment">// 超时，异常处理，设置的超时时间过短或输入输出buffer没有消耗/释放导致解码阻塞。</span></li><li>        <span class="hljs-keyword">continue</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == AV_ERR_STREAM_CHANGED) {</li><li>        <span class="hljs-comment">// 解码输出参数变化后的回调处理，应用根据实际情况进行处理。</span></li><li>        OH_AVFormat *outFormat = <span class="hljs-built_in">OH_AudioCodec_GetOutputDescription</span>(audioDec_);</li><li>        <span class="hljs-type">int32_t</span> sampleRate;</li><li>        <span class="hljs-type">int32_t</span> channelCount;</li><li>        <span class="hljs-type">int32_t</span> sampleFormat;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(outFormat, OH_MD_KEY_AUD_SAMPLE_RATE, &amp;sampleRate)) {</li><li>            <span class="hljs-comment">// 判断采样率是否发生变化，进行对应处理。</span></li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(outFormat, OH_MD_KEY_AUD_CHANNEL_COUNT, &amp;channelCount)) {</li><li>            <span class="hljs-comment">// 判断声道数是否发生变化，进行对应处理。</span></li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVFormat_GetIntValue</span>(outFormat, OH_MD_KEY_AUDIO_SAMPLE_FORMAT, &amp;sampleFormat)) {</li><li>            <span class="hljs-comment">// 判断音频采样格式是否发生变化，进行对应处理。</span></li><li>        }</li><li>        <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    OH_AVBuffer *outputBuf = <span class="hljs-built_in">OH_AudioCodec_GetOutputBuffer</span>(audioDec_, index);</li><li>    <span class="hljs-keyword">if</span> (outputBuf == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    OH_AVCodecBufferAttr attr;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(outputBuf, &amp;attr) != AV_ERR_OK) {</li><li>        <span class="hljs-comment">// 异常处理。</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (attr.flags &amp; AVCODEC_BUFFER_FLAGS_EOS) {</li><li>        <span class="hljs-built_in">OH_AudioCodec_FreeOutputBuffer</span>(audioDec_, index);</li><li>        <span class="hljs-comment">// 解码输出结束。</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    outFile_.<span class="hljs-built_in">write</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-built_in">OH_AVBuffer_GetAddr</span>(outputBuf)), attr.size);</li><li>    <span class="hljs-built_in">OH_AudioCodec_FreeOutputBuffer</span>(audioDec_, index);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AudioCodec_Flush()刷新解码器。</p>       <p>调用OH_AudioCodec_Flush()后，解码器仍处于运行态，但会清空当前队列，释放已解码的数据。刷新前获取到的输入输出buffer都无法接续使用。</p>       <p>此时需要调用OH_AudioCodec_Start()重新开始解码。</p>       <p>使用情况：</p>       <ul>        <li>之前输入的数据不再使用的场景，例如在解封装seek之后，调用刷新。</li>        <li>在文件EOS之后，需要调用刷新。</li>        <li>在执行过程中遇到可继续执行的错误时（即OH_AudioCodec_IsValid 为true）调用。</li>       </ul>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 刷新解码器audioDec_。</span></li><li>OH_AVErrCode ret = OH_AudioCodec_Flush(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 重新开始解码。</span></li><li>ret = OH_AudioCodec_Start(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>（可选）调用OH_AudioCodec_Reset()重置解码器。</p>       <p>调用OH_AudioCodec_Reset()后，解码器回到初始化的状态，需要先调用OH_AudioCodec_Configure()重新配置，再调用OH_AudioCodec_Start()重新开始解码。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 重置解码器audioDec_。</span></li><li>OH_AVErrCode ret = OH_AudioCodec_Reset(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li><li><span class="hljs-comment">// 重新配置解码器参数。</span></li><li>ret = OH_AudioCodec_Configure(audioDec_, format);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Stop()停止解码器。</p>       <p>停止后，可以通过调用OH_AudioCodec_Start()重新进入已启动状态（started）。停止前获取到的输入输出buffer都无法接续使用，需要在启动后重新获取输入输出buffer。</p>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 终止解码器audioDec_。</span></li><li><span class="hljs-type">OH_AVErrCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_AudioCodec_Stop(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>}</li></ol></pre></div></div></li>      <li>       <p>调用OH_AudioCodec_Destroy()销毁解码器实例，释放资源。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>禁止重复销毁解码器。</p>        </div></div></div>       <div _ngcontent-jek-c106="" class="highlight-div"><div _ngcontent-jek-c106="" class="highlight-div-header"><div _ngcontent-jek-c106="" class="highlight-div-header-left"><div _ngcontent-jek-c106="" class="handle-button expand-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-jek-c106="" class="highlight-div-header-right"><div _ngcontent-jek-c106="" class="handle-button ai-button"></div><div _ngcontent-jek-c106="" class="handle-button line-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-jek-c106="" class="handle-button theme-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-jek-c106="" class="handle-button copy-button"><div _ngcontent-jek-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-jek-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-objectivec" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 调用OH_AudioCodec_Destroy, 销毁解码器。</span></li><li>OH_AVErrCode ret = OH_AudioCodec_Destroy(audioDec_);</li><li><span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>    <span class="hljs-comment">// 异常处理。</span></li><li>} <span class="hljs-keyword">else</span> {</li><li>    audioDec_ = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 不可重复destroy。</span></li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>