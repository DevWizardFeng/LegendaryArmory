<h1 _ngcontent-dpg-c119="" class="doc-title ng-star-inserted" title="预加载实现类"> 预加载实现类 </h1>

<div _ngcontent-dpg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在“entry/src/main/ets/prefetchUtil”目录下新增PrefetchUtil.ets和PrefetchWrapper.ets。</p> <p>PrefetchUtil和PrefetchWrapper实现类功能如下：</p> <ul><li>PrefetchUtil：预加载API的封装类，为PrefetchWrapper提供预加载API封装接口。<ul><li>提供安装预加载的数据获取接口</li><li>提供周期性预加载的任务注册接口和数据获取接口</li><li>提供周期性预加载是否已拉取数据的判断接口</li></ul> </li><li>PrefetchWrapper：预加载包装类，为页面提供预加载封装接口。<ul><li>提供安装预加载数据获取和渲染接口</li><li>提供周期性预加载数据获取和渲染接口</li><li>提供安装预加载和周期性预加载数据获取和渲染接口</li></ul> </li></ul> <div class="tiledSection"><h2 id="section86618918715">PrefetchUtil<i class="anchor-icon anchor-icon-link" anchorid="section86618918715" tips="复制节点链接"></i></h2><p>周期性预加载任务注册间隔需要大于12小时，建议按照如下示例取值为24小时。</p> <div _ngcontent-dpg-c106="" class="highlight-div"><div _ngcontent-dpg-c106="" class="highlight-div-header"><div _ngcontent-dpg-c106="" class="highlight-div-header-left"><div _ngcontent-dpg-c106="" class="handle-button expand-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpg-c106="" class="highlight-div-header-right"><div _ngcontent-dpg-c106="" class="handle-button ai-button"></div><div _ngcontent-dpg-c106="" class="handle-button line-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpg-c106="" class="handle-button theme-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpg-c106="" class="handle-button copy-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { cloudResPrefetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CloudFoundationKit'</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PreferenceUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/PreferenceUtil'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">GlobalContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/GlobalContext'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span> = <span class="hljs-string">'defaultStore'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFERENCES_PREFETCH_FIRST_REGISTER_TIME</span> = <span class="hljs-string">'prefetchTaskFirstRegisterTime'</span>; <span class="hljs-comment">// 首次注册时间</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFERENCES_PREFETCH_TASK_EXPIRE_TIME</span> = <span class="hljs-string">'prefetchTaskExpireTime'</span>; <span class="hljs-comment">// 任务过期时间</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFETCH_TASK_REGISTER_INTERVAL</span> = <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 24h &lt; 72h</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFETCH_DATA_UPDATE_INTERVAL</span> = <span class="hljs-number">12</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 12h</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HILOG_DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'Prefetch'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefetchUtil</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">timeoutId</span>: <span class="hljs-built_in">number</span> = (<span class="hljs-number">0</span> - <span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_VALUE</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">hasPrefetchedData</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">isPrefetchTaskRegistered</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">now</span>: <span class="hljs-built_in">number</span> = (<span class="hljs-number">0</span> - <span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_VALUE</span>);</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 预加载数据获取</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type 安装预加载/周期预加载数据</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> 预加载getPrefetchResult API异常</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">PrefetchResult</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPrefetchResult</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: cloudResPrefetch.PrefetchMode</span>) {</li><li>    <span class="hljs-keyword">return</span> cloudResPrefetch.<span class="hljs-title function_">getPrefetchResult</span>(<span class="hljs-keyword">type</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 周期性预加载应用注册任务，间隔24h</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> token 应用/用户级token，可以取空</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> params 自定义筛选参数，定义为json格式，可以取空</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> forceRegister 是否强制注册</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerPrefetchTask</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span>, params: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>,</span></li><li><span class="hljs-params">    forceRegister: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">updatePrefetchTaskInfo</span>();</li><li>    <span class="hljs-keyword">if</span> (!forceRegister) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">registerPrefetchTaskNotForced</span>(token, params);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">registerPrefetchTaskForced</span>(token, params);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 是否有周期性预加载数据：首次注册12h后才有周期性预加载数据</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">boolean</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">hasPrefetchTaskData</span>() : <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">hasPrefetchedData</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">updatePrefetchTaskInfo</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span> != <span class="hljs-number">0</span> - <span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_VALUE</span>) {</li><li>      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span>);</li><li>    }</li><li>    <span class="hljs-keyword">let</span> firstRegisterTime = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getValue</span>(<span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>(), <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>,</li><li>      <span class="hljs-variable constant_">PREFERENCES_PREFETCH_FIRST_REGISTER_TIME</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-keyword">if</span> (firstRegisterTime) {</li><li>      <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">isPrefetchTaskRegistered</span> = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-comment">// 判断任务是否已获取数据(首次注册后12h，之后数据每隔12h更新一次)</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span> - firstRegisterTime &gt;= <span class="hljs-variable constant_">PREFETCH_DATA_UPDATE_INTERVAL</span>) {</li><li>        <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">hasPrefetchedData</span> = <span class="hljs-literal">true</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">isPrefetchTaskRegistered</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`first register time: <span class="hljs-subst">${PrefetchUtil.now}</span>`</span>);</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">setValue</span>(<span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>(), <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>,</li><li>        <span class="hljs-variable constant_">PREFERENCES_PREFETCH_FIRST_REGISTER_TIME</span>, <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerPrefetchTaskForced</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span>, params: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span></span>) {</li><li>    <span class="hljs-comment">// 过期或强制更新任务注册</span></li><li>    <span class="hljs-keyword">let</span> expireTime = <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span> + <span class="hljs-variable constant_">PREFETCH_TASK_REGISTER_INTERVAL</span>;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`new expireTime: <span class="hljs-subst">${expireTime}</span>`</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">setValue</span>(<span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>(), <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>,</li><li>      <span class="hljs-variable constant_">PREFERENCES_PREFETCH_TASK_EXPIRE_TIME</span>, expireTime);</li><li>    <span class="hljs-comment">// 更新任务注册和定时器</span></li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">registerPrefetchTaskWithApi</span>(token, params);</li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">updateTaskTimer</span>(<span class="hljs-variable constant_">PREFETCH_TASK_REGISTER_INTERVAL</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerPrefetchTaskNotForced</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span>, params: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span></span>) {</li><li>    <span class="hljs-comment">// 判断任务到期，重新注册</span></li><li>    <span class="hljs-keyword">let</span> expireTime = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getValue</span>(<span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>(), <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>,</li><li>      <span class="hljs-variable constant_">PREFERENCES_PREFETCH_TASK_EXPIRE_TIME</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-keyword">if</span> (expireTime &amp;&amp; (<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span> &lt; expireTime)) {</li><li>      <span class="hljs-comment">// 任务没有过期：只更新定时器</span></li><li>      <span class="hljs-keyword">let</span> delay = expireTime - <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">now</span>;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`not expire, delay:<span class="hljs-subst">${delay}</span>`</span>);</li><li>      <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">updateTaskTimer</span>(delay);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">registerPrefetchTaskForced</span>(token, params);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">registerPrefetchTaskWithApi</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span>, params: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      cloudResPrefetch.<span class="hljs-title function_">registerPrefetchTask</span>({</li><li>        <span class="hljs-attr">token</span>: token,</li><li>        <span class="hljs-attr">params</span>: params</li><li>      });</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`register success`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`register catch = <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">updateTaskTimer</span>(<span class="hljs-params">delay: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span> != (<span class="hljs-number">0</span> - <span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_VALUE</span>)) {</li><li>        <span class="hljs-built_in">clearInterval</span>(<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span>)</li><li>        <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-property">timeoutId</span> = (<span class="hljs-number">0</span> - <span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_VALUE</span>);</li><li>      }</li><li>    }, delay);</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section1192871813236">PrefetchWrapper<i class="anchor-icon anchor-icon-link" anchorid="section1192871813236" tips="复制节点链接"></i></h2><ul><li>预加载数据获取成功时，需要增加页面的渲染逻辑。</li><li>预加载数据获取失败时，需要做数据降级处理。如下示例代码以cloudFunctionCall接口触发云函数为例获取数据，请根据实际业务实现进行修改。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>使用cloudFunctionCall接口之前，请先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cloudfoundation-call-function#section197479161807">设置云函数配置项</a>。</li><li>测试周期性预加载时，需要将下文示例代码periodicPrefetch方法中的如下代码块注释。若不注释，则需等待12h才能获取周期性预加载数据。<div _ngcontent-dpg-c106="" class="highlight-div"><div _ngcontent-dpg-c106="" class="highlight-div-header"><div _ngcontent-dpg-c106="" class="highlight-div-header-left"><div _ngcontent-dpg-c106="" class="handle-button expand-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpg-c106="" class="highlight-div-header-right"><div _ngcontent-dpg-c106="" class="handle-button ai-button"></div><div _ngcontent-dpg-c106="" class="handle-button line-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpg-c106="" class="handle-button theme-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpg-c106="" class="handle-button copy-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">hasPrefetchTaskData</span>()) { <span class="hljs-comment">// 是否有周期性预加载数据：首次注册12h后才有周期性预加载数据</span></li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'not has prefetch data'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cloudFunctionCall</span>(); <span class="hljs-comment">// 使用普通方式获取应用数据</span></li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> <p>测试完成后，取消上述代码块注释即可。</p> </li></ul> </div></div></div> </li></ul> <div _ngcontent-dpg-c106="" class="highlight-div"><div _ngcontent-dpg-c106="" class="highlight-div-header"><div _ngcontent-dpg-c106="" class="highlight-div-header-left"><div _ngcontent-dpg-c106="" class="handle-button expand-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpg-c106="" class="highlight-div-header-right"><div _ngcontent-dpg-c106="" class="handle-button ai-button"></div><div _ngcontent-dpg-c106="" class="handle-button line-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpg-c106="" class="handle-button theme-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpg-c106="" class="handle-button copy-button"><div _ngcontent-dpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpg-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { cloudFunction, cloudResPrefetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CloudFoundationKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrefetchUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./PrefetchUtil'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PreferenceUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/PreferenceUtil'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">GlobalContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/GlobalContext'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HILOG_DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PrefetchWrapper'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFETCH_MODE</span> = <span class="hljs-string">"prefetchMode"</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span> = <span class="hljs-string">'defaultStore'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefetchWrapper</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PrefetchWrapper</span>;</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PrefetchWrapper</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PrefetchWrapper</span>.<span class="hljs-property">instance</span>) {</li><li>      <span class="hljs-title class_">PrefetchWrapper</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrefetchWrapper</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PrefetchWrapper</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 支持安装预加载和周期性预加载（推荐）</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">doPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>();</li><li>    <span class="hljs-keyword">let</span> prefetchMode =</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getValueSync</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-keyword">if</span> (!prefetchMode) {</li><li>      <span class="hljs-comment">// 应用安装后首次打开：使用安装预加载</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'installPrefetch'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">installPrefetch</span>();</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">setValue</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>,</li><li>        cloudResPrefetch.<span class="hljs-property">PrefetchMode</span>.<span class="hljs-property">PERIODIC_PREFETCH</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 应用安装后非首次打开：使用周期性预加载</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'periodicPrefetch: %{public}d'</span>, prefetchMode);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">periodicPrefetch</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 仅支持安装预加载</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">doInstallPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>();</li><li>    <span class="hljs-keyword">let</span> prefetchMode =</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getValueSync</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-keyword">if</span> (!prefetchMode) {</li><li>      <span class="hljs-comment">// 应用安装后首次打开：使用安装预加载</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'installPrefetch'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">installPrefetch</span>();</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">setValue</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>,</li><li>        cloudResPrefetch.<span class="hljs-property">PrefetchMode</span>.<span class="hljs-property">PERIODIC_PREFETCH</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 仅支持周期性预加载</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">doPeriodicPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> context = <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getContext</span>();</li><li>    <span class="hljs-keyword">let</span> prefetchMode =</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getValueSync</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-keyword">if</span> (!prefetchMode) {</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">setValue</span>(context, <span class="hljs-variable constant_">PREFERENCES_PREFETCH_STORE_NAME</span>, <span class="hljs-variable constant_">PREFETCH_MODE</span>,</li><li>        cloudResPrefetch.<span class="hljs-property">PrefetchMode</span>.<span class="hljs-property">PERIODIC_PREFETCH</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// 应用安装后非首次打开：使用周期性预加载</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'periodicPrefetch: %{public}d'</span>, prefetchMode);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">periodicPrefetch</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">installPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">getPrefetchResult</span>(cloudResPrefetch.<span class="hljs-property">PrefetchMode</span>.<span class="hljs-property">INSTALL_PREFETCH</span>)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: cloudResPrefetch.PrefetchResult</span>) =&gt;</span> { <span class="hljs-comment">// 接口调用成功处理缓存的应用数据</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get install prefetch cache successfully'</span>);</li><li>        <span class="hljs-keyword">let</span> dataResult = data.<span class="hljs-property">result</span>; <span class="hljs-comment">// data.result即是缓存的应用数据</span></li><li>        <span class="hljs-comment">// todo 处理dataResult</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get install prefetch dataResult: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataResult));</li><li>      })</li><li>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`get install prefetch cache failed: <span class="hljs-subst">${err.message}</span>, <span class="hljs-subst">${err.code}</span>`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cloudFunctionCall</span>(); <span class="hljs-comment">// 应用走原有逻辑获取数据，示例使用云函数获取</span></li><li>      })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">initPeriodPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> token = <span class="hljs-string">''</span>; <span class="hljs-comment">// 应用自定义token参数，一般是鉴权参数，云侧云函数开发时提取鉴权，不鉴权，可以为空</span></li><li>    <span class="hljs-keyword">let</span> params = <span class="hljs-string">''</span>; <span class="hljs-comment">// 应用自定义params参数，一般是筛选参数，可以定义成json格式，云侧云函数开发是提取进行筛选，不需要，可以为空</span></li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">registerPrefetchTask</span>(token, params);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">periodicPrefetch</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initPeriodPrefetch</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">hasPrefetchTaskData</span>()) { <span class="hljs-comment">// 是否有周期性预加载数据：首次注册12h后才有周期性预加载数据</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'not has prefetch data'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cloudFunctionCall</span>(); <span class="hljs-comment">// 使用普通方式获取应用数据</span></li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">PrefetchUtil</span>.<span class="hljs-title function_">getPrefetchResult</span>(cloudResPrefetch.<span class="hljs-property">PrefetchMode</span>.<span class="hljs-property">PERIODIC_PREFETCH</span>)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: cloudResPrefetch.PrefetchResult</span>) =&gt;</span> { <span class="hljs-comment">// 接口调用成功处理缓存的应用数据</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get periodic prefetch cache successfully'</span>);</li><li>        <span class="hljs-keyword">let</span> dataResult = data.<span class="hljs-property">result</span>; <span class="hljs-comment">// data.result即是缓存的应用数据</span></li><li>        <span class="hljs-keyword">let</span> timestamp = data.<span class="hljs-property">timestamp</span>; <span class="hljs-comment">// data.timestamp即是缓存拉取时间</span></li><li>        <span class="hljs-keyword">let</span> token = data.<span class="hljs-property">token</span>; <span class="hljs-comment">// data.token即是注册任务token</span></li><li>        <span class="hljs-comment">// todo 处理dataResult</span></li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get periodic prefetch dataResult: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataResult));</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get periodic prefetch timestamp: %{public}s'</span>, timestamp.<span class="hljs-title function_">toString</span>());</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'get periodic prefetch token: %{public}s'</span>, token)</li><li>      })</li><li>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`get periodic prefetch cache failed: <span class="hljs-subst">${err.message}</span>, <span class="hljs-subst">${err.code}</span>`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cloudFunctionCall</span>(); <span class="hljs-comment">// 应用走原有逻辑获取数据，示例使用云函数获取</span></li><li>      })</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">cloudFunctionCall</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'cloudFunctionCall start'</span>);</li><li>    cloudFunction.<span class="hljs-title function_">call</span>({</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">"function_name"</span>,  <span class="hljs-comment">// 需修改为实际的云函数名称</span></li><li>      <span class="hljs-attr">timeout</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1000</span></li><li>    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: cloudFunction.FunctionResult</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'call function successfully'</span>);</li><li>      <span class="hljs-keyword">let</span> dataResult = data.<span class="hljs-property">result</span>; <span class="hljs-comment">// data.result即是缓存的应用数据</span></li><li>      <span class="hljs-comment">// todo 处理dataResult</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'call function get: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataResult));</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">HILOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'call function failed: %{public}s'</span>, err.<span class="hljs-property">message</span>);</li><li>    })</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>