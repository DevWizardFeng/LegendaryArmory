<h1 _ngcontent-akf-c119="" class="doc-title ng-star-inserted" title="预加载工具类"> 预加载工具类 </h1>

<div _ngcontent-akf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>在“entry/src/main/ets/common”目录下新增GlobalContext.ets和PreferenceUtil.ets。</p> <div class="tiledSection"><h2 id="section6771830191211">GlobalContext<i class="anchor-icon anchor-icon-link" anchorid="section6771830191211" tips="复制节点链接"></i></h2><p>全局上下文类，提供全局上下文句柄的初始化和获取功能。参考示例如下：</p> <div _ngcontent-akf-c106="" class="highlight-div"><div _ngcontent-akf-c106="" class="highlight-div-header"><div _ngcontent-akf-c106="" class="highlight-div-header-left"><div _ngcontent-akf-c106="" class="handle-button expand-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-akf-c106="" class="highlight-div-header-right"><div _ngcontent-akf-c106="" class="handle-button ai-button"></div><div _ngcontent-akf-c106="" class="handle-button line-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-akf-c106="" class="handle-button theme-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-akf-c106="" class="handle-button copy-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-akf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalContext</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">initContext</span>(<span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-property">context</span> = context;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getContext</span>(): common.<span class="hljs-property">UIAbilityContext</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-property">context</span>;</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section3897195310184">PreferenceUtil<i class="anchor-icon anchor-icon-link" anchorid="section3897195310184" tips="复制节点链接"></i></h2><p>首选项工具类，提供数据读取和存储功能。参考示例如下：</p> <div _ngcontent-akf-c106="" class="highlight-div"><div _ngcontent-akf-c106="" class="highlight-div-header"><div _ngcontent-akf-c106="" class="highlight-div-header-left"><div _ngcontent-akf-c106="" class="handle-button expand-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-akf-c106="" class="highlight-div-header-right"><div _ngcontent-akf-c106="" class="handle-button ai-button"></div><div _ngcontent-akf-c106="" class="handle-button line-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-akf-c106="" class="handle-button theme-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-akf-c106="" class="handle-button copy-button"><div _ngcontent-akf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-akf-c106="" class="highlight-scroll-div"><pre class="typescript prettyprint linenums hljs language-typescript" hw-language="typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> dataPreferences <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.data.preferences'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'PreferenceUtil'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">DEFAULT_STORE_NAME</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"prefetchDefaultStore"</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreferenceUtil</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">cachedPreferences</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, dataPreferences.<span class="hljs-property">Preferences</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>,</li><li>    <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;dataPreferences.<span class="hljs-property">ValueType</span> | <span class="hljs-literal">null</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> store = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getStore</span>(context, storeName);</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">updateStoreCache</span>(storeName, store);</li><li>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">get</span>(key, <span class="hljs-string">''</span>);    </li><li>      <span class="hljs-keyword">return</span> result;</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`getValue from <span class="hljs-subst">${storeName}</span> error, key:<span class="hljs-subst">${key}</span>, err:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getValueSync</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): dataPreferences.<span class="hljs-property">ValueType</span> | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> store = <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getStoreSync</span>(context, storeName);</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">updateStoreCache</span>(storeName, store);</li><li>      <span class="hljs-keyword">const</span> result = store.<span class="hljs-title function_">getSync</span>(key, <span class="hljs-string">''</span>);</li><li>      <span class="hljs-keyword">return</span> result;</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`getValueSync from <span class="hljs-subst">${storeName}</span> error, key:<span class="hljs-subst">${key}</span>, err:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>,</li><li>    <span class="hljs-attr">value</span>: dataPreferences.<span class="hljs-property">ValueType</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">try</span> {      </li><li>      <span class="hljs-keyword">let</span> store = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">getStore</span>(context, storeName);</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-title function_">updateStoreCache</span>(storeName, store);</li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">put</span>(key, value);</li><li>      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">flush</span>();</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`putValue from <span class="hljs-subst">${storeName}</span> error, key:<span class="hljs-subst">${key}</span>, err:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getStore</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;dataPreferences.<span class="hljs-property">Preferences</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> actualStoreName = !storeName ? <span class="hljs-variable constant_">DEFAULT_STORE_NAME</span> : storeName;</li><li>    <span class="hljs-keyword">let</span> store = <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-property">cachedPreferences</span>.<span class="hljs-title function_">get</span>(actualStoreName);</li><li>    <span class="hljs-keyword">if</span> (store) {</li><li>      <span class="hljs-keyword">return</span> store;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`there is no cached store:<span class="hljs-subst">${actualStoreName}</span>, begin to get one`</span>);</li><li>    <span class="hljs-keyword">return</span> dataPreferences.<span class="hljs-title function_">getPreferences</span>(context, actualStoreName);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getStoreSync</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>): dataPreferences.<span class="hljs-property">Preferences</span> {</li><li>    <span class="hljs-keyword">let</span> actualStoreName = !storeName ? <span class="hljs-variable constant_">DEFAULT_STORE_NAME</span> : storeName;</li><li>    <span class="hljs-keyword">let</span> store = <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-property">cachedPreferences</span>.<span class="hljs-title function_">get</span>(actualStoreName);</li><li>    <span class="hljs-keyword">if</span> (store) {</li><li>      <span class="hljs-keyword">return</span> store;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getStoreSync there is no cached store:<span class="hljs-subst">${actualStoreName}</span>, begin to get one`</span>);</li><li>    <span class="hljs-keyword">return</span> dataPreferences.<span class="hljs-title function_">getPreferencesSync</span>(context, { <span class="hljs-attr">name</span>: actualStoreName });</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">updateStoreCache</span>(<span class="hljs-attr">storeName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">store</span>: dataPreferences.<span class="hljs-property">Preferences</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-property">cachedPreferences</span>.<span class="hljs-title function_">has</span>(storeName)) {</li><li>      <span class="hljs-title class_">PreferenceUtil</span>.<span class="hljs-property">cachedPreferences</span>.<span class="hljs-title function_">set</span>(storeName, store);</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> </div> </div> <div></div></div>