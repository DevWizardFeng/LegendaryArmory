<h1 _ngcontent-boj-c119="" class="doc-title ng-star-inserted" title="预览(ArkTS)"> 预览(ArkTS) </h1>

<div _ngcontent-boj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>在开发相机应用时，需要先<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation">申请相关权限</a>。</p>    <p>预览是启动相机后看见的画面，通常在拍照和录像前执行。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入camera接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre></div></div></li>      <li>       <p>创建Surface。</p>       <p>相机开发模型为Surface模型，该模型主要通过Surface实现数据交互。在开发相机应用界面时，首先需要通过创建XComponent组件为预览流提供Surface，再通过获取XComponent组件对应Surface的ID创建预览流，预览流画面即可直接在XComponent组件内渲染，详细获取surfaceId请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#getxcomponentsurfaceid9" target="_blank">getXComponentSurfaceId</a>方法。而XComponent的能力由UI提供，相关介绍可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent组件参考</a>。</p>       <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">         <p>预览流与录像输出流的分辨率的宽高比要保持一致，如果设置XComponent组件中的Surface显示区域宽高比为1920:1080 = 16:9，则需要预览流中的分辨率的宽高比也为16:9，如分辨率选择640:360，或960:540，或1920:1080，以此类推。</p>        </div></div></div>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct example {</li><li>  <span class="hljs-attr">xComponentCtl</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-attr">surfaceId</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">XComponent</span>({</li><li>      <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>      <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>      <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span></li><li>    })</li><li>      .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>(); <span class="hljs-comment">// 获取组件surfaceId。</span></li><li>        <span class="hljs-comment">// 使用surfaceId创建预览流，开启相机，组件实时渲染每帧预览流数据。</span></li><li>      })</li><li>      <span class="hljs-comment">// surface的宽、高设置与XComponent组件的宽、高设置相反，或使用.renderFit(RenderFit.RESIZE_CONTAIN)自动填充显示无需设置宽、高。</span></li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>))</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>))</li><li>  }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameraoutputcapability" target="_blank">CameraOutputCapability</a>中的previewProfiles属性获取当前设备支持的预览能力，返回previewProfilesArray数组 。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">createPreviewOutput</a>方法创建预览输出流，其中，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">createPreviewOutput</a>方法中的两个参数分别是当前设备支持的预览配置信息previewProfile和步骤二中获取的surfaceId。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPreviewOutput</span>(<span class="hljs-params">cameraManager: camera.CameraManager, cameraOutputCapability: camera.CameraOutputCapability, surfaceId: <span class="hljs-built_in">string</span></span>): camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">if</span> (!cameraOutputCapability || !cameraOutputCapability.<span class="hljs-property">previewProfiles</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfilesArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">Profile</span>&gt; = cameraOutputCapability.<span class="hljs-property">previewProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (!previewProfilesArray || previewProfilesArray.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"previewProfilesArray is null or []"</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">previewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">//previewProfilesArray要选择与步骤二设置宽高比一致的previewProfile配置信息，此处选择数组第一项仅供接口使用示例参考。</span></li><li>    previewOutput = cameraManager.<span class="hljs-title function_">createPreviewOutput</span>(previewProfilesArray[<span class="hljs-number">0</span>], surfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to create the PreviewOutput instance. error code: "</span> + err.<span class="hljs-property">code</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> previewOutput;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使能。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#start11" target="_blank">Session.start</a>方法输出预览流，接口调用失败会返回相应错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraerrorcode" target="_blank">Camera错误码</a>。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startPreviewOutput</span>(<span class="hljs-params">cameraManager: camera.CameraManager, previewOutput: camera.PreviewOutput</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraArray</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = [];</li><li>    cameraArray = cameraManager.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>    <span class="hljs-keyword">if</span> (cameraArray.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'no camera.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 获取支持的模式类型。</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">sceneModes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">SceneMode</span>&gt; = cameraManager.<span class="hljs-title function_">getSupportedSceneModes</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupportPhotoMode</span>: <span class="hljs-built_in">boolean</span> = sceneModes.<span class="hljs-title function_">indexOf</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>) &gt;= <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (!isSupportPhotoMode) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'photo mode not support'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span>;</li><li>    cameraInput = cameraManager.<span class="hljs-title function_">createCameraInput</span>(cameraArray[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">if</span> (cameraInput === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'cameraInput is undefined'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 打开相机。</span></li><li>    <span class="hljs-keyword">await</span> cameraInput.<span class="hljs-title function_">open</span>();</li><li>    <span class="hljs-keyword">let</span> session = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>);</li><li>    <span class="hljs-keyword">if</span> (!session) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'session is null'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">photoSession</span>: camera.<span class="hljs-property">PhotoSession</span> = session <span class="hljs-keyword">as</span> camera.<span class="hljs-property">PhotoSession</span>;</li><li>    photoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>    photoSession.<span class="hljs-title function_">addInput</span>(cameraInput);</li><li>    photoSession.<span class="hljs-title function_">addOutput</span>(previewOutput);</li><li>    <span class="hljs-keyword">await</span> photoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>    <span class="hljs-keyword">await</span> photoSession.<span class="hljs-title function_">start</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`startPreviewOutput call failed, error: <span class="hljs-subst">${error}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2>          <p>在相机应用开发过程中，可以随时监听预览输出流状态，包括预览流启动、预览流结束、预览流输出错误。</p>     <ul>      <li>       <p>通过注册固定的frameStart回调函数获取监听预览启动结果，previewOutput创建成功时即可监听，预览第一次曝光时触发，有该事件返回结果则认为预览流已启动。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onPreviewOutputFrameStart</span>(<span class="hljs-params">previewOutput: camera.PreviewOutput</span>): <span class="hljs-built_in">void</span> {</li><li>  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameStart'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Preview frame started'</span>);</li><li>  });</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的frameEnd回调函数获取监听预览结束结果，previewOutput创建成功时即可监听，预览完成最后一帧时触发，有该事件返回结果则认为预览流已结束。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onPreviewOutputFrameEnd</span>(<span class="hljs-params">previewOutput: camera.PreviewOutput</span>): <span class="hljs-built_in">void</span> {</li><li>  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameEnd'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Preview frame ended'</span>);</li><li>  });</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的error回调函数获取监听预览输出错误结果，回调返回预览输出接口使用错误时对应的错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraerrorcode" target="_blank">Camera错误码</a>。</p>       <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">onPreviewOutputError</span>(<span class="hljs-params">previewOutput: camera.PreviewOutput</span>): <span class="hljs-built_in">void</span> {</li><li>  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">previewOutputError: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Preview output error code: <span class="hljs-subst">${previewOutputError.code}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>    <div class="tiledSection">     <h2 id="完整示例">完整示例<i class="anchor-icon anchor-icon-link" anchorid="完整示例" tips="复制节点链接"></i></h2>          <div _ngcontent-boj-c106="" class="highlight-div"><div _ngcontent-boj-c106="" class="highlight-div-header"><div _ngcontent-boj-c106="" class="highlight-div-header-left"><div _ngcontent-boj-c106="" class="handle-button expand-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-boj-c106="" class="highlight-div-header-right"><div _ngcontent-boj-c106="" class="handle-button ai-button"></div><div _ngcontent-boj-c106="" class="handle-button line-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-boj-c106="" class="handle-button theme-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-boj-c106="" class="handle-button copy-button"><div _ngcontent-boj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-boj-c106="" class="highlight-scroll-div"><pre class="ts prettyprint linenums hljs language-typescript" hw-language="ts" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { camera } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CameraKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponentCtl</span>: <span class="hljs-title class_">XComponentController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XComponentController</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">xComponentSurfaceId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1920</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraManager</span>: camera.<span class="hljs-property">CameraManager</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameras</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; | <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">CameraDevice</span>&gt; = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraInput</span>: camera.<span class="hljs-property">CameraInput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">previewOutput</span>: camera.<span class="hljs-property">PreviewOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">session</span>: camera.<span class="hljs-property">VideoSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getHostContext</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">cameraPermission</span>: <span class="hljs-title class_">Permissions</span> = <span class="hljs-string">'ohos.permission.CAMERA'</span>; <span class="hljs-comment">// 申请权限相关问题可参考本篇开头的申请相关权限文档</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestPermissionsFn</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, [<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>]);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; res.<span class="hljs-property">permissions</span>.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPermission</span>.<span class="hljs-title function_">toString</span>() === res.<span class="hljs-property">permissions</span>[i] &amp;&amp; res.<span class="hljs-property">authResults</span>[i] === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = <span class="hljs-literal">true</span>;</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissionsFn</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageShow</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPageShow'</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span> !== <span class="hljs-string">''</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onPageHide</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onPageHide'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>        <span class="hljs-title class_">XComponent</span>({</li><li>          <span class="hljs-attr">id</span>: <span class="hljs-string">'componentId'</span>,</li><li>          <span class="hljs-attr">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-property">SURFACE</span>,</li><li>          <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span></li><li>        })</li><li>          .<span class="hljs-title function_">onLoad</span>(<span class="hljs-keyword">async</span> () =&gt; {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onLoad is called'</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentCtl</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>(); <span class="hljs-comment">// 获取组件surfaceId。</span></li><li>            <span class="hljs-comment">// 初始化相机，组件实时渲染每帧预览流数据。</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCamera</span>()</li><li>          })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>))</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>))</li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// 初始化相机。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initCamera previewOutput xComponentSurfaceId:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.xComponentSurfaceId}</span>`</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// 获取相机管理器实例。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span> = camera.<span class="hljs-title function_">getCameraManager</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera getCameraManager'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 获取当前设备支持的相机device列表。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera getSupportedCameras'</span>);</li><li>      }</li><li>      <span class="hljs-comment">// 选择一个相机device，创建cameraInput输出对象。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createCameraInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>[<span class="hljs-number">0</span>]);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera createCameraInput'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 打开相机。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>.<span class="hljs-title function_">open</span>();</li><li>      <span class="hljs-comment">// 获取相机device支持的profile。</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">capability</span>: camera.<span class="hljs-property">CameraOutputCapability</span> =</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">getSupportedOutputCapability</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameras</span>[<span class="hljs-number">0</span>], camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>      <span class="hljs-keyword">if</span> (!capability || capability.<span class="hljs-property">previewProfiles</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'capability is null || []'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> minRatioDiff : <span class="hljs-built_in">number</span> = <span class="hljs-number">0.1</span>;</li><li>      <span class="hljs-keyword">let</span> surfaceRatio : <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>; <span class="hljs-comment">// 最接近16:9宽高比。</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: camera.<span class="hljs-property">Profile</span> = capability.<span class="hljs-property">previewProfiles</span>[<span class="hljs-number">0</span>];</li><li>      <span class="hljs-comment">// 应用开发者根据实际业务需求选择一个支持的预览流previewProfile。</span></li><li>      <span class="hljs-comment">// 此处以选择CAMERA_FORMAT_YUV_420_SP（NV21）格式、满足限定条件分辨率的预览流previewProfile为例。</span></li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; capability.<span class="hljs-property">previewProfiles</span>.<span class="hljs-property">length</span>; index++) {</li><li>        <span class="hljs-keyword">const</span> tempProfile = capability.<span class="hljs-property">previewProfiles</span>[index];</li><li>        <span class="hljs-keyword">let</span> tempRatio = tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> &gt;= tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> ?</li><li>          tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> : tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> / tempProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>        <span class="hljs-keyword">let</span> currentRatio = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(tempRatio - surfaceRatio);</li><li>        <span class="hljs-keyword">if</span> (currentRatio &lt;= minRatioDiff &amp;&amp; tempProfile.<span class="hljs-property">format</span> == camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YUV_420_SP</span>) {</li><li>          previewProfile = tempProfile;</li><li>          <span class="hljs-keyword">break</span>;</li><li>        }</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> = previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>; <span class="hljs-comment">// 更新xComponent组件的宽。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span> = previewProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>; <span class="hljs-comment">// 更新xComponent组件的高。</span></li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`initCamera imageWidth:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageWidth}</span> imageHeight:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.imageHeight}</span>`</span>);</li><li>
</li><li>      <span class="hljs-comment">// 使用xComponentSurfaceId创建预览。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentSurfaceId</span>);</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span>) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'initCamera createPreviewOutput'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// 创建录像模式相机会话。</span></li><li>      <span class="hljs-keyword">let</span> session = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>      <span class="hljs-keyword">if</span> (!session) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'session is null'</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span> = session <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>      <span class="hljs-comment">// 开始配置会话。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">beginConfig</span>();</li><li>      <span class="hljs-comment">// 添加相机设备输入。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addInput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>);</li><li>      <span class="hljs-comment">// 添加预览流输出。</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">addOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span>);</li><li>      <span class="hljs-comment">// 提交会话配置。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">commitConfig</span>();</li><li>      <span class="hljs-comment">// 开始启动已配置的输入输出流。</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`initCamera fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">releaseCamera</span>();</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 释放相机。</span></li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseCamera</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'releaseCamera'</span>);</li><li>    <span class="hljs-comment">// 停止当前会话。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">stop</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to stop session: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放相机输入流。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>?.<span class="hljs-title function_">close</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to close the camera: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放预览输出流。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewOutput</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to stop the preview stream: '</span>, e)});</li><li>    <span class="hljs-comment">// 释放会话。</span></li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to release session: '</span>, e)});</li><li>  }</li><li>}</li></ol></pre></div></div>    </div>   </div>   <div></div></div>