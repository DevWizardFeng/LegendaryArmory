<h1 _ngcontent-ske-c119="" class="doc-title ng-star-inserted" title="预览(C/C++)"> 预览(C/C++) </h1>

<div _ngcontent-ske-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>预览是启动相机后看见的画面，通常在拍照和录像前执行。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hilog/log.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/photo_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/video_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libohcamera.so</li><li>    libhilog_ndk.z.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>获取SurfaceId。</p>       <p>XComponent组件为预览流提供的SurfaceId，而XComponent的能力由UI提供，相关介绍可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent组件参考</a>。</p></li>      <li>       <p>根据传入的SurfaceId，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_getsupportedcameraoutputcapability" target="_blank">OH_CameraManager_GetSupportedCameraOutputCapability()</a>方法获取当前设备支持的预览能力。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_createpreviewoutput" target="_blank">OH_CameraManager_CreatePreviewOutput()</a>方法创建预览输出流，其中，OH_CameraManager_CreatePreviewOutput()方法中的参数分别是cameraManager指针，previewProfiles数组中的第一项，步骤三中获取的surfaceId，以及返回的previewOutput指针。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">Camera_PreviewOutput* <span class="hljs-title">CreatePreviewOutput</span><span class="hljs-params">(<span class="hljs-type">char</span>* previewSurfaceIdstr, Camera_Manager* cameraManager,</span></span></li><li><span class="hljs-function">    <span class="hljs-type">const</span> Camera_Profile* previewProfile)</span></li><li><span class="hljs-function"></span>{</li><li>    Camera_PreviewOutput* previewOutput = <span class="hljs-literal">nullptr</span>;</li><li>    Camera_ErrorCode ret = <span class="hljs-built_in">OH_CameraManager_CreatePreviewOutput</span>(cameraManager, previewProfile,</li><li>        previewSurfaceIdstr, &amp;previewOutput);</li><li>    <span class="hljs-keyword">if</span> (previewOutput == <span class="hljs-literal">nullptr</span> || ret != CAMERA_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_CameraManager_CreatePreviewOutput failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> previewOutput;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>使能。当session完成CommitConfig后通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_start" target="_blank">OH_CaptureSession_Start()</a>方法输出预览流，接口调用失败会返回相应错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_errorcode" target="_blank">Camera_ErrorCode</a>。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">SessionStart</span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_Start(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Start failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_stop" target="_blank">OH_CaptureSession_Stop()</a>方法停止预览流，接口调用失败会返回相应错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_errorcode" target="_blank">Camera_ErrorCode</a>。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>Camera_ErrorCode <span class="hljs-title function_">SessionStop</span><span class="hljs-params">(Camera_CaptureSession* captureSession)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_CaptureSession_Stop(captureSession);</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_CaptureSession_Stop failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="状态监听">状态监听<i class="anchor-icon anchor-icon-link" anchorid="状态监听" tips="复制节点链接"></i></h2>          <p>在相机应用开发过程中，可以随时监听预览输出流状态，包括预览流启动、预览流结束、预览流输出错误。</p>     <ul>      <li>       <p>通过注册固定的frameStart回调函数获取监听预览启动结果，previewOutput创建成功时即可监听，预览第一次曝光时触发，有该事件返回结果则认为预览流已启动。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">PreviewOutputOnFrameStart</span>(Camera_PreviewOutput* previewOutput)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "PreviewOutputOnFrameStart");</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的frameEnd回调函数获取监听预览结束结果，previewOutput创建成功时即可监听，预览完成最后一帧时触发，有该事件返回结果则认为预览流已结束。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PreviewOutputOnFrameEnd</span><span class="hljs-params">(Camera_PreviewOutput* previewOutput, <span class="hljs-type">int32_t</span> frameCount)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"PreviewOutput frameCount = %{public}d"</span>, frameCount);</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过注册固定的error回调函数获取监听预览输出错误结果，callback返回预览输出接口使用错误时对应的错误码，错误码类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_errorcode" target="_blank">Camera_ErrorCode</a>。</p>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">PreviewOutputOnError</span>(Camera_PreviewOutput* previewOutput, Camera_ErrorCode errorCode)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, "PreviewOutput errorCode = %{public}d", errorCode);</li><li>}</li></ol></pre></div></div>       <div _ngcontent-ske-c106="" class="highlight-div"><div _ngcontent-ske-c106="" class="highlight-div-header"><div _ngcontent-ske-c106="" class="highlight-div-header-left"><div _ngcontent-ske-c106="" class="handle-button expand-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ske-c106="" class="highlight-div-header-right"><div _ngcontent-ske-c106="" class="handle-button ai-button"></div><div _ngcontent-ske-c106="" class="handle-button line-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ske-c106="" class="handle-button theme-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ske-c106="" class="handle-button copy-button"><div _ngcontent-ske-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ske-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-java" data-highlighted="yes"><ol class="linenums"><li>PreviewOutput_Callbacks* GetPreviewOutputListener(<span class="hljs-keyword">void</span>)</li><li>{</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-type">PreviewOutput_Callbacks</span> <span class="hljs-variable">previewOutputListener</span> <span class="hljs-operator">=</span> {</li><li>        .onFrameStart = PreviewOutputOnFrameStart,</li><li>        .onFrameEnd = PreviewOutputOnFrameEnd,</li><li>        .onError = PreviewOutputOnError</li><li>    };</li><li>    <span class="hljs-keyword">return</span> &amp;previewOutputListener;</li><li>}</li><li>Camera_ErrorCode <span class="hljs-title function_">RegisterPreviewOutputCallback</span><span class="hljs-params">(Camera_PreviewOutput* previewOutput)</span></li><li>{</li><li>    <span class="hljs-type">Camera_ErrorCode</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> OH_PreviewOutput_RegisterCallback(previewOutput, GetPreviewOutputListener());</li><li>    <span class="hljs-keyword">if</span> (ret != CAMERA_OK) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"OH_PreviewOutput_RegisterCallback failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre></div></div></li>     </ul>    </div>   </div>   <div></div></div>