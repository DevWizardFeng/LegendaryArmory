<h1 _ngcontent-evp-c119="" class="doc-title ng-star-inserted" title="预览流二次处理(C/C++)"> 预览流二次处理(C/C++) </h1>

<div _ngcontent-evp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <p>通过ImageReceiver创建预览输出，获取预览流实时数据，以供后续进行图像二次处理，比如应用可以对其添加滤镜算法等。</p>    <div class="tiledSection">     <h2 id="开发步骤">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="开发步骤" tips="复制节点链接"></i></h2>          <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera" target="_blank">Camera API参考</a>。</p>     <ol>      <li>       <p>导入NDK接口，接口中提供了相机相关的属性和方法，导入方法如下。</p>       <div _ngcontent-evp-c106="" class="highlight-div"><div _ngcontent-evp-c106="" class="highlight-div-header"><div _ngcontent-evp-c106="" class="highlight-div-header-left"><div _ngcontent-evp-c106="" class="handle-button expand-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-evp-c106="" class="highlight-div-header-right"><div _ngcontent-evp-c106="" class="handle-button ai-button"></div><div _ngcontent-evp-c106="" class="handle-button line-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-evp-c106="" class="handle-button theme-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-evp-c106="" class="handle-button copy-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-evp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 导入NDK接口头文件。</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;multimedia/image_framework/image/image_receiver_native.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_input.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/capture_session.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/preview_output.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ohcamera/camera_manager.h"</span></span></li></ol></pre></div></div></li>      <li>       <p>在CMake脚本中链接相关动态库。</p>       <div _ngcontent-evp-c106="" class="highlight-div"><div _ngcontent-evp-c106="" class="highlight-div-header"><div _ngcontent-evp-c106="" class="highlight-div-header-left"><div _ngcontent-evp-c106="" class="handle-button expand-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-evp-c106="" class="highlight-div-header-right"><div _ngcontent-evp-c106="" class="handle-button ai-button"></div><div _ngcontent-evp-c106="" class="handle-button line-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-evp-c106="" class="handle-button theme-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-evp-c106="" class="handle-button copy-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-evp-c106="" class="highlight-scroll-div"><pre class="txt prettyprint linenums hljs language-plaintext" hw-language="txt" data-highlighted="yes"><ol class="linenums"><li>target_link_libraries(entry PUBLIC</li><li>    libace_napi.z.so</li><li>    libhilog_ndk.z.so</li><li>    libohimage.so</li><li>    libimage_receiver.so</li><li>    libnative_image.so</li><li>    libohcamera.so</li><li>    libnative_buffer.so</li><li>)</li></ol></pre></div></div></li>      <li>       <p>初始化图片接收器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-receiver-c">ImageReceiver</a>实例，获取SurfaceId。</p>       <p>通过image的OH_ImageReceiverNative_Create方法创建OH_ImageReceiverNative实例，再通过实例的OH_ImageReceiverNative_GetReceivingSurfaceId方法获取SurfaceId。</p>       <div _ngcontent-evp-c106="" class="highlight-div"><div _ngcontent-evp-c106="" class="highlight-div-header"><div _ngcontent-evp-c106="" class="highlight-div-header-left"><div _ngcontent-evp-c106="" class="handle-button expand-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-evp-c106="" class="highlight-div-header-right"><div _ngcontent-evp-c106="" class="handle-button ai-button"></div><div _ngcontent-evp-c106="" class="handle-button line-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-evp-c106="" class="handle-button theme-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-evp-c106="" class="handle-button copy-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-evp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitImageReceiver</span><span class="hljs-params">()</span> </span>{</li><li>    OH_ImageReceiverOptions* options = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 注意捕获错误码处理异常及对象判空，当前示例仅展示调用流程。</span></li><li>    <span class="hljs-comment">// 设置图片参数。</span></li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_Create</span>(&amp;options);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS || options == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverOptions_Create call failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    Image_Size imgSize;</li><li>    imgSize.width = <span class="hljs-number">1080</span>; <span class="hljs-comment">// 创建预览流的宽。</span></li><li>    imgSize.height = <span class="hljs-number">1080</span>; <span class="hljs-comment">// 创建预览流的高。</span></li><li>    <span class="hljs-type">int32_t</span> capacity = <span class="hljs-number">8</span>; <span class="hljs-comment">// BufferQueue里最大Image数量，推荐填写8。</span></li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetSize</span>(options, imgSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverOptions_SetSize call failed"</span>);</li><li>    }</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverOptions_SetCapacity</span>(options, capacity);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverOptions_SetCapacity call failed"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 创建OH_ImageReceiverNative对象。</span></li><li>    OH_ImageReceiverNative* receiver = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_Create</span>(options, &amp;receiver);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS || receiver == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverNative_Create call failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 获取OH_ImageReceiverNative对象的SurfaceId。</span></li><li>    <span class="hljs-type">uint64_t</span> receiverSurfaceID = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageReceiverNative_GetReceivingSurfaceId</span>(receiver, &amp;receiverSurfaceID);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverNative_GetReceivingSurfaceId call failed"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"receiver surfaceID:%{public}lu"</span>, receiverSurfaceID);</li><li>    }</li><li>}</li></ol></pre></div></div></li>      <li>       <p>通过上一步获取到的SurfaceId创建预览流（在创建预览流之前需要将SurfaceId类型转成char *），参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-preview">预览(C/C++)</a>步骤4。</p></li>      <li>       <p>创建会话，使能会话，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-camera-session-management">会话管理(C/C++)</a>。</p></li>      <li>       <p>注册ImageReceiver图片接收器的回调，监听获取每帧上报图像内容。</p>       <div _ngcontent-evp-c106="" class="highlight-div"><div _ngcontent-evp-c106="" class="highlight-div-header"><div _ngcontent-evp-c106="" class="highlight-div-header-left"><div _ngcontent-evp-c106="" class="handle-button expand-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-evp-c106="" class="highlight-div-header-right"><div _ngcontent-evp-c106="" class="handle-button ai-button"></div><div _ngcontent-evp-c106="" class="handle-button line-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-evp-c106="" class="handle-button theme-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-evp-c106="" class="handle-button copy-button"><div _ngcontent-evp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-evp-c106="" class="highlight-scroll-div"><pre class="prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>OH_ImageReceiverNative* receiver; <span class="hljs-comment">// 步骤3创建的实例。</span></li><li>
</li><li><span class="hljs-comment">// 图像回调函数，参考媒体/Image Kit（图片处理服务）。</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnCallback</span><span class="hljs-params">(OH_ImageReceiverNative* receiver)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (receiver == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"receiver is nullptr."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest buffer available."</span>);</li><li>    <span class="hljs-comment">// 注意捕获错误码处理异常及对象判空，当前示例仅展示调用流程。</span></li><li>    OH_ImageNative* image = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// 从bufferQueue中获取图像。</span></li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverNative_ReadNextImage</span>(receiver, &amp;image);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS || image == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageReceiverNative_ReadNextImage call failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 读取图像宽高。</span></li><li>    Image_Size size;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetImageSize</span>(image, &amp;size);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetImageSize call failed."</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetImageSize errCode:%{public}d width:%{public}d height:%{public}d"</span>, errCode,</li><li>        size.width, size.height);</li><li>
</li><li>    <span class="hljs-comment">// 获取图像ComponentType。</span></li><li>    <span class="hljs-type">size_t</span> typeSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">uint32_t</span>* types = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">uint32_t</span>[typeSize];</li><li>    <span class="hljs-keyword">if</span> (!types) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Failed to allocate memory"</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    errCode =  <span class="hljs-built_in">OH_ImageNative_GetComponentTypes</span>(image, &amp;types, &amp;typeSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS || typeSize == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"typeSize is 0"</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">delete</span>[] types;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">uint32_t</span> component = types[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-comment">// 获取图像buffer。</span></li><li>    OH_NativeBuffer* imageBuffer = <span class="hljs-literal">nullptr</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetByteBuffer</span>(image, component, &amp;imageBuffer);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetByteBuffer call failed."</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">delete</span>[] types;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">size_t</span> bufferSize = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetBufferSize</span>(image, component, &amp;bufferSize);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetBufferSize call failed."</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">delete</span>[] types;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest buffer component: %{public}d size:%{public}zu"</span>, component, bufferSize);</li><li>    <span class="hljs-comment">// 获取图像行距。</span></li><li>    <span class="hljs-type">int32_t</span> stride = <span class="hljs-number">0</span>;</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_GetRowStride</span>(image, component, &amp;stride);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_GetRowStride call failed."</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">delete</span>[] types;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ImageReceiverNativeCTest buffer stride：%{public}d."</span>, stride);</li><li>    <span class="hljs-type">void</span>* srcVir = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">int32_t</span> retCode = <span class="hljs-built_in">OH_NativeBuffer_Map</span>(imageBuffer, &amp;srcVir);</li><li>    <span class="hljs-keyword">if</span> (retCode != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_NativeBuffer_Map call failed."</span>);</li><li>        <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>        <span class="hljs-keyword">delete</span>[] types;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-type">uint8_t</span>* srcBuffer = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint8_t</span>*&gt;(srcVir);</li><li>    <span class="hljs-comment">// 判断行距与预览流宽是否一致，如不一致，需要考虑stride对读取buffer的影响。</span></li><li>    <span class="hljs-keyword">if</span> (stride == size.width) {</li><li>        <span class="hljs-comment">// 传给其他不需要stride的接口处理。</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// 传给其他支持stride的接口处理，或去除stride数据。</span></li><li>        <span class="hljs-comment">// 去除stride数据示例:将byteBuffer中的数据去除stride，拷贝得到新的dstBuffer数据。</span></li><li>        <span class="hljs-type">size_t</span> dstBufferSize = size.width * size.height * <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 相机预览流返回NV21格式。</span></li><li>        std::unique_ptr&lt;<span class="hljs-type">uint8_t</span>[]&gt; dstBuffer = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">uint8_t</span>[]&gt;(dstBufferSize);</li><li>        <span class="hljs-type">uint8_t</span>* dstPtr = dstBuffer.<span class="hljs-built_in">get</span>();</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; size.height * <span class="hljs-number">1.5</span>; j++) {</li><li>            <span class="hljs-built_in">memcpy</span>(dstPtr, srcBuffer, size.width);</li><li>            dstPtr += size.width;</li><li>            srcBuffer += stride;</li><li>        }</li><li>        <span class="hljs-comment">// 传给其他不需要stride的接口处理。</span></li><li>    }</li><li>    <span class="hljs-comment">// 释放资源。</span></li><li>    retCode = <span class="hljs-built_in">OH_NativeBuffer_Unmap</span>(imageBuffer); <span class="hljs-comment">// 释放buffer,保证bufferQueue正常轮转。</span></li><li>    <span class="hljs-keyword">if</span> (retCode != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_NativeBuffer_Unmap call failed."</span>);</li><li>    }</li><li>    errCode = <span class="hljs-built_in">OH_ImageNative_Release</span>(image);</li><li>    <span class="hljs-keyword">if</span> (errCode != IMAGE_SUCCESS) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"OH_ImageNative_Release call failed."</span>);</li><li>    }</li><li>    <span class="hljs-keyword">delete</span>[] types;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OnImageReceiver</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// 注册图像回调事件，监听每帧上报的图像。</span></li><li>    Image_ErrorCode errCode = <span class="hljs-built_in">OH_ImageReceiverNative_On</span>(receiver, OnCallback);</li><li>}</li></ol></pre></div></div></li>     </ol>    </div>   </div>   <div></div></div>