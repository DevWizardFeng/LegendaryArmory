<h1 _ngcontent-flu-c119="" class="doc-title ng-star-inserted" title="高性能GPU排序"> 高性能GPU排序 </h1>

<div _ngcontent-flu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>XEngine Kit HPS特性提供高性能GPU排序能力。相比于其它排序能力，该能力依托于华为Maleoon GPU的软硬结合优化，效率更高。</p> <div class="tiledSection"><h2 id="section624112515458">约束与限制<i class="anchor-icon anchor-icon-link" anchorid="section624112515458" tips="复制节点链接"></i></h2><ul><li>支持的设备类型：马良910 GPU及以上的Phone设备，并且从5.0.2(14)版本开始，新增支持Tablet、PC/2in1设备，从5.1.0(18)版本开始新增支持TV设备。</li><li>可通过以下方式查询相关扩展特性是否支持：<p>对于Vulkan，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#ga686e40e383c8e946b36c11b4073e77c3" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>扩展特性查询接口进行查询，如查询结果包含XEG_HPS_RADIX_SORT_EXTENSION_NAME，则表示支持该特性，若查询结果未包含，则表示不支持该特性。</p> </li></ul> </div> <div class="tiledSection"><h2 id="section297614137247">接口说明<i class="anchor-icon anchor-icon-link" anchorid="section297614137247" tips="复制节点链接"></i></h2><p>以下接口为使用高性能GPU排序所需要使用的接口，关于这些接口的详细说明见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine" target="_blank">接口文档</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.1" valign="top" width="50%"><p>名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.3.1.3.1.2" valign="top" width="50%"><p>描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CreateHPS (VkDevice device, const XEG_HPSCreateInfo *pCreateInfo, XEG_HPS *pHps)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>创建XEG_HPS对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR void VKAPI_CALL HMS_XEG_DestroyHPS (XEG_HPS hps)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>销毁XEG_HPS对象。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>VKAPI_ATTR VkResult VKAPI_CALL HMS_XEG_CmdRadixSortHPS (VkCommandBuffer commandBuffer, XEG_HPS hps, const XEG_HPSRadixSortDescription *pDescription)</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>录制HPS排序命令，使用此接口前需要通过HMS_XEG_EnumerateDeviceExtensionProperties接口查询是否支持XEG_HPS_RADIX_SORT_EXTENSION_NAME扩展。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1171182142612">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1171182142612" tips="复制节点链接"></i></h2><p>本章以在Vulkan应用程序渲染为例，说明使用高性能GPU排序的开发步骤。</p> </div> <div class="tiledSection"><h3 id="section79201052326" class="firsth2">配置项目<i class="anchor-icon anchor-icon-link" anchorid="section79201052326" tips="复制节点链接"></i></h3><p>编译HAP时，Native层so需要依赖NDK中的XEngine相关库和头文件。</p> </div> <ul><li>头文件引用<div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_hps.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_vulkan_extension.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;xengine/xeg_extension_defs.h&gt;</span></span></li></ol></pre></div></div> </li><li>CMakeLists.txt添加库依赖<p>CMakeLists.txt中添加对XEngine动态链接库依赖的代码如下。</p> <div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">find_library</span>(</li><li>    # Sets the name of the path variable.</li><li>    xengine-lib</li><li>    # Specifies the name of the NDK library that you want CMake to locate.</li><li>    xengine</li><li>)</li><li><span class="hljs-built_in">target_link_libraries</span>(nativerender PUBLIC</li><li>    ...... <span class="hljs-comment">// 其他库文件</span></li><li>    ${xengine-lib})</li></ol></pre></div></div> </li></ul> <div class="tiledSection"><h3 id="section114231231174114">集成高性能GPU排序（Vulkan）<i class="anchor-icon anchor-icon-link" anchorid="section114231231174114" tips="复制节点链接"></i></h3><p>XEngine 高性能GPU排序可以独立使用。相关代码在Native层实现。</p> <p>在调用XEngine Kit特性接口前，需要先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/syscap#判断-api-是否可以使用" target="_blank">Syscap</a>查询确认您的目标设备支持SystemCapability.Graphic.XEngine系统能力。</p> <ol><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_enumeratedeviceextensionproperties" target="_blank">HMS_XEG_EnumerateDeviceExtensionProperties</a>接口，获取XEngine支持的扩展信息，只有在支持XEG_HPS_RADIX_SORT_EXTENSION_NAME扩展时才可以使用高性能GPU排序接口。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>VkPhysicalDevice physicalDevice;</li><li>std::vector&lt;std::string&gt; supportedExtensions;</li><li><span class="hljs-type">uint32_t</span> propertyCount;</li><li><span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, <span class="hljs-literal">nullptr</span>);</li><li><span class="hljs-keyword">if</span> (propertyCount &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-function">std::vector&lt;XEG_ExtensionProperties&gt; <span class="hljs-title">properties</span><span class="hljs-params">(propertyCount)</span></span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HMS_XEG_EnumerateDeviceExtensionProperties</span>(physicalDevice, &amp;propertyCount, &amp;properties.<span class="hljs-built_in">front</span>()) ==</li><li>        VK_SUCCESS) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ext : properties) {</li><li>            supportedExtensions.<span class="hljs-built_in">push_back</span>(ext.extensionName);</li><li>        }</li><li>    }</li><li>}</li><li><span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">find</span>(supportedExtensions.<span class="hljs-built_in">begin</span>(), supportedExtensions.<span class="hljs-built_in">end</span>(), XEG_HPS_RADIX_SORT_EXTENSION_NAME) ==</li><li>    supportedExtensions.<span class="hljs-built_in">end</span>()) {</li><li>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</li><li>}</li></ol></pre></div></div> <p></p></li><li><span>准备HPS相关资源。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>VkDevice device;</li><li>VkCommandBuffer cmdBuffer;</li><li>VkQueue queue;</li><li><span class="hljs-comment">// 要被排序的key</span></li><li>VkBuffer keyBuffer;</li><li><span class="hljs-comment">// 与key对应的value</span></li><li>VkBuffer indexBuffer;</li><li><span class="hljs-comment">// 排序量</span></li><li>VkBuffer sortCount;</li></ol></pre></div></div> <p></p></li><li><span>声明实例句柄。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>XEG_HPS xegHPS { VK_NULL_HANDLE };</li></ol></pre></div></div> <p></p></li><li><span>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_createhps" target="_blank">HMS_XEG_CreateHPS</a>接口，实例化句柄。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 构造输入描述符</span></li><li>XEG_HPSRadixSort sorInfo{</li><li>    XEG_STRUCTURE_TYPE_HPS_RADIX_SORT,</li><li>    <span class="hljs-literal">nullptr</span></li><li>};</li><li>
</li><li>XEG_HPSCreateInfo info {</li><li>    XEG_STRUCTURE_TYPE_HPS_CREATE_INFO, </li><li>    &amp;sorInfo</li><li>};</li><li><span class="hljs-comment">// 实例化句柄</span></li><li><span class="hljs-built_in">HMS_XEG_CreateHPS</span>(device, &amp;info, &amp;xegHPS);</li></ol></pre></div></div> <p></p></li><li><span>构造排序描述符，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/xengine-kit-xengine#hms_xeg_cmdradixsorthps" target="_blank">HMS_XEG_CmdRadixSortHPS</a>接口录制排序命令。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li>VkCommandBufferBeginInfo cmdBufferBeginInfo {};</li><li>cmdBufferBeginInfo.sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO;</li><li>
</li><li><span class="hljs-comment">// 录制排序命令</span></li><li><span class="hljs-built_in">vkBeginCommandBuffer</span>(cmdBuffer, &amp;cmdBufferBeginInfo);</li><li>XEG_HPSRadixSortDescription sortDescription{</li><li>    XEG_STRUCTURE_TYPE_HPS_RADIX_SORT_DESCRIPTION,</li><li>    <span class="hljs-literal">nullptr</span>,</li><li>    sortCount,</li><li>    keyBuffer,</li><li>    indexBuffer</li><li>};</li><li><span class="hljs-built_in">HMS_XEG_CmdRadixSortHPS</span>(cmdBuffer, xegHPS, &amp;sortDescription);</li><li><span class="hljs-built_in">vkEndCommandBuffer</span>(cmdBuffer);</li></ol></pre></div></div> <p></p></li><li><span>提交排序命令。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 提交command buffer</span></li><li>VkResult res;</li><li>{</li><li>    VkSubmitInfo submitInfo{};</li><li>    submitInfo.sType = VK_STRUCTURE_TYPE_SUBMIT_INFO;</li><li>    submitInfo.waitSemaphoreCount = <span class="hljs-number">0</span>;</li><li>    submitInfo.signalSemaphoreCount = <span class="hljs-number">0</span>;</li><li>    submitInfo.pSignalSemaphores = <span class="hljs-literal">nullptr</span>;</li><li>    submitInfo.commandBufferCount = <span class="hljs-number">1</span>;</li><li>    submitInfo.pCommandBuffers = &amp;cmdBuffer;</li><li>    submitInfo.pWaitSemaphores = <span class="hljs-literal">nullptr</span>;</li><li>    res = <span class="hljs-built_in">vkQueueSubmit</span>(queue, <span class="hljs-number">1</span>, &amp;submitInfo, <span class="hljs-literal">nullptr</span>);</li><li>}</li><li><span class="hljs-comment">//等待结束</span></li><li><span class="hljs-built_in">vkDeviceWaitIdle</span>(device);</li></ol></pre></div></div> <p></p></li><li><span>销毁HPS对象。</span><p></p><div _ngcontent-flu-c106="" class="highlight-div"><div _ngcontent-flu-c106="" class="highlight-div-header"><div _ngcontent-flu-c106="" class="highlight-div-header-left"><div _ngcontent-flu-c106="" class="handle-button expand-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-flu-c106="" class="highlight-div-header-right"><div _ngcontent-flu-c106="" class="handle-button ai-button"></div><div _ngcontent-flu-c106="" class="handle-button line-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-flu-c106="" class="handle-button theme-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-flu-c106="" class="handle-button copy-button"><div _ngcontent-flu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-flu-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span>(xegHPS){</li><li>    <span class="hljs-built_in">HMS_XEG_DestroyHPS</span>(xegHPS);</li><li>}</li></ol></pre></div></div> <p></p></li></ol> </div> </div> <div></div></div>