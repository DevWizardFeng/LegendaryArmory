<h1 _ngcontent-qqv-c119="" class="doc-title ng-star-inserted" title="AI辅助图文内容编创"> AI辅助图文内容编创 </h1>

<div _ngcontent-qqv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section19725102811279">概述<i class="anchor-icon anchor-icon-link" anchorid="section19725102811279" tips="复制节点链接"></i></h2><p>本场景实现社交通讯类应用的图文内容编创流程，接入自由流转、服务互动等HarmonyOS特性能力。</p> </div> <div class="tiledSection"><h2 id="section119601333185612">整体场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section119601333185612" tips="复制节点链接"></i></h2><p>图文编创流程主要通过Photo Picker选取本地图片，然后对图片进行智能处理，同时也可使用自定义相机拍摄动图，最后进行文字编创时可进行自由流转接续编辑和跨端获取相册或相机拍摄内容。</p> </div> <div class="tiledSection"><h3 id="section151021842133212" class="firsth2">演示效果<i class="anchor-icon anchor-icon-link" anchorid="section151021842133212" tips="复制节点链接"></i></h3><p>图文编创操作流程</p> <p></p> <p><span><img originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163343.29150025627948942397024955441730:50001231000000:2800:0BD39187A9D8302486172869E6A3ECF1FEEE21093982ACA2E45622711106ED05.gif" class="notEnlarge" width="232" height="480"></span></p> </div> <div class="tiledSection"><h2 id="section45743163315">场景适用说明<i class="anchor-icon anchor-icon-link" anchorid="section45743163315" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section103802575335" class="firsth2">适用范围<i class="anchor-icon anchor-icon-link" anchorid="section103802575335" tips="复制节点链接"></i></h3><p>本场景适用于社交通讯类应用，图文内容编辑过程中接入HarmonyOS特性能力，提供详细技术实现方案，降低开发者学习成本，提高接入速度。</p> </div> <div class="tiledSection"><h2 id="section175521479342">场景优势<i class="anchor-icon anchor-icon-link" anchorid="section175521479342" tips="复制节点链接"></i></h2><p>本场景结合HarmonyOS的跨设备互通、智能处理、自由流转等能力，提升用户内容发布体验。具体优势如下：</p> <p>（1）跨设备互通能力使多设备用户可以灵活选择存储在不同设备上的媒体资源，并使用不同设备的拍摄能力获取新图像，简化了不同设备间的数据传输流程，提升了用户体验。</p> <p>（2）HarmonyOS智能的使用，为用户提供了强大的编创能力支持。用户可以从图中提取有效信息进行文字编辑，可以从候选图中提取目标去除背景，进行二次创作。这些技术的应用，为用户提供了更丰富的编创选择。</p> <p>（3）自由流转能力的接入，可无缝切换至其他设备，并同步最新编辑状态至新设备，用户可以灵活选择合适设备，实现接续编辑。</p> </div> <div class="tiledSection"><h2 id="section18414181359">场景分析<i class="anchor-icon anchor-icon-link" anchorid="section18414181359" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section101362512362" class="firsth2">典型场景分析<i class="anchor-icon anchor-icon-link" anchorid="section101362512362" tips="复制节点链接"></i></h3> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="23.56%"><p>子场景名称</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>描述</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>实现方案</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="23.56%"><p>图片视图选择</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>发布首页资源文件类型选择</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>使用Photo Picker能力实现图片选择</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="23.56%"><p>相机拍摄</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>自定义相机页面，可拍摄和预览Moving Photo图片</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>使用Camera相机组件能力自定义相机</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="23.56%"><p>图片文字识别、抠取与HDR Vivid图片的展示</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>图片浏览页支持选定图片的目标抠取、复制图上文字信息获取，参与创作编辑，自动识别HDR模式并展示高亮</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>使用Image组件的智能识别能力，实现OCR文字识别与抠图</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="23.56%"><p>跨端相册选取</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>从其他设备的相册中选取图片，回传到本端设备</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>基于CollaborationService跨设备互通组件</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="23.56%"><p>编辑页流转接续</p> </td> <td class="cellrowborder" valign="top" width="42.25%"><p>编创内容支持在多设备之间接续编辑。开发者可以在不同设备上继续编辑内容</p> </td> <td class="cellrowborder" valign="top" width="34.19%"><p>基于Ability的自由流转能力，使用ArkData数据管理和分布式文件管理实现本地创作内容的多设备之间接续编辑</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section8145193993611">场景实现<i class="anchor-icon anchor-icon-link" anchorid="section8145193993611" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h2 id="section182378402229">Photo Picker的使用<i class="anchor-icon anchor-icon-link" anchorid="section182378402229" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0904101815234" class="firsth2">子场景描述<i class="anchor-icon anchor-icon-link" anchorid="section0904101815234" tips="复制节点链接"></i></h3><p>用户在首页点击进入发布流程时，将直接跳转到半模态窗口的Picker页面。该页面支持自定义，为开发者提供更多选择。</p> </div> <div class="tiledSection"><h3 id="section13101013142415">关键点说明<i class="anchor-icon anchor-icon-link" anchorid="section13101013142415" tips="复制节点链接"></i></h3><p>使用系统Picker能力，可以免申请权限读写权限'READ_IMAGEVIDEO'和'WRITE_IMAGEVIDEO'，给开发者提供了极大的便利。</p> </div> <div class="tiledSection"><h3 id="section14372316142515">关键代码<i class="anchor-icon anchor-icon-link" anchorid="section14372316142515" tips="复制节点链接"></i></h3><p>首先在使用前，需要先创建PhotoViewPicker实例。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L72-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> photoViewPicker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-built_in">PhotoViewPicker</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L72-L72" target="_blank">UIUtils.ets</a></div></div></div></div> <p>根据业务逻辑需要进行图片选择环节的属性设置，如设置可选择的媒体资源类型、资源数量上限。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L67-L69" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">const</span> photoSelectOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-built_in">PhotoSelectOptions</span>();</li><li>photoSelectOptions.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;</li><li>photoSelectOptions.maxSelectNumber = CommonConstants.LIMIT_PICKER_NUM - selectedNum;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L67-L69" target="_blank">UIUtils.ets</a></div></div></div></div> <div class="p">发起调用，获取图片。<div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L67-L73" data-highlighted="yes"><ol class="linenums"><li>photoViewPicker.<span class="hljs-title function_">select</span>(photoSelectOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> uriArr = photoSelectResult.<span class="hljs-property">photoUris</span>;</li><li>  <span class="hljs-title function_">callback</span>(uriArr);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">UIUtils</span>.<span class="hljs-property">tag</span>,</li><li>    <span class="hljs-string">`Invoke photoViewPicker.select failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/UIUtils.ets#L67-L73" target="_blank">UIUtils.ets</a></div></div></div></div> </div> </div> <div class="tiledSection"><h2 id="section4144207172817">OCR文字识别、智能抠图与HDR vivid的使用<i class="anchor-icon anchor-icon-link" anchorid="section4144207172817" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section113965263283" class="firsth2">子场景描述<i class="anchor-icon anchor-icon-link" anchorid="section113965263283" tips="复制节点链接"></i></h3><p>选取图片后，可以浏览图片并长按物体实现目标抠取，同时可以识别图片中的文字以供后续文本编辑使用。如果图片采用HDR Vivid模式拍摄，将展示其效果。</p> </div> <div class="tiledSection"><h3 id="section218034910260">演示效果<i class="anchor-icon anchor-icon-link" anchorid="section218034910260" tips="复制节点链接"></i></h3><p>长按图片可识别文字并实现物体抠图</p> <p></p> <p><span><img originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163343.47691233337040077886113469304210:50001231000000:2800:80F514B790EFE106330910D2567341FED91144854A2A7C4C4105452BE76B8FC0.gif" class="notEnlarge" width="232" height="480"></span></p> </div> <div class="tiledSection"><h3 id="section2308205432816">关键点说明<i class="anchor-icon anchor-icon-link" anchorid="section2308205432816" tips="复制节点链接"></i></h3><p>（1）在Image组件中，设置enableAnalyzer属性可实现OCR文字识别和抠图；设置dynamicRangeMode属性可展示HDR高亮，需配合image.DecodingOptions配置动态范围模式。</p> <p>（2）图片可OCR文字识别时，点击图片内出现的识别按钮或长按文字，会出现复制文本菜单和文字框选区域。</p> <p>（3）抠图：长按图片中的物体，出现抠图效果，菜单中可复制与分享。</p> </div> <div class="tiledSection"><h3 id="section11376157133417">关键代码<i class="anchor-icon anchor-icon-link" anchorid="section11376157133417" tips="复制节点链接"></i></h3><p>开启图片智能分析属性并设置图像的动态模式。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/SelectedEditeView.ets#L88-L91" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">Image</span>(item)</li><li>  <span class="hljs-selector-class">.objectFit</span>(ImageFit.Contain)</li><li>  <span class="hljs-selector-class">.enableAnalyzer</span>(true)</li><li>  <span class="hljs-selector-class">.dynamicRangeMode</span>(DynamicRangeMode.HIGH)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/SelectedEditeView.ets#L88-L91" target="_blank">SelectedEditeView.ets</a></div></div></div></div> <p>设置图片解码选项，配合动态模式。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/FileUtils.ets#L27-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">DecodingOptions</span> = {</li><li>  <span class="hljs-variable">index</span>: <span class="hljs-number">0</span>,</li><li>  <span class="hljs-variable">editable</span>: <span class="hljs-keyword">false</span>,</li><li>  <span class="hljs-variable">desiredPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">RGBA_8888</span>,</li><li>};</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">uri</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">ImageInfo</span> | <span class="hljs-title class_">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">imageInfo</span>: <span class="hljs-title class_">ImageInfo</span> | <span class="hljs-title class_">undefined</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">uri</span>, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_ONLY</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">displayName</span> = <span class="hljs-variable">file</span>.<span class="hljs-variable">name</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageResource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">imageResource</span>.<span class="hljs-title function_">createPixelMapSync</span>(<span class="hljs-variable">FileUtils</span>.<span class="hljs-variable">options</span>);</li><li>    <span class="hljs-variable">imageInfo</span> = { <span class="hljs-variable">imagePixelMap</span>: <span class="hljs-title class_">pixelMap</span>, <span class="hljs-variable">imageName</span>: <span class="hljs-title class_">displayName</span> };</li><li>    <span class="hljs-variable">fs</span>.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable">file</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">FileUtils</span>.<span class="hljs-variable">tag</span>, `<span class="hljs-variable">createPixelMap</span> <span class="hljs-variable">error</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">error</span>)}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">imageInfo</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/FileUtils.ets#L27-L85" target="_blank">FileUtils.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section464920010581">Moving Photo的拍摄与展示<i class="anchor-icon anchor-icon-link" anchorid="section464920010581" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h2 id="section121716333372">子场景描述<i class="anchor-icon anchor-icon-link" anchorid="section121716333372" tips="复制节点链接"></i></h2><p>在编辑图片页，增加一个自定义相机tab项，开发者可以根据自身需求，设置并拍摄多种模式的照片，用于内容展示。</p> </div> <div class="tiledSection"><h3 id="section76831524113812" class="firsth2">关键点说明<i class="anchor-icon anchor-icon-link" anchorid="section76831524113812" tips="复制节点链接"></i></h3><p>（1）相机初始化后，可设置Moving Photo属性，默认关闭。当前场景中，若设置为开启，可点击Moving Photo按钮切换状态。</p> <p>（2）获取拍摄的最新图片，需要在拍摄完成后等待30秒，然后才能获取到最新图片。</p> <p>（3）使用MovingPhotoView视图预览Moving Photo图片，长按可播放。</p> <p>（4）申请对应权限，同意后初始化相机。</p> </div> <div class="tiledSection"><h3 id="section1833663316397">关键代码<i class="anchor-icon anchor-icon-link" anchorid="section1833663316397" tips="复制节点链接"></i></h3><p>申请对应权限。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/CameraView.ets#L35-L190" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> permissions: Array&lt;Permissions&gt; = [</li><li>  <span class="hljs-string">'ohos.permission.CAMERA'</span>,</li><li>  <span class="hljs-string">'ohos.permission.MICROPHONE'</span>,</li><li>  <span class="hljs-string">'ohos.permission.MEDIA_LOCATION'</span>,</li><li>  <span class="hljs-string">'ohos.permission.READ_IMAGEVIDEO'</span>,</li><li>  <span class="hljs-string">'ohos.permission.WRITE_IMAGEVIDEO'</span>,</li><li>];</li><li>
</li><li>abilityAccessCtrl.createAtManager().requestPermissionsFromUser(DataUtils.context, <span class="hljs-keyword">this</span>.permissions).then(() =&gt; {</li><li>  <span class="hljs-keyword">this</span>.surfaceId = <span class="hljs-keyword">this</span>.mXComponentController.getXComponentSurfaceId();</li><li>  <span class="hljs-keyword">this</span>.initCamera();</li><li>  <span class="hljs-keyword">this</span>.getThumbnail();</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/CameraView.ets#L35-L190" target="_blank">CameraView.ets</a></div></div></div></div> <p>相机设置Moving Photo属性。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/model/CameraService.ets#L206-L211" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setEnableLivePhoto</span>(<span class="hljs-params">isMovingPhoto: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span>?.<span class="hljs-title function_">isMovingPhotoSupported</span>()) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">photoOutput</span>?.<span class="hljs-title function_">enableMovingPhoto</span>(isMovingPhoto);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/model/CameraService.ets#L206-L211" target="_blank">CameraService.ets</a></div></div></div></div> <div class="p">获取媒体库中最新图片地址与缩略图。<div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/CameraView.ets#L292-L300" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">getThumbnail</span>(): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> photoAsset: photoAccessHelper.PhotoAsset =</li><li>    AppStorage.<span class="hljs-keyword">get</span>(CommonConstants.KEY_PHOTO_ASSET) <span class="hljs-keyword">as</span> photoAccessHelper.PhotoAsset;</li><li>  <span class="hljs-keyword">if</span> (photoAsset === undefined) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.currentImg = <span class="hljs-keyword">await</span> photoAsset.getThumbnail();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/view/CameraView.ets#L292-L300" target="_blank">CameraView.ets</a></div></div></div></div> </div> <p>引入Moving Photo相关库。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L17-L17" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MovingPhotoView</span>, <span class="hljs-title class_">MovingPhotoViewController</span>, <span class="hljs-title class_">MovingPhotoViewAttribute</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.multimedia.movingphotoview'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L17-L17" target="_blank">PreviewMovingPhotoPage.ets</a></div></div></div></div> <p>通过拍摄后获取的photoAccessHelper.PhotoAsset请求Moving Photo。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L34-L212" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">StorageLink</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_MOVING_DATA</span>) <span class="hljs-variable">src</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">MovingPhoto</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>@<span class="hljs-title function_">StorageLink</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_IMAGE_INFO</span>) <span class="hljs-variable">imageInfoArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ImageInfo</span>&gt; = [];</li><li>@<span class="hljs-title function_">State</span> <span class="hljs-variable">isMuted</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>
</li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">requestMovingPhoto</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">requestMovingPhoto</span>() {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span> =</li><li>    <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_PHOTO_ASSET</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">PhotoAsset</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">photoAsset</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">requestOptions</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">RequestOptions</span> = {</li><li>    <span class="hljs-variable">deliveryMode</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">DeliveryMode</span>.<span class="hljs-title class_">FAST_MODE</span>,</li><li>  }</li><li>  <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">MediaAssetManager</span>.<span class="hljs-title function_">requestMovingPhoto</span>(<span class="hljs-variable">DataUtils</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">photoAsset</span>, <span class="hljs-variable">requestOptions</span>,</li><li>    <span class="hljs-variable">new</span> <span class="hljs-title function_">MediaDataHandlerMovingPhoto</span>());</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDataHandlerMovingPhoto</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">MediaAssetDataHandler</span>&lt;<span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">MovingPhoto</span>&gt; {</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">onDataPrepared</span>(<span class="hljs-variable">movingPhoto</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">MovingPhoto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>    <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_MOVING_DATA</span>, <span class="hljs-variable">movingPhoto</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L34-L212" target="_blank">PreviewMovingPhotoPage.ets</a></div></div></div></div> <p>添加Moving Photo展示图。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L62-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">Flex</span>({</li><li>    <span class="hljs-variable">direction</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">BreakpointType</span>(</li><li>      {</li><li>        <span class="hljs-variable">sm</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-title class_">Column</span>,</li><li>        <span class="hljs-variable">md</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-title class_">Column</span>,</li><li>        <span class="hljs-variable">lg</span>: <span class="hljs-title class_">FlexDirection</span>.<span class="hljs-title class_">Row</span>,</li><li>      }</li><li>    ).<span class="hljs-title function_">getValue</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentBreakpoint</span>),</li><li>    <span class="hljs-variable">wrap</span>: <span class="hljs-title class_">FlexWrap</span>.<span class="hljs-title class_">NoWrap</span>,</li><li>    <span class="hljs-variable">justifyContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-title class_">Start</span>,</li><li>    <span class="hljs-variable">alignItems</span>: <span class="hljs-title class_">ItemAlign</span>.<span class="hljs-title class_">Start</span>,</li><li>    <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-title class_">Start</span></li><li>  }) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setActions</span>();</li><li>    <span class="hljs-title function_">MovingPhotoView</span>({</li><li>      <span class="hljs-variable">movingPhoto</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">src</span>,</li><li>      <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span></li><li>    })</li><li>      .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.full_screen'</span>))</li><li>      .<span class="hljs-title function_">objectFit</span>(<span class="hljs-variable">ImageFit</span>.<span class="hljs-variable">Contain</span>)</li><li>      .<span class="hljs-title function_">muted</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isMuted</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">BreakpointType</span>(</li><li>        {</li><li>          <span class="hljs-variable">sm</span>: { <span class="hljs-variable">bottom</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">margin_190</span>') } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>,</li><li>          <span class="hljs-variable">md</span>: { <span class="hljs-variable">bottom</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">margin_190</span>') } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>,</li><li>          <span class="hljs-variable">lg</span>: { <span class="hljs-variable">right</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">margin_24</span>') } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>,</li><li>        }</li><li>      ).<span class="hljs-title function_">getValue</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentBreakpoint</span>))</li><li>  }</li><li>  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>)</li><li>  .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.full_screen'</span>))</li><li>  .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.full_screen'</span>))</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/PreviewMovingPhotoPage.ets#L62-L101" target="_blank">PreviewMovingPhotoPage.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>本章节只介绍主干流程的关键代码，要实现自定义相机还需要其他配置，可详细关注封装模块CameraService文件，Moving Photo的使用可查看相关Api使用：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-movingphotoview" target="_blank">动图照片</a>。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section18322112514480">跨设备互通组件的使用<i class="anchor-icon anchor-icon-link" anchorid="section18322112514480" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section23525020612" class="firsth2">演示效果<i class="anchor-icon anchor-icon-link" anchorid="section23525020612" tips="复制节点链接"></i></h3><p>跨端相册获取新的图片</p> <p></p> <p><span><img height="339.15000000000003" originheight="480" originwidth="741" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163343.08969690266079593774509676565531:50001231000000:2800:82DA4B0E2B1A4ADDEF0F1C44B633EF10E9F003D40B2F83E5FDD129B508F71CB6.gif" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section1360413734816">子场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1360413734816" tips="复制节点链接"></i></h3><p>通过跨设备互通组件，实现跨端相册访问和跨端相机拍照，从其他设备获取新的图像内容，提高设备间图像传输的快捷性和便利性。</p> </div> <div class="tiledSection"><h3 id="section6534261611">关键点说明<i class="anchor-icon anchor-icon-link" anchorid="section6534261611" tips="复制节点链接"></i></h3><p>（1）使用跨设备互通组件需要连接网络并登录相同账号。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>当前跨设备互通能力仅支持“重”设备调用“轻”设备，其中“重”设备指重量较大、便携性较差的设备，“轻”设备指重量较轻、便携性较好的设备。设备间可跨端调用关系如下说明：</p> <p>（1）平板可调用手机，但无法调用其他平板。</p> <p>（2）手机无法调用平板，也无法调用其他手机。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section28901469125">关键代码<i class="anchor-icon anchor-icon-link" anchorid="section28901469125" tips="复制节点链接"></i></h3><p>跨端拍照与跨端相册访问</p> <p>使用createCollaborationServiceMenuItems定义设备列表选择器，显示组网内具有相机能力的设备列表。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L16-L351" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> {</li><li>  CollaborationServiceFilter,</li><li>  CollaborationServiceStateDialog,</li><li>  createCollaborationServiceMenuItems</li><li>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ServiceCollaborationKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li>CollaborationMenu() {</li><li>  Menu() {</li><li>    createCollaborationServiceMenuItems([CollaborationServiceFilter.ALL]);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L16-L351" target="_blank">GraphicCreationPage.ets</a></div></div></div></div> <p>使用CollaborationCameraStateDialog弹窗组件提示对端相机拍摄状态。</p> <p>该组件在build()函数内直接调用，实现onState方法。拍摄完成后，通过onState方法回传内容。</p> <p>onState方法的回调函数包含两个参数：stateCode表示业务完成状态，buffer表示成功返回的数据。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L122-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-title function_">setCollaborationDialog</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">CollaborationServiceStateDialog</span>({</li><li>    <span class="hljs-attr">onState</span>: (<span class="hljs-attr">stateCode</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">bufferType</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">doInsertPicture</span>(stateCode,</li><li>      bufferType, buffer)</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">doInsertPicture</span>(<span class="hljs-attr">stateCode</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">bufferType</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">if</span> (stateCode !== <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span>, <span class="hljs-string">`doInsertPicture stateCode: <span class="hljs-subst">${stateCode}</span>}`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span>, <span class="hljs-string">`doInsertPicture bufferType: <span class="hljs-subst">${bufferType}</span>}`</span>);</li><li>  <span class="hljs-keyword">if</span> (bufferType === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">BUFFER_TYPE</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageInfoArr</span>.<span class="hljs-property">length</span> === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LIMIT_PICKER_NUM</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-attr">message</span>: $r(<span class="hljs-string">'app.string.toast_picker_limit'</span>),</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-title class_">DataUtils</span>.<span class="hljs-title function_">fromResToNumber</span>($r(<span class="hljs-string">'app.float.show_DELAY_TIME'</span>)),</li><li>      });</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">saveUri</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">FileUtils</span>.<span class="hljs-title function_">saveFile</span>(<span class="hljs-title class_">DataUtils</span>.<span class="hljs-property">context</span>, buffer);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">imageInfo</span>: <span class="hljs-title class_">ImageInfo</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title class_">FileUtils</span>.<span class="hljs-title function_">createPixelMap</span>(saveUri);</li><li>    <span class="hljs-keyword">if</span> (imageInfo) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageInfoArr</span>.<span class="hljs-title function_">unshift</span>(imageInfo);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedData</span>.<span class="hljs-title function_">unshiftData</span>(imageInfo.<span class="hljs-property">imagePixelMap</span>);</li><li>      <span class="hljs-comment">// copy file to distributedFilesDir</span></li><li>      <span class="hljs-title class_">FileUtils</span>.<span class="hljs-title function_">copyFileToDestination</span>(saveUri, <span class="hljs-title class_">DataUtils</span>.<span class="hljs-property">context</span>.<span class="hljs-property">distributedFilesDir</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L122-L154" target="_blank">GraphicCreationPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1973014141516">应用接续的实现<i class="anchor-icon anchor-icon-link" anchorid="section1973014141516" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section108527071615" class="firsth2">子场景描述<i class="anchor-icon anchor-icon-link" anchorid="section108527071615" tips="复制节点链接"></i></h3><p>使用Ability的自由流转能力，编辑内容可以流转到其他设备上进行接续编辑，方便用户在不同设备上编辑。</p> </div> <div class="tiledSection"><h3 id="section19879144691417">演示效果<i class="anchor-icon anchor-icon-link" anchorid="section19879144691417" tips="复制节点链接"></i></h3><p>自由流转，接续编辑图文内容的功能已启用。</p> <p></p> <p><span><img height="339.15000000000003" originheight="480" originwidth="741" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163343.91064663069086906143912835518056:50001231000000:2800:F620C67555AD045594485A6465C2CCC856723F2965EC4DB42D640EA20B076601.gif" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section17420124841615">关键点说明<i class="anchor-icon anchor-icon-link" anchorid="section17420124841615" tips="复制节点链接"></i></h3><p>接续使用条件</p> <p>（1）两端设备登录同一华为账号。</p> <p>（2）两端设备打开Wi-Fi和蓝牙开关，连接同一局域网，可提升数据传输速度。</p> <p>（3）应用接续只能在同应用（UIAbility）之间触发，双端设备都需要该应用。</p> <p>（4）在onContinue回调中使用wantParam传输的数据应控制在100KB以内。对于大于100KB的数据，建议使用分布式数据对象或分布式文件系统，例如图片文件。</p> <p>申请权限需要在module.json5文件中的module对象的requestPermissions属性中进行。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/module.json5#L15-L105" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.DISTRIBUTED_DATASYNC"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:distributed_desc"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>]</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/module.json5#L15-L105" target="_blank">module.json5</a></div></div></div></div> <div class="p">打开应用接续开关，在module.json5文件里的module对象的abilities字段内设置"continuable"的值为true。<div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/module.json5#L109-L135" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"abilities"</span>: [</li><li>  {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"continuable"</span>: <span class="hljs-keyword">true</span>,</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>]</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/module.json5#L109-L135" target="_blank">module.json5</a></div></div></div></div> </div> </div> <div class="tiledSection"><h3 id="section132571239103220">关键代码<i class="anchor-icon anchor-icon-link" anchorid="section132571239103220" tips="复制节点链接"></i></h3><p>应用接续可以按需迁移路由栈，也可选择动态配置，仅对特定页面开启接续，此处仅设置最后的图文编辑页面GraphicCreationPage开启接续能力。按需迁移路由栈的方法具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-continuation-guide#section34254151518" target="_blank">应用接续开发指导：按需迁移页面栈</a>。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L62-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onPageShow</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-title class_">DataUtils</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">ACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setMissionContinueState ACTIVE result: '</span>, <span class="hljs-string">`<span class="hljs-subst">${result.code}</span>`</span>);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-title class_">DataUtils</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">ContinueState</span>.<span class="hljs-property">INACTIVE</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setMissionContinueState INACTIVE result: '</span>, <span class="hljs-string">`<span class="hljs-subst">${result.code}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/pages/GraphicCreationPage.ets#L62-L75" target="_blank">GraphicCreationPage.ets</a></div></div></div></div> <p>设置迁移加载指定页面。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L165-L176" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onWindowStageRestore</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/GraphicCreationPage'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L165-L176" target="_blank">EntryAbility.ets</a></div></div></div></div> <div class="p">迁移端实现onContinue接口，多图片自由流转，使用资产卡片数组的方式传递，与其他文本数据分装成一个数据对象。<div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L90-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">async</span> <span class="hljs-title function_">onContinue</span>(<span class="hljs-variable">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span> | <span class="hljs-title class_">undefined</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">OnContinueResult</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// get distribute id</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">genSessionId</span>();</li><li>    <span class="hljs-variable">wantParam</span>.<span class="hljs-variable">distributedSessionId</span> = <span class="hljs-variable">sessionId</span>;</li><li>    <span class="hljs-comment">// set images assets info</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageInfoArray</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title class_">get</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ImageInfo</span>&gt;&gt;(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_IMAGE_INFO</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">assets</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Assets</span> = [];</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">imageInfoArray</span>) {</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">imageInfoArray</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">append</span> = <span class="hljs-variable">imageInfoArray</span>[<span class="hljs-variable">i</span>];</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">attachment</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getAssetInfo</span>(<span class="hljs-variable">append</span>);</li><li>        <span class="hljs-variable">assets</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">attachment</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// set distribute data object</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">contentInfo</span>: <span class="hljs-title class_">ContentInfo</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ContentInfo</span>(</li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_TITLE</span>),</li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_DESCRIPTION</span>),</li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_IMAGE_INFO</span>),</li><li>      <span class="hljs-variable">assets</span></li><li>    );</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">source</span> = <span class="hljs-variable">contentInfo</span>.<span class="hljs-title function_">flatAssets</span>();</li><li>    <span class="hljs-comment">// save data to distribute</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">source</span>);</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">tag</span>, `<span class="hljs-variable">onContinue</span> <span class="hljs-variable">source</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">source</span>)}`);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>.<span class="hljs-title function_">setSessionId</span>(<span class="hljs-variable">sessionId</span>);</li><li>    <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable">wantParam</span>.<span class="hljs-variable">targetDevice</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">tag</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">save</span>. <span class="hljs-variable">Code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">tag</span>, <span class="hljs-string">'distributedDataObject failed'</span>, `<span class="hljs-variable">code</span> ${(<span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>).<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">OnContinueResult</span>.<span class="hljs-variable">AGREE</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">getAssetInfo</span>(<span class="hljs-variable">append</span>: <span class="hljs-title class_">ImageInfo</span>): <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">filePath</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">distributedFilesDir</span> + <span class="hljs-string">'/'</span> + <span class="hljs-variable">append</span>.<span class="hljs-variable">imageName</span>;</li><li>  <span class="hljs-variable">fs</span>.<span class="hljs-title function_">statSync</span>(<span class="hljs-variable">filePath</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">uri</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable">filePath</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">stat</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">statSync</span>(<span class="hljs-variable">filePath</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">attachment</span>: <span class="hljs-title class_">commonType</span>.<span class="hljs-title class_">Asset</span> = {</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-title class_">append</span>.<span class="hljs-title class_">imageName</span>,</li><li>    <span class="hljs-variable">uri</span>: <span class="hljs-title class_">uri</span>,</li><li>    <span class="hljs-variable">path</span>: <span class="hljs-title class_">filePath</span>,</li><li>    <span class="hljs-variable">createTime</span>: <span class="hljs-title class_">stat</span>.<span class="hljs-title class_">ctime</span>.<span class="hljs-title class_">toString</span>(),</li><li>    <span class="hljs-variable">modifyTime</span>: <span class="hljs-title class_">stat</span>.<span class="hljs-title class_">ctime</span>.<span class="hljs-title class_">toString</span>(),</li><li>    <span class="hljs-variable">size</span>: <span class="hljs-title class_">stat</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">toString</span>()</li><li>  };</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">tag</span>, `<span class="hljs-variable">getAssetInfo</span> <span class="hljs-variable">attachment</span> = ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">attachment</span>)}`);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">attachment</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L90-L142" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>这部分代码写在EntryAbility中，而不是Page页中。使用AppStorage进行数据的持续保存和双向绑定，当数据变化时更新视图。</p> </div></div></div> <p>接收端实现onCreate接口和onNewWant接口，onCreate接口用于冷启动或多实例热启动，onNewWant接口用于单实例热启动。仅在应用接续状态下，注册数据监听，恢复页面流转的数据。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L32-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onCreate</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">DataUtils</span>.<span class="hljs-variable">context</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>;</li><li>  <span class="hljs-comment">// set circulation status INACTIVE</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-title function_">setMissionContinueState</span>(<span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">ContinueState</span>.<span class="hljs-variable">INACTIVE</span>, (<span class="hljs-variable">result</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(`<span class="hljs-variable">restoreDistributedObject</span> <span class="hljs-variable">setMissionContinueState</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">result</span>.<span class="hljs-variable">code</span>}`);</li><li>  });</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">restoreDistributedObject</span>(<span class="hljs-variable">want</span>, <span class="hljs-variable">launchParam</span>);</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">tag</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span>);</li><li>}</li><li>
</li><li><span class="hljs-title function_">onNewWant</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">restoreDistributedObject</span>(<span class="hljs-variable">want</span>, <span class="hljs-variable">launchParam</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">restoreDistributedObject</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">launchParam</span>.<span class="hljs-variable">launchReason</span> !== <span class="hljs-variable">AbilityConstant</span>.<span class="hljs-variable">LaunchReason</span>.<span class="hljs-variable">CONTINUATION</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// File copying takes a long time, resulting in the page lifecycle aboutToAppear being executed first.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">imageInfoArr</span>: <span class="hljs-title class_">ImageInfo</span>[] = [];</li><li>  <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_IMAGE_INFO</span>, <span class="hljs-variable">imageInfoArr</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">contentInfo</span>: <span class="hljs-title class_">ContentInfo</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ContentInfo</span>(<span class="hljs-variable">undefined</span>, <span class="hljs-variable">undefined</span>, <span class="hljs-variable">undefined</span>, <span class="hljs-variable">undefined</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span> = <span class="hljs-variable">distributedDataObject</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">contentInfo</span>);</li><li>  <span class="hljs-comment">// Add a data restored listener.</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'status'</span>,</li><li>    (<span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">networkId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">status</span>: <span class="hljs-string">'online'</span> | <span class="hljs-string">'offline'</span> | <span class="hljs-string">'restored'</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> === <span class="hljs-string">'restored'</span>) {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_TITLE</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>[<span class="hljs-string">'title'</span>]);</li><li>        <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_DESCRIPTION</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>[<span class="hljs-string">'description'</span>]);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">attachments</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>[<span class="hljs-string">'attachments'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">commonType</span>.<span class="hljs-variable">Assets</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">attachments</span>) {</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">attachment</span> <span class="hljs-variable">of</span> <span class="hljs-variable">attachments</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">sourceUri</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(`${<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">distributedFilesDir</span>}/${<span class="hljs-variable">attachment</span>.<span class="hljs-variable">name</span>}`);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">destination</span>: <span class="hljs-title class_">string</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span>;</li><li>            <span class="hljs-variable">FileUtils</span>.<span class="hljs-title function_">copyFileToDestination</span>(<span class="hljs-variable">sourceUri</span>, <span class="hljs-variable">destination</span>);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">uri</span>: <span class="hljs-title class_">string</span> = `${<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span>}/${<span class="hljs-variable">attachment</span>.<span class="hljs-variable">name</span>}`;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">imageInfo</span> = <span class="hljs-variable">FileUtils</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">uri</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">imageInfo</span>) {</li><li>              <span class="hljs-variable">imageInfoArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">imageInfo</span>);</li><li>            }</li><li>          }</li><li>        }</li><li>        <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_IMAGE_INFO</span>, <span class="hljs-variable">imageInfoArr</span>);</li><li>        <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">KEY_RESTORE_IMAGE_INFO</span>, <span class="hljs-variable">imageInfoArr</span>);</li><li>      }</li><li>    });</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">sessionId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">want</span>.<span class="hljs-variable">parameters</span>?.<span class="hljs-variable">distributedSessionId</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">distributedObject</span>.<span class="hljs-title function_">setSessionId</span>(<span class="hljs-variable">sessionId</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-title function_">restoreWindowStage</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">LocalStorage</span>());</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L32-L85" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>图片的流转需要借助分布式文件系统，发送侧需将文件拷贝到分布式目录下，接受侧再从分布式目录拷贝到本地沙箱使用。</p> <div class="screenLinkPre"><div _ngcontent-qqv-c106="" class="highlight-div"><div _ngcontent-qqv-c106="" class="highlight-div-header"><div _ngcontent-qqv-c106="" class="highlight-div-header-left"><div _ngcontent-qqv-c106="" class="handle-button expand-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qqv-c106="" class="highlight-div-header-right"><div _ngcontent-qqv-c106="" class="handle-button ai-button"></div><div _ngcontent-qqv-c106="" class="handle-button line-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qqv-c106="" class="handle-button theme-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qqv-c106="" class="handle-button copy-button"><div _ngcontent-qqv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qqv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/FileUtils.ets#L41-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">copyFileToDestination</span>(<span class="hljs-params">sourceUri: <span class="hljs-built_in">string</span>, destination: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">FILE_BUFFER_SIZE</span>);</li><li>    <span class="hljs-keyword">let</span> readSize = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(sourceUri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    <span class="hljs-keyword">let</span> readLen = fs.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, buf, { <span class="hljs-attr">offset</span>: readSize });</li><li>    <span class="hljs-keyword">let</span> destinationDistribute =</li><li>      fs.<span class="hljs-title function_">openSync</span>(<span class="hljs-string">`<span class="hljs-subst">${destination}</span>/<span class="hljs-subst">${file.name}</span>`</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>    <span class="hljs-keyword">while</span> (readLen &gt; <span class="hljs-number">0</span>) {</li><li>      readSize += readLen;</li><li>      fs.<span class="hljs-title function_">writeSync</span>(destinationDistribute.<span class="hljs-property">fd</span>, buf);</li><li>      readLen = fs.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, buf, { <span class="hljs-attr">offset</span>: readSize });</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">FileUtils</span>.<span class="hljs-property">tag</span>, <span class="hljs-string">'copyFileToDestination success'</span>);</li><li>    fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>    fs.<span class="hljs-title function_">closeSync</span>(destinationDistribute);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">FileUtils</span>.<span class="hljs-property">tag</span>, <span class="hljs-string">`copyFileToDestination failed. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/graphic-creation/blob/master/entry/src/main/ets/utils/FileUtils.ets#L41-L61" target="_blank">FileUtils.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section94082528515">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section94082528515" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/graphic-creation" target="_blank">AI辅助图文内容高效编创</a></li></ul> </div> </div> <div></div></div>