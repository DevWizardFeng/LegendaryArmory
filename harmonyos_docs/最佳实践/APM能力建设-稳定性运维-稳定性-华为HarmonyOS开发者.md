<h1 _ngcontent-abg-c119="" class="doc-title ng-star-inserted" title="APM能力建设"> APM能力建设 </h1>

<div _ngcontent-abg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>APM作为应用性能管理平台，可线上监控应用质量。系统提供采集质量数据的能力，开发者可以收集这类数据构建APM平台。</p> <p><span><img height="524.560379" originheight="610" originwidth="964" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.75888718374746070786642223314629:50001231000000:2800:5CF6EA507EE01FCF779EE30A5CB1867634E0D12C3ECA03CE93B1A1731C1815FD.png" title="点击放大" width="828.977296"></span></p> <p>本文主要介绍如何通过HiAppEvent订阅接口采集系统事件。其中，系统事件是指应用运行期间，应用进程发生的性能、功耗、稳定性等故障，HiAppEvent会将这些故障通过事件返回给开发者。</p> <div class="tiledSection"><h2 id="section1236911501472">HiAppEvent系统事件订阅能力<i class="anchor-icon anchor-icon-link" anchorid="section1236911501472" tips="复制节点链接"></i></h2></div> <p>当前HiAppEvent支持的各种系统事件介绍、检测原理、事件参数对象params包含的字段说明，具体请查阅各种系统事件的介绍。</p> <p style="color: rgb(0,176,240);"><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-crash-events" target="_blank">崩溃事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-freeze-events" target="_blank">应用冻屏事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events" target="_blank">资源泄漏事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-address-sanitizer-events" target="_blank">地址越界事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-mainthreadjank-events" target="_blank">主线程超时事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-apphicollie-events" target="_blank">任务执行超时事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-app-killed-events" target="_blank">应用查杀事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-app-launch-event" target="_blank">启动耗时事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-scroll-jank-event" target="_blank">滑动丢帧事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-cpu-usage-high-event" target="_blank">CPU高负载事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-battery-usage-event" target="_blank">24h功耗器件分解统计事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-audio-jank-event" target="_blank">音频卡顿事件介绍</a></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>external_log返回的路径是沙箱目录，非真实物理路径，应用有权限访问自己的沙箱目录，参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory" target="_blank">应用沙箱目录</a>。external_log日志空间受限，应用处理完日志文件后请及时删除。</p> </div></div></div> <div class="tiledSection"><h3 id="section1522715553719" class="firsth2">系统事件订阅机制<i class="anchor-icon anchor-icon-link" anchorid="section1522715553719" tips="复制节点链接"></i></h3></div> <p>应用调用HiAppEvent接口订阅系统事件，并生成一个共享目录。当应用进程发生故障，DFX系统抓取相关信息生成事件和日志，分享到应用共享目录。HiAppEvent监听到有事件发生回调给应用。</p> <p>原理如下图：</p> <p><span><img height="291.27000000000004" originheight="444" originwidth="797" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.48800190034301791622698661018264:50001231000000:2800:03FB743F34511704276BC30106F8A84EA0843E8BF7BB93F8DE2C5BEF378F983C.png" title="点击放大" width="523.6875"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>发生崩溃、卡死和地址越界故障时，应用会退出，所以需要在应用下次启动时才能获取到相应系统事件。</p> </div></div></div> <div class="tiledSection"><h2 id="section4706103193814">HiAppEvent系统事件订阅方法<i class="anchor-icon anchor-icon-link" anchorid="section4706103193814" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2748171473812" class="firsth2">订阅接口使用方法<i class="anchor-icon anchor-icon-link" anchorid="section2748171473812" tips="复制节点链接"></i></h3></div> <p>HiAppEvent提供addWatcher()接口可以订阅系统事件，支持三种订阅方式。</p> <p>方式一：设置回调条件triggerCondition，实现onTrigger()回调，满足回调条件自动触发回调。</p> <p>方式二：未设置回调条件参数，使用事件订阅返回的holder对象主动获取系统事件。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>主动获取系统事件，由于系统事件可能未生成或者日志信息未抓取完成，可能查询为空，可以尝试多次调用查询接口。</p> </div></div></div> <p>方式三：实现onReceive()回调，监听到订阅的事件生成后实时回调。</p> <p>ArkTS接口参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventaddwatcher" target="_blank">hiAppEvent.addWatcher</a>，C/C++接口参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-hiappevent-h#oh_hiappevent_addwatcher" target="_blank">OH_HiAppEvent_AddWatcher()</a>。</p> <div class="tiledSection"><h3 id="section2981153763815">参数扩展接口使用方法<i class="anchor-icon anchor-icon-link" anchorid="section2981153763815" tips="复制节点链接"></i></h3></div> <p>HiAppEvent提供setEventParam()接口可以在系统事件中添加自定义参数，当前支持在崩溃和卡死事件中增加自定义参数。ArkTS接口参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventseteventparam12" target="_blank">hiAppEvent.setEventParam</a>。</p> <p>使用接口完成参数键值对赋值。以在订阅崩溃事件中添加自定义参数为例，ArkTS接口示例代码如下：</p> <div _ngcontent-abg-c106="" class="highlight-div"><div _ngcontent-abg-c106="" class="highlight-div-header"><div _ngcontent-abg-c106="" class="highlight-div-header-left"><div _ngcontent-abg-c106="" class="handle-button expand-button"><div _ngcontent-abg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-abg-c106="" class="highlight-div-header-right"><div _ngcontent-abg-c106="" class="handle-button ai-button"></div><div _ngcontent-abg-c106="" class="handle-button line-button"><div _ngcontent-abg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-abg-c106="" class="handle-button theme-button"><div _ngcontent-abg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-abg-c106="" class="handle-button copy-button"><div _ngcontent-abg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-abg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hiAppEvent, hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, hiAppEvent.<span class="hljs-property">ParamType</span>&gt; = {</li><li>  <span class="hljs-string">"test_data"</span>: <span class="hljs-number">100</span>,</li><li>};</li><li><span class="hljs-comment">/* 添加崩溃事件的自定义参数 */</span></li><li><span class="hljs-comment">// domain.OS表示操作系统级事件</span></li><li><span class="hljs-comment">// event.APP_CRASH指定订阅崩溃事件类型</span></li><li>hiAppEvent.<span class="hljs-title function_">setEventParam</span>(params, hiAppEvent.<span class="hljs-property">domain</span>.<span class="hljs-property">OS</span>, hiAppEvent.<span class="hljs-property">event</span>.<span class="hljs-property">APP_CRASH</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent success to set event param`</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`HiAppEvent code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>});</li></ol></pre></div></div> <div class="tiledSection"><h2 id="section1046804823816">HiAppEvent系统事件订阅方案设计<i class="anchor-icon anchor-icon-link" anchorid="section1046804823816" tips="复制节点链接"></i></h2></div> <p>以崩溃采集为例，可参考如下设计：</p> <p><span><img originheight="728" originwidth="1211" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.86217768631345420902654751610494:50001231000000:2800:1CBC97DAD8A6AD114F9D68F0EA4B0F69C7D6612503C8488B56198023BB84AF67.png" width="920" height="553.0635838150289"></span></p> <ol><li>APM代码早于业务代码。</li><li>应用启动阶段注册ErrorManager，可以捕获JS异常，发生JsError崩溃时进程不会退出。参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs-V5/faqs-arkts-81-V5" target="_blank">如何使用ErrorManager捕获异常</a>。</li><li>在ErrorManager回调中执行takeNext接口获取JsError崩溃事件。</li><li>应用发生CPP Crash异常退出，下次启动获取NativeCrash崩溃事件。</li><li>获取的崩溃信息可以持久化存储，上传后再删除，避免上传失败导致数据丢失。</li><li>日志管理，external_log日志处理后（比如上传后）及时清理。</li></ol> </div> <div></div></div>