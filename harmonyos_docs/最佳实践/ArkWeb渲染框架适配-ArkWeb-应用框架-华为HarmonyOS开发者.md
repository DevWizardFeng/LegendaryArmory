<h1 _ngcontent-yyk-c119="" class="doc-title ng-star-inserted" title="ArkWeb渲染框架适配"> ArkWeb渲染框架适配 </h1>

<div _ngcontent-yyk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section11095349403">概述<i class="anchor-icon anchor-icon-link" anchorid="section11095349403" tips="复制节点链接"></i></h2><p>Hybrid应用开发是介于Web应用和系统应用两者之间的应用开发技术，兼具“系统应用良好交互体验”的优势和“Web应用跨平台开发”的优势。其主要原理是由Native通过JSBridge通道提供统一的API，然后用Html/CSS实现界面，JS来写业务逻辑，能够调用系统API，最终的页面在WebView中显示。</p> </div> <div class="tiledSection"><h2 id="section87751344114512">Hybrid应用鸿蒙化方案<i class="anchor-icon anchor-icon-link" anchorid="section87751344114512" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section71698293479" class="firsth2">整体架构<i class="anchor-icon anchor-icon-link" anchorid="section71698293479" tips="复制节点链接"></i></h3><p><span><img originheight="475" originwidth="608" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.30187506059402154713142695146559:50001231000000:2800:40C1D0D76062C21DD147ACB6090EF8E1CCC0FAF613FF0F84D3B7E2679AE74804.png" width="608" height="475"></span></p> <ol><li>Ark进程：由ArkTS引擎提供运行时，具备调用系统API的能力。应用启动从Ark进程进入，完成EntryAbility的初始化并创建HarmonyOS应用页面。Ark进程可以动态或者静态创建Webview运行时环境，并加载html/css/js资源文件。</li><li>Webview进程：默认支持标准W3C API，对ArkTS侧资源的访问有限制。Webview渲染能力主要由Web组件提供。用户可以通过Web组件的属性配置是否开启同层渲染能力、是否允许执行JavaScript脚本等。</li><li>JSBridge：上述两种进程的通讯机制，允许数据双向流动。Webview进程通过JSBridge通道访问拓展API。</li></ol> </div> <div class="tiledSection"><h3 id="section11246144216487">方案设计<i class="anchor-icon anchor-icon-link" anchorid="section11246144216487" tips="复制节点链接"></i></h3><p>Hybrid应用鸿蒙化方案主要集中在双端通信JSBridge实现、拓展接口实现和基于同层渲染的原生组件实现。JSBridge是前端与ArkTS进行双向通信的桥梁。通过JSBridge，前端应用能访问到ArkTS侧实现的拓展接口，实现更丰富的业务功能。视图层方面，可以使用系统提供的同层渲染能力，把部分性能要求比较高的前端组件改成ArkTS实现，以达到更好的体验效果。下图蓝色背景的方框图展示了上述三点所处的框架位置：</p> <p><span><img originheight="344" originwidth="866" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.28346439930252142497056308687043:50001231000000:2800:51A82C7A283FDB0B422351C6CD11E6E634E1739DB1D8BB70742C5239F82A8000.png" width="866" height="344"></span></p> </div> <div class="tiledSection"><h2 id="section4272192164219">业务实现中的关键点<i class="anchor-icon anchor-icon-link" anchorid="section4272192164219" tips="复制节点链接"></i></h2><p>Hybrid应用鸿蒙化方案主要围绕双端通信、API鸿蒙化、组件鸿蒙化三方面进行开发。双端通信：JS侧使用ArkTS的通道，是鸿蒙化的基石；API鸿蒙化：针对JS侧平台相关的API，提供一套HarmonyOS版本的实现；组件鸿蒙化：针对Web组件，以同层渲染的方式提供替代组件，以提升组件的性能与交互体验。</p> </div> <div class="tiledSection"><h3 id="section1672011288193" class="firsth2">双端通信<i class="anchor-icon anchor-icon-link" anchorid="section1672011288193" tips="复制节点链接"></i></h3><p>JSBridge扮演Webview进程与ArkUI主进程沟通的桥梁，是一种双向通信的机制。HarmonyOS系统提供Web组件以及@ohos.web.webview等ArkWeb API来进行Web开发。可以通过WebMessagePort以及javaScriptProxy代理的方式实现JSBridge。</p> <ol><li>WebMessagePort是一种比较基础的消息发送以及接收机制，支持的消息类型为string和ArrayBuffer，具体业务消息内容的封装和解析需要从零设计，存在上手难、工作量大的特点。</li><li>JavaScriptProxy代理机制注入ArkUI主进程对象（如命名为native）到Webview中，在Webview的window上生成对应代理对象，业务可以直接调用该代理对象的方法，相关的操作将作用到ArkUI主进程的native对象。代码实例如下：<div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L95-L130" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Web component loading H5.</span></li><li><span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">param</span>.<span class="hljs-title class_">path</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">webController</span> })</li><li>  .<span class="hljs-title function_">zoomAccess</span>(<span class="hljs-keyword">false</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-variable">Const</span>.<span class="hljs-variable">WEB_CONSTANT_WIDTH</span>)</li><li>  .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>  .<span class="hljs-title function_">margin</span>({</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_LEFT</span>, <span class="hljs-variable">right</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_RIGHT</span>,</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_TOP</span></li><li>  })</li><li>  .<span class="hljs-title function_">onErrorReceive</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">error</span>.<span class="hljs-title function_">getErrorInfo</span>() === <span class="hljs-string">'ERR_INTERNET_DISCONNECTED'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">internet_err</span>'),</li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_DURATION</span></li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">error</span>.<span class="hljs-title function_">getErrorInfo</span>() === <span class="hljs-string">'ERR_CONNECTION_TIMED_OUT'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">internet_err</span>'),</li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_DURATION</span></li><li>      });</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">onProgressChange</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">newProgress</span> === <span class="hljs-variable">Const</span>.<span class="hljs-variable">WEB_CONSTANT_PROGRESS_MAX</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">isLoading</span> = <span class="hljs-keyword">false</span>;</li><li>      <span class="hljs-title function_">clearInterval</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">intervalLoading</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">intervalLoading</span> = -<span class="hljs-number">1</span>;</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">javaScriptProxy</span>({</li><li>    <span class="hljs-variable">object</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">linkObj</span>,</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-string">'linkObj'</span>,</li><li>    <span class="hljs-variable">methodList</span>: [<span class="hljs-string">'messageFromHtml'</span>],</li><li>    <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">webController</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L95-L130" target="_blank">WebPage.ets</a></div></div></div></div> </li></ol> <p>前端可以使用native.makePhoneCall(..) 的方式进行调用。且方法的参数支持基本类型、字典对象、函数等，对于JSBridge的设计提供了便利。关于Web.javaScriptProxy()以及WebviewController.registerJavaScriptProxy()的使用方法可以参考《<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-in-page-app-function-invoking" target="_blank">前端页面调用应用侧函数</a>》。</p> <p>通过对比，javaScriptProxy注入对象的方式构造JSBridge是一个比较好的技术选型。建议JSBridge的实现基于注入机制进行设计，并考虑分层设计来提高其通用性和灵活性，下图展示一种分层设计思路：</p> <p><span><img originheight="543" originwidth="865" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.84161878867712925479551853137918:50001231000000:2800:25187D5444EB83F533366492386054823B7774E725CAC58B2221FE9CD761A403.png" width="865" height="543"></span></p> <ol><li>通信层：对上层屏蔽具体的通信机制，主要负责Web侧和ArkTS侧数据的传递，但不解析数据的业务含义，不关注传递的数据内容。数据可以序列化为字符串进行传递或者以object对象进行传递。使用javaScriptProxy代理机制实现的通信层代码示例如下：<div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L95-L130" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Web component loading H5.</span></li><li><span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">param</span>.<span class="hljs-title class_">path</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">webController</span> })</li><li>  .<span class="hljs-title function_">zoomAccess</span>(<span class="hljs-keyword">false</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-variable">Const</span>.<span class="hljs-variable">WEB_CONSTANT_WIDTH</span>)</li><li>  .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>  .<span class="hljs-title function_">margin</span>({</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_LEFT</span>, <span class="hljs-variable">right</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_RIGHT</span>,</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_MARGIN_TOP</span></li><li>  })</li><li>  .<span class="hljs-title function_">onErrorReceive</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">error</span>.<span class="hljs-title function_">getErrorInfo</span>() === <span class="hljs-string">'ERR_INTERNET_DISCONNECTED'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">internet_err</span>'),</li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_DURATION</span></li><li>      });</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">error</span>.<span class="hljs-title function_">getErrorInfo</span>() === <span class="hljs-string">'ERR_CONNECTION_TIMED_OUT'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">internet_err</span>'),</li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-title class_">Const</span>.<span class="hljs-title class_">WEB_CONSTANT_DURATION</span></li><li>      });</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">onProgressChange</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>?.<span class="hljs-variable">newProgress</span> === <span class="hljs-variable">Const</span>.<span class="hljs-variable">WEB_CONSTANT_PROGRESS_MAX</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">isLoading</span> = <span class="hljs-keyword">false</span>;</li><li>      <span class="hljs-title function_">clearInterval</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">intervalLoading</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">intervalLoading</span> = -<span class="hljs-number">1</span>;</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">javaScriptProxy</span>({</li><li>    <span class="hljs-variable">object</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">linkObj</span>,</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-string">'linkObj'</span>,</li><li>    <span class="hljs-variable">methodList</span>: [<span class="hljs-string">'messageFromHtml'</span>],</li><li>    <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">webController</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L95-L130" target="_blank">WebPage.ets</a></div></div></div></div> </li><li>通道层（Channel）：允许注册多种方法层通道。该层的JS侧实现负责把方法层的API信息对象（包含名称、参数、返回值类型等信息）打包成通信层识别的信息数据，交给通信层传递到ArkTS侧。ArkTS侧的实现包含两个主要功能，一个是把信息数据解包出API的信息，并交给ArkTS侧的方法层调用具体的API；另外一个功能就是执行jsCall，ArkTS侧通过WebviewController .runJavaScript()方法在执行JS侧的回调函数。<p>在JS侧，nativeCall()方法提供打包转换能力。如下面示例：</p> <div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/HttpServerOfWeb/public/js/index.js#L100-L102" data-highlighted="yes"><ol class="linenums"><li>function <span class="hljs-built_in">openDialog</span>() {</li><li>  linkObj<span class="hljs-selector-class">.messageFromHtml</span>(prizesArr[prizesPosition]);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/HttpServerOfWeb/public/js/index.js#L100-L102" target="_blank">index.js</a></div></div></div></div> <p>在ArkTS侧，通过runJavaScript()执行JS侧方法：</p> <div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L152-L162" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">Button</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.btnValue'</span>))</li><li>  <span class="hljs-selector-class">.fontSize</span>(Const.WEB_CONSTANT_BUTTON_FONT_SIZE)</li><li>  <span class="hljs-selector-class">.fontColor</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.color.start_window_background'</span>))</li><li>  <span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">top</span>: Const.WEB_CONSTANT_BUTTON_MARGIN_TOP })</li><li>  <span class="hljs-selector-class">.width</span>(Const.WEB_CONSTANT_BUTTON_WIDTH)</li><li>  <span class="hljs-selector-class">.height</span>(Const.WEB_CONSTANT_BUTTON_HEIGHT)</li><li>  <span class="hljs-selector-class">.backgroundColor</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.color.blue'</span>))</li><li>  <span class="hljs-selector-class">.borderRadius</span>(Const.WEB_CONSTANT_BUTTON_BORDER_RADIUS)</li><li>  <span class="hljs-selector-class">.onClick</span>(() =&gt; {</li><li>    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.webController</span><span class="hljs-selector-class">.runJavaScript</span>(<span class="hljs-string">'startDraw()'</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_codelabs/WebComponent/blob/master/entry/src/main/ets/pages/WebPage.ets#L152-L162" target="_blank">WebPage.ets</a></div></div></div></div> </li><li>方法层（MethodChannel）：可以针对一类API格式封装成一种MethodChannel。同种MethodChannel的API具备一致的参数规范、返回值规范，比如小程序API规范，这样便于把API的调用信息封装成结构化的信息对象，供给通道层进行传递。</li></ol> <p>JSBridge的设计是否合理关系到应用的性能，开发者也可以考虑是否需要批量缓存请求再统一发送请求来减少请求次数，或者把不变的请求结果进行缓存等等。</p> </div> <div class="tiledSection"><h3 id="section10185154755419">API鸿蒙化<i class="anchor-icon anchor-icon-link" anchorid="section10185154755419" tips="复制节点链接"></i></h3><p>H5业务设计中除了使用W3C API外，还可以使用ArkTS侧API拓展来访问设备。如下图所示：</p> <p><span><img originheight="107" originwidth="866" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.46886326008884239755499813551273:50001231000000:2800:52BF164F25D1367FA7BFF586B5A2FB7E3B416E1DCAAD9A47119287D63D149E80.png" width="866" height="107"></span></p> <p>系统高阶API是对系统API的一层封装，实现更符合业务要求的接口。拓展API的规范设计具有较大的灵活性，建议对API的参数，返回值类型格式进行限制，使用基本类型或者简单的字典对象，尽量避免使用复杂的类型的参数或返回值，可以参考比较成熟的小程序框架，其规范格式可以分成三种类型：</p> <ol><li>func(paramObj), 其中 paramObj包含基本类型的数据属性以及success/fail/complete()回调函数。</li><li>on/offFunc(callback), 注册和移除监听函数。</li><li>getXxManager(): obj, 获取某类功能的全局单例管理器，如文件管理器。管理器的方法也遵守上述两点规范。</li></ol> <p>设计过程中可以把API都汇聚到一个对象作为属性字段存在，方便在切面视角增加统一的参数、返回值加工处理，拦截处理。示意图如下：</p> <p><span><img originheight="359" originwidth="742" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.52345833107298687765914877467516:50001231000000:2800:4A5F100AEA77C4D0FE5708D724D70EF7C88968F22326DF9FF67AB99A5446453D.png" width="742" height="359"></span></p> </div> <div class="tiledSection"><h3 id="section1566293815469">组件鸿蒙化<i class="anchor-icon anchor-icon-link" anchorid="section1566293815469" tips="复制节点链接"></i></h3><p>HarmonyOS提供同层渲染能力把原生组件直接渲染到WebView层级，从而获得更大的灵活性以及性能上获得更好表现。开发者可通过Web组件同层渲染相关属性来进行控制：enableNativeEmbedMode开关控制；onNativeEmbedLifecycleChange处理同层渲染生命周期：CREATE/UPDATE/DESTROY；onNativeEmbedGestureEvent处理交互事件。同层渲染功能要求前端页面文件中显式使用embed标签，并且embed标签内type必须以“native/”开头。使用Vue等框架可以方便地进一步封装embed标签生成自定义组件，并增加更多属性、事件和方法，通过JSBridge与ArkTS侧进行同步。在ArkTS侧，对应地需要自定义实现一个原生组件或者使用系统内置组件，通过NodeContainer组件进行动态挂载。同层渲染的原理如下：</p> <p>开发角度：前端页面开发者使用&lt;embed&gt;标签来表示使用原生组件；应用开发者使用NodeContainer关联离屏节点树，使用makeNode()接口在H5页面上渲染出组件。</p> <p><span><img originheight="348" originwidth="812" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.55957685182613222997193275159875:50001231000000:2800:DA1A2FBF29AD8F054EF6AA1EBF5BF1CE6C46134D350AA8223C3CAE7A104ACC4C.png" width="812" height="348"></span></p> <p>离屏节点动态上下树：</p> <p><span><img originheight="505" originwidth="758" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.48091089990869699768697275114235:50001231000000:2800:E990AC8B785DE18513A5663639F18AF8AF56FEBAA7215DA7DC48D5E9E673F567.png" width="758" height="505"></span></p> <p>1）开发者初始构建一个NodeContainer对象表示一个空的占位符。NodeContainer里面内容为空时，在初始化的时候大小为0，不参与布局。</p> <p>2）NodeController持有buildnode对象，通过makeNode()接口将buildnode对象返回给NodeContainer，来实现动态上树。</p> <p>3） NodeController里面rebuild()方法，触发NodeContainer重新调用makeNode()接口。 makeNode()接口若返回空，则实现动态下树。</p> <p>使用H5结合embed标签示例：</p> <div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/resources/rawfile/embed_view.html#L9-L13" data-highlighted="yes"><ol class="linenums"><li>&lt;div&gt;</li><li>    &lt;div <span class="hljs-built_in">id</span>=<span class="hljs-string">"bodyId"</span>&gt;</li><li>        &lt;embed <span class="hljs-built_in">id</span>=<span class="hljs-string">"nativeSearch"</span> <span class="hljs-built_in">type</span> = <span class="hljs-string">"native/component"</span> width=<span class="hljs-string">"100%"</span> height=<span class="hljs-string">"100%"</span> src=<span class="hljs-string">"view"</span>/&gt;</li><li>    &lt;/div&gt;</li><li>&lt;/div&gt;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/resources/rawfile/embed_view.html#L9-L13" target="_blank">embed_view.html</a></div></div></div></div> <p>在ArkTS侧，可以扩展NodeController来统一管理同层渲染节点。其makeNode()接口实现示例如下：</p> <div class="screenLinkPre"><div _ngcontent-yyk-c106="" class="highlight-div"><div _ngcontent-yyk-c106="" class="highlight-div-header"><div _ngcontent-yyk-c106="" class="highlight-div-header-left"><div _ngcontent-yyk-c106="" class="handle-button expand-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-yyk-c106="" class="highlight-div-header-right"><div _ngcontent-yyk-c106="" class="handle-button ai-button"></div><div _ngcontent-yyk-c106="" class="handle-button line-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-yyk-c106="" class="handle-button theme-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-yyk-c106="" class="handle-button copy-button"><div _ngcontent-yyk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-yyk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/ets/pages/Index.ets#L16-L219" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">PRODUCT_DATA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/GoodsViewModel'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">ProductDataModel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/GoodsModel'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BuilderNode</span>, <span class="hljs-variable">FrameNode</span>, <span class="hljs-variable">NodeController</span>, <span class="hljs-variable">NodeRenderType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-comment">// Margin vertical</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">MARGIN_VERTICAL</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">8</span>;</li><li><span class="hljs-comment">// Font weight</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">FONT_WEIGHT</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">500</span>;</li><li><span class="hljs-comment">// Placeholder</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">PLACEHOLDER</span>: <span class="hljs-title class_">ResourceStr</span> = $<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.embed_search'</span>);</li><li>
</li><li><span class="hljs-variable">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeControllerParams</span> {</li><li>  <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span>;</li><li>  <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchNodeController</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span> = <span class="hljs-variable">NodeRenderType</span>.<span class="hljs-variable">RENDER_TYPE_DISPLAY</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentType</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 设置渲染参数</span></li><li><span class="hljs-comment">   * </span></li><li><span class="hljs-comment">   * @param params 渲染参数</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">setRenderOption</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">NodeControllerParams</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">surfaceId</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">renderType</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">renderType</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">embedId</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">embedId</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentWidth</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">width</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentHeight</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">height</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentType</span> = <span class="hljs-variable">params</span>.<span class="hljs-keyword">type</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * 创建节点</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * @param uiContext UIContext</span></li><li><span class="hljs-comment">   * @returns 节点</span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">BuilderNode</span>(<span class="hljs-variable">uiContext</span>, { <span class="hljs-variable">surfaceId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">surfaceId</span>, <span class="hljs-keyword">type</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">renderType</span> });</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">componentType</span> === <span class="hljs-string">'native/component'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">searchBuilder</span>), { <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">componentWidth</span>, <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">componentHeight</span> });</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setBuilderNode</span>(<span class="hljs-variable">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Params</span>[]&gt; | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span> = <span class="hljs-variable">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getBuilderNode</span>(): <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateNode</span>(<span class="hljs-variable">arg</span>: <span class="hljs-title class_">Object</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>?.<span class="hljs-title function_">update</span>(<span class="hljs-variable">arg</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getEmbedId</span>(): <span class="hljs-title class_">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">embedId</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">postEvent</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">TouchEvent</span> | <span class="hljs-title class_">undefined</span>): <span class="hljs-title class_">boolean</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>?.<span class="hljs-title function_">postTouchEvent</span>(<span class="hljs-variable">event</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">boolean</span>;</li><li>  }</li><li>}</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SearchComponent</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">params</span>: <span class="hljs-title class_">Params</span>;</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">SearchController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SearchController</span>()</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>      <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_mall"</span>))</li><li>        .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body4'</span>))</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-variable">FONT_WEIGHT</span>)</li><li>        .<span class="hljs-title function_">fontFamily</span>(<span class="hljs-string">'HarmonyHeiTi-Medium'</span>)</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Search</span>({ <span class="hljs-variable">placeholder</span>: <span class="hljs-title class_">PLACEHOLDER</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>      .<span class="hljs-title function_">margin</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.integer.embed_row_margin"</span>))</li><li>
</li><li>      <span class="hljs-title function_">Grid</span>() {</li><li>        <span class="hljs-title function_">ForEach</span>(<span class="hljs-variable">PRODUCT_DATA</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">GridItem</span>() {</li><li>            <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>              <span class="hljs-title function_">Image</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">imageRes</span>).<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.integer.embed_image_size"</span>))</li><li>              <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">title</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body1'</span>))</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>                  .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>                  .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-variable">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-title class_">Ellipsis</span> })</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">price</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body1'</span>))</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>                  .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>              }</li><li>            }</li><li>            .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_background'</span>))</li><li>            .<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>            .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>            .<span class="hljs-title function_">borderRadius</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_corner_radius_default_m'</span>))</li><li>          }</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">index</span>.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">rowsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_elements_margin_vertical_m'</span>))</li><li>      .<span class="hljs-title function_">columnsGap</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_elements_margin_vertical_m'</span>))</li><li>      .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>      .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_sixty_percent"</span>))</li><li>      .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_card_margin_start'</span>))</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">width</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">height</span>)</li><li>  }</li><li>}</li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">searchBuilder</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">SearchComponent</span>({ <span class="hljs-variable">params</span>: <span class="hljs-title class_">params</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-variable">browserTabController</span>: <span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">componentIdArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt; = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">nodeControllerMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">SearchNodeController</span>&gt; = <span class="hljs-variable">new</span> <span class="hljs-title function_">Map</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>, (<span class="hljs-variable">componentId</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>        <span class="hljs-title function_">NodeContainer</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>));</li><li>      }, (<span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">embedId</span>)</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>("<span class="hljs-title class_">embed_view</span>.<span class="hljs-title class_">html</span>"), <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">browserTabController</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>        .<span class="hljs-title function_">zoomAccess</span>(<span class="hljs-keyword">false</span>)</li><li>        .<span class="hljs-title function_">enableNativeEmbedMode</span>(<span class="hljs-keyword">true</span>)</li><li>        .<span class="hljs-title function_">onNativeEmbedLifecycleChange</span>((<span class="hljs-variable">embed</span>) =&gt; {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">componentId</span> = <span class="hljs-variable">embed</span>.<span class="hljs-variable">info</span>?.<span class="hljs-variable">id</span>?.<span class="hljs-title function_">toString</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">embed</span>.<span class="hljs-variable">status</span> === <span class="hljs-variable">NativeEmbedStatus</span>.<span class="hljs-variable">CREATE</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SearchNodeController</span>();</li><li>            <span class="hljs-variable">nodeController</span>.<span class="hljs-title function_">setRenderOption</span>({</li><li>              <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">surfaceId</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-keyword">type</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-keyword">type</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span>.<span class="hljs-title class_">RENDER_TYPE_TEXTURE</span>,</li><li>              <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">embedId</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">width</span>),</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">height</span>)</li><li>            });</li><li>            <span class="hljs-variable">nodeController</span>.<span class="hljs-title function_">rebuild</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">componentId</span>, <span class="hljs-variable">nodeController</span>);</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">componentId</span>);</li><li>          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">embed</span>.<span class="hljs-variable">status</span> === <span class="hljs-variable">NativeEmbedStatus</span>.<span class="hljs-variable">UPDATE</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">updateNode</span>({</li><li>              <span class="hljs-variable">text</span>: <span class="hljs-string">'update'</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">width</span>),</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">height</span>)</li><li>            } <span class="hljs-keyword">as</span> <span class="hljs-variable">ESObject</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">rebuild</span>();</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">setBuilderNode</span>(<span class="hljs-variable">null</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">rebuild</span>();</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">onNativeEmbedGestureEvent</span>((<span class="hljs-variable">touch</span>) =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">componentId</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">getEmbedId</span>() === <span class="hljs-variable">touch</span>.<span class="hljs-variable">embedId</span>) {</li><li>              <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">postEvent</span>(<span class="hljs-variable">touch</span>.<span class="hljs-variable">touchEvent</span>);</li><li>            }</li><li>          })</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/ets/pages/Index.ets#L16-L219" target="_blank">Index.ets</a></div></div></div></div> <p>实现中可以使用map容器把embedType和离屏节点的builder()函数进行关联，当makeNode()执行时，取出embedType对应的builder()函数来创建rootNode节点，最后把rootNode节点关联的FrameNode返回，达到离屏节点动态上树、H5渲染出原生组件的效果。同层渲染可以参考文档《<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-same-layer" target="_blank">同层渲染绘制Video和Button组件</a>》</p> </div> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_codelabs/WebComponent" target="_blank">基于Web组件实现随机抽奖功能</a></li><li><a href="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering" target="_blank">基于ArkWeb实现系统原生组件渲染至H5页面上</a></li></ul> </div> </div> <div></div></div>