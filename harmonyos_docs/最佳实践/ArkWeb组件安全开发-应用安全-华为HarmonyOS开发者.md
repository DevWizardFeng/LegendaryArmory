<h1 _ngcontent-fhd-c119="" class="doc-title ng-star-inserted" title="ArkWeb组件安全开发"> ArkWeb组件安全开发 </h1>

<div _ngcontent-fhd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1089596171114">概述<i class="anchor-icon anchor-icon-link" anchorid="section1089596171114" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section125004240593" class="firsth2">目标<i class="anchor-icon anchor-icon-link" anchorid="section125004240593" tips="复制节点链接"></i></h3><p>本文旨在指导应用开发者在Hybrid混合应用开发模式下安全地使用ArkWeb组件。Hybrid混合开发指，开发者通过Web H5技术构建可动态加载与渲染的页面（如商品推广、隐私政策等），并通过应用内置的ArkWeb组件进行展示。同时，开发者可依托<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkweb-ndk-jsbridge" target="_blank">JSBridge</a>的能力，让Web页面能够方便地使用应用原生功能，例如获取地理位置、调用摄像头甚至移动支付等功能。</p> <p>该模式在提升开发灵活性与Web交互能力的同时，也使大量敏感能力暴露至Web侧，显著扩大攻击面。此外，诸如跨站脚本攻击、身份混淆、明文数据传输等常见Web漏洞，会进一步削弱混合应用的整体安全性，增加了恶意代码注入、权限滥用、敏感信息泄露等高危风险的发生概率。</p> <p>因此，本文基于大量真实漏洞案例，为应用开发者提供了若干关于ArkWeb安全开发的最佳实践，涵盖<a href="/consumer/cn/doc/best-practices/bpta-arkweb-component-security#section37021234194614">安全的Web资源访问</a>、<a href="/consumer/cn/doc/best-practices/bpta-arkweb-component-security#section18547133101712">恰当的权限管控</a>、<a href="/consumer/cn/doc/best-practices/bpta-arkweb-component-security#section74092496444">确保敏感数据传输安全</a>三种典型开发场景，以系统性提升应用的整体安全水平。</p> </div> <div class="tiledSection"><h3 id="section16765232114">适用范围<i class="anchor-icon anchor-icon-link" anchorid="section16765232114" tips="复制节点链接"></i></h3><p>本文适用于采用ArkWeb组件进行混合开发的应用，包括加载动态H5页面、JSBridge调用原生能力等场景。</p> <p>注：纯网页浏览、资源搜索等需要访问全网内容的场景（例如开发浏览器应用）不受本文限制。</p> </div> <div class="tiledSection"><h2 id="section37021234194614">安全的Web资源访问<i class="anchor-icon anchor-icon-link" anchorid="section37021234194614" tips="复制节点链接"></i></h2></div> <p>遵循以下最佳实践使用ArkWeb进行Web资源访问，能够提升Web运行环境的可信度，保护应用的关键业务和数据。</p> <div class="tiledSection"><h3 id="设置允许加载白名单来限制arkweb组件加载的网页内容" class="firsth2">设置允许加载白名单来限制ArkWeb组件加载的网页内容<i class="anchor-icon anchor-icon-link" anchorid="设置允许加载白名单来限制arkweb组件加载的网页内容" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>开发者应当限制ArkWeb仅能加载受信任的业务网页，而非任意来源的网页。建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#seturltrustlist12" target="_blank">setUrlTrustList()</a>为ArkWeb配置允许加载白名单。配置成功后，ArkWeb组件能够在网页加载或跳转前自动校验目标URL，仅允许符合白名单的URL被加载或跳转，其他URL将被自动拦截，同时展示告警页。</p> <p><strong>【风险说明】</strong></p> <p>攻击者会向应用ArkWeb中加载恶意URL，其具体影响因ArkWeb使用环境而异，可能会导致账户劫持、隐私泄露、任意代码执行等严重后果。</p> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/SetURLTrustList.ets#L17-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">urlTrustList</span>: <span class="hljs-built_in">string</span> =</li><li>    <span class="hljs-string">'{\'UrlPermissionList\':[{\'scheme\':\'https\', \'host\':\'trust.example.com\', \'port\':80, \'path\':\'test\'}]}'</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Setting the trustList'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Set up an allowlist to allow access only to trusted web pages.</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setUrlTrustList</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">urlTrustList</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Access the trust web'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Allowlist activated, access to trusted web pages is permitted.</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">'https://trust.example.com/test'</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Access the untrusted web'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Allowlist activated, blocking access to untrusted web and displaying an alarm page.</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">'http://untrust.example.com/test'</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/SetURLTrustList.ets#L17-L62" target="_blank">SetURLTrustList.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免将不可信域名配置到允许加载白名单">避免将不可信域名配置到允许加载白名单<i class="anchor-icon anchor-icon-link" anchorid="避免将不可信域名配置到允许加载白名单" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>避免将公共CDN域名（如cdn.example.com）等非业务拥有者专属的域名配置到允许加载白名单中。</p> <p><strong>【风险说明】</strong></p> <p>攻击者可能绕过允许加载白名单，加载恶意URL。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/SetURLTrustList.ets#L17-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">webviewController</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">urlTrustList</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'{\'UrlPermissionList\':'</span></li><li>    + <span class="hljs-string">'[{\'scheme\':\'https\', \'host\':\'cdnjs.cloudflare.com\'},'</span> <span class="hljs-comment">// Public CDN domains are untrusted.</span></li><li>    + <span class="hljs-string">'{\'scheme\':\'https\', \'host\':\'cdn.ampproject.org\'}]}'</span> <span class="hljs-comment">// Public service domains are at risk of being abused.</span></li><li>  <span class="hljs-attr">urlStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span> <span class="hljs-comment">// Any URL to be loaded.</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">urlStr</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span> })</li><li>        .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">onControllerAttached</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">setUrlTrustList</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">urlTrustList</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/SetURLTrustList.ets#L17-L44" target="_blank">SetURLTrustList.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="加载外部来源的脚本或资源时务必对不可信内容进行安全校验或过滤">加载外部来源的脚本或资源时，务必对不可信内容进行安全校验或过滤<i class="anchor-icon anchor-icon-link" anchorid="加载外部来源的脚本或资源时务必对不可信内容进行安全校验或过滤" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">WebviewController</a>提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loaddata" target="_blank">loadData()</a>方法用于加载资源，以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascript" target="_blank">runJavaScript()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascriptext10" target="_blank">runJavaScriptExt()</a>方法用于执行脚本，并通过回调方式返回脚本执行结果。</p> <p>若待加载的JavaScript脚本或者资源来自外部可控的不可信来源（例如通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want#want" target="_blank">Want</a>传入），务必在加载前对资源内容进行检查和过滤。</p> <p><strong>【风险说明】</strong></p> <p>如果加载的资源或者脚本不可信，则会导致恶意代码注入，造成跨站脚本攻击（XSS）；此外，若ArkWeb组件注册了敏感JavaScriptProxy接口，还可能导致<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>接口被恶意调用，影响Hybrid应用安全性。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/LoadURL.ets#L29-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>  .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>  .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">jsMethod</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'alert("xss")'</span> <span class="hljs-comment">// External controlled string</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(jsMethod)</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'result: '</span> + result);</li><li>        })</li><li>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'error: '</span> + error);</li><li>        })</li><li>      <span class="hljs-keyword">if</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'url: '</span>, error.<span class="hljs-property">url</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${error.code}</span>, Message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/LoadURL.ets#L29-L47" target="_blank">LoadURL.ets</a></div></div></div></div> <p>index.html内容如下：</p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L18-L29" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml">Hello world!</span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></span></li><li><span class="language-xml">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-xml">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Ark WebComponent'</span>)</span></li><li><span class="language-xml">        <span class="hljs-keyword">return</span> <span class="hljs-string">"This value is from index.html"</span></span></li><li><span class="language-xml">    }</span></li><li><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L18-L29" target="_blank">index.html</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/LoadURL.ets#L29-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>  .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>  .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> whiteMethods = [<span class="hljs-string">'test()'</span>]</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">jsMethod</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'alert("xss")'</span> <span class="hljs-comment">// External controlled string</span></li><li>      <span class="hljs-keyword">if</span> (whiteMethods.<span class="hljs-title function_">indexOf</span>(jsMethod) === -<span class="hljs-number">1</span>) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'input method not in whiteList'</span>)</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(jsMethod)</li><li>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'result: '</span> + result);</li><li>        })</li><li>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'error: '</span> + error);</li><li>        })</li><li>      <span class="hljs-keyword">if</span> (event) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'url: '</span>, event.<span class="hljs-property">url</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>: <span class="hljs-title class_">BusinessError</span> = error;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${e.code}</span>, Message: <span class="hljs-subst">${e.message}</span>`</span>);</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/LoadURL.ets#L29-L53" target="_blank">LoadURL.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="若要在oninterceptrequest中加载本地文件务必校验文件url以防止本地数据被窃取">若要在onInterceptRequest中加载本地文件，务必校验文件URL，以防止本地数据被窃取<i class="anchor-icon anchor-icon-link" anchorid="若要在oninterceptrequest中加载本地文件务必校验文件url以防止本地数据被窃取" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#oninterceptrequestevent12" target="_blank">onInterceptRequest()</a>拦截URL资源访问，可以定制返回状态、内容等Response报文。若应用需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourcerequest#getrequesturl" target="_blank">getRequestUrl()</a>打开本地文件，务必对URL进行路径检查，并判断是否存在路径遍历符号“../”，防止目录穿越。</p> <p><strong>【风险说明】</strong></p> <p>目录穿越是指攻击者能够利用路径遍历符访问到本不应该读取的目录下的文件，一旦被利用，则可能导致应用内敏感文件遭到窃取，甚至造成远程代码执行等严重安全后果。</p> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/OnInterceptRequest.ets#L17-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">responseWeb</span>: <span class="hljs-title class_">WebResourceResponse</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebResourceResponse</span>();</li><li>  <span class="hljs-attr">heads</span>: <span class="hljs-title class_">Header</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>      <span class="hljs-comment">// Intercept URL resource access through onInterceptRequest and customize the response message.</span></li><li>        .<span class="hljs-title function_">onInterceptRequest</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-comment">// The URL passed by event.request.getRequestUrl() should be restricted to a specific path,</span></li><li>          <span class="hljs-comment">// and the presence of '../' should be checked.</span></li><li>          <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getRequestUrl</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'file:///data/trusted_path'</span>) &amp;&amp;</li><li>            event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getRequestUrl</span>().<span class="hljs-title function_">includes</span>(<span class="hljs-string">'../'</span>) !== <span class="hljs-literal">true</span>) {</li><li>            <span class="hljs-keyword">try</span> {</li><li>              <span class="hljs-keyword">let</span> file =</li><li>                fileIo.<span class="hljs-title function_">openSync</span>(event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getRequestUrl</span>(), fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">arrayBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">6</span>);</li><li>              fileIo.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, arrayBuffer, { <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">length</span>: arrayBuffer.<span class="hljs-property">byteLength</span> });</li><li>              fileIo.<span class="hljs-title function_">closeSync</span>(file);</li><li>              <span class="hljs-keyword">let</span> decoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>);</li><li>              <span class="hljs-keyword">let</span> stringData = decoder.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer));</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">head1</span>: <span class="hljs-title class_">Header</span> = {</li><li>                <span class="hljs-attr">headerKey</span>: <span class="hljs-string">'Connection'</span>,</li><li>                <span class="hljs-attr">headerValue</span>: <span class="hljs-string">'keep-alive'</span></li><li>              }</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">head2</span>: <span class="hljs-title class_">Header</span> = {</li><li>                <span class="hljs-attr">headerKey</span>: <span class="hljs-string">'Cache-Control'</span>,</li><li>                <span class="hljs-attr">headerValue</span>: <span class="hljs-string">'no-cache'</span></li><li>              }</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">heads</span>.<span class="hljs-title function_">push</span>(head1);</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">heads</span>.<span class="hljs-title function_">push</span>(head2);</li><li>
</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">String</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseHeader</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">heads</span>);</li><li>                <span class="hljs-comment">// After the file is read, it will be encapsulated and the response will be called back to the web page.</span></li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseData</span>(stringData);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseEncoding</span>(<span class="hljs-string">'utf-8'</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseMimeType</span>(<span class="hljs-string">'text/html'</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseCode</span>(<span class="hljs-number">200</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setReasonMessage</span>(<span class="hljs-string">'OK'</span>);</li><li>                <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'success'</span>);</li><li>              })</li><li>              promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'prepare response ready'</span>);</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseIsReady</span>(<span class="hljs-literal">true</span>);</li><li>              })</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>.<span class="hljs-title function_">setResponseIsReady</span>(<span class="hljs-literal">false</span>);</li><li>            } <span class="hljs-keyword">catch</span> (error) {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${error.code}</span>, Message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>            }</li><li>          }</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseWeb</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/OnInterceptRequest.ets#L17-L80" target="_blank">OnInterceptRequest.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免在允许跨域访问的本地文件目录中包含敏感资源">避免在允许跨域访问的本地文件目录中包含敏感资源<i class="anchor-icon anchor-icon-link" anchorid="避免在允许跨域访问的本地文件目录中包含敏感资源" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>ArkWeb默认不允许跨域访问本地文件资源，除非使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#setpathallowinguniversalaccess12" target="_blank">setPathAllowingUniversalAccess()</a>设置了允许跨域访问的本地文件目录。在此情况下，务必最小化允许访问的文件目录范围，且目录中不得存放敏感资源，如用户数据、cookie、各类token等。</p> <p>注：鸿蒙系统仅开放针对应用文件目录（Context.filesDir）、应用资源目录（Context.resourceDir）设置允许跨域访问。若设置路径列表不符合要求，则会导致设置失败。</p> <p><strong>【风险说明】</strong></p> <p>若设置了允许跨域访问本地文件目录，可能会让攻击者访问本地文件，导致敏感资源泄露，并发起“应用克隆攻击”。</p> </div> <div class="tiledSection"><h3 id="避免http与https混合内容加载">避免HTTP与HTTPS混合内容加载<i class="anchor-icon anchor-icon-link" anchorid="避免http与https混合内容加载" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-attributes#mixedmode" target="_blank">mixedMode()</a>设置是否允许加载超文本传输协议（HTTP）和超文本传输安全协议（HTTPS）的混合内容，ArkWeb默认不允许加载HTTP和HTTPS的混合内容（mixedMode默认设为None），应当避免设置为All。开发者若在调试场景下需要访问HTTP，则务必在调试完成后将mixedMode设置为None。</p> <p><strong>【风险说明】</strong></p> <p>若允许ArkWeb组件同时加HTTP和HTTPS的混合内容，则会引入中间人攻击风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/MixedMode.ets#L26-L27" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-string">'www.huawei.com'</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>  .<span class="hljs-title function_">mixedMode</span>(<span class="hljs-variable">MixedMode</span>.<span class="hljs-variable">All</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/MixedMode.ets#L26-L27" target="_blank">MixedMode.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/MixedMode.ets#L26-L27" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-string">'www.huawei.com'</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>  .<span class="hljs-title function_">mixedMode</span>(<span class="hljs-variable">MixedMode</span>.<span class="hljs-variable">None</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/MixedMode.ets#L26-L27" target="_blank">MixedMode.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免在ssl校验出错时继续加载页面">避免在SSL校验出错时继续加载页面<i class="anchor-icon anchor-icon-link" anchorid="避免在ssl校验出错时继续加载页面" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>当用户加载的网页资源发生SSL校验错误（如目标网站的证书或协议校验出现错误），ArkWeb组件会通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onsslerrorevent12" target="_blank">onSslErrorEvent()</a>通知应用。默认情况下，ArkWeb组件会取消加载发生该错误的资源，若业务场景要求继续执行，开发者务必在调用confirm之前做显式校验或者说明。建议使用onSslErrorEvent捕获全量资源错误，不建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onsslerroreventreceive9" target="_blank">onSslErrorEventReceive()</a>。</p> <p><strong>【风险说明】</strong></p> <p>如果在SSL校验出错时忽略SSL错误并继续加载，容易导致中间人攻击等风险。</p> <p><strong>例外情况：</strong>用于加载全网URL的应用（例如浏览器）可以例外，但需要在页面显式告知用户待加载页面存在安全风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/OnSslErrorEventReceive.ets#L17-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>        .<span class="hljs-title function_">onSslErrorEvent</span>((<span class="hljs-variable">event</span>: <span class="hljs-title class_">SslErrorEvent</span>) =&gt; {</li><li>          <span class="hljs-variable">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ssl check failed, error is: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">error</span>.<span class="hljs-title function_">toString</span>());</li><li>          <span class="hljs-variable">event</span>.<span class="hljs-variable">handler</span>.<span class="hljs-title function_">handleConfirm</span>();</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/OnSslErrorEventReceive.ets#L17-L33" target="_blank">OnSslErrorEventReceive.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/OnSslErrorEventReceive.ets#L17-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>        .<span class="hljs-title function_">onSslErrorEvent</span>((<span class="hljs-variable">event</span>: <span class="hljs-title class_">SslErrorEvent</span>) =&gt; {</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent url: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">url</span>);</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent error: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">error</span>);</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent originalUrl: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">originalUrl</span>);</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent referrer: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">referrer</span>);</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent isFatalError: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">isFatalError</span>);</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'onSslErrorEvent isMainFrame: '</span> + <span class="hljs-variable">event</span>.<span class="hljs-variable">isMainFrame</span>);</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>({</li><li>            <span class="hljs-variable">title</span>: <span class="hljs-string">'onSslErrorEvent'</span>,</li><li>            <span class="hljs-variable">message</span>: <span class="hljs-string">'text'</span>,</li><li>            <span class="hljs-variable">primaryButton</span>: {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'Confirm'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-variable">event</span>.<span class="hljs-variable">handler</span>.<span class="hljs-title function_">handleConfirm</span>();</li><li>              }</li><li>            },</li><li>            <span class="hljs-variable">secondaryButton</span>: {</li><li>              <span class="hljs-variable">value</span>: <span class="hljs-string">'cancel'</span>,</li><li>              <span class="hljs-variable">action</span>: () =&gt; {</li><li>                <span class="hljs-variable">event</span>.<span class="hljs-variable">handler</span>.<span class="hljs-title function_">handleCancel</span>();</li><li>              }</li><li>            },</li><li>            <span class="hljs-variable">cancel</span>: () =&gt; {</li><li>              <span class="hljs-variable">event</span>.<span class="hljs-variable">handler</span>.<span class="hljs-title function_">handleCancel</span>();</li><li>            }</li><li>          })</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/OnSslErrorEventReceive.ets#L17-L57" target="_blank">OnSslErrorEventReceive.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="正式release版本务必关闭arkweb的网页调试功能">正式Release版本务必关闭ArkWeb的网页调试功能<i class="anchor-icon anchor-icon-link" anchorid="正式release版本务必关闭arkweb的网页调试功能" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#setwebdebuggingaccess" target="_blank">setWebDebuggingAccess()</a>可以用于开启ArkWeb网页调试功能，默认配置下，调试功能处于关闭状态。在正式Release版本上务必保持关闭该功能。</p> <p><strong>【风险说明】</strong></p> <p>若开发者主动开启调试功能，将增加业务对外接口被恶意利用的风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/WebDebug.ets#L26-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">setWebDebuggingAccess</span>(<span class="hljs-literal">true</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/WebDebug.ets#L26-L30" target="_blank">WebDebug.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section18547133101712">恰当的权限管控<i class="anchor-icon anchor-icon-link" anchorid="section18547133101712" tips="复制节点链接"></i></h2></div> <p>遵循以下最佳实践，确保ArkWeb运行时满足最小特权原则，仅授予受信任的Web页面所需权限。</p> <div class="tiledSection"><h3 id="注册javascriptproxy接口时务必同时设置允许调用白名单来检查调用接口的页面身份" class="firsth2">注册JavaScriptProxy接口时，务必同时设置允许调用白名单检查调用接口的页面身份<i class="anchor-icon anchor-icon-link" anchorid="注册javascriptproxy接口时务必同时设置允许调用白名单来检查调用接口的页面身份" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>接口，尤其是访问敏感资源的接口，务必在调用前通过白名单来检查调用页面的合法性，以满足最小特权原则。建议开发者在注册JavaScriptProxy时，通过设置permission参数配置允许调用接口白名单。完成配置后，当Web侧调用该JavaScriptProxy接口时，ArkWeb会对调用页面的URL进行检查，仅符合白名单要求的URL的请求才会被允许，其余请求将被拦截。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>避免利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onpagebegin" target="_blank">onPageBegin()</a>等生命周期函数自行实现接口白名单校验，务必统一通过permission参数进行控制。</p> </div></div></div> <p><strong>【风险说明】</strong></p> <p>通过JavaScriptProxy接口注册的方法能被攻击者利用，导致加载恶意内容、执行恶意代码、滥用敏感资源等风险。</p> <p></p> <p>参考文档：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-in-page-app-function-invoking#如何建立应用侧与h5侧的交互通道" target="_blank">建立应用侧与H5侧交互通道</a></p> </div> <div class="tiledSection"><h3 id="注册javascriptproxy接口时遵循最小必要原则">注册JavaScriptProxy接口时遵循最小必要原则<i class="anchor-icon anchor-icon-link" anchorid="注册javascriptproxy接口时遵循最小必要原则" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>仅向Web页面注册业务必须的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>接口，建议避免将调试接口、内部逻辑接口等直接暴露给Web页面。同时，开发者应通过设置访问控制（例如允许调用白名单）检查调用者的合法性。</p> <p><strong>【风险说明】</strong></p> <p>若暴露的接口涉及返回敏感信息或执行敏感操作，一旦被攻击者调用，将导致账户仿冒攻击、执行恶意代码等风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/JavaScriptProxy.ets#L17-L45" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">InsecureObj</span> {</li><li>  <span class="hljs-title function_">executeSQL</span>(<span class="hljs-variable">cmd</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-comment">// Do something dangerous here</span></li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'Execute: '</span> + <span class="hljs-variable">cmd</span>);</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>  <span class="hljs-variable">testObj</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">InsecureObj</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>        .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-keyword">true</span>)</li><li>        .<span class="hljs-title function_">javaScriptProxy</span>({</li><li>          <span class="hljs-variable">object</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">testObj</span>,</li><li>          <span class="hljs-variable">name</span>: <span class="hljs-string">'objName'</span>,</li><li>          <span class="hljs-variable">methodList</span>: [<span class="hljs-string">'executeSQL'</span>],</li><li>          <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span>,</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/JavaScriptProxy.ets#L17-L45" target="_blank">JavaScriptProxy.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免在onoverrideurlloading中进行页面加载">避免在onOverrideUrlLoading中进行页面加载<i class="anchor-icon anchor-icon-link" anchorid="避免在onoverrideurlloading中进行页面加载" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>当URL将要加载到Web组件中时，Hybrid应用可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onoverrideurlloading12" target="_blank">onOverrideUrlLoading()</a>接收通知，接管加载流程的控制权。onOverrideUrlLoading()是不可信的生命周期，不建议在此方法中执行任何业务逻辑。开发者应避免在onOverrideUrlLoading()函数实现中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loadurl" target="_blank">loadUrl()</a>进行页面加载。</p> <p><strong>【风险说明】</strong></p> <p>此操作不仅可能导致当前加载流程意外终止，还会打破ArkWeb的安全限制，增加额外的安全风险（onOverrideUrlLoading()由页面发起，loadUrl()由Hybrid应用发起，ArkWeb内核对两种流程的安全校验有差别，因此不可以混用）。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/OnOverrideUrlLoading.ets#L17-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">onOverrideUrlLoading</span>(<span class="hljs-function">(<span class="hljs-params">webResourceRequest: WebResourceRequest</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (webResourceRequest &amp;&amp; webResourceRequest.<span class="hljs-title function_">getRequestUrl</span>() === <span class="hljs-string">'http://www.example.com'</span>) {</li><li>            <span class="hljs-keyword">try</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">'www.example.com'</span>);</li><li>              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>            } <span class="hljs-keyword">catch</span> (error) {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${error.code}</span>, Message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>            }</li><li>          }</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/OnOverrideUrlLoading.ets#L17-L41" target="_blank">OnOverrideUrlLoading.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免使用geturlgetoriginalurl函数获取url进行调用白名单校验">避免使用getUrl/getOriginalUrl函数获取URL进行调用白名单校验<i class="anchor-icon anchor-icon-link" anchorid="避免使用geturlgetoriginalurl函数获取url进行调用白名单校验" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>调用过程中，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#geturl" target="_blank">getUrl()</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#getoriginalurl" target="_blank">getOriginalUrl()</a>可能获取到不准确的页面的URL，若将其用于校验，则可能出现错误判断，引入安全风险。建议通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#getlastjavascriptproxycallingframeurl12" target="_blank">getLastJavascriptProxyCallingFrameUrl()</a>函数来获取准确的发起调用的页面URL。</p> <p>注：getLastJavascriptProxyCallingFrameUrl仅能在JavaScriptProxy中使用，请勿在其他场景中使用该函数获取URL，否则可能获取到错误值。</p> <p><strong>【风险说明】</strong></p> <p>对不准确的页面URL进行安全校验，将导致安全校验失效，可能让攻击者发起越权攻击等。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/GetURL.ets#L29-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> url: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">this</span>.controller.getUrl();</li><li><span class="hljs-keyword">if</span> (url === <span class="hljs-string">'https://www.huawei.com'</span>) {</li><li>  hilog.info(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'Pass the check'</span>);</li><li>  <span class="hljs-comment">// do some native invoke</span></li><li>} <span class="hljs-keyword">else</span> {</li><li>  hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'Not allowed to execute: '</span> + cmd);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/GetURL.ets#L29-L35" target="_blank">GetURL.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/GetURL.ets#L29-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> url: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">this</span>.controller.getLastJavascriptProxyCallingFrameUrl();</li><li><span class="hljs-keyword">if</span> (url === <span class="hljs-string">'https://www.huawei.com'</span>) {</li><li>  hilog.info(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'Pass the check'</span>);</li><li>  <span class="hljs-comment">// do some native invoke</span></li><li>} <span class="hljs-keyword">else</span> {</li><li>  hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'Not allowed to execute: '</span> + cmd);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/GetURL.ets#L29-L35" target="_blank">GetURL.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免在javascriptproxy中提供页面加载功能">避免在JavaScriptProxy中提供页面加载功能<i class="anchor-icon anchor-icon-link" anchorid="避免在javascriptproxy中提供页面加载功能" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>开发者应避免在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loadurl" target="_blank">loadUrl()</a>进行页面加载。如果业务有加载页面的需求，应当通过HTML跳转实现。</p> <p><strong>【风险说明】</strong></p> <p>不当操作不仅会导致当前页面生命周期意外终止，还会打破ArkWeb的安全限制，增加额外风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/Redirection.ets#L17-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestObj</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">webview_controller: webview.WebviewController</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> = webview_controller</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">goto</span>(<span class="hljs-params">uri: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadUrl</span>(uri);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${error.code}</span>, Message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  testObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">javaScriptProxy</span>({</li><li>          <span class="hljs-attr">object</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">testObj</span>,</li><li>          <span class="hljs-attr">name</span>: <span class="hljs-string">'objName'</span>,</li><li>          <span class="hljs-attr">methodList</span>: [<span class="hljs-string">'goto'</span>],</li><li>          <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>,</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/Redirection.ets#L17-L54" target="_blank">Redirection.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免在javascriptproxy中提供脚本执行功能">避免在JavaScriptProxy中提供脚本执行功能<i class="anchor-icon anchor-icon-link" anchorid="避免在javascriptproxy中提供脚本执行功能" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>开发者应避免在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-i#javascriptproxy12" target="_blank">JavaScriptProxy</a>中提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascript" target="_blank">runJavaScript()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascriptext10" target="_blank">runJavaScriptExt()</a>等代码执行功能。</p> <p><strong>【风险说明】</strong></p> <p>由于JavaScriptProxy注册在Web组件上，因此通过JavaScriptProxy执行的JS脚本可以影响在Web组件上运行的所有页面。受攻击者控制的子页面能借助此能力在父页面上执行代码，造成跨域风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/RunJavaScript.ets#L17-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestObj</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">webview_controller: webview.WebviewController</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> = webview_controller</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">eval</span>(<span class="hljs-params">uri: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(uri, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (error) {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>          <span class="hljs-string">`run JavaScript error, ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>,  Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    });</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'AceString'</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">testObj</span>: <span class="hljs-title class_">TestObj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'www.example.com'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">javaScriptProxy</span>({</li><li>          <span class="hljs-attr">object</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">testObj</span>,</li><li>          <span class="hljs-attr">name</span>: <span class="hljs-string">'objName'</span>,</li><li>          <span class="hljs-attr">methodList</span>: [<span class="hljs-string">'eval'</span>],</li><li>          <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>,</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/RunJavaScript.ets#L17-L59" target="_blank">RunJavaScript.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="务必在onpermissionrequest函数中显式通知用户进行授权">务必在onPermissionRequest函数中显式通知用户进行授权<i class="anchor-icon anchor-icon-link" anchorid="务必在onpermissionrequest函数中显式通知用户进行授权" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>Web页面能够通过getUserMedia()标准接口访问设备摄像头/麦克风。ArkWeb组件会触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onpermissionrequest9" target="_blank">onPermissionRequest()</a>函数来管理当前Web页面的授权，应当创建显式弹窗进行用户授权，如使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-dialog#alertdialog" target="_blank">AlertDialog</a>，避免直接授予页面权限。默认情况下，ArkWeb组件拒绝权限授予。</p> <p><strong>【风险说明】</strong></p> <p>若未经用户授权进行访问，则可能导致隐私泄露和违规风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/PermissionRequest.ets#L17-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.CAMERA'</span>, <span class="hljs-string">'ohos.permission.MICROPHONE'</span>])</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data permission: '</span> + data.<span class="hljs-property">permissions</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data authResults: '</span> + data.<span class="hljs-property">authResults</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>        <span class="hljs-string">`Failed to request permissions from user. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'https://example.com/index.html'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">onPermissionRequest</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-comment">// Directly granting page permissions is a wrong approach.</span></li><li>          event.<span class="hljs-property">request</span>.<span class="hljs-title function_">grant</span>(event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getAccessibleResource</span>());</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/PermissionRequest.ets#L17-L50" target="_blank">PermissionRequest.ets</a></div></div></div></div> <p>index.html内容如下：</p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L33-L60" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"video"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">autoplay</span>=<span class="hljs-string">"autoplay"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"HTML5 Camera"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Open Camera"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"getMedia()"</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span></li><li><span class="language-xml">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMedia</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-xml">        <span class="hljs-keyword">let</span> constraints = {</span></li><li><span class="language-xml">            <span class="hljs-attr">video</span>: {<span class="hljs-attr">width</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>},</span></li><li><span class="language-xml">            <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span></span></li><li><span class="language-xml">        };</span></li><li><span class="language-xml">        <span class="hljs-comment">// Get video</span></span></li><li><span class="language-xml">        <span class="hljs-keyword">let</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"video"</span>);</span></li><li><span class="language-xml">        <span class="hljs-comment">// Return Promise object</span></span></li><li><span class="language-xml">        <span class="hljs-keyword">let</span> promise = navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(constraints);</span></li><li><span class="language-xml">        <span class="hljs-comment">// then() sync，invoke MediaStream as param</span></span></li><li><span class="language-xml">        promise.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">MediaStream</span>) {</span></li><li><span class="language-xml">            video.<span class="hljs-property">srcObject</span> = <span class="hljs-title class_">MediaStream</span>;</span></li><li><span class="language-xml">            video.<span class="hljs-title function_">play</span>();</span></li><li><span class="language-xml">        });</span></li><li><span class="language-xml">    }</span></li><li><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L33-L60" target="_blank">index.html</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/PermissionRequest.ets#L17-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, [<span class="hljs-string">'ohos.permission.CAMERA'</span>, <span class="hljs-string">'ohos.permission.MICROPHONE'</span>])</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data permission: '</span> + data.<span class="hljs-property">permissions</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'data authResults: '</span> + data.<span class="hljs-property">authResults</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>        <span class="hljs-string">`Failed to request permissions from user. Code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-string">'https://example.com/index.html'</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">onPermissionRequest</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (event) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>({</li><li>              <span class="hljs-attr">title</span>: <span class="hljs-string">'title'</span>,</li><li>              <span class="hljs-attr">message</span>: <span class="hljs-string">'text'</span>,</li><li>              <span class="hljs-attr">primaryButton</span>: {</li><li>                <span class="hljs-attr">value</span>: <span class="hljs-string">'deny'</span>,</li><li>                <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>                  event.<span class="hljs-property">request</span>.<span class="hljs-title function_">deny</span>();</li><li>                }</li><li>              },</li><li>              <span class="hljs-attr">secondaryButton</span>: {</li><li>                <span class="hljs-attr">value</span>: <span class="hljs-string">'onConfirm'</span>,</li><li>                <span class="hljs-attr">action</span>: <span class="hljs-function">() =&gt;</span> {</li><li>                  <span class="hljs-comment">// Explicit pop-ups that ask user for authorization, e.g., using AlertDialog, is the correct approach.</span></li><li>                  event.<span class="hljs-property">request</span>.<span class="hljs-title function_">grant</span>(event.<span class="hljs-property">request</span>.<span class="hljs-title function_">getAccessibleResource</span>());</li><li>                }</li><li>              },</li><li>              <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> {</li><li>                event.<span class="hljs-property">request</span>.<span class="hljs-title function_">deny</span>();</li><li>              }</li><li>            })</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/PermissionRequest.ets#L17-L70" target="_blank">PermissionRequest.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="务必在ongeolocationshow函数中显式通知用户进行授权">务必在onGeolocationShow函数中显式通知用户进行授权<i class="anchor-icon anchor-icon-link" anchorid="务必在ongeolocationshow函数中显式通知用户进行授权" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>在Web页面访问设备地理位置时，务必在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#ongeolocationshow" target="_blank">onGeolocationShow()</a>回调函数内发起显式弹窗，明确告知用户进行授权。由于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-attributes#geolocationaccess" target="_blank">geolocationAccess</a>属性默认为true，ArkWeb会默认允许网页发起访问地理位置的请求，因此开发者务必在获得用户确认和同意后才能向网页返回位置信息；否则应当将geolocationAccess设置为false，禁止网页获取定位数据。</p> <p><strong>【风险说明】</strong></p> <p>若未经用户授权进行访问，可能导致隐私泄露和违规风险。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/GeolocationShow.ets#L17-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">geolocationAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">onGeolocationShow</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>          event.<span class="hljs-property">geolocation</span>.<span class="hljs-title function_">invoke</span>(event.<span class="hljs-property">origin</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/GeolocationShow.ets#L17-L33" target="_blank">GeolocationShow.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/GeolocationShow.ets#L17-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>('<span class="hljs-title class_">index</span>.<span class="hljs-title class_">html</span>'), <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>        .<span class="hljs-title function_">geolocationAccess</span>(<span class="hljs-keyword">true</span>)</li><li>        .<span class="hljs-title function_">onGeolocationShow</span>((<span class="hljs-variable">event</span>) =&gt; {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">event</span>) {</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">showAlertDialog</span>({</li><li>              <span class="hljs-variable">title</span>: <span class="hljs-string">'title'</span>,</li><li>              <span class="hljs-variable">message</span>: <span class="hljs-string">'text'</span>,</li><li>              <span class="hljs-variable">confirm</span>: {</li><li>                <span class="hljs-variable">value</span>: <span class="hljs-string">'onConfirm'</span>,</li><li>                <span class="hljs-variable">action</span>: () =&gt; {</li><li>                  <span class="hljs-variable">event</span>.<span class="hljs-variable">geolocation</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-variable">event</span>.<span class="hljs-variable">origin</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);</li><li>                }</li><li>              },</li><li>              <span class="hljs-variable">cancel</span>: () =&gt; {</li><li>                <span class="hljs-variable">event</span>.<span class="hljs-variable">geolocation</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-variable">event</span>.<span class="hljs-variable">origin</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);</li><li>              }</li><li>            })</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/GeolocationShow.ets#L17-L47" target="_blank">GeolocationShow.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免不经检查拼接和执行web侧传递的javascript内容">避免未经检查拼接和执行Web侧传递的JavaScript内容<i class="anchor-icon anchor-icon-link" anchorid="避免不经检查拼接和执行web侧传递的javascript内容" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>应用侧（ArkTS）可能会通过开放接口、生命周期拦截等方式接收Web页面（HTML+JS）传递的数据，再通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascript" target="_blank">runJavaScript()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#runjavascriptext10" target="_blank">runJavaScriptExt()</a>异步执行JS，回传执行结果。开发者务必对传递的数据进行安全过滤，再执行异步回调。</p> <p><strong>【风险说明】</strong></p> <p>从Web页面传递至应用侧（ArkTS）的内容不可信，若被攻击者控制，可能导致通用型跨站脚本攻击（UXSS）。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/RunJavaScript2.ets#L35-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(</li><li>  <span class="hljs-comment">// Trusting data_from_H5 passed through web pages will result in the execution of arbitrary JS code,</span></li><li>  <span class="hljs-comment">// e.g., enclose the alert and execute other JS code through data_from_H5.</span></li><li>  <span class="hljs-string">'javascript:alert('</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataFromH5</span> + <span class="hljs-string">')'</span>,</li><li>  <span class="hljs-function">(<span class="hljs-params">error, result</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>        <span class="hljs-string">`run JavaScript error, ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (result) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">webResult</span> = result;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`The test() return value is: <span class="hljs-subst">${result}</span>`</span>);</li><li>    }</li><li>  });</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/RunJavaScript2.ets#L35-L49" target="_blank">RunJavaScript2.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/RunJavaScript2.ets#L17-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">dataFromH5</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span> <span class="hljs-comment">// Messages passed from web pages</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">webResult</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webResult</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: $rawfile(<span class="hljs-string">'index.html'</span>), <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>        .<span class="hljs-title function_">javaScriptAccess</span>(<span class="hljs-literal">true</span>)</li><li>        .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Use regular expressions to match all single and double quotes.</span></li><li>            <span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/['"\(\)]/g</span>;</li><li>            <span class="hljs-comment">// Use the replace method to replace all matched characters with an empty string.</span></li><li>            <span class="hljs-keyword">let</span> sanitizedStr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataFromH5</span>.<span class="hljs-title function_">replace</span>(regex, <span class="hljs-string">''</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">runJavaScript</span>(</li><li>              <span class="hljs-comment">// Perform security filtering on the data_from_H5 passed through the web page before calling back.</span></li><li>              <span class="hljs-string">'javascript:alert('</span> + sanitizedStr + <span class="hljs-string">')'</span>,</li><li>              <span class="hljs-function">(<span class="hljs-params">error, result</span>) =&gt;</span> {</li><li>                <span class="hljs-keyword">if</span> (error) {</li><li>                  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>                    <span class="hljs-string">`run JavaScript error, ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>                <span class="hljs-keyword">if</span> (result) {</li><li>                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">webResult</span> = result;</li><li>                  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">`The test() return value is: <span class="hljs-subst">${result}</span>`</span>);</li><li>                }</li><li>              });</li><li>            <span class="hljs-keyword">if</span> (event) {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>, <span class="hljs-string">'url: '</span>, event.<span class="hljs-property">url</span>);</li><li>            }</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/RunJavaScript2.ets#L17-L63" target="_blank">RunJavaScript2.ets</a></div></div></div></div> </div> <p>index.html内容如下：</p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L18-L29" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml">Hello world!</span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></span></li><li><span class="language-xml">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) {</span></li><li><span class="language-xml">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Ark WebComponent'</span>)</span></li><li><span class="language-xml">        <span class="hljs-keyword">return</span> <span class="hljs-string">"This value is from index.html"</span></span></li><li><span class="language-xml">    }</span></li><li><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/resources/rawfile/index.html#L18-L29" target="_blank">index.html</a></div></div></div></div> <div class="tiledSection"><h2 id="section74092496444">确保敏感数据数据传输安全<i class="anchor-icon anchor-icon-link" anchorid="section74092496444" tips="复制节点链接"></i></h2></div> <p>遵循以下最佳实践，确保应用与Web网页安全地进行数据传递，提升应用安全性，同时为用户提供隐私安全保障。</p> <div class="tiledSection"><h3 id="避免向web页面直接追加认证cookie" class="firsth2">避免直接向Web页面追加认证Cookie<i class="anchor-icon anchor-icon-link" anchorid="避免向web页面直接追加认证cookie" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>出于业务需要进行用户状态同步时，其中一种方式是使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webcookiemanager" target="_blank">WebCookieManager</a>为指定URL的页面传递Cookie。</p> <p>务必在校验待追加Cookie的URL符合业务预期后，再使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webcookiemanager#configcookiesync11" target="_blank">configCookieSync()</a>向其追加认证Cookie。建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#seturltrustlist12" target="_blank">setUrlTrustList()</a>配置加载白名单后，再对待追加Cookie的URL进行一次合法性判断。</p> <p><strong>【风险说明】</strong></p> <p>向未经校验的URL直接追加认证Cookie是非常危险的行为，可能导致认证Cookie被窃取。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/SetCookies.ets#L17-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">unknownUrl</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// unknown_url from external source</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'configCookieSync'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// unknown_url is not verified.</span></li><li>            webview.<span class="hljs-property">WebCookieManager</span>.<span class="hljs-title function_">configCookieSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">unknownUrl</span>, <span class="hljs-string">'a=b'</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">unknownUrl</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/SetCookies.ets#L17-L42" target="_blank">SetCookies.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/SetCookies.ets#L17-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { webview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WebComponent</span> {</li><li>  <span class="hljs-attr">controller</span>: webview.<span class="hljs-property">WebviewController</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title class_">WebviewController</span>();</li><li>  <span class="hljs-attr">unknown_url</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// unknown_url from external source</span></li><li>  <span class="hljs-attr">urlTrustList</span>: <span class="hljs-built_in">string</span> =</li><li>    <span class="hljs-string">'{\'UrlPermissionList\':[{\'scheme\':\'http\', \'host\':\'trust.example.com\', \'port\':80, \'path\':\'test\'}]}'</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'configCookieSync'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Set up an allowlist to allow access only to trusted web pages.</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setUrlTrustList</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">urlTrustList</span>);</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-comment">// Perform another validity check on unknown_url to implement more granular control.</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">unknown_url</span> === <span class="hljs-string">'https://www.example.com'</span>) {</li><li>              webview.<span class="hljs-property">WebCookieManager</span>.<span class="hljs-title function_">configCookieSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">unknown_url</span>, <span class="hljs-string">'a=b'</span>);</li><li>            }</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ArkWebSecurity'</span>,</li><li>              <span class="hljs-string">`ErrorCode: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span>, Message: <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>          }</li><li>        })</li><li>      <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">unknown_url</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/SetCookies.ets#L17-L53" target="_blank">SetCookies.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="避免将用户敏感信息直接拼接到url进行加载">避免将用户敏感信息直接拼接到URL中进行加载<i class="anchor-icon anchor-icon-link" anchorid="避免将用户敏感信息直接拼接到url进行加载" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>避免将用户敏感信息，如OAuth Token、Session ID、手机号等，直接拼接到URL中并访问加载，例如调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loadurl" target="_blank">loadUrl()</a>。</p> <p><strong>【风险说明】</strong></p> <p>当URL为外部可控时，将导致敏感信息泄露。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/LoadURLWithSensitiveData.ets#L17-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebComponent</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-variable">webviewController</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>  <span class="hljs-variable">accessToken</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'xxxx'</span>; <span class="hljs-comment">// After the user completes the login operation, the token returned by the server.</span></li><li>  <span class="hljs-variable">untrustedURL</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span> <span class="hljs-comment">// Any URL to be loaded</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">untrustedURL</span> + <span class="hljs-string">'?token='</span> + <span class="hljs-keyword">this</span>.<span class="hljs-title class_">accessToken</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">webviewController</span> })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/LoadURLWithSensitiveData.ets#L17-L32" target="_blank">LoadURLWithSensitiveData.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="应用通过postmessage接口向网页传送敏感数据时务必指定接收该消息的uri">应用通过postMessage接口向网页传送敏感数据时，务必指定接收该消息的URI<i class="anchor-icon anchor-icon-link" anchorid="应用通过postmessage接口向网页传送敏感数据时务必指定接收该消息的uri" tips="复制节点链接"></i></h3><p><strong>【描述】</strong></p> <p>在使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webmessageport" target="_blank">WebMessagePort</a>和网页建立连接时，需要保证通信对端网页可信。</p> <p><strong>【风险说明】</strong></p> <p>缺少访问控制可能会意外的将应用侧ArkTS代码暴露给网页的JavaScript，导致敏感资源泄露。</p> <p><strong>【反例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/PostMessage.ets#L42-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.ports = <span class="hljs-keyword">this</span>.controller.createWebMessagePorts();</li><li><span class="hljs-keyword">this</span>.controller.postMessage(<span class="hljs-string">'__init_port__'</span>, [<span class="hljs-keyword">this</span>.ports[<span class="hljs-number">0</span>]], <span class="hljs-string">'*'</span>);</li><li><span class="hljs-keyword">this</span>.ports[<span class="hljs-number">1</span>].postMessageEvent(<span class="hljs-string">'Post message event to html'</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/ErrorSamples/PostMessage.ets#L42-L44" target="_blank">PostMessage.ets</a></div></div></div></div> <p><strong>【正例】</strong></p> <div class="screenLinkPre"><div _ngcontent-fhd-c106="" class="highlight-div"><div _ngcontent-fhd-c106="" class="highlight-div-header"><div _ngcontent-fhd-c106="" class="highlight-div-header-left"><div _ngcontent-fhd-c106="" class="handle-button expand-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fhd-c106="" class="highlight-div-header-right"><div _ngcontent-fhd-c106="" class="handle-button ai-button"></div><div _ngcontent-fhd-c106="" class="handle-button line-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fhd-c106="" class="handle-button theme-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fhd-c106="" class="handle-button copy-button"><div _ngcontent-fhd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fhd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/PostMessage.ets#L42-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.ports = <span class="hljs-keyword">this</span>.controller.createWebMessagePorts();</li><li><span class="hljs-keyword">this</span>.controller.postMessage(<span class="hljs-string">'__init_port__'</span>, [<span class="hljs-keyword">this</span>.ports[<span class="hljs-number">0</span>]], <span class="hljs-keyword">this</span>.url_in_whitelist);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkWebSecurity/arkwebsecurity/src/main/ets/pages/PostMessage.ets#L42-L43" target="_blank">PostMessage.ets</a></div></div></div></div> </div> </div> <div></div></div>