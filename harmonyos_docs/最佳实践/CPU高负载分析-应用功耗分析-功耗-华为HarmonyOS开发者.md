<h1 _ngcontent-rsy-c119="" class="doc-title ng-star-inserted" title="CPU 高负载分析"> CPU 高负载分析 </h1>

<div _ngcontent-rsy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section6369943717">日志获取<i class="anchor-icon anchor-icon-link" anchorid="section6369943717" tips="复制节点链接"></i></h2><p>对于CPU高负载问题的分析，需要在Profiler工具中启动Energy模板分析任务，并重现问题场景。</p> <p>IDE工具中集成了CPU高负载故障的异常检测功能，操作步骤如下：</p> <ol><li>点击Profiler工具，选择要分析的应用进程，创建一个Energy Session，按照复现路径操作应用，捕获大约15秒的信息。</li><li>观察Energy Anomaly泳道，若标注为红色的异常则表示已识别到CPU高负载异常。<p><span><img height="281.51046" originheight="663" originwidth="1918" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.36872994394910079502810400869402:50001231000000:2800:C18CE9CD855F30915681C414C793D3B46C7437E7706BBDEBC9C2FDDDF29796D8.png" title="点击放大" width="814.378019"></span></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>CPU负载是3秒内的平均负载值。如果线程连续在大核最高频率下运行3秒，负载值将达到100%。当线程在不同的核心、不同的频率下运行，且运行时间不同时，将根据芯片的计算能力和运行时间进行相应的比例折算。</p> </div></div></div> </li><li>点击More中的箭头，可直接查看当前函数执行的总时间比较长的函数，可接着分析函数执行时间长的原因。<p><span><img height="149.21496100000002" originheight="376" originwidth="2051" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.61675664933402018666266086329859:50001231000000:2800:67FE993B4E5AC84470CEBFA9C6D0B27CDDB36AFE91C81BDDF0BDDA07E52B46F5.png" title="点击放大" width="813.96"></span></p> </li></ol> </div> <div class="tiledSection"><h2 id="section630015519212">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section630015519212" tips="复制节点链接"></i></h2><p>CPU高负载问题通常涉及以下三种情况：</p> <ol><li>GC线程负载高。需要通过Allocation和Snapshot模板来分析内存使用情况。</li><li>UI线程负载高。应通过Trace泳道分析是否存在冗余绘制及组件未复用等问题，主要结合应用主进程、render_service、RSUniRenderThre以及RSHardwareThread这些管线中的帧率、帧长和未送显情况进行详细分析。</li><li>应用侧其他线程负载高。需要借助Callstack泳道分析函数栈，排查应用的业务逻辑是否存在异常，是否频繁执行了长耗时任务，或因异常业务逻辑导致了无限循环。</li></ol> <p>针对上述情况进行详细分析和定位，确认根本原因后进行修复，随后观察功耗和发热情况是否满足性能要求。如不满足，则需重复上述分析和定位过程。</p> </div> <p><span><img originheight="813" originwidth="1275" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.05603277208385983719159237699635:50001231000000:2800:99DA5AB5E21AC6E5BFC2E1548832452E4E2D0854EC30A1B9E8B3835B0B97910F.png" width="920" height="586.635294117647"></span></p> <div class="tiledSection"><h2 id="section12422123110423">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section12422123110423" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section7330175911215" class="firsth2">案例一：应用侧某线程负载过高<i class="anchor-icon anchor-icon-link" anchorid="section7330175911215" tips="复制节点链接"></i></h3><p>某应用使用过程中，边刷视频边查看评论或推荐时，手机发烫严重，关闭应用后逐渐恢复正常。</p> <ol><li><span>在Profiler工具中开启Energy模板分析任务并复现问题场景。</span></li><li><span>观察CPU Core泳道找到运行时长占比比较高的线程，详细分析方法可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-cpu" target="_blank">CPU活动分析</a>。</span><p></p><p>选择CPU Core泳道，通过下方详情区可以看出应用进程占比时长较高。</p> <p><span><img height="555.9498666666667" originheight="901" originwidth="1491" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.81766152663967497014307564780086:50001231000000:2800:9F058B1053C72DDB4FAA322E7E88AF1BCF722CE80BDB008A0552F1F76820CE1C.png" title="点击放大" width="920"></span></p> <p>查看CPU频点情况，通过查看Frequency泳道发现CPU核的频点都很高，CPU调度非常频繁。</p> <p>Frequency子泳道：表示CPU频率，鼠标悬浮在Frequency泳道上，可以看到CPU的运行频率。</p> <p><span><img height="483.8709333333333" originheight="740" originwidth="1407" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.74448572842587613557119988437225:50001231000000:2800:3F0D15756A1B89905960D8DF8FFDD937D047529F8F642409CAA0F72B51F09FFA.png" title="点击放大" width="920"></span></p> <p>当所有CPU核频点都较高时，选择CPU Core泳道，查看CPU负载来源。通过详情区，可以看到CPU负载主要来源于应用侧的子线程（线程号55523）。</p> <p><span><img height="528.1168" originheight="849" originwidth="1479" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.58052738475579188458026971011990:50001231000000:2800:97C4C2BAB03D73FD23DDF7CB8C47A2E79B0A7C200276AE3EDE850FA1E8CA3CF7.png" title="点击放大" width="920"></span></p> <p></p></li><li><span>根据CPU高负载线程类型进行详细排查。本案例中，CPU负载主要来源于应用侧的子线程（线程号55523）。需要借助<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-click-to-complete-delay-analysis" target="_blank">点击完成时延分析</a>该线程执行的任务，结合函数栈排查业务逻辑是否存在异常。大多情况下都是由于该线程频繁执行长耗时任务或者无限循环逻辑导致的。</span></li></ol> </div> <div class="tiledSection"><h3 id="section16372163052514">案例二：GC线程负载过高<i class="anchor-icon anchor-icon-link" anchorid="section16372163052514" tips="复制节点链接"></i></h3><p>某应用使用期间，屏幕发烫严重，壳温高达40摄氏度；结束应用后，温度自行恢复正常。</p> <ol><li><span>在Profiler工具中开启Energy模板分析任务并复现问题场景。</span></li><li><span>观察CPU Core泳道找到运行时长占比比较高的线程，详细分析方法可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-cpu" target="_blank">CPU活动分析</a>。</span><p></p><p>选择CPU Core泳道，通过下方详情区可以看出，应用进程占比时长较高。不同应用的应用进程名称不同，一般与应用包名一致。</p> <p><span><img height="542.7264" originheight="925" originwidth="1568" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.24120450201882817593530263820207:50001231000000:2800:00C2B56100F23171B3059226DE5F6DB5F3E91FC44A717E560636AD2EC7C6E26D.png" title="点击放大" width="920"></span></p> <p>查看CPU频点情况，通过查看Frequency泳道的CPU频率可以看出CPU部分核上频点很高，基本保持在最高频状态运行。即下图中的CPU10、CPU11，其对应的Frequency子泳道基本被填满。</p> <p><span><img height="511.94933333333336" originheight="739" originwidth="1328" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.07248240875337548480988755240476:50001231000000:2800:8528D241191FA4690E44574345EFA1B6A939C433565043C2FB2DE387B4D4E583.png" title="点击放大" width="920"></span></p> <p>当部分核频点较高时，选择CPU频点比较高的核对应的Slice子泳道，查看CPU负载来源。即CPU10与CPU11对应的Slice子泳道，通过详情区可以看到CPU负载主要来源于应用进程的OS_GC_Thread线程。</p> <p><span><img height="578.1402666666667" originheight="942" originwidth="1499" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.96275125738033517231001821764160:50001231000000:2800:794CE94AA517A030E1D4B4511A79FDC2C0FE27A508DF0E7A9A461A94529659AC.png" title="点击放大" width="920"></span></p> <p><span><img height="592.0874666666667" originheight="966" originwidth="1501" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.00394853107406516366966201717043:50001231000000:2800:3883A08D390974EC57F1DC36978FD3491ECCCC34FD3F21FB7E156CC3D3C2070B.png" title="点击放大" width="920"></span></p> <p></p></li><li><span>根据CPU高负载线程类型进行详细排查。本案例中，CPU负载主要来源于应用进程的OS_GC_Thread线程。针对GC线程负载高的情况，需要借助Allocation和Snapshot模板具体分析内存使用情况。详细分析方法参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-allocations" target="_blank">Allocation分析</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-snapshot" target="_blank">Snapshot分析</a>。</span></li></ol> </div> <div class="tiledSection"><h3 id="section1715825662515">案例三：UI主线程负载过高<i class="anchor-icon anchor-icon-link" anchorid="section1715825662515" tips="复制节点链接"></i></h3><p>在某应用上进入直播页面进行观看，功耗超100mA，手机温度持续升高。</p> <ol><li><span>在Profiler工具中开启Energy模板分析任务并复现问题场景。</span></li><li><span>观察CPU Core泳道找到运行时长占比比较高的线程，详细分析方法可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-cpu" target="_blank">CPU活动分析</a>。</span><p></p><p>选择CPU Core泳道，通过下方详情区可以看出，应用进程占比时长较高。</p> <p><span><img height="476.16746666666666" originheight="781" originwidth="1509" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.01467753284217106269196249417934:50001231000000:2800:76DF5628BF51690236D2F3E179AA83DC0F4ABAE13A8B64C1D421143522DA0DD0.png" title="点击放大" width="920"></span></p> <p>查看CPU频点情况，通过查看Frequency泳道发现CPU部分核（CPU10、CPU11）的频点很高，且每个CPU核调度都非常频繁。</p> <p><span><img height="469.76426666666663" originheight="649" originwidth="1271" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.91935275711393692671531449454782:50001231000000:2800:61B5E13E0D9A0A68E90AEC5F2229BCAC721D353984E7601CE09A55DEF41D6A3B.png" title="点击放大" width="920"></span></p> <p>选择CPU Core泳道，查看CPU负载来源。通过详情区，可以看到CPU负载主要来源于应用UI主线程（线程号43436，与应用进程号一致为主线程）。</p> <p><span><img height="521.4805333333334" originheight="844" originwidth="1489" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163435.53409603610773049501828886482896:50001231000000:2800:0752952824E41FD3307E88FA532AE7F0FAC07DA87E85EF5E8833D58ECE1976F6.png" title="点击放大" width="920"></span></p> <p></p></li><li><span>根据CPU高负载线程类型进行详细排查。本案例中，CPU负载主要来源于应用UI主线程。需要分析UI主线程的Trace泳道判断是否存在冗余绘制及组件未复用等情况。</span><p></p><p>找到UI主线程对应的Trace泳道（可以根据应用包名或上一步中的线程号查找）。选择对应的线程泳道，可以看到详情区包含了线程运行状态，选择Thread States，可以看出Running状态占比非常高。</p> <p><span><img height="511.0416" originheight="856" originwidth="1541" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163436.29389467477876051403653671257373:50001231000000:2800:15B23F6A4B5F1AA33F0D09C155DB49717A292390F3D892528C6C86063844C908.png" title="点击放大" width="920"></span></p> <p>查看Slice List，检查是否存在冗余绘制及组件未复用等情况。选择Slice List，发现id为-1的Image一直在执行绘制任务，Occurrences达到了4万多次。然后借助ArkUI Inspector工具进行排查确认组件是否存在冗余绘制情况。关于ArkUI Inspector的使用可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-arkui-inspector" target="_blank">布局分析</a>。</p> <p><span><img height="563.1749333333333" originheight="958" originwidth="1565" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163436.45487228174688576566899103242969:50001231000000:2800:3D4BF0AB15E59D430C53F3CCA5D7371329B887E57B5D4573212E611097860DBB.png" title="点击放大" width="920"></span></p> <p></p></li></ol> </div> </div> <div></div></div>