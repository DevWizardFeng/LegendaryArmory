<h1 _ngcontent-ocf-c119="" class="doc-title ng-star-inserted" title="CppCrash类问题优化建议"> CppCrash类问题优化建议 </h1>

<div _ngcontent-ocf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section121716614417">优化建议1：使用map\vector\list\set等STL库时，要避免数据竞争<i class="anchor-icon anchor-icon-link" anchorid="section121716614417" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise1.cpp#L37-L40" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EraseMapItem1</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span></span></li><li><span class="hljs-function"></span>{</li><li>    appRunningRecordMap_.<span class="hljs-built_in">erase</span>(key);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise1.cpp#L37-L40" target="_blank">CppCrashAdvise1.cpp</a></div></div></div></div> <p>如果存在多个线程同时操作同一个map时，此处将map元素删除，另一个线程同时操作map会产生崩溃问题。</p> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise1.cpp#L44-L56" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EraseMapItem2</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 加锁</span></li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    appRunningRecordMap_.<span class="hljs-built_in">erase</span>(key);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FindMapItem</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// 加锁</span></li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    appRunningRecordMap_.<span class="hljs-built_in">find</span>(key);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise1.cpp#L44-L56" target="_blank">CppCrashAdvise1.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section4665546144414">优化建议2：多线程访问全局变量/静态变量/类成员变量，如果涉及修改删除操作，对其所有操作都要加锁保护<i class="anchor-icon anchor-icon-link" anchorid="section4665546144414" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L33-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">list</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title class_">g_list</span>;</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">MainFunc</span>()</li><li>{</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">xxx</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object</span>&gt;();</li><li>    <span class="hljs-variable">g_list</span>.<span class="hljs-title function_">push_back</span>(<span class="hljs-variable">xxx</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// 线程1</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Thread1Func</span>()</li><li>{</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">auto</span> &amp;<span class="hljs-title class_">ptr</span> : <span class="hljs-title class_">g_list</span>) {</li><li>        <span class="hljs-variable">ptr</span>-&gt;<span class="hljs-title class_">method</span>();</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 线程2</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Thread2Func</span>()</li><li>{</li><li>    <span class="hljs-variable">g_list</span>.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 此处清空list，可能会造成线程1使用g_list时发生崩溃</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L33-L53" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L57-L71" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 线程1</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Thread1FuncEx</span>()</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutexEx_</span>);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">auto</span> &amp;<span class="hljs-title class_">ptr</span> : <span class="hljs-title class_">g_list</span>) {</li><li>        <span class="hljs-variable">ptr</span>-&gt;<span class="hljs-title class_">method</span>();</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-comment">// 线程2</span></li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Thread2FuncEx</span>()</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutexEx_</span>);</li><li>    <span class="hljs-variable">g_list</span>.<span class="hljs-title function_">clear</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L57-L71" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section43313220450">优化建议3：谨慎在异步场景lambda表达式中使用引用捕获，注意变量生命周期<i class="anchor-icon anchor-icon-link" anchorid="section43313220450" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L94-L110" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">Checker</span>::<span class="hljs-title function_ invoke__">Detection</span>(std::<span class="hljs-variable constant_">string</span>&amp; url)</li><li>{</li><li>    handler.<span class="hljs-title function_ invoke__">PostAsyncTask</span>(</li><li>        [this, &amp;url]() {</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Checker</span>::<span class="hljs-title function_ invoke__">DoCheck</span>(url)) {</li><li>                <span class="hljs-comment">// ...</span></li><li>            }</li><li>        }</li><li>    );</li><li>    <span class="hljs-comment">// 这里url变量即将析构</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">bool</span> <span class="hljs-title class_">Checker</span>::<span class="hljs-title function_ invoke__">DoCheck</span>(<span class="hljs-keyword">const</span> std::<span class="hljs-variable constant_">string</span>&amp; url)</li><li>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L94-L110" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L114-L124" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Checker</span>::<span class="hljs-title class_">Detection2</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span>&amp; <span class="hljs-title class_">url</span>)</li><li>{</li><li>    <span class="hljs-variable">handler</span>.<span class="hljs-title function_">PostAsyncTask</span>(</li><li>        [<span class="hljs-keyword">this</span>, <span class="hljs-variable">url</span>]() {</li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">Checker</span>::<span class="hljs-title class_">DoCheck</span>(<span class="hljs-title class_">url</span>)) {</li><li>                <span class="hljs-comment">// ...</span></li><li>            }</li><li>        }</li><li>    );</li><li>    <span class="hljs-comment">// 这里url变量即将析构，但lambda已经有自己的拷贝</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L114-L124" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section79641512458">优化建议4：智能指针和裸指针使用前，都要进行判空<i class="anchor-icon anchor-icon-link" anchorid="section79641512458" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L132-L133" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">smartPointer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">smartPointer</span>-&gt;<span class="hljs-title class_">method</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L132-L133" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L140-L143" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">smartPointer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">smartPointer</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">smartPointer</span>-&gt;<span class="hljs-title class_">method</span>();</li><li>    }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L140-L143" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section14359531194512">优化建议5：不要使用多个智能指针管理同一个裸指针<i class="anchor-icon anchor-icon-link" anchorid="section14359531194512" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L150-L152" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">Object</span>* <span class="hljs-variable">xxx</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Object</span>();</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">xxx1</span>(<span class="hljs-title class_">xxx</span>); <span class="hljs-comment">// xxx1 引用计数减为0时析构一次xxx</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">xxx2</span>(<span class="hljs-title class_">xxx</span>); <span class="hljs-comment">// xxx2 引用计数减为0时析构一次xxx</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L150-L152" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L159-L159" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">xxx</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object</span>&gt;();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L159-L159" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section16278843194514">优化建议6：不要从智能指针中取出裸指针继续使用<i class="anchor-icon anchor-icon-link" anchorid="section16278843194514" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L164-L166" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">auto</span> <span class="hljs-variable">smartPointer</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object</span>&gt;(); <span class="hljs-comment">// smartPointer引用计数减为0时析构</span></li><li><span class="hljs-variable">auto</span> <span class="hljs-variable">pointer</span> = <span class="hljs-variable">smartPointer</span>.<span class="hljs-title function_">get</span>();</li><li><span class="hljs-variable">pointer</span>-&gt;<span class="hljs-title class_">method</span>(); <span class="hljs-comment">// 当smartPinter析构后继续使用pointer可能发生crash</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L164-L166" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L175-L176" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">smartPointer</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object</span>&gt;();</li><li>    <span class="hljs-variable">smartPointer</span>-&gt;<span class="hljs-title class_">method</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L175-L176" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section671765414519">优化建议7：禁止将裸指针构造为智能指针后，继续使用或主动释放裸指针<i class="anchor-icon anchor-icon-link" anchorid="section671765414519" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L183-L186" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">Object</span>* <span class="hljs-variable">pointer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Object</span>();</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title class_">smartPointer</span>(<span class="hljs-title class_">pointer</span>); <span class="hljs-comment">// smartPointer 引用计数减为0时析构</span></li><li>    <span class="hljs-variable">pointer</span>-&gt;<span class="hljs-title class_">method</span>(); <span class="hljs-comment">// 当smartPointer析构后继续使用pointer可能发生crash</span></li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">pointer</span>; <span class="hljs-comment">// 主动释放裸指针发生crash</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L183-L186" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L193-L194" data-highlighted="yes"><ol class="linenums"><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">smartPointer</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object</span>&gt;();</li><li>    <span class="hljs-variable">smartPointer</span>-&gt;<span class="hljs-title class_">method</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L193-L194" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1198918454612">优化建议8：禁止在信号处理流程中调用非异步安全函数和使用map\vector\list\set等STL库<i class="anchor-icon anchor-icon-link" anchorid="section1198918454612" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L199-L202" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">SignalHandler</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, <span class="hljs-type">siginfo_t</span>* si, <span class="hljs-type">void</span>* context)</span> <span class="hljs-comment">// 信号处理函数</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> *c = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 禁止使用malloc，malloc是非异步安全函数</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L199-L202" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L206-L209" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">SignalHandlerEx</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, <span class="hljs-type">siginfo_t</span>* si, <span class="hljs-type">void</span>* context)</span> <span class="hljs-comment">// 信号处理函数</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> c[<span class="hljs-number">10</span>] = {<span class="hljs-number">0</span>};</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L206-L209" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>信号处理函数直接或间接调用的对象或函数需确保异步安全。</p> <p><strong>malloc是非异步安全函数，因此在信号处理函数中，</strong></p> <ol><li>禁止在堆上申请内存</li><li>禁止使用STL类对象，比如在堆动态分配内存的 string、vector、list、set、map...</li><li>调用的外部函数，需确保该函数异步安全，典型非异步安全的getproctid、fgets、fopen...</li></ol> </div></div></div> <p><strong>异步安全函数列表</strong></p> <p>如果可以安全的调用该函数，并且在信号处理程序上文中可以安全的使用，则该函数是异步安全的或异步信号安全的。下表中所列的均为异步安全函数，来自POSIX标准。应用程序可以<strong>在信号处理程序中调用这些异步安全函数</strong>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>_Exit()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>fexecve()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>posix_trace_event()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigprocmask()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>_exit()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>fork()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pselect()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigqueue()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>abort()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>fstat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pthread_kill()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigset()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>accept()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>fstatat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pthread_self()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigsuspend()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>access()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>fsync()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pthread_sigmask()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sleep()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>aio_error()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>ftruncate()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>raise()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sockatmark()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>aio_return()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>futimens()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>read()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>socket()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>aio_suspend()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getegid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>readlink()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>socketpair()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>alarm()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>geteuid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>readlinkat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>stat()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>bind()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getgid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>recv()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>symlink()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>cfgetispeed()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getgroups()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>recvfrom()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>symlinkat()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>cfgetospeed()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getpeername()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>recvmsg()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcdrain()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>cfsetispeed()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getpgrp()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>rename()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcflow()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>cfsetospeed()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getpid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>renameat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcflush()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>chdir()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getppid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>rmdir()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcgetattr()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>chmod()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getsockname()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>select()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcgetpgrp()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>chown()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getsockopt()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sem_post()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcsendbreak()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>clock_gettime()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>getuid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>send()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcsetattr()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>close()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>kill()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sendmsg()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>tcsetpgrp()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>connect()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>link()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sendto()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>time()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>creat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>linkat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>setgid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>timer_getoverrun()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>dup()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>listen()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>setpgid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>timer_gettime()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>dup2()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>lseek()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>setsid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>timer_settime()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>execl()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>lstat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>setsockopt()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>times()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>execle()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mkdir()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>setuid()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>umask()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>execv()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mkdirat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>shutdown()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>uname()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>execve()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mkfifo()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigaction()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>unlink()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>faccessat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mkfifoat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigaddset()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>unlinkat()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fchdir()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mknod()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigdelset()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>utime()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fchmod()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>mknodat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigemptyset()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>utimensat()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fchmodat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>open()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigfillset()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>utimes()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fchown()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>openat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigismember()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>wait()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fchownat()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pause()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>signal()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>waitpid()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fcntl()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>pipe()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigpause()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>write()</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>fdatasync()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>poll()</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>sigpending()</p> </td> <td class="cellrowborder" valign="top" width="25%">&nbsp;&nbsp;</td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section7326823104610">优化建议9：不要传递this指针到其他模块或者线程<i class="anchor-icon anchor-icon-link" anchorid="section7326823104610" tips="复制节点链接"></i></h2><p>将this指针传递到其他模块或者线程是非常危险的行为，如果其他模块或者线程与this指针指向的对象的生命周期不一致时，很容易造成崩溃问题。</p> <p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise4.cpp#L32-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Object1</span>::<span class="hljs-title class_">Run</span>()</li><li>{</li><li>    <span class="hljs-variable">startThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(<span class="hljs-title class_">new</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>([<span class="hljs-keyword">this</span>] { <span class="hljs-comment">// 将this指针传递给其他线程</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == <span class="hljs-title class_">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">this</span>-&gt;<span class="hljs-title class_">GetInfo</span>();</li><li>        <span class="hljs-comment">// ...</span></li><li>    }));</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise4.cpp#L32-L42" target="_blank">CppCrashAdvise4.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise3.cpp#L23-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Object2</span> : <span class="hljs-keyword">public</span> <span class="hljs-title class_">std</span>::<span class="hljs-title class_">enable_shared_from_this</span>&lt;<span class="hljs-title class_">Object2</span>&gt; {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Run</span>();</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">GetInfo</span>() {}</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt; <span class="hljs-title class_">startThread_</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>};</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">Object2</span>::<span class="hljs-title class_">Run</span>()</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">weak_ptr</span>&lt;<span class="hljs-title class_">Object2</span>&gt; <span class="hljs-title class_">weakPtr</span> = <span class="hljs-title function_">shared_from_this</span>(); <span class="hljs-comment">// 调用shared_from_this捕获this(c++17开始可使用waek_form_this)</span></li><li>    <span class="hljs-variable">startThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(<span class="hljs-title class_">new</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>([<span class="hljs-title class_">weakPtr</span>] { <span class="hljs-comment">// weakPtr传递给其他线程</span></li><li>        <span class="hljs-title class_">auto</span> <span class="hljs-title class_">ptr</span> = <span class="hljs-title class_">weakPtr</span>.<span class="hljs-title class_">lock</span>();</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ptr</span> == <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-variable">ptr</span>-&gt;<span class="hljs-title class_">GetInfo</span>();</li><li>        <span class="hljs-comment">// ...</span></li><li>    }));</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">MainFuncEx</span>()</li><li>{</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">object</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Object2</span>&gt;(); <span class="hljs-comment">// 必须使用智能指针初始化Object对象</span></li><li>    <span class="hljs-variable">object</span>-&gt;<span class="hljs-title class_">Run</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise3.cpp#L23-L52" target="_blank">CppCrashAdvise3.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1932593834620">优化建议10：禁止接口返回局部变量的引用<i class="anchor-icon anchor-icon-link" anchorid="section1932593834620" tips="复制节点链接"></i></h2><p>错误示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L213-L217" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span>&amp; <span class="hljs-title class_">GetString</span>()</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">result</span> = <span class="hljs-string">"this is string"</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>; <span class="hljs-comment">// 禁止返回局部变量result的引用</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L213-L217" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> <p>正确示例：</p> <div class="screenLinkPre"><div _ngcontent-ocf-c106="" class="highlight-div"><div _ngcontent-ocf-c106="" class="highlight-div-header"><div _ngcontent-ocf-c106="" class="highlight-div-header-left"><div _ngcontent-ocf-c106="" class="handle-button expand-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ocf-c106="" class="highlight-div-header-right"><div _ngcontent-ocf-c106="" class="handle-button ai-button"></div><div _ngcontent-ocf-c106="" class="handle-button line-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ocf-c106="" class="handle-button theme-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ocf-c106="" class="handle-button copy-button"><div _ngcontent-ocf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ocf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L221-L225" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">GetStringEx</span>()</li><li>{</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">result</span> = <span class="hljs-string">"this is string"</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>; <span class="hljs-comment">// 返回局部变量的值</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashAdvise2.cpp#L221-L225" target="_blank">CppCrashAdvise2.cpp</a></div></div></div></div> </div> </div> <div></div></div>