<h1 _ngcontent-bix-c119="" class="doc-title ng-star-inserted" title="CppCrash类问题案例"> CppCrash类问题案例 </h1>

<div _ngcontent-bix-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文以列举常见案例方式介绍如何分析并修复CppCrash问题。阅读本文之前，建议开发者先阅读<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-runtime-crash-detection" target="_blank">应用崩溃问题检测方法</a>了解系统检测CppCrash问题的原理和机制，然后阅读<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-crash-cpp-way" target="_blank">CppCrash类问题分析方法</a>了解分析CppCrash问题的一般步骤。</p> <p>除本文之外，开发者还可以参考以下文档分析API相关的CppCrash问题:</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-stability-crash-issues" target="_blank">UI相关应用崩溃常见问题</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-coding-standard-api" target="_blank">易错API的使用规范</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-faq-about-stability" target="_blank">稳定性相关问题汇总</a></p> <div class="tiledSection"><h2 id="section1256915404215">案例1：空指针解引用问题<i class="anchor-icon anchor-icon-link" anchorid="section1256915404215" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section89484394417" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section89484394417" tips="复制节点链接"></i></h3></div> <p>智能指针使用之前未判空，造成进程运行时发生空指针解引用崩溃问题。</p> <div class="tiledSection"><h3 id="section1045213010514">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section1045213010514" tips="复制节点链接"></i></h3></div> <p>进程发生崩溃，影响稳定运行，导致非预期退出。</p> <div class="tiledSection"><h3 id="section177536911516">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section177536911516" tips="复制节点链接"></i></h3><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">1970</span>-<span class="hljs-number">12</span>-<span class="hljs-number">07</span> <span class="hljs-number">10</span>:<span class="hljs-number">27</span>:<span class="hljs-number">48.228</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">26984</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20010045</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV_MAPERR</span>)@<span class="hljs-number">0000000000000004</span>  <span class="hljs-title class_">probably</span> <span class="hljs-title class_">caused</span> <span class="hljs-title class_">by</span> <span class="hljs-title class_">NULL</span> <span class="hljs-title class_">pointer</span> <span class="hljs-title class_">dereference</span> </li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">Info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">27270</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">xxx</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000022770</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libapp</span> <span class="hljs-variable">context</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AbilityRuntime</span>::<span class="hljs-title class_">ApplicationContext</span>::<span class="hljs-title class_">DispatchWindowStageFocus</span> (<span class="hljs-variable">std</span>::<span class="hljs-variable">__l</span>::<span class="hljs-title class_">shared</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-title class_">NativeReference</span>&gt; <span class="hljs-title class_">consts</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">__l</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">NativeReference</span>&gt; <span class="hljs-title class_">consts</span>)+<span class="hljs-number">152</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000014</span><span class="hljs-variable">ea58</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libabilitykit_native</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">AbilityImpl</span>::<span class="hljs-title class_">AfterFocused</span>()+<span class="hljs-number">560</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000014</span><span class="hljs-variable">f8ec</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libabilitykit_native</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">AbilityImpl</span>::<span class="hljs-title class_">WindowLifeCycleImpl</span>::<span class="hljs-title class_">AfterFocused</span>()+<span class="hljs-number">92</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000006</span><span class="hljs-variable">acb8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libwm</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span></li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000000e680</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventHandler</span>::<span class="hljs-title class_">DistributeEvent</span> (<span class="hljs-variable">std</span>::<span class="hljs-variable">__l</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-title class_">InnerEvent</span>, <span class="hljs-title class_">void</span> (*)(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">InnerEvent</span>*)&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">808</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000174</span><span class="hljs-variable">cc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span></li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000015</span><span class="hljs-variable">c30</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span></li><li>#<span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000018698</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span></li><li>#<span class="hljs-number">08</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-variable">d02a0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libc</span>.<span class="hljs-title function_">so</span>(<span class="hljs-title function_">__pthread_start</span>(<span class="hljs-variable">void</span>*)+<span class="hljs-number">40</span>)</li><li>#<span class="hljs-number">09</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000072128</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libc</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">__start_thread</span>+<span class="hljs-number">68</span>)</li></ol></pre></div></div> </div> <p>空指针类型崩溃可以从故障原因得到提示信息。通过llvm-addr2line解行号发现业务代码中在使用智能指针之前未对智能指针判空，对空地址进行访问导致崩溃产生。</p> <div class="tiledSection"><h3 id="section82242023556">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section82242023556" tips="复制节点链接"></i></h3></div> <p>对所有使用该指针的地方进行保护性判空。</p> <div class="tiledSection"><h3 id="section1807122910513">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section1807122910513" tips="复制节点链接"></i></h3></div> <p>指针在使用之前应该要进行判空处理，防止访问空指针造成进程崩溃退出。</p> <div class="tiledSection"><h2 id="section1282391012314">案例2：多线程竞争问题<i class="anchor-icon anchor-icon-link" anchorid="section1282391012314" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section98001142951" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section98001142951" tips="复制节点链接"></i></h3></div> <p>napi_env释放后仍被使用。</p> <div class="tiledSection"><h3 id="section7792135013515">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section7792135013515" tips="复制节点链接"></i></h3></div> <p>核心崩溃栈如下：</p> <p><span><img originheight="242" originwidth="1688" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163453.13152343950206463805154752821319:50001231000000:2800:DFC388DD90BD6C39037CBAA149978555752DC2236EF80A05F9E8F0431AD3DAAA.png" width="920" height="131.89573459715638"></span></p> <div class="tiledSection"><h3 id="section64751613619">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section64751613619" tips="复制节点链接"></i></h3></div> <p>napi接口的env（JavaScript环境）指向非法内存，崩溃栈直接挂在NativeEngineInterface::ClearLastError()中，增加维测打印后结合HiLog梳理崩溃前的业务流程，根据打印的env地址0000007F01338CC0定位，发现是env被释放后仍然被使用。</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ipc在线程1创建remoteobj对象</span>,<span class="hljs-variable">并保存当前线程的env</span></li><li><span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">32.108</span> <span class="hljs-number">3952</span> <span class="hljs-number">4030</span> <span class="hljs-title class_">I</span> <span class="hljs-title class_">CO1510</span>/<span class="hljs-variable">napi_remoteObject_holer</span>:<span class="hljs-number">27</span>:[<span class="hljs-title class_">crashtest</span>],<span class="hljs-variable">NAPIRemoteObjectHolder</span> <span class="hljs-variable">create</span>, <span class="hljs-variable">env</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01338CC0</span>, <span class="hljs-variable">holder</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01331E00</span>, <span class="hljs-variable">descriptor</span>:<span class="hljs-title class_">connect</span>-<span class="hljs-title class_">test</span></li><li><span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">32.109</span> <span class="hljs-number">3952</span> <span class="hljs-number">4030</span> <span class="hljs-title class_">I</span> <span class="hljs-title class_">CO1510</span>/<span class="hljs-variable">napi_remoteObject</span>:<span class="hljs-number">161</span>:[<span class="hljs-title class_">crashtest</span>] <span class="hljs-variable">NAPIRemoteObject</span> <span class="hljs-variable">create</span>, <span class="hljs-variable">desc</span>:<span class="hljs-title class_">connect</span>-<span class="hljs-title class_">test</span>,<span class="hljs-keyword">this</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01329F60</span>,<span class="hljs-variable">env</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01338CC0</span></li><li><span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">32.142</span> <span class="hljs-number">3952</span> <span class="hljs-number">4030</span> <span class="hljs-title class_">I</span> <span class="hljs-title class_">CO1510</span>/<span class="hljs-variable">napi_remoteObject_holer</span>:<span class="hljs-number">32</span>:[<span class="hljs-title class_">crashtest</span>],<span class="hljs-variable">NAPIRemoteObjectHolder</span> <span class="hljs-variable">release</span>, <span class="hljs-variable">env</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01338CC0</span>, <span class="hljs-variable">holder</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01331E00</span></li><li><span class="hljs-variable">线程1的引擎</span>(<span class="hljs-variable">env</span>)<span class="hljs-variable">被析构行</span></li><li><span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">32.143</span> <span class="hljs-number">3952</span> <span class="hljs-number">4030</span> <span class="hljs-title class_">I</span> <span class="hljs-title class_">C03900</span>/<span class="hljs-variable">NAPI</span>:[(<span class="hljs-variable">ark_native_engine</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">64</span>)(~<span class="hljs-variable">ArkNativeEngine</span>)] <span class="hljs-variable">ArkNativeEngine</span>:~<span class="hljs-title class_">ArkNativeEngine</span></li><li><span class="hljs-variable">ipc在线程2中使用先前保存的env</span>,<span class="hljs-variable">出现崩溃</span></li><li><span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">43.034</span> <span class="hljs-number">3952</span> <span class="hljs-number">3997</span> <span class="hljs-title class_">I</span> <span class="hljs-title class_">C01510</span>/<span class="hljs-variable">napi_remoteObject</span>: <span class="hljs-number">171</span>:[<span class="hljs-title class_">crashtest</span>] <span class="hljs-variable">NAPIRemoteObject</span> <span class="hljs-variable">Destructor</span>, <span class="hljs-keyword">this</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01329F60</span>,<span class="hljs-variable">env</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">F01338CC0</span></li></ol></pre></div></div> <p>由于JavaScript本身是单线程执行的，对env的任何操作都必须在创建该JS线程的原始线程上进行，如果违反该规则可能会出现意想不到的问题。</p> <div class="tiledSection"><h3 id="section17091311618">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section17091311618" tips="复制节点链接"></i></h3></div> <p>一个线程创建的env，不要传递给其他线程使用。</p> <div class="tiledSection"><h3 id="section14465141917611">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section14465141917611" tips="复制节点链接"></i></h3></div> <p>对于栈顶崩溃在libace_napi.z.so、libark_jsruntime.so等库操作env的问题，并且出现概率相对较高，在CppCrash日志的调用栈难以直接分析出崩溃原因情况下，可以考虑开启<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-multi-thread-check" target="_blank">多线程检测</a>帮助开发者快速定位问题。此外，在多线程操作STL容器（如vector、map、set等）的场景中，由于STL容器是非线程安全的，如果多线程进行添加和删除操作，容易出现SIGSEGV类崩溃，如果崩溃现场代码与STL容器相关，也可以考虑是多线程竞争问题。</p> <div class="tiledSection"><h2 id="section3692438732">案例3：内存访问类崩溃问题<i class="anchor-icon anchor-icon-link" anchorid="section3692438732" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section61553111620" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section61553111620" tips="复制节点链接"></i></h3></div> <p>每次崩溃地址都在libace_napi_ark.z.so的可读可执行段上。崩溃原因是需要对地址进行写操作，而对应的maps段只有可读、可执行权限没有写权限，当进程试图访问不被允许访问的内存区域时，进程发生内存访问类崩溃。</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>7f82740000-7f8275c000 r--p 00000000 /system/lib64/libace_napi_ark.z.so</li><li>7f8275c000-7f8276e000 r-xp 0001b000 /system/lib64/libace_napi_ark.z.so &lt;-崩溃地址落在该地址区间</li><li>7f8276e000-7f82773000 r--p 0002c000 /system/lib64/libace_napi_ark.z.so</li><li>7f82773000-7f82774000 rw-p 00030000 /system/lib64/libace_napi_ark.z.so</li></ol></pre></div></div> <div class="tiledSection"><h3 id="section11978174213617">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section11978174213617" tips="复制节点链接"></i></h3></div> <p>崩溃调用栈如下图。</p> <p><span><img originheight="645" originwidth="1847" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163453.02446541480332366147769716690169:50001231000000:2800:67AA6490C09484EAE1C54A4350BC1991A6D0393E3CEF2FDA0EC880C337DB62AE.png" width="920" height="321.27774769897127"></span></p> <div class="tiledSection"><h3 id="section53313557614">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section53313557614" tips="复制节点链接"></i></h3></div> <p>根据业务逻辑分析，node应该保存在堆上，node地址不可能落在libace_napi_ark.z.so的代码段。从问题的现象分析，大概率是踩内存问题。踩内存问题可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hwasan" target="_blank">HWASan工具</a>排查问题。于是后续使用ASan版本进行压测复现，也找到了稳定必现的场景。ASan版本检测出来的问题也和上面崩溃栈反映的问题一致。ASan日志显示的踩内存类型是heap-use-after-free，根据日志信息弄清从内存申请、内存释放到使用已被释放的内存整个过程。经过分析后发现业务代码对同一个地址（0x003a375eb724）进行重复释放，在重复释放内存操作时，使用该地址去访问了其对象成员，因此报出了use-after-free（使用已经释放的内存）问题。</p> <p>ASan核心日志如下：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>=================================================================</li><li>==appspawn==2029==ERROR: AddressSanitizer: heap-use-after-free on address 0x003a375eb724 at pc 0x002029ba8514 bp 0x007fd8175710 sp 0x007fd8175708</li><li>READ of size 1 at 0x003a375eb724 thread T0 (thread name) &lt;- 使用已被释放的内存现场</li><li>    # 0 0x2029ba8510  (/system/asan/lib64/platformsdk/libark_jsruntime.so+0xca8510) panda::ecmascript::Node::IsUsing() const at arkcompiler/ets_runtime/ecmascript/ecma_global_storage.h:82:16</li><li>(inlined by) panda::JSNApi::DisposeGlobalHandleAddr(panda::ecmascript::EcmaVM const*, unsigned long) at arkcompiler/ets_runtime/ecmascript/napi/jsnapi.cpp:749:67 BuildID[md5/uuid]=9a18e2ec0dc8a83216800b2f0dd7b76a</li><li>    # 1 0x403ee94d30  (/system/asan/lib64/libace.z.so+0x6194d30) panda::CopyableGlobal&lt;panda::ObjectRef&gt;::Free() at arkcompiler/ets_runtime/ecmascript/napi/include/jsnapi.h:1520:9</li><li>(inlined by) panda::CopyableGlobal&lt;panda::ObjectRef&gt;::Reset() at arkcompiler/ets_runtime/ecmascript/napi/include/jsnapi.h:189:9</li><li>(inlined by) OHOS::Ace::Framework::JsiType&lt;panda::ObjectRef&gt;::Reset() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/engine/jsi/jsi_types.inl:112:13</li><li>(inlined by) OHOS::Ace::Framework::JsiWeak&lt;OHOS::Ace::Framework::JsiObject&gt;::~JsiWeak() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/engine/jsi/jsi_ref.h:167:16</li><li>(inlined by) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:44:5 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 2 0x403ee9296c  (/system/asan/lib64/libace.z.so+0x619296c) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:42:5</li><li>(inlined by) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:42:5 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 3 0x403ed9b130  (/system/asan/lib64/libace.z.so+0x609b130) OHOS::Ace::Referenced::DecRefCount() at foundation/arkui/ace_engine/frameworks/base/memory/referenced.h:76:13</li><li>(inlined by) OHOS::Ace::RefPtr&lt;OHOS::Ace::Framework::ViewFunctions&gt;::~RefPtr() at foundation/arkui/ace_engine/frameworks/base/memory/referenced.h:148:22 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 4 0x403ed9b838  (/system/asan/lib64/libace.z.so+0x609b838) OHOS::Ace::RefPtr&lt;OHOS::Ace::Framework::ViewFunctions&gt;::Reset() at foundation/arkui/ace_engine/frameworks/base/memory/referenced.h:163:9</li><li>(inlined by) OHOS::Ace::Framework::JSViewFullUpdate::~JSViewFullUpdate() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view.cpp:159:21 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 5 0x403ed9bf24  (/system/asan/lib64/libace.z.so+0x609bf24) OHOS::Ace::Framework::JSViewFullUpdate::~JSViewFullUpdate() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view.cpp:157:1</li><li>(inlined by) OHOS::Ace::Framework::JSViewFullUpdate::~JSViewFullUpdate() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view.cpp:157:1 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>...</li><li>freed by thread T0 (thread name) here: &lt;- 内存释放的现场</li><li>    # 0 0x2024ed3abc  (/system/asan/lib64/libclang_rt.asan.so+0xd3abc)</li><li>    # 1 0x2029ba8424  (/system/asan/lib64/platformsdk/libark_jsruntime.so+0xca8424) std::__h::__function::__value_func&lt;void (unsigned long)&gt;::operator()[abi:v15004](unsigned long&amp;&amp;) const at prebuilts/clang/ohos/linux-x86_64/llvm/bin/../include/libcxx-ohos/include/c++/v1/__functional/function.h:512:16</li><li>(inlined by) std::__h::function&lt;void (unsigned long)&gt;::operator()(unsigned long) const at prebuilts/clang/ohos/linux-x86_64/llvm/bin/../include/libcxx-ohos/include/c++/v1/__functional/function.h:1197:12</li><li>(inlined by) panda::ecmascript::JSThread::DisposeGlobalHandle(unsigned long) at arkcompiler/ets_runtime/ecmascript/js_thread.h:604:9</li><li>(inlined by) panda::JSNApi::DisposeGlobalHandleAddr(panda::ecmascript::EcmaVM const*, unsigned long) at arkcompiler/ets_runtime/ecmascript/napi/jsnapi.cpp:752:24 BuildID[md5/uuid]=9a18e2ec0dc8a83216800b2f0dd7b76a</li><li>    # 2 0x403ee94b68  (/system/asan/lib64/libace.z.so+0x6194b68) panda::CopyableGlobal&lt;panda::FunctionRef&gt;::Free() at arkcompiler/ets_runtime/ecmascript/napi/include/jsnapi.h:1520:9</li><li>(inlined by) panda::CopyableGlobal&lt;panda::FunctionRef&gt;::Reset() at arkcompiler/ets_runtime/ecmascript/napi/include/jsnapi.h:189:9</li><li>(inlined by) OHOS::Ace::Framework::JsiType&lt;panda::FunctionRef&gt;::Reset() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/engine/jsi/jsi_types.inl:112:13</li><li>(inlined by) OHOS::Ace::Framework::JsiWeak&lt;OHOS::Ace::Framework::JsiFunction&gt;::~JsiWeak() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/engine/jsi/jsi_ref.h:167:16</li><li>(inlined by) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:44:5 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 3 0x403ee9296c  (/system/asan/lib64/libace.z.so+0x619296c) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:42:5</li><li>(inlined by) OHOS::Ace::Framework::ViewFunctions::~ViewFunctions() at foundation/arkui/ace_engine/frameworks/bridge/declarative_frontend/jsview/js_view_functions.h:42:5 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>    # 4 0x403ed9b130  (/system/asan/lib64/libace.z.so+0x609b130) OHOS::Ace::Referenced::DecRefCount() at foundation/arkui/ace_engine/frameworks/base/memory/referenced.h:76:13</li><li>(inlined by) OHOS::Ace::RefPtr&lt;OHOS::Ace::Framework::ViewFunctions&gt;::~RefPtr() at foundation/arkui/ace_engine/frameworks/base/memory/referenced.h:148:22 BuildID[md5/uuid]=1330f8b9be73bdb76ae18107c2a60ca1</li><li>...</li><li>previously allocated by thread T0 (thread name) here: &lt;- 内存申请的现场</li><li>    # 0 0x2024ed3be4  (/system/asan/lib64/libclang_rt.asan.so+0xd3be4)</li><li>    # 1 0x2029ade778  (/system/asan/lib64/platformsdk/libark_jsruntime.so+0xbde778) panda::ecmascript::NativeAreaAllocator::AllocateBuffer(unsigned long) at arkcompiler/ets_runtime/ecmascript/mem/native_area_allocator.cpp:98:17 BuildID[md5/uuid]=9a18e2ec0dc8a83216800b2f0dd7b76a</li><li>    # 2 0x2029a39064  (/system/asan/lib64/platformsdk/libark_jsruntime.so+0xb39064) std::__h::enable_if&lt;!std::is_array_v&lt;panda::ecmascript::NodeList&lt;panda::ecmascript::WeakNode&gt;&gt;, panda::ecmascript::NodeList&lt;panda::ecmascript::WeakNode&gt;*&gt;::type panda::ecmascript::NativeAreaAllocator::New&lt;panda::ecmascript::NodeList&lt;panda::ecmascript::WeakNode&gt;&gt;() at arkcompiler/ets_runtime/ecmascript/mem/native_area_allocator.h:61:19</li><li>(inlined by) unsigned long panda::ecmascript::EcmaGlobalStorage&lt;panda::ecmascript::Node&gt;::NewGlobalHandleImplement&lt;panda::ecmascript::WeakNode&gt;(panda::ecmascript::NodeList&lt;panda::ecmascript::WeakNode&gt;**, panda::ecmascript::NodeList&lt;panda::ecmascript::WeakNode&gt;**, unsigned long) at arkcompiler/ets_runtime/ecmascript/ecma_global_storage.h:565:34</li><li>(inlined by) panda::ecmascript::EcmaGlobalStorage&lt;panda::ecmascript::Node&gt;::SetWeak(unsigned long, void*, void (*)(void*), void (*)(void*)) at arkcompiler/ets_runtime/ecmascript/ecma_global_storage.h:455:26 BuildID[md5/uuid]=9a18e2ec0dc8a83216800b2f0dd7b76a</li><li>    # 3 0x2029ba5620  (/system/asan/lib64/platformsdk/libark_jsruntime.so+0xca5620) std::__h::__function::__value_func&lt;unsigned long (unsigned long, void*, void (*)(void*), void (*)(void*))&gt;::operator()[abi:v15004](unsigned long&amp;&amp;, void*&amp;&amp;, void (*&amp;&amp;)(void*), void (*&amp;&amp;)(void*)) const at prebuilts/clang/ohos/linux-x86_64/llvm/bin/../include/libcxx-ohos/include/c++/v1/__functional/function.h:512:16</li><li>(inlined by) std::__h::function&lt;unsigned long (unsigned long, void*, void (*)(void*), void (*)(void*))&gt;::operator()(unsigned long, void*, void (*)(void*), void (*)(void*)) const at prebuilts/clang/ohos/linux-x86_64/llvm/bin/../include/libcxx-ohos/include/c++/v1/__functional/function.h:1197:12</li><li>(inlined by) panda::ecmascript::JSThread::SetWeak(unsigned long, void*, void (*)(void*), void (*)(void*)) at arkcompiler/ets_runtime/ecmascript/js_thread.h:610:16</li><li>(inlined by) panda::JSNApi::SetWeak(panda::ecmascript::EcmaVM const*, unsigned long) at arkcompiler/ets_runtime/ecmascript/napi/jsnapi.cpp:711:31 BuildID[md5/uuid]=9a18e2ec0dc8a83216800b2f0dd7b76a</li><li>...</li></ol></pre></div></div> <p>根据调用栈继续分析，JsiWeak析构或重置的时候会触发其成员（类型为JsiObject/JsiValue/JsiFunction）父类JsiType中CopyableGlobal被释放，如下图。</p> <p><span><img originheight="608" originwidth="1367" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163453.53571751996247596379096709174057:50001231000000:2800:E3D1B6D5E6A50F928AFA8F58B1DAD009B37377248E651D70B41EAC660A330DD8.png" width="920" height="409.1880029261156"></span></p> <p>运行时在GC过程中IterateWeakEcmaGlobalStorage，会对无callback的WeakNode调用DisposeGlobalHandle操作，也对其进行释放，如下图。</p> <p><span><img originheight="471" originwidth="1014" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163453.99312895182896931981214384282771:50001231000000:2800:6F3D01C3ED1F98525CD7225A8720313894118FB84614DBE2D2FA10BA65C019F4.png" width="920" height="427.33727810650885"></span></p> <p>对于同一个WeakNode，可能会存在两个入口释放。如果是GC过程中IterateWeakEcmaGlobalStorage先释放，因为无callback回调通知到JsiWeak进行清理，JsiWeak那边仍保存一个对已释放的WeakNode引用，即CopyableGlobal；当前面讲的WeakNode所在的NodeList被整体释放，JsiWeak处保留的CopyableGlobal再释放，就会存在重复释放内存问题。</p> <p><span><img originheight="484" originwidth="895" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163454.55123264299061825517638436801547:50001231000000:2800:F64B7A98BC018C1523E71696DAC8F32D235436B95D21672D6501650650A7B65C.png" width="895" height="484"></span></p> <div class="tiledSection"><h3 id="section202214185714">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section202214185714" tips="复制节点链接"></i></h3></div> <p>JsiWeak调用SetWeakCallback，传入callback，在GC过程中IterateWeakEcmaGlobalStorage释放WeakNode时，通知JsiWeak对其保存的CopyableGlobal进行重置，确保同一个地址不被重复释放。</p> <div class="tiledSection"><h3 id="section1083182513720">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section1083182513720" tips="复制节点链接"></i></h3></div> <p>使用内存时应考虑是否存在重复释放或者未释放的可能，另外定位内存访问类崩溃问题（一般是SIGSEGV类型问题）时，如果根据调用栈继续分析问题无头绪时，应优先考虑使能HWASan版本复现问题。</p> <div class="tiledSection"><h2 id="section1662118147417">案例4：生命周期类问题<i class="anchor-icon anchor-icon-link" anchorid="section1662118147417" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section192827336720" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section192827336720" tips="复制节点链接"></i></h3></div> <p>生命周期类问题是指在对象生命周期外访问其内存产生崩溃的问题，通常是由于不恰当使用裸指针造成。裸指针是指不具有封装或自动内存管理特性的指针。它只是一个简单的指针，指向内存地址，没有保护或管理指针指向的内存。裸指针可以直接访问内存，但容易导致内存泄漏和空指针引用等问题。使用裸指针时需要特别小心，以避免潜在的安全问题。推荐使用智能指针来管理内存。</p> <div class="tiledSection"><h3 id="section1227813377710">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section1227813377710" tips="复制节点链接"></i></h3></div> <p>开发者在写native代码创建napi_value时，需要配合napi_handle_scope一起使用。napi_handle_scope的作用是管理napi_value的生命周期，napi_value只能在napi_handle_scope的作用域范围内进行使用，离开napi_handle_scope作用域范围后，napi_value及它所持有的JS对象的生命周期不再得到保护，一旦引用计数为0，就会被GC回收掉，此时再去使用napi_value就会访问已释放的内存，产生问题。</p> <p>napi_value其实是个裸指针（结构体指针），其作用是持有JS对象，用于保持JS对象的生命周期，保证JS对象不被GC当成垃圾对象回收。离开napi_handle_scope作用域之后，napi_value由GC回收，napi_value不再持有JS对象（不再保护JS对象生命周期）。</p> <div class="tiledSection"><h3 id="section119214492715">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section119214492715" tips="复制节点链接"></i></h3></div> <p>根据调用栈定位到行号找到出现问题的napi接口的上层接口，在上层接口内找到出问题的napi_value，检查napi_value的使用范围是否超出了napi_handle_scope的作用域范围。</p> <p>napi_value超出napi_handle_scope的作用域范围，如下：</p> <div class="screenLinkPre"><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/napi_init.cpp#L19-L42" data-highlighted="yes"><ol class="linenums"><li>static napi_value Add(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info)</li><li>{</li><li>    size_t argc = 2;</li><li>    napi_value args[2] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(<span class="hljs-built_in">env</span>, info, &amp;argc, args , nullptr, nullptr);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, args[0], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, args[1], &amp;valuetype1);</li><li>
</li><li>    double value0;</li><li>    napi_get_value_double(<span class="hljs-built_in">env</span>, args[0], &amp;value0);</li><li>
</li><li>    double value1;</li><li>    napi_get_value_double(<span class="hljs-built_in">env</span>, args[1], &amp;value1);</li><li>
</li><li>    napi_value <span class="hljs-built_in">sum</span>;</li><li>    napi_create_double(<span class="hljs-built_in">env</span>, value0 + value1, &amp;<span class="hljs-built_in">sum</span>);</li><li>
</li><li>    <span class="hljs-built_in">return</span> <span class="hljs-built_in">sum</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/napi_init.cpp#L19-L42" target="_blank">napi_init.cpp</a></div></div></div></div> <p>JS侧通过Add接口添加数据，native侧以napi_value保存到vector，JS侧通过get接口获取添加的数据，native侧将保存的napi_value以数组形式返回回去，然后JS侧读取数据的属性。出现报错：Can not get Prototype on non ECMA Object。跨napi的native_value未使用napi_ref保存，导致native_value失效。</p> <div class="tiledSection"><h3 id="section241514557818">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section241514557818" tips="复制节点链接"></i></h3><p>开发者可以通过napi_handle_scope来管理napi_value的生命周期，进入native方法前开始作用域，从native方法出来后结束作用域，详细使用请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-life-cycle" target="_blank">使用Node-API接口进行生命周期相关开发</a>。</p> </div> <div class="tiledSection"><h2 id="section134911495417">案例5：SIGABRT类崩溃问题<i class="anchor-icon anchor-icon-link" anchorid="section134911495417" tips="复制节点链接"></i></h2></div> <p>SIGABRT进程异常终止，通常为进程自身调用标准函数库的abort()函数，崩溃原因在调用abort()函数的代码。由程序检测到异常时触发，如线程创建失败，文件描述符使用异常等，大多数情况是各基础库（C库等）进行校验操作，校验失败会主动终止进程。</p> <div class="screenLinkPre"><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse5.cpp#L32-L37" data-highlighted="yes"><ol class="linenums"><li>static napi_value <span class="hljs-built_in">TriggerCrash</span>(napi_env env, napi_callback_info info)</li><li>{</li><li>    <span class="hljs-built_in">OH_LOG_FATAL</span>("LOG_APP", "test fatal log.");</li><li>    <span class="hljs-built_in">abort</span>();</li><li>    return <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse5.cpp#L32-L37" target="_blank">CppCrashCaseAnalyse5.cpp</a></div></div></div></div> <p><span><img originheight="1040" originwidth="1920" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163454.98542023852284181308592790449879:50001231000000:2800:1FFF006A8447BA08AC65ABDD45950C2FDE5017B3E7A525298CBB206D8ABE61E3.png" width="920" height="498.33333333333337"></span>构造主动调用abort函数场景举例说明SIGABRT类崩溃问题如何分析。上图所示，LastFatalMessage是进程退出前的最后一条fatal级别日志，对于SIGABRT类崩溃问题其一般能提供程序主动异常终止的原因，对定位该类问题有很大帮助。从上往下跳过C库的调用栈，找到调用abort函数的调用栈（图中#02层调用栈），从这里结合LastFatalMessage进行分析。</p> <p>除了调用abort函数外，C++中的另一个异常处理机制还包括assert函数，assert用于校验当前函数执行流程中的一些数据，校验失败进程会主动终止，分析问题的方法都是一样的。</p> <div class="screenLinkPre"><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse6.cpp#L29-L38" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TriggerCrash</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0  <span class="hljs-comment">//If the value is 0, an error will be reported. If it is 1, it is normal</span></span></li><li>    <span class="hljs-type">void</span> *pc = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1024</span>);</li><li><span class="hljs-meta">#<span class="hljs-keyword">else</span></span></li><li>    <span class="hljs-type">void</span> *pc = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li>    <span class="hljs-built_in">assert</span>(pc != <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse6.cpp#L29-L38" target="_blank">CppCrashCaseAnalyse6.cpp</a></div></div></div></div> <p><span><img originheight="1040" originwidth="1920" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163454.27198037721197505034550606320999:50001231000000:2800:FC22BF5A153A65CCFAC2516C8D3C6826A2195521A5300F3030A9E7031EAB4DFF.png" width="920" height="498.33333333333337"></span></p> <div class="tiledSection"><h2 id="section10107179911">案例6：通过反汇编分析CppCrash问题<i class="anchor-icon anchor-icon-link" anchorid="section10107179911" tips="复制节点链接"></i></h2></div> <p><strong>llvm-objdump工具使用方法</strong></p> <p>llvm-objdump是系统侧提供的反汇编工具，归档路径[SDK DIR PATH]/default/HarmonyOS/native/llvm/bin/llvm-objdump.exe，使用命令如下：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>llvm-objdump.exe -d -l libark_jsruntime.so &gt; dump.txt</li></ol></pre></div></div> <p>进行以上操作可以导出libark_jsruntime.so的全量汇编指令到dump.txt文件。</p> <p><strong>结合具体案例解答</strong></p> <p>CppCrash日志核心内容如下：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>Process name:xxx</li><li>Process life time:13402s</li><li>Process Memory(kB): 11902(Rss)</li><li>Device Memory(kB): Total 1935820, Free 516244, Available 1205608</li><li>Reason:SIGSEGV(SEGV_MAPERR)@0x0000005b3b46c000</li><li>Fault thread info:</li><li>Tid:48552, Name:xxx</li><li>#00 pc 00000000000a87e4 /system/lib/ld-musl-aarch64.so.1(memcpy+356)(3c3e7fb27680dc2ee99aa08dd0f81e85)</li><li>...</li></ol></pre></div></div> <p>分析步骤：</p> <ol><li><p>根据pc寄存器地址找到对应的汇编指令，确定在哪条指令执行时发生崩溃。</p> <p>在CppCrash日志文件中找到栈顶的PC地址，并反汇编对应的二进制。</p> <p>例如在执行00000000000a87e4地址对应的指令时发生崩溃，反汇编查看ld-musl-aarch64.so.1文件0xa87e4偏移地址显示的信息：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>xxx/../../third_party/optimized-routines/string/aarch64/memcpy.S:175 &lt;- 源码行号</li><li>a87e4：a94371aa         ldp x10, x11, [x1, #48]</li><li>地址：    值                   汇编指令</li></ol></pre></div></div> <p>ldr指令是加载多数据指令（LDP-Load Pair），用于从内存中同时加载两个64位的数据到两个不同的寄存器中。</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>ldp    x10,        x11,    [x1, #48]</li><li>ldp 目标寄存器1, 目标寄存器2, &lt;源地址&gt;</li></ol></pre></div></div> <p>从内存中指定位置（由寄存器x1中地址加上48字节偏移量确定）读取两个连续的64位数据，并将它们分别存储到寄存器x10和x11中。</p> <p>根据反汇编显示的源码文件位置175行，查看对应memcpy.S源文件代码：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>L(loop64):</li><li>line 170   stp A_l, A_h, [dst, 16]</li><li>line 171   ldp A_l, A_h, [src, 16]</li><li>line 172   stp B_l, B_h, [dst, 32]</li><li>line 173   ldp B_l, B_h, [src, 32]</li><li>line 174   stp C_l, C_h, [dst, 48]</li><li>line 175   ldp C_l, C_h, [src, 48]      &lt;-  崩溃处指令</li><li>line 176   stp D_l, D_h, [dst, 64]</li><li>line 177   ldp D_l, D_h, [src, 64]</li><li>line 178   subs count, count, 64</li><li>line 179   b.hi L(loop64)</li></ol></pre></div></div> </li><li><p>根据寄存器值，结合上下文确定哪个对象导致了问题。</p> <p>非类成员函数x0寄存器加载的是函数第1个参数，x1加载的是第2个参数，x2加载的第3个参数，依次类推；类成员函数，x0加载的是类实例对象的指针，其后x1、x2、x3为参数，注意函数参数超过5个会压入栈中。栈顶函数void* memcpy(void* restrict dest, void* restrict src, size_t n)参数，x0是dest（目的地址）, x1是src（源地址），x2是n（拷贝字节数）。</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>Register:</li><li>x0:000005b50c3e3c4 x1:000005b3b46bfcc x2:0000000000007e88 x3:000005b50c42380</li><li>...</li></ol></pre></div></div> <p>根据在CppCrash日志中找到对应的三个寄存器值，结合崩溃地址0x0000005b3b46c000，确定出问题的参数是memcpy函数第2个参数（源地址）。</p> </li><li><p>结合崩溃地址附近的内存特征确定问题类型。</p> <p>通过CppCrash日志中Memory near registers查看寄存器附近内存地址值：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="text prettyprint linenums hljs language-plaintext" hw-language="text" data-highlighted="yes"><ol class="linenums"><li>x1(xxxx):</li><li>    0000005b3b46bfbc 3e99fedbc0a9b5e9</li><li>    0000005b3b46bfc4 a91ab9d327969682</li><li>    0000005b3b46bfcc 83906d9c18cdb9c1</li><li>    0000005b3b46bfd4 627dd75ab9335eb0</li><li>    0000005b3b46bfdc aabe2bb1b00f2c03</li><li>    0000005b3b46bfe4 f981e4acb716cbc1</li><li>    0000005b3b46bfec 806b3d5730d281ee</li><li>    0000005b3b46bff4 3e99fedbc0a9b5e9</li><li>    0000005b3b46bffc ffffffffffffffff  -&gt; 内存值是ffffffffffffffff表示0000005b3b46bffc是非法地址，读取越界</li><li>    0000005b3b46c004 ffffffffffffffff</li><li>    0000005b3b46c00c ffffffffffffffff</li><li>    0000005b3b46c014 ffffffffffffffff</li><li>    0000005b3b46c01c ffffffffffffffff</li><li>    0000005b3b46c024 ffffffffffffffff</li><li>    0000005b3b46c02c ffffffffffffffff</li><li>    0000005b3b46c034 ffffffffffffffff</li><li>    ...</li></ol></pre></div></div> <p>以上确定是一个读取越界的问题，只需分析代码中调用memcpy时传入的src（源内存的指针）和n（拷贝的字节数）两个参数即可。</p> </li><li><p>跟踪出问题对象的参数来源，结合代码与流水日志确定问题。</p> <ul><li><p>排查参数对象的有效性、范围是否合法，例如源内存的实际大小是否与传入的n一致。</p> </li><li><p>排查参数对象的生命周期是否合法，例如源内存是否已被释放，是否存在多线程操作对象。</p> </li><li><p>根据函数的上下文，排查参数的不合理操作逻辑，例如跟踪buf和bufsize的操作逻辑，增加调试信息，锁定不合理操作逻辑，上下文片段如下。</p> <div class="screenLinkPre"><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalysis8.cpp#L25-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">xxxFunc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *buf, <span class="hljs-type">uint32_t</span> bufSize)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-type">uint32_t</span> srcOffset = appendOffset - bufSize;</li><li>    <span class="hljs-keyword">auto</span> ret = <span class="hljs-built_in">memcpy</span>(cache + srcOffset, buf, bufSize);</li><li>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalysis8.cpp#L25-L34" target="_blank">CppCrashCaseAnalysis8.cpp</a></div></div></div></div> <p></p> </li></ul> <p>通过持续追踪buf和bufSize的来源，最终确定buf实际大小与bufSize在连续拷贝后不匹配，bufSize大于实际buf大小导致越界读取。</p> </li></ol> <div class="tiledSection"><h2 id="section4979192312276">案例7：ILL_ILLPACCFI类崩溃问题<i class="anchor-icon anchor-icon-link" anchorid="section4979192312276" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6311181301120" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section6311181301120" tips="复制节点链接"></i></h3></div> <p>ILL_ILLPACCFI类崩溃问题仅在开启指针校验功能后，在校验指针时发现异常产生崩溃。因此该类问题需要分析是什么原因造成指针异常，导致校验指针失败。</p> <div class="tiledSection"><h3 id="section13971916191119">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section13971916191119" tips="复制节点链接"></i></h3></div> <p>进程发生崩溃后生成的cppcrash中Reason字段是ILL_ILLPACCFI，崩溃日志核心内容如下：</p> <div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Generated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">HiviewDFX</span>@<span class="hljs-title function_">OpenHarmony</span></li><li><span class="hljs-variable">Device</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Build</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Fingerprint</span>:<span class="hljs-number">2e5</span><span class="hljs-title class_">b4fa2280718c81a0ad9597d1c86676b6cce4f6beeda75d7068cafbafd9f86</span></li><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">fpac10</span></li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">2025</span>-<span class="hljs-number">06</span>-<span class="hljs-number">12</span> <span class="hljs-number">14</span>:<span class="hljs-number">19</span>:<span class="hljs-number">29.750</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">540</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">0</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:./<span class="hljs-variable">fpacl0</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-title class_">ls</span></li><li><span class="hljs-variable">ReaSon</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGILL</span>(<span class="hljs-title class_">ILL_ILLPACCFI</span>) @<span class="hljs-number">0x0000005615e449a8</span> &lt;- <span class="hljs-title class_">Reason字段是ILL_ILLPACCFI</span></li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">540</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">fpac10</span>.</li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000019</span><span class="hljs-variable">a8</span> /<span class="hljs-variable">data</span>/<span class="hljs-variable">kernel</span> <span class="hljs-variable">test</span>/<span class="hljs-title function_">fpac10</span>(<span class="hljs-keyword">main</span>+<span class="hljs-number">84</span>) &lt;- <span class="hljs-variable">异常发生位置</span></li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-variable">a1574</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-number">1</span><span class="hljs-variable">d</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">libc_start</span> <span class="hljs-variable">_main_stage2</span>+<span class="hljs-number">80</span>) (<span class="hljs-variable">aca211c0cbb78f65c624199913847e19</span>)</li><li><span class="hljs-variable">Registers</span>: &lt;- <span class="hljs-title class_">寄存器信息</span></li><li><span class="hljs-variable">x0</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cad0</span> <span class="hljs-title class_">x1</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cad0</span> <span class="hljs-title class_">x2</span>:<span class="hljs-number">000000000000000</span><span class="hljs-title class_">c</span> <span class="hljs-title class_">x3</span>:<span class="hljs-number">0000000000006000</span></li><li><span class="hljs-variable">x4</span>:<span class="hljs-number">0000005615e46</span><span class="hljs-title class_">cfc</span> <span class="hljs-title class_">x5</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cadc</span> <span class="hljs-title class_">x6</span>:<span class="hljs-number">0000216</span><span class="hljs-title class_">f6c6c6568</span> <span class="hljs-title class_">x7</span>:<span class="hljs-number">000000000000216</span><span class="hljs-title class_">f</span></li><li><span class="hljs-variable">x8</span>:<span class="hljs-number">0</span> <span class="hljs-number">0000005</span><span class="hljs-title class_">a00000000x9</span>：<span class="hljs-number">000000000000</span><span class="hljs-title class_">a51f</span> <span class="hljs-title class_">xl0</span>:<span class="hljs-number">00000000</span><span class="hljs-title class_">ffffffe0</span> <span class="hljs-title class_">xll</span>:<span class="hljs-title class_">ffffffffffffffd8</span></li><li><span class="hljs-variable">x12</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581c940</span> <span class="hljs-title class_">x13</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a193527ec</span> <span class="hljs-title class_">x14</span>:<span class="hljs-number">0000000000000001</span> <span class="hljs-title class_">x15</span>:<span class="hljs-number">0000000000000000</span></li><li><span class="hljs-variable">x16</span>:<span class="hljs-number">0000005615e45</span><span class="hljs-title class_">cd8</span> <span class="hljs-title class_">x17</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a193cba80</span> <span class="hljs-title class_">x18</span>:<span class="hljs-number">0000000000000000</span> <span class="hljs-title class_">x19</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cb68</span></li><li><span class="hljs-variable">x20</span>:<span class="hljs-number">0000000000000001</span> <span class="hljs-title class_">x21</span>:<span class="hljs-number">0000005615e44954</span> <span class="hljs-title class_">x22</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cb78</span> <span class="hljs-title class_">x23</span>:<span class="hljs-number">00000000000000e8</span></li><li><span class="hljs-variable">X24</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a1951d880</span> <span class="hljs-title class_">x25</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a1951e1a0</span> <span class="hljs-title class_">x26</span>:<span class="hljs-number">0000000000000001</span> <span class="hljs-title class_">x27</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a1951a000</span></li><li><span class="hljs-variable">x28</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">a1951d8c8</span> <span class="hljs-title class_">x29</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581caf0</span></li><li><span class="hljs-variable">lr</span>:<span class="hljs-number">0000005615e4499</span><span class="hljs-title class_">c</span> <span class="hljs-title class_">sp</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fc581cac0</span> <span class="hljs-title class_">pc</span>:<span class="hljs-number">0000005615e449</span><span class="hljs-title class_">a8</span></li></ol></pre></div></div> <div class="tiledSection"><h3 id="section3966271117">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section3966271117" tips="复制节点链接"></i></h3></div> <p>根据CppCrash日志提供的堆栈信息，找到异常发生位置为fpac10二进制中的0x19a8处。</p> <ol><li>根据地址定位到行号发现崩溃在autia汇编指令。<div class="screenLinkPre"><div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse7.cpp#L31-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> g_ori[<span class="hljs-number">12</span>] = <span class="hljs-string">"hello!"</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> context = <span class="hljs-number">0xa51f</span>;</li><li>    <span class="hljs-type">void</span> *addr = (<span class="hljs-type">void</span>*)(&amp;SupportPac::SupportPacPrint);</li><li>    <span class="hljs-type">char</span> a[<span class="hljs-number">8</span>] = {};</li><li>    <span class="hljs-built_in">memcpy</span>(a, &amp;g_ori, <span class="hljs-built_in">sizeof</span>(g_ori)); <span class="hljs-comment">// 伪造内存溢出攻击，篡改addr内容</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ARM_FEATURE_PAUTH</span></li><li>    __asm__ __volatile__(<span class="hljs-string">"autia %0, %1\n\t"</span></li><li>        <span class="hljs-string">"blr %0\n\t"</span></li><li>        : <span class="hljs-string">"+r"</span>(addr) : <span class="hljs-string">"r"</span>(context):);</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li>    std::cout &lt;&lt; a;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/CppCrash/entry/src/main/cpp/CppCrashCaseAnalyse7.cpp#L31-L46" target="_blank">CppCrashCaseAnalyse7.cpp</a></div></div></div></div> </li><li>通过反汇编查看汇编指令，汇编指令片段如下:<div _ngcontent-bix-c106="" class="highlight-div"><div _ngcontent-bix-c106="" class="highlight-div-header"><div _ngcontent-bix-c106="" class="highlight-div-header-left"><div _ngcontent-bix-c106="" class="handle-button expand-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bix-c106="" class="highlight-div-header-right"><div _ngcontent-bix-c106="" class="handle-button ai-button"></div><div _ngcontent-bix-c106="" class="handle-button line-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bix-c106="" class="handle-button theme-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bix-c106="" class="handle-button copy-button"><div _ngcontent-bix-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bix-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">0000000000001954</span> <span class="">&lt;</span><span class=""><span class="hljs-keyword">main</span></span><span class="">&gt;</span>:</li><li><span class="hljs-number">1954</span>: <span class="hljs-title class_">d10103ff</span> <span class="hljs-title class_">sub</span> <span class="hljs-title class_">sP</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">64</span></li><li><span class="hljs-number">1958</span>: <span class="hljs-title class_">a9037bfd</span> <span class="hljs-title class_">stp</span> <span class="hljs-title class_">x29</span>, <span class="hljs-variable">x30</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">48</span>] </li><li><span class="hljs-number">195</span><span class="hljs-variable">c</span>: <span class="hljs-number">9100</span><span class="hljs-title class_">c3fd</span> <span class="hljs-title class_">add</span> <span class="hljs-title class_">x29</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">48</span></li><li><span class="hljs-number">1960</span>: <span class="hljs-number">2</span><span class="hljs-title class_">a1f03e8</span> <span class="hljs-title class_">mov</span> <span class="hljs-title class_">w8</span>, <span class="hljs-variable">wzr</span></li><li><span class="hljs-number">1964</span>: <span class="hljs-title class_">b9000fes</span> <span class="hljs-title class_">str</span> <span class="hljs-title class_">w8</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">12</span>]</li><li><span class="hljs-number">1968</span>: <span class="hljs-title class_">b81fc3bf</span> <span class="hljs-title class_">stur</span> <span class="hljs-title class_">wzr</span>,[<span class="hljs-variable">x29</span>, #-<span class="hljs-number">4</span>]</li><li><span class="hljs-number">196</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">d294a3e8</span> <span class="hljs-title class_">mov</span> <span class="hljs-title class_">x8</span>, #<span class="hljs-number">42271</span></li><li><span class="hljs-number">1970</span>: <span class="hljs-title class_">f81f03a8</span> <span class="hljs-title class_">stur</span> <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x29</span>, #-<span class="hljs-number">16</span>]</li><li><span class="hljs-number">1974</span>: <span class="hljs-title class_">bo00008</span>  <span class="hljs-title class_">adrp</span> <span class="hljs-title class_">x8</span>, <span class="hljs-number">0x2000</span> <span class="">&lt;</span><span class=""><span class="hljs-keyword">main</span>+<span class="hljs-number">0x24</span></span><span class="">&gt;</span></li><li><span class="hljs-number">1978</span>: <span class="hljs-title class_">f9464d08</span> <span class="hljs-title class_">ldr</span> <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x8</span>, #<span class="hljs-number">3224</span>]</li><li><span class="hljs-number">197</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">f9000fe8</span> <span class="hljs-title class_">str</span> <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">24</span>]</li><li><span class="hljs-number">1980</span>: <span class="hljs-number">910043e0</span> <span class="hljs-title class_">add</span> <span class="hljs-title class_">x0</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">16</span> </li><li><span class="hljs-number">1984</span>: <span class="hljs-title class_">f90003e0</span> <span class="hljs-title class_">str</span> <span class="hljs-title class_">x0</span>,[<span class=""><span class="hljs-variable">sp</span></span>] </li><li><span class="hljs-number">1988</span>: <span class="hljs-title class_">f90oobff</span> <span class="hljs-title class_">str</span> <span class="hljs-title class_">xzr</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">16</span>]</li><li><span class="hljs-number">198</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">d503201f</span> <span class="hljs-title class_">nop</span></li><li><span class="hljs-number">1990</span>: <span class="hljs-number">10011</span><span class="hljs-title class_">b01</span> <span class="hljs-title class_">adr</span> <span class="hljs-title class_">x1</span>, #<span class="hljs-number">9056</span></li><li><span class="hljs-number">1994</span>: <span class="hljs-title class_">d2800182</span> <span class="hljs-title class_">mov</span> <span class="hljs-title class_">x2</span>, #<span class="hljs-number">12</span> </li><li><span class="hljs-number">1998</span>: <span class="hljs-number">9400003</span><span class="hljs-title class_">a</span> <span class="hljs-title class_">bl</span> <span class="hljs-number">0x1a80</span> &lt;<span class="hljs-title class_">memcpy</span>@<span class="hljs-title class_">plt</span>&gt;</li><li><span class="hljs-number">199</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">f94003e1</span> <span class="hljs-title class_">ldr</span> <span class="hljs-title class_">x1</span>, [<span class=""><span class="hljs-variable">sp</span></span>] </li><li><span class="hljs-number">19</span><span class="hljs-variable">a0</span>: <span class="hljs-title class_">f9400fe8</span> <span class="hljs-title class_">ldr</span> <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">24</span>]</li><li><span class="hljs-number">19</span><span class="hljs-variable">a4</span>: <span class="hljs-title class_">f85f03a9</span> <span class="hljs-title class_">ldur</span>. <span class="hljs-title class_">x9</span>. [<span class="hljs-title class_">x29</span>, #-<span class="hljs-number">16</span>]</li><li><span class="hljs-number">19</span><span class="hljs-variable">a8</span>: <span class="hljs-title class_">dac11128</span> <span class="hljs-title class_">autia</span> <span class="hljs-title class_">x8</span>, <span class="hljs-variable">x9</span>            &lt;- <span class="hljs-variable">异常位置</span></li><li><span class="hljs-number">19</span><span class="hljs-variable">ac</span>: <span class="hljs-title class_">d03f0100</span> <span class="hljs-title class_">blr</span>   <span class="hljs-title class_">x8</span></li><li><span class="hljs-number">19</span><span class="hljs-variable">b0</span>: <span class="hljs-title class_">f9000fe8</span> <span class="hljs-title class_">str</span> <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">24</span>] </li><li><span class="hljs-number">19</span><span class="hljs-variable">b4</span>: <span class="hljs-title class_">d503201f</span> <span class="hljs-title class_">nop</span></li><li><span class="hljs-number">19</span><span class="hljs-variable">b8</span>: <span class="hljs-number">10</span><span class="hljs-title class_">ff6c40</span> <span class="hljs-title class_">adr</span> <span class="hljs-title class_">x0</span>, #-<span class="hljs-number">4728</span></li><li><span class="hljs-number">19</span><span class="hljs-variable">bc</span>: <span class="hljs-number">94000035</span> <span class="hljs-title class_">bl</span> <span class="hljs-number">0x1a90</span> &lt;<span class="hljs-title class_">printf</span>@<span class="hljs-title class_">plt</span>&gt;</li><li><span class="hljs-number">19</span><span class="hljs-variable">c0</span>: <span class="hljs-title class_">b9400fe0</span> <span class="hljs-title class_">ldr</span> <span class="hljs-title class_">w0</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">12</span>]</li><li><span class="hljs-number">19</span><span class="hljs-variable">c4</span>: <span class="hljs-title class_">a9437bfd</span> <span class="hljs-title class_">ldp</span> <span class="hljs-title class_">x29</span>, <span class="hljs-variable">x30</span>,[<span class="hljs-variable">sp</span>, #<span class="hljs-number">48</span>] </li><li><span class="hljs-number">19</span><span class="hljs-variable">c8</span>: <span class="hljs-number">910103</span><span class="hljs-title class_">ff</span> <span class="hljs-title class_">add</span> <span class="hljs-title class_">sp</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">64</span></li><li><span class="hljs-number">19</span><span class="hljs-variable">cc</span>: <span class="hljs-title class_">d65f03c0</span> <span class="hljs-title class_">ret</span></li></ol></pre></div></div> <div class="p"><ol><li>0x19a8地址对应的指令是autia x8, x9。autia是armv8.3芯片上的一个指针校验指令，第一个参数x8为函数指针，第二参数x9为用于指针校验的key值，key在编译时期自动生成。</li><li>从崩溃日志中发现x8寄存器中的地址0x5a00000000是异常的，所以导致autia指令执行失败。</li><li>向上查找汇编指令寻找x8寄存器的值怎么来的，发现0x19a0地址处ldr x8, [sp, #24]，x8寄存器值是从sp+24地址处加载得到，再往上查找发现0x197c地址处指令str x8, [sp, #24]，将x8的寄存器的值存入内存地址sp+24。</li><li>排查0x197c到0x19a0地址之间是否有写栈内存的操作，排查发现memcpy函数第一个参数x0为sp+16，第二个参数x1为9056，第三个参数x2为12，即往a数组首地址sp+16拷贝12个字节内存。但a数组缓冲区大小只有8个字节，所以在拷贝时写入内存超过缓冲区边界，造成sp+24地址处内存值被非法改写，该地址处原本存的是函数指针。</li></ol> </div> </li></ol> <div class="tiledSection"><h3 id="section162491041131116">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section162491041131116" tips="复制节点链接"></i></h3></div> <p>在使用memcpy函数拷贝内存时要注意拷贝内存的大小不能超过目的缓冲区大小，建议使用memcpy_s安全函数代替memcpy。</p> </div> <div></div></div>