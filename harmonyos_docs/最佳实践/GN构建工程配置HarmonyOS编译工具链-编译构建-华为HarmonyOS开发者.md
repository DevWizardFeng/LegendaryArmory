<h1 _ngcontent-rpg-c119="" class="doc-title ng-star-inserted" title="GN构建工程配置HarmonyOS编译工具链"> GN构建工程配置HarmonyOS编译工具链 </h1>

<div _ngcontent-rpg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section388820268254">概述<i class="anchor-icon anchor-icon-link" anchorid="section388820268254" tips="复制节点链接"></i></h2><p>本文将介绍如何在GN工程中配置HarmonyOS工具链，然后通过HarmonyOS工具链编译出可以在HarmonyOS环境下使用的三方库。</p> <p>HarmonyOS编译子系统是以GN和Ninja构建为基座，对构建和配置粒度进行部件化抽象、对内建模块进行功能增强、对业务模块进行功能扩展的系统，该系统提供以下基本功能：</p> <ul><li>以部件为最小粒度拼装产品和独立编译。</li><li>支持轻量、小型、标准三种系统的解决方案级版本构建，以及用于支撑应用开发者使用DevEco Studio开发的SDK开发套件的构建。</li><li>支持芯片解决方案厂商的灵活定制和独立编译。</li></ul> <p><strong>Ninja：</strong>是一个专注于快速编译的小型构建系统。</p> <p><strong>GN：</strong>Generate Ninja的缩写，用于产生Ninja文件。</p> </div> <div class="tiledSection"><h2 id="section1148710319351">编译环境配置<i class="anchor-icon anchor-icon-link" anchorid="section1148710319351" tips="复制节点链接"></i></h2><ol><li>Linux编译环境搭建（如果已有对应版本的Linux开发环境，可跳过Linux环境搭建过程）：详细指导见以下链接。<p><a href="https://learn.microsoft.com/zh-cn/windows/wsl/install" target="_blank">使用 WSL 在 Windows 上安装 Linux</a>。</p> <p><a href="https://learn.microsoft.com/zh-cn/windows/wsl/install-manual" target="_blank">Ubuntu分发版本获取及安装说明</a>。</p> <p>编译环境目前主要支持Ubuntu18.04和Ubuntu20.04。</p> </li><li>HarmonyOS SDK镜像下载：<p>从HarmonyOS官网门户选择Linux版本的Command Line Tools下载即可。</p> <p><a href="https://developer.huawei.com/consumer/cn/download/" target="_blank">下载链接</a>。</p> </li><li>安装构建工具depot_tools并添加到环境变量。<p>任意位置创建工作目录depot_tools，cd到自己创建的目录，拉取工具（需要网络环境）：</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-built_in">mkdir</span> </span>depot_tools</li><li><span class=""><span class="hljs-built_in">cd</span> </span>depot_tools</li><li>git <span class="hljs-built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</li></ol></pre></div></div> <p>将depot_tools的路径加到环境变量中：</p> <p>编辑.bashrc文件将depot_tools路径信息加到最后一行。</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>vi ~/.bashrc                                    </li></ol></pre></div></div> <p></p> <p>在.bashrc文件的最后添加下面一行代码。</p> <p><span><img height="69.9979" originheight="95" originwidth="1083" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163509.28871923879125806501699999178055:50001231000000:2800:5D085391027442D8C8B81C88AA22616363A9A1D7377C49170AB3691820F3C733.png" title="点击放大" width="798"></span></p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-built_in">export</span> </span><span class="">PATH</span>=<span class=""><span class="hljs-string">"</span></span><span class=""><span class="hljs-string"><span class="hljs-variable">$PATH</span></span></span><span class=""><span class="hljs-string">:/xxx/depot_tools"</span></span></li></ol></pre></div></div> <p>此处需配置绝对路径信息，例如这里创建的本地路径是/mnt/d/my_code/depot_tools，故此处配置如上图。</p> <p>刷新环境变量使其生效：</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class=""><span class="hljs-built_in">source</span></span> ~/.bashrc </li></ol></pre></div></div> </li><li>使用GN需要Python环境，安装Python环境。<div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-sql" data-highlighted="yes"><ol class="linenums"><li>sudo apt <span class="hljs-keyword">update</span></li><li>sudo apt install python</li></ol></pre></div></div> <p>直接输入指令sudo apt install python可能会安装失败，需要先输入sudo apt update更新一下可用包的最新列表。</p> <p><span><img height="172.8734" originheight="211" originwidth="974" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163509.31899800317512468201415135368387:50001231000000:2800:C3F687349CAC00EFA550CA4BF414F23D45E2F0198A17F300CC9F7B729CAE4A21.png" title="点击放大" width="798"></span></p> <p>判断python是否安装成功：</p> <p>输入python显示python版本即可。</p> <p><span><img originheight="104" originwidth="719" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.83215203380292963728543657571828:50001231000000:2800:4826478AA6E6683198571B3FAF92087C0472B387722E35EF857217835551B68D.png" width="719" height="104"></span></p> </li></ol> </div> <div class="tiledSection"><h2 id="section3984142203619">GN构建工程适配流程<i class="anchor-icon anchor-icon-link" anchorid="section3984142203619" tips="复制节点链接"></i></h2><p><span><img height="689.9242" originheight="715" originwidth="827" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.98795269986579746726387638313287:50001231000000:2800:360B6A2CF0643A584564D467E6D279188B284E784BA9BDA8C30F3685D4ADBF6E.png" title="点击放大" width="798"></span></p> <p>首先，需要添加HarmonyOS平台的宏定义；然后配置好HarmonyOS平台的工具链信息（包括clang工具链，sysroot以及clang版本）；接着需要在toolchain路径下配置各个架构的ohos_clang_toolchain；然后扩充gcc_toolchain模版功能，配置HarmonyOS用于启动引导程序的.o文件信息。剩下的就是需要设置一些HarmonyOS的编译参数（主要是基础的编译选项、宏定义等）；然后在BUILD.gn中不同架构平台的分支处，添加对应的HarmonyOS平台的分支，其中未适配HarmonyOS的三方库可以先走Linux分支的编译配置。更加详细的信息可参考下节的适配案例。</p> </div> <div class="tiledSection"><h2 id="section85091772373">webRTC适配案例<i class="anchor-icon anchor-icon-link" anchorid="section85091772373" tips="复制节点链接"></i></h2><p>本文将通过webRTC的GN构建工程案例来对上一章节的流程进行实操讲解。WebRTC (Web Real-Time Communications) 是一项实时通讯技术，它允许网络应用或者站点，在不借助中间媒介的情况下，建立浏览器之间点对点（Peer-to-Peer）的连接，实现视频流和（或）音频流或者其他任意数据的传输。下面了解下如何通过GN构建工程将webRTC适配到HarmonyOS系统上。</p> </div> <div class="tiledSection"><h3 id="section1079472424615" class="firsth2">适配流程<i class="anchor-icon anchor-icon-link" anchorid="section1079472424615" tips="复制节点链接"></i></h3><ol><li><strong>添加HarmonyOS平台宏定义</strong><p>这里主要在build/config/BUILDCONFIG.gn文件中适配HarmonyOS的default_compiler_configs和_default_toolchain。在GN工程里面，BUILDCONFIG.gn是第一位被解析的，里面定义的变量相当于全局变量，可以被后续所有的.gn文件使用。编译过程中可能会配置一些编译选项以及一些头文件搜索路径。default_compiler_configs指向的文件里面会包括一些默认的编译选项以及头文件搜索路径等等。_default_toolchain指向了一个工具链相关的函数。具体修改点如下：</p> <p><span><img height="833.1888" originheight="869" originwidth="960" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.49118853336797741783083630248826:50001231000000:2800:07F6DCF1E4717F8B8CB327567D631B71A682851C0CA9B0B70F80B8D417D541DF.png" title="点击放大" width="920"></span></p> </li><li><strong>设置HarmonyOS平台clang工具链相关路径</strong><p>不同平台的工具链会有一些差别，所以需要使用HarmonyOS的工具链。这里主要修改config/clang/clang.gni文件。.gni文件类似于GN的头文件，会被import到各个.gn文件中使用其定义的一些变量。该文件中的核心修改点在于配置指向HarmonyOS SDK的工具链路径。另外还需修改clang_use_chrome_plugins的值为false，HarmonyOS中默认clang_use_chrome_plugins值为false，不设置可能会报错find-bad-constructs文件找不到。</p> <p>此处ohos_sdk_native_root的值需要对应修改为自己本地HarmonyOS SDK中的native的路径。具体修改点如下：</p> <p><span><img height="569.5536000000001" originheight="592" originwidth="959" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.99933338309391252359394490681312:50001231000000:2800:497B30DCFD8F6947FBB4524C6428207C7DCFFFA8449A2672615B171FBE28E725.png" title="点击放大" width="920"></span></p> </li><li><strong>设置HarmonyOS平台sysroot路径</strong><p>这里主要修改build/config/sysroot.gni文件，sysroot里面包含了许多头文件搜索路径，配置了sysroot之后，编译过程中会去该目录下搜索需要的头文件。SDK里面会提供大量的头文件，这些头文件都会放在sysroot目录下，所以需要引入HarmonyOS对应的sysroot。具体修改点如下：</p> <p><span><img height="550.0618666666667" originheight="568" originwidth="953" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.34703434078718500660047098342015:50001231000000:2800:1716F69094DE5158C1F1060EC89993703389FD09E4098465DC19FE9CAC626234.png" title="点击放大" width="920"></span></p> </li><li><strong>修改HarmonyOS平台clang版本</strong><p>这里主要修改build/toolchain/toolchain.gni文件，在该文件中配置HarmonyOS对应的clang版本号。具体修改点如下：</p> <p><span><img height="247.70080000000002" originheight="252" originwidth="948" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.50032252025598010051027336620029:50001231000000:2800:E732DBE63F6744681B1C6A1E90B9C36E76C70DCDBD7EDD5C9161DBF1834E1455.png" title="点击放大" width="920"></span></p> </li><li><strong>设置各个架构的ohos_clang_toolchain</strong><p>这里主要是在build/toolchain路径下新建一个ohos/BUILD.gn文件，用于配置ohos_clang_toolchain，里面主要配置了HarmonyOS用于启动引导程序的.o文件。同时设置HarmonyOS不同架构(主要包括ohos_clang_arm、ohos_clang_arm64、ohos_clang_x86_64)的ohos_clang_toolchain配置信息。具体添加内容如下：</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>import(<span class="hljs-string">"//build/config/sysroot.gni"</span>)</li><li>import(<span class="hljs-string">"//build/toolchain/gcc_toolchain.gni"</span>)</li><li>
</li><li><span class="hljs-function"><span class="hljs-title">declare_args</span></span>() {</li><li>  <span class="hljs-comment"># Whether unstripped binaries, i.e. compiled with debug symbols, should be</span></li><li>  <span class="hljs-comment"># considered runtime_deps rather than stripped ones.</span></li><li>  ohos_unstripped_runtime_outputs = <span class="hljs-literal">true</span></li><li>  ohos_extra_cflags = <span class="hljs-string">""</span></li><li>  ohos_extra_cppflags = <span class="hljs-string">""</span></li><li>  ohos_extra_cxxflags = <span class="hljs-string">""</span></li><li>  ohos_extra_asmflags = <span class="hljs-string">""</span></li><li>  ohos_extra_ldflags = <span class="hljs-string">""</span></li><li>}</li><li>
</li><li><span class="hljs-comment"># The ohos clang toolchains share most of the same parameters, so we have this</span></li><li><span class="hljs-comment"># wrapper around gcc_toolchain to avoid duplication of logic.</span></li><li><span class="hljs-comment">#</span></li><li><span class="hljs-comment"># Parameters:</span></li><li><span class="hljs-comment">#  - toolchain_root</span></li><li><span class="hljs-comment">#      Path to cpu-specific toolchain within the ndk.</span></li><li><span class="hljs-comment">#  - sysroot</span></li><li><span class="hljs-comment">#      Sysroot for this architecture.</span></li><li><span class="hljs-comment">#  - lib_dir</span></li><li><span class="hljs-comment">#      Subdirectory inside of sysroot where libs go.</span></li><li><span class="hljs-comment">#  - binary_prefix</span></li><li><span class="hljs-comment">#      Prefix of compiler executables.</span></li><li>template(<span class="hljs-string">"ohos_clang_toolchain"</span>) {</li><li>  gcc_toolchain(target_name) {</li><li>    assert(defined(invoker.toolchain_args),</li><li>           <span class="hljs-string">"toolchain_args must be defined for ohos_clang_toolchain()"</span>)</li><li>    toolchain_args = invoker.toolchain_args</li><li>    toolchain_args.current_os = <span class="hljs-string">"ohos"</span></li><li>
</li><li>    <span class="hljs-comment"># Output linker map files for binary size analysis.</span></li><li>    enable_linker_map = <span class="hljs-literal">true</span></li><li>
</li><li>    ohos_libc_dir =</li><li>        rebase_path(invoker.sysroot + <span class="hljs-string">"/"</span> + invoker.lib_dir, root_build_dir)</li><li>    libs_section_prefix = <span class="hljs-string">"<span class="hljs-variable">${ohos_libc_dir}</span>/Scrt1.o"</span></li><li>    libs_section_prefix += <span class="hljs-string">" <span class="hljs-variable">${ohos_libc_dir}</span>/crti.o"</span></li><li>    libs_section_postfix = <span class="hljs-string">"<span class="hljs-variable">${ohos_libc_dir}</span>/crtn.o"</span></li><li>
</li><li>    <span class="hljs-keyword">if</span> (invoker.target_name == <span class="hljs-string">"ohos_clang_arm"</span>) {</li><li>      abi_target = <span class="hljs-string">"arm-linux-ohos"</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (invoker.target_name == <span class="hljs-string">"ohos_clang_arm64"</span>) {</li><li>      abi_target = <span class="hljs-string">"aarch64-linux-ohos"</span></li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (invoker.target_name == <span class="hljs-string">"ohos_clang_x86_64"</span>) {</li><li>      abi_target = <span class="hljs-string">"x86_64-linux-ohos"</span></li><li>    }</li><li>
</li><li>    clang_rt_dir =</li><li>        rebase_path(<span class="hljs-string">"<span class="hljs-variable">${clang_lib_path}</span>/<span class="hljs-variable">${abi_target}</span>/nanlegacy"</span>,</li><li>                    root_build_dir)</li><li>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ohos_libc_dir :"</span>, ohos_libc_dir)</li><li>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"clang_rt_dir :"</span>, clang_rt_dir)</li><li>    solink_libs_section_prefix = <span class="hljs-string">"<span class="hljs-variable">${ohos_libc_dir}</span>/crti.o"</span></li><li>    solink_libs_section_prefix += <span class="hljs-string">" <span class="hljs-variable">${clang_rt_dir}</span>/clang_rt.crtbegin.o"</span></li><li>    solink_libs_section_postfix = <span class="hljs-string">"<span class="hljs-variable">${ohos_libc_dir}</span>/crtn.o"</span></li><li>    solink_libs_section_postfix += <span class="hljs-string">" <span class="hljs-variable">${clang_rt_dir}</span>/clang_rt.crtend.o"</span></li><li>
</li><li>    _prefix = rebase_path(<span class="hljs-string">"<span class="hljs-variable">${clang_base_path}</span>/bin"</span>, root_build_dir)</li><li>    cc = <span class="hljs-string">"<span class="hljs-variable">${_prefix}</span>/clang"</span></li><li>    cxx = <span class="hljs-string">"<span class="hljs-variable">${_prefix}</span>/clang++"</span></li><li>    ar = <span class="hljs-string">"<span class="hljs-variable">${_prefix}</span>/llvm-ar"</span></li><li>    ld = cxx</li><li>    readelf = <span class="hljs-string">"<span class="hljs-variable">${_prefix}</span>/llvm-readobj"</span></li><li>    nm = <span class="hljs-string">"<span class="hljs-variable">${_prefix}</span>/llvm-nm"</span></li><li>    <span class="hljs-keyword">if</span> (!is_debug) {</li><li>      strip = rebase_path(<span class="hljs-string">"<span class="hljs-variable">${clang_base_path}</span>/bin/llvm-strip"</span>, root_build_dir)</li><li>      use_unstripped_as_runtime_outputs = ohos_unstripped_runtime_outputs</li><li>    }</li><li>    extra_cflags = ohos_extra_cflags</li><li>    extra_cppflags = ohos_extra_cppflags</li><li>    extra_cxxflags = ohos_extra_cxxflags</li><li>    extra_asmflags = ohos_extra_asmflags</li><li>    extra_ldflags = ohos_extra_ldflags</li><li>  }</li><li>}</li><li>
</li><li>ohos_clang_toolchain(<span class="hljs-string">"ohos_clang_arm"</span>) {</li><li>  sysroot = <span class="hljs-string">"<span class="hljs-variable">${sysroot}</span>"</span></li><li>  lib_dir = <span class="hljs-string">"usr/lib/arm-linux-ohos"</span></li><li>  toolchain_args = {</li><li>    current_cpu = <span class="hljs-string">"arm"</span></li><li>  }</li><li>}</li><li>
</li><li>ohos_clang_toolchain(<span class="hljs-string">"ohos_clang_arm64"</span>) {</li><li>  sysroot = <span class="hljs-string">"<span class="hljs-variable">${sysroot}</span>"</span></li><li>  lib_dir = <span class="hljs-string">"usr/lib/aarch64-linux-ohos"</span></li><li>  toolchain_args = {</li><li>    current_cpu = <span class="hljs-string">"arm64"</span></li><li>  }</li><li>}</li><li>
</li><li>ohos_clang_toolchain(<span class="hljs-string">"ohos_clang_x86_64"</span>) {</li><li>  sysroot = <span class="hljs-string">"<span class="hljs-variable">${sysroot}</span>"</span></li><li>  lib_dir = <span class="hljs-string">"usr/lib/x86_64-linux-ohos"</span></li><li>  toolchain_args = {</li><li>    current_cpu = <span class="hljs-string">"x86_64"</span></li><li>  }</li><li>}</li></ol></pre></div></div> </li><li><strong>扩充原本的gcc_toolchain模版功能</strong><p>主要修改/build/toolchain/gcc_toolchain.gni文件。GN工程里面默认会配置gcc_toolchain，里面会包括一些tool，例如tool("cc")、tool("cxx")、tool("tolink")等等，编译不同的内容时调用其对应的配置项。这里主要是需要修改tool("solink")、tool("solink_module")中的rspfile_content配置以及tool("link")中的link_comand配置。需要在gcc_toolchain.gni中template("gcc_toolchain")下添加几个参数（libs_section_prefix、libs_section_postfix 、solink_libs_section_prefix、solink_libs_section_postfix ）的识别。这几个参数是指向了上一步骤中配置的用于启动引导程序的.o文件。这些参数会在需要修改的rspfile_content、link_comand参数中用到。具体修改如下：</p> <p><span><img height="771.4629333333332" originheight="785" originwidth="937" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.39009576731153723597796163334326:50001231000000:2800:7FE8D7CFBE09EFCC9E33196905D5A981D9C14D800DD57D36704801C11602F2A9.png" title="点击放大" width="920"></span></p> <p>修改tool("solink")和tool("solink_module")中的rspfile_content为rspfile_content = "-Wl,--whole-archive {{inputs}} {{solibs}} -Wl,--no-whole-archive $solink_libs_section_prefix {{libs}} $solink_libs_section_postfix"，这里需要用到刚刚定义的参数信息。具体修改如下：</p> <p><span><img height="301.6864" originheight="422" originwidth="1296" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.87288538497966628371551978455013:50001231000000:2800:C9D7395168A4529CC7F47369D1F354DB21B979C18DE41FDEA9FECAAE62CDFDDF.png" title="点击放大" width="920"></span></p> <p><span><img height="150.64693333333332" originheight="209" originwidth="1299" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.93895467850435923241892815278607:50001231000000:2800:3304E83F1DCEDB658F623D6862AA290BB71BA111552ED9BED51F1CD6C1E524FF.png" title="点击放大" width="920"></span></p> <p>修改tool("link")中link_command为link_command = "$ld {{ldflags}}${extra_ldflags} -o \"$unstripped_outfile\" $libs_section_prefix $start_group_flag @\"$rspfile\" {{solibs}} {{libs}} $end_group_flag $libs_section_postfix"，这里需要用到刚刚定义的参数信息。</p> <p><span><img height="173.64693333333332" originheight="288" originwidth="1545" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.25120525500382656054480125799583:50001231000000:2800:09062687FA2B8815C59971223CB10A55816F07B9DF45EA8674C764741305641F.png" title="点击放大" width="920"></span></p> </li><li><strong>设置HarmonyOS的一些编译参数，将其加入到BUILDCONFIG.gn中</strong><p>这里需要在build/config路径下新建一个ohos/BUILD.gn文件，该文件主要是定义了一个config("compiler")，该config会被注册到所有的编译目标，该config里面主要设置了基础的编译选项、宏定义等。</p> <p>此处ohos_clang_base_path  的值需要对应修改为自己本地HarmonyOS SDK中的llvm的路径。具体添加内容如下：</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>import(<span class="hljs-string">"//build/config/sysroot.gni"</span>)</li><li>assert(is_ohos)</li><li>
</li><li>ohos_clang_base_path = <span class="hljs-string">"/mnt/d/ohos/ohos-sdk/linux/native/llvm"</span></li><li>ohos_clang_version = <span class="hljs-string">"15.0.4"</span></li><li>
</li><li><span class="hljs-keyword">if</span> (is_ohos) {</li><li>  <span class="hljs-keyword">if</span> (current_cpu == <span class="hljs-string">"arm"</span>) {</li><li>    abi_target = <span class="hljs-string">"arm-linux-ohos"</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current_cpu == <span class="hljs-string">"x86"</span>) {</li><li>    abi_target = <span class="hljs-string">""</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current_cpu == <span class="hljs-string">"arm64"</span>) {</li><li>    abi_target = <span class="hljs-string">"aarch64-linux-ohos"</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current_cpu == <span class="hljs-string">"x86_64"</span>) {</li><li>    abi_target = <span class="hljs-string">"x86_64-linux-ohos"</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    assert(<span class="hljs-literal">false</span>, <span class="hljs-string">"Architecture not supported"</span>)</li><li>  }</li><li>}</li><li>
</li><li>config(<span class="hljs-string">"compiler"</span>) {</li><li>  cflags = [</li><li>    <span class="hljs-string">"-ffunction-sections"</span>,</li><li>    <span class="hljs-string">"-fno-short-enums"</span>,</li><li>    <span class="hljs-string">"-fno-addrsig"</span>,</li><li>  ]</li><li>
</li><li>  cflags += [</li><li>    <span class="hljs-string">"-Wno-unknown-warning-option"</span>,</li><li>    <span class="hljs-string">"-Wno-int-conversion"</span>,</li><li>    <span class="hljs-string">"-Wno-unused-variable"</span>,</li><li>    <span class="hljs-string">"-Wno-misleading-indentation"</span>,</li><li>    <span class="hljs-string">"-Wno-missing-field-initializers"</span>,</li><li>    <span class="hljs-string">"-Wno-unused-parameter"</span>,</li><li>    <span class="hljs-string">"-Wno-c++11-narrowing"</span>,</li><li>    <span class="hljs-string">"-Wno-unneeded-internal-declaration"</span>,</li><li>    <span class="hljs-string">"-Wno-undefined-var-template"</span>,</li><li>    <span class="hljs-string">"-Wno-implicit-int-float-conversion"</span>,</li><li>  ]</li><li>  defines = [</li><li>    <span class="hljs-comment"># The NDK has these things, but doesn't define the constants to say that it</span></li><li>    <span class="hljs-comment"># does. Define them here instead.</span></li><li>    <span class="hljs-string">"HAVE_SYS_UIO_H"</span>,</li><li>  ]</li><li>
</li><li>  defines += [</li><li>    <span class="hljs-string">"OHOS"</span>,</li><li>    <span class="hljs-string">"__MUSL__"</span>,</li><li>    <span class="hljs-string">"_LIBCPP_HAS_MUSL_LIBC"</span>,</li><li>    <span class="hljs-string">"__BUILD_LINUX_WITH_CLANG"</span>,</li><li>    <span class="hljs-string">"__GNU_SOURCE"</span>,</li><li>    <span class="hljs-string">"_GNU_SOURCE"</span>,</li><li>  ]</li><li>
</li><li>  ldflags = [</li><li>    <span class="hljs-string">"-Wl,--no-undefined"</span>,</li><li>    <span class="hljs-string">"-Wl,--exclude-libs=libunwind_llvm.a"</span>,</li><li>    <span class="hljs-string">"-Wl,--exclude-libs=libc++_static.a"</span>,</li><li>
</li><li>    <span class="hljs-comment"># Don't allow visible symbols from libraries that contain</span></li><li>    <span class="hljs-comment"># assembly code with symbols that aren't hidden properly.</span></li><li>    <span class="hljs-comment"># http://crbug.com/448386</span></li><li>    <span class="hljs-string">"-Wl,--exclude-libs=libvpx_assembly_arm.a"</span>,</li><li>  ]</li><li>
</li><li>  cflags += [ <span class="hljs-string">"--target=<span class="hljs-variable">$abi_target</span>"</span> ]</li><li>  include_dirs = [</li><li>    <span class="hljs-string">"<span class="hljs-variable">${sysroot}</span>/usr/include/<span class="hljs-variable">${abi_target}</span>"</span>,</li><li>    <span class="hljs-string">"<span class="hljs-variable">${ohos_clang_base_path}</span>/lib/clang/<span class="hljs-variable">${ohos_clang_version}</span>/include"</span>,</li><li>  ]</li><li>
</li><li>  ldflags += [ <span class="hljs-string">"--target=<span class="hljs-variable">$abi_target</span>"</span> ]</li><li>
</li><li>  <span class="hljs-comment"># Assign any flags set for the C compiler to asmflags so that they are sent</span></li><li>  <span class="hljs-comment"># to the assembler.</span></li><li>  asmflags = cflags</li><li>}</li></ol></pre></div></div> </li><li><strong>build/config/compiler/BUILD.gn中增加对is_ohos的判断</strong><p>保证可以正确走HarmonyOS支持的编译分支。这里主要是为了防止clang版本号校验失败导致异常。具体修改如下：</p> <p><span><img height="499.24106666666665" originheight="520" originwidth="962" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.89951879976280034854281994382904:50001231000000:2800:906EA0CF4CD36B75AD0007968A90E89172125C80F647F6E442713C5C35F5BFB3.png" title="点击放大" width="920"></span></p> </li><li><strong>未适配HarmonyOS的三方库走linux编译配置</strong><p>当前部分三方库还未适配HarmonyOS，涉及到时可以先走linux的编译配置，例如：需要获取config.h文件时。</p> <p>修改modules/video_capture的BUILD.gn。具体修改如下：</p> <p><span><img height="314.2597333333333" originheight="325" originwidth="960" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.90017902859157812223262299260463:50001231000000:2800:4D6A88309043B04E45BABD6FA7622376E807846B30E5DF178AB5B7621FA6574A.png" title="点击放大" width="920"></span></p> <p>修改third_party/zlib的BUILD.gn。具体修改如下：</p> <p><span><img height="423.8746666666667" originheight="439" originwidth="958" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.03419826372556403502234639537024:50001231000000:2800:9E1165EC635C42873F3733245CE99800A16BA2D81B8BA2174681AA377EEE838E.png" title="点击放大" width="920"></span></p> <p>修改third_party/libevent中的BUILD.gn。HarmonyOS SDK中没有queue.h头文件，需要使用compat dir目录下的queue.h头文件。具体修改如下：</p> <p><span><img height="547.8153493333333" originheight="591" originwidth="955" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.26601560367251269258189353707302:50001231000000:2800:3E04D3ED375DA647574DF15181671493BBF8D0EBFE88C3546A594F9F56902794.png" title="点击放大" width="920"></span></p> </li><li><strong>编译</strong><p>先通过GN命令生成对应的ninja文件，然后使用ninja编译命令进行编译。</p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>gn <span class="">gen</span> <span class="">../out</span>/xxx --<span class="">args</span>=<span class="hljs-string">'</span><span class=""><span class="hljs-string">is_clang=true </span></span><span class="hljs-string">target_os=</span><span class=""><span class="hljs-string">"ohos"</span></span><span class="hljs-string"> target_cpu=</span><span class=""><span class="hljs-string">"arm64"</span></span><span class="hljs-string"> xxx'</span>  </li><li>ninja -v -C <span class="">../out</span>/xxx <span class="hljs-variable">${target_name}</span> -j16 </li></ol></pre></div></div> <p>可以根据需要在编译指令中添加对应参数信息。</p> <p>查看具体编译命令：</p> <p>可以在gn gen命令中添加--ninja-args="-v -dkeeprsp"用于查看具体编译命令，这个命令将会在编译过程中打印详细的编译命令，并且保留编译过程中生成的rsp文件。</p> <p>查看一个目标被谁依赖：</p> <p>例如gn refs out/intermediate/arm64_72 //pc:rtc_pc_base。这个命令将显示与目标//pc:rtc_pc_base相关的所有依赖项并列出所有引用了该目标的其他目标或文件。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section749391684720">常见问题总结<i class="anchor-icon anchor-icon-link" anchorid="section749391684720" tips="复制节点链接"></i></h3><p>在对webRTC的GN工程进行HarmonyOS工具链适配过程中，遇到了一些常见问题场景。下面针对这些问题做一个具体分析。</p> <ol><li><strong>Assertion failed. Unsupported ARM OS</strong><p><strong>问题详情：</strong></p> <p><span><img originheight="300" originwidth="1350" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163510.29142537303004684843890725753472:50001231000000:2800:61B88B1EF16BB608349110984968854BDE80B0D33C82A9A0ADEB1662C12BBB08.png" width="920" height="204.44444444444443"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>三方库内部没有做对is_ohos的判断，导致走到错误分支。当前很多业务模块还未适配HarmonyOS，暂时可以走linux分支以保证正常编译。</p> <p><strong>具体修改：</strong></p> <p>修改third_party/zlib的BUILD.gn文件。</p> <p><span><img height="423.8746666666667" originheight="439" originwidth="958" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.95126330790115332693065079431757:50001231000000:2800:0D5E3F4317A7C94F16F2DC870BE7A8B87DB9EED1F0539DA773FE50E334EAA0AD.png" title="点击放大" width="920"></span></p> </li><li><strong>python找不到pkg-config文件：No such file or directory: 'pkg-config'</strong><p><strong>问题详情：</strong></p> <p><span><img height="271.586" originheight="600" originwidth="1763" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.54108488413772330495074934811103:50001231000000:2800:7CC14C576995348551D61BACF72FA8097663A479B2077D31ACE0A465AEEB3A12.png" title="点击放大" width="798"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>缺少pkg-config插件，安装该插件。</p> <p><strong>具体指令：</strong></p> <div _ngcontent-rpg-c106="" class="highlight-div"><div _ngcontent-rpg-c106="" class="highlight-div-header"><div _ngcontent-rpg-c106="" class="highlight-div-header-left"><div _ngcontent-rpg-c106="" class="handle-button expand-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rpg-c106="" class="highlight-div-header-right"><div _ngcontent-rpg-c106="" class="handle-button ai-button"></div><div _ngcontent-rpg-c106="" class="handle-button line-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rpg-c106="" class="handle-button theme-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rpg-c106="" class="handle-button copy-button"><div _ngcontent-rpg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rpg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li>sudo apt-<span class="hljs-keyword">get</span> install pkg-config</li></ol></pre></div></div> </li><li><strong>Unknown command line argument '-split-threshold-for-reg-with-hint=0'</strong><p><strong>问题详情：</strong></p> <p><span><img height="186.02710000000002" originheight="442" originwidth="1896" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.76536189281955056769717500052846:50001231000000:2800:8CB5AFCBCBB604292F62313E435551754D170D001733CE1639823A55523ADCC7.png" title="点击放大" width="798"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>编译过程中会提示部分配置不识别，需要将这些配置项删除。</p> <p><strong>具体修改：</strong></p> <p>在build/config/compiler/BUILD.gn中删除以下配置。</p> <p><span><img height="663.8106666666666" originheight="690" originwidth="958" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.76148627554033929213642821438200:50001231000000:2800:64273E8362D1462C45C0990C5F45CD240AD594F0B9E69ABA030ADED6DDB2C67A.png" title="点击放大" width="920"></span></p> </li><li><strong>WARN类型导致的ERROR</strong><p><strong>问题详情：</strong></p> <p><span><img height="140.1155" originheight="335" originwidth="1908" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.31169321808856645904831014203697:50001231000000:2800:D0871B857D036690D923949ACAA5576EE9D3C8468DDCF5026D3DE5040576EFFE.png" title="点击放大" width="798"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>编译器驱动程序有时（很少）会在调用之前发出警告。实际的链接器需要确保这些警告是否也被视为致命错误。为了避免编译中出现因警告而造成出错，可以添加编译参数treat_warnings_as_errors = false，或者去除config(treat_warnings_as_errors)中配置的“-Werror”，详情如下：</p> <p><span><img height="229.3744" originheight="236" originwidth="960" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.46224299100056748186050526157978:50001231000000:2800:CF837FA5EA90B648568EFBD62BB7B8E0ECBC5FD5B680E13338594C02A5F7158D.png" title="点击放大" width="920"></span></p> <p><strong>具体修改：</strong></p> <ul><li>添加编译指令配置项treat_warnings_as_errors （建议使用）<p><span><img height="21.532700000000002" originheight="33" originwidth="1223" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.65060133578589471904655399700771:50001231000000:2800:0841F7BA95F6D158862EE672E3536D5144C1111A6E8EAE378CA21FA52CEB64E9.png" title="点击放大" width="798"></span></p> </li><li>修改源代码，在build/config/compiler/BUILD.gn中删除以下配置。<p><span><img height="470.2549333333333" originheight="487" originwidth="957" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.50520586171595809911039260296869:50001231000000:2800:12BD2AB4CE168B903F5C0DC72D4B6094C0E857F101C58FE6C8A58ABEF530C3F8.png" title="点击放大" width="920"></span></p> </li></ul> </li><li><strong>error: reinterpret_cast from 'pthread_t' (aka 'unsigned long') to 'rtc::PlatformThreadId' (aka 'int') is not allowed</strong><p><strong>问题详情：</strong></p> <p><span><img height="187.34380000000002" originheight="447" originwidth="1904" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.99732462993441978655898173137688:50001231000000:2800:2C327787CFF5FA18F769FF095FC141090DCE367FFB9183359F0B30591C8F66E4.png" title="点击放大" width="798"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>rtc_base/platform_thread_types.cc未识别到is_ohos导致内部走错分支导致异常。目前HarmonyOS支持的接口是gettid()，rtc_base/platform_thread_types.cc需要识别到is_ohos然后调用gettid()。由于当前很多业务模块还未进行识别，暂时需要走linux分支，故需要保留linux的定义。</p> <p><strong>具体修改：</strong></p> <ul><li>首先需要在根目录的BUILD.gn中配置识别HarmonyOS系统的变量is_ohos：<p><span><img height="384.5354666666667" originheight="397" originwidth="956" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.88651899393199322905959698312101:50001231000000:2800:6F1CECAA1A2FEF128424DAA94D7F8EFA6C07676E72A0ED4AAA02CC00CCD2F8BF.png" title="点击放大" width="920"></span></p> </li><li>修改rtc_base/platform_thread_types.cc业务代码：<p><span><img height="425.7269333333333" originheight="440" originwidth="956" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.61457904861636973841473719843535:50001231000000:2800:90C8D7C855C30473DFE97F66F408B3C7C73879978514DB46CD83AF877516CCC1.png" title="点击放大" width="920"></span></p> </li></ul> </li><li><strong>fatal error: 'config.h' file not found</strong><p><strong>fatal error: 'sys/queue.h' file not found</strong></p> <p><strong>问题详情：</strong></p> <p><span><img height="165.5318" originheight="396" originwidth="1909" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.52171031021337686188685929377360:50001231000000:2800:82BC52FF2578841C831F98CD82397C2319629FEDB85F485319B4E0A80973C0FE.png" title="点击放大" width="798"></span><span><img height="160.3581" originheight="382" originwidth="1901" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.95258188096540640105798852548604:50001231000000:2800:B00EC73C1AC67EEB3CF7A5EDB842676B6B459CB487CF65D5C316B6A4F087EE62.png" title="点击放大" width="798"></span></p> <p><strong>问题原因/解决措施：</strong></p> <p>找不到config.h头文件，libevent尚未适配HarmonyOS，需要添加is_ohos的判断并走linux的文件路径寻找config.h。</p> <p>找不到'sys/queue.h'文件，HarmonyOS SDK中没有queue.h头文件，需要使用compat dir目录下的queue.h头文件。</p> <p><strong>具体修改：</strong></p> <p>修改third_party/libevent中的BUILD.gn。</p> <p><span><img height="570.9765333333334" originheight="591" originwidth="955" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163511.66978600080439193500508462528905:50001231000000:2800:B0922161B9FF672305510192359CE7485C13529F65067A51EA2FDD1905C922C7.png" title="点击放大" width="920"></span></p> </li></ol> </div> </div></div>