<h1 _ngcontent-vqe-c119="" class="doc-title ng-star-inserted" title="HDR Vivid视频录制、播放与转码"> HDR Vivid视频录制、播放与转码 </h1>

<div _ngcontent-vqe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1469510592520">概述<i class="anchor-icon anchor-icon-link" anchorid="section1469510592520" tips="复制节点链接"></i></h2></div> <p>随着5G、光纤等网络技术的普及，终端显示能力进一步提升，“真实”、“沉浸”的超高清音视频体验时代已到来。高动态范围（High-Dynamic Range，简称HDR）作为超高清音视频产业的关键技术之一，比传统的标准动态范围（Standard Dynamic Range，简称SDR）拥有更广的色域和更高的动态范围（动态范围指的是亮度最大值和最小值的比值），为图像保留更多细节。超高清HDR加上宽色域能让视频亮度层次和色彩的呈现更真实、更自然。</p> <p>HDR Vivid是<span style="color: rgb(29,29,26);">由华为主导开发的</span>高动态范围视频技术标准，中文名为“菁彩影像”。它受亮度、对比度、色深、色域等因素影响，是一种提高画面亮度及对比度的画面处理技术。 其技术特点与优势为：</p> <ol><li>高动态范围：HDR Vivid通过更广的色域和更高的动态范围，使得画面能够容纳更多的细节和色彩层次。与传统的SDR相比，HDR Vivid的高光亮度是SDR的40倍，它能够同时呈现更深的黑色和更亮的白色，让画面的亮部和暗部细节更加清晰。</li><li>色彩丰富：HDR Vivid支持10bit/12bit的色深，使得色彩过渡更加平滑，色彩表现更加细腻。色域面积相对BT.709标准增加了70%<strong>，</strong>色域越大证明能显示的颜色越多，HDR Vivid能够呈现更加真实的色彩，让用户感受到更加丰富的视觉体验。</li><li>智能优化：作为一种动态HDR标准，HDR Vivid能够根据视频场景，逐帧动态优化画面的亮度、对比度和色彩。HDR Vivid使用动态元数据和智能映射引擎，将母版颜色容积映射到显示设备上，这种映射使得创作者的意图在不同显示设备上都得以保留，并且呈现最优画质效果，解决了传统制作和显示过程中色彩信息和亮度细节丢失的问题。</li></ol> <p><span style="color: rgb(29,29,26);">目前涉及到的HDR场景包括：HDR视频录制、HDR视频播放、视频转码（HDR2SDR）、HDR图片拍照等。本文旨在向开发者介绍，如何使用HarmonyOS的系统能力进行常用场景的开发：</span></p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-hdrvivid#section1557617218612">HDR Vivid视频录制</a><span style="color: rgb(29,29,26);">：主要使用场景为有HDR Vivid视频录制需求的应用。</span></li><li><a href="/consumer/cn/doc/best-practices/bpta-hdrvivid#section16986221152715">HDR Vivid视频播放</a><span style="color: rgb(29,29,26);">：主要使用场景为有播放HDR Vivid视频片源需求的应用。</span></li><li><a href="/consumer/cn/doc/best-practices/bpta-hdrvivid#section205681450115711">HDR Vivid视频转码成SDR视频</a><span style="color: rgb(29,29,26);">：主要使用场景为不支持HDR Vivid视频播放的场景或其他特殊情况。</span></li></ul> <div class="tiledSection"><h2 id="section1557617218612">HDR Vivid视频录制<i class="anchor-icon anchor-icon-link" anchorid="section1557617218612" tips="复制节点链接"></i></h2></div> <p>HDR Vivid视频录制是一种先进的视频录制技术，它基于动态元数据对亮度、对比度和颜色进行逐个场景优化，为显示终端提供更加准确的动态映射方式。</p> <p>HDR Vivid视频录制的开发和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording" target="_blank">主流格式视频录制</a>的开发基本一致，差异点体现在部分参数的配置上。</p> <p>HarmonyOS上开发录制视频的功能一般有两个方案：</p> <ul><li>使用Camera配合系统级音视频录制类AVRecorder进行录制。</li><li>使用Camera配合系统编码器进行录制。</li></ul> <div class="tiledSection"><h3 id="section58824491485" class="firsth2">使用Camera+AVRecorder录制<i class="anchor-icon anchor-icon-link" anchorid="section58824491485" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>应用通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avrecorder" target="_blank">AVRecorder</a>实现视频录制时，先通过Camera接口调用相机服务，通过视频HDI捕获图像数据送显至应用，同时送至AVRecorder的录制服务，录制服务将图像数据编码后封装至文件中，实现视频录制功能。流程图如下：</p> <p><span><img height="356.1075" originheight="600" originwidth="882" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163039.38964289226247187742646574035978:50001231000000:2800:6A6894708E1AC72DF6DE8DFBF07D51D5D657015296CE530DCD82A40F2130EB33.png" title="点击放大" width="523.6875"></span></p> </div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager" target="_blank">Camera</a>+<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder" target="_blank">AVRecorder</a>录制HDR Vivid视频，与录制普通视频的区别主要在于：</p> <ul><li>AVRecorder<ol><li>AVRecoder需要配置isHdr参数为true，对应的编码格式必须为video/hevc。</li></ol> </li></ul> <ul><li>Camera<ol><li>相机创建video output实例时，选择yuv 10bit profile（CAMERA_FORMAT_YCRCB_P010）。</li><li>HDR录像需要相机支持视频防抖功能。</li><li>相机会话配置颜色空间为BT2020_HLG_LIMIT。</li></ol> </li></ul> <p><strong>开发步骤</strong></p> <p>针对以上四点不同，开发视频录制功能时，可参考以下步骤（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-hdr-recording" target="_blank">HDR Vivid相机录像(ArkTS)</a>）：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreateavrecorder9" target="_blank">createAVRecorder()</a>创建AVRecorder实例。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L229-L235" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Creating an AVRecorder Instance</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVRecorder</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`createAVRecorder call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L229-L235" target="_blank">Record.ets</a></div></div></div></div> </li><li>配置预览流与录像输出流的分辨率为16:9，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#avrecorderprofile9" target="_blank">AVRecorderProfile</a>参数中的变量isHdr为True，videoCodec为VIDEO_HEVC格式，表示要录制的是HDR Vivid视频。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L173-L207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">videoSize</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Size</span> = {</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-number">1920</span>,</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-number">1080</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">videoProfile</span>: <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span> = <span class="hljs-variable">videoProfilesArray</span>.<span class="hljs-title function_">find</span>((<span class="hljs-variable">profile</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span>) =&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">profile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span> === <span class="hljs-variable">videoSize</span>.<span class="hljs-variable">width</span> &amp;&amp; <span class="hljs-variable">profile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> === <span class="hljs-variable">videoSize</span>.<span class="hljs-variable">height</span>;</li><li>});</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-variable">videoProfile</span>) {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'videoProfile is not found'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">aVRecorderProfile</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">AVRecorderProfile</span> = {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable">videoCodec</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">CodecMimeType</span>.<span class="hljs-title class_">VIDEO_AVC</span>,</li><li>  <span class="hljs-comment">// ...</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L173-L207" target="_blank">Record.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createvideooutput" target="_blank">createVideoOutput()</a>创建video output实例，选择yuv 10bit profile。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/HDRVivid/AVRecorder/entry/src/main/ets/pages/Record.ets#L185-L253" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">VideoProfile</span> = videoProfilesArray.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">profile: camera.VideoProfile</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> === videoSize.<span class="hljs-property">width</span> &amp;&amp; profile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> === videoSize.<span class="hljs-property">height</span> &amp;&amp;</li><li>    profile.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCRCB_P010</span>;</li><li>});</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">previewProfile</span>: <span class="hljs-literal">undefined</span> | camera.<span class="hljs-property">Profile</span> = previewProfilesArray.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">profile: camera.Profile</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">return</span> profile.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YCRCB_P010</span> &amp;&amp;</li><li>    profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> === videoSize.<span class="hljs-property">width</span> &amp;&amp; profile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span> == videoSize.<span class="hljs-property">height</span></li><li>});</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">prepare</span>(avRecorderConfig);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`prepare call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">videoSurfaceId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  videoSurfaceId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">getInputSurface</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getInputSurface call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>}</li><li><span class="hljs-keyword">if</span> (videoSurfaceId === <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoOutput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createVideoOutput</span>(videoProfile, videoSurfaceId);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create the videoOutput instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/HDRVivid/AVRecorder/entry/src/main/ets/pages/Record.ets#L185-L253" target="_blank">Record.ets</a></div></div></div></div> </li><li>创建并配置普通录像模式（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videosession" target="_blank">VideoSession</a>）的相机会话，同时设置视频防抖及色彩空间属性。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/HDRVivid/AVRecorder/entry/src/main/ets/pages/Record.ets#L268-L421" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create and configure a camera session</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">beginConfig</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">commitConfig</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">mode</span>: camera.<span class="hljs-property">VideoStabilizationMode</span> = camera.<span class="hljs-property">VideoStabilizationMode</span>.<span class="hljs-property">AUTO</span>;</li><li><span class="hljs-comment">// Check whether video anti-shake is supported</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  isSupported = <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">isVideoStabilizationModeSupported</span>(mode);</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`isVideoStabilizationModeSupported: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(isSupported)}</span>`</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// If the failure occurs, the error code error.code is returned and processed</span></li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The isVideoStabilizationModeSupported call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>}</li><li><span class="hljs-keyword">if</span> (isSupported) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Setting video anti-shake</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">setVideoStabilizationMode</span>(mode);</li><li>    <span class="hljs-keyword">let</span> activeVideoStabilizationMode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">getActiveVideoStabilizationMode</span>();</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`activeVideoStabilizationMode: <span class="hljs-subst">${activeVideoStabilizationMode}</span>`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`setVideoStabilizationMode or getActiveVideoStabilizationMode failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`videoStabilizationMode: <span class="hljs-subst">${mode}</span> is not support`</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Set the color space of the camera session to BT2020_HLG_LIMIT</span></li><li><span class="hljs-keyword">if</span> (isSupported) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">colorSpace</span>: colorSpaceManager.<span class="hljs-property">ColorSpace</span> = colorSpaceManager.<span class="hljs-property">ColorSpace</span>.<span class="hljs-property">BT2020_HLG_LIMIT</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;colorSpaceManager.<span class="hljs-property">ColorSpace</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    colorSpaces = <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The getSupportedColorSpaces call failed. error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">let</span> isSupportedColorSpaces = colorSpaces.<span class="hljs-title function_">indexOf</span>(colorSpace) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (isSupportedColorSpaces) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`setColorSpace: <span class="hljs-subst">${colorSpace}</span>`</span>);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">setColorSpace</span>(colorSpace);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`The setColorSpace call failed, error code: <span class="hljs-subst">${err.code}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">activeColorSpace</span>: colorSpaceManager.<span class="hljs-property">ColorSpace</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`activeColorSpace: <span class="hljs-subst">${activeColorSpace}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getActiveColorSpace failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`colorSpace: <span class="hljs-subst">${colorSpace}</span> is not support`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureSession</span>.<span class="hljs-title function_">start</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`captureSession start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/HDRVivid/AVRecorder/entry/src/main/ets/pages/Record.ets#L268-L421" target="_blank">Record.ets</a></div></div></div></div> </li><li>启动video流。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L382-L388" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">videoOutput</span>.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start the video output. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Callback invoked to indicate the video output start success.'</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L382-L388" target="_blank">Record.ets</a></div></div></div></div> </li><li>启动recorder进行录制。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L393-L403" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">startRecord</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`avRecorder start error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/camera-kit-avrecorder/blob/master/entry/src/main/ets/pages/Record.ets#L393-L403" target="_blank">Record.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section1809191617421">使用Camera+AVCodec录制<i class="anchor-icon anchor-icon-link" anchorid="section1809191617421" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>应用通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/avcodec-module" target="_blank">AVCodec</a>实现视频录制时，先通过Camera接口调用相机服务，通过视频HDI捕获图像数据送显至应用，同时送至AVCodec的编码模块将图像数据编码后封装至文件中，实现视频录制功能。流程图如下：</p> <p><span><img height="356.1075" originheight="600" originwidth="882" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163039.98882139313149576252538026416703:50001231000000:2800:804D0E0063EE5FE8F5E4195C08DC7572EBA7DC16D7F2BE698D93666FF6728CBB.png" title="点击放大" width="523.6875"></span></p> </div> <p>使用Camera+<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/avcodec-module" target="_blank">AVCodec</a>录制HDR Vivid视频，与录制普通视频的区别主要在于：</p> <ul><li>AVCodec<ol><li>视频编码器AVCodec需要选择HEVC格式，并配置profile为HEVC_PROFILE_MAIN_10的相机底层。</li><li>编码器AVCodec配置颜色相关参数为COLOR_PRIMARY_BT2020。</li></ol> </li><li>Camera<ol><li>相机在创建video output实例时，选择yuv 10bit profile。</li><li>HDR录像需要相机支持视频防抖功能，并配置颜色空间为BT2020_HLG_LIMIT。</li></ol> </li></ul> <p><strong>开发步骤</strong></p> <p>针对以上四点不同，使用Camera+AVCodec开发HDR Vivid视频录制功能时，可参考以下步骤（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdr-vivid-video-recorder" target="_blank">HDR Vivid视频录制</a>）：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_createbymime" target="_blank">OH_VideoEncoder_CreateByMime()</a>根据MIME类型创建HEVC格式视频编码器并初始化。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L24-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create a video coder and initialize it</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoEncoder::Create</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;videoCodecMime)</span> </span>{</li><li>    encoder_ = <span class="hljs-built_in">OH_VideoEncoder_CreateByMime</span>(videoCodecMime.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(encoder_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Create failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L24-L29" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>配置HDR Vivid相关参数，包括可选配置视频帧宽度、视频帧高度、视频颜色格式，以及必须配置为HEVC_PROFILE_MAIN_10的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-base-h#oh_hevcprofile" target="_blank">OH_HEVCProfile</a>，表示HEVC编码档次为10bit主档次。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L117-L160" data-highlighted="yes"><ol class="linenums"><li>int32_t VideoEncoder::<span class="hljs-built_in">Configure</span>(const SampleInfo &amp;sampleInfo) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Setting HDRVivid-related parameters</span></li><li>    if (sampleInfo.isHDRVivid) {</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_I_FRAME_INTERVAL, sampleInfo.iFrameInterval);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_RANGE_FLAG, sampleInfo.rangFlag);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_COLOR_PRIMARIES, sampleInfo.primary);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_TRANSFER_CHARACTERISTICS, sampleInfo.transfer);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(format, OH_MD_KEY_MATRIX_COEFFICIENTS, sampleInfo.matrix);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L117-L160" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_configure" target="_blank">OH_VideoEncoder_Configure()</a>配置编码器。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L151-L152" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Setting the Encoder</span></li><li><span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_VideoEncoder_Configure</span>(encoder_, format);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L151-L152" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>ArkTs侧调用createVideoOutput创建video output实例，选择yuv 10bit profile。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/common/utils/CameraCheck.ets#L74-L139" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">videoProfileCheck</span>(<span class="hljs-variable">cameraManager</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraManager</span>,</li><li>  <span class="hljs-variable">cameraData</span>: <span class="hljs-title class_">CameraDataModel</span>): <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">cameraDevices</span> = <span class="hljs-variable">cameraManager</span>.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">profiles</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraOutputCapability</span> =</li><li>    <span class="hljs-variable">cameraManager</span>.<span class="hljs-title function_">getSupportedOutputCapability</span>(<span class="hljs-variable">cameraDevices</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">camera</span>.<span class="hljs-variable">SceneMode</span>.<span class="hljs-variable">NORMAL_VIDEO</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">videoProfiles</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span>&gt; = <span class="hljs-variable">profiles</span>.<span class="hljs-variable">videoProfiles</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">videoProfile</span>: <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span> = <span class="hljs-variable">videoProfiles</span>.<span class="hljs-title function_">find</span>((<span class="hljs-variable">profile</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">cameraData</span>.<span class="hljs-variable">isHDRVivid</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">profile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span> === <span class="hljs-variable">cameraData</span>.<span class="hljs-variable">cameraWidth</span> &amp;&amp;</li><li>          <span class="hljs-variable">profile</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span> === <span class="hljs-variable">cameraData</span>.<span class="hljs-variable">cameraHeight</span> &amp;&amp;</li><li>          <span class="hljs-variable">profile</span>.<span class="hljs-variable">format</span> === <span class="hljs-variable">camera</span>.<span class="hljs-variable">CameraFormat</span>.<span class="hljs-variable">CAMERA_FORMAT_YCBCR_P010</span> &amp;&amp;</li><li>          <span class="hljs-variable">profile</span>.<span class="hljs-variable">frameRateRange</span>.<span class="hljs-variable">min</span> === <span class="hljs-number">1</span> &amp;&amp;</li><li>          <span class="hljs-variable">profile</span>.<span class="hljs-variable">frameRateRange</span>.<span class="hljs-variable">max</span> === <span class="hljs-number">30</span>;</li><li>        <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  });</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">videoProfile</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/common/utils/CameraCheck.ets#L74-L139" target="_blank">CameraCheck.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L213-L236" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">videoProfile</span>: <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoProfile</span> = <span class="hljs-title function_">videoProfileCheck</span>(<span class="hljs-variable">cameraManager</span>, <span class="hljs-variable">params</span>);</li><li><span class="hljs-keyword">if</span> (!<span class="hljs-variable">videoProfile</span>) {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'videoProfile is not found!'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// Create the encoder output object</span></li><li><span class="hljs-variable">encoderVideoOutput</span> = <span class="hljs-variable">cameraManager</span>.<span class="hljs-title function_">createVideoOutput</span>(<span class="hljs-variable">videoProfile</span>, <span class="hljs-variable">params</span>.<span class="hljs-variable">surfaceId</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">encoderVideoOutput</span> === <span class="hljs-variable">undefined</span>) {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'encoderVideoOutput is undefined'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'encoderVideoOutput  success'</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L213-L236" target="_blank">Recorder.ets</a></div></div></div></div> <p></p> </li><li>设置视频防抖及色彩空间。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L71-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">isVideoStabilizationModeSupported</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>, <span class="hljs-variable">mode</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoStabilizationMode</span>): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">isSupported</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">isSupported</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">isVideoStabilizationModeSupported</span>(<span class="hljs-variable">mode</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-comment">// Failed to return error code error. code and handle it.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">The</span> <span class="hljs-variable">isVideoStabilizationModeSupported</span> <span class="hljs-variable">call</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">isSupported</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">setVideoStabilizationMode</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">mode</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoStabilizationMode</span> = <span class="hljs-variable">camera</span>.<span class="hljs-variable">VideoStabilizationMode</span>.<span class="hljs-variable">AUTO</span>;</li><li>  <span class="hljs-comment">// Check if video stabilization is supported.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">isSupported</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-title function_">isVideoStabilizationModeSupported</span>(<span class="hljs-variable">session</span>, <span class="hljs-variable">mode</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">isSupported</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setVideoStabilizationMode</span>: ${<span class="hljs-variable">mode</span>}`);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Setting video anti-shake</span></li><li>      <span class="hljs-variable">session</span>.<span class="hljs-title function_">setVideoStabilizationMode</span>(<span class="hljs-variable">mode</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">activeVideoStabilizationMode</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getActiveVideoStabilizationMode</span>();</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">activeVideoStabilizationMode</span>: ${<span class="hljs-variable">activeVideoStabilizationMode</span>}`);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setVideoStabilizationMode</span> <span class="hljs-keyword">catch</span> <span class="hljs-variable">error</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">videoStabilizationMode</span>: ${<span class="hljs-variable">mode</span>} <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">support</span>`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">isSupported</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">colorSpaces</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">The</span> <span class="hljs-variable">getSupportedColorSpaces</span> <span class="hljs-variable">call</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">colorSpaces</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Set the color space</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>, <span class="hljs-variable">isHdr</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> =</li><li>      <span class="hljs-variable">isHdr</span> ? <span class="hljs-variable">colorSpaceManager</span>.<span class="hljs-variable">ColorSpace</span>.<span class="hljs-variable">BT2020_HLG_LIMIT</span> : <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>.<span class="hljs-title class_">BT709_LIMIT</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; = <span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-variable">session</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">isSupportedColorSpaces</span> = <span class="hljs-variable">colorSpaces</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable">colorSpace</span>) &gt;= <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">isSupportedColorSpaces</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setColorSpace</span>: ${<span class="hljs-variable">colorSpace</span>}`);</li><li>      <span class="hljs-variable">session</span>.<span class="hljs-title function_">setColorSpace</span>(<span class="hljs-variable">colorSpace</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">activeColorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">activeColorSpace</span>: ${<span class="hljs-variable">activeColorSpace</span>}`);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">colorSpace</span>: ${<span class="hljs-variable">colorSpace</span>} <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">support</span>`);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setColorSpace</span> <span class="hljs-keyword">catch</span> <span class="hljs-variable">error</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L71-L132" target="_blank">Recorder.ets</a></div></div></div></div> </li><li>创建并配置相机会话。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L222-L357" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-title class_">XComponentPreviewProfile</span>: camera.<span class="hljs-property">Profile</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title function_">previewProfileCameraCheck</span>(cameraManager, params);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-title class_">XComponentPreviewProfile</span> === <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'XComponentPreviewProfile is not found'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// Create a session flow</span></li><li><span class="hljs-keyword">try</span> {</li><li>  videoSession = cameraManager.<span class="hljs-title function_">createSession</span>(camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>) <span class="hljs-keyword">as</span> camera.<span class="hljs-property">VideoSession</span>;</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to create the session instance. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// Start Configuring the session.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  videoSession.<span class="hljs-title function_">beginConfig</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to add cameraInput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Add the XComponent preview stream to the session.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  videoSession.<span class="hljs-title function_">addOutput</span>(<span class="hljs-title class_">XComponentPreviewOutput</span>);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Add the encoder video stream to the session.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  videoSession.<span class="hljs-title function_">addOutput</span>(encoderVideoOutput);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Submit configuration information.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">commitConfig</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Set video stabilization.</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-title function_">setVideoStabilizationMode</span>(videoSession)) {</li><li>  <span class="hljs-comment">// Set color space.</span></li><li>  <span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(videoSession, params.<span class="hljs-property">isHDRVivid</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Session start.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">await</span> videoSession.<span class="hljs-title function_">start</span>();</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Start the video output stream</span></li><li>encoderVideoOutput.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L222-L357" target="_blank">Recorder.ets</a></div></div></div></div> <p></p> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avmuxer-h#oh_avmuxer_create" target="_blank">OH_AVMuxer_Create()</a>创建AVMuxer封装器实例对象，设置封装格式及封装路径，配置HDR Vivid相关参数。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L31-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an encapsulator instance object and set the encapsulation format to mp4</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Create</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd)</span> </span>{</li><li>    muxer_ = <span class="hljs-built_in">OH_AVMuxer_Create</span>(fd, AV_OUTPUT_FORMAT_MPEG_4);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(muxer_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Muxer create failed, fd: %{public}d"</span>, fd);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Config</span><span class="hljs-params">(SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(muxer_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Muxer is null"</span>);</li><li>    </li><li>    OH_AVFormat *formatAudio = <span class="hljs-built_in">OH_AVFormat_CreateAudioFormat</span>(sampleInfo.audioCodecMime.<span class="hljs-built_in">data</span>(),</li><li>                                                             sampleInfo.audioSampleRate, sampleInfo.audioChannelCount);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(formatAudio != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Create audio format failed"</span>);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_PROFILE, AAC_PROFILE_LC);</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;audioTrackId_, formatAudio);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatAudio); </li><li>
</li><li>    OH_AVFormat *formatVideo =</li><li>        <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>(), sampleInfo.videoWidth, sampleInfo.videoHeight);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(formatVideo != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Create video format failed"</span>);</li><li>
</li><li>    <span class="hljs-built_in">OH_AVFormat_SetDoubleValue</span>(formatVideo, OH_MD_KEY_FRAME_RATE, sampleInfo.frameRate);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_WIDTH, sampleInfo.videoWidth);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_HEIGHT, sampleInfo.videoHeight);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(formatVideo, OH_MD_KEY_CODEC_MIME, sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>());</li><li>    <span class="hljs-keyword">if</span> (sampleInfo.isHDRVivid) {</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_VIDEO_IS_HDR_VIVID, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_RANGE_FLAG, sampleInfo.rangFlag);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_COLOR_PRIMARIES, sampleInfo.primary);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_TRANSFER_CHARACTERISTICS, sampleInfo.transfer);</li><li>        <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_MATRIX_COEFFICIENTS, sampleInfo.matrix);</li><li>    }</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;videoTrackId_, formatVideo);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatVideo);</li><li>    formatVideo = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">OH_AVMuxer_SetRotation</span>(muxer_, CAMERA_ANGLE);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"AddTrack failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L31-L70" target="_blank">Muxer.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videoencoder-h#oh_videoencoder_start" target="_blank">OH_VideoEncoder_Start()</a>启动编码器。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L57-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start Encoder</span></li><li>int32_t VideoEncoder::Start() {</li><li>    CHECK_AND_RETURN_RET_LOG(encoder_ != nullptr, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Encoder is null"</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> ret = OH_VideoEncoder_Start(encoder_);</li><li>    CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span>, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Start failed, ret: %{public}d"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L57-L64" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section16986221152715">HDR Vivid视频播放<i class="anchor-icon anchor-icon-link" anchorid="section16986221152715" tips="复制节点链接"></i></h2><p>要实现HDR Vivid视频播放，通常需要在视频播放流程中进行特定的处理，这包括：视频文件解析、解码器配置和渲染处理。</p> </div> <p>相对于主流格式视频播放的开发，HDR Vivid视频播放的开发与其流程基本一致，只在解码格式上有所区别。下面将从解码格式上来讲解在HarmonyOS上进行视频开发的主要两种方案：</p> <ul><li>使用系统播放器（已集成系统解码和渲染能力）进行开发。</li><li>基于系统解码和渲染能力开发应用级播放器。</li></ul> <div class="tiledSection"><h3 id="section11502183617297" class="firsth2">使用系统播放器AVPlayer开发<i class="anchor-icon anchor-icon-link" anchorid="section11502183617297" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>AVPlayer提供功能完善一体化播放能力，应用只需要提供流媒体来源，不负责数据解析和解码就可达成播放效果。</p> <p><span><img height="271.32" originheight="600" originwidth="1154" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163039.56027744497542319383717403965700:50001231000000:2800:EB4F7974AD14BF93118E55A82754F2BB0A4BB77D6FAFC6F5707B60A38597EF44.png" title="点击放大" width="523.6875"></span></p> </div> <p><strong>开发步骤</strong></p> <p>使用系统播放器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>开发视频播放功能，主要开发步骤为（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback" target="_blank">使用AVPlayer播放视频（ArkTS）</a>）：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreateavplayer9" target="_blank">createAVPlayer()</a>创建AVPlayer实例，初始化进入idle状态并设置资源属性url。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L52-L84" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">initAVPlayer</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">media</span>.<span class="hljs-title function_">createAVPlayer</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">player</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">AVPlayer</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">player</span> !== <span class="hljs-variable">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayer</span> = <span class="hljs-variable">player</span>;</li><li>      <span class="hljs-comment">// this.curSource.video is the local video path, and this.curSource.url is the network video path</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">curSource</span>.<span class="hljs-variable">video</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">fileDescriptor</span>: <span class="hljs-title class_">resourceManager</span>.<span class="hljs-title class_">RawFileDescriptor</span> | <span class="hljs-title class_">undefined</span> =</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>?.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">curSource</span>.<span class="hljs-variable">video</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">fileDescriptor</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">avFileDescriptor</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">AVFileDescriptor</span> =</li><li>            { <span class="hljs-variable">fd</span>: <span class="hljs-title class_">fileDescriptor</span>.<span class="hljs-title class_">fd</span>, <span class="hljs-variable">offset</span>: <span class="hljs-title class_">fileDescriptor</span>.<span class="hljs-title class_">offset</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">fileDescriptor</span>.<span class="hljs-title class_">length</span> };</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayer</span>.<span class="hljs-variable">fdSrc</span> = <span class="hljs-variable">avFileDescriptor</span>;</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayer</span>.<span class="hljs-variable">url</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">curSource</span>.<span class="hljs-variable">url</span>;</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'createAVPlayer fail'</span>);</li><li>    }</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">AVPlayer</span> <span class="hljs-variable">catchCallback</span>, <span class="hljs-variable">error</span> <span class="hljs-variable">message</span>:${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L52-L84" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li><li>设置业务需要的监听事件，从XComponent组件获取surfaceID并设置该属性，接着调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#prepare9" target="_blank">prepare()</a>，AVPlayer进入prepared状态，可设置缩放模式、音量等。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L204-L267" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">setStateChangeCallback</span>(<span class="hljs-params">avPlayer: media.AVPlayer</span>): <span class="hljs-keyword">void</span></span> {</li><li>  avPlayer.<span class="hljs-keyword">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (state: <span class="hljs-built_in">string</span>) =&gt; {</li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>:</li><li>        Logger.info(TAG, <span class="hljs-string">'AVPlayer state initialized called.'</span> + ` <span class="hljs-keyword">this</span>.curIndex:${<span class="hljs-keyword">this</span>.curIndex}`);</li><li>        avPlayer.surfaceId = <span class="hljs-keyword">this</span>.surfaceID;</li><li>        avPlayer.prepare();</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>:</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L204-L267" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li><li>设置视频播控功能，包括播放<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#play9" target="_blank">play()</a>，暂停<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#pause9" target="_blank">pause()</a>，跳转<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>，停止<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#stop9" target="_blank">stop()</a> 、重置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#reset9" target="_blank">reset()</a>等操作。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L355-L440" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">playVideo</span>(): <span class="hljs-keyword">void</span></span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">pauseVideo</span>(): <span class="hljs-keyword">void</span></span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">stopVideo</span>(): <span class="hljs-keyword">void</span></span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Parameter seekTime unit - milliseconds (ms)</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">seek</span>(<span class="hljs-params">seekTime: number</span>): <span class="hljs-keyword">void</span></span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L355-L440" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li><li>最后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#release9" target="_blank">release()</a>销毁实例，退出播放。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L468-L486" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> releaseVideo(index: number): void {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avPlayer) {</li><li>    Logger.info(TAG, `releaseVideo: state:${<span class="hljs-keyword">this</span>.avPlayer.state} <span class="hljs-keyword">this</span>.curIndex:${<span class="hljs-keyword">this</span>.curIndex} <span class="hljs-keyword">this</span>.index:${index}`);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.avPlayer.off(<span class="hljs-string">'timeUpdate'</span>);</li><li>      <span class="hljs-keyword">this</span>.avPlayer.off(<span class="hljs-string">'seekDone'</span>);</li><li>      <span class="hljs-keyword">this</span>.avPlayer.off(<span class="hljs-string">'speedDone'</span>);</li><li>      <span class="hljs-keyword">this</span>.avPlayer.off(<span class="hljs-string">'error'</span>);</li><li>      <span class="hljs-keyword">this</span>.avPlayer.off(<span class="hljs-string">'stateChange'</span>);</li><li>      <span class="hljs-keyword">this</span>.avPlayer.release();</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      Logger.error(TAG, `releaseVideo failed, err.code:${err.code}, err.message:${err.message}`);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-player/blob/master/MediaService/src/main/ets/controller/AvPlayerController.ets#L468-L486" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section20600229103818">使用系统解码器AVCodec开发<i class="anchor-icon anchor-icon-link" anchorid="section20600229103818" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> </div> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding" target="_blank">AVCodec模块</a>的Native API接口，可以完成视频解码功能，即将媒体数据在系统侧解码成YUV文件或送显至应用上。</p> <p><span><img height="314.21250000000003" originheight="600" originwidth="1000" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163040.99148013343007426936881711773948:50001231000000:2800:0FA8AACBE4CA9B890C654CA62C36D7D4EB4C33022CEE692AD4CD7CFD406F59D6.png" title="点击放大" width="523.6875"></span></p> <p><strong>开发步骤</strong></p> <p>使用系统解码器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h" target="_blank">AVCodec</a>开发HDR Vivid视频播放功能，主要开发步骤为（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdr-vivid-video-player" target="_blank">HDR Vivid视频播放</a>）：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_createbymime" target="_blank">OH_VideoDecoder_CreateByMime()</a>通过HEVC格式创建解码器实例对象。如果需要对HDR Vivid视频进行解码，需要配置MimeType为H265 (即OH_AVCODEC_MIMETYPE_VIDEO_HEVC)。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L29-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create a decoder instance object</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::Create</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;videoCodecMime)</span> </span>{</li><li>    decoder_ = <span class="hljs-built_in">OH_VideoDecoder_CreateByMime</span>(videoCodecMime.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(decoder_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Create failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L29-L34" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_registercallback" target="_blank">OH_VideoDecoder_RegisterCallback()</a>设置回调函数。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L38-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Setting the callback function</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">VideoDecoder</span>::<span class="hljs-title class_">SetCallback</span>(<span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*codecUserData</span>) {</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">AV_ERR_OK</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_RegisterCallback</span>(<span class="hljs-variable">decoder_</span>,</li><li>                                           {<span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecFormatChange</span>,</li><li>                                            <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>},</li><li>                                           <span class="hljs-variable">codecUserData</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AV_ERR_OK</span>, <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Set callback failed, ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L38-L48" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configure" target="_blank">OH_VideoDecoder_Configure()</a>配置解码器。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L52-L76" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Setting the Decoder</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::Configure</span><span class="hljs-params">(<span class="hljs-type">const</span> SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_VideoDecoder_Configure</span>(decoder_, format);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L52-L76" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>从XComponent组件获取window参数，设置Surface，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_prepare" target="_blank">OH_VideoDecoder_Prepare()</a>使解码器就绪。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L80-L110" data-highlighted="yes"><ol class="linenums"><li>int32_t VideoDecoder::Config(<span class="hljs-keyword">const</span> SampleInfo &amp;sampleInfo, CodecUserData *codecUserData) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// SetSurface from video decoder</span></li><li>    <span class="hljs-keyword">if</span> (sampleInfo.window != nullptr) {</li><li>        <span class="hljs-type">int</span> ret = OH_VideoDecoder_SetSurface(decoder_, sampleInfo.window);</li><li>        CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span> &amp;&amp; sampleInfo.window, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>,</li><li>                                 <span class="hljs-string">"Set surface failed, ret: %{public}d"</span>, ret);</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// Prepare video decoder</span></li><li>    {</li><li>        <span class="hljs-type">int</span> ret = OH_VideoDecoder_Prepare(decoder_);</li><li>        CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span>, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Prepare failed, ret: %{public}d"</span>, ret);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L80-L110" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_start" target="_blank">OH_VideoDecoder_Start()</a>启动解码器。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L114-L121" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start the Decoder</span></li><li>int32_t VideoDecoder::Start() {</li><li>    CHECK_AND_RETURN_RET_LOG(decoder_ != nullptr, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Decoder is null"</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> ret = OH_VideoDecoder_Start(decoder_);</li><li>    CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span>, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Start failed, ret: %{public}d"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L114-L121" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_pushinputbuffer" target="_blank">OH_VideoDecoder_PushInputBuffer()</a>写入解码码流。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L125-L131" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Write the decoded stream</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::PushInputBuffer</span><span class="hljs-params">(CodecBufferInfo &amp;info)</span> </span>{</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(decoder_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Decoder is null"</span>);</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_VideoDecoder_PushInputBuffer</span>(decoder_, info.bufferIndex);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Push input data failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L125-L131" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_renderoutputbuffer" target="_blank">OH_VideoDecoder_RenderOutputBuffer()</a>渲染并释放解码帧。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L135-L147" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Render and release decoded frames</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::FreeOutputBuffer</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> bufferIndex, <span class="hljs-type">bool</span> render)</span> </span>{</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(decoder_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Decoder is null"</span>);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = AVCODEC_SAMPLE_ERR_OK;</li><li>    <span class="hljs-keyword">if</span> (render) {</li><li>        ret = <span class="hljs-built_in">OH_VideoDecoder_RenderOutputBuffer</span>(decoder_, bufferIndex);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        ret = <span class="hljs-built_in">OH_VideoDecoder_FreeOutputBuffer</span>(decoder_, bufferIndex);</li><li>    }</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Free output data failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L135-L147" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>最后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_destroy" target="_blank">OH_VideoDecoder_Destroy()</a>销毁解码器实例，释放资源。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L151-L160" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Destroy the decoder instance and release resources</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::Release</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (decoder_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_VideoDecoder_Flush</span>(decoder_);</li><li>        <span class="hljs-built_in">OH_VideoDecoder_Stop</span>(decoder_);</li><li>        <span class="hljs-built_in">OH_VideoDecoder_Destroy</span>(decoder_);</li><li>        decoder_ = <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L151-L160" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section205681450115711">HDR Vivid视频转码成SDR视频<i class="anchor-icon anchor-icon-link" anchorid="section205681450115711" tips="复制节点链接"></i></h2><p>将HDR Vivid视频转码成SDR视频是一个涉及多个技术要点的复杂过程。通过合理的转码处理，可以确保视频内容在不同设备上都能呈现出更好的效果，不仅优化了视频的播放体验，还可以满足更广泛受众的需求，提高市场影响力。</p> <p>首先需要理解HDR和SDR的根本区别：</p> <ul><li>HDR<ul><li>高亮度：支持最高1000、4000、甚至10000尼特亮度。</li><li>宽色域：通常使用Rec.2020色彩空间，能显示更丰富、更鲜艳的颜色。</li><li>高比特深度：通常使用10-bit或12-bit，使得色彩过渡非常平滑，几乎看不到色阶断层。</li></ul> </li><li>SDR<ul><li>低亮度：标准亮度约为100尼特。</li><li>窄色域：通常使用Rec.709色彩空间，色彩范围小。</li><li>低比特深度：传统为8-bit，现在也有10-bit SDR，但是亮度范围有限。</li></ul> </li></ul> <p>转码的核心在于：如何把HDR中那部分“亮的多的”和“色彩更鲜艳的”信息，合理地“塞进”SDR这个有限的框内？具体来说就是将HDR更广的动态范围、色域适配到SDR的显示限制内，尽可能保留画面细节和观感，而不让画面看起来过曝、失真或灰暗。</p> <p>所以转码的本质上是一个将大容量信息压缩到小容量容量中，并尽量保持视觉美感的过程。</p> <p>HarmonyOS上开发HDR Vivid视频转码成SDR视频的功能一般有两个方案：</p> <ul><li>使用AVCodec原生能力转码：主要适用于需要深度定制转码流程的场景，依赖硬件解码器支持，兼容性受设备限制。</li><li>使用VideoProcessing模块转码：主要适用于需要快实现标准化转码流程的场景，无需自定义色彩转换，内置转换算法，配置参数即可完成。比AVCodec原生能力转码流程兼容性好，减少设备差异导致的异常。</li></ul> </div> <div class="tiledSection"><h3 id="section3120190111119" class="firsth2">使用AVCodec原生能力转码<i class="anchor-icon anchor-icon-link" anchorid="section3120190111119" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>AVCodec是系统提供的底层音视频编解码接口，主要负责原始音频数据的编解码处理。在解码过程中，AVCodec提供了色彩转换的接口支持将输出的原始YUV数据转换成指定的SDR标准的YUV数据，具体开发步骤如下所示。</p> <ol><li>先创建硬解码器。</li><li>设置解码器输出格式为SDR，由解码器完成色彩转换，直接将输出的原始YUV数据转换成指定的SDR标准的YUV数据。</li><li>启动解码器，开始转码过程。</li></ol> <p>详细的流程如下：</p> <p><span><img height="358.1025" originheight="629" originwidth="918" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163040.41584964968702860296336529918637:50001231000000:2800:25A58D8C51502F2B5DC9D956CB58743DFC5D0495DDB018F8B831D4E26643794D.png" title="点击放大" width="523.6875"></span></p> <p><strong>开发步骤</strong></p> <p>使用AVCodec原生能转码，主要的开发步骤为（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hdrvivid2sdr" target="_blank">视频解码支持HDRVivid2SDR</a>）：</p> <ol><li>创建解码器实例，查询系统支持的解码器能力，根据查询结果基于name创建硬解码器。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/kangliangup/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/include/VideoDecoder.h#L24-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoDecoder</span> {</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-comment">// ...</span></li><li>    OH_AVCodec *decoder_;</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/kangliangup/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/include/VideoDecoder.h#L24-L44" target="_blank">VideoDecoder.h</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L35-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::Create</span><span class="hljs-params">(SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    OH_AVCapability *capability = <span class="hljs-built_in">OH_AVCodec_GetCapabilityByCategory</span>(OH_AVCODEC_MIMETYPE_VIDEO_HEVC, <span class="hljs-literal">false</span>, HARDWARE);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(capability != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERROR, <span class="hljs-string">"OH_AVCodec_GetCapabilityByCategory failed"</span>);</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-built_in">OH_AVCapability_GetName</span>(capability);</li><li>    decoder_ = <span class="hljs-built_in">OH_VideoDecoder_CreateByName</span>(name);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(decoder_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERROR, <span class="hljs-string">"Create VideoDecoder failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L35-L50" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_registercallback" target="_blank">OH_VideoDecoder_RegisterCallback()</a>设置回调函数。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L125-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">VideoDecoder</span>::<span class="hljs-title class_">SetCallback</span>(<span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*codecUserData</span>){</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoDecoder_RegisterCallback</span>(<span class="hljs-variable">decoder_</span>, </li><li>                                                {<span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnCodecFormatChange</span>, </li><li>                                                <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>}, </li><li>                                                <span class="hljs-variable">codecUserData</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AV_ERR_OK</span>, <span class="hljs-variable">AVCODEC_SAMPLE_ERROR</span>, <span class="hljs-string">"Create SetCallback failed"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L125-L132" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configurehttps://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-videodecoder-h#oh_videodecoder_configure" target="_blank">OH_VideoDecoder_Configure()</a>配置解码器。需配置项：视频帧宽度、视频帧高度、视频像素格式、指定输出为SDR。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L136-L158" data-highlighted="yes"><ol class="linenums"><li>int32_t VideoDecoder::Configure(const SampleInfo &amp;sampleInfo) {</li><li>    OH_AVFormat *<span class="hljs-keyword">format</span> = OH_AVFormat_Create();</li><li>    CHECK_AND_RETURN_RET_LOG(<span class="hljs-keyword">format</span> != nullptr, AVCODEC_SAMPLE_ERROR, <span class="hljs-string">"Create AVFormat failed"</span>);</li><li>    OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_WIDTH, sampleInfo.videoWidth);</li><li>    OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_HEIGHT, sampleInfo.videoHeight);</li><li>    OH_AVFormat_SetDoubleValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_FRAME_RATE, sampleInfo.frameRate);</li><li>    OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_PIXEL_FORMAT, sampleInfo.pixelFormat);</li><li>    OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_ROTATION, sampleInfo.rotation);</li><li>    <span class="hljs-regexp">//</span> ...</li><li>        // Key configuration: HDR to SDR conversion</li><li>        OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_DECODER_OUTPUT_COLOR_SPACE, OH_COLORSPACE_BT709_LIMIT);</li><li>        OH_AVFormat_SetIntValue(<span class="hljs-keyword">format</span>, OH_MD_KEY_VIDEO_ENABLE_LOW_LATENCY, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-regexp">//</span> ...</li><li>    <span class="hljs-keyword">int</span> ret = OH_VideoDecoder_Configure(decoder<span class="hljs-number">_</span>, <span class="hljs-keyword">format</span>);</li><li>    OH_AVFormat_Destroy(<span class="hljs-keyword">format</span>);</li><li>    <span class="hljs-keyword">format</span> = nullptr;</li><li>    CHECK_AND_RETURN_RET_LOG(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERROR, <span class="hljs-string">"VideoDecoder Configure failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/capbilities/VideoDecoder.cpp#L136-L158" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>后续步骤具体可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-decoding#surface模式" target="_blank">视频解码Surface模式</a>。</li></ol> </div> <div class="tiledSection"><h3 id="section1076719357145">使用VideoProcessing模块转码<i class="anchor-icon anchor-icon-link" anchorid="section1076719357145" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>VideoProcessing内部集成了色彩空间转换的模块，直接支持HDR Vivid视频到SDR视频的转换，开发者无须手动手动处理YUV数据的色彩转换，只需要通过配置参数即可完成转码。具体开发步骤如下所示。</p> <ol><li>创建色彩空间转换模块。</li><li>注册异步回调函数。</li><li>启动色彩空间转换处理，开始转码。</li></ol> <p>详细的流程如下：</p> <p><span><img height="278.3025" originheight="656" originwidth="1234" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163040.15874605548338623066145874552063:50001231000000:2800:E32CA2FB0CDBB3535B2A2D7F319E4CDA400EF41234DEA8254FD06D7C6FFEC101.png" title="点击放大" width="523.6875"></span></p> <p><strong>开发步骤</strong></p> <p>使用VideoProcessing模块转码，主要的开发步骤为（详细开发步骤可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-csc-V5" target="_blank">视频色彩空间转换</a>）：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_video_processing-V5#oh_videoprocessing_create" target="_blank">OH_VideoProcessing_Create()</a>创建色彩空间转换模块。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L204-L224" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">PrepareSurface</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>) {</li><li>    <span class="hljs-variable">VideoProcessing_ErrorCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">VIDEO_PROCESSING_ERROR_INVALID_VALUE</span>;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isEnvironmentInited</span>) {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_InitializeEnvironment</span>();</li><li>        <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_InitializeEnvironment failed"</span>);</li><li>        <span class="hljs-variable">isEnvironmentInited</span> = <span class="hljs-keyword">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">isVPRunning</span>) {</li><li>        <span class="hljs-title function_">StopProcessing</span>();</li><li>    }</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">metaData</span> = <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">metaData</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">metaData</span> == <span class="hljs-number">2</span>) { <span class="hljs-comment">//  metadata only supports generating OH_VIDEO_HDR_VIVID format</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_Create</span>(&amp;<span class="hljs-title class_">processor</span>, <span class="hljs-variable">VIDEO_PROCESSING_TYPE_METADATA_GENERATION</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_Create</span>(&amp;<span class="hljs-title class_">processor</span>, <span class="hljs-variable">VIDEO_PROCESSING_TYPE_COLOR_SPACE_CONVERSION</span>);</li><li>    }</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_Create failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_GetSurface</span>(<span class="hljs-variable">processor</span>, &amp;<span class="hljs-title class_">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">pluginWindow_</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_GetSurface failed"</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"PrepareSurface succeed"</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L204-L224" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li><li>从XComponent获取OHNativeWindow实例，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_video_processing-V5#oh_videoprocessing_setsurface" target="_blank">OH_VideoProcessing_SetSurface()</a>设置surface。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L150-L200" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">InitProcessing</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>) {</li><li>    <span class="hljs-variable">VideoProcessing_ErrorCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">VIDEO_PROCESSING_ERROR_INVALID_VALUE</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">processType</span> = <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">processType</span>;</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">processType</span>) {</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">err</span> = <span class="hljs-number">0</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">colorSpace</span> == <span class="hljs-variable">OH_COLORSPACE_BT709_LIMIT</span>) {</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">SET_FORMAT</span>,</li><li>                                                        <span class="hljs-variable">NATIVEBUFFER_PIXEL_FMT_YCBCR_420_SP</span>);</li><li>            <span class="hljs-variable">int8_t</span> <span class="hljs-variable">metaData</span> = <span class="hljs-variable">OH_VIDEO_NONE</span>;</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_SetMetadataValue</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">OH_HDR_METADATA_TYPE</span>,</li><li>                                                   <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint8_t</span>), (<span class="hljs-variable">uint8_t</span> *)&amp;<span class="hljs-title class_">metaData</span>);</li><li>            <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"NativeWindowHandleOpt BT709_LIMIT failed"</span>);</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">colorSpace</span> == <span class="hljs-variable">OH_COLORSPACE_BT2020_HLG_LIMIT</span>) {</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_SetMetadataValue</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">OH_HDR_METADATA_TYPE</span>,</li><li>                                                   <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint8_t</span>), (<span class="hljs-variable">uint8_t</span> *)&amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">metaData</span>);</li><li>            <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"SetMetadataValue BT2020_HLG_LIMIT failed"</span>);</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">SET_FORMAT</span>,</li><li>                                                        <span class="hljs-variable">NATIVEBUFFER_PIXEL_FMT_RGBA_1010102</span>);</li><li>            <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"NativeWindowHandleOpt BT2020_HLG_LIMIT failed"</span>);</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">colorSpace</span> == <span class="hljs-variable">OH_COLORSPACE_BT2020_PQ_LIMIT</span>) {</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_SetMetadataValue</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">OH_HDR_METADATA_TYPE</span>,</li><li>                                                   <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">uint8_t</span>), (<span class="hljs-variable">uint8_t</span> *)&amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">metaData</span>);</li><li>            <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"SetMetadataValue BT2020_PQ_LIMIT failed"</span>);</li><li>            <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">SET_FORMAT</span>,</li><li>                                                        <span class="hljs-variable">NATIVEBUFFER_PIXEL_FMT_RGBA_1010102</span>);</li><li>            <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"NativeWindowHandleOpt BT2020_PQ_LIMIT failed"</span>);</li><li>        }</li><li>        <span class="hljs-variable">err</span> = <span class="hljs-title function_">OH_NativeWindow_SetColorSpace</span>(<span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">colorSpace</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">err</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"SetColorSpace failed"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_SetSurface</span>(<span class="hljs-variable">processor</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_SetSurface</span>(<span class="hljs-variable">processor</span>, <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">windowOut</span>);</li><li>    }</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"SetSurface failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessingCallback_Create</span>(&amp;<span class="hljs-title class_">callback</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessingCallback_Create failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessingCallback_BindOnError</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnError</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnError failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessingCallback_BindOnState</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnState</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnState failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessingCallback_BindOnNewOutputBuffer</span>(<span class="hljs-variable">callback</span>, <span class="hljs-variable">OnNewOutputBuffer</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnNewOutputBuffer failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_RegisterCallback</span>(<span class="hljs-variable">processor</span>, <span class="hljs-variable">callback</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_RegisterCallback failed"</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"InitProcessing succeed"</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L150-L200" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_video_processing-V5#oh_videoprocessing_registercallback" target="_blank">OH_VideoProcessing_RegisterCallback()</a>等函数创建并绑定回调函数。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L188-L197" data-highlighted="yes"><ol class="linenums"><li>ret = OH_VideoProcessingCallback_Create(&amp;callback);</li><li>CHECK_AND_RETURN_LOG(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessingCallback_Create failed"</span>);</li><li>ret = OH_VideoProcessingCallback_BindOnError(callback, OnError);</li><li>CHECK_AND_RETURN_LOG(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnError failed"</span>);</li><li>ret = OH_VideoProcessingCallback_BindOnState(callback, OnState);</li><li>CHECK_AND_RETURN_LOG(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnState failed"</span>);</li><li>ret = OH_VideoProcessingCallback_BindOnNewOutputBuffer(callback, OnNewOutputBuffer);</li><li>CHECK_AND_RETURN_LOG(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessingCallback_BindOnNewOutputBuffer failed"</span>);</li><li>ret = OH_VideoProcessing_RegisterCallback(processor, callback, nullptr);</li><li>CHECK_AND_RETURN_LOG(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessing_RegisterCallback failed"</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L188-L197" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/_video_processing-V13#oh_videoprocessing_start" target="_blank">OH_VideoProcessing_Start()</a>启动色彩空间转换处理。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L228-L242" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">StartProcessing</span>() {</li><li>    <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">sampleInfo_</span>-&gt;<span class="hljs-title class_">vpErrorCode</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">VideoProcessing_ErrorCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_Start</span>(<span class="hljs-variable">processor</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>) {</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_Start failed， ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"StartProcessing succeed"</span>);</li><li>    </li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L228-L242" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/_video_processing-V13#oh_videoprocessing_stop" target="_blank">OH_VideoProcessing_Stop()</a>停止色彩空间转换处理。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L248-L260" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">StopProcessing</span>() {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"StartProcessing stop :%{public}d, %{public}d"</span>,</li><li>                 <span class="hljs-variable">g_FrameCount</span>, <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">frameCount</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">isVPRunning</span>) {</li><li>        <span class="hljs-variable">VideoProcessing_ErrorCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_Stop</span>(<span class="hljs-variable">processor</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_Stop failed"</span>);</li><li>        <span class="hljs-variable">isVPRunning</span> = <span class="hljs-keyword">false</span>;</li><li>    }</li><li>    <span class="hljs-variable">g_FrameCount</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">GetInstance</span>()-&gt;<span class="hljs-title class_">frameCount</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"StartProcessing Stop succeed"</span>);</li><li>    <span class="hljs-title function_">DestroyProcessing</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L248-L260" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_video_processing-V5#oh_videoprocessing_destroy" target="_blank">OH_VideoProcessing_Destroy()</a>及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_video_processing-V5#oh_videoprocessing_deinitializeenvironment" target="_blank">OH_VideoProcessing_DeinitializeEnvironment()</a>释放处理实例和资源。<div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L285-L298" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PluginManager::Release</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (isVPRunning) {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-built_in">DestroyProcessing</span>();</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (isEnvironmentInited) {</li><li>        VideoProcessing_ErrorCode ret = <span class="hljs-built_in">OH_VideoProcessing_DeinitializeEnvironment</span>();</li><li>        <span class="hljs-built_in">CHECK_AND_RETURN_LOG</span>(ret == VIDEO_PROCESSING_SUCCESS, <span class="hljs-string">"OH_VideoProcessing_DeinitializeEnvironment failed"</span>);</li><li>        isEnvironmentInited = <span class="hljs-literal">false</span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, LOG_TAG, <span class="hljs-string">"DeinitializeEnvironment Succeed"</span>);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L285-L298" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-vqe-c106="" class="highlight-div"><div _ngcontent-vqe-c106="" class="highlight-div-header"><div _ngcontent-vqe-c106="" class="highlight-div-header-left"><div _ngcontent-vqe-c106="" class="handle-button expand-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vqe-c106="" class="highlight-div-header-right"><div _ngcontent-vqe-c106="" class="handle-button ai-button"></div><div _ngcontent-vqe-c106="" class="handle-button line-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vqe-c106="" class="handle-button theme-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vqe-c106="" class="handle-button copy-button"><div _ngcontent-vqe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vqe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L264-L281" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">PluginManager</span>::<span class="hljs-title class_">DestroyProcessing</span>() {</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">processor</span> != <span class="hljs-variable">nullptr</span>, <span class="hljs-string">"processor is nullptr"</span>);</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"start DestroyProcessing"</span>);</li><li>    <span class="hljs-variable">VideoProcessing_ErrorCode</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessing_Destroy</span>(<span class="hljs-variable">processor</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessing_Destroy failed"</span>);</li><li>    <span class="hljs-variable">processor</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">callback</span> != <span class="hljs-variable">nullptr</span>, <span class="hljs-string">"callback is nullptr"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoProcessingCallback_Destroy</span>(<span class="hljs-variable">callback</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">VIDEO_PROCESSING_SUCCESS</span>, <span class="hljs-string">"OH_VideoProcessingCallback_Destroy failed"</span>);</li><li>    <span class="hljs-variable">callback</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"Destroy And Callback_Destroy succeed"</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">OnErrorThread_</span> &amp;&amp; <span class="hljs-variable">OnErrorThread_</span>-&gt;<span class="hljs-title class_">joinable</span>()) {</li><li>        <span class="hljs-variable">OnErrorThread_</span>-&gt;<span class="hljs-title class_">detach</span>();</li><li>        <span class="hljs-variable">OnErrorThread_</span>.<span class="hljs-title function_">reset</span>();</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-variable">LOG_TAG</span>, <span class="hljs-string">"Release OnError Thread succeed"</span>);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/hdr2sdr/blob/master/entry/src/main/cpp/render/ProcessingPluginManager.cpp#L264-L281" target="_blank">ProcessingPluginManager.cpp</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section13120203414151">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section13120203414151" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/hdr2sdr/tree/master/" target="_blank">HDR转码SDR</a></li></ul> </div> </div> <div></div></div>