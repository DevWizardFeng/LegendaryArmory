<h1 _ngcontent-rkl-c119="" class="doc-title ng-star-inserted" title="Image白块解决方案"> Image白块解决方案 </h1>

<div _ngcontent-rkl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section10882173517262">概述<i class="anchor-icon anchor-icon-link" anchorid="section10882173517262" tips="复制节点链接"></i></h2><p>在通过Image组件加载网络图片时，整个过程可分为四个关键阶段：组件创建、图片资源下载、图片解码和最终刷新显示。当加载的图片资源过大时，组件需等待下载与解码完成后才进行刷新。由于下载阶段耗时较长（尤其在网络波动或大文件场景下），图片在完全渲染前会显示为空白或浅色占位图，这种现象被称为“Image白块”。它不仅影响视觉体验，还可能降低用户对应用性能的感知。</p> <p>为减少白块出现，开发者可采用预下载与缓存机制：</p> <ul><li>预下载阶段：在组件创建前（如父页面初始化时），将网络图片通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">应用沙箱</a>的方式进行提前缓存。</li><li>缓存复用阶段：当Image组件加载时，首先检查应用沙箱是否存在缓存。若存在，则直接读取缓存数据；若不存在，再发起网络请求。非首次请求时，该机制可避免重复下载，从而缩短白块持续时间。</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>Image加载网络图片两种方式对比</span><br><span><img height="256.815286" originheight="427" originwidth="1592" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163422.47510130933503227748015507757271:50001231000000:2800:55837881FC0312019B53522546E11FFBF1F353B116C8409A67C2E89E63731C2E.png" title="点击放大" width="907.725"></span></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1. 开发者在使用Image加载较大的网络图片时，网络下载推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/http-request" target="_blank">HTTP</a>工具提前预下载。</p> <p>2. 在预下载之后，开发者可根据业务自行选择数据处理方式，如将预下载后得到的ArrayBuffer转成BASE64、使用应用沙箱提前缓存、直接转PixelMap、或是业务上自行处理ArrayBuffer等多种方式灵活处理数据后，传给Image组件。</p> </div></div></div> <p>当子页面需要加载很大的网络图片时，可以在父页面提前将网络数据预下载到应用沙箱中，子组件加载时从沙箱中读取，减少白块出现时长。</p> </div> <div class="tiledSection"><h2 id="section104565112043">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section104565112043" tips="复制节点链接"></i></h2><p>开发者使用Navigation组件时，通常会在主页引入子页面组件，在按钮中添加方法实现跳转子页面组件。当子页面中需展示一张较大的网络图片时，而Image未设置占位图时，会出现点击按钮后，子组件的Image组件位置出现长时间的Image白块现象。</p> <p>本文将以应用沙箱提前缓存举例，给出减少Image白块出现时长的一种优化方案。</p> </div> <div class="tiledSection"><h3 id="section8374724596" class="firsth2">【优化前】：使用Image组件直接加载网络地址<i class="anchor-icon anchor-icon-link" anchorid="section8374724596" tips="复制节点链接"></i></h3><p>使用Image组件直接加载网络地址。</p> <div class="screenLinkPre"><div _ngcontent-rkl-c106="" class="highlight-div"><div _ngcontent-rkl-c106="" class="highlight-div-header"><div _ngcontent-rkl-c106="" class="highlight-div-header-left"><div _ngcontent-rkl-c106="" class="handle-button expand-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rkl-c106="" class="highlight-div-header-right"><div _ngcontent-rkl-c106="" class="handle-button ai-button"></div><div _ngcontent-rkl-c106="" class="handle-button line-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rkl-c106="" class="handle-button theme-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rkl-c106="" class="handle-button copy-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/PageOne.ets#L16-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Builder</span></li><li>export function PageOneBuilder() {</li><li>  <span class="hljs-built_in">PageOne</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">@Component</span></li><li>export struct PageOne {</li><li>  pageInfo: NavPathStack = new <span class="hljs-built_in">NavPathStack</span>();</li><li>  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">name</span>: string = <span class="hljs-string">'pageOne'</span>;</li><li>  <span class="hljs-keyword">@LocalStorageLink</span>(<span class="hljs-string">'imageData'</span>) <span class="hljs-attribute">imageData</span>: PixelMap | undefined = undefined;</li><li>
</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">NavDestination</span>() {</li><li>      <span class="hljs-built_in">Row</span>() {</li><li>        <span class="hljs-comment">// Positive example: At this time, the Image has obtained the network image that has been loaded in advance,</span></li><li>        <span class="hljs-comment">// reducing the time for white blocks to appear.</span></li><li>        <span class="hljs-built_in">Image</span>(this.imageData)</li><li>          <span class="hljs-selector-class">.objectFit</span>(ImageFit.Auto)</li><li>          <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>          <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      }</li><li>      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)</li><li>    }</li><li>    <span class="hljs-selector-class">.title</span>(this.name)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/PageOne.ets#L16-L43" target="_blank">PageOne.ets</a></div></div></div></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>使用Image直接加载网络图片时，可以使用.alt()的方式，在网络图片加载成功前使用占位图，避免白块出现时长过长，优化用户体验。</li></ul> <ul><li>使用网络图片时，需要申请权限ohos.permission.INTERNET。具体申请方式请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。</li></ul> </div></div></div> <div class="tiledSection"><h3 id="section66762818562">【优化后】：通过预下载的方式<i class="anchor-icon anchor-icon-link" anchorid="section66762818562" tips="复制节点链接"></i></h3><p>子页面PageOne中需展示一张较大的网络图片，在父组件的aboutToAppear()中提前发起网络请求，并做判断文件是否存在，已下载的不再重复请求，存储在应用沙箱中。当父页面点击按钮跳转子页面PageOne，此时触发pixMap请求读取应用沙箱中已缓存解码的网络图片并存储在LocalStorage中，通过在子页面的Image中传入被@StorageLink修饰的变量ImageData进行数据刷新，图片送显。</p> <div class="fignone"><span class="figcap"><b>图2 </b>使用预下载的方式，由开发者灵活地处理网络图片，减少白块出现时长</span><br><span><img height="639.083221" originheight="906" originwidth="490" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163422.58916891966481716932486304498274:50001231000000:2800:74155583F2E94E45EFDE0319C45BA711CA4E10D5CACDAFCE4CB0FAC14F62A00B.png" title="点击放大" width="354.1125"></span></div> <ol><li>在父组件里aboutToAppear()中提前发起网络请求，当父页面点击按钮跳转子页面PageOne，此时触发pixMap请求读取应用沙箱中已缓存解码的网络图片并存储在localStorage中。非首次点击时，不再重复调用getPixMap()，避免每次点击都从沙箱里读取文件。<div class="screenLinkPre"><div _ngcontent-rkl-c106="" class="highlight-div"><div _ngcontent-rkl-c106="" class="highlight-div-header"><div _ngcontent-rkl-c106="" class="highlight-div-header-left"><div _ngcontent-rkl-c106="" class="handle-button expand-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rkl-c106="" class="highlight-div-header-right"><div _ngcontent-rkl-c106="" class="handle-button ai-button"></div><div _ngcontent-rkl-c106="" class="handle-button line-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rkl-c106="" class="handle-button theme-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rkl-c106="" class="handle-button copy-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/MainPage.ets#L16-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">fileIo</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">fs</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">common</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">httpRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/NetRequest'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-package">Logger</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/Logger'</span>;</li><li>
</li><li><span class="hljs-comment">// Obtain the path of the application file</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'uiContext'</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span> = <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">filesDir</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">fileUrl</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">filesDir</span> + <span class="hljs-string">'/xxx.png'</span>; <span class="hljs-comment">// The image's network address suffix needs to be replaced by the real url.</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">para</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">undefined</span>&gt; = { <span class="hljs-string">'imageData'</span>: <span class="hljs-title class_">undefined</span> };</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">localStorage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">LocalStorage</span>(<span class="hljs-variable">para</span>);</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'[GetPixMapFunc]'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span>(<span class="hljs-variable">localStorage</span>)</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainPage</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">childNavStack</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">NavPathStack</span>();</li><li>  @<span class="hljs-title function_">LocalStorageLink</span>(<span class="hljs-string">'imageData'</span>) <span class="hljs-variable">imageData</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>
</li><li>  <span class="hljs-title function_">getPixMap</span>() { <span class="hljs-comment">// Read files from the application sandbox</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span>: <span class="hljs-title class_">fs</span>.<span class="hljs-title class_">File</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">fileUrl</span>, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span>); <span class="hljs-comment">// Open the file in a synchronous manner</span></li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">InitializationOptions</span> = {</li><li>        <span class="hljs-string">'alphaType'</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// transparency</span></li><li>        <span class="hljs-string">'editable'</span>: <span class="hljs-keyword">false</span>, <span class="hljs-comment">// Editable or not</span></li><li>        <span class="hljs-string">'pixelFormat'</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// Pixel format</span></li><li>        <span class="hljs-string">'scaleMode'</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// Abbreviated value</span></li><li>        <span class="hljs-string">'size'</span>: { <span class="hljs-variable">height</span>: <span class="hljs-number">100</span>, <span class="hljs-variable">width</span>: <span class="hljs-number">100</span> }</li><li>      };</li><li>      <span class="hljs-variable">fs</span>.<span class="hljs-title function_">close</span>(<span class="hljs-variable">file</span>)</li><li>      <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">options</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">PixelMap</span>) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">imageData</span> = <span class="hljs-variable">pixelMap</span>;</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">e</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'Resource loading error, file or does not exist!'</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">httpRequest</span>(); <span class="hljs-comment">// Initiate a network request ahead of the parent component</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Navigation</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">childNavStack</span>) {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Button</span>(<span class="hljs-string">'push Path to pageOne'</span>, { <span class="hljs-variable">stateEffect</span>: <span class="hljs-keyword">true</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-title class_">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">bottom</span>: <span class="hljs-string">'36vp'</span> })</li><li>          .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>            <span class="hljs-comment">// Do not call getPixMap() repeatedly except for the first click to avoid reading files from the sandbox with each click.</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">localStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'imageData'</span>)) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getPixMap</span>();</li><li>            }</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">childNavStack</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-variable">name</span>: <span class="hljs-string">'pageOne'</span> });</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">End</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Transparent</span>)</li><li>    .<span class="hljs-title function_">title</span>(<span class="hljs-string">'ParentNavigation'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/MainPage.ets#L16-L83" target="_blank">MainPage.ets</a></div></div></div></div> </li><li>在NetRequest.ets中定义网络请求httpRequest()，通过fs.access()检查文件是否存在，当文件存在时不再重复请求，并写入沙箱中。<div class="screenLinkPre"><div _ngcontent-rkl-c106="" class="highlight-div"><div _ngcontent-rkl-c106="" class="highlight-div-header"><div _ngcontent-rkl-c106="" class="highlight-div-header-left"><div _ngcontent-rkl-c106="" class="handle-button expand-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rkl-c106="" class="highlight-div-header-right"><div _ngcontent-rkl-c106="" class="handle-button ai-button"></div><div _ngcontent-rkl-c106="" class="handle-button line-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rkl-c106="" class="handle-button theme-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rkl-c106="" class="handle-button copy-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/utils/NetRequest.ets#L16-L56" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">// Obtain the path of the application file</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'uiContext'</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = uiContext?.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">filesDir</span>: string = context.<span class="hljs-property">filesDir</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">fileUrl</span>: string = filesDir + <span class="hljs-string">'/xxx.png'</span>; <span class="hljs-comment">// The image's network address suffix needs to be replaced by the real url.</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">httpRequest</span>(<span class="hljs-params"></span>) {</li><li>  fs.<span class="hljs-title function_">access</span>(fileUrl, fs.<span class="hljs-property">AccessModeType</span>.<span class="hljs-property">READ</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> { <span class="hljs-comment">// Check whether files exist</span></li><li>    <span class="hljs-keyword">if</span> (!res) { <span class="hljs-comment">// If the address does not exist in the sandbox, re-request the network image resource</span></li><li>      http.<span class="hljs-title function_">createHttp</span>()</li><li>        <span class="hljs-comment">// Please fill in a specific network image address here, example: https://img.picui.cn/free/2024/09/09/66deb127cf1c0.png</span></li><li>        <span class="hljs-comment">// If you fill in the real address, you need to replace the global fileUrl with the real address suffix.</span></li><li>        .<span class="hljs-title function_">request</span>(<span class="hljs-string">'https://example.com/xxx.png'</span>,</li><li>          <span class="hljs-function">(<span class="hljs-params">error: BusinessError, data: http.HttpResponse</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (error) {</li><li>              <span class="hljs-comment">// If the download fails, no subsequent logic is executed</span></li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-comment">// Processing data returned by network requests</span></li><li>            <span class="hljs-keyword">if</span> (http.<span class="hljs-property">ResponseCode</span>.<span class="hljs-property">OK</span> === data.<span class="hljs-property">responseCode</span>) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-attr">imageData</span>: <span class="hljs-title class_">ArrayBuffer</span> = data.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>;</li><li>              <span class="hljs-comment">// Save the image to the app sandbox</span></li><li>              <span class="hljs-title function_">readWriteFileWithStream</span>(imageData);</li><li>            }</li><li>          }</li><li>        )</li><li>    }</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-comment">// Write to the sandbox</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readWriteFileWithStream</span>(<span class="hljs-params">imageData: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">outputStream</span>: fs.<span class="hljs-property">Stream</span> = fs.<span class="hljs-title function_">createStreamSync</span>(fileUrl, <span class="hljs-string">'w+'</span>);</li><li>  <span class="hljs-keyword">await</span> outputStream.<span class="hljs-title function_">write</span>(imageData);</li><li>  outputStream.<span class="hljs-title function_">closeSync</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/utils/NetRequest.ets#L16-L56" target="_blank">NetRequest.ets</a></div></div></div></div> </li><li>在子组件中通过在子页面的Image中传入被@StorageLink修饰的变量ImageData进行数据刷新，图片送显。<div class="screenLinkPre"><div _ngcontent-rkl-c106="" class="highlight-div"><div _ngcontent-rkl-c106="" class="highlight-div-header"><div _ngcontent-rkl-c106="" class="highlight-div-header-left"><div _ngcontent-rkl-c106="" class="handle-button expand-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rkl-c106="" class="highlight-div-header-right"><div _ngcontent-rkl-c106="" class="handle-button ai-button"></div><div _ngcontent-rkl-c106="" class="handle-button line-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rkl-c106="" class="handle-button theme-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rkl-c106="" class="handle-button copy-button"><div _ngcontent-rkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/PageOne.ets#L16-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Builder</span></li><li>export function PageOneBuilder() {</li><li>  <span class="hljs-built_in">PageOne</span>();</li><li>}</li><li>
</li><li><span class="hljs-keyword">@Component</span></li><li>export struct PageOne {</li><li>  pageInfo: NavPathStack = new <span class="hljs-built_in">NavPathStack</span>();</li><li>  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">name</span>: string = <span class="hljs-string">'pageOne'</span>;</li><li>  <span class="hljs-keyword">@LocalStorageLink</span>(<span class="hljs-string">'imageData'</span>) <span class="hljs-attribute">imageData</span>: PixelMap | undefined = undefined;</li><li>
</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">NavDestination</span>() {</li><li>      <span class="hljs-built_in">Row</span>() {</li><li>        <span class="hljs-comment">// Positive example: At this time, the Image has obtained the network image that has been loaded in advance,</span></li><li>        <span class="hljs-comment">// reducing the time for white blocks to appear.</span></li><li>        <span class="hljs-built_in">Image</span>(this.imageData)</li><li>          <span class="hljs-selector-class">.objectFit</span>(ImageFit.Auto)</li><li>          <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>          <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      }</li><li>      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)</li><li>    }</li><li>    <span class="hljs-selector-class">.title</span>(this.name)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/PreHttpRequestUseFiles/entry/src/main/ets/pages/PageOne.ets#L16-L43" target="_blank">PageOne.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section5101181020354">性能分析<i class="anchor-icon anchor-icon-link" anchorid="section5101181020354" tips="复制节点链接"></i></h2><p>下面使用trace对优化前后性能进行对比分析。</p> </div> <p>【优化前】</p> <p>分析阶段的起点为父页面点击按钮开始计时即trace的H:DispatchTouchEvent，结束点为子页面图片渲染的首帧出现即H:CreateImagePixelMap标签后的第一个Vsync，记录白块出现时间为1.3s，其中以H:HttpRequestInner的标签起始为起点到H:DownloadImageSuccess标签结束为终点记录时间，即为网络下载耗时1.2s，因此使用Image直接加载网络图片时，出现长时间Image白块，其原因是需要等待网络下载资源完成。</p> <div class="fignone"><span class="figcap"><b>图3 </b>直接使用Image加载网络数据</span><br><span><img height="216.4575" originheight="513" originwidth="1238" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163422.28366492471470118116315392852609:50001231000000:2800:FCF1A1DD0F05891D6F78743B09B56786759BA67C1910D6EB14A66AD79A594E9C.png" title="点击放大" width="523.6875"></span></div> <p>【优化后】</p> <p>分析阶段的起点为父页面点击按钮开始计时即trace的H:DispatchTouchEvent，结束点为子页面图片渲染的首帧出现即H:CreateImagePixelMap标签后的第一个Vsync，记录白块出现时间为32.6ms，其中记录H:HttpRequestInner的标签耗时即为提前网络下载的耗时1.16s，对比白块时长可知提前预下载可以减少白块出现时长。</p> <div class="fignone"><span class="figcap"><b>图4 </b>使用预下载的方式</span><br><span><img height="214.4625" originheight="545" originwidth="1328" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163422.61321767461113289680177439366190:50001231000000:2800:635AC04251ABCE0EA7EDEDB6E0B0EBFBB6BE710E66982E0FF898A102A165F047.png" title="点击放大" width="523.6875"></span></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>网络下载耗时实际受到网络波动影响，优化前后的网络下载耗时数据总体差异在1s内，提供的性能数值仅供参考。</p> </div></div></div> <div class="tiledSection"><h2 id="section194901143142512">效果对比<i class="anchor-icon anchor-icon-link" anchorid="section194901143142512" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.14.2.1.3.1.1" valign="top" width="54.75%"><p>（优化前）直接使用Image加载网络数据，未使用预下载</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.14.2.1.3.1.2" valign="top" width="45.25%"><p>（优化后）使用预下载</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="54.75%"><p></p> <p><span><img height="546.9226000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163423.74185108686485377387175689890359:50001231000000:2800:44B37445B744794F4D34C9C94E82C1070613745A4CA23E02614021AB136A8419.gif" title="点击放大" width="266"></span></p> </td> <td class="cellrowborder" valign="top" width="45.25%"><p></p> <p><span><img height="546.9226000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163423.59577101850475848013010565350234:50001231000000:2800:C8A45710FEE73469EE61E8E7125CFEBEB63C92889B3326C1531BB9AAED2931C4.gif" title="点击放大" width="266"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section18173193012339">性能对比<i class="anchor-icon anchor-icon-link" anchorid="section18173193012339" tips="复制节点链接"></i></h2><p>对比数据如下：</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.16.1.4.1.1" valign="top" width="43.669999999999995%"><p>方案</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.16.1.4.1.2" valign="top" width="20.4%"><p>白块出现时长(毫秒)</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.16.1.4.1.3" valign="top" width="35.93%"><p>白块出现时长</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="43.669999999999995%"><p>（优化前）直接使用Image加载网络数据，未使用预下载</p> </td> <td class="cellrowborder" valign="top" width="20.4%"><p>1300</p> </td> <td class="cellrowborder" valign="top" width="35.93%"><p>图片位置白块出现时间较长</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="43.669999999999995%"><p>（优化后）使用预下载</p> </td> <td class="cellrowborder" valign="top" width="20.4%"><p>32.6</p> </td> <td class="cellrowborder" valign="top" width="35.93%"><p>图片位置白块出现时间较短</p> </td> </tr>  </tbody></table></div> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1.测试数据仅限于示例程序，不同设备特性和具体应用场景的多样性，所获得的性能数据存在差异，提供的数值仅供参考。</p> <p>2.由于该方案仅将下载解码网络图片的步骤提前，不会影响内存等应用数据。开发者可自行管理解码后的PixelMap，主动实现图片的复用和缓存。</p> </div></div></div> <p>由此可见，加载网络图片时，使用预下载，提前处理网络请求并从应用沙箱中读取缓存数据的方式，可以减少用户可见Image白屏或白块出现时长，提升用户体验。</p> <div class="tiledSection"><h2 id="section19423911173814">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section19423911173814" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/PreHttpRequestUseFiles" target="_blank">Image白块解决问题指导</a></li></ul> </div> </div> <div></div></div>