<h1 _ngcontent-ler-c119="" class="doc-title ng-star-inserted" title="JS Crash类问题案例"> JS Crash类问题案例 </h1>

<div _ngcontent-ler-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文将基于当前开发者所遇到的高频的JS Crash故障进行案例介绍。开发者可阅读<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-runtime-crash-detection">应用崩溃类问题检测方法</a>了解系统检测JS Crash问题的原理和机制，阅读<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-crash-js-way" target="_blank">JS Crash类问题分析方法</a>了解分析JS Crash问题的一般步骤。</p> <div class="tiledSection"><h2 id="section845321710124">Cannot read property xxx of undefined类案例<i class="anchor-icon anchor-icon-link" anchorid="section845321710124" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1245532571218" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section1245532571218" tips="复制节点链接"></i></h3></div> <p>此类问题在实际应用开发调试运行过程中是常见的JS Crash类型，其表示为变量不是预期类型，在代码层面则为对变量的使用未进行事先的校验，在错误日志中报错多表现为如下：</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Error</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">TypeError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:<span class="hljs-title class_">Cannot</span> <span class="hljs-title class_">read</span> <span class="hljs-title class_">property</span> <span class="hljs-title class_">xxx</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">undefined</span></li></ol></pre></div></div> <div class="tiledSection"><h3 id="section83323531211">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section83323531211" tips="复制节点链接"></i></h3></div> <div class="p">更新手势跟踪相关属性时偶现JS Crash，获取JS Crash日志如下：<div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Generated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">HiviewDFX</span>@<span class="hljs-title function_">OpenHarmony</span></li><li>================================================================</li><li><span class="hljs-variable">Device</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxxx</span></li><li><span class="hljs-variable">Build</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxxx</span></li><li><span class="hljs-variable">Fingerprint</span>:<span class="hljs-number">9851196</span><span class="hljs-title class_">f9fed7fd818170303296ae7a5767c9ab11f38fd8b0072f0e32c42ea39</span></li><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Version</span>:<span class="hljs-number">1.0</span><span class="hljs-number">.0.29</span></li><li><span class="hljs-variable">VersionCode</span>:<span class="hljs-number">10000029</span></li><li><span class="hljs-variable">PreInstalled</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Foreground</span>:<span class="hljs-title class_">No</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">2780</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020018</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TypeError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">TypeError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:<span class="hljs-title class_">Cannot</span> <span class="hljs-title class_">read</span> <span class="hljs-title class_">property</span> <span class="hljs-title class_">needRenderTranslate</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">undefined</span></li><li><span class="hljs-variable">Stacktrace</span>:</li><li><span class="hljs-variable">Cannot</span> <span class="hljs-variable">get</span> <span class="hljs-variable">SourceMap</span> <span class="hljs-variable">info</span>, <span class="hljs-variable">dump</span> <span class="hljs-variable">raw</span> <span class="hljs-variable">stack</span>:</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">updateGestureValue</span> (<span class="hljs-variable">phone</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">SceneBoard</span>/<span class="hljs-variable">recent</span>/<span class="hljs-variable">scenepanel</span>/<span class="hljs-variable">recentpanel</span>/<span class="hljs-variable">RecentGesture</span>.<span class="hljs-variable">ts</span>:<span class="hljs-number">51</span>:<span class="hljs-number">51</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">onRecentGestureActionBegin</span> (<span class="hljs-variable">phone</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">SceneBoard</span>/<span class="hljs-variable">scenemanager</span>/<span class="hljs-variable">SCBScenePanel</span>.<span class="hljs-variable">ts</span>:<span class="hljs-number">5609</span>:<span class="hljs-number">5609</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">anonymous</span> (<span class="hljs-variable">phone</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">SceneBoard</span>/<span class="hljs-variable">scenemanager</span>/<span class="hljs-variable">SCBScenePanel</span>.<span class="hljs-variable">ts</span>:<span class="hljs-number">555</span>:<span class="hljs-number">555</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">anonymous</span> (<span class="hljs-variable">phone</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">SceneBoard</span>/<span class="hljs-variable">recent</span>/<span class="hljs-variable">RecentEventView</span>.<span class="hljs-variable">ts</span>:<span class="hljs-number">183</span>:<span class="hljs-number">183</span>)</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section4780135751213">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section4780135751213" tips="复制节点链接"></i></h3></div> <ol><li>提取日志关键信息<ol><li>通过日志信息可以确定为Type Error类问题，由异常信息得知是在读取needRenderTranslate对象时报错，该对象为undefined。</li><li>可以通过异常代码调用栈，获取错误产生位置。</li><li>Cannot get SourceMap info, dump raw stack 信息表示该应用为release包安装，JS栈转换eTS行列号失败，可考虑使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-release-app-stack-analysis" target="_blank">堆栈轨迹分析</a>来解析行号。</li></ol> </li><li>定位到具体代码<p>通过以上 JS 堆栈和报错变量分析，能够定位到具体函数示例如下：</p> <div class="screenLinkPre"><div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse1.ets#L27-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Update the attributes related to manual effects</span></li><li><span class="hljs-keyword">public</span> updateGestureValue(screenWidth: number, recentScale: number, sceneContainerSessionList: SCBSceneContainerSession[]) {</li><li>  <span class="hljs-comment">// Calculation of the distance moved by the hand</span></li><li>  <span class="hljs-keyword">this</span>.translationUpY = (<span class="hljs-keyword">this</span>.multiCardsNum &gt;= <span class="hljs-number">1</span>) ? sceneContainerSessionList[<span class="hljs-keyword">this</span>.multiCardsNum - <span class="hljs-number">1</span>].needRenderTranslate.translateY : <span class="hljs-number">0</span>;    <span class="hljs-comment">// Report an incorrect line number</span></li><li>  <span class="hljs-keyword">this</span>.translationDownY = (<span class="hljs-keyword">this</span>.multiCardsNum &gt;= <span class="hljs-number">2</span>) ? sceneContainerSessionList[<span class="hljs-keyword">this</span>.multiCardsNum - <span class="hljs-number">2</span>].needRenderTranslate.translateY : <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">this</span>.screenWidth = <span class="hljs-keyword">this</span>.getUIContext().px2vp(screenWidth);</li><li>  <span class="hljs-keyword">this</span>.recentScale = recentScale;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse1.ets#L27-L34" target="_blank">JSCrashCaseAnalyse1.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section112781730141312">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section112781730141312" tips="复制节点链接"></i></h3><p>上述分析已经明确为sceneContainerSessionList的成员变量needRenderTranslate在使用的过程中可能存在为undefined的情况。对于这类问题，增加保护性判断可直接规避。具体修改方法可以如下，在访问对象前增加“?”操作符进行判断保护。</p> <div class="screenLinkPre"><div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse2.ets#L27-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Update the attributes related to manual effects</span></li><li><span class="hljs-keyword">public</span> updateGestureValue(screenWidth: number, recentScale: number, sceneContainerSessionList: SCBSceneContainerSession[]) {</li><li>  <span class="hljs-comment">// Calculation of the distance moved by the hand</span></li><li>  <span class="hljs-keyword">this</span>.translationUpY = (<span class="hljs-keyword">this</span>.multiCardsNum &gt;= <span class="hljs-number">1</span>) ?</li><li>  sceneContainerSessionList[<span class="hljs-keyword">this</span>.multiCardsNum - <span class="hljs-number">1</span>]?.needRenderTranslate.translateY : <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">this</span>.translationDownY = (<span class="hljs-keyword">this</span>.multiCardsNum &gt;= <span class="hljs-number">2</span>) ?</li><li>  sceneContainerSessionList[<span class="hljs-keyword">this</span>.multiCardsNum - <span class="hljs-number">2</span>]?.needRenderTranslate.translateY : <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">this</span>.screenWidth = <span class="hljs-keyword">this</span>.getUIContext().px2vp(screenWidth);</li><li>  <span class="hljs-keyword">this</span>.recentScale = recentScale;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse2.ets#L27-L36" target="_blank">JSCrashCaseAnalyse2.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section43071843111314">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section43071843111314" tips="复制节点链接"></i></h3><p>对于这类问题，需要开发者在编码阶段充分考虑对象访问的安全性，确保必要的判空处理。同时很多场景单纯的判空可能只能是规避问题，还需要结合业务看看是否是原始对象构造或赋值的逻辑存在问题。</p> </div> <div class="tiledSection"><h2 id="section772320178289">XXX is not callable类案例<i class="anchor-icon anchor-icon-link" anchorid="section772320178289" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1972412179282" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section1972412179282" tips="复制节点链接"></i></h3><p>这个错误表示应用代码试图像调用函数一样去调用某个对象，但该对象不可被调用（不是一个函数或方法），xxx表示把不可被调用对象的值打印出来。</p> <ul><li>误将变量名用作函数名：可能将一个非函数的变量名当作函数来调用。</li><li>对象方法不存在或未正确引用：尝试调用对象上不存在的方法，或者方法的引用方式不正确。</li></ul> </div> <div class="tiledSection"><h3 id="section17724117142816">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section17724117142816" tips="复制节点链接"></i></h3><p>运行程序时出现JS Crash，获取JS Crash日志如下：</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Device</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Build</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Fingerprint</span>:<span class="hljs-number">654897</span><span class="hljs-title class_">efdb96b3520481880c8ed746cb2e76916639456c47a8513a3575b3424b</span></li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">myapplication</span></li><li><span class="hljs-variable">Version</span>:<span class="hljs-number">1.0</span><span class="hljs-number">.0</span></li><li><span class="hljs-variable">VersionCode</span>:<span class="hljs-number">1000000</span></li><li><span class="hljs-variable">PreInstalled</span>:<span class="hljs-title class_">No</span></li><li><span class="hljs-variable">Foreground</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">50237</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020199</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-title function_">Memory</span>(<span class="hljs-variable">kB</span>): <span class="hljs-number">126783</span>(<span class="hljs-title class_">Rss</span>)</li><li><span class="hljs-variable">Device</span> <span class="hljs-title function_">Memory</span>(<span class="hljs-variable">kB</span>): <span class="hljs-title class_">Total</span> <span class="hljs-number">11679172</span>, <span class="hljs-variable">Free</span> <span class="hljs-number">414280</span>, <span class="hljs-variable">Available</span> <span class="hljs-number">4485120</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TypeError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">TypeError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:<span class="hljs-title class_">undefined</span> <span class="hljs-keyword">is</span> <span class="hljs-title class_">not</span> <span class="hljs-title class_">callable</span></li><li><span class="hljs-variable">Stacktrace</span>:</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">b</span> <span class="hljs-variable">entry</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">test</span>.<span class="hljs-variable">js</span>:<span class="hljs-number">18</span>:<span class="hljs-number">5</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">test1</span> <span class="hljs-variable">entry</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">test</span>.<span class="hljs-variable">js</span>:<span class="hljs-number">15</span>:<span class="hljs-number">5</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">anonymous</span> <span class="hljs-variable">entry</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">Index</span>.<span class="hljs-variable">ets</span>:<span class="hljs-number">18</span>:<span class="hljs-number">11</span>)</li><li><span class="hljs-variable">HiLog</span>:</li><li>...</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section15441161615398">分析过程<i class="anchor-icon anchor-icon-link" anchorid="section15441161615398" tips="复制节点链接"></i></h3><p>该问题主要场景：</p> <ul><li>类被混淆了，开发者调用对应的方法报出的问题。（混淆导致的方法不存在）</li><li>开发者调用的对象出现了非预期的值或者该对象无相关方法，例如number没有trim方法。</li><li>开发者自定义的napi，so未加载，调用对应方法不存在而报错。</li></ul> <p>报错场景示例：</p> <ol><li>入参无类型判断<div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">a</span>) {</li><li>    a.<span class="hljs-title function_">trim</span>(); <span class="hljs-comment">// 报错undefined is not callable;</span></li><li>}</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">c</span>(<span class="hljs-params"></span>){</li><li>    <span class="hljs-keyword">let</span> a = <span class="hljs-number">123</span>;</li><li>    <span class="hljs-title function_">b</span>(a);</li><li>}</li></ol></pre></div></div> <p>原因分析：入参是number类型，number类型无trim函数。</p> </li><li>错误的对象类型<div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> a = <span class="hljs-number">123</span>;</li><li>a();  <span class="hljs-comment">// 123 is not callable</span></li></ol></pre></div></div> <p>原因分析：number类型不是一个函数或方法。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section137241517112813">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section137241517112813" tips="复制节点链接"></i></h3><ul><li>检查错误位置：查看错误堆栈确定哪一行代码触发了错误。(如果开启混淆功能下的代码压缩功能需先还原报错代码栈具体操作可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V14/source-obfuscation-V14#报错栈还原" target="_blank">报错栈还原</a>)。</li><li>检查对象类型：使用typeof操作符来检测数据类型。</li><li>设置参数默认值：为参数设置空字符串默认值，确保始终有字符串可供操作。</li></ul> </div> <div class="tiledSection"><h2 id="section18728957192015">taskpool：failed toserialize result类问题案例<i class="anchor-icon anchor-icon-link" anchorid="section18728957192015" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2578924192118" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section2578924192118" tips="复制节点链接"></i></h3></div> <p>taskpool执行任务失败，返回了序列化失败的异常信息。产生该问题的原因是任务返回的结果序列化失败，是不可序列化的类型。</p> <div class="tiledSection"><h3 id="section10367163672110">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section10367163672110" tips="复制节点链接"></i></h3></div> <p>taskpool执行任务失败，catch中捕获的异常信息为：An exception occurred during serialization, taskpool: failed to serialize result。</p> <p><span><img height="611.0266527069026" originheight="1062" originwidth="1599" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.77984178785897746438511753496972:50001231000000:2800:3181DC51EA1270B1E721C0D05A4BB183861860F8E80DA1BA12BE363B6395D720.png" title="点击放大" width="920"></span></p> <div class="tiledSection"><h3 id="section456719468211">问题代码<i class="anchor-icon anchor-icon-link" anchorid="section456719468211" tips="复制节点链接"></i></h3></div> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// utils.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printArgs</span>(<span class="hljs-params">args: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">return</span> args</li><li>}</li><li>
</li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">creatTask</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> sum = a+b;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>:taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(printArgs, sum);</li><li>  <span class="hljs-keyword">return</span> task;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">resultError</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(creatTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>{</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e:BusinessError</span>)=&gt;</span>{</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"resultError task catch message:"</span>+e.<span class="hljs-property">message</span>)</li><li>  })</li><li>}</li></ol></pre></div></div> <div class="tiledSection"><h3 id="section15789754142117">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section15789754142117" tips="复制节点链接"></i></h3></div> <p>在catch到的信息里，前一段信息里有“during serialization”这样的信息，这就表明了这是因为序列化失败导致的。后一段是“failed to serialize result”，表明这个是结果返回时候的序列化失败，需要看下返回的结果是什么类型。目前taskpool只支持的类型参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#序列化支持类型" target="_blank">序列化支持类型</a>。</p> <div class="tiledSection"><h3 id="section10890131916221">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section10890131916221" tips="复制节点链接"></i></h3></div> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// utils.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printArgs</span>(<span class="hljs-params">args: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">return</span> args</li><li>}</li><li>
</li><li><span class="hljs-comment">// Index.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">creatTask</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> sum = a+b;</li><li>  <span class="hljs-keyword">return</span> sum;</li><li>}</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">resultError</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(creatTask, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</li><li>  taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>{</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">task2</span>:taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(printArgs, res);</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"resultError task success"</span>)</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e:BusinessError</span>)=&gt;</span>{</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"resultError task catch message:"</span>+e.<span class="hljs-property">message</span>)</li><li>  })</li><li>}</li></ol></pre></div></div> <p>如代码所示，新的task构造在then中执行，task里返回的结果设置为能够正常序列化的类型。</p> <p><span><img height="723.9465946734315" originheight="1237" originwidth="1572" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.01473958045141806502377078198861:50001231000000:2800:E4E87F419C94DFFF15F5F51FD633E7D6CDE0EEF46145C61A3128BA880A9AD046.png" title="点击放大" width="920"></span></p> <div class="tiledSection"><h3 id="section1465013116226">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section1465013116226" tips="复制节点链接"></i></h3></div> <p>由于TaskPool在进行数据传送过程中，会对传递的参数和返回的结果进行序列化与反序列化的操作，因此对于这些数据类型的设置需严格，以避免异常问题的发生。</p> <div class="tiledSection"><h2 id="section147181171915">XXX is not initialized 类问题案例<i class="anchor-icon anchor-icon-link" anchorid="section147181171915" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section080231514193" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section080231514193" tips="复制节点链接"></i></h3></div> <p>报错信息解释：模块间循环依赖导致运行时未初始化。</p> <p><span><img height="278.2208554728218" originheight="597" originwidth="1974" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.46934400504220095457626268225422:50001231000000:2800:DB6449383FA1BDAA6440C3D0CA6305CA944F34141AD3872FFD3966438CAD30B9.png" title="点击放大" width="920"></span></p> <p>报错xxx is not initialized不一定是循环依赖问题，需要通过hdc命令打开循环依赖检测开关进一步确认，无需重启设备。命令如下：</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>开启：hdc shell param <span class="hljs-built_in">set</span> persist.ark.properties 0x2000105c</li><li>关闭：hdc shell param <span class="hljs-built_in">set</span> persist.ark.properties 0x0000105c</li></ol></pre></div></div> <p>开关打开后复现报错就是第一现场报错，解决即可。如果报错仍是xxx is not initialized，就是文件存在循环依赖。</p> <p>循环依赖原理：</p> <ul><li>模块加载顺序：根据ECMA规范，模块的执行顺序是深度遍历加载。假设应用存在加载链路A-&gt;B-&gt;C，那么ArkTs模块化会先执行C文件，再执行B文件，最后执行A文件，执行顺序为C-&gt;B-&gt;A。</li><li>循环依赖：如果应用存在加载链路A-&gt;B-&gt;A，根据深度遍历执行顺序，执行流程会先标记A的状态为加载中，然后去加载B，标记B的状态为加载中，然后去加载A，由于A文件已经标记加载中，根据规范定义，识别到加载中模块会直接返回，就会先执行B文件。</li></ul> <p>部分循环依赖会产生crash的原因：</p> <p>由上面的叙述可知，B文件虽然依赖A文件变量，但是B文件先执行，如果B文件导入的A文件变量没有在全局或者静态类中被使用，B文件就会正常执行。如果B文件变量在全局或者静态类中被使用，导致文件执行时就会用到A的变量，就会产生xxx is not initialized的crash，即循环依赖导致变量未被初始化。</p> <div class="tiledSection"><h3 id="section11988123172011">问题代码<i class="anchor-icon anchor-icon-link" anchorid="section11988123172011" tips="复制节点链接"></i></h3><p>反例：</p> </div> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// A.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Animal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./B'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> a = <span class="hljs-string">"this is A"</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// B.ets</span></li><li><span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./A'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {</li><li>  <span class="hljs-keyword">static</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this is in class"</span>);</li><li>    <span class="hljs-keyword">let</span> str = a; <span class="hljs-comment">// 报错信息：a is not initialized</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p>正例:</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// B.ets</span></li><li><span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./A'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {</li><li>  <span class="hljs-keyword">static</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this is in class"</span>);</li><li>  }</li><li>  str = a;  <span class="hljs-comment">// 修改点</span></li><li>}</li></ol></pre></div></div> <p>模块间循环依赖 - const/let</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// module1.ets</span></li><li><span class="hljs-keyword">import</span> { a, b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module2'</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> m = a;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> j = <span class="hljs-number">2</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> n = b;</li><li>
</li><li><span class="hljs-comment">// module2.ets</span></li><li><span class="hljs-keyword">import</span> { i, j } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module1'</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> a = i; <span class="hljs-comment">// 报错信息：Error message:i is not initialized</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = j; <span class="hljs-comment">// 报错信息：Error message:j is not initialized</span></li></ol></pre></div></div> <p>模块间循环依赖 - class</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// class1.ets</span></li><li><span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./class2'</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {</li><li>  <span class="hljs-keyword">static</span> a = b;</li><li>}</li><li>
</li><li><span class="hljs-comment">// class2.ets</span></li><li><span class="hljs-keyword">import</span> { A } <span class="hljs-keyword">from</span> <span class="hljs-string">'./class1'</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> b = <span class="hljs-number">1</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> i = A.<span class="hljs-property">a</span>; <span class="hljs-comment">// 报错信息：Error message:A is not initialized</span></li><li><span class="hljs-keyword">const</span> j = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>(); <span class="hljs-comment">// 报错信息：Error message:A is not initialized</span></li></ol></pre></div></div> <div class="tiledSection"><h3 id="section64621843142010">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section64621843142010" tips="复制节点链接"></i></h3></div> <p>循环依赖的检测方法：安全规则<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide_no-cycle" target="_blank">@security/no-cycle</a>。</p> <div class="tiledSection"><h2 id="section2729126191411">Error类案例<i class="anchor-icon anchor-icon-link" anchorid="section2729126191411" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1945161518148" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section1945161518148" tips="复制节点链接"></i></h3></div> <p>Error 类问题一般是开发者或JS库主动抛出来的JS异常。</p> <p>这类问题目前有两种场景：</p> <ol><li>应用程序遇到无法解决的故障，需要考虑抛出JS异常来终止业务并生成故障日志。</li><li>依赖使用JS库或者其他模块的接口，若可能抛出异常，需要考虑使用try-catch机制进行捕获，否则会终止当前业务。</li></ol> <div class="tiledSection"><h3 id="section196134041413">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section196134041413" tips="复制节点链接"></i></h3></div> <p>开发者自主抛出JS异常，可通过如下代码实现：</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 生产环境应使用加密的错误代码而非明文描述</span></li><li><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"TEST JS ERROR"</span>) </li></ol></pre></div></div> <p>通过DevEco Studio的FaultLog工具可收集到此类异常日志，其中JS异常栈信息可直接定位到抛异常的代码位置。</p> <p><span><img originheight="913" originwidth="1068" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.32536977048784218196723603589918:50001231000000:2800:823FA2580671F5CEAD4EA89A1FFE6740FF4A85429C8E6700BDB36A5E23904727.png" width="920" height="786.4794007490636"></span></p> <p>这类问题可通过故障日志定位到具体的代码行，检视上下文来分析问题即可。</p> <p><strong>因未处理三方接口抛出的JS异常导致的JS Crash问题</strong></p> <div class="p">获取JS Crash日志核心内容如下<div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">Error</span> <span class="hljs-selector-tag">name</span>:<span class="hljs-selector-tag">Error</span></li><li><span class="hljs-selector-tag">Error</span> <span class="hljs-selector-tag">message</span>:<span class="hljs-selector-tag">BusinessError</span>  <span class="hljs-number">2501000</span>: <span class="hljs-selector-tag">Operation</span> <span class="hljs-selector-tag">failed</span>.</li><li><span class="hljs-selector-tag">Error</span> <span class="hljs-selector-tag">code</span>:<span class="hljs-number">2501000</span></li><li><span class="hljs-selector-tag">Stacktrace</span>:</li><li><span class="hljs-selector-tag">Cannot</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">SourceMap</span> <span class="hljs-selector-tag">info</span>, <span class="hljs-selector-tag">dump</span> <span class="hljs-selector-tag">raw</span> <span class="hljs-selector-tag">stack</span>:</li><li>  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">onStart</span> (product/phone/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/feature/systemstatus/linkspeedcomponent/src/main/ets/default/controller/NetSpeedController.<span class="hljs-attribute">ts</span>:<span class="hljs-number">50</span>:<span class="hljs-number">1</span>)</li><li>  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">NetSpeedController</span> (product/phone/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/feature/systemstatus/linkspeedcomponent/src/main/ets/default/controller/NetSpeedController.<span class="hljs-attribute">ts</span>:<span class="hljs-number">43</span>:<span class="hljs-number">43</span>)</li><li>  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">getInstance</span> (product/phone/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/staticcommon/basiccommon/src/main/ets/component/utils/SingletonHelper.<span class="hljs-attribute">ts</span>:<span class="hljs-number">17</span>:<span class="hljs-number">17</span>)</li><li>  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">func_main_0</span> (product/phone/build/default/cache/default/default<span class="hljs-variable">@CompileArkTS</span>/esmodule/release/feature/systemstatus/linkspeedcomponent/src/main/ets/default/controller/NetSpeedController.<span class="hljs-attribute">ts</span>:<span class="hljs-number">325</span>:<span class="hljs-number">325</span>)</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section86877327155">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section86877327155" tips="复制节点链接"></i></h3></div> <ol><li>提取日志关键信息<p>通过日志信息可以确定为Error类问题，为代码主动抛出的异常。可以通过异常代码调用栈，获取错误产生位置。Cannot get SourceMap info, dump raw stack信息表示该应用为release包安装，JS栈转换eTS行列号失败，可考虑使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-release-app-stack-analysis" target="_blank">堆栈轨迹分析</a>来解析行号。</p> </li><li>定位到具体代码<p>通过以上 JS 堆栈，能够定位到NetSpeedController.ts文件中具体代码片段如下，异常抛出位置为wifiManager.on函数调用。</p> <div class="screenLinkPre"><div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse4.ets#L19-L32" data-highlighted="yes"><ol class="linenums"><li>onStart(): void {</li><li>  <span class="hljs-keyword">super</span>.onStart();</li><li>  log.showInfo(<span class="hljs-string">'onStart'</span>);</li><li>
</li><li>  wifiManager.on(<span class="hljs-string">'wifiConnectionChange'</span>, (<span class="hljs-keyword">data</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-keyword">data</span> === <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.handleUpdateState();</li><li>  });</li><li>  wifiManager.on(<span class="hljs-string">'wifiStateChange'</span>, (<span class="hljs-keyword">data</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.isWifiActive = <span class="hljs-keyword">data</span> === <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.handleUpdateState();</li><li>  });</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse4.ets#L19-L32" target="_blank">JSCrashCaseAnalyse4.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section12715194218157">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section12715194218157" tips="复制节点链接"></i></h3><p>通过分析wifiManager.on源码，得知该函数内存在部分场景会抛出内容为BusinessError 2501000: Operation failed.的JS异常，识别此类异常不会导致程序无法运行下去，考虑使用try-catch机制对异常进行捕获处理。具体的修改方法可参考如下:</p> <div class="screenLinkPre"><div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse5.ets#L19-L40" data-highlighted="yes"><ol class="linenums"><li>onStart(): void {</li><li>  <span class="hljs-keyword">super</span>.onStart();</li><li>  log.showInfo(<span class="hljs-string">'onStart'</span>);</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    wifiManager.on(<span class="hljs-string">'wifiConnectionChange'</span>, (<span class="hljs-keyword">data</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.isConnected = <span class="hljs-keyword">data</span> === <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">this</span>.handleUpdateState();</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    log.showError(<span class="hljs-string">'wifiConnectionChange error'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    wifiManager.on(<span class="hljs-string">'wifiStateChange'</span>, (<span class="hljs-keyword">data</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.isWifiActive = <span class="hljs-keyword">data</span> === <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">this</span>.handleUpdateState();</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    log.showError(<span class="hljs-string">'wifiStateChange error'</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/JSCrash/entry/src/main/ets/pages/JSCrashCaseAnalyse5.ets#L19-L40" target="_blank">JSCrashCaseAnalyse5.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section1773205613154">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section1773205613154" tips="复制节点链接"></i></h3><p>对于这类问题，可以考虑在编码阶段灵活地运用 JS 异常机制去识别各类异常场景；同时，使用可能会抛异常的接口时，也需要考虑是否需要捕获该异常，避免影响应用主体业务。</p> </div> <div class="tiledSection"><h2 id="section779814339364">OutOfMemoryError类案例<i class="anchor-icon anchor-icon-link" anchorid="section779814339364" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section16031440173719" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section16031440173719" tips="复制节点链接"></i></h3><p>OutOfMemoryError类问题一般是由于程序在运行过程中，因申请的ArkTS内存超过运行时环境可分配的内存限制，导致内存分配失败而触发的错误。</p> </div> <div class="tiledSection"><h3 id="section1421726133819">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section1421726133819" tips="复制节点链接"></i></h3><p>用户在使用应用过程中，偶现程序崩溃或卡顿现象，获取崩溃日志可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jscrash-guidelines#日志获取" target="_blank">日志获取</a>。</p> <p>ArkTS/JS代码未处理异常会生成JS Crash日志，检测方法详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/jscrash-guidelines" target="_blank">JS Crash（进程崩溃）检测</a>。</p> <p>Error name:OutOfMemoryError字段代表应用存在内存泄漏的场景，对应的崩溃堆栈如下：</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Device</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Build</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Fingerprint</span>:<span class="hljs-number">873</span><span class="hljs-title class_">b2d78dbf1c413e983bae646887824217f21ad45746f8cd70beafc8212c482</span></li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">oom</span></li><li><span class="hljs-variable">Version</span>:<span class="hljs-number">1.0</span><span class="hljs-number">.0</span></li><li><span class="hljs-variable">VersionCode</span>:<span class="hljs-number">1000000</span></li><li><span class="hljs-variable">PreInstalled</span>:<span class="hljs-title class_">No</span></li><li><span class="hljs-variable">Foreground</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">20168</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020198</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-title function_">Memory</span>(<span class="hljs-variable">kB</span>): <span class="hljs-number">663416</span>(<span class="hljs-title class_">Rss</span>)</li><li><span class="hljs-variable">Device</span> <span class="hljs-title function_">Memory</span>(<span class="hljs-variable">kB</span>): <span class="hljs-title class_">Total</span> <span class="hljs-number">11679260</span>, <span class="hljs-variable">Free</span> <span class="hljs-number">898896</span>, <span class="hljs-variable">Available</span> <span class="hljs-number">5358592</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">OutOfMemoryError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">OutOfMemoryError</span></li><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:<span class="hljs-title class_">OutOfMemory</span> <span class="hljs-title class_">when</span> <span class="hljs-title class_">trying</span> <span class="hljs-title class_">to</span> <span class="hljs-title class_">allocate</span> <span class="hljs-number">40</span> <span class="hljs-title class_">bytes</span> <span class="hljs-title class_">function</span> <span class="hljs-title class_">name</span>: <span class="hljs-title class_">SharedHeap</span>::<span class="hljs-title class_">AllocateOldOrHugeObject</span> </li><li><span class="hljs-variable">Stacktrace</span>:</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">testGenStringOOM</span> <span class="hljs-variable">entry</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">Index</span>.<span class="hljs-variable">ets</span>:<span class="hljs-number">39</span>:<span class="hljs-number">15</span>)</li><li>    <span class="hljs-variable">at</span> <span class="hljs-variable">anonymous</span> <span class="hljs-variable">entry</span> (<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">ets</span>/<span class="hljs-variable">pages</span>/<span class="hljs-variable">Index</span>.<span class="hljs-variable">ets</span>:<span class="hljs-number">21</span>:<span class="hljs-number">13</span>)</li><li>
</li><li><span class="hljs-variable">HiLog</span>:</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section16266163944510">分析过程<i class="anchor-icon anchor-icon-link" anchorid="section16266163944510" tips="复制节点链接"></i></h3></div> <p>常规的JsCrash日志通过其清晰的调用堆栈，能够精准地指引定位到引发异常的根源代码。相比之下，OutOfMemory异常则不同，其相关的JsCrash日志往往是内存问题长期积累后的最终表现，而非一个直接的触发点。因此，JsCrash日志通常无法提供立竿见影的诊断价值，需要借助snapshot内存占用分析工具来进行根本原因分析。</p> <p>从上文JsCrash日志中可以看到：应用名、pid、报错信息、调用栈等，其中有参考意义的主要是报错信息，这个报错信息中能告诉报错原因，这个crash是因为oldSpace+hugeSpace的和到达了上限，这时候尝试再往space中分内存就发生了OOM。</p> <p>调用栈的参考意义不大，调用栈只说明了分内存，如果到达上限，分1个字节的内存也会OOM，所以一般情况下调用栈可以忽略。</p> <p>特殊情况：就是有些应用高频的发生OOM，而且每次的crash文件的调用栈都一样，那说明这个调用栈可能是个高频调用，而且有泄露，最终导致了OOM，这种情况才有查看调用链的价值，其它情况只需要分析heapsnapshot文件即可。</p> <p>下面介绍两种形态如何分析：</p> <ol><li>开发态Snapshot内存占用分析<p>在开发态存在泄露场景，可使用DevEco Studio的Snapshot功能，不操作应用录制一次快照，重复操作应用录制5次快照，将两次的快照进行对比，操作步骤参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-snapshot-basic-operations" target="_blank">Snapshot模板基本操作</a>。</p> </li><li>运维态OOM内存占用分析<p>现网：</p> <p>首先需要订阅资源泄漏事件,使用说明可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events-arkts" target="_blank">订阅资源泄漏事件（ArkTS）</a>。</p> <p>当应用在ArkTS中遇到内存OOM时，系统会自动执行Heapdump，生成rawheap文件。rawheap的获取方法可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/rawheap-translator" target="_blank">rawheap-translator工具</a>。</p> <p>本地：</p> <ul><li>ArkTs内存管理方式和GC的时机</li></ul> <p>首先要明确方舟虚拟机是如何管理ArkTs内存，并且在什么时候进行GC的。</p> <p>在方舟虚拟机采用的是标记清除法回收内存，内存是通过维护一棵树来管理的，这颗树的根节点被称为GC Root，ArkTs对象只要被挂载到这颗树上则说明该对象存活。很多刚接触内存的同学可能会对GC Root产生误解，认为挂在GC Root上的对象是需要被回收的，而根节点之所以叫GC Root是因为标记清楚法在标记阶段，垃圾收集器从GC Root开始遍历。所有从GC Root可达的对象都会被标记为“存活”。在清除阶段，垃圾收集器会扫描内存中的所有对象。如果某个对象没有在标记阶段被标记为存活，那么该对象就是“垃圾”，可以被回收。垃圾收集器会释放这些未标记对象所占用的内存空间。每次GC都是从根节点开始，所以根节点被称为GC Root。该树的快照如图所示：</p> <p><span><img originheight="535" originwidth="818" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.75774926590913118171052462262061:50001231000000:2800:A01987265B7F58412AE32380831F0877DB20EEABB8A166C46FB79F72467869DA.png" width="818" height="535"></span></p> <p>ArkTs的对象是存在引用和被引用关系的，图中箭头指向的都是被引用对象，所有存活的对象都直接或间接被GC Root所引用，从GC Root到被引用对象的路径为该对象的引用链。因此，解决内存泄漏的关键就是在于将对象的引用链在合适的地方（结合业务判断）断开。</p> <ul><li>如下图，distance为1的时候为js_proxy，没有被具体的应用的jsobject对象持有，下面就介绍下这些对象如何分析。</li></ul> <p><span><img height="196.9944634525661" originheight="397" originwidth="1854" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.10745478337778471209290580564751:50001231000000:2800:8495FF09F6E41670DE929D156A22A814EB32EE6849FB086D1795FB874F7D8203.png" title="点击放大" width="920"></span></p> </li></ol> <p><strong>场景构造：</strong></p> <p>当distance为1时为基本类型，在应用代码中将该基本类型传递到native中，最终被native持有，导致该JS对象未被释放。可以参照下面的代码，原理很简单，构造一个proxy代理，传递到native中，使其发生泄露。</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.page_text_font_size'</span>))</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Welcome'</span>;</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));</li><li>            <span class="hljs-keyword">let</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();</li><li>            <span class="hljs-keyword">let</span> proxy11  = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(testYY, obj);</li><li>            testNapi.<span class="hljs-title class_">TestLeak</span>(proxy11);</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testYY</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"test leak"</span>);</li><li>}</li></ol></pre></div></div> <p>下面再看native的代码，调用napi_create_reference创建对js传过来的proxy的引用，使其无法释放。</p> <div _ngcontent-ler-c106="" class="highlight-div"><div _ngcontent-ler-c106="" class="highlight-div-header"><div _ngcontent-ler-c106="" class="highlight-div-header-left"><div _ngcontent-ler-c106="" class="handle-button expand-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ler-c106="" class="highlight-div-header-right"><div _ngcontent-ler-c106="" class="handle-button ai-button"></div><div _ngcontent-ler-c106="" class="handle-button line-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ler-c106="" class="handle-button theme-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ler-c106="" class="handle-button copy-button"><div _ngcontent-ler-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ler-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TestLeak</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    napi_value proxy = args[<span class="hljs-number">0</span>];</li><li>    napi_ref task_ref;</li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, proxy, <span class="hljs-number">1</span>, &amp;task_ref);</li><li>    <span class="hljs-comment">// 由于未调用napi_delete_reference发生内存泄漏</span></li><li>    <span class="hljs-comment">// napi_delete_reference(env, task_ref-&gt;ref);</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>场景测试：</strong></p> <p>demo构造完成后，下面进行堆快照测试，在不点击前拍摄一个堆快照，点击7次后再拍摄一个堆快照，然后对比看下：</p> <p><span><img height="342.6708711897738" originheight="818" originwidth="2196" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.36897221454379897232632010775969:50001231000000:2800:FF5067FBF21662676EE86CFE7EAECABEB55F8D638BD676D12511DF38477A5F23.png" title="点击放大" width="920"></span></p> <p>通过快照能看见Proxy发生了泄露，这时需要寻找与这个Proxy相关的属性，可以展开它的field，可以看到它的target是一个叫testYY的function，它的handle是一个JSObject。通过这两个属性，就可以结合应用代码分析这个Proxy在哪创建的，在哪传入native的，再分析native的函数哪里存在内存泄漏。</p> <p><span><img height="532.1159807877043" originheight="1269" originwidth="2194" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.87201340030507190746988493856368:50001231000000:2800:B86AAEC8155337794408E5ADBC65A20A4F74A0C4BA422A47BE6CBEFDE850C280.png" title="点击放大" width="920"></span></p> <p>下面查看testYY的引用链，testYY被Proxy持有，这与背景中的引用链相符，只是该引用链较长，未在testYY中调用其他方法。</p> <p><span><img height="294.1212121212121" originheight="704" originwidth="2202" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.51462746841324457788637855143894:50001231000000:2800:48BC5B47F1645F27C66E70454D4710F3B7093718E96CE69765BE867480679248.png" title="点击放大" width="920"></span></p> <p>当distance为1时是一个基本类型，这种情况必定是将该基本类型传入native导致被native持有无法释放。获取JS传过来的参数，创建引用后，proxy发生泄露。原因是未调用napi_delete_reference；如果不调用，系统会认为该对象（proxy）始终处于被引用状态，因此不会释放。</p> <p><span><img originheight="273" originwidth="541" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163457.23111559678628239254536409360797:50001231000000:2800:88EA8FA2365039B584B10236D587A7075D3C48AB5C8D51E7986792D1903FC30B.png" width="541" height="273"></span></p> <div class="tiledSection"><h3 id="section134095715271">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section134095715271" tips="复制节点链接"></i></h3><p>ArkTS应用中出现OOM异常通常是由于内存泄漏、大对象分配、频繁创建对象或缓存不当导致的。建议开发者及时释放无用资源，避免循环中创建对象，优化图片和数据结构，实施合理的缓存策略，并使用内存分析工具监控应用内存使用。通过预防性编码、资源管理和渐进加载等措施，可有效减少OOM异常，提升应用稳定性。</p> </div> <div class="tiledSection"><h3 id="section19313173422712">相关文档<i class="anchor-icon anchor-icon-link" anchorid="section19313173422712" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hiappevent-watcher-resourceleak-events" target="_blank">资源泄漏事件介绍</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-js-memleak-detection" target="_blank">JS内存泄漏问题检测方法</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-scenario-stability-leak" target="_blank">资源泄漏类问题案例</a></p> </div> </div> <div></div></div>