<h1 _ngcontent-hqs-c119="" class="doc-title ng-star-inserted" title="NDK开发ArkTS侧编码规范"> NDK开发ArkTS侧编码规范 </h1>

<div _ngcontent-hqs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ArkTS通过引用编译好的so文件来调用native方法。为避免不规范引用导致的运行时异常和故障排查成本，开发者应按照本文的标准进行引用。</p> <p>NDK工程创建步骤及目录结构可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/create-with-ndk" target="_blank">创建NDK工程</a>。</p> <div class="tiledSection"><h2 id="section3822175519414">import本模块的so<i class="anchor-icon anchor-icon-link" anchorid="section3822175519414" tips="复制节点链接"></i></h2><p><strong>配置依赖</strong>：</p> <p>模块根目录 &gt; oh-package.json5</p> <div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"entry"</span>,</li><li>  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Please describe the basic information."</span>,</li><li>  <span class="hljs-string">"main"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"license"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"dependencies"</span>: {</li><li>    <span class="hljs-comment">// 依赖的so</span></li><li>    <span class="hljs-string">"libentry.so"</span>: <span class="hljs-string">"file:./src/main/cpp/types/libentry"</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p>依赖文件中的so名称要与CMakeLists.txt文件中的模块名称一致。</p> <p>模块根目录 &gt; src &gt; main &gt; cpp &gt; CMakeLists.txt</p> <div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li># the minimum version of CMake.</li><li><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.4</span>.<span class="hljs-number">1</span>)</li><li><span class="hljs-built_in">project</span>(MyApplication14)</li><li><span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})</li><li><span class="hljs-built_in">if</span>(DEFINED PACKAGE_FIND_FILE)</li><li>    <span class="hljs-built_in">include</span>(${PACKAGE_FIND_FILE})</li><li><span class="hljs-built_in">endif</span>()</li><li><span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}</li><li>                    ${NATIVERENDER_ROOT_PATH}/include)</li><li>
</li><li># 声明一个产物libentry<span class="hljs-selector-class">.so</span>，SHARED表示产物为动态库，napi_init<span class="hljs-selector-class">.cpp</span>为产物的源代码              </li><li><span class="hljs-built_in">add_library</span>(entry SHARED napi_init.cpp)</li><li>
</li><li># 声明产物entry链接时需要的三方库libace_napi<span class="hljs-selector-class">.z</span><span class="hljs-selector-class">.so</span></li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so)</li></ol></pre></div></div> <p><strong>引用native方法</strong>：</p> <p>引用的so文件名称必须与oh-package.json5中定义的一致。</p> <div class="screenLinkPre"><div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/DevEcoStaticCheck/src/main/ets/pages/Index3.ets#L6-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// Reference napi in dependent modules</span></li><li><span class="hljs-keyword">import</span> { testNapi } <span class="hljs-keyword">from</span> <span class="hljs-string">'library'</span>;</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// Call methods in Napi</span></li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/DevEcoStaticCheck/src/main/ets/pages/Index3.ets#L6-L30" target="_blank">Index3.ets</a></div></div></div></div> <p>调用的方法名称必须与.d.ts文件中导出的方法名一致。</p> <p>模块根目录 &gt; src &gt; main &gt; cpp &gt; types &gt; libentry &gt; index.d.ts</p> <div class="screenLinkPre"><div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/Ndk1/src/main/cpp/types/libndk1/Index.d.ts#L2-L2" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/Ndk1/src/main/cpp/types/libndk1/Index.d.ts#L2-L2" target="_blank">Index.d.ts</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section191555604420">import其它模块的so<i class="anchor-icon anchor-icon-link" anchorid="section191555604420" tips="复制节点链接"></i></h2><p>开发者可以在har/hsp中编写公共的so，供其他模块调用。</p> </div> <div class="tiledSection"><h3 id="section1369811291443" class="firsth2">引用方模块<i class="anchor-icon anchor-icon-link" anchorid="section1369811291443" tips="复制节点链接"></i></h3><p><strong>本地依赖</strong>：</p> <p>模块根目录 &gt; oh-package.json5</p> <div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"entry"</span>,</li><li>  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Please describe the basic information."</span>,</li><li>  <span class="hljs-string">"main"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"license"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"dependencies"</span>: {</li><li>    <span class="hljs-comment">// 依赖当前工程下的其它模块</span></li><li>    <span class="hljs-string">"library"</span>: <span class="hljs-string">"file:../library"</span></li><li>  }</li><li>}</li></ol></pre></div></div> </div> <p><strong>远程依赖</strong>：</p> <div class="p">运行命令<div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>ohpm install library --registry http://localhost:8088/repos/ohpm</li></ol></pre></div></div> </div> <div class="p">工程根目录 &gt; oh-package.json5 中会自动配置依赖。<div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"depend_othermodule_so"</span>,</li><li>  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Please describe the basic information."</span>,</li><li>  <span class="hljs-string">"main"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"license"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"dependencies"</span>: {</li><li>    <span class="hljs-comment">// 名称必须与远程模块名称相同</span></li><li>    <span class="hljs-string">"library"</span>: <span class="hljs-string">"^2.0.0"</span></li><li>  },</li><li>  <span class="hljs-string">"devDependencies"</span>: {</li><li>    <span class="hljs-string">"@ohos/hypium"</span>: <span class="hljs-string">"1.0.17"</span>,</li><li>    <span class="hljs-string">"@ohos/hamock"</span>: <span class="hljs-string">"1.0.1-rc2"</span></li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="p"><strong>引用native方法</strong>：<div class="screenLinkPre"><div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/DevEcoStaticCheck/src/main/ets/pages/Index3.ets#L6-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// Reference napi in dependent modules</span></li><li><span class="hljs-keyword">import</span> { testNapi } <span class="hljs-keyword">from</span> <span class="hljs-string">'library'</span>;</li><li>
</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// Call methods in Napi</span></li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Test NAPI 2 + 3 = %{public}d'</span>, testNapi.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/DevEcoStaticCheck/src/main/ets/pages/Index3.ets#L6-L30" target="_blank">Index3.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section117617409514">导出方模块<i class="anchor-icon anchor-icon-link" anchorid="section117617409514" tips="复制节点链接"></i></h3></div> <p>通过统一出口将napi导出。</p> <p>模块根目录 &gt; index.ets</p> <div class="screenLinkPre"><div _ngcontent-hqs-c106="" class="highlight-div"><div _ngcontent-hqs-c106="" class="highlight-div-header"><div _ngcontent-hqs-c106="" class="highlight-div-header-left"><div _ngcontent-hqs-c106="" class="handle-button expand-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hqs-c106="" class="highlight-div-header-right"><div _ngcontent-hqs-c106="" class="handle-button ai-button"></div><div _ngcontent-hqs-c106="" class="handle-button line-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hqs-c106="" class="handle-button theme-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hqs-c106="" class="handle-button copy-button"><div _ngcontent-hqs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hqs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/Ndk1/src/main/ets/pages/Index.ets#L4-L5" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'liblibrary.so'</span>;</li><li><span class="hljs-keyword">export</span> {testNapi}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/StabilityCodingSpecification/Ndk1/src/main/ets/pages/Index.ets#L4-L5" target="_blank">Index.ets</a></div></div></div></div> <p></p> </div> <div></div></div>