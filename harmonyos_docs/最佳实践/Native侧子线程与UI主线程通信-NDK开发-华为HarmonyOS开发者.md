<h1 _ngcontent-gks-c119="" class="doc-title ng-star-inserted" title="Native侧子线程与UI主线程通信"> Native侧子线程与UI主线程通信 </h1>

<div _ngcontent-gks-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section181711033124918">概述<i class="anchor-icon anchor-icon-link" anchorid="section181711033124918" tips="复制节点链接"></i></h2><p>开发者在Native侧进行开发实践时，经常会遇到一些耗时的任务，例如I/O操作、域名解析以及复杂计算等。这些任务如果直接在主线程中执行，将会严重阻塞主线程，影响后续任务的正常流程，进而导致用户界面响应延迟甚至卡顿。</p> <p>为了提升代码性能，通常会将这类耗时任务放在Native子线程中执行。通常情况下，Native子线程可以独立完成自己的任务，但是很多时候需要将数据从主线程传递到Native子线程，或者将Native子线程的执行结果返回给主线程。</p> <p>在多线程环境中，有一个关键问题是如何安全地在后台线程（Native侧子线程）和UI主线程之间进行通信。ArkTS侧函数通常只能在主线程里调用，如果Native侧通过std::thread或pthread创建了子线程，那么主线程中的上下文环境和数据（napi_env、napi_value以及napi_ref）是不能直接在子线程上下文中使用的。</p> <p>为确保正确性，当Native侧在子线程完成其计算或处理后，若需要回调ArkTS函数，必须先通过线程同步机制将结果传递回主线程，然后才能安全地在主线程环境中调用ArkTS函数。针对这个问题，可以采用以下方案来解决。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-native-sub-main-comm#section867313171296">基于线程安全函数机制实现</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-native-sub-main-comm#section8322162418295">基于libuv异步库的uv_async_send方法实现</a></li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>推荐开发者使用线程安全函数作为Native侧子线程与UI主线程的通信手段。</p> <p>如果线程安全函数确实不能满足开发需要，开发者可以使用libuv库自定义Loop然后通过uv_async_send方法进行线程间通信。</p> <p>另外，libuv库中的uv_queue_work接口也可以实现线程间通信，但存在以下弊端：</p> <ul><li>使用uv_queue_work作为线程间通信的手段时，execute回调中一般实现为空任务，没有任何维测信息，一旦异步任务不回调，定位将很困难。这种方式不仅低效，而且还增加了发生故障时定位问题的难度。</li><li>它会破坏底层的数据可信性，uv_queue_work函数仅用于抛异步任务，异步任务的execute回调被提交到线程池后会经过调度执行，因此并不保证多次提交的任务之间的时序关系。</li></ul> <p>更多libuv库的方案策略可以查看API参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv" target="_blank">libuv</a>。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section103722314257">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section103722314257" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section867313171296" class="firsth2">基于线程安全函数机制<i class="anchor-icon anchor-icon-link" anchorid="section867313171296" tips="复制节点链接"></i></h3><p>HarmonyOS Node-API提供了一系列<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-data-types-interfaces#异步安全线程相关" target="_blank">线程安全函数</a>相关的接口，通过这些接口可以在Native侧创建一个可以在多线程间共享并安全使用的函数对象。在创建过程中，需要指定一些关键信息，如ArkTS回调函数、异步资源标识符、缓冲队列容量、初始线程数等。这些信息将用于确保函数在多线程环境下的正确性和安全性。通过这个机制，子线程可以将数据传递给主线程，主线程接收到数据后会调用ArkTS回调函数进行处理。</p> <p><strong>调用流程图</strong></p> <p><span><img height="642.1905" originheight="749" originwidth="916" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.71215280326242081770391545582944:50001231000000:2800:E2CA67FE758676F46333D7A84789A7D56DD42AC92EF071788F8D20A139DF963B.png" title="点击放大" width="784.3675000000001"></span></p> <p>首先ArkTS侧会传递一个回调函数到Native侧，然后在Native侧创建一个线程安全函数，此线程安全函数会绑定一个回调函数（通过napi_call_threadsafe_function调用线程安全函数时，会触发该回调函数），接着需要保存后续需要用到的上下文信息及参数，然后拆分子线程（子线程绑定了要用到的上下文信息及参数）。</p> <p>Native侧子线程分配到系统资源之后会执行对应的业务逻辑，通过Node-API提供的线程安全函数相关的接口调用前面声明的线程安全函数，该线程安全函数会被push到主线程的事件循环中等待事件调度执行。</p> <p>线程安全函数在事件循环中得到调度后会通过napi_call_back接口调用ArkTS回调函数。</p> <p><strong>开发步骤</strong></p> <ol><li>ArkTS侧传递函数到Native侧</li><li>Native侧主线程中构建线程安全函数、保存上下文信息并拆分子线程</li><li>在Native侧子线程中请求线程安全函数并调用</li><li>在线程安全函数中回调ArkTS侧传递的回调函数</li></ol> </div> <div class="tiledSection"><h3 id="section8322162418295">基于libuv异步库的uv_async_send方法<i class="anchor-icon anchor-icon-link" anchorid="section8322162418295" tips="复制节点链接"></i></h3><p>libuv库提供了一个函数uv_async_send，用于在非阻塞事件循环中异步发送信号。uv_async_send函数允许用户在不同的线程或者事件循环的不同部分之间发送信号，从而触发某些操作而不需要直接调用阻塞函数。uv_async_send的核心原理是利用事件循环（event-loop）和内部消息队列来实现线程间的通信。具体来说，它允许一个线程（通常是工作线程）发送信号给主线程上的事件循环，从而触发主线程上的某个回调函数。因此利用该原理可以在主线程中定义用于回调ArkTS侧函数的回调函数，待子线程中业务逻辑执行完成后通过uv_async_send接口实现在子线程中通知主线程执行回调，进而实现对ArkTS侧函数的调用。</p> <p><strong>调用流程图</strong></p> <p><span><img height="900.9287" originheight="5856" originwidth="4581" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163058.19001381498854824057696952367297:50001231000000:2800:B05C6F5B6FFE0D467FFAFC2B4B394C81A9BB897D80909C9F724226530BA336B6.png" title="点击放大" width="704.9000000000001"></span></p> <p></p> <p>首先ArkTS侧会传递一个回调函数到Native侧，Native侧接收到后会保存后续需要用到的上下文信息及参数，接着通过napi_get_uv_event_loop接口获取主线程Loop，该Loop会在主线程中执行，然后初始化async句柄并绑定后续需要在主线程调用的回调函数，运行Loop。接着拆分子线程（子线程绑定了要用到的上下文信息及参数）。</p> <p>Native侧子线程分配到系统资源之后在子线程中调用uv_async_send方法通知主线程调用与async绑定的函数。</p> <p>运行在主线程的Loop接收到信号后，会调用之前async句柄绑定的回调函数，然后就可以在该函数中调用ArkTS回调函数。</p> <p><strong>开发步骤</strong></p> <ol><li>ArkTS侧传递函数到Native侧</li><li>Native侧保存上下文信息</li><li>通过napi_get_uv_event_loop接口获取主线程loop并初始化async句柄绑定回调函数</li><li>在子线程中调用uv_async_send方法通知主线程调用与async绑定的函数</li><li>在主线程中运行Loop执行async绑定的函数，调用ArkTS侧传递的回调函数</li></ol> </div> <div class="tiledSection"><h2 id="section11138115720353">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section11138115720353" tips="复制节点链接"></i></h2><p>本节将以分别使用线程安全函数和libuv异步库实现以下操作，在Native侧拆分子线程执行业务逻辑，子线程业务逻辑完成之后回到主线程执行ArkTS侧传入的ArkTS回调函数，从而完成了对ArkTS端变量值的加30操作。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>从ArkTS侧传递给Native侧的函数引用，其生命周期仅限于它所在的作用域内。若要确保在超出该作用域后仍能继续使用这个函数引用，需要采取适当的方法来延长其生命周期。可以通过调用napi_create_reference接口为ArkTS对象创建一个引用(reference)。这样可以避免对象因垃圾回收机制而被提前释放，从而有效地延长它的生命周期。然而，在创建引用之后，务必牢记要在不再需要该引用时，调用napi_delete_reference来释放引用，以防止内存泄漏问题的发生。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section12789649613" class="firsth2">基于线程安全函数机制实现<i class="anchor-icon anchor-icon-link" anchorid="section12789649613" tips="复制节点链接"></i></h3><ol><li>ArkTS侧传递函数到Native侧<div class="p">在ArkTS侧实现一个回调函数，参数为param，函数体中对参数param加30后刷新变量value，并返回最新的param值。将回调函数作为参数调用Native侧的threadSafeCase接口。<div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L66-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Call Native side function and pass ArkTS side function to Native side.</span></li><li>testNapi.threadSafeCase(<span class="hljs-keyword">this</span>.work);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L66-L67" target="_blank">Index.ets</a></div></div></div></div> </div> </li><li>Native侧主线程中构建线程安全函数、保存上下文信息并拆分子线程<p>threadSafeCase接口接收到ArkTS传入的回调函数后通过napi_create_threadsafe_function创建一个线程安全函数tsFn，tsFn会回调主线程中的ThreadSafeCallJs方法，然后在ThreadSafeCallJs方法中调用ArkTS侧传入的回调函数。</p> <p>在拆分子线程时，需要保存上下文信息及ArkTS函数引用，保存完之后拆分子线程。</p> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L25-L31" data-highlighted="yes"><ol class="linenums"><li>napi_threadsafe_function tsFn;</li><li><span class="hljs-type">static</span> <span class="hljs-type">int</span> g_value = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CallbackContext</span> {</li><li>    napi_env env = <span class="hljs-literal">nullptr</span>;</li><li>    napi_ref callbackRef = <span class="hljs-literal">nullptr</span>;</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L25-L31" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L77-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ThreadSafeCase</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value js_callback;</li><li>    napi_value workName;</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;js_callback, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_valuetype valueType = napi_undefined;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, js_callback, &amp;valueType);</li><li>    <span class="hljs-keyword">if</span> (valueType != napi_valuetype::napi_function) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"ThreadSafeCase"</span>, NAPI_AUTO_LENGTH, &amp;workName);</li><li>    <span class="hljs-built_in">napi_create_threadsafe_function</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, workName, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, ThreadSafeCallJs, &amp;tsFn);</li><li>    <span class="hljs-keyword">auto</span> asyncContext = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CallbackContext</span>();</li><li>    asyncContext-&gt;env = env;</li><li>    <span class="hljs-built_in">napi_create_reference</span>(env, js_callback, <span class="hljs-number">1</span>, &amp;asyncContext-&gt;callbackRef);</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(SubThread, asyncContext)</span></span>;</li><li>    t.<span class="hljs-built_in">detach</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L77-L97" target="_blank">napi_init.cpp</a></div></div></div></div> </li><li>在Native侧子线程中请求线程安全函数并调用<p>在子线程中通过napi_call_threadsafe_function调用线程安全函数tsFn，把CallbackContext结构体数据作为参数传入线程安全函数。开发者可以根据自身实际需求在子线程中添加相应的业务操作。</p> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L35-L43" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">SubThread</span>(CallbackContext *asyncContext) {</li><li>    if (asyncContext == nullptr) {</li><li>        return;</li><li>    }</li><li>    <span class="hljs-built_in">napi_acquire_threadsafe_function</span>(tsFn);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "ThreadSafe ChildThread, value:[%{public}d]", g_value);</li><li>    <span class="hljs-built_in">napi_call_threadsafe_function</span>(tsFn, asyncContext, napi_tsfn_nonblocking);</li><li>    <span class="hljs-built_in">napi_release_threadsafe_function</span>(tsFn, napi_tsfn_release);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L35-L43" target="_blank">napi_init.cpp</a></div></div></div></div> </li><li>在线程安全函数中回调ArkTS侧传递的回调函数<p>通过上面保存的上下文信息及ArkTS函数引用回调ArkTS回调函数实现加30操作。</p> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L47-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">void</span> <span class="hljs-title function_">ThreadSafeCallJs</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_value</span> <span class="hljs-variable">js_callBack</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">context</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-variable">CallbackContext</span> *<span class="hljs-variable">argContext</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackContext</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">argContext</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">napi_get_reference_value</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">argContext</span>-&gt;<span class="hljs-title class_">callbackRef</span>, &amp;<span class="hljs-title class_">js_callBack</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">napi_valuetype</span> <span class="hljs-variable">valueType</span> = <span class="hljs-variable">napi_undefined</span>;</li><li>    <span class="hljs-title function_">napi_typeof</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">js_callBack</span>, &amp;<span class="hljs-title class_">valueType</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">valueType</span> != <span class="hljs-variable">napi_valuetype</span>::<span class="hljs-title class_">napi_function</span>) {</li><li>        <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">argContext</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">argContext</span>;</li><li>        <span class="hljs-variable">argContext</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">argv</span>;</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">g_value</span>, &amp;<span class="hljs-title class_">argv</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">result</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">js_callBack</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">argv</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">result</span>, &amp;<span class="hljs-title class_">g_value</span>);</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"ThreadSafe CallArkTS end, value:[%{public}d]"</span>, <span class="hljs-variable">g_value</span>);</li><li>    <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">argContext</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">argContext</span>;</li><li>    <span class="hljs-variable">argContext</span> = <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L47-L73" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol> <p><strong>结果展示</strong></p> <p><span><img originheight="62" originwidth="898" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163058.49272600972498042883211405443675:50001231000000:2800:4FC22FE6C720ACC6AEA1124E27A3D101482B3D793C8DC8287A1E4F3DD394E52B.png" width="898" height="62"></span></p> </div> <div class="tiledSection"><h3 id="section1024562613517">基于libuv异步库的uv_async_send方法实现<i class="anchor-icon anchor-icon-link" anchorid="section1024562613517" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用libuv异步库需要在CMakeLists.txt文件中添加libuv.so依赖，并在使用libuv接口的代码文件中引用其头文件uv.h，例如这里我们在napi_init文件中引用。</p> <div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// CMakeLists.txt文件</span></li><li><span class="hljs-built_in">target_link_libraries</span>(entry PUBLIC libace_napi.z.so libhilog_ndk.z.so libuv.so)</li><li>
</li><li><span class="hljs-comment">// napi_init.cpp文件</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;uv.h&gt;</span></span></li></ol></pre></div></div> </div></div></div> <ol><li>ArkTS侧传递函数到Native侧<p>在ArkTS侧实现一个回调函数，参数为param，函数体中对参数param加30后刷新变量value，并返回最新的param值。将回调函数作为参数调用Native侧的libUvCase接口。</p> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L23-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@State</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-attr">work</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-function">(<span class="hljs-params">param: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  param += <span class="hljs-number">30</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = param;</li><li>  <span class="hljs-keyword">return</span> param;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L23-L28" target="_blank">Index.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L79-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Call Native side function and pass ArkTS side function to Native side.</span></li><li>testNapi.libUvCase(<span class="hljs-keyword">this</span>.work);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/ets/pages/Index.ets#L79-L80" target="_blank">Index.ets</a></div></div></div></div> </li><li>Native侧保存上下文信息。<div class="p">libUvCase接口接收到ArkTS传入的回调函数后保存上下文信息及ArkTS函数引用。<div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L141-L156" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>napi_value callback_function;</li><li><span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;callback_function, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>napi_valuetype valueType = napi_undefined;</li><li><span class="hljs-built_in">napi_typeof</span>(env, callback_function, &amp;valueType);</li><li><span class="hljs-keyword">if</span> (valueType != napi_valuetype::napi_function) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">auto</span> asyncContext = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CallbackContext</span>();</li><li><span class="hljs-keyword">if</span> (asyncContext == <span class="hljs-literal">nullptr</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>asyncContext-&gt;env = env;</li><li><span class="hljs-built_in">napi_create_reference</span>(env, callback_function, <span class="hljs-number">1</span>, &amp;asyncContext-&gt;callbackRef);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L141-L156" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li><li>通过napi_get_uv_event_loop接口获取主线程Loop并初始化async句柄绑定回调函数<div class="p">在libUvCase接口中保存完数据之后，通过napi_get_uv_event_loop接口获取主线程Loop，该Loop会在主线程中运行。然后初始化一个async句柄，该句柄会绑定一个后续在主线程Loop上运行的回调函数（后续可以在该函数中调用ArkTS侧函数）。接着拆分子线程。<div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-rust" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L160-L173" data-highlighted="yes"><ol class="linenums"><li>uv_loop_t *<span class="hljs-keyword">loop</span> = nullptr;</li><li><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">napi_get_uv_event_loop</span>(env, &amp;<span class="hljs-keyword">loop</span>) != napi_ok) {</li><li>    delete asyncContext;</li><li>    <span class="hljs-keyword">return</span> nullptr;</li><li>}</li><li>    </li><li>uv_async_t *<span class="hljs-keyword">async</span> = new <span class="hljs-title function_ invoke__">uv_async_t</span>();</li><li><span class="hljs-title function_ invoke__">uv_async_init</span>(<span class="hljs-keyword">loop</span>, <span class="hljs-keyword">async</span>, async_handler);</li><li><span class="hljs-keyword">async</span><span class="hljs-punctuation">-&gt;</span>data = asyncContext;</li><li>asyncContext<span class="hljs-punctuation">-&gt;</span><span class="hljs-keyword">async</span> = <span class="hljs-keyword">async</span>;</li><li>
</li><li>std::thread <span class="hljs-title function_ invoke__">caseThread</span>(CallbackUvWorkTest, asyncContext);</li><li>caseThread.<span class="hljs-title function_ invoke__">detach</span>();</li><li><span class="hljs-keyword">return</span> nullptr;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L160-L173" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li><li>在子线程中调用uv_async_send方法通知主线程调用与async绑定的函数<div class="p">子线程获取到系统调度之后，调用uv_async_send方法通知主线程调用与async绑定的回调函数。<div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L130-L136" data-highlighted="yes"><ol class="linenums"><li>void <span class="hljs-built_in">CallbackUvWorkTest</span>(CallbackContext *context) {</li><li>    if (context == nullptr) {</li><li>        return;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, "LibUV ChildThread, value:[%{public}d]", g_value);</li><li>    <span class="hljs-built_in">uv_async_send</span>(context-&gt;async);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L130-L136" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li><li>在主线程中运行Loop执行async句柄绑定的函数，调用ArkTS侧传递的回调函数<div class="p">主线程收到子线程uv_async_send传递的信号后会在对应Loop中调用之前async句柄绑定的的回调函数，该函数会运行在主线程里（也就是我们之前获取的Loop中），通过上面保存的上下文信息及ArkTS函数引用回调ArkTS回调函数实现加30操作。<div class="screenLinkPre"><div _ngcontent-gks-c106="" class="highlight-div"><div _ngcontent-gks-c106="" class="highlight-div-header"><div _ngcontent-gks-c106="" class="highlight-div-header-left"><div _ngcontent-gks-c106="" class="handle-button expand-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gks-c106="" class="highlight-div-header-right"><div _ngcontent-gks-c106="" class="handle-button ai-button"></div><div _ngcontent-gks-c106="" class="handle-button line-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gks-c106="" class="handle-button theme-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gks-c106="" class="handle-button copy-button"><div _ngcontent-gks-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gks-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L107-L134" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">async_handler</span>(<span class="hljs-variable">uv_async_t</span> *<span class="hljs-variable">handle</span>) {</li><li>    <span class="hljs-variable">CallbackContext</span> *<span class="hljs-variable">context</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">CallbackContext</span> *&gt;(<span class="hljs-variable">handle</span>-&gt;<span class="hljs-title class_">data</span>);</li><li>    <span class="hljs-variable">napi_handle_scope</span> <span class="hljs-variable">scope</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_open_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, &amp;<span class="hljs-title class_">scope</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">scope</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">context</span>;</li><li>        <span class="hljs-variable">context</span> = <span class="hljs-variable">nullptr</span>;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">handle</span> != <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-variable">delete</span> <span class="hljs-variable">handle</span>;</li><li>            <span class="hljs-variable">handle</span> = <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">callback</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_get_reference_value</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>, &amp;<span class="hljs-title class_">callback</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">retArg</span>;</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">g_value</span>, &amp;<span class="hljs-title class_">retArg</span>);</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">result</span>;</li><li>    <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">callback</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">retArg</span>, &amp;<span class="hljs-title class_">result</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">result</span>, &amp;<span class="hljs-title class_">g_value</span>);</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"LibUV CallArkTS end, value:[%{public}d]"</span>, <span class="hljs-variable">g_value</span>);</li><li>    <span class="hljs-title function_">napi_close_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">scope</span>);</li><li>    <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">context</span>;</li><li>    <span class="hljs-variable">context</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">uv_close</span>((<span class="hljs-variable">uv_handle_t</span> *)<span class="hljs-variable">async</span>, [](<span class="hljs-variable">uv_handle_t</span> *<span class="hljs-variable">handle</span>) { <span class="hljs-variable">delete</span> (<span class="hljs-variable">uv_async_t</span> *)<span class="hljs-variable">handle</span>; });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication/blob/master/entry/src/main/cpp/napi_init.cpp#L107-L134" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li></ol> <p><strong>结果展示</strong></p> <p><span><img originheight="67" originwidth="876" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163058.39161971365400984385771357169784:50001231000000:2800:020004B0C7F270DBC2EAFF8E5E32A9B67C9EB1EC1F5353AC7A839F7021A3AA1E.png" width="876" height="67"></span></p> </div> <div class="tiledSection"><h2 id="section1236122531014">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section1236122531014" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section18993563615" class="firsth2">如何在Native侧调用ArkTS侧异步方法，并获取异步计算结果到Native侧<i class="anchor-icon anchor-icon-link" anchorid="section18993563615" tips="复制节点链接"></i></h3><p>可以参考如下链接：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-ndk-32" target="_blank">在Native侧调用ArkTS侧异步方法</a>。</p> </div> <div class="tiledSection"><h2 id="section124618207263">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section124618207263" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/NativeSubMainThreadCommunication" target="_blank">实现Native侧子线程与UI主线程通信</a></li></ul> </div> </div> <div></div></div>