<h1 _ngcontent-qhi-c119="" class="doc-title ng-star-inserted" title="Native侧实现文件访问"> Native侧实现文件访问 </h1>

<div _ngcontent-qhi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1256365412359">概述<i class="anchor-icon anchor-icon-link" anchorid="section1256365412359" tips="复制节点链接"></i></h2><p>在对文件处理性能要求高的场景中，Native侧访问文件处理数据比在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-file-access" target="_blank">ArkTS侧操作文件</a>有更高的效率和更快的响应，例如处理大文件、复杂的文件操作以及实时通信等低时延场景。根据文件位置的不同，应用在Native侧访问文件可以分为以下三种类型：</p> <ul><li>类型一：访问应用沙箱内的文件进行读写操作，主要是通过沙箱路径进行访问。</li><li>类型二：访问应用资源文件进行读操作，可以通过传递资源管理器进行访问。</li><li>类型三：访问系统公共目录中的文件进行读写操作，可以使用文件picker来获取文件描述符。</li></ul> <p>本文将针对这三种场景给出具体的实现方案。</p> </div> <div class="tiledSection"><h2 id="section8318153120525">访问应用沙箱文件<i class="anchor-icon anchor-icon-link" anchorid="section8318153120525" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory" target="_blank">应用沙箱</a>是一种以安全防护为目的的隔离机制，避免数据受到恶意路径穿越访问。在这种沙箱的保护机制下，应用可见的目录范围即为“应用沙箱目录”，沙箱中的文件就需要通过沙箱路径去进行访问。Native侧获取沙箱路径的方案有两种：</p> <ul><li>方案一：ArkTS侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-context-stage#获取应用文件路径" target="_blank">获取沙箱路径</a>传递给Native侧访问文件。</li><li>方案二：Native侧直接<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory#应用沙箱路径和真实物理路径的对应关系" target="_blank">拼接沙箱路径</a>访问文件。</li></ul> </div> <div class="tiledSection"><h3 id="section13262125205417" class="firsth2">方案一：ArkTS侧获取沙箱路径传递给Native侧访问文件<i class="anchor-icon anchor-icon-link" anchorid="section13262125205417" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图1 </b>ArkTS侧获取沙箱路径传递给Native侧访问文件示意图</span><br><span><img originheight="440" originwidth="282" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.33917436845642775777634379799824:50001231000000:2800:7470CFDD70C7650A6E6C7ACFB2A1B0A37B5C50478AEA78C2CBE2F9841385100B.png" class="notEnlarge" width="282" height="440"></span></div> <p><strong>实现方案</strong></p> <p>这里以访问沙箱文件并写入文本的场景为例，实现方案分为Native侧定义操作文件的方法和ArkTS侧调用该方法两部分。</p> <p>第一部分：在Native侧定义一个方法，用于接收沙箱路径并将文本写入到文件中。</p> <ol><li>通过Node-API接口将沙箱路径和要写入文本的内容传递到Native侧。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L41-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">0</span>], pathBuf, sizeof(pathBuf), &amp;pathSize);</li><li><span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], contentsBuf, sizeof(contentsBuf), &amp;contentsSize);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L41-L42" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>通过指定的路径打开文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L47-L48" data-highlighted="yes"><ol class="linenums"><li>FILE *fp;</li><li>fp = fopen(pathBuf, <span class="hljs-string">"w"</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L47-L48" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>使用C标准库的文件操作函数写入文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L56-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"%s"</span>, contentsBuf);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L56-L57" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>完整代码如下所示：<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L32-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/FileAccessMethods.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TransferSandboxPath</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">//Convert the sandbox path and the contents of the text to be written into C-side variables through the Node-API interface.</span></li><li>    <span class="hljs-type">size_t</span> pathSize, contentsSize;</li><li>    <span class="hljs-type">char</span> pathBuf[BUFFER_SIZE], contentsBuf[BUFFER_SIZE];</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">0</span>], pathBuf, <span class="hljs-built_in">sizeof</span>(pathBuf), &amp;pathSize);</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], contentsBuf, <span class="hljs-built_in">sizeof</span>(contentsBuf), &amp;contentsSize);</li><li>    <span class="hljs-comment">//Open the file through the specified path.</span></li><li>    <span class="hljs-built_in">snprintf</span>(pathBuf, <span class="hljs-built_in">sizeof</span>(pathBuf), <span class="hljs-string">"%s/TransferSandboxPath.txt"</span>, pathBuf);</li><li>    FILE *fp;</li><li>    fp = <span class="hljs-built_in">fopen</span>(pathBuf, <span class="hljs-string">"w"</span>);</li><li>    <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, DOMAIN, TAG, <span class="hljs-string">"Open file error!"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, <span class="hljs-string">"Open file successfully!"</span>);</li><li>    <span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li>    <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"%s"</span>, contentsBuf);</li><li>    <span class="hljs-built_in">fclose</span>(fp);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L32-L61" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将该<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">C++接口与ArkTS接口进行绑定和映射</a>，同时在index.d.ts文件中，提供该接口方法以便于ArkTS侧调用。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L20-L20" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">transferSandboxPath</span>: <span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span>, contents: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L20-L20" target="_blank">Index.d.ts</a></div></div></div></div> </li></ol> <p>第二部分：在Native侧访问沙箱文件写数据的功能实现后，在ArkTS侧调用该方法。</p> <ol><li>引用Native侧相应的so库。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L22-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">FileAccess</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libfile_access.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L22-L26" target="_blank">Index.ets</a></div></div></div></div> </li><li>在ArkTS侧获取沙箱路径。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L37-L37" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> sandboxFilesDir: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()!.filesDir;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L37-L37" target="_blank">Index.ets</a></div></div></div></div> </li><li>获取到沙箱路径后，将该路径传递给Native侧，同时传递需要写入的内容。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L73-L73" data-highlighted="yes"><ol class="linenums"><li>FileAccess.transferSandboxPath(<span class="hljs-keyword">this</span>.sandboxFilesDir, content);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L73-L73" target="_blank">Index.ets</a></div></div></div></div> </li></ol> </div> <p>通过上述步骤，实现了在Native侧通过ArkTS侧传递的沙箱路径访问与操作应用沙箱文件的方案。</p> <p><strong>效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图2 </b>ArkTS侧传递沙箱路径到Native侧方案效果展示</span><br><span><img height="552.2692000000001" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.42886464470400388064897041155488:50001231000000:2800:54D7EE816394ACAACC15AA64F2354A05299A2802618565AD8BBB3B2E5A7E05FA.png" title="点击放大" width="266"></span></div> <p><span><img originheight="150" originwidth="441" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.30277201881284148643308354216814:50001231000000:2800:1418EABE9515F9FAEDFEABFE932252E1D030B26D9EC682605097762503C8483E.png" width="441" height="150"></span></p> <div class="tiledSection"><h3 id="section19243162119554">方案二：Native侧直接拼接沙箱路径访问文件<i class="anchor-icon anchor-icon-link" anchorid="section19243162119554" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图3 </b>Native侧直接拼接沙箱路径访问文件示意图</span><br><span><img originheight="440" originwidth="339" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.05052024627706896843777851440648:50001231000000:2800:62D16A1EE09F670CF9EA8B23A3F031842319296FCBE1F9DEBAC05575F181155F.png" width="339" height="440"></span></div> <p><strong>实现方案</strong></p> <p>这里同样以访问沙箱文件并写入文本的场景为例，实现方案分为Native侧定义操作文件的方法和ArkTS侧调用该方法两部分。</p> <p>第一部分：在Native侧定义一个方法，用于拼接沙箱路径并将文本写入到文件中。</p> <ol><li>根据实际文件位置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory#应用沙箱路径和真实物理路径的对应关系" target="_blank">拼接沙箱路径</a>。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L71-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">char</span> pathBuf[READ_SIZE] = {<span class="hljs-number">0</span>};</li><li><span class="hljs-built_in">strncpy</span>(pathBuf,FILE_PATH,READ_SIZE);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L71-L72" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将要写入文本的内容通过Node-API接口传递到Native侧。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L78-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">0</span>], contentsBuf, sizeof(contentsBuf), &amp;contentsSize);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L78-L78" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>通过指定的路径打开文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L82-L84" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Open the file through the specified path.</span></li><li>FILE *fp;</li><li>fp = <span class="hljs-built_in">fopen</span>(pathBuf, <span class="hljs-string">"w"</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L82-L84" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>使用C标准库的文件操作函数写入文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L92-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"%s"</span>, contentsBuf);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L92-L93" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>完整代码如下所示：<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L64-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">SplicePath</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">//Splice the sandbox path according to the actual file location.</span></li><li>    <span class="hljs-type">size_t</span> contentsSize;</li><li>    <span class="hljs-type">char</span> pathBuf[READ_SIZE] = {<span class="hljs-number">0</span>};</li><li>    <span class="hljs-built_in">strncpy</span>(pathBuf,FILE_PATH,READ_SIZE);</li><li>    <span class="hljs-comment">//Convert the contents of the text to be written into C-side variables through the Node-API interface.</span></li><li>    <span class="hljs-type">char</span> contentsBuf[BUFFER_SIZE];</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">0</span>], contentsBuf, <span class="hljs-built_in">sizeof</span>(contentsBuf), &amp;contentsSize);</li><li>    <span class="hljs-comment">//Open the file through the specified path.</span></li><li>    FILE *fp;</li><li>    fp = <span class="hljs-built_in">fopen</span>(pathBuf, <span class="hljs-string">"w"</span>);</li><li>    <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, DOMAIN, TAG, <span class="hljs-string">"Open file error!"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, <span class="hljs-string">"Open file successfully!"</span>);</li><li>    <span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li>    <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"%s"</span>, contentsBuf);</li><li>    <span class="hljs-built_in">fclose</span>(fp);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L64-L97" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将该<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">C++接口与ArkTS接口进行绑定和映射</a>，同时在index.d.ts文件中，提供该接口方法。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L23-L23" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">splicePath</span>: <span class="hljs-function">(<span class="hljs-params">contents: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L23-L23" target="_blank">Index.d.ts</a></div></div></div></div> </li></ol> <p>第二部分：Native侧访问沙箱文件写数据的功能实现后，在ArkTS侧调用该方法。</p> <ol><li>引用Native侧相应的so库。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L23-L25" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">FileAccess</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libfile_access.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L23-L25" target="_blank">Index.ets</a></div></div></div></div> </li><li>在ArkTS侧调用该接口实现文件写入的操作。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L84-L84" data-highlighted="yes"><ol class="linenums"><li>FileAccess<span class="hljs-selector-class">.splicePath</span>(<span class="hljs-attribute">content</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L84-L84" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <p>通过上述步骤，实现了在Native侧通过拼接沙箱路径访问与操作应用沙箱文件的方案。</p> <p><strong>效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图4 </b>Native侧拼接沙箱路径方案效果展示</span><br><span><img height="552.2692000000001" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.64870951638488917192024169980692:50001231000000:2800:58DF8C31BC95CD5B99AEEEA98243E5509589E5606AC10724B229584ECFC509A2.png" title="点击放大" width="266"></span></div> <p><span><img originheight="150" originwidth="428" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.02541664833017496071946400693944:50001231000000:2800:B6708B3862928AC8B504ADA32D54DC6A8E47C7EB13F10016E5A24A94A98CEA7A.png" width="428" height="150"></span></p> </div> <div class="tiledSection"><h2 id="section1052945819523">访问应用包内资源文件<i class="anchor-icon anchor-icon-link" anchorid="section1052945819523" tips="复制节点链接"></i></h2><p>Native侧可以通过Resource Manager<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/rawfile-guidelines" target="_blank">操作应用资源文件中的Rawfile目录和文件</a>，这里以Native侧读取Rawfile文件内容的场景为例介绍该方案。</p> <div class="fignone"><span class="figcap"><b>图5 </b>Native侧访问应用资源文件方案示意图</span><br><span><img originheight="440" originwidth="282" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.47774332240913229641929442083487:50001231000000:2800:4D4CE3FB67465FD8B04122C2470A7A95D20A4BF03EC9F038E3E1BCB37337C838.png" class="notEnlarge" width="282" height="440"></span></div> <p><strong>实现方案</strong></p> <p>实现方案分为Native侧定义操作文件的方法和ArkTS侧调用该方法两部分。</p> <p>第一部分：在Native侧定义一个读取文件的方法，注意使用Resource Manager需要引用头文件rawfile/raw_file_manager.h，并在工程的cmakelists.txt文件中链接动态库librawfile.z.so。</p> <ol><li>将传入的Resource Manager对象转换为Native对象。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L105-L106" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Convert the incoming resource manager object into a Native object.</span></li><li>NativeResourceManager *mNativeResMgr = <span class="hljs-built_in">OH_ResourceManager_InitNativeResourceManager</span>(env, argv[<span class="hljs-number">0</span>]);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L105-L106" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将传入的文件名通过Node-API接口传递到Native侧。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L111-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Convert the passed-in file name into a C-side variable through the Node-API interface.</span></li><li><span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], fileNameBuf, sizeof(fileNameBuf), &amp;fileNameSize);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L111-L112" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>通过资源对象打开文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L115-L116" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Open a file through a resource object</span></li><li>RawFile *rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(mNativeResMgr, fileNameBuf);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L115-L116" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>通过资源对象读取文件内容。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L122-L125" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Read the file content through the resource object</span></li><li><span class="hljs-variable">long</span> <span class="hljs-variable">len</span> = <span class="hljs-title function_">OH_ResourceManager_GetRawFileSize</span>(<span class="hljs-variable">rawFile</span>);</li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">char</span>[]&gt; <span class="hljs-title class_">data</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">char</span>[]&gt;(<span class="hljs-title class_">len</span>);</li><li><span class="hljs-title function_">OH_ResourceManager_ReadRawFile</span>(<span class="hljs-variable">rawFile</span>, <span class="hljs-variable">data</span>.<span class="hljs-title function_">get</span>(), <span class="hljs-variable">len</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L122-L125" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>完整代码如下所示。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L100-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TransferResourceMgr</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">//Convert the incoming resource manager object into a Native object.</span></li><li>    NativeResourceManager *mNativeResMgr = <span class="hljs-built_in">OH_ResourceManager_InitNativeResourceManager</span>(env, argv[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-type">size_t</span> fileNameSize;</li><li>    <span class="hljs-type">char</span> fileNameBuf[BUFFER_SIZE];</li><li>    <span class="hljs-comment">//Convert the passed-in file name into a C-side variable through the Node-API interface.</span></li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], fileNameBuf, <span class="hljs-built_in">sizeof</span>(fileNameBuf), &amp;fileNameSize);</li><li>    <span class="hljs-comment">//Open a file through a resource object</span></li><li>    RawFile *rawFile = <span class="hljs-built_in">OH_ResourceManager_OpenRawFile</span>(mNativeResMgr, fileNameBuf);</li><li>    <span class="hljs-keyword">if</span> (rawFile != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, <span class="hljs-string">"OH_ResourceManager_OpenRawFile success."</span>);</li><li>    }</li><li>    <span class="hljs-comment">//Read the file content through the resource object</span></li><li>    <span class="hljs-type">long</span> len = <span class="hljs-built_in">OH_ResourceManager_GetRawFileSize</span>(rawFile);</li><li>    std::unique_ptr&lt;<span class="hljs-type">char</span>[]&gt; data = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(len);</li><li>    <span class="hljs-built_in">OH_ResourceManager_ReadRawFile</span>(rawFile, data.<span class="hljs-built_in">get</span>(), len);</li><li>    <span class="hljs-built_in">OH_ResourceManager_CloseRawFile</span>(rawFile);</li><li>    <span class="hljs-built_in">OH_ResourceManager_ReleaseNativeResourceManager</span>(mNativeResMgr);</li><li>    napi_value contents;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, data.<span class="hljs-built_in">get</span>(), len, &amp;contents);</li><li>    <span class="hljs-keyword">return</span> contents;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L100-L132" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将该<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">C++接口与ArkTS接口进行绑定和映射</a>，同时在index.d.ts文件中，提供该接口方法。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L26-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">transferResourceMgr</span>: <span class="hljs-function">(<span class="hljs-params">resMgr: resourceManager.ResourceManager, path: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L26-L26" target="_blank">Index.d.ts</a></div></div></div></div> </li></ol> <p>第二部分：Native侧访问Rawfile文件读数据的功能实现后，在ArkTS侧调用该方法。</p> <ol><li>引用Native侧相应的so库。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L23-L25" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">FileAccess</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libfile_access.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L23-L25" target="_blank">Index.ets</a></div></div></div></div> </li><li>在ArkTS侧获取Resource Manager。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L40-L40" data-highlighted="yes"><ol class="linenums"><li>private resMgr: resourceManager.ResourceManager = this.<span class="hljs-built_in">getUIContext</span>().<span class="hljs-built_in">getHostContext</span>()!.resourceManager;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L40-L40" target="_blank">Index.ets</a></div></div></div></div> </li><li>在ArkTS侧调用该接口传递Resource Manager和文件名并读取返回的文件内容。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L93-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> rawfileContext = FileAccess.transferResourceMgr(<span class="hljs-keyword">this</span>.resMgr, FileNameList[<span class="hljs-number">2</span>]);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L93-L93" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <p>通过上述步骤，实现了在Native侧通过ArkTS侧传递的Resource Manager访问与读取应用资源文件的方案。</p> <p><strong>效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图6 </b>ArkTS侧传递resource manager到Native侧方案效果展示</span><br><span><img height="552.5485" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.53212107347129294650768224822564:50001231000000:2800:47BF7291EC5FA80966E3073B87EDC0C341D756485684E10796856453590220F7.png" title="点击放大" width="266"></span></div> <p><span><img originheight="150" originwidth="410" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.94074416134291375315488838695280:50001231000000:2800:AA7EB812A12EC3B63146DC26A60E0B8F21399721D706A01FEBFB671348BD624F.png" width="410" height="150"></span></p> </div> <div class="tiledSection"><h2 id="section155851933125320">访问公共目录文件<i class="anchor-icon anchor-icon-link" anchorid="section155851933125320" tips="复制节点链接"></i></h2><p>系统公共目录下储存的是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/user-file-overview" target="_blank">用户文件</a>，应用对用户文件的操作需要提前获取用户授权，或由用户操作完成。可以通过系统预置的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/select-user-file#选择文档类文件" target="_blank">文件选择器（FilePicker）</a>实现该能力，目前主要有创建文件、写入和读取三类操作，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-picker#save" target="_blank">创建文件</a>可以直接使用picker，针对Native侧，有如下两种场景：</p> <ul><li>场景一：写数据到公共目录文件。</li><li>场景二：从公共目录文件中读取数据。</li></ul> </div> <div class="tiledSection"><h3 id="section104381215105615" class="firsth2">场景一：写数据到公共目录文件<i class="anchor-icon anchor-icon-link" anchorid="section104381215105615" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>ArkTS侧通过文件picker在公共目录下创建文件，并传递文件描述符到Native侧，Native侧通过文件描述符打开文件并将数据写入到文件中。</p> <div class="fignone"><span class="figcap"><b>图7 </b>Native侧写入公共目录文件场景示意图</span><br><span><img originheight="450" originwidth="274" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.24353796256227824201705956829375:50001231000000:2800:A7FC88E2506DBB4FE6DFD05B2E2674FD862596308F64987D2CAD2D1EB97807CF.png" class="notEnlarge" width="274" height="450"></span></div> <p><strong>实现方案</strong></p> <p>实现方案分为Native侧定义操作文件的方法和ArkTS侧调用该方法两部分。</p> <p>第一部分：在Native侧定义一个方法，用于接收文件描述符并将数据写入到文件中，注意使用文件描述符操作文件需要引用头文件unistd.h。</p> <ol><li>将传入的文件描述符和要写入文件的内容通过Node-API接口传递到Native侧。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L144-L146" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Convert the incoming file descriptor and the contents to be written into the file into C-side variables.</span></li><li><span class="hljs-built_in">napi_get_value_uint32</span>(env, argv[<span class="hljs-number">0</span>], &amp;fd);</li><li><span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], contentsBuf, sizeof(contentsBuf), &amp;contentsSize);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L144-L146" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>使用C标准库的文件操作函数写入文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L150-L151" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li><span class="hljs-type">size_t</span> buffSize = <span class="hljs-built_in">write</span>(fd, contentsBuf, contentsSize);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L150-L151" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>根据write函数的返回值判断操作是否成功。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L154-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">res</span>;</li><li><span class="hljs-comment">//According to the return value of the write function, judge whether the operation returns the result successfully. </span></li><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">contents</span>;</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">buffSize</span> == -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-variable">res</span> = <span class="hljs-string">"Write File Failed!"</span>;</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">DOMAIN</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">"%s"</span>, <span class="hljs-variable">res</span>.<span class="hljs-title function_">c_str</span>());</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">res</span> = <span class="hljs-string">"Write File Successfully!!!"</span>;</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">DOMAIN</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">"%s"</span>, <span class="hljs-variable">res</span>.<span class="hljs-title function_">c_str</span>());</li><li>}</li><li><span class="hljs-title function_">napi_create_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">res</span>.<span class="hljs-title function_">c_str</span>(), <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">res</span>), &amp;<span class="hljs-title class_">contents</span>);</li><li><span class="hljs-keyword">return</span> <span class="hljs-variable">contents</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L154-L165" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>完整代码如下所示：<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L135-L167" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">WriteFileUsingPickerFd</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">size_t</span> contentsSize;</li><li>    <span class="hljs-type">char</span> contentsBuf[BUFFER_SIZE];</li><li>    <span class="hljs-comment">//Convert the incoming file descriptor and the contents to be written into the file into C-side variables.</span></li><li>    <span class="hljs-built_in">napi_get_value_uint32</span>(env, argv[<span class="hljs-number">0</span>], &amp;fd);</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, argv[<span class="hljs-number">1</span>], contentsBuf, <span class="hljs-built_in">sizeof</span>(contentsBuf), &amp;contentsSize);</li><li>    <span class="hljs-built_in">ftruncate</span>(fd, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-comment">//Write a file using the file operation function of the C standard library.</span></li><li>    <span class="hljs-type">size_t</span> buffSize = <span class="hljs-built_in">write</span>(fd, contentsBuf, contentsSize);</li><li>    std::string res;</li><li>    <span class="hljs-comment">//According to the return value of the write function, judge whether the operation returns the result successfully. </span></li><li>    napi_value contents;</li><li>    <span class="hljs-keyword">if</span> (buffSize == <span class="hljs-number">-1</span>) {</li><li>        res = <span class="hljs-string">"Write File Failed!"</span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, DOMAIN, TAG, <span class="hljs-string">"%s"</span>, res.<span class="hljs-built_in">c_str</span>());</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        res = <span class="hljs-string">"Write File Successfully!!!"</span>;</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, <span class="hljs-string">"%s"</span>, res.<span class="hljs-built_in">c_str</span>());</li><li>    }</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, res.<span class="hljs-built_in">c_str</span>(), <span class="hljs-built_in">sizeof</span>(res), &amp;contents);</li><li>    <span class="hljs-keyword">return</span> contents;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L135-L167" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将该<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">C++接口与ArkTS接口进行绑定和映射</a>，同时在index.d.ts文件中，提供该接口方法。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L29-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">writeFileUsingPickerFd</span>: <span class="hljs-function">(<span class="hljs-params">fd: <span class="hljs-built_in">number</span>, contents: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L29-L29" target="_blank">Index.d.ts</a></div></div></div></div> </li></ol> <p>第二部分：Native侧访问公共目录文件写数据的功能实现后，在ArkTS侧调用该方法。</p> <ol><li>引用Native侧相应的so库。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L23-L23" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">FileAccess</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libfile_access.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L23-L23" target="_blank">FileOperate.ets</a></div></div></div></div> </li><li>在ArkTS侧拉起picker选择文件并将文件描述符传入Native接口中。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L36-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">WriteFileByPicker</span>(<span class="hljs-params">contents: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-comment">//Configure picker Selection Information</span></li><li>  <span class="hljs-keyword">const</span> documentSelectOptions = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentSelectOptions</span>();</li><li>  documentSelectOptions.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>  documentSelectOptions.<span class="hljs-property">fileSuffixFilters</span> = [<span class="hljs-string">'.txt'</span>];</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  <span class="hljs-keyword">const</span> documentViewPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentViewPicker</span>();</li><li>  <span class="hljs-comment">//Pull up the picker selection file</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> documentViewPicker.<span class="hljs-title function_">select</span>(documentSelectOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">documentSelectResult: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>    uris = documentSelectResult;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span> = uris[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">new</span> fileUri.<span class="hljs-title class_">FileUri</span>(uri).<span class="hljs-property">path</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Open The File path is [<span class="hljs-subst">${uri}</span>]`</span>);</li><li>    <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(path, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span>);</li><li>    <span class="hljs-comment">//Call the native method to write a file</span></li><li>    <span class="hljs-keyword">let</span> res = <span class="hljs-title class_">FileAccess</span>.<span class="hljs-title function_">writeFileUsingPickerFd</span>(file.<span class="hljs-property">fd</span>, contents);</li><li>    fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-keyword">return</span> res;</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Open The file failed, error code is [<span class="hljs-subst">${error.code}</span>], error message is [<span class="hljs-subst">${error.message}</span>]`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'Write Failed by Picker'</span>;</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L36-L59" target="_blank">FileOperate.ets</a></div></div></div></div> </li></ol> <p>通过上述步骤，实现了在Native侧通过ArkTS侧picker传递的文件资源描述符访问公共目录文件并写入内容的方案。</p> <p><strong>效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图8 </b>Native侧写公共目录文件场景方案效果展示</span><br><span><img height="552.5485" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.47782973968929359266581609984835:50001231000000:2800:711E02B58E38ABDA30F3B1EB8CF86C290843C05A1CC0BCF0F69AED2A8276225F.png" title="点击放大" width="266"></span></div> <p><span><img originheight="150" originwidth="731" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.46902732448733787327014846583454:50001231000000:2800:23DED0C41DDC7861A34FE082E621E559D9C0D94D162BCEB737CBB29E5D791EA8.png" width="731" height="150"></span></p> </div> <div class="tiledSection"><h3 id="section5616124410567">场景二：从公共目录文件中读取数据<i class="anchor-icon anchor-icon-link" anchorid="section5616124410567" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>ArkTS侧通过文件picker选择文件，并传递文件描述符到Native侧，Native侧通过文件描述符打开文件并读取文件数据。</p> <div class="fignone"><span class="figcap"><b>图9 </b>Native侧读取公共目录文件场景示意图</span><br><span><img originheight="450" originwidth="273" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.81152139753883650594870925464399:50001231000000:2800:652E8D2A6144DA2C6169883B75B2D97E839309DB26FED92EA8B163B7C4F191C0.png" class="notEnlarge" width="273" height="450"></span></div> <p><strong>实现方案</strong></p> <p>实现方案分为Native侧定义操作文件的方法和ArkTS侧调用该方法两部分。</p> <p>第一部分：在Native侧定义一个方法，用于接收文件描述符并将数据写入到文件中，注意使用文件描述符操作文件需要引用头文件unistd.h。</p> <ol><li>将传入的文件描述符通过Node-API接口传递到Native侧。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L172-L173" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Convert the incoming file descriptor into a C-side variable.</span></li><li><span class="hljs-built_in">napi_get_value_uint32</span>(env, argv[<span class="hljs-number">0</span>], &amp;fd);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L172-L173" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>使用C标准库的文件操作函数读取文件。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L182-L184" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Use the file operation function of the C standard library to read the file.</span></li><li><span class="hljs-type">char</span> buff[READ_SIZE];</li><li><span class="hljs-type">size_t</span> buffSize = <span class="hljs-built_in">read</span>(fd, buff, <span class="hljs-built_in">sizeof</span>(buff));</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L182-L184" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>判断读取是否成功并返回文件内容。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L187-L195" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Judge whether the reading is successful or not and return the file content.</span></li><li>napi_value contents;</li><li>if (buffSize == -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, DOMAIN, TAG, "Read File Failed!!!");</li><li>} else {</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, "Read File Successfully!!!");</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, buff, buffSize, &amp;contents);</li><li>}</li><li>return contents;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L187-L195" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>完整代码如下所示：<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L170-L197" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/FileAccessMethods.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ReadFileUsingPickerFd</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value argv[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-comment">//Convert the incoming file descriptor into a C-side variable.</span></li><li>    <span class="hljs-built_in">napi_get_value_uint32</span>(env, argv[<span class="hljs-number">0</span>], &amp;fd);</li><li>    <span class="hljs-comment">//Use the file operation function of the C standard library to read the file.</span></li><li>    <span class="hljs-type">char</span> buff[READ_SIZE];</li><li>    <span class="hljs-type">size_t</span> buffSize = <span class="hljs-built_in">read</span>(fd, buff, <span class="hljs-built_in">sizeof</span>(buff));</li><li>    <span class="hljs-comment">//Judge whether the reading is successful or not and return the file content.</span></li><li>    napi_value contents;</li><li>    <span class="hljs-keyword">if</span> (buffSize == <span class="hljs-number">-1</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, DOMAIN, TAG, <span class="hljs-string">"Read File Failed!!!"</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, DOMAIN, TAG, <span class="hljs-string">"Read File Successfully!!!"</span>);</li><li>        <span class="hljs-built_in">napi_create_string_utf8</span>(env, buff, buffSize, &amp;contents);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> contents;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/FileAccessMethods.cpp#L170-L197" target="_blank">FileAccessMethods.cpp</a></div></div></div></div> </li><li>将该<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">C++接口与ArkTS接口进行绑定和映射</a>，同时在index.d.ts文件中，提供该接口方法。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L32-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">readFileUsingPickerFd</span>: <span class="hljs-function">(<span class="hljs-params">fd: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/cpp/types/libfile_access/Index.d.ts#L32-L32" target="_blank">Index.d.ts</a></div></div></div></div> </li></ol> <p>第二部分：Native侧访问公共目录文件读数据的功能实现后，在ArkTS侧调用该方法。</p> <ol><li>引用Native侧相应的so库。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L22-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">FileAccess</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libfile_access.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/pages/Index.ets#L22-L26" target="_blank">Index.ets</a></div></div></div></div> </li><li>在ArkTS侧拉起picker选择文件并将文件描述符传入Native接口中。<div class="screenLinkPre"><div _ngcontent-qhi-c106="" class="highlight-div"><div _ngcontent-qhi-c106="" class="highlight-div-header"><div _ngcontent-qhi-c106="" class="highlight-div-header-left"><div _ngcontent-qhi-c106="" class="handle-button expand-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qhi-c106="" class="highlight-div-header-right"><div _ngcontent-qhi-c106="" class="handle-button ai-button"></div><div _ngcontent-qhi-c106="" class="handle-button line-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qhi-c106="" class="handle-button theme-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qhi-c106="" class="handle-button copy-button"><div _ngcontent-qhi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qhi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L62-L84" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ReadFileByPicker</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-comment">//Configure picker Selection Information</span></li><li>  <span class="hljs-keyword">const</span> documentSelectOptions = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentSelectOptions</span>();</li><li>  documentSelectOptions.<span class="hljs-property">maxSelectNumber</span> = <span class="hljs-number">1</span>;</li><li>  documentSelectOptions.<span class="hljs-property">fileSuffixFilters</span> = [<span class="hljs-string">'.txt'</span>];</li><li>  <span class="hljs-comment">//Pull up the picker selection file</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  <span class="hljs-keyword">const</span> documentViewPicker = <span class="hljs-keyword">new</span> picker.<span class="hljs-title class_">DocumentViewPicker</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> documentViewPicker.<span class="hljs-title function_">select</span>(documentSelectOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">documentSelectResult: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> {</li><li>    uris = documentSelectResult;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span> = uris[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> = <span class="hljs-keyword">new</span> fileUri.<span class="hljs-title class_">FileUri</span>(uri).<span class="hljs-property">path</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The Opened File path is [<span class="hljs-subst">${uri}</span>]`</span>);</li><li>    <span class="hljs-keyword">let</span> file = fs.<span class="hljs-title function_">openSync</span>(path, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>    <span class="hljs-comment">//Call the native method to read the file.</span></li><li>    <span class="hljs-keyword">let</span> res = <span class="hljs-title class_">FileAccess</span>.<span class="hljs-title function_">readFileUsingPickerFd</span>(file.<span class="hljs-property">fd</span>);</li><li>    fs.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-keyword">return</span> res;</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Open The file failed, error code is [<span class="hljs-subst">${error.code}</span>], error message is [<span class="hljs-subst">${error.message}</span>]`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'Read Failed by Picker!'</span>;</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeFileAccess/blob/master/entry/src/main/ets/common/utils/FileOperate.ets#L62-L84" target="_blank">FileOperate.ets</a></div></div></div></div> </li></ol> <p>通过上述步骤，实现了在Native侧通过ArkTS侧picker传递的文件资源描述符访问公共目录文件并读取内容的方案。</p> <p><strong>效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图10 </b>Native侧读公共目录文件场景方案效果展示</span><br><span><img height="552.5485" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.72918851969891170225495632523972:50001231000000:2800:BA75EAE35D9EBB22AE95342CB02154016A65909106D12F037D5A19956FADADFC.png" title="点击放大" width="266"></span></div> <p><span><img originheight="150" originwidth="709" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.51238281392774356511572073535223:50001231000000:2800:D0E6C2A8C961811109B079349BE330243F6B5981BBE3F41C212E7F698481F9AA.png" width="709" height="150"></span></p> </div> <div class="tiledSection"><h2 id="section17187194710132">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section17187194710132" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/NativeFileAccess" target="_blank">Native侧实现文件访问</a></li></ul> </div> </div> <div></div></div>