<h1 _ngcontent-adf-c119="" class="doc-title ng-star-inserted" title="Native侧跨HAR/HSP模块接口调用"> Native侧跨HAR/HSP模块接口调用 </h1>

<div _ngcontent-adf-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section209361359184818">概述<i class="anchor-icon anchor-icon-link" anchorid="section209361359184818" tips="复制节点链接"></i></h2><p>在大型应用开发中，应用通常会分为多个业务模块，业务模块常会以HSP或HAR包的形式提供SDK能力，这些SDK往往会提供Native接口给HAP模块的Native层直接调用，从而实现应用的复杂功能。而如何在Native侧跨HAR/HSP模块进行接口调用，是开发者经常遇到的问题。本文将介绍Native侧跨HAR/HSP模块调用两种典型场景，包括调用Native方法和调用ArkTS方法，以方便开发者更好的掌握Native侧跨模块调用的能力。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-cross-module-reference#section470062115417">Native侧跨HAR/HSP模块调用Native方法</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-cross-module-reference#section1485574818153">Native侧跨HAR/HSP模块调用ArkTS方法</a></li></ul> </div> <div class="tiledSection"><h2 id="section8341757171016">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section8341757171016" tips="复制节点链接"></i></h2><p>如图1所示，Native侧跨HAR/HSP模块调用原理主要包括以下步骤。</p> <ol><li>在Module1（HAP）模块中，ArkTS侧通过Node-API调用Native接口。</li><li>Module1（HAP）模块Native侧调用Module2（HSP/HAR）模块Native方法。<ol><li>被调用方<ol class="substepthirdol"><li>在Module2（HSP/HAR）模块中，创建头文件，并在build-profile.json5中配置头文件导出。</li><li>在Module2（HSP/HAR）模块的CMakeLists.txt中进行配置，将源文件配置到so中。</li></ol> </li><li>调用方<ol class="substepthirdol"><li>在Module1（HAP）模块的oh-package.json5文件配置引入Module2（HSP/HAR）模块。</li><li>在Module1（HAP）模块的CMakeLists.txt中，配置引入Module2的so文件。</li><li>引入Module2（HSP/HAR）模块的头文件后，就可以调用Module2（HSP/HAR）模块的Native方法。</li></ol> </li></ol> </li><li>在Module2（HSP/HAR）模块中，Native侧通过Node-API接口进行模块加载，从而调用ArkTS方法。</li></ol> <div class="fignone"><span class="figcap"><b>图1 </b>Native侧跨HAR/HSP模块调用原理图</span><br><span><img height="478.42760000000004" originheight="893" originwidth="993" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.20629759792869853469746610097505:50001231000000:2800:8095E9AF619CD59279FF1418E84ABE2F696A897746EA2F85CCA314BDBA85A04F.png" title="点击放大" width="532"></span></div> </div> <div class="tiledSection"><h2 id="section470062115417">Native侧跨HAR/HSP模块调用Native方法<i class="anchor-icon anchor-icon-link" anchorid="section470062115417" tips="复制节点链接"></i></h2></div> <p>如下图所示，Native侧跨HAR/HSP模块调用Native方法的调用链路为Module1 ArkTS -&gt; Module1 Native -&gt; Module2 Native。在HarmonyOS项目中，Native侧跨模块调用Native方法实际就是C++侧调用，需要配置编译链接依赖。其实现的关键是在Module2（HSP/HAR）模块的build-profile.json5中，配置头文件导出，并在CMakeLists.txt中进行配置，将源文件配置到so中。</p> <div class="fignone"><span class="figcap"><b>图2 </b>Native侧跨HAR/HSP模块调用Native方法</span><br><span><img height="468.5856" originheight="894" originwidth="1015" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.18790946102264882384723521320024:50001231000000:2800:5FA681F3588C8CBC930167623B5808FAFD3D7DDA5626DE5F0E36D01D2B60BA42.png" title="点击放大" width="532"></span></div> <div class="tiledSection"><h3 id="section38391644541" class="firsth2">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section38391644541" tips="复制节点链接"></i></h3><p>Native侧跨HAR/HSP模块调用Native方法时，需要实现Module1（HAP）的ArkTS 侧调用Module1（HSP/HAR）的Native 侧、Module1（HAP）的Native 侧调用Module2（HSP/HAR）的Native 侧。在当前场景下，跨模块调用HAR模块和HSP模块的方式相同，当前以跨模块调用HAR模块为例，详细流程如下所示。</p> <ol><li>开发者需要创建Module2（HAR）模块staticModule，详细创建流程可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-har#section643521083015" target="_blank">创建库模块</a>。</li></ol><ol start="2"><li>在Module2中新建C++文件napi_har.cpp，再新建其头文件napi_har.h，并定义Native方法。<p>napi_har.cpp代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L16-L21" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi_har.h"</span></span></li><li>
</li><li><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">harNativeAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> </span>{</li><li>    <span class="hljs-keyword">return</span> a + b;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L16-L21" target="_blank">napi_har.cpp</a></div></div></div></div> <p>napi_har.h代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.h#L16-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// staticModule\src\main\cpp\napi_har.h</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CROSSMODULEREFERENCE_NAPI_HAR_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CROSSMODULEREFERENCE_NAPI_HAR_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">harNativeAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span></span>;</li><li><span class="hljs-function">napi_value <span class="hljs-title">harArkTSAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span></span>;</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">//CROSSMODULEREFERENCE_NAPI_HAR_H</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.h#L16-L28" target="_blank">napi_har.h</a></div></div></div></div> </li></ol><ol start="3"><li>在Module2中的build-profile.json5中配置头文件导出。如果不做当前headerPath的配置，会导致Module1引用不到Module2的头文件。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/build-profile.json5#L3-L61" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"apiType"</span>: <span class="hljs-string">"stageMode"</span>,</li><li>  <span class="hljs-string">"buildOption"</span>: {</li><li>    <span class="hljs-string">"externalNativeOptions"</span>: {</li><li>      <span class="hljs-string">"path"</span>: <span class="hljs-string">"./src/main/cpp/CMakeLists.txt"</span>,</li><li>      <span class="hljs-string">"arguments"</span>: <span class="hljs-string">""</span>,</li><li>      <span class="hljs-string">"cppFlags"</span>: <span class="hljs-string">""</span>,</li><li>      <span class="hljs-string">"abiFilters"</span>: [<span class="hljs-string">"x86_64"</span>, <span class="hljs-string">"arm64-v8a"</span>]</li><li>    },</li><li>    <span class="hljs-string">"nativeLib"</span>: {</li><li>      <span class="hljs-string">"headerPath"</span>: <span class="hljs-string">"./src/main/cpp"</span></li><li>    },</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/build-profile.json5#L3-L61" target="_blank">build-profile.json5</a></div></div></div></div> </li></ol><ol start="4"><li>在Module2的CMakeLists.txt中配置将源文件打包到so。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/CMakeLists.txt#L15-L16" data-highlighted="yes"><ol class="linenums"><li># staticModule\<span class="hljs-attribute">src</span>\<span class="hljs-selector-tag">main</span>\cpp\CMakeLists<span class="hljs-selector-class">.txt</span></li><li><span class="hljs-built_in">add_library</span>(add SHARED napi_init.cpp napi_har.cpp)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/CMakeLists.txt#L15-L16" target="_blank">CMakeLists.txt</a></div></div></div></div> </li></ol><ol start="5"><li>在Module2模块创建后，需要在Module1的oh-package.json5文件中配置对应的依赖。如下所示，staticModule为新创建的HAR模块的文件名，static_module为HAR模块的名称。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/oh-package.json5#L2-L16" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"entry"</span>,</li><li>  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,</li><li>  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Please describe the basic information."</span>,</li><li>  <span class="hljs-string">"main"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"license"</span>: <span class="hljs-string">""</span>,</li><li>  <span class="hljs-string">"dependencies"</span>: {</li><li>    <span class="hljs-string">"libentry.so"</span>: <span class="hljs-string">"file:./src/main/cpp/types/libentry"</span>,</li><li>    <span class="hljs-string">"static_module"</span>: <span class="hljs-string">"file:../staticModule"</span>,</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/oh-package.json5#L2-L16" target="_blank">oh-package.json5</a></div></div></div></div> </li></ol><ol start="6"><li>在Module1中的CMakeLists.txt中配置so依赖。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/CMakeLists.txt#L17-L18" data-highlighted="yes"><ol class="linenums"><li># <span class="hljs-variable">entry</span>\<span class="hljs-variable">src</span>\<span class="hljs-keyword">main</span>\<span class="hljs-variable">cpp</span>\<span class="hljs-variable">CMakeLists</span>.<span class="hljs-variable">txt</span></li><li><span class="hljs-title function_">target_link_libraries</span>(<span class="hljs-variable">entry</span> <span class="hljs-variable">PUBLIC</span> <span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span> <span class="hljs-variable">static_module</span>::<span class="hljs-title class_">add</span> <span class="hljs-title class_">shared_module</span>::<span class="hljs-title class_">calc</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/CMakeLists.txt#L17-L18" target="_blank">CMakeLists.txt</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>static_module::add中第一个参数static_module是module2的模块名称，第二个参数add是module2编译出来的so名称（不需要带上lib）。默认情况下，module2的模块名称与so名称相同，为了方便说明，在本案例中将so名称修改成了add。</p> </div></div></div> </li></ol><ol start="7"><li>在Module1的napi_init.cpp中导入Module2的头文件napi_har.h，并调用其Native方法harNativeAdd()。</li></ol><ol start="8"><li>在Module1的Native侧调用Module2的invokeHarNative()方法。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L46-L71" data-highlighted="yes"><ol class="linenums"><li>// entry\src\main\cpp\napi_init.cpp</li><li>static napi_value invokeHarNative(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info)</li><li>{</li><li>    size_t argc = 2;</li><li>    napi_value args[2] = {nullptr};</li><li>
</li><li>    napi_get_cb_info(<span class="hljs-built_in">env</span>, info, &amp;argc, args , nullptr, nullptr);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, args[0], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, args[1], &amp;valuetype1);</li><li>
</li><li>    double value0;</li><li>    napi_get_value_double(<span class="hljs-built_in">env</span>, args[0], &amp;value0);</li><li>
</li><li>    double value1;</li><li>    napi_get_value_double(<span class="hljs-built_in">env</span>, args[1], &amp;value1);</li><li>
</li><li>    napi_value <span class="hljs-built_in">sum</span>;</li><li>
</li><li>    napi_create_double(<span class="hljs-built_in">env</span>, harNativeAdd(value0, value1), &amp;<span class="hljs-built_in">sum</span>);</li><li>
</li><li>    <span class="hljs-built_in">return</span> <span class="hljs-built_in">sum</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L46-L71" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol><ol start="9"><li>在Module1的ArkTS侧调用Native侧的invokeHarNative()方法。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/ets/pages/Index.ets#L43-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Button</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.call_har_native_method'</span>))</li><li>  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">12</span> })</li><li>  .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>      <span class="hljs-variable">message</span>: <span class="hljs-string">'HarNative method call succeed, result is '</span> + <span class="hljs-title class_">napi</span>.<span class="hljs-title class_">invokeHarNative</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>).<span class="hljs-title class_">toString</span>()</li><li>    });</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/ets/pages/Index.ets#L43-L51" target="_blank">Index.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section727612286143">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section727612286143" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图3 </b>Native侧调用HAR模块的Native方法</span><br><span><img height="545.965" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.75188877507255579476959834376843:50001231000000:2800:E0490FC965BF32AC40E96880EC9D5A5ACC9F2418FCFD240506A069BD9E5CD0AC.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h2 id="section1485574818153">Native侧跨HAR/HSP模块调用ArkTS方法<i class="anchor-icon anchor-icon-link" anchorid="section1485574818153" tips="复制节点链接"></i></h2><p>如下图所示，Native侧跨HAR/HSP模块调用ArkTS方法是<a href="/consumer/cn/doc/best-practices/bpta-cross-module-reference#section470062115417">Native侧跨HAR/HSP模块调用Native方法</a>的基础上调用ArkTS方法。其关键是在Module2中获取Module1中的上下文napi_env，并根据上下文napi_env加载模块、调用对应的ArkTS方法。</p> <div class="fignone"><span class="figcap"><b>图4 </b>Native侧跨HAR/HSP模块调用ArkTS方法</span><p><span><img height="442.9166" originheight="890" originwidth="1069" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.74445225007342228811785641177861:50001231000000:2800:E90110F23703827FEE6805E46034E4F1865BBB2AA10A07F26116489D51AA0335.png" title="点击放大" width="532"></span></p> </div> </div> <div class="tiledSection"><h3 id="section3835162611167" class="firsth2">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section3835162611167" tips="复制节点链接"></i></h3><p>Native侧跨HAR/HSP模块调用ArkTS方法具体实现方法如下所示。</p> <ol><li>在完成<a href="/consumer/cn/doc/best-practices/bpta-cross-module-reference#section470062115417">Native侧跨HAR/HSP模块调用Native方法</a>后，在Module1中新增invokeHarArkTS()方法以准备调用HAR模块的ArkTS方法。</li><li>在Module2的Native侧，新增setHarEnv()方法，用以传递napi_env，并在头文件中进行配置，代码如下所示。<p>napi_har.h代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.h#L18-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// staticModule\src\main\cpp\napi_har.h</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CROSSMODULEREFERENCE_NAPI_HAR_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> CROSSMODULEREFERENCE_NAPI_HAR_H</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;js_native_api_types.h&gt;</span></span></li><li>napi_env g_main_env;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setHarEnv</span><span class="hljs-params">(napi_env env)</span></span>;</li><li><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">harNativeAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span></span>;</li><li><span class="hljs-function">napi_value <span class="hljs-title">harArkTSAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span></span>;</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">//CROSSMODULEREFERENCE_NAPI_HAR_H</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.h#L18-L26" target="_blank">napi_har.h</a></div></div></div></div> <p>napi_har.cpp代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L25-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// staticModule\src\main\cpp\napi_har.cpp</span></li><li><span class="hljs-keyword">void</span> <span class="hljs-title function_">setHarEnv</span>(<span class="hljs-params">napi_env env</span>) {</li><li>    g_main_env = env;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L25-L28" target="_blank">napi_har.cpp</a></div></div></div></div> </li></ol><ol start="3"><li>在Module1中的napi_init.cpp中的Init()方法中调用setHarEnv()方法将Module1中的napi_env传递到Module2中。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L148-L166" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        { <span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"invokeHarNative"</span>, <span class="hljs-literal">nullptr</span>, invokeHarNative, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"invokeHarArkTS"</span>, <span class="hljs-literal">nullptr</span>, invokeHarArkTS, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"invokeHspNative"</span>, <span class="hljs-literal">nullptr</span>, invokeHspNative, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> },</li><li>        { <span class="hljs-string">"invokeHspArkTS"</span>, <span class="hljs-literal">nullptr</span>, invokeHspArkTS, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span> }</li><li>    };</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-built_in">setHarEnv</span>(env);</li><li>     <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L148-L166" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol><ol start="4"><li>在Module2中创建ArkTS方法，提供给Module2的Native侧调用。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/ets/utils/Util.ets#L17-L20" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// staticModule\src\main\ets\utils\Util.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">return</span> a + b;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/ets/utils/Util.ets#L17-L20" target="_blank">Util.ets</a></div></div></div></div> </li></ol><ol start="5"><li>在Module2模块的build-profile.json5文件中进行以下配置。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/build-profile.json5#L2-L62" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"apiType"</span>: <span class="hljs-string">"stageMode"</span>,</li><li>  <span class="hljs-string">"buildOption"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"arkOptions"</span> : {</li><li>      <span class="hljs-string">"runtimeOnly"</span> : {</li><li>        <span class="hljs-string">"sources"</span>: [</li><li>          <span class="hljs-string">"./src/main/ets/utils/Util.ets"</span></li><li>        ]</li><li>      }</li><li>    }</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/build-profile.json5#L2-L62" target="_blank">build-profile.json5</a></div></div></div></div> </li></ol><ol start="6"><li>在Module2的Native侧调用ArkTS方法，并配置到头文件中。详细步骤如下所示。<ol><li>通过napi_load_module_with_info()加载模块，其中，第二个参数是待加载的ets文件的路径，第三个参数是bundleName+模块名。</li><li>使用napi_get_named_property()获取模块导出的add()方法。</li><li>使用napi_call_function()调用add()方法。</li></ol> <p>napi_har.cpp代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L32-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// staticModule\src\main\cpp\napi_har.cpp</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">harArkTSAdd</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> </span>{</li><li>    napi_env env = g_main_env;</li><li>    napi_value <span class="hljs-keyword">module</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_load_module_with_info</span>(env, <span class="hljs-string">"static_module/src/main/ets/utils/Util"</span>, <span class="hljs-string">"com.example.crossmodulereference/entry"</span>, &amp;<span class="hljs-keyword">module</span>);</li><li>    <span class="hljs-keyword">if</span> (napi_ok != status) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>    }</li><li>    </li><li>    napi_value addFunc;</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, <span class="hljs-keyword">module</span>, <span class="hljs-string">"add"</span>, &amp;addFunc);</li><li>    </li><li>    napi_value addResult;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, a, &amp;argv[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, b, &amp;argv[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-built_in">napi_call_function</span>(env, <span class="hljs-keyword">module</span>, addFunc, <span class="hljs-number">2</span>, argv, &amp;addResult);</li><li>    </li><li>    <span class="hljs-keyword">return</span> addResult;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/staticModule/src/main/cpp/napi_har.cpp#L32-L51" target="_blank">napi_har.cpp</a></div></div></div></div> </li></ol><ol start="7"><li>在module1的Native侧调用module2的harArkTSAdd()方法。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L75-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">invokeHarArkTS</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args , <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">1</span>], &amp;valuetype1);</li><li>
</li><li>    <span class="hljs-type">double</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>
</li><li>    <span class="hljs-type">double</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>    </li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">harArkTSAdd</span>(value0, value1);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/cpp/napi_init.cpp#L75-L96" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol><ol start="8"><li>在Module1的ArkTS侧调用Native侧的invokeHarArkTS()方法。<div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/ets/pages/Index.ets#L55-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">Button</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.call_har_ArkTS_method'</span>))</li><li>  <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)</li><li>  <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)</li><li>  <span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">top</span>: <span class="hljs-number">12</span> })</li><li>  <span class="hljs-selector-class">.onClick</span>(() =&gt; {</li><li>    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.getUIContext</span>()<span class="hljs-selector-class">.getPromptAction</span>()<span class="hljs-selector-class">.showToast</span>({ message: 'HarArkTS method call succeed, result is '</li><li>      + napi.invokeHarArkTS(2, 3).toString() });</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/src/main/ets/pages/Index.ets#L55-L62" target="_blank">Index.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section06791734141618">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section06791734141618" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图5 </b>Native侧调用HAR模块的ArkTS方法</span><br><span><img height="545.965" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.62613148685296398396718392914190:50001231000000:2800:99E4FD24C2175AB053831C9BD64F554769777C57254834E30E16C78F74BC6448.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h2 id="section16599204273615">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section16599204273615" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section9793141413448" class="firsth2">跨HSP模块调用和跨HAR模块调用的区别<i class="anchor-icon anchor-icon-link" anchorid="section9793141413448" tips="复制节点链接"></i></h3><p>HSP模块和HAR模块被调用时，主要的区别在Module2 Native调用Module2 ArkTS中，在调用napi_load_module_with_info加载模块时的入参有一些区别，其他的流程都是一样的。</p> <ol><li>被调用模块Module2是HAR</li></ol> <p>如图所示，编译构建后，HAR模块被打包到各个模块之中，所以其入口模块仍然是HAP模块，napi_load_module_with_info中第2个参数的模块名称要填HAP模块中oh-package.json5中定义的依赖HAR的名称，而不是HAR模块的实际名称。</p> <p><span><img height="178.5525" originheight="291" originwidth="867" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.51168439625904748608102038131133:50001231000000:2800:C20C76DEBE9FB6EFE37E2C8AEC46E09F2131B4B9EFB66E1D73229D1D991D254C.png" title="点击放大" width="532"></span></p> <ol start="2"><li>被调用模块Module2是HSP</li></ol> <p>当被调用模块Module2是HSP，HSP是独立的模块，其入口模块就是HSP本模块，所以napi_load_module_with_info第2个参数的模块名就是它自己的模块名。</p> </div> <div class="tiledSection"><h3 id="section35164441147">是否支持直接依赖HAR模块和HSP模块的三方so（即依赖传递问题）？<i class="anchor-icon anchor-icon-link" anchorid="section35164441147" tips="复制节点链接"></i></h3><p>当前HAR模块和HSP模块都不支持依赖传递。</p> </div> <div class="tiledSection"><h3 id="section1881145011119">多包依赖同一so时，最终打包后的so有多少份？<i class="anchor-icon anchor-icon-link" anchorid="section1881145011119" tips="复制节点链接"></i></h3><p>如果多个HAR模块同时依赖commonHar的so，同一模块的同名so在打包后可以通过覆盖策略只保留一份。</p> <p>如果多个HSP模块同时依赖commonHar的so，在编译构建时，会将依赖的so编译打包到最终的编译产物里，所以每一个.hsp文件都会有一个so。</p> </div> <div class="tiledSection"><h3 id="section1998216512188">报错找不到HAR/HSP模块的ArkTS文件<i class="anchor-icon anchor-icon-link" anchorid="section1998216512188" tips="复制节点链接"></i></h3><p><strong>问题现象</strong></p> <p>调用HAR/HSP模块的ArkTS文件时，可能会遇到以下报错：</p> <div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Error</span> <span class="hljs-variable">message</span>:<span class="hljs-title class_">Cannot</span> <span class="hljs-title class_">find</span> <span class="hljs-title class_">module</span> <span class="hljs-string">'staticModule/src/main/ets/utils/Util'</span> <span class="hljs-title class_">imported</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'com.xxxx.crossmodulereference/entry'</span>.</li></ol></pre></div></div> <p><strong>可能原因</strong></p> <p>可能原因是工程级的build-profile.json5中的useNormalizedOHMUrl设置参数为false。</p> <p><strong>解决措施</strong></p> <p>在调用模块Module1的build-profile.json5里面添加如下配置。</p> <div class="screenLinkPre"><div _ngcontent-adf-c106="" class="highlight-div"><div _ngcontent-adf-c106="" class="highlight-div-header"><div _ngcontent-adf-c106="" class="highlight-div-header-left"><div _ngcontent-adf-c106="" class="handle-button expand-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-adf-c106="" class="highlight-div-header-right"><div _ngcontent-adf-c106="" class="handle-button ai-button"></div><div _ngcontent-adf-c106="" class="handle-button line-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-adf-c106="" class="handle-button theme-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-adf-c106="" class="handle-button copy-button"><div _ngcontent-adf-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-adf-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/build-profile.json5#L2-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-string">"buildOption"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"arkOptions"</span> : {</li><li>      <span class="hljs-string">"runtimeOnly"</span> : {</li><li>        <span class="hljs-string">"packages"</span>: [</li><li>          <span class="hljs-string">"static_module"</span></li><li>        ]</li><li>      }</li><li>    }</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CrossModuleReference/blob/master/entry/build-profile.json5#L2-L54" target="_blank">build-profile.json5</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section358013317252">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section358013317252" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CrossModuleReference" target="_blank">Native侧跨HAR/HSP模块调用</a></li></ul> </div> </div> <div></div></div>