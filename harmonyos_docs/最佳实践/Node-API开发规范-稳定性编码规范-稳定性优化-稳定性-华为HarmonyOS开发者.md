<h1 _ngcontent-nbk-c119="" class="doc-title ng-star-inserted" title="Node-API开发规范"> Node-API开发规范 </h1>

<div _ngcontent-nbk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section56645611461">获取JS传入参数及其数量<i class="anchor-icon anchor-icon-link" anchorid="section56645611461" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>当传入napi_get_cb_info的argv不为nullptr时，argv的长度必须大于等于传入argc声明的大小。</p> <p>当argv不为nullptr时，napi_get_cb_info会根据argc声明的数量将JS实际传入的参数写入argv。如果argc小于或等于实际JS传入参数的数量，该接口仅会将声明的argc数量的参数写入argv；而当argc大于实际参数数量时，该接口会在argv的尾部填充undefined。</p> <p><strong>错误示例</strong></p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IncorrectDemo1</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// The `argc` is not properly initialized, resulting in an indeterminate random value, which may cause the length of `argv` to be less than the number declared by `argc`, leading to data overrun. </span></li><li>    <span class="hljs-type">size_t</span> argc;</li><li>    napi_value argv[<span class="hljs-number">10</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">IncorrectDemo2</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// The number of declared argc exceeds the actual length initialized by argv, causing the napi_get_cb_info interface to write out-of-bounds data when writing to argv. </span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">5</span>;</li><li>    napi_value argv[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>正确示例</strong></p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L54-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetArgvDemo1</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// Argv passes null ptr to obtain the true number of parameters passed in</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// JS input parameter is 0, do not execute subsequent logic</span></li><li>    <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Create an array to retrieve the parameters passed in JS</span></li><li>    napi_value *argv = <span class="hljs-keyword">new</span> napi_value[argc];</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// Business code</span></li><li>    <span class="hljs-comment">// ... ...</span></li><li>    <span class="hljs-comment">// The object created by argv for new is manually released after use</span></li><li>    <span class="hljs-keyword">delete</span>[] argv;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetArgvDemo2</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value argv[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// Napi_get_cf_info will write argc JS parameters or undefined to argv</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-comment">// Business code</span></li><li>    <span class="hljs-comment">// ... ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L54-L81" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section95371713593">生命周期管理<i class="anchor-icon anchor-icon-link" anchorid="section95371713593" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>合理使用napi_open_handle_scope和napi_close_handle_scope管理napi_value的生命周期，做到生命周期最小化，避免发生内存泄漏问题。</p> <p>每个napi_value属于特定的HandleScope。HandleScope通过napi_open_handle_scope和napi_close_handle_scope来建立和关闭。HandleScope关闭后，所属的napi_value会自动释放。</p> <p><strong>正确示例</strong>：</p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L70-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OpenHandleScope</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// When frequently calling the Napi interface to create JS objects in a for loop, handle_stope should be added to promptly release resources that are no longer in use.</span></li><li>    <span class="hljs-comment">// In the following example, at the end of each loop, the lifecycle of the local variable res has ended. Therefore, adding scope to release its held JS objects in a timely manner to prevent memory leakage</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {</li><li>        napi_handle_scope scope = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_open_handle_scope</span>(env, &amp;scope);</li><li>        <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        napi_value res;</li><li>        <span class="hljs-built_in">napi_create_object</span>(env, &amp;res);</li><li>        <span class="hljs-built_in">napi_close_handle_scope</span>(env, scope);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L70-L83" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section710793119594">上下文敏感<i class="anchor-icon anchor-icon-link" anchorid="section710793119594" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>多引擎实例场景下，禁止通过Node-API跨引擎实例访问JS对象。</p> <p>引擎实例是一个独立的运行环境。JS对象的创建和访问操作必须在同一个引擎实例中进行。如果在不同的引擎实例中操作同一个对象，可能会引发程序崩溃。引擎实例在接口中体现为napi_env。</p> <p><strong>错误示例</strong>：</p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="cpp prettyprint linenums hljs language-cpp" hw-language="cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Thread 1 executes, creating a string object in env1 with the value "bar". </span></li><li><span class="hljs-built_in">napi_create_string_utf8</span>(env1, <span class="hljs-string">"bar"</span>, NAPI_AUTO_LENGTH, &amp;string);</li><li><span class="hljs-comment">// Thread 2 executes, creates an object in env2, and sets the aforementioned string object into the object. </span></li><li>napi_status status = <span class="hljs-built_in">napi_create_object</span>(env2, &amp;object);</li><li><span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>    <span class="hljs-built_in">napi_throw_error</span>(env, ...);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li>status = <span class="hljs-built_in">napi_set_named_property</span>(env2, object, <span class="hljs-string">"foo"</span>, string);</li><li><span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>    <span class="hljs-built_in">napi_throw_error</span>(env, ...);</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre></div></div> <p>所有的JS对象都隶属于具体的某一napi_env，不可将env1的对象，设置到env2中的对象中。在env2中一旦访问到env1的对象，程序可能会发生崩溃。</p> <div class="tiledSection"><h2 id="section12887194318596">异常处理<i class="anchor-icon anchor-icon-link" anchorid="section12887194318596" tips="复制节点链接"></i></h2></div> <p><strong>【建议】</strong>Node-API接口调用发生异常需要及时处理，不能遗漏异常到后续逻辑，否则程序可能发生不可预期行为。</p> <p><strong>正确示例</strong>：</p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L88-L109" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ErroHandle</span>(<span class="hljs-params">napi_env env, napi_callback_info info</span>)</span> {</li><li>    napi_value <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>;</li><li>
</li><li>    <span class="hljs-comment">// 1.create object</span></li><li>    napi_status status = napi_create_object(env, &amp;<span class="hljs-built_in">object</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, <span class="hljs-string">"ERROR: "</span>, <span class="hljs-string">"..."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 2.Create attribute values</span></li><li>    status = napi_create_string_utf8(env, <span class="hljs-string">"bar"</span>, NAPI_AUTO_LENGTH, &amp;<span class="hljs-built_in">string</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, <span class="hljs-string">"ERROR: "</span>, <span class="hljs-string">"..."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 3.Set the result of step 2 to the value of the object property foo</span></li><li>    status = napi_set_named_property(env, <span class="hljs-built_in">object</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-built_in">string</span>);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        napi_throw_error(env, <span class="hljs-string">"ERROR: "</span>, <span class="hljs-string">"..."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L88-L109" target="_blank">napi_init.cpp</a></div></div></div></div> <p>如上示例中，步骤1或者步骤2出现异常时，步骤3都不会正常进行。只有当方法的返回值是napi_ok时，才能保持继续正常运行；否则后续流程可能会出现不可预期的行为。</p> <div class="tiledSection"><h2 id="section12599145215597">异步任务<i class="anchor-icon anchor-icon-link" anchorid="section12599145215597" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>当使用uv_queue_work方法将任务抛到JS线程上面执行的时候，对JS线程的回调方法，一般情况下需要加上napi_handle_scope来管理回调方法创建的napi_value的生命周期。</p> <p>使用uv_queue_work方法，不会走Node-API框架，此时需要开发者自己合理使用napi_handle_scope来管理napi_value的生命周期。</p> <p><strong>正确示例</strong>：</p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L113-L153" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">callbackTest</span>(<span class="hljs-variable">CallbackContext</span>* <span class="hljs-variable">context</span>)</li><li>{</li><li>    <span class="hljs-variable">uv_loop_s</span>* <span class="hljs-variable">loop</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_get_uv_event_loop</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, &amp;<span class="hljs-title class_">loop</span>);</li><li>    <span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">uv_work_t</span>;</li><li>    <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">retData</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span> = (<span class="hljs-variable">void</span>*)<span class="hljs-variable">context</span>;</li><li>    <span class="hljs-title function_">uv_queue_work</span>(</li><li>        <span class="hljs-variable">loop</span>, <span class="hljs-variable">work</span>,</li><li>        <span class="hljs-comment">// Please note that uv_queue-work will create a thread and execute the callback function. If developers only</span></li><li>        <span class="hljs-comment">// want to throw tasks to JS threads, it is not recommended to use uv_queue-work to avoid redundant thread</span></li><li>        <span class="hljs-comment">// creation</span></li><li>        [](<span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span>) {</li><li>            <span class="hljs-comment">// Execute some business logic</span></li><li>        },</li><li>        <span class="hljs-comment">// This callback will be executed on the JS thread where the loop is located</span></li><li>        [](<span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span>, <span class="hljs-variable">int</span> <span class="hljs-variable">status</span>) {</li><li>            <span class="hljs-variable">CallbackContext</span>* <span class="hljs-variable">context</span> = (<span class="hljs-variable">CallbackContext</span>*)<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>;</li><li>            <span class="hljs-variable">napi_handle_scope</span> <span class="hljs-variable">scope</span> = <span class="hljs-variable">nullptr</span>;</li><li>            <span class="hljs-title function_">napi_open_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, &amp;<span class="hljs-title class_">scope</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">scope</span> == <span class="hljs-variable">nullptr</span>) {</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span> != <span class="hljs-variable">nullptr</span>) {</li><li>                    <span class="hljs-variable">delete</span> <span class="hljs-variable">work</span>;</li><li>                }</li><li>                <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">callback</span> = <span class="hljs-variable">nullptr</span>;</li><li>            <span class="hljs-title function_">napi_get_reference_value</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>, &amp;<span class="hljs-title class_">callback</span>);</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">retArg</span>;</li><li>            <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">retData</span>, &amp;<span class="hljs-title class_">retArg</span>);</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">ret</span>;</li><li>            <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">callback</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">retArg</span>, &amp;<span class="hljs-title class_">ret</span>);</li><li>            <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>            <span class="hljs-title function_">napi_close_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">scope</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span> != <span class="hljs-variable">nullptr</span>) {</li><li>                <span class="hljs-variable">delete</span> <span class="hljs-variable">work</span>;</li><li>            }</li><li>            <span class="hljs-variable">delete</span> <span class="hljs-variable">context</span>;</li><li>        }</li><li>    );</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L113-L153" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section1466511017014">对象绑定<i class="anchor-icon anchor-icon-link" anchorid="section1466511017014" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>使用napi_wrap接口，如果最后一个参数result传递不为nullptr，需要开发者在合适的时机调用napi_remove_wrap函数主动删除创建的napi_ref。</p> <p>napi_wrap接口定义如下：</p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">napi_wrap</span>(napi_env env, napi_value js_object, <span class="hljs-type">void</span>* native_object, napi_finalize finalize_cb, <span class="hljs-type">void</span>* finalize_hint, napi_ref* result)</li></ol></pre></div></div> <p>当最后一个参数result不为nullptr时，框架会创建一个napi_ref对象，指向js_object。开发者需要管理js_object的生命周期，在合适时机调用napi_remove_wrap删除napi_ref，以便GC正常释放js_object，触发绑定的C++对象native_object的析构函数finalize_cb。</p> <p>根据业务情况，最后一个参数result可以直接传递为nullptr。</p> <p><strong>正确示例</strong>：</p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L157-L173" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NapiWrapTest</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value jsobject, nativeObject;</li><li>    napi_finalize cb;</li><li>    <span class="hljs-comment">// Usage 1: Napi_rap does not need to receive the created napi_ref, and the last parameter is passed as nulliptr.</span></li><li>    <span class="hljs-comment">// The created napi_ref is a weak reference, managed by the system, and does not require manual release by the user</span></li><li>    <span class="hljs-built_in">napi_wrap</span>(env, jsobject, nativeObject, cb, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>
</li><li>    <span class="hljs-comment">// Usage 2: napi_rap needs to receive the created napi_ref, the last parameter is not null ptr, and the returned</span></li><li>    <span class="hljs-comment">// napi_ref is a strong reference that needs to be manually released by the user, otherwise it will cause memory</span></li><li>    <span class="hljs-comment">// leakage</span></li><li>    napi_ref result;</li><li>    <span class="hljs-built_in">napi_wrap</span>(env, jsobject, nativeObject, cb, <span class="hljs-literal">nullptr</span>, &amp;result);</li><li>    <span class="hljs-comment">// When js_order and result are no longer used in the future, promptly call napi_remove-wrap to release result</span></li><li>    <span class="hljs-type">void</span> *nativeObjectResult = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_remove_wrap</span>(env, jsobject, &amp;nativeObjectResult);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L157-L173" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section61861498016">高性能数组<i class="anchor-icon anchor-icon-link" anchorid="section61861498016" tips="复制节点链接"></i></h2></div> <p><strong>【建议】</strong>存储值类型数据时，使用ArrayBuffer代替JSArray来提高应用性能。</p> <p>使用JSArray作为容器储存数据，支持几乎所有的JS数据类型。</p> <p>使用napi_set_element方法对JSArray存储值类型数据（如int32）时，同样会涉及到与运行时的交互，造成不必要的开销。</p> <p>ArrayBuffer进行增改是直接对缓冲区进行更改，性能显著优于使用napi_set_element操作JSArray。</p> <p>在这种场景下，推荐使用napi_create_arraybuffer接口创建 ArrayBuffer 对象。</p> <p><strong>示例：</strong></p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L177-L218" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// The following code uses a regular JSArray as a container, but it only stores data of type int32.</span></li><li><span class="hljs-comment">// But because it is a JS object, it can only be modified using the napi method, resulting in lower performance.</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ArrayDemo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> arrSize = <span class="hljs-number">1000</span>;</li><li>    napi_value jsArr = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_array</span>(env, &amp;jsArr);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arrSize; i++) {</li><li>        napi_value arrValue = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, i, &amp;arrValue);</li><li>        <span class="hljs-comment">// Conventional JSArray uses napi method to read and write arrays, which results in poor performance.</span></li><li>        <span class="hljs-built_in">napi_set_element</span>(env, jsArr, i, arrValue);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> jsArr;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">// Recommended writing style:</span></li><li><span class="hljs-comment">// Taking int32 type data as an example, but the following code uses an ArrayBuffer as the container.</span></li><li><span class="hljs-comment">// Therefore, C/C++methods can be used to directly modify the buffer.</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">ArrayBufferDemo</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> arrSize = <span class="hljs-number">1000</span>;</li><li>    napi_value arrBuffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">void</span>* data = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li>
</li><li>    <span class="hljs-built_in">napi_create_arraybuffer</span>(env, arrSize * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int32_t</span>), &amp;data, &amp;arrBuffer);</li><li>    <span class="hljs-comment">// Data is a null pointer, cancel writing to data</span></li><li>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> arrBuffer;</li><li>    }</li><li>    <span class="hljs-type">int32_t</span>* i32Buffer = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">int32_t</span>*&gt;(data);</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arrSize; i++) {</li><li>        <span class="hljs-comment">// ArrayBuffer directly modifies the buffer, skipping runtime,</span></li><li>        <span class="hljs-comment">// Equivalent in performance to manipulating C/C++objects</span></li><li>        i32Buffer[i] = i;</li><li>    }</li><li>
</li><li>
</li><li>    <span class="hljs-keyword">return</span> arrBuffer;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L177-L218" target="_blank">napi_init.cpp</a></div></div></div></div> <p>napi_create_arraybuffer等同于JS代码中的newArrayBuffer(size)，生成的对象不可直接在TS/JS中读取，需要将其包装为TypedArray或DataView后才能进行读写。</p> <p><strong>基准性能测试结果如下：</strong></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>以下数据为千次循环写入累计数据，为了更清晰地体现出差异，已对设备核心频率进行限制。</p> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.48.1.3.1.1" style="border: none;" valign="top" width="50%"><p>容器类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.48.1.3.1.2" style="border: none;" valign="top" width="50%"><p>Benchmark数据（us）</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" style="border: none;" valign="top" width="50%"><p>JSArray</p> </td> <td class="cellrowborder" style="border: none;" valign="top" width="50%"><p>1566.174</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="50%"><p>ArrayBuffer</p> </td> <td class="cellrowborder" style="border: none;" valign="top" width="50%"><p>3.609</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section104643113110">数据转换<i class="anchor-icon anchor-icon-link" anchorid="section104643113110" tips="复制节点链接"></i></h2></div> <p><strong>【建议】</strong>尽可能的减少数据转换次数，避免不必要的复制。</p> <ul><li><strong>减少数据转换次数：</strong>频繁的数据转换可能导致性能下降，建议通过批量处理数据或使用更高效的数据结构来优化性能。</li><li><strong>避免不必要的数据复制：</strong>数据转换时，使用Node-API提供的接口直接访问原始数据。</li><li><strong>使用缓存：</strong>如果数据在多次转换中都会被使用到，可以考虑使用缓存来避免重复的数据转换，从而减少不必要的计算，提高性能。</li></ul> <div class="tiledSection"><h2 id="section1413915447119">模块注册与模块命名<i class="anchor-icon anchor-icon-link" anchorid="section1413915447119" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong></p> <p>nm_register_func对应的函数需要加上修饰符static，防止与其他so里的符号冲突。</p> <p>模块注册的入口，即使用__attribute__((constructor))修饰函数的函数名需要确保与其他模块不同。</p> <p>模块实现中.nm_modname字段需要与模块名完全匹配，区分大小写。</p> <p><strong>错误示例</strong></p> <p>模块名为nativerender的错误示例：</p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module nativeModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    <span class="hljs-comment">// The function corresponding to nm_register_func was not marked as static. </span></li><li>    .nm_register_func = Init,</li><li>    <span class="hljs-comment">// In the module implementation, if the.nm_modname field does not fully match the module name, it may cause module loading failures in multi-threaded scenarios. </span></li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = <span class="hljs-literal">nullptr</span>,</li><li>    .reserved = { <span class="hljs-number">0</span> },</li><li>};</li><li>
</li><li><span class="hljs-comment">// The entry function name for module registration is RegisterModule, which is prone to conflict with other modules. </span></li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterModule</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;nativeModule);</li><li>}</li></ol></pre></div></div> <p><strong>正确示例</strong>：</p> <p>模块名为nativerender的正确示例：</p> <div class="screenLinkPre"><div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L234-L257" data-highlighted="yes"><ol class="linenums"><li>EXTERN_C_START</li><li><span class="hljs-keyword">static</span> napi_value <span class="hljs-title function_">Init</span><span class="hljs-params">(napi_env env, napi_value <span class="hljs-keyword">exports</span>)</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">exports</span>;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-keyword">static</span> <span class="hljs-type">napi_module</span> <span class="hljs-variable">demoModule</span> <span class="hljs-operator">=</span> {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = nullptr,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li>extern <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-keyword">void</span> <span class="hljs-title function_">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> { napi_module_register(&amp;demoModule); }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NodeAPIDevelopment/entry/src/main/cpp/napi_init.cpp#L234-L257" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section177783381377">正确的使用napi_create_external系列接口创建的JS Object<i class="anchor-icon anchor-icon-link" anchorid="section177783381377" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>napi_create_external系列接口创建的JS对象仅限当前线程使用。跨线程传递（如使用worker的post_message）会导致应用崩溃。若需跨线程传递绑定有Native对象的JS对象，请使用napi_coerce_to_native_binding_object接口。</p> <p><strong>错误示例</strong></p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">MyFinalizeCB</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *finalize_data, <span class="hljs-type">void</span> *finalize_hint)</span> </span>{ <span class="hljs-keyword">return</span>; };</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CreateMyExternal</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_external</span>(env, <span class="hljs-literal">nullptr</span>, MyFinalizeCB, <span class="hljs-literal">nullptr</span>, &amp;result);</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-comment">// The code for module registration has been omitted here; you may need to register the CreateMyExternal method yourself. </span></li></ol></pre></div></div> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">createMyExternal</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span>;</li><li>
</li><li><span class="hljs-comment">// Application Code </span></li><li><span class="hljs-keyword">import</span> testNapi <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { worker } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> mWorker = <span class="hljs-keyword">new</span> worker.<span class="hljs-title class_">ThreadWorker</span>(<span class="hljs-string">'../workers/Worker'</span>);</li><li>
</li><li>{</li><li>    <span class="hljs-keyword">const</span> mExternalObj = testNapi.<span class="hljs-title function_">createMyExternal</span>();</li><li>
</li><li>    mWorker.<span class="hljs-title function_">postMessage</span>(mExternalObj);</li><li>
</li><li>}</li><li>
</li><li><span class="hljs-comment">// Close the worker thread.</span></li><li><span class="hljs-comment">// The application may crash at this step or during subsequent garbage collection by the engine. </span></li><li>mWorker.<span class="hljs-title function_">terminate</span>();</li><li><span class="hljs-comment">// The implementation of Worker is a default template, omitted here. </span></li></ol></pre></div></div> <div class="tiledSection"><h2 id="section470814481876">防止重复释放获取的buffer<i class="anchor-icon anchor-icon-link" anchorid="section470814481876" tips="复制节点链接"></i></h2></div> <p><strong>【规则】</strong>使用napi_get_arraybuffer_info等接口，参数data资源开发者不允许释放，data的生命周期受引擎管理。</p> <p>这里以napi_get_arraybuffer_info为例，该接口定义如下：</p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">napi_get_arraybuffer_info</span>(napi_env env, napi_value arraybuffer, <span class="hljs-type">void</span>** data, <span class="hljs-type">size_t</span>* byte_length)</li></ol></pre></div></div> <p>data获取的是ArrayBuffer的缓冲区头指针，开发者只能在该缓冲区内进行读写操作，不得执行释放操作。该段内存由引擎内部的ArrayBuffer分配器管理，并随JS对象ArrayBuffer的生命周期自动释放。</p> <p><strong>错误示例：</strong></p> <div _ngcontent-nbk-c106="" class="highlight-div"><div _ngcontent-nbk-c106="" class="highlight-div-header"><div _ngcontent-nbk-c106="" class="highlight-div-header-left"><div _ngcontent-nbk-c106="" class="handle-button expand-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nbk-c106="" class="highlight-div-header-right"><div _ngcontent-nbk-c106="" class="handle-button ai-button"></div><div _ngcontent-nbk-c106="" class="handle-button line-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nbk-c106="" class="handle-button theme-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nbk-c106="" class="handle-button copy-button"><div _ngcontent-nbk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nbk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">void</span>* arrayBufferPtr = <span class="hljs-literal">nullptr</span>;</li><li>napi_value arrayBuffer = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-type">size_t</span> createBufferSize = ARRAY_BUFFER_SIZE;</li><li>napi_status verification = <span class="hljs-built_in">napi_create_arraybuffer</span>(env, createBufferSize, &amp;arrayBufferPtr, &amp;arrayBuffer);</li><li><span class="hljs-type">size_t</span> arrayBufferSize;</li><li>napi_status result = <span class="hljs-built_in">napi_get_arraybuffer_info</span>(env, arrayBuffer, &amp;arrayBufferPtr, &amp;arrayBufferSize);</li><li><span class="hljs-keyword">delete</span> arrayBufferPtr; <span class="hljs-comment">// This step is prohibited. The lifecycle of the created arrayBufferPtr is managed by the engine, and users are not allowed to delete it themselves. Otherwise, it may lead to double free. </span></li></ol></pre></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.75.1.2.1.1" style="border: none;" valign="top" width="100%"><p>Node-API中受当前规则约束的接口有：</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_create_arraybuffer</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_create_sendable_arraybuffer</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_get_arraybuffer_info</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_create_buffer</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_get_buffer_info</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_get_typedarray_info</p> </td> </tr> <tr><td class="cellrowborder" style="border: none;" valign="top" width="100%"><p>napi_get_dataview_info</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section18767413820">其他<i class="anchor-icon anchor-icon-link" anchorid="section18767413820" tips="复制节点链接"></i></h2></div> <p><strong>【建议】</strong>合理使用napi_object_freeze和napi_object_seal来控制对象以及对象属性的可变性。</p> <p>napi_object_freeze等同于Object.freeze，冻结后对象的所有属性均无法修改；napi_object_seal等同于Object.seal，密封后对象不可增删属性，但属性值仍可修改。两者的主要区别在于，freeze后属性值不可修改，而seal后属性值仍可修改。</p> <p>使用以上语义时，确保约束条件符合需求。违背语义在严格模式下会抛出Error，默认严格模式。</p> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/NodeAPIDevelopment" target="_blank">Node-API开发规范</a></li></ul> </div> </div> <div></div></div>