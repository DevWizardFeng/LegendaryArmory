<h1 _ngcontent-ihq-c119="" class="doc-title ng-star-inserted" title="Swiper组件加载丢帧优化"> Swiper组件加载丢帧优化 </h1>

<div _ngcontent-ihq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section982822131413">概述<i class="anchor-icon anchor-icon-link" anchorid="section982822131413" tips="复制节点链接"></i></h2><p>在应用开发中，Swiper组件适用于翻页场景，如桌面和图库等应用。当Swiper组件滑动切换页面时，基于按需加载原则，通常在下一个页面即将显示时才进行加载和布局绘制。对于复杂页面场景，该过程可能需要较长时间，导致滑动过程中出现卡顿，影响滑动体验，甚至成为整个应用的性能瓶颈。</p> <p>本文主要介绍Swiper性能优化的相关方法。</p> </div> <div class="tiledSection"><h2 id="section4505135391411">懒加载<i class="anchor-icon anchor-icon-link" anchorid="section4505135391411" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section337503013554" class="firsth2">原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section337503013554" tips="复制节点链接"></i></h3></div> <p><span style="color: rgb(36,41,46);">懒加载从提供的数据源按需迭代数据，并在每次迭代过程中创建相应的组件，Swiper采用懒加载进行数据懒加载，在布局时会根据可视区域按需创建Swiper子组件，并在Swiper子组件滑出可视区域外时销毁以降低内存占用。Swiper组件的开发，属于滑动容器加载的一种场景，其LazyForEach懒加载原理可参考：</span><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-best-practices-long-list#section182645364229">《长列表加载性能优化-懒加载》</a>。</p> <div class="tiledSection"><h3 id="section233416451545">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section233416451545" tips="复制节点链接"></i></h3><p>为了展示Swiper使用ForEach与LazyForEach加载的性能差异，本地模拟答题场景进行测试。</p> <p>Swiper子组件核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/LazyForEachSwiper.ets#L20-L71" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">QuestionSwiperItem</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">itemData</span>: <span class="hljs-title class_">Question</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span> = params.<span class="hljs-property">itemData</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Question</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>?.<span class="hljs-property">title</span>)</li><li>        <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>?.<span class="hljs-property">image</span>)</li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">16</span> }) {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>)</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/LazyForEachSwiper.ets#L20-L71" target="_blank">LazyForEachSwiper.ets</a></div></div></div></div> </div> <p>Swiper主页面核心代码如下：</p> <ul><li>使用ForEach加载页面<div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L12-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(i);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">addData</span>(i, i);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Swiper</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperController</span>) {</li><li>      <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">SwiperItem</span>({ <span class="hljs-attr">myIndex</span>: index })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">5</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L12-L32" target="_blank">SwiperCoreCode.ets</a></div></div></div></div> </li></ul> <ul><li>使用LazyForEach加载页面<div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/LazyForEachSwiper.ets#L93-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Swiper</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperController</span>) {</li><li>  <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: Question</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">QuestionSwiperItem</span>({ <span class="hljs-attr">itemData</span>: item })</li><li>  }, <span class="hljs-function">(<span class="hljs-params">item: Question</span>) =&gt;</span> item.<span class="hljs-property">id</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/LazyForEachSwiper.ets#L93-L97" target="_blank">LazyForEachSwiper.ets</a></div></div></div></div> </li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>当总题量为1000时，ForEach与LazyForEach的性能对比</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.2.5.1.1" valign="top" width="25%"><p>加载方式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.1.2" valign="top" width="25%"><p>完全显示所用时间</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.1.3" valign="top" width="25%"><p>丢帧率</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.2.5.1.4" valign="top" width="25%"><p>独占内存</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>ForEach</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>951ms</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>8.5%</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>200MB</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>LazyForEach</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>280.6ms</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>0.0%</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>25.18MB</p> </td> </tr>  </tbody></table></div> </div> <p>根据实验数据，当Swiper的子组件数量超过100个时，采用懒加载可以提升帧率30%以上，并且减少内存占用20%以上。</p> <div class="tiledSection"><h2 id="section143504547145">缓存数据项<i class="anchor-icon anchor-icon-link" anchorid="section143504547145" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section3912119583" class="firsth2">原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section3912119583" tips="复制节点链接"></i></h3><p>LazyForEach懒加载可以通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-swiper#cachedcount8" target="_blank">cachedCount</a>来指定缓存数量，详细原理参考：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-best-practices-long-list#section11667144010222">《长列表加载性能优化-缓存列表项》</a>。</p> </div> <div class="tiledSection"><h3 id="section15211385813">使用场景<i class="anchor-icon anchor-icon-link" anchorid="section15211385813" tips="复制节点链接"></i></h3><p>如果开发者的应用场景属于加载耗时的场景，尤其是以下场景，推荐使用。</p> <ul><li><span style="color: rgb(73,73,73);">Swiper的子组件具有复杂的动画；</span></li><li><span style="color: rgb(73,73,73);">Swiper的子组件加载时需要执行网络请求等耗时操作；</span></li><li><span style="color: rgb(73,73,73);">Swiper的子组件包含大量需要渲染的图像或资源。</span></li></ul> </div> <div class="tiledSection"><h3 id="section16450155101716">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section16450155101716" tips="复制节点链接"></i></h3><p>案例模拟Swiper子组件包含大量图像资源，前置条件如下：</p> <ul><li>Swiper的子组件包含50个ListItem的List组件；</li><li>每个ListItem加载网络图片；</li><li>Swiper组件共有20个ListItem子组件；</li><li><span style="color: rgb(73,73,73);">一屏显示一个Swiper子组件。</span></li></ul> <p>Swiper子组件核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L43-L74" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">SwiperItem</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">myIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// Construct data</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">imgURL</span>: <span class="hljs-built_in">string</span>[] = <span class="hljs-title class_">Constant</span>.<span class="hljs-property">imgURL</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">push</span>(i);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {</li><li>        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imgURL</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">myIndex</span> * <span class="hljs-number">50</span> + index])</li><li>              .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Contain</span>)</li><li>              .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>              .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>          }</li><li>          .<span class="hljs-title function_">aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>          .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Green</span> })</li><li>        }, <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index.<span class="hljs-title function_">toString</span>());</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L43-L74" target="_blank">SwiperCoreCode.ets</a></div></div></div></div> <p>Swiper主页面核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L82-L109" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">TestCodeTwo</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">dataSrc</span>: <span class="hljs-title class_">NumberDataSource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">NumberDataSource</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">20</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSrc</span>.<span class="hljs-title function_">addData</span>(<span class="hljs-variable">i</span>, <span class="hljs-variable">i</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title function_">Swiper</span>() {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSrc</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">SwiperItem</span>({</li><li>            <span class="hljs-variable">myIndex</span>: <span class="hljs-title class_">index</span></li><li>          });</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>());</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">1</span>)</li><li>      .<span class="hljs-title function_">autoPlay</span>(<span class="hljs-keyword">true</span>)</li><li>      .<span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</li><li>      .<span class="hljs-title function_">duration</span>(<span class="hljs-number">100</span>)</li><li>      <span class="hljs-comment">// ...</span></li><li>    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">5</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCode.ets#L82-L109" target="_blank">SwiperCoreCode.ets</a></div></div></div></div> </div> <p>为了测试不同缓存数量对性能的影响，将 `cachedCount` 的值分别设置为 1、2、4、8。基于案例程序，测试不同缓存数量对帧率和内存占用的影响。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>不同cachedCount数量下的性能数据对比</caption><tbody><tr><th class="firstcol" id="mcps1.3.16.2.6.1.1" valign="top" width="20%"><p>缓存数量</p> </th> <td class="cellrowborder" valign="top" width="20%"><p>1</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>2</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>4</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>8</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.16.2.6.2.1" valign="top" width="20%"><p>丢帧率</p> </th> <td class="cellrowborder" valign="top" width="20%"><p>3.0%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>3.3%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>3.1%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>3.0%</p> </td> </tr> <tr><th class="firstcol" id="mcps1.3.16.2.6.3.1" valign="top" width="20%"><p>独占内存</p> </th> <td class="cellrowborder" valign="top" width="20%"><p>64.36MB</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>117.39MB</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>214.32MB</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>377.38MB</p> </td> </tr>  </tbody></table></div> </div> <p>根据测试结果，随着cachedCount的增加，应用的内存占用呈线性增长，但帧率没有显著提升。</p> <p>在一屏显示一个Swiper子组件的连续滑动场景中，将cachedCount值设置为1或2。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>缓存数量仅供参考，不同的应用程序设置的最佳缓存数量不一致，需要针对应用程序测试得出最佳缓存数量。</p> </div></div></div> <div class="tiledSection"><h2 id="section8783121513246">提前加载数据<i class="anchor-icon anchor-icon-link" anchorid="section8783121513246" tips="复制节点链接"></i></h2></div> <p>在抛滑场景时，Swiper组件有个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-swiper#onanimationstart9" target="_blank">onAnimationStart()</a>回调接口，切换动画开始时触发该回调。此时，切换动画的逻辑在渲染线程中执行，主线程则可以利用这段时间加载子组件所需的资源，如图像和网络资源，减少后续cachedCount范围内的节点预加载耗时。跟手滑动阶段不会触发onAnimationStart回调，只有在离手后进行切换动画时才会触发。</p> <div class="tiledSection"><h3 id="section105391550185214" class="firsth2">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section105391550185214" tips="复制节点链接"></i></h3><p>Swiper子组件：在子组件首次构建(生命周期执行到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttoappear" target="_blank">aboutToAppear()</a>)时，先判断Swiper数据中图片资源是否已经存在，若不存在则先下载图片资源，再构建节点。</p> <div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/PreloadDataSwiper.ets#L37-L85" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PreloadSwiperItem</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'preloadData'</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperData</span>.<span class="hljs-variable">pixelMap</span>) {</li><li>      <span class="hljs-variable">ImageUtils</span>.<span class="hljs-title function_">getPixelMap</span>(<span class="hljs-variable">IMAGE_URL</span>, (<span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">PixelMap</span>) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperData</span>.<span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">pixelMap</span>;</li><li>      });</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDidBuild</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'preloadData'</span>, <span class="hljs-number">1</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Grid</span>() {</li><li>      <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">gridDataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>        <span class="hljs-title function_">GridItem</span>() {</li><li>          <span class="hljs-title function_">ImageItem</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span>, <span class="hljs-variable">swiperData</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">swiperData</span> })</li><li>        }</li><li>      }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">string</span> =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr'</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/PreloadDataSwiper.ets#L37-L85" target="_blank">PreloadDataSwiper.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>打点事件说明，当SwiperItem发生预加载时，会先进入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-page-custom-components-lifecycle" target="_blank">自定义组件生命周期</a>回调aboutToAppear，在aboutToAppear回调中使用startTrace开启打点跟踪，随后会进入build渲染组件，build函数执行完成后进入onDidBuild回调，在该回调中使用finishTrace停止打点追踪。分别使用“noPreLoadData”，“preLoadData”标签统计两种场景下的SwiperItem预加载耗时，关于本例中使用性能打点的介绍，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hitracemeter" target="_blank">性能打点</a>。</p> </div></div></div> <p>Swiper主页面核心代码：</p> <ul><li>不提前加载数据<div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCodeNoPreLoadData.ets#L15-L43" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NoPreLoadData</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">dataSrc</span>: <span class="hljs-title class_">PixelMapDataSource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">PixelMapDataSource</span>();</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">20</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSrc</span>.<span class="hljs-title function_">addData</span>(<span class="hljs-variable">i</span>, []);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title function_">Swiper</span>() {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSrc</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">PixelMap</span>[], <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">SwiperItem</span>({</li><li>            <span class="hljs-variable">myIndex</span>: <span class="hljs-title class_">index</span>,</li><li>            <span class="hljs-variable">dataSource</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">dataSrc</span></li><li>          });</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">index</span>.<span class="hljs-title function_">toString</span>());</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">5</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/SwiperCoreCodeNoPreLoadData.ets#L15-L43" target="_blank">SwiperCoreCodeNoPreLoadData.ets</a></div></div></div></div> </li></ul> </div> <ul><li>提前加载数据<div class="screenLinkPre"><div _ngcontent-ihq-c106="" class="highlight-div"><div _ngcontent-ihq-c106="" class="highlight-div-header"><div _ngcontent-ihq-c106="" class="highlight-div-header-left"><div _ngcontent-ihq-c106="" class="handle-button expand-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ihq-c106="" class="highlight-div-header-right"><div _ngcontent-ihq-c106="" class="handle-button ai-button"></div><div _ngcontent-ihq-c106="" class="handle-button line-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ihq-c106="" class="handle-button theme-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ihq-c106="" class="handle-button copy-button"><div _ngcontent-ihq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ihq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/PreloadDataSwiper.ets#L106-L133" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Swiper</span>() {</li><li>  <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperDataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: SwiperData</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">PreloadSwiperItem</span>({ <span class="hljs-attr">swiperData</span>: item })</li><li>  }, <span class="hljs-function">(<span class="hljs-params">item: SwiperData</span>) =&gt;</span> item.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>())</li><li>}</li><li>.<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">1</span>)</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onAnimationStart</span>(<span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span>, targetIndex: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (targetIndex &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperDataSource</span>.<span class="hljs-title function_">totalCount</span>() - <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-keyword">let</span> swiperData = <span class="hljs-variable language_">this</span>.<span class="hljs-property">swiperDataSource</span>.<span class="hljs-title function_">getData</span>(targetIndex + <span class="hljs-number">2</span>);</li><li>    <span class="hljs-keyword">if</span> (swiperData.<span class="hljs-property">pixelMap</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// Simulation data download</span></li><li>      <span class="hljs-title class_">ImageUtils</span>.<span class="hljs-title function_">getPixelMap</span>(<span class="hljs-variable constant_">IMAGE_URL</span>, <span class="hljs-function">(<span class="hljs-params">pixelMap: PixelMap</span>) =&gt;</span> {</li><li>        swiperData.<span class="hljs-property">pixelMap</span> = pixelMap;</li><li>      });</li><li>    }</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SwiperPerformance/blob/master/entry/src/main/ets/pages/PreloadDataSwiper.ets#L106-L133" target="_blank">PreloadDataSwiper.ets</a></div></div></div></div> </li></ul> <p>性能分析：</p> <p>如图1所示，不使用onAnimationStart回调提前加载数据，通过自定义打点标签“H:noPreLoadData”，可以看出SwiperItem节点的构建耗时50ms左右。</p> <div class="fignone"><span class="figcap"><b>图1 </b>没有提前加载数据的打点信息</span><br><span><img height="169.57500000000002" originheight="411" originwidth="1268" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163434.79138176406554245513731197153980:50001231000000:2800:3E262BD8A221018BA63A9D299627A7843676ACADAD3F1B9E557E4510A356BFCE.png" title="点击放大" width="523.6875"></span></div> <p>如图2所示，采用onAnimationStart回调提前加载数据，通过自定义打点标签“H:preLoadData”，可以看出SwiperItem节点的构建耗时2ms左右。</p> <div class="fignone"><span class="figcap"><b>图2 </b>使用了提前加载数据的打点信息</span><br><span><img height="135.66" originheight="357" originwidth="1369" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163434.62821098705181233845938737170976:50001231000000:2800:EC54DB9CFEF234C61513D51A5E8BE5AA0B6E3B337442B7B393E668B04216D84D.png" title="点击放大" width="523.6875"></span></div> <p>观察“H:noPreLoadData”时间段的详细trace图，可以发现预加载构建SwiperItem时，aboutToAppear生命周期回调加载图片资源占用48毫秒。</p> <div class="fignone"><span class="figcap"><b>图3 </b>“H:noPreLoadData”时间段的trace详细信息</span><br><span><img height="264.33750000000003" originheight="526" originwidth="1040" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163434.54518063247171883753364747188486:50001231000000:2800:834BB915BC544586F6196C14D54782FE29B42509D494073993FBFC5F2F4B89E4.png" title="点击放大" width="523.6875"></span></div> <p>使用onAnimationStart回调接口提前加载后续范围内子组件所需资源，能够减少cachedCount范围内子组件节点的加载时间。</p> <div class="tiledSection"><h2 id="section10363132882518">组件复用<i class="anchor-icon anchor-icon-link" anchorid="section10363132882518" tips="复制节点链接"></i></h2><p>在Swiper翻页场景中，子组件频繁创建和销毁。将子组件封装为自定义组件，并使用@Reusable装饰器修饰，以减少ArkUI框架内部反复创建和销毁节点的开销。</p> <p>详细原理及性能分析参考：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-best-practices-long-list#section36781044162218">《长列表加载性能优化-组件复用》</a>。</p> </div> <div class="tiledSection"><h2 id="section205518093115">总结<i class="anchor-icon anchor-icon-link" anchorid="section205518093115" tips="复制节点链接"></i></h2><p>本文介绍Swiper在复杂页面场景下的注意事项和性能优化方法。</p> <ul><li>使用LazyForEach懒加载，可以针对大量数据实现快速渲染显示，并减少内存占用。</li><li>合理设置cachedCount缓存数据项，预先加载屏幕可视区外的数据缓存。</li><li>在抛滑场景中，可以利用渲染线程和主线程分离，在onAnimationStart接口回调中提前加载子组件所需资源，从而减少后续预加载所需时间。</li><li><span style="color: rgb(48,48,48);">使用@Reusable复用</span>组件，借助RecycleManager从复用池中取出的视图对象，快速绑定新的数据，减少创建、销毁视图带来的性能损耗。</li></ul> </div> <div class="tiledSection"><h2 id="section18571548184811">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section18571548184811" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/SwiperPerformance" target="_blank">优化Swiper组件加载慢丢帧问题</a></li></ul> </div> </div> <div></div></div>