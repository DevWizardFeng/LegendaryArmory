<h1 _ngcontent-wpn-c119="" class="doc-title ng-star-inserted" title="TaskPool使用规范"> TaskPool使用规范 </h1>

<div _ngcontent-wpn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section104mcpsimp">概述<i class="anchor-icon anchor-icon-link" anchorid="section104mcpsimp" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction" target="_blank">任务池（TaskPool）</a>基于池化思想和任务机制，提供了一系列并发API，旨在充分发挥多核CPU的优势，降低主线程负载，提高程序性能。使用TaskPool进行开发需遵守一些规范，并综合业务和并发特性，细分场景使用。违反这些规范可能会导致性能劣化，引起稳定性或者其他非预期的问题。</p> <p>本文就TaskPool错误使用导致的一些诸如应用报错、业务异常、资源消耗过大等问题进行了分析，并总结出了一些使用规范，以帮助开发者更好的使用TaskPool进行应用开发。</p> </div> <div class="tiledSection"><h2 id="section130mcpsimp">TaskPool使用规范<i class="anchor-icon anchor-icon-link" anchorid="section130mcpsimp" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section88003418524" class="firsth2">根据业务场景合理划分项目结构，避免在子线程中直接或间接引入UI<i class="anchor-icon anchor-icon-link" anchorid="section88003418524" tips="复制节点链接"></i></h3></div> <p><strong>场景描述</strong></p> <p>在工程中导入文件和HAR时，某些文件使用了如@Observed、AppStorage等UI装饰器或状态变量，这些UI装饰器或状态变量即使没有被显式调用也可能会被解析执行。然而目前子线程并不支持UI属性，当解析到这些UI装饰器或状态变量时，会抛出异常并返回，导致本模块的解析会被中断。访问这些包含UI的文件中的某些变量时可能会抛出错误：xxx is not initialized ，导致功能失效甚至crash。如下图所示：</p> <p><span><img height="320.322254" originheight="471" originwidth="1232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163018.71165684434752974396747490756404:50001231000000:2800:164B9182C54DB20E4FB99CD22B16C62DBCA3870D121159BFEB4F6EC602DFD710.png" title="点击放大" width="837.9000000000001"></span></p> <p></p> <p>另外在一些复杂项目中，即使本模块未发生改动，也可能由于SDK或其他依赖模块发生变更而导致该问题。此类问题排查起来较为困难，因此推荐在开发和迭代阶段就做好相应的约束和验证。</p> <p><strong>反例</strong></p> <p>实现Foo和Bar类。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/wrong/a.ets#L3-L16" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// a.ets</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">"sampleTag"</span>, <span class="hljs-string">"this is class Foo"</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bar</span> {</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">"sampleTag"</span>, <span class="hljs-string">"this is class Bar"</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/wrong/a.ets#L3-L16" target="_blank">a.ets</a></div></div></div></div> <p>在Sample.ets中import需要使用的类和方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L3-L8" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample1.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Bar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./wrong/a'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Foo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./correct/b'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L3-L8" target="_blank">Sample1.ets</a></div></div></div></div> <p>实现@Concurrent方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L12-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample1.ets</span></li><li>@Concurrent</li><li><span class="hljs-function">function <span class="hljs-title">wrongConcurrentFunc</span>()</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> bar: Bar = <span class="hljs-keyword">new</span> Bar;</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-keyword">let</span> error: BusinessError = e;</li><li>    hilog.error(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'error occur: '</span> + error.message);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L12-L22" target="_blank">Sample1.ets</a></div></div></div></div> <p>在组件的onClick()方法中使用taskpool.execute()调用wrongConcurrentFunc()。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L48-L55" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample1.ets</span></li><li>taskpool.<span class="hljs-title function_">execute</span>(wrongConcurrentFunc)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'execute success'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L48-L55" target="_blank">Sample1.ets</a></div></div></div></div> <p>本例中，在a.ets中声明了2个class（Foo和Bar），其中class Foo被@Observed修饰。当在子线程中尝试new Bar时，解析执行到@Observed会抛出异常，并不会继续执行class Bar的逻辑，导致Bar属于未定义变量，访问时会抛出异常: Bar is not initialized。</p> <p><strong>正例</strong></p> <p>实现@Observed装饰器装饰的类Bar。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/correct/a.ets#L2-L7" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// a.ets</span></li><li>@<span class="hljs-title function_">Observed</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bar</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"Bar"</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/correct/a.ets#L2-L7" target="_blank">a.ets</a></div></div></div></div> <p>实现一个普通的类Foo。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/correct/b.ets#L2-L5" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// b.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/correct/b.ets#L2-L5" target="_blank">b.ets</a></div></div></div></div> <p>在correctConcurrentFunc()方法中创建Foo对象。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L25-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample1.ets</span></li><li>@Concurrent</li><li><span class="hljs-function">function <span class="hljs-title">correctConcurrentFunc</span>()</span> {</li><li>  <span class="hljs-keyword">let</span> foo: Foo = <span class="hljs-keyword">new</span> Foo;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L25-L29" target="_blank">Sample1.ets</a></div></div></div></div> <p>在组件的onClick()方法中使用taskpool.execute()调用correctConcurrentFunc()。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L56-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample1.ets</span></li><li>taskpool<span class="hljs-selector-class">.execute</span>(correctConcurrentFunc);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample1/Sample1.ets#L56-L57" target="_blank">Sample1.ets</a></div></div></div></div> <p>将原先涉及UI的class（此处为Bar）剥离到单独的文件中，子线程再去导入不涉及UI的class（此处为Foo），这样就能确保应用正确运行。这样划分结构有利于提高程序正确性、执行效率和可维护性。</p> <div class="tiledSection"><h3 id="section154031117125416">在长时任务中注册监听事件，避免在非长时任务中使用带有监听性质的接口<i class="anchor-icon anchor-icon-link" anchorid="section154031117125416" tips="复制节点链接"></i></h3></div> <p><strong>场景描述</strong></p> <p>通常监听接口具有长时属性，当在子线程注册监听接口并执行回调事件时，即使当该任务执行返回后，监听接口仍然会生效，并且触发时间不确定。由于TaskPool使能了负载均衡机制，对于非长时任务，会在任务执行完成后尝试回收空闲线程。</p> <p>如果注册了监听接口的子线程已经被释放，而此时其他线程又向该子线程发送事件则会导致功能异常或者未定义行为，比如crash。</p> <p>因此，当开发者有监听需求时，推荐使用长时任务，主动管理任务所在线程的生命周期。</p> <p><span><img height="333.2537870095614" originheight="476" originwidth="1314" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163018.38397844005272351414727973719953:50001231000000:2800:4F53B86242A68D83F2E61715A501195C0E4BE987AD60AC11EAD094207D4F47B5.png" title="点击放大" width="920"></span></p> <p><strong>反例</strong></p> <p>在concurrentFunc()方法中调用httpRequest中的监听方法，监听网络请求结果。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L2-L19" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample2.ets</span></li><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> httpRequest = http.<span class="hljs-title function_">createHttp</span>();</li><li>  httpRequest.<span class="hljs-title function_">on</span>(<span class="hljs-string">'headersReceive'</span>, <span class="hljs-function">(<span class="hljs-params">header: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'header: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(header));</li><li>  });</li><li>
</li><li>  httpRequest.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataEnd'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'No more data in response, data receive end'</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L2-L19" target="_blank">Sample2.ets</a></div></div></div></div> <p>在组件的onClick()方法中使用taskpool.execute()调用concurrentFunc()。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L36-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample2.ets</span></li><li>taskpool.<span class="hljs-title function_">execute</span>(concurrentFunc)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'execute success'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L36-L43" target="_blank">Sample2.ets</a></div></div></div></div> <p>如在上述反例中，在concurrentFunc()中使用了http API，其中on()接口监听headersReceive事件，当相关事件到来时调用回调。从concurrentFunc()的角度来说，注册完on()接口，该任务的逻辑也就完成和返回了。回调如果不调用，执行该任务的线程就一直处于空闲状态。一段时间后，该线程可能会被释放，如果此时headersReceive事件再次到来，就会引起非预期行为。</p> <p><strong>正例</strong></p> <p>在concurrentFunc()方法中调用httpRequest中的监听方法，监听网络请求结果。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L2-L17" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample2.ets</span></li><li><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> httpRequest = http.<span class="hljs-title function_">createHttp</span>();</li><li>  httpRequest.<span class="hljs-title function_">on</span>(<span class="hljs-string">'headersReceive'</span>, <span class="hljs-function">(<span class="hljs-params">header: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'header: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(header));</li><li>  });</li><li>
</li><li>  httpRequest.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataEnd'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'No more data in response, data receive end'</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L2-L17" target="_blank">Sample2.ets</a></div></div></div></div> <p>在组件的onClick()方法中使用taskpool.execute()执行concurrentFunc()方法，并在成功拿到回调结果后中断task。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L52-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample2.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">LongTask</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">LongTask</span>(concurrentFunc);</li><li>taskpool.<span class="hljs-title function_">execute</span>(task)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'receive http msg success.'</span>);</li><li>    taskpool.<span class="hljs-title function_">terminateTask</span>(task);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample2/Sample2.ets#L52-L61" target="_blank">Sample2.ets</a></div></div></div></div> <p>需要根据业务诉求合理选择任务类型。像http类的监听性质的接口适合使用长时任务，同时主动管理任务所在线程的生命周期，在具体逻辑执行完成后调用terminateTask()接口(通常在拿到结果时调用，即await之后或then逻辑里)，释放资源，避免造成执行长时任务的线程长时间不释放。</p> <div class="tiledSection"><h3 id="section71021154125417">使用emitter和LongTask()的组合实现回调场景的通信诉求，避免在回调函数中使用sendData()<i class="anchor-icon anchor-icon-link" anchorid="section71021154125417" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>TaskPool提供了支持TaskPool子线程和宿主线程通信的接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#senddata11" target="_blank">sendData()</a>。作为TaskPool提供的接口，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#senddata11" target="_blank">sendData()</a>能够安全的将子线程的数据传输到宿主线程。</p> <p>然而<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#senddata11" target="_blank">sendData()</a>接口依赖于Task，生命周期同Task一致。考虑到微任务和异步事件的特性，回调函数可能在TaskPool任务结果返回后才会被处理：此时Task可能已经被销毁，如果再去调用依赖Task的接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#senddata11" target="_blank">sendData()</a>是不合理和不安全的。TaskPool在这种情况下会抛出异常，如果这种异常是在任务返回后调用抛出的，还将被遗留在线程中不被处理，因此需避免在回调函数中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#senddata11" target="_blank">sendData()</a>。</p> <p>如果有需要，推荐使用emitter，emitter能够方便地实现宿主线程和子线程之间的双向通信。另外emitter的on()接口具有监听性质，在没有取消注册的情况下，能在任意时间被触发，因此需要在LongTask()中注册。</p> <p><span><img height="384.454455" originheight="473" originwidth="1048" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163019.88878665424589756090484452517303:50001231000000:2800:C3BC97A94A4F5C2292CF0449D20C9FE12D7307E5A36F35AB0A5051A60C6DF086.png" title="点击放大" width="851.865"></span></p> <p><strong>反例</strong></p> <p>实现一个@Concurrent方法，并在其中通过promise异步调用taskpool中的sendData()方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L6-L19" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample3.ets</span></li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">wrongConcurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> promise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</li><li>  promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      taskpool.<span class="hljs-property">Task</span>.<span class="hljs-title function_">sendData</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">warn</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`sendData failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L6-L19" target="_blank">Sample3.ets</a></div></div></div></div> <p>创建一个Task，通过onReceiveData()方法接收taskpool通过sendData()方法发送的数据。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L48-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample3.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(wrongConcurrentFunc);</li><li>task.<span class="hljs-title function_">onReceiveData</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"onReceiveData has been called"</span>);</li><li>})</li><li>taskpool.<span class="hljs-title function_">execute</span>(task)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'receive http msg success.'</span>);</li><li>    taskpool.<span class="hljs-title function_">terminateTask</span>(task);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L48-L60" target="_blank">Sample3.ets</a></div></div></div></div> <p>在上述反例中，使用了异步接口，并在then中使用了sendData()。从执行流来看，wrongConcurrentFunc()会先调用Promise.resolve()生成并返回一个promise。此时，并没有其他可执行逻辑，因此会直接返回，即出了wrongConcurrentFunc()的作用域。之后在执行微任务队列时，then中的回调逻辑会被执行，且不在wrongConcurrentFunc()的作用域中执行，因此会抛出异常：sendData is not called in the concurrent function。</p> <p><strong>正例</strong></p> <p>实现一个@Concurrent方法，并在其中通过emitter()方法发送数据。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L23-L31" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample3.ets</span></li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">correctConcurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> promise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</li><li>  promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"1"</span>, { <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"anonymous"</span> } });</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L23-L31" target="_blank">Sample3.ets</a></div></div></div></div> <p>创建一个LongTask，并在emitter()接收到数据后中断该task。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L69-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample3.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">LongTask</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">LongTask</span>(correctConcurrentFunc);</li><li>emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"1"</span>, <span class="hljs-function">(<span class="hljs-params">data: emitter.EventData</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xff00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"name is : "</span> + data.<span class="hljs-property">data</span>?.<span class="hljs-property">name</span>);</li><li>  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-string">"1"</span>)</li><li>  taskpool.<span class="hljs-title function_">terminateTask</span>(task)</li><li>})</li><li>taskpool.<span class="hljs-title function_">execute</span>(task)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'receive http msg success.'</span>);</li><li>    taskpool.<span class="hljs-title function_">terminateTask</span>(task);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample3/Sample3.ets#L69-L83" target="_blank">Sample3.ets</a></div></div></div></div> <p>正例中仍使用了Promise then的用法，区别于反例，在then的逻辑里使用了emitter()来代替sendData()接口。同时将correctConcurrentFunc()这个任务声明为LongTask()，并使用terminateTask()手动管理生命周期，在实现功能的同时也能够保证程序的正确性。</p> </div> <div class="tiledSection"><h3 id="section6382128018">根据业务场景和性能数据控制并发度<i class="anchor-icon anchor-icon-link" anchorid="section6382128018" tips="复制节点链接"></i></h3></div> <p><strong>场景描述</strong></p> <p>使用TaskPool存在一定执行成本，对于耗时长的任务（同步或者异步回调阶段耗时）可以抛到TaskPool中去执行，而耗时十分短的任务则可以直接放在主线程执行。</p> <p>同时合理划分业务粒度，对于一组相关联的任务，可以使用任务组TaskGroup。等待所有子任务都处理完再继续向下处理，从而保证业务代码整体性和可维护性。对于某些不紧急的查询任务，则可以将这些任务收集起来，在一些较为空闲的时间段再抛到任务池中执行。</p> <p>在合适的场景下也可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#sequencerunner-11" target="_blank">SequenceRunner</a>()等API，以避免短时间内大量任务连续进入任务池，使线程数瞬间提升到最大。主线程连续处理大量任务密集返回时的回调和微任务会阻塞UI，影响用户体验。</p> <p><span><img height="422.330461" originheight="451" originwidth="866" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163019.52881205809714559939647564097308:50001231000000:2800:AA09DA466A8A171B41D2D5EFA48BC65EEB5345C14CEF231DF87FD97EB550842A.png" title="点击放大" width="810.9675000000001"></span></p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample5/Sample5.ets#L2-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample5.ets</span></li><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">imageProcessing</span>(<span class="hljs-params">dataSlice: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-title class_">ArrayBuffer</span> {</li><li>  <span class="hljs-comment">// Step 1: Specific image processing operations and other time-consuming operations.</span></li><li>  <span class="hljs-keyword">return</span> dataSlice;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">histogramStatistic</span>(<span class="hljs-params">pixelBuffer: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// Step 2: Divide into three segments for concurrent scheduling.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">number</span>: <span class="hljs-built_in">number</span> = pixelBuffer.<span class="hljs-property">byteLength</span> / <span class="hljs-number">3</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer1</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">number</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer2</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span> * <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">buffer3</span>: <span class="hljs-title class_">ArrayBuffer</span> = pixelBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-built_in">number</span> * <span class="hljs-number">2</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">group</span>: taskpool.<span class="hljs-property">TaskGroup</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">TaskGroup</span>();</li><li>  <span class="hljs-keyword">try</span> {</li><li>    group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer1);</li><li>    group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer2);</li><li>    group.<span class="hljs-title function_">addTask</span>(imageProcessing, buffer3);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">warn</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`addTask failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  taskpool.<span class="hljs-title function_">execute</span>(group, taskpool.<span class="hljs-property">Priority</span>.<span class="hljs-property">HIGH</span>)</li><li>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// Step 3: Summarize the result array.</span></li><li>    })</li><li>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample5/Sample5.ets#L2-L39" target="_blank">Sample5.ets</a></div></div></div></div> <p>在组件的onClick()方法中调用histogramStatistic()方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample5/Sample5.ets#L56-L58" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample5.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">24</span>);</li><li><span class="hljs-title function_">histogramStatistic</span>(buffer);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample5/Sample5.ets#L56-L58" target="_blank">Sample5.ets</a></div></div></div></div> <p>上例是一段处理图片的代码。在示例中将图片buffer分成3段，使用TaskPool的TaskGroup接口分发一组任务到多个子线程计算，同时接收多个结果，再返回UI线程展示。</p> <div class="tiledSection"><h3 id="section769720122012">正确处理业务逻辑异常情况，避免Task损耗<i class="anchor-icon anchor-icon-link" anchorid="section769720122012" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>在TaskPool并发场景下，调用接口需要保证匹配，例如open()接口和close()接口要对应，使用了setInterval()后也需要调用clearInterval()。如果接口不匹配，在退出阶段可能会有些句柄未正常关闭，这将会导致线程不能被释放。当线程较多时，这种情况对常驻内存会有较大影响。</p> <p>推荐使用try...catch...来处理业务逻辑可能出现的异常。例如当taskpool.execute()传入的参数可能发生异常时，使用外层try...catch...及时捕获，当子线程中的task可能出现异常时，则可以使用.catch进行捕获。</p> <p><strong>例1</strong></p> <p>创建一个@Concurrent方法，并通过setInterval()模拟一个定时任务。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L21-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">correctConcurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    count++;</li><li>    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">10</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"the value has reached the threshold"</span>);</li><li>      <span class="hljs-built_in">clearInterval</span>(id);</li><li>    }</li><li>  }, <span class="hljs-number">1000</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L21-L32" target="_blank">Sample4.ets</a></div></div></div></div> <p>在组件的onClick()方法中通过taskpool执行correctConcurrentFunc()方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L60-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(correctConcurrentFunc);</li><li>taskpool.<span class="hljs-title function_">execute</span>(task)</li><li>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'receive http msg success.'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L60-L68" target="_blank">Sample4.ets</a></div></div></div></div> <p>在子线程使用定时器setInterval()模拟了一个定时任务，当定时条件满足条件后，主动使用clearInterval()将定时器取消，能够保证线程在空闲时能被正常释放。</p> <p><strong>例2</strong></p> <p>创建一个@Observed类，并在@Concurrent方法中传入该类的对象。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L6-L16" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li>@<span class="hljs-title function_">Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"foo"</span></li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">correctConcurrentFunc1</span>(<span class="hljs-variable">foo</span>: <span class="hljs-title class_">Foo</span>) {</li><li>  <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"the id is: "</span> + <span class="hljs-variable">foo</span>.<span class="hljs-variable">id</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L6-L16" target="_blank">Sample4.ets</a></div></div></div></div> <p>在组件的onClick()方法中通过taskpool执行correctConcurrentFunc1()，并通过try...catch...捕获异常。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L77-L90" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">let</span> foo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>();</li><li>  taskpool.<span class="hljs-title function_">execute</span>(correctConcurrentFunc1, foo)</li><li>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'receive http msg success.'</span>);</li><li>    })</li><li>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`execute failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    })</li><li>} <span class="hljs-keyword">catch</span> (e) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">ErrorEvent</span> = e;</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"error info: "</span> + error.<span class="hljs-property">message</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L77-L90" target="_blank">Sample4.ets</a></div></div></div></div> <p>在创建并执行Task时，模拟误传入标注了@Observed的class Foo，构建序列化错误场景。通常对于taskpool抛出的异常，会使用.catch的形式来捕获。但对于taskpool.execute()的序列化逻辑，此时Promise还未被创建，所以也无法被.catch捕获，因此此处使用外层的try...catch...来捕获异常</p> <p><strong>例3</strong></p> <p>实现一个@Concurrent方法，并抛出异常。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L38-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">correctConcurrentFunc2</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">Error</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"TaskPoolThread error"</span>);</li><li>  <span class="hljs-keyword">throw</span> error;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L38-L43" target="_blank">Sample4.ets</a></div></div></div></div> <p>在组件的onClick()方法中通过taskpool执行correctConcurrentFunc2()方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-go" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L99-L102" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample4.ets</span></li><li>taskpool.execute(correctConcurrentFunc2).catch((<span class="hljs-type">error</span>: BusinessError) =&gt; {</li><li>  hilog.<span class="hljs-type">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"error info: "</span> + <span class="hljs-type">error</span>.message);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample4/Sample4.ets#L99-L102" target="_blank">Sample4.ets</a></div></div></div></div> <p>例3中对于子线程抛出的异常，使用了.catch的方式，异常能被正确捕获，打印也符合预期。</p> </div> <div class="tiledSection"><h3 id="section4455731704">ArkTS线程间传递对象遵守序列化<i class="anchor-icon anchor-icon-link" anchorid="section4455731704" tips="复制节点链接"></i></h3></div> <p><strong>场景描述</strong></p> <p>目前序列化支持的数据类型有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/normal-object" target="_blank">普通对象</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arraybuffer-object" target="_blank">ArrayBuffer对象</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/shared-arraybuffer-object" target="_blank">SharedArrayBuffer对象</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/transferabled-object" target="_blank">Transferable对象（NativeBinding对象）</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/sendable-object" target="_blank">Sendable对象</a>五种，不支持代理和Promise等类型。因为序列化导致的失败，日志中会有“taskpool: failed to serialize arguments.”或者 "taskpool: failed to serialize result.”，可以通过过滤ArkCompiler Error日志查看具体类型报错，并根据类型排查代码（返回值的传递同样不支持这些类型）。</p> <p><strong>反例1</strong></p> <p>创建一个@Concurrent方法，动态import一个模块。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L6-L11" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample6.ets</span></li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">returnModule</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./a'</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L6-L11" target="_blank">Sample6.ets</a></div></div></div></div> <p>在组件的onClick()方法中通过taskpool执行returnModule()方法，并通过try...catch...捕获异常。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L41-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample6.ets</span></li><li>taskpool.<span class="hljs-title function_">execute</span>(returnModule).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"error info: "</span> + e.<span class="hljs-property">message</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L41-L44" target="_blank">Sample6.ets</a></div></div></div></div> <p>反例1中尝试动态import加载一个模块，返回到主线程使用，因module不支持序列化，出现报错。</p> <p><strong>反例2</strong></p> <p>创建一个@Concurrent方法，通过Promise异步执行resolve()方法。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L15-L24" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample6.ets</span></li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">returnPromise</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>();</li><li>    }, <span class="hljs-number">1000</span>);</li><li>  })</li><li>  <span class="hljs-keyword">return</span> promise;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L15-L24" target="_blank">Sample6.ets</a></div></div></div></div> <p>在组件的onClick()方法中通过taskpool执行returnModule()方法，并通过try...catch...捕获异常。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L53-L56" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Sample6.ets</span></li><li>taskpool.<span class="hljs-title function_">execute</span>(returnPromise).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">"error info: "</span> + e.<span class="hljs-property">message</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/sample6/Sample6.ets#L53-L56" target="_blank">Sample6.ets</a></div></div></div></div> <p>反例2中尝试返回一个pending状态的promise，目前会被拦截，需要在当前线程完成对promise的操作。</p> <div class="tiledSection"><h2 id="section154mcpsimp">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section154mcpsimp" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1571018337588" class="firsth2">使用TaskPool时不遵循最小化导入原则有什么影响<i class="anchor-icon anchor-icon-link" anchorid="section1571018337588" tips="复制节点链接"></i></h3></div> <p>根据ECMA规范，导入方法和变量的时候，JavaScript运行时会根据开发者指定的入口文件开始深度遍历import链上的每个文件，并先从叶子节点执行文件。每个文件只会运行一次，然后存放在线程缓存中，后续加载可直接获取。</p> <p>对于TaskPool中的concurrentFunc()，虽然使能了精准import机制，在concurrentFunc()的最顶层仅会导入当前执行所需要的模块。但是对于较大的模块或在当前模块内依赖导入的其他模块，在系统侧是无法优化的。</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L2-L14" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a'</span></li><li><span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b'</span></li><li><span class="hljs-keyword">import</span> { c } <span class="hljs-keyword">from</span> <span class="hljs-string">'./c'</span></li><li>
</li><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentFunc</span>(<span class="hljs-params"></span>) {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'value: '</span> + a);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L2-L14" target="_blank">test.ets</a></div></div></div></div> <p>如上面的例子，模块a、b、c虽然都被引用了，但concurrentFunc()中仅仅使用了模块a，因此在TaskPool中执行concurrentFunc()函数，仅有模块a会被解析执行。但a中所有依赖的模块仍然都会被解析执行。</p> <p>另一种常见的情形是导入HAR包，当使用 import { case } from '@ohos/common' 导入时，前端会翻译成 import { case } from '@ohos/common/index'。由于index文件是整个HAR包导出的接口，虽然开发者可能只是想使用其中一个接口，但实际上却执行了整个HAR包(包括HAR包中导入的文件)，导致较大的耗时。虽然这部分耗时在子线程，但是也会对任务的执行耗时和内存产生较大影响。</p> <p>一般来说，在子线程中导入HAR包通常仅是使用其中某些独立的方法，在这种情况下，采用精准导入的方法可以带来比较明显的收益。比如使用import { case } from '@ohos/common/xxx/xxx/case' 来导入具体文件(需要考虑可操作性)，或者将这个方法封装到一个全新的文件，这样仅解析这个单独的文件即可。</p> <p>因此在使用TaskPool时应该遵循最小化导入原则，尤其避免在独立的任务中引入大量不相关文件或者HAR。</p> <div class="tiledSection"><h3 id="section1941218441859">子线程使用同步接口和异步接口有什么差异 ，使用哪种接口比较合适<i class="anchor-icon anchor-icon-link" anchorid="section1941218441859" tips="复制节点链接"></i></h3></div> <p>TaskPool线程池线程的最大数量是有限的，当前策略是maxThreads=CPU核数 -1，因此基于当前的设备，正常情况下线程数上限为11个。当所有线程都被占用时，后续的任务可能不会被及时调度。因此，在工作线程中推荐使用异步接口而非同步接口，在等待I/O时能够及时处理新入队的任务，避免任务池阻塞。</p> <p>以文件系统copy为例，以下提供了同步和异步两种接口。由于文件拷贝比较耗时，推荐在子线程使用异步接口。</p> <p>同步：</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L19-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> srcPath = pathDir + <span class="hljs-string">"/srcDir/test.txt"</span>;</li><li><span class="hljs-built_in">let</span> dstPath = pathDir + <span class="hljs-string">"/dstDir/test.txt"</span>;</li><li>
</li><li>fs.copyFileSync(srcPath, dstPath);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L19-L22" target="_blank">test.ets</a></div></div></div></div> <p>异步：</p> <div class="screenLinkPre"><div _ngcontent-wpn-c106="" class="highlight-div"><div _ngcontent-wpn-c106="" class="highlight-div-header"><div _ngcontent-wpn-c106="" class="highlight-div-header-left"><div _ngcontent-wpn-c106="" class="handle-button expand-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wpn-c106="" class="highlight-div-header-right"><div _ngcontent-wpn-c106="" class="handle-button ai-button"></div><div _ngcontent-wpn-c106="" class="handle-button line-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wpn-c106="" class="handle-button theme-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wpn-c106="" class="handle-button copy-button"><div _ngcontent-wpn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wpn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L8-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-keyword">let</span> srcPath = pathDir + <span class="hljs-string">"/srcDir/test.txt"</span>;</li><li><span class="hljs-keyword">let</span> dstPath = pathDir + <span class="hljs-string">"/dstDir/test.txt"</span>;</li><li>fs.<span class="hljs-title function_">copyFile</span>(srcPath, dstPath, <span class="hljs-number">0</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'copy file succeed'</span>);</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-string">'sampleTag'</span>, <span class="hljs-string">'copy file failed with error message: '</span> + err.<span class="hljs-property">message</span> + <span class="hljs-string">', error code: '</span> + err.<span class="hljs-property">code</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/TaskPoolPractice/entry/src/main/ets/pages/test.ets#L8-L34" target="_blank">test.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section5857132062">使用Sendable传输数据与使用深拷贝传输数据有什么差异<i class="anchor-icon anchor-icon-link" anchorid="section5857132062" tips="复制节点链接"></i></h3><p>默认情况下，Sendable数据被分配在共享堆SharedHeap中，其在ArkTS并发实例间是通过引用传递数据。区别于深拷贝的方式，在trace上的直观表现是序列化和反序列化的时间明显减少，因此非常适用于性能敏感的场景。</p> <p>比如从网络数据库获取数据，可以将获取数据的逻辑改造到子线程中，并将期望获取的业务模型声明为Sendable。子线程中获取到JSON数据、转换并生成模型数据后，通过Sendable以引用的方式传回到主线程，这样能显著减少主线程的负载。</p> <p>另外由于子线程不支持UI属性，放入子线程的数据需要同UI剥离出来，返回的数据需要使用合理的方式同UI结合并渲染。对于这种Sendable对象和UI的组合使用可以参考ArkUI的新特性<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-makeobserved" target="_blank">makeObserved</a>。将makeObserved和@Sendable配合使用满足了应用开发中，在子线程做大数据处理，在UI线程做ViewModel的显示和观察数据的需求。</p> <p>此外，Sendable特性支持共享模块。对于一些工具类单例，由于线程隔离的特性，需要在子线程调用时使用Init重新初始化一次。在使用共享模块后，可以保证多线程内共享一个单例，优化写法，提升易用性。对一些耗时的SDK，如果能使用共享模块，也可以将初始化阶段下沉到子线程，主线程使用的时候将不用重新初始化相关模块，能够有效提升性能。</p> </div> <div class="tiledSection"><h3 id="section1370720320610">Napi回调耗时长如何处理<i class="anchor-icon anchor-icon-link" anchorid="section1370720320610" tips="复制节点链接"></i></h3><p>ArkTS的执行是在单线程中进行的，这意味着异步函数不会自己创建线程。 即使用了TaskPool，任务在任务池的子线程执行，但是结果逻辑是需要返回到任务的宿主线程处理的。</p> </div> <p>一般来说，对于异步任务，开发者在ArkTS线程调用接口，对应接口会返回promise并挂起，异步逻辑则在工作线程中执行。异步逻辑执行完成后，通过线程间通信机制把结果返回到ArkTS线程。回到ArkTS线程后对应的Trace表示为Napi complete，在这一阶段会调用napi_resolve_deferred。</p> <p>当Promise状态变为Fulfield之后会执行微任务队列，即执行开发者定义的await之后的逻辑或者then的逻辑。这段耗时和微任务的逻辑和数量密切相关，Napi complete的Trace也会统计这段耗时。这段耗时并不是系统造成的，而是开发者自己的代码的耗时。如果耗时较长，例如在forEach里对返回的数据做复杂的加工处理，渲染UI等，可能会有掉帧的风险。</p> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/TaskPoolPractice" target="_blank">TaskPool使用规范</a></li></ul> </div> </div> <div></div></div>