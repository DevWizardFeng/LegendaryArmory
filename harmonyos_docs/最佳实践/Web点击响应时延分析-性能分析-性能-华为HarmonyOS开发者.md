<h1 _ngcontent-sqs-c119="" class="doc-title ng-star-inserted" title="Web点击响应时延分析"> Web点击响应时延分析 </h1>

<div _ngcontent-sqs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="p">下图为在ArkTS侧使用Web组件加载Web页面时的效果。当用户点击字块后，动画效果延迟较长时间才触发。点击操作响应时延的性能指标衡量起点为用户点击应用元素的时间，终点为应用界面开始发生变化的时间，变化时间应控制在100ms以内，以确保操作响应及时，维护用户流畅体验。开发者可以通过录屏辅助测试，使用DevEco Profiler工具量化点击响应时延，判断是否存在需要优化的问题。<div class="fignone"><span class="figcap"><b>图1 </b>场景动画</span><br><span><img height="600.0827" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163407.07833003827924518476811204793678:50001231000000:2800:56F76C5EFBECEC7B92DB74CBD04A006FC87B7EE361F06ECFAB66AEE155A98059.gif" title="点击放大" width="292.6"></span></div> </div> <div class="tiledSection"><h2 id="section1211162513314">问题定位流程<i class="anchor-icon anchor-icon-link" anchorid="section1211162513314" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section128316392035" class="firsth2">Web网页整体加载流程与关键Trace点<i class="anchor-icon anchor-icon-link" anchorid="section128316392035" tips="复制节点链接"></i></h3></div> <div class="fignone"><span class="figcap"><b>图2 </b>Web网页整体加载泳道图</span></div> <p><span><img height="314.21250000000003" originheight="2032" originwidth="3380" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163407.44822454604889915286019390269086:50001231000000:2800:938077240B74A2C684306EF896C8F3EC11A22E95BE06AC1D664E8F2E14270694.png" title="点击放大" width="523.6875"></span></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.1" valign="top" width="48.809999999999995%"><p>Web网页加载流程拆解</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.1.3.1.2" valign="top" width="51.190000000000005%"><p>关键Trace</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>点击事件</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>最后一个DispatchTouchEvent到组件初始化前</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>Web组件初始化</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>NWebImpl|CreateNWeb到导航流程前</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>导航流程</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>NavigationControllorImpl::LoadURLWithParams到NavigationBodyLoader::OnStartLoadingResponseBody结束</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>DOM&amp;CSS解析</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>CSSParserImpl::parseStyleSheet和ParseHTML解析，扣除HTMLDocumentParser::RunScriptsForPausedTreeBuilder</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>JS编译+执行</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>EvaluateScript 和 v8.callFunction</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>等待网络资源下载</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>render主线程ThrottlingURLLoader::OnReceiveResponse前的空闲</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>点击响应结束点</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>NotifyFrameSwapped，UnloadOldFrame/第一个SkiaOutputSurfaceImplOnGpu::SwapBuffers</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>绘制</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>ThreadProxy::BeginMaiFrame扣除v8执行</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>光栅化&amp;合成</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>从ProxyImpl::NotifyReadyToCommitOnImpl开始到SwapBuffers结束</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="48.809999999999995%"><p>完成时延结束</p> </td> <td class="cellrowborder" valign="top" width="51.190000000000005%"><p>最后一个SkiaOutputSurfaceImplOnGpu::SwapBuffers</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section16693115665">使用DevEco Profiler工具抓取Trace<i class="anchor-icon anchor-icon-link" anchorid="section16693115665" tips="复制节点链接"></i></h3><p>使用Profiler工具分析卡顿和丢帧场景的方法可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-insight-session-frame" target="_blank">Frame分析</a>。对于响应时延类问题，首先确认响应的起止点，确定区域位置和具体操作。</p> </div> <ol><li>确认起点：如果是由点击触发，则首先定位到应用侧的DispatchTouchEvent，如下图虚线所示：<div class="fignone"><span class="figcap"><b>图3 </b>Trace起点</span><p><span><img height="205.939195" originheight="862" originwidth="2192" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.01683566012492608786870717223014:50001231000000:2800:390C03070F834AAFE73850CA3B24BA43F11E561605916E4C0ED7B2A50F279E54.png" title="点击放大" width="523.6875"></span></p> </div> </li><li>确认终点：选择连续稳定发出的第一帧vsync信号作为终点，而非不稳定vsync信号，是因为非连续的vsync信号不一定触发界面上的渲染行为。本文旨在分析从应用元素点击到应用界面开始变化的点击时延问题，因此选择连续稳定渲染的第一帧vsync信号作为终点。<div class="fignone"><span class="figcap"><b>图4 </b>Trace终点</span><p><span><img height="206.178063" originheight="863" originwidth="2192" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.84339287480002308707460646628191:50001231000000:2800:66D98BE065EB5C33DEBF8B3AFB8C593DE8D49A09E8B865AA6C7B623137BFA470.png" title="点击放大" width="523.6875"></span></p> </div> <p>从图中可以看出，后续动画已经达到最大帧率，说明无响应发生在图中区域内。</p> </li><li>分析中途出现的H:ReceiveVsync信号可以发现，在无响应阶段出现了几帧，但每帧的耗时并不长。应用侧也是如此，说明在UI绘制过程中没有高负载。<div class="fignone"><span class="figcap"><b>图5 </b>Trace帧率分析</span><p><span><img height="206.8948" originheight="866" originwidth="2192" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.59212571761707884862251850412478:50001231000000:2800:A367EA28C8BC4F1970DFD63A4374AC3CE5E79B3756956B594B46E1D297E4FB56.png" title="点击放大" width="523.6875"></span></p> </div> </li><li>在此过程中，应用长时间占用CPU，原因可能是进行了大量的计算。<div class="fignone"><span class="figcap"><b>图6 </b>可能耗时原因</span></div> <p><span><img height="206.8948" originheight="866" originwidth="2192" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.31206884462476327835647602446438:50001231000000:2800:5E253EEA79969CF8BCBF9E01E3F9DF1B69259B026D679578AA34C2A2E1F81216.png" title="点击放大" width="523.6875"></span></p> </li></ol> <p>经过前面的分析，应用侧发现Web侧可能产生了大量计算。此时，需要使用Devtools工具进行进一步分析。</p> <div class="tiledSection"><h3 id="section5453717664">使用Devtools进行分析<i class="anchor-icon anchor-icon-link" anchorid="section5453717664" tips="复制节点链接"></i></h3><p>参考此链接使用Devtools调试前端页面：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-debugging-with-devtools" target="_blank">使用Devtools工具调试前端页面</a>。</p> <p>抓取的DevTools泳道图如下图所示，本章节分析可能发生的异常区域：</p> </div> <div class="fignone"><span class="figcap"><b>图7 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.64017703899761513764004485282511:50001231000000:2800:C602F24CB71C5B1CA107AE7023372A386710854045C059B92A3259830036FA29.png" title="点击放大" width="523.6875"></span></div> <ul><li>区域1:   该处为起点，输入Event搜索点击事件。</li><li>区域2：该处为组件加载区域，主要是JS执行。</li><li>区域3：该处为响应终点，Frame泳道第一帧送显。</li><li>区域4：该区域为动画区域，负责执行动画。</li><li>区域5：该区域为空白，通常是由于setTimeout等延迟函数导致。</li></ul> <p>由于此页面不涉及网络交互，因此未标记网络区域等部分区域，后续将提供示例。</p> <div class="tiledSection"><h2 id="section92431391469">常见问题分析实例<i class="anchor-icon anchor-icon-link" anchorid="section92431391469" tips="复制节点链接"></i></h2><p>在H5页面点击切换场景中，Web组件已初始化，点击事件由Web内部处理。该过程主要发生在下图的1、2、3、4区域。</p> <div class="fignone"><span class="figcap"><b>图8 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.76467280120018473682154051345569:50001231000000:2800:A587AA0AFFD3BE58E5DDAA5DA0936FCDA239750635B2E07BDCD987440C60D09A.png" title="点击放大" width="523.6875"></span></div> <p>当点击时会执行以下流程：</p> </div> <ol><li>Web导航等待主页面渲染出第一个非空白帧。</li><li>主页面主资源下载解析渲染，之后子资源交错下载解析渲染。</li><li>主资源渲染完成，若为非空白帧，唤起导航动画，页面响应。</li><li>主资源渲染完成，若为空白帧，Web会丢弃，后续子资源渲染出的第一个非空白帧，唤起导航动画，页面响应。</li></ol> <p>响应慢通常由以下原因导致：</p> <ol><li>主资源渲染组件结构复杂，耗时较高。</li><li>主资源为空，子资源动态加载，导致第一帧显示延迟。</li></ol> <p>本文将分别介绍组件加载异常、网络异常、动画异常和空白区域异常。</p> <div class="tiledSection"><h3 id="section19602381071" class="firsth2">组件加载区域异常分析<i class="anchor-icon anchor-icon-link" anchorid="section19602381071" tips="复制节点链接"></i></h3><p>对应下图中的区域2：可以记录此段内容的加载耗时。</p> <div class="fignone"><span class="figcap"><b>图9 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.99409403473701172882760783747919:50001231000000:2800:6417837E861004992B8AA29CDFD2F99E0ABE110E7C7CBDC28FC54DC46A57874B.png" title="点击放大" width="523.6875"></span></div> <p>此处异常点通常为：</p> </div> <ol><li>区域耗时较长，例如区域2耗时约290ms，是一个优化点。</li><li>多个区域涉及加载渲染组件，这可能是动态加载组件，时延较高。此时，可以观察到大量调用的myFun1，点击左下方可跳转到源码：    </li></ol> <div class="fignone"><span class="figcap"><b>图10 </b>DevTools泳道图区域划分</span><br><span><img height="356.477107" originheight="1196" originwidth="1757" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.45528214566030887772908847709120:50001231000000:2800:A84B0EEE32D9AC30D42B062493F2401281BD316DA66BDE3B37147A6F56D9A360.png" title="点击放大" width="523.6875"></span></div> <p>源码耗时如下图所示：</p> <div class="fignone"><span class="figcap"><b>图11 </b>源码耗时</span><p></p> </div> <p><span><img height="461.526226" originheight="536" originwidth="609" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.51913167632620133525682638886513:50001231000000:2800:057C0337FCC2B5AFBE517B75EE0E16BB0F1EEAFAEAA9A9A228FEBF390C3AE9A5.png" title="点击放大" width="523.6875"></span></p> <p>如图所示，源码处会显示具体方法的耗时。此时可以发现myFun1方法采用了递归，大幅增加了CPU的运算耗时，导致响应延时。将递归方法myFun1优化为循环方法myFun2，时间复杂度从O(2^n)降低到O(n)，在该场景下能显著减少耗时。经测试，myFun2的实际耗时在微秒级别，无法使用DevTools工具统计，建议使用其他方法进行函数耗时统计分析。</p> <div class="tiledSection"><h3 id="section1093613298714">网络区域异常分析<i class="anchor-icon anchor-icon-link" anchorid="section1093613298714" tips="复制节点链接"></i></h3><p>网络耗时占比异常通常发生在响应阶段，表现为网络请求完成后执行JavaScript或任务时阻塞线程，导致整体耗时显著增加。具体见图中的区域2：</p> <div class="fignone"><span class="figcap"><b>图12 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.00469042941226055452593260676000:50001231000000:2800:5F39C45CCC4687BE48044DA1ADC98258E4D233162E5767FEC43B8002D74891AE.png" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h3 id="section118006379712">动画区域异常分析<i class="anchor-icon anchor-icon-link" anchorid="section118006379712" tips="复制节点链接"></i></h3><p>如果区域4中测试的响应时间的Trace起点到终点的时间相差很大，动画区域可能会出现异常。常见的异常包括页面背景色为透明，动画曲线呈现先慢后快的特点，导致动画弹出起点时透明色视觉上没有变化。</p> <div class="fignone"><span class="figcap"><b>图13 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.66061879936542324699300084593348:50001231000000:2800:DB633D756C6C3C1418D08B716F13A0E9108DD831064EB5253CA4F57C2FEEE073.png" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h3 id="section1853014612710">空白区域异常分析<i class="anchor-icon anchor-icon-link" anchorid="section1853014612710" tips="复制节点链接"></i></h3><p>对应下图中的区域5：</p> <div class="fignone"><span class="figcap"><b>图14 </b>DevTools泳道图区域划分</span><br><span><img height="380.242744" originheight="1336" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.84641600192582506941020502662967:50001231000000:2800:4B9F5D76E5A7029D30478D5603D59778C0394D4E7081CFBCEC453D19CF1FCA3E.png" title="点击放大" width="523.6875"></span></div> <p> 此处的异常点通常为：</p> </div> <ol><li>网络请求时间过长，导致页面元素无法及时渲染显示。</li><li>定时器等待后，可在空白区域找到与定时器相关的函数执行。</li></ol> <p>发现代码中有await delayFun(500)这种定时器延迟函数，优化方法是移除冗余延迟函数。</p> <div class="p">经过上述分析步骤的优化，此时再次调用DevTools进行分析：<div class="fignone"><span class="figcap"><b>图15 </b>优化后的泳道图</span><br><span><img height="384.0375" originheight="909" originwidth="1239" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163408.00897400128473225737062642542308:50001231000000:2800:127DF8D29E70769CFCE7337F33F985D9C908318A37CAB819035226E0A642EA83.png" title="点击放大" width="523.6875"></span></div> </div> <p>可以看出耗时明显减少，回归正常水平。</p> <div class="tiledSection"><h2 id="section5681859487">总结<i class="anchor-icon anchor-icon-link" anchorid="section5681859487" tips="复制节点链接"></i></h2><p>通过以上步骤，使用录屏、Trace工具和DevTools分析，可以定位并解决Web页面点击响应时延问题。</p> </div> </div> <div></div></div>