<h1 _ngcontent-ltq-c119="" class="doc-title ng-star-inserted" title="Web组件拦截能力的使用"> Web组件拦截能力的使用 </h1>

<div _ngcontent-ltq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section16819426474">概述<i class="anchor-icon anchor-icon-link" anchorid="section16819426474" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/web-component-overview?ha_source=sousuo&amp;ha_sourceId=89000251" target="_blank">ArkWeb</a>（方舟Web）提供的Web组件支持在应用嵌入网页访问功能。在实际使用过程中，网页内的大量图片、视频等静态资源容易造成用户流量消耗过快，同时，嵌入的恶意脚本也会拖慢网页加载速度，影响用户体验。为此，可以利用Web组件的拦截能力，使用本地资源副本替换高频访问的静态资源，并基于黑名单机制拦截恶意脚本的加载，从而有效提升网页加载效率，优化用户体验。</p> <p>ArkWeb提供了多种拦截能力，使开发者能够监控、修改和记录网络请求及其响应，有助于实现业务功能的自定义与性能提升等。这些能力在拦截时机、拦截范围和拦截效果等方面存在差异，因此适用于不同的开发场景。本文将介绍三种基于Web组件的拦截方案，并提供各方案在典型应用场景中的实例，帮助开发者更好地掌握ArkWeb拦截能力的选择和使用。</p> </div> <div class="tiledSection"><h2 id="section38931232698">原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section38931232698" tips="复制节点链接"></i></h2><p>应用可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onloadintercept10" target="_blank">onLoadIntercept()</a>接口拦截Web组件的页面跳转，或通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()</a>接口和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>机制拦截Web组件发起的网络请求。这三种拦截方案存在一定的差异，以下为具体原理和使用场景介绍。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>三种Web组件的拦截方案</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.1.1" valign="top"><p>使用场景</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.1.2" valign="top"><p>页面跳转控制</p> </th> <th align="left" class="cellrowborder" colspan="2" id="mcps1.3.2.3.2.5.1.3" valign="top"><p>网络请求拦截</p> </th> </tr> <tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.2.1" valign="top" width="11.47%"><p>方案</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.2.2" valign="top" width="28.680000000000007%"><p>onLoadIntercept</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.2.3" valign="top" width="28.480000000000004%"><p>onInterceptRequest</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.2.5.2.4" valign="top" width="31.370000000000005%"><p>WebSchemeHandler</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="11.47%"><p>典型应用场景</p> </td> <td class="cellrowborder" valign="top" width="28.680000000000007%"><ul><li><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-web-app-jump-and-pull-up" target="_blank">应用的跳转与拉起</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section103591931490">请求重定向</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section1367693510110">页面白名单配置</a></li></ul> </td> <td class="cellrowborder" valign="top" width="28.480000000000004%"><ul><li><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section29637307122">本地资源替换</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section766911191316">自定义资源加载策略</a></li><li>提示恶意请求</li></ul> </td> <td class="cellrowborder" valign="top" width="31.370000000000005%"><p>除支持onInterceptRequest的应用场景外，还支持：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section736313281410">配置公共请求头</a></li><li>跨域请求</li><li>POST请求拦截</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>拦截时机</p> </td> <td class="cellrowborder" valign="top"><p>Web组件加载url之前</p> </td> <td class="cellrowborder" colspan="2" valign="top"><p>请求发起前</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>拦截范围</p> </td> <td class="cellrowborder" valign="top"><p>页面主URL的请求（包括页面中iframe的导航行为，不包括子资源的请求）</p> </td> <td class="cellrowborder" colspan="2" valign="top"><p>页面主URL的请求和子资源的请求</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>数据访问能力</p> </td> <td class="cellrowborder" colspan="2" valign="top"><p>支持获取请求的URL、是否为主frame等相关信息，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourcerequest" target="_blank">WebResourceRequest</a></p> </td> <td class="cellrowborder" valign="top"><p>除支持获取请求的URL、是否为主frame等相关信息外，还支持获取POST请求体和buffer类型数据，具体参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandlerrequest" target="_blank">WebSchemeHandlerRequest</a></p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>拦截效果</p> </td> <td class="cellrowborder" valign="top"><p>可以拦截或放行Web组件发起当前请求</p> </td> <td class="cellrowborder" colspan="2" valign="top"><p>可以拦截当前请求并返回自定义响应，或者放行当前请求并返回原始响应</p> </td> </tr>  </tbody></table></div> </div> <p>三种拦截方案的不同特性，对应着不同的使用场景。下面将分别提供这三种方案的使用指导，开发者可根据实际应用场景选择合适的拦截方案。</p> </div> <div class="tiledSection"><h3 id="section2178190103214" class="firsth2">方案选择指导<i class="anchor-icon anchor-icon-link" anchorid="section2178190103214" tips="复制节点链接"></i></h3><p><strong>onLoadIntercept</strong></p> <p><strong>定位</strong>：用于拦截Web组件的URL加载行为，进行页面跳转控制。</p> </div> <p><strong>核心用法</strong>：</p> <ul><li><strong><a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-web-app-jump-and-pull-up" target="_blank">应用的跳转与拉起</a></strong>：拦截特定地址的请求，拉起指定应用或跳转其他页面处理，用于实现拦截支付类标签链接跳转到支付应用进行支付，或拦截地址类标签链接跳转到地图类应用进行导航等。</li></ul> <ul><li><strong><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section103591931490">请求重定向</a></strong>：拦截特定地址的请求，并将访问重定向到新的目标地址，用于在域名更换或登录引导时，将用户访问跳转到正确的页面。</li></ul> <ul><li><strong><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section1367693510110">页面白名单配置</a></strong>：配置链接黑名单/白名单，拦截/放行指定URL请求，确保Web组件的请求在信任范围内，用于实现阻止用户访问危险网页等功能。</li></ul> <p><strong>使用策略</strong>：相较于其他两种拦截方案，onLoadIntercept的主要目标是拦截页面跳转行为，而非替换请求内容。因此，在需要中断页面跳转的情况下，可选择使用本方案。</p> <p></p> <p><strong>onInterceptRequest</strong></p> <p><strong>定位</strong>：用于拦截Web组件的URL加载行为，进行网络请求拦截。</p> <p><strong>核心用法</strong></p> <ul><li><strong><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section29637307122">本地资源替换</a></strong>：将频繁使用的静态资源缓存至本地，在访问这些资源时，返回本地响应，用于提升页面的加载速度和响应性能。</li></ul> <ul><li><strong><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section766911191316">自定义资源加载策略</a></strong>：拦截特定资源请求（如图片、视频等），在Wi-Fi和移动网络下分别加载高清资源和压缩资源，用于实现数据消耗与用户体验的平衡。</li><li><strong>提示恶意请求</strong>：拦截已知恶意请求，返回空数据或提示信息作为请求响应，用于阻止恶意脚本的加载。</li></ul> <p><strong>使用策略</strong>：onInterceptRequest支持通过文件句柄、Resource资源、ByteBuffer或String的方式替换请求内容，要求开发者一次性提供完整的请求内容。在需要拦截网络请求并向Web组件返回特定响应的业务场景下，可选择本方案。相较于基于WebSchemeHandler的拦截方案，本方案的实现更加轻量。</p> <p></p> <p><strong>WebSchemeHandler</strong></p> <p><strong>定位</strong>：用于拦截Web组件的URL加载行为，进行网络请求拦截。</p> <p><strong>核心用法</strong>：</p> <p>除支持onInterceptRequest的核心用法外，还支持：</p> <ul><li><strong><a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section736313281410">配置公共请求头</a></strong>：拦截特定地址的网络请求，注入认证信息后转发给服务端，用于协助服务端识别请求的用户身份并验证其访问权限。</li><li><strong>跨域请求</strong>：拦截Web组件发起的跨域请求，转发至远端服务器，将跨域请求结果配置到自定义响应中，返回给Web组件，用于解决依赖多元数据交互的Web应用的跨域问题。</li><li><strong>POST请求拦截</strong>：拦截POST请求，根据请求内容动态生成响应，用于实现表单提交处理等功能。</li></ul> <p><strong>使用策略</strong>：相较于基于onInterceptRequest的拦截方案，WebSchemeHandler不仅具备其全部功能，还提供了更灵活的流式处理能力，允许开发者通过ByteBuffer逐步提供请求内容，并且能够获取请求的上传内容，如POST请求的数据。在需要拦截网络请求，获取更多请求内容或进行流式处理等复杂业务场景下，建议采用本方案。</p> <div class="tiledSection"><h2 id="section111971013297">基于onLoadIntercept()拦截能力的使用<i class="anchor-icon anchor-icon-link" anchorid="section111971013297" tips="复制节点链接"></i></h2><p>Web组件在加载URL前会触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onloadintercept10" target="_blank">onLoadIntercept()</a>回调，用于判断是否拦截此次请求。基于该回调，可以实现<a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section103591931490">请求重定向</a>或<a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section1367693510110">页面白名单配置</a>功能。</p> <div class="fignone"><span class="figcap"><b>图1 </b>基于onLoadIntercept()的请求拦截流程图</span><br><span><img height="233.43850000000003" originheight="968" originwidth="3815" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163021.75176037850507525985505818756592:50001231000000:2800:3C5BE37AD443570089D664823BA4A4CD16E81F182FE56518A95467C56E23F75E.png" title="点击放大" width="920"></span></div> </div> <div class="tiledSection"><h3 id="section103591931490" class="firsth2">请求重定向<i class="anchor-icon anchor-icon-link" anchorid="section103591931490" tips="复制节点链接"></i></h3><p>请求重定向的典型应用是在网站改版或登录状态管理等场景中，将用户访问自动跳转到正确的页面。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图2 </b>请求重定向</span><br><span><img height="486.9263" originheight="2258" originwidth="2467" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163021.59671595843989377240440396196189:50001231000000:2800:EB5EC04A8B21E972C44D48D1C972FBCFAF188199F496571ADFE9D95037ED3B5C.png" title="点击放大" width="532"></span></div> <p><strong>实现原理</strong></p> <p>在Web组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onloadintercept10" target="_blank">onLoadIntercept()</a>回调中获取请求的URL，若URL满足重定向条件，则通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loadurl" target="_blank">WebviewController.loadUrl()</a>加载重定向页面。</p> <p><strong>开发步骤</strong></p> <ol><li>获取请求的URL。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L75-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the load intercept event</span></li><li><span class="hljs-comment"> * Returns true if loading should be blocked (redirect performed), false to allow</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processLoadIntercept</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnLoadInterceptEvent</span>): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">requestUrl</span> = <span class="hljs-variable">event</span>.<span class="hljs-variable">data</span>.<span class="hljs-title function_">getRequestUrl</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L75-L96" target="_blank">RedirectRequestModel.ets</a></div></div></div></div> </li><li>判断URL是否满足重定向条件。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L49-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Checks if the URL needs to be intercepted and redirected</span></li><li><span class="hljs-comment"> */</span></li><li>shouldInterceptUrl(requestUrl: string): boolean {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.redirectUrl) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> normalizedRequest = <span class="hljs-keyword">this</span>.normalizeUrl(requestUrl);</li><li>  <span class="hljs-keyword">const</span> normalizedRedirect = <span class="hljs-keyword">this</span>.normalizeUrl(<span class="hljs-keyword">this</span>.redirectUrl);</li><li>  <span class="hljs-keyword">const</span> isRedirectTarget = normalizedRequest === normalizedRedirect;</li><li>  <span class="hljs-keyword">return</span> !isRedirectTarget;</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Normalizes the URL</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> normalizeUrl(url: string): string {</li><li>  <span class="hljs-keyword">return</span> url</li><li>    .replace(/^(?:[a-zA-Z]+:)?\/\<span class="hljs-comment">//, '')</span></li><li>    .replace(/\/+$/, <span class="hljs-string">''</span>)</li><li>    .trim();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L49-L70" target="_blank">RedirectRequestModel.ets</a></div></div></div></div> </li><li>若满足重定向条件，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#loadurl" target="_blank">WebviewController.loadUrl()</a>加载重定向页面。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L74-L117" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the load intercept event</span></li><li><span class="hljs-comment"> * Returns true if loading should be blocked (redirect performed), false to allow</span></li><li><span class="hljs-comment"> */</span></li><li>processLoadIntercept(event: OnLoadInterceptEvent): boolean {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.shouldInterceptUrl(requestUrl)) {</li><li>    <span class="hljs-comment">// Perform redirect</span></li><li>    <span class="hljs-keyword">const</span> redirected = <span class="hljs-keyword">this</span>.performRedirect();</li><li>    <span class="hljs-keyword">return</span> redirected; <span class="hljs-comment">// Block original URL if redirect successful</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// Allow loading</span></li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Performs the redirect operation</span></li><li><span class="hljs-comment"> */</span></li><li>performRedirect(): boolean {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.controller.loadUrl(<span class="hljs-keyword">this</span>.redirectUrl);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/RedirectRequestInterceptor/model/RedirectRequestModel.ets#L74-L117" target="_blank">RedirectRequestModel.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section1367693510110">页面白名单配置<i class="anchor-icon anchor-icon-link" anchorid="section1367693510110" tips="复制节点链接"></i></h3><p>页面白名单配置的典型应用是通过限制访问来源，仅允许可信来源接入系统，来防止非授权访问和网络攻击。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图3 </b>页面白名单配置</span><br><span><img height="400.89000000000004" originheight="2262" originwidth="5191" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163021.74596481410774049007418819463055:50001231000000:2800:81FE77A64474F478930065C395C621BD1A706A28FF965237A2A74D759A597648.png" title="点击放大" width="920"></span></div> <p><strong>实现原理</strong></p> <p>在Web组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#onloadintercept10" target="_blank">onLoadIntercept()</a>回调中获取请求的URL，若URL不属于白名单链接，则跳转到浏览器打开请求页面。</p> <p><strong>开发步骤</strong></p> <ol><li>配置页面白名单链接。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/view/PageWhitelistView.ets#L160-L168" data-highlighted="yes"><ol class="linenums"><li>Web({ src: <span class="hljs-keyword">this</span>.loadingUrl, controller: <span class="hljs-keyword">this</span>.controller })</li><li>  .onLoadIntercept((event) =&gt; {</li><li>    <span class="hljs-comment">// Update whitelist URLs before intercepting</span></li><li>    <span class="hljs-keyword">this</span>.viewModel?.setWhitelistUrls(<span class="hljs-keyword">this</span>.whitelistUrlArr.map(url =&gt; url.toString()));</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/view/PageWhitelistView.ets#L160-L168" target="_blank">PageWhitelistView.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L33-L56" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Updates the whitelist URLs</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">setWhitelistUrls</span>(<span class="hljs-attr">urls</span>: <span class="hljs-built_in">string</span>[]): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">whitelistDomains</span> = urls</li><li>    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractDomain</span>(url))</li><li>    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">domain</span> =&gt;</span> domain.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  Extract the domain name from a URL</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">extractDomain</span>(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">let</span> normalized = url.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toLowerCase</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  normalized = normalized</li><li>    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^(?:[a-z0-9+.-]+:)?\/\//</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// strip protocol-like prefixes</span></li><li>    .<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[/?#]/</span>)[<span class="hljs-number">0</span>]; <span class="hljs-comment">// drop everything after domain</span></li><li>  <span class="hljs-keyword">return</span> normalized.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:+$/</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/+$/</span>, <span class="hljs-string">''</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L33-L56" target="_blank">PageWhitelistModel.ets</a></div></div></div></div> </li><li>获取请求的URL。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L111-L133" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the load intercept event</span></li><li><span class="hljs-comment"> * Returns true if loading should be blocked, false to allow</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processLoadIntercept</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnLoadInterceptEvent</span>): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">requestUrl</span> = <span class="hljs-variable">event</span>.<span class="hljs-variable">data</span>.<span class="hljs-title function_">getRequestUrl</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L111-L133" target="_blank">PageWhitelistModel.ets</a></div></div></div></div> </li><li>判断URL是否属于白名单链接。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L68-L77" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Checks if a URL is in the whitelist</span></li><li><span class="hljs-comment"> */</span></li><li>isUrlInWhitelist(requestUrl: string): boolean {</li><li>  <span class="hljs-keyword">const</span> requestDomain = <span class="hljs-keyword">this</span>.extractDomain(requestUrl);</li><li>  <span class="hljs-keyword">if</span> (!requestDomain) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.whitelistDomains.includes(requestDomain);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L68-L77" target="_blank">PageWhitelistModel.ets</a></div></div></div></div> </li><li>若不属于白名单链接，通过弹窗提示是否跳转到浏览器打开。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L110-L134" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the load intercept event</span></li><li><span class="hljs-comment"> * Returns true if loading should be blocked, false to allow</span></li><li><span class="hljs-comment"> */</span></li><li>processLoadIntercept(event: OnLoadInterceptEvent): boolean {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Check if URL is in whitelist</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isUrlInWhitelist(requestUrl)) {</li><li>    <span class="hljs-keyword">this</span>.allowAllForCurrentLoad = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// Allow loading and subsequent requests</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// URL not in whitelist, show dialog</span></li><li>  <span class="hljs-keyword">this</span>.showDialog(requestUrl);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Block loading</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/PageWhitelistInterceptor/model/PageWhitelistModel.ets#L110-L134" target="_blank">PageWhitelistModel.ets</a></div></div></div></div> </li><li>点击确认，在浏览器中加载请求页面。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/component/WhitelistDialog.ets#L123-L163" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Open URL in external browser</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">openInBrowser</span>(<span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>    <span class="hljs-variable">uri</span>: <span class="hljs-title class_">url</span>,</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-string">'ohos.want.action.viewData'</span>,</li><li>    <span class="hljs-variable">entities</span>: [<span class="hljs-string">'entity.system.browsable'</span>],</li><li>    <span class="hljs-variable">parameters</span>: {</li><li>      <span class="hljs-string">'ohos.ability.params.showDefaultPicker'</span>: <span class="hljs-keyword">true</span></li><li>    }</li><li>  };</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">getHostContext</span>()! <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li>  <span class="hljs-variable">context</span>.<span class="hljs-title function_">startAbility</span>(<span class="hljs-variable">want</span>)</li><li>    .<span class="hljs-title function_">then</span>(() =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>?.<span class="hljs-variable">onOk</span>) {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>?.<span class="hljs-title function_">onOk</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">targetUrl</span>)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    })</li><li>    .<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/component/WhitelistDialog.ets#L123-L163" target="_blank">WhitelistDialog.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section184845411126">基于onInterceptRequest()拦截能力的使用<i class="anchor-icon anchor-icon-link" anchorid="section184845411126" tips="复制节点链接"></i></h2><p>Web组件在加载URL之前会触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()</a>回调，用于判断是否拦截此次请求并返回自定义响应数据。基于该回调，可以实现<a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section29637307122">本地资源替换</a>或<a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section766911191316">自定义资源加载策略</a>。</p> <div class="fignone"><span class="figcap"><b>图4 </b>基于onInterceptRequest()的请求拦截流程图</span><br><span><img height="222.8585" originheight="968" originwidth="3996" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.09895393927330813470234568780001:50001231000000:2800:F9B46951AA6887FEFD9ABE4867C7DDDEE16A0334B7DE30978F9A752289953D30.png" title="点击放大" width="920"></span></div> </div> <div class="tiledSection"><h3 id="section29637307122" class="firsth2">本地资源替换<i class="anchor-icon anchor-icon-link" anchorid="section29637307122" tips="复制节点链接"></i></h3><p>本地资源替换的典型应用是将部分频繁使用且变动较小的远程静态资源缓存至本地，以提升页面的加载速度和响应性能。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图5 </b>本地资源替换</span><br><span><img height="487.5647" originheight="2260" originwidth="2466" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.09156254931184273090656570827104:50001231000000:2800:128512BC9913812C2CA5195AE0A8C5276B174305EBE993C252301A5A91AE61C1.png" title="点击放大" width="532"></span></div> <p><strong>实现原理</strong></p> <p>在Web组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()</a>回调中获取网络请求信息，通过网络请求资源与本地资源的映射关系，获取对应的本地资源并将其设置给<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourceresponse" target="_blank">WebResourceResponse</a>作为请求响应。</p> <p><strong>开发步骤</strong></p> <ol><li>配置网络请求资源和本地资源的映射关系，以及本地资源与相应MIME类型的映射关系。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/view/LocalResourceView.ets#L37-L144" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Map between domain names and local files</span></li><li>schemeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([</li><li>  [<span class="hljs-string">'https://www.example.com/'</span>, <span class="hljs-string">'index.html'</span>],</li><li>  [<span class="hljs-string">'https://www.example.com/mountain.png'</span>, <span class="hljs-string">'mountain.png'</span>]</li><li>]);</li><li><span class="hljs-comment">// Map between local files and format mimeType</span></li><li>mimeTypeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([</li><li>  [<span class="hljs-string">'index.html'</span>, <span class="hljs-string">'text/html'</span>],</li><li>  [<span class="hljs-string">'mountain.png'</span>, <span class="hljs-string">'image/png'</span>]</li><li>]);</li><li>  <span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestUrl</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })</li><li>    .<span class="hljs-title function_">onInterceptRequest</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// Update scheme map before intercepting</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>?.<span class="hljs-title function_">updateMappings</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeMap</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">mimeTypeMap</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/view/LocalResourceView.ets#L37-L144" target="_blank">LocalResourceView.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L29-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Updates the scheme and mime type mappings</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">updateMappings</span>(<span class="hljs-attr">schemeMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;, <span class="hljs-attr">mimeTypeMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">schemeMap</span> = schemeMap;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mimeTypeMap</span> = mimeTypeMap;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L29-L35" target="_blank">LocalResourceModel.ets</a></div></div></div></div> </li><li>获取请求的URL。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L41-L77" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns local resource response if applicable</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processRequest</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnInterceptRequestEvent</span> | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">WebResourceResponse</span> | <span class="hljs-title class_">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">requestUrl</span> = <span class="hljs-variable">event</span>.<span class="hljs-variable">request</span>.<span class="hljs-title function_">getRequestUrl</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L41-L77" target="_blank">LocalResourceModel.ets</a></div></div></div></div> </li><li>通过映射关系获取本地资源。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L40-L133" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns local resource response if applicable</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li>processRequest(event: OnInterceptRequestEvent | <span class="hljs-literal">null</span>): WebResourceResponse | <span class="hljs-literal">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">this</span>.getUrlSchemeFromMap(requestUrl);</li><li>
</li><li>  <span class="hljs-keyword">if</span> (key.length === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// No match, allow original request</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">const</span> rawfileName = <span class="hljs-keyword">this</span>.schemeMap.<span class="hljs-keyword">get</span>(key);</li><li>  <span class="hljs-keyword">if</span> (!rawfileName) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// Invalid mapping, allow original request</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">const</span> mimeType = <span class="hljs-keyword">this</span>.mimeTypeMap.<span class="hljs-keyword">get</span>(rawfileName);</li><li>  <span class="hljs-keyword">if</span> (!mimeType) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// Invalid mapping, allow original request</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Gets the matching URL scheme key from the map</span></li><li><span class="hljs-comment"> */</span></li><li>getUrlSchemeFromMap(prefix: string): string {</li><li>  let matchedKey: string = <span class="hljs-string">''</span>;</li><li>  let maxLength: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">const</span> urlOrigin = <span class="hljs-keyword">this</span>.getUrlOrigin(prefix);</li><li>  <span class="hljs-keyword">const</span> urlFileName = <span class="hljs-keyword">this</span>.getFileName(prefix);</li><li>
</li><li>  <span class="hljs-comment">// Find the longest matching key to prioritize specific paths over general ones</span></li><li>  <span class="hljs-keyword">for</span> (let key of <span class="hljs-keyword">this</span>.schemeMap.keys()) {</li><li>    <span class="hljs-comment">// 1. Direct prefix match</span></li><li>    <span class="hljs-keyword">if</span> (prefix.startsWith(key) &amp;&amp; key.length &gt; maxLength) {</li><li>      matchedKey = key;</li><li>      maxLength = key.length;</li><li>      <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 2. Same-domain file name match</span></li><li>    <span class="hljs-keyword">const</span> keyFileName = <span class="hljs-keyword">this</span>.getFileName(key);</li><li>    <span class="hljs-keyword">if</span> (keyFileName.length === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (key.startsWith(urlOrigin) &amp;&amp; keyFileName === urlFileName &amp;&amp; key.length &gt; maxLength) {</li><li>      matchedKey = key;</li><li>      maxLength = key.length;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">return</span> matchedKey;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L40-L133" target="_blank">LocalResourceModel.ets</a></div></div></div></div> </li><li>构建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourceresponse" target="_blank">WebResourceResponse</a>，设置并返回本地资源作为请求响应。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L39-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns local resource response if applicable</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processRequest</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnInterceptRequestEvent</span> | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">WebResourceResponse</span> | <span class="hljs-title class_">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Create response with local file</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">createLocalResourceResponse</span>(<span class="hljs-variable">rawfileName</span>, <span class="hljs-variable">mimeType</span>);</li><li>}</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Creates a response with local file data</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">createLocalResourceResponse</span>(<span class="hljs-variable">rawfileName</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">mimeType</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">WebResourceResponse</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">response</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WebResourceResponse</span>();</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseHeader</span>([{</li><li>    <span class="hljs-variable">headerKey</span>: <span class="hljs-string">'Connection'</span>,</li><li>    <span class="hljs-variable">headerValue</span>: <span class="hljs-string">'keep-alive'</span></li><li>  }]);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseData</span>($<span class="hljs-title function_">rawfile</span>(<span class="hljs-variable">rawfileName</span>));</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseEncoding</span>(<span class="hljs-string">'utf-8'</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseMimeType</span>(<span class="hljs-variable">mimeType</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseCode</span>(<span class="hljs-number">200</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setReasonMessage</span>(<span class="hljs-string">'OK'</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseIsReady</span>(<span class="hljs-keyword">true</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">response</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/LocalResourceInterceptor/model/LocalResourceModel.ets#L39-L99" target="_blank">LocalResourceModel.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section766911191316">自定义资源加载策略<i class="anchor-icon anchor-icon-link" anchorid="section766911191316" tips="复制节点链接"></i></h3><p>自定义资源加载策略的典型应用是在Wi-Fi网络环境下加载高清图片，而在非Wi-Fi网络环境下加载压缩图片或本地占位图，以实现数据消耗与体验优化的平衡。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图6 </b>Wi-Fi网络环境下加载图片资源</span><br><span><img height="487.72429999999997" originheight="2258" originwidth="2463" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.35293862564550966346347469741259:50001231000000:2800:B99A617B51C714C703559B01F2735D7A0A9797085BDFB6F352F789752656E09E.png" title="点击放大" width="532"></span></div> <div class="fignone"><span class="figcap"><b>图7 </b>非Wi-Fi网络环境下加载本地占位图</span><br><span><img height="487.1125" originheight="2257" originwidth="2465" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.38792676570706445449926150344383:50001231000000:2800:3CC7CAA11C276C5724C7A755439612C99BA9CBF27808BB740202911A015B603E.png" title="点击放大" width="532"></span></div> <p><strong>实现原理</strong></p> <p>在Web组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()</a>回调中获取网络请求信息，对于图片资源请求，判断当前是否处于Wi-Fi网络环境下。若非Wi-Fi网络环境，则将本地占位图设置给<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourceresponse" target="_blank">WebResourceResponse</a>作为请求响应。</p> <p><strong>开发步骤</strong></p> <ol><li>判断当前网络环境，若处于Wi-Fi网络环境下，则直接返回原始请求响应。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L40-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns appropriate response</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li>processRequest(event: OnInterceptRequestEvent | <span class="hljs-literal">null</span>): WebResourceResponse | <span class="hljs-literal">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// If WiFi network, allow original network request</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isWifiNetwork()) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Checks if currently connected to a Wi-Fi network</span></li><li><span class="hljs-comment"> */</span></li><li>isWifiNetwork(): boolean {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> netHandle = connection.getDefaultNetSync();</li><li>    <span class="hljs-keyword">const</span> netData = connection.getNetCapabilitiesSync(netHandle);</li><li>    <span class="hljs-keyword">return</span> netData.bearerTypes.includes(connection.NetBearType.BEARER_WIFI);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L40-L99" target="_blank">CustomLoadingStrategyModel.ets</a></div></div></div></div> </li><li>获取请求的URL。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L39-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns appropriate response</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processRequest</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnInterceptRequestEvent</span> | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">WebResourceResponse</span> | <span class="hljs-title class_">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">requestUrl</span> = <span class="hljs-variable">event</span>.<span class="hljs-variable">request</span>.<span class="hljs-title function_">getRequestUrl</span>();</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L39-L78" target="_blank">CustomLoadingStrategyModel.ets</a></div></div></div></div> </li><li>判断请求类型，若非图片资源请求，则直接返回原始请求响应。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L38-L113" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns appropriate response</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li>processRequest(<span class="hljs-keyword">event</span>: OnInterceptRequestEvent | <span class="hljs-literal">null</span>): WebResourceResponse | <span class="hljs-literal">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Only intercept image requests</span></li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isImageRequestUrl(requestUrl)) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// Not an image, allow original request</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Checks if a URL request is for an image</span></li><li><span class="hljs-comment"> */</span></li><li>isImageRequestUrl(url: <span class="hljs-built_in">string</span>): boolean {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> format of <span class="hljs-keyword">this</span>.imageFormatList) {</li><li>    <span class="hljs-keyword">if</span> (url.endsWith(format)) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L38-L113" target="_blank">CustomLoadingStrategyModel.ets</a></div></div></div></div> </li><li>构建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-webresourceresponse" target="_blank">WebResourceResponse</a>，对于非Wi-fi网络环境下的图片资源请求，设置并返回本地占位图作为请求响应。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L37-L141" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Processes the intercepted request and returns appropriate response</span></li><li><span class="hljs-comment"> * Returns null if request should be allowed through</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">processRequest</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">OnInterceptRequestEvent</span> | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">WebResourceResponse</span> | <span class="hljs-title class_">null</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Replace with placeholder image</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">createPlaceholderResponse</span>();</li><li>}</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Creates a placeholder image response for non-WiFi networks</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">createPlaceholderResponse</span>(): <span class="hljs-title class_">WebResourceResponse</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">response</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WebResourceResponse</span>();</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseHeader</span>([{</li><li>    <span class="hljs-variable">headerKey</span>: <span class="hljs-string">'Connection'</span>,</li><li>    <span class="hljs-variable">headerValue</span>: <span class="hljs-string">'keep-alive'</span></li><li>  }]);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseData</span>($<span class="hljs-title function_">rawfile</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">IMAGE_NO_WLAN</span>));</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseEncoding</span>(<span class="hljs-string">'utf-8'</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseMimeType</span>(<span class="hljs-string">'image/png'</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseCode</span>(<span class="hljs-number">200</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setReasonMessage</span>(<span class="hljs-string">'OK'</span>);</li><li>  <span class="hljs-variable">response</span>.<span class="hljs-title function_">setResponseIsReady</span>(<span class="hljs-keyword">true</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">response</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CustomLoadingStrategyInterceptor/model/CustomLoadingStrategyModel.ets#L37-L141" target="_blank">CustomLoadingStrategyModel.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section172467500138">基于WebSchemeHandler拦截能力的使用<i class="anchor-icon anchor-icon-link" anchorid="section172467500138" tips="复制节点链接"></i></h2><p>为当前Web组件设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>，可以拦截指定协议的请求，获得请求信息并返回自定义响应数据。基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>机制，可以实现<a href="/consumer/cn/doc/best-practices/bpta-web-interceptor#section736313281410">配置公共请求头</a>等场景。</p> <div class="fignone"><span class="figcap"><b>图8 </b>基于WebSchemeHandler的请求拦截流程图</span><br><span><img height="222.525" originheight="968" originwidth="4002" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.14897356661752621447631892386276:50001231000000:2800:8874285E8B579701B49E527C1A5052846B87BF78E4DBCAEF3D9EBEF04708CAFF.png" title="点击放大" width="920"></span></div> </div> <div class="tiledSection"><h3 id="section736313281410" class="firsth2">配置公共请求头<i class="anchor-icon anchor-icon-link" anchorid="section736313281410" tips="复制节点链接"></i></h3><p>配置公共请求头的典型应用是在网络访问的过程中，在请求头中携带认证信息，使服务端能够识别用户身份并验证其访问权限。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图9 </b>配置公共请求头</span><br><span><img height="487.5248" originheight="2258" originwidth="2464" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.38760120862968351415179143030338:50001231000000:2800:12953B39FDEA87AC19704AD45A48F1374166986E77F1048A55532D2511B8134C.png" title="点击放大" width="532"></span></div> <p><strong>实现原理</strong></p> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">WebviewController</a>将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>设置给当前Web组件后，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler#onrequeststart12" target="_blank">WebSchemeHandler.onRequestStart()</a>回调中拦截网络请求，并为其添加公共请求头，然后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section176881642192516" target="_blank">rcp</a>将请求转发到服务端。</p> <p><strong>开发步骤</strong></p> <ol><li>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">WebviewController</a>将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>设置给Web组件。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CommonHeaderInterceptor/viewmodel/CommonHeaderViewModel.ets#L47-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Bind interceptor to HTTP</span></li><li>controller.setWebSchemeHandler(<span class="hljs-string">'http'</span>, <span class="hljs-keyword">this</span>.schemeHandler);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CommonHeaderInterceptor/viewmodel/CommonHeaderViewModel.ets#L47-L48" target="_blank">CommonHeaderViewModel.ets</a></div></div></div></div> </li><li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler#onrequeststart12" target="_blank">WebSchemeHandler.onRequestStart()</a>回调中拦截网络请求。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CommonHeaderInterceptor/viewmodel/CommonHeaderViewModel.ets#L52-L58" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set up request interceptor</span></li><li><span class="hljs-keyword">this</span>.schemeHandler.onRequestStart((request: webview.WebSchemeHandlerRequest,</li><li>  resourceHandler: webview.WebResourceHandler) =&gt; {</li><li>  <span class="hljs-comment">// Process request</span></li><li>  <span class="hljs-keyword">const</span> handled = <span class="hljs-keyword">this</span>.model.processRequest(request, resourceHandler);</li><li>  <span class="hljs-keyword">return</span> handled;</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/Interceptors/CommonHeaderInterceptor/viewmodel/CommonHeaderViewModel.ets#L52-L58" target="_blank">CommonHeaderViewModel.ets</a></div></div></div></div> </li><li>为网络请求添加自定义的公共请求头，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section163819131811" target="_blank">rcp.createSession()</a>创建HTTP会话。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L85-L102" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Creates an RCP session for the next outbound request.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">createSession</span>(<span class="hljs-variable">headers</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">string</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Create RCP session</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">sessionConfig</span>: <span class="hljs-title class_">rcp</span>.<span class="hljs-title class_">SessionConfiguration</span> = {</li><li>      <span class="hljs-variable">headers</span>: <span class="hljs-title class_">headers</span></li><li>    };</li><li>      </li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">session</span> = <span class="hljs-variable">rcp</span>.<span class="hljs-title function_">createSession</span>(<span class="hljs-variable">sessionConfig</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L85-L102" target="_blank">RcpRequestForwarder.ets</a></div></div></div></div> </li><li>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section176881642192516" target="_blank">rcp</a>将请求转发到服务端获取请求响应。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L106-L138" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Sends GET or HEAD requests via the RCP session.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">forwardGetRequest</span>(</li><li>  <span class="hljs-variable">targetUrl</span>: <span class="hljs-title class_">string</span>,</li><li>  <span class="hljs-variable">headers</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">string</span>&gt;,</li><li>  <span class="hljs-variable">resourceHandler</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebResourceHandler</span>,</li><li>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">createSession</span>(<span class="hljs-variable">headers</span>);</li><li>
</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">session</span>?.<span class="hljs-title function_">get</span>(<span class="hljs-variable">targetUrl</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">response</span>: <span class="hljs-title class_">rcp</span>.<span class="hljs-title class_">Response</span>) =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">handleResponse</span>(<span class="hljs-variable">response</span>, <span class="hljs-variable">resourceHandler</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">session</span>?.<span class="hljs-title function_">close</span>();</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L106-L138" target="_blank">RcpRequestForwarder.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didreceiveresponse12" target="_blank">didReceiveResponse()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didreceiveresponsebody12" target="_blank">didReceiveResponseBody()</a>将构造的响应头和响应体传递给拦截的请求。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L208-L279" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Maps the RCP response to a WebSchemeHandlerResponse.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">handleResponse</span>(</li><li>  <span class="hljs-attr">response</span>: rcp.Response,</li><li>  <span class="hljs-attr">resourceHandler</span>: webview.WebResourceHandler,</li><li>): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">webResponse</span> = <span class="hljs-keyword">new</span> webview.<span class="hljs-title function_ invoke__">WebSchemeHandlerResponse</span>();</li><li>    webResponse.<span class="hljs-title function_ invoke__">setStatus</span>(response.statusCode || <span class="hljs-number">200</span>);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setStatusText</span>(<span class="hljs-string">'OK'</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>    webResponse.<span class="hljs-title function_ invoke__">setMimeType</span>(mimeType);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setEncoding</span>(encoding);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setNetErrorCode</span>(WebNetErrorList.NET_OK);</li><li>
</li><li>    <span class="hljs-comment">// Set CORS headers</span></li><li>    webResponse.<span class="hljs-title function_ invoke__">setHeaderByName</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-literal">true</span>);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setHeaderByName</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>, <span class="hljs-literal">true</span>);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setHeaderByName</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span>, <span class="hljs-literal">true</span>);</li><li>    webResponse.<span class="hljs-title function_ invoke__">setHeaderByName</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization, X-Custom-Header'</span>, <span class="hljs-literal">true</span>);</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>    resourceHandler.<span class="hljs-title function_ invoke__">didReceiveResponse</span>(webResponse);</li><li>    resourceHandler.<span class="hljs-title function_ invoke__">didReceiveResponseBody</span>(response.body);</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L208-L279" target="_blank">RcpRequestForwarder.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webresourcehandler#didfinish12" target="_blank">didFinish()</a>通知Web组件被拦截的请求已经完成。<div class="screenLinkPre"><div _ngcontent-ltq-c106="" class="highlight-div"><div _ngcontent-ltq-c106="" class="highlight-div-header"><div _ngcontent-ltq-c106="" class="highlight-div-header-left"><div _ngcontent-ltq-c106="" class="handle-button expand-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ltq-c106="" class="highlight-div-header-right"><div _ngcontent-ltq-c106="" class="handle-button ai-button"></div><div _ngcontent-ltq-c106="" class="handle-button line-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ltq-c106="" class="handle-button theme-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ltq-c106="" class="handle-button copy-button"><div _ngcontent-ltq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ltq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L207-L280" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Maps the RCP response to a WebSchemeHandlerResponse.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">handleResponse</span>(</li><li>  <span class="hljs-variable">response</span>: <span class="hljs-title class_">rcp</span>.<span class="hljs-title class_">Response</span>,</li><li>  <span class="hljs-variable">resourceHandler</span>: <span class="hljs-title class_">webview</span>.<span class="hljs-title class_">WebResourceHandler</span>,</li><li>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable">resourceHandler</span>.<span class="hljs-title function_">didFinish</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/web-interceptor/blob/master/entry/src/main/ets/common/utils/RcpRequestForwarder.ets#L207-L280" target="_blank">RcpRequestForwarder.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1472665316144">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section1472665316144" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section97609589315" class="firsth2">Web组件是否支持拦截前端页面的router.push()方法？<i class="anchor-icon anchor-icon-link" anchorid="section97609589315" tips="复制节点链接"></i></h3><p>不支持。Web组件目前仅提供网络请求的拦截方法，而前端页面的router.push()方法不会触发新的网络请求，因此无法被拦截。</p> </div> <div class="tiledSection"><h3 id="section152115247403">Web组件支持异步判断是否拦截网络请求吗？<i class="anchor-icon anchor-icon-link" anchorid="section152115247403" tips="复制节点链接"></i></h3><p>不支持。Web组件不支持异步判断是否拦截网络请求，但是可以在拦截网络请求后，异步处理响应数据，具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()示例代码</a>。</p> </div> <div class="tiledSection"><h3 id="section9991337174916">Web组件是否支持拦截Ajax原始响应？<i class="anchor-icon anchor-icon-link" anchorid="section9991337174916" tips="复制节点链接"></i></h3><p>不支持。Web组件目前仅提供网络请求的拦截方法，无法拦截请求的响应。然而，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-basic-components-web-events#oninterceptrequest9" target="_blank">onInterceptRequest()</a>回调或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webschemehandler" target="_blank">WebSchemeHandler</a>机制自定义响应。</p> </div> <div class="tiledSection"><h2 id="section5742829546">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section5742829546" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/web-interceptor" target="_blank">实现基于Web组件的请求拦截功能</a></li></ul> </div> </div> <div></div></div>