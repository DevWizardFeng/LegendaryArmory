<h1 _ngcontent-qvy-c119="" class="doc-title ng-star-inserted" title="libuv使用规范及案例"> libuv使用规范及案例 </h1>

<div _ngcontent-qvy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section82921408582">前言<i class="anchor-icon anchor-icon-link" anchorid="section82921408582" tips="复制节点链接"></i></h2><p>本文主要从以下几方面展开，以帮助开发者正确使用libuv相关接口，并在出现问题时能够排查代码找到问题点：</p> <ul><li>libuv使用细则</li><li>与libuv相关的Crash案例</li><li>与libuv相关的Freeze案例</li></ul> </div> <div class="tiledSection"><h2 id="section211335114589">libuv使用细则<i class="anchor-icon anchor-icon-link" anchorid="section211335114589" tips="复制节点链接"></i></h2><p>本章节主要阐述libuv中Requests和Handles的使用规范，确保开发者正确使用libuv接口，避免应用出现稳定性问题。关于libuv原理，感兴趣的开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv" target="_blank">libuv</a>。</p> </div> <div class="tiledSection"><h3 id="section9992103815147" class="firsth2">libuv中Requests使用规范<i class="anchor-icon anchor-icon-link" anchorid="section9992103815147" tips="复制节点链接"></i></h3><p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv" target="_blank">libuv</a>库中，Request表示一个短暂的请求，不会被事件循环长期持有。请求任务执行完毕后，该请求在事件循环上的使命结束。如果需要继续下一次请求，必须再次调用相关接口。在<a href="https://docs.libuv.org/en/v1.x/" target="_blank">libuv官方文档</a>中，Request主要有如下几种类型：</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvRequest.h#L12-L21" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_req_s</span> <span class="hljs-type">uv_req_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_getaddrinfo_s</span> <span class="hljs-type">uv_getaddrinfo_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_getnameinfo_s</span> <span class="hljs-type">uv_getnameinfo_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_shutdown_s</span> <span class="hljs-type">uv_shutdown_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_write_s</span> <span class="hljs-type">uv_write_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_connect_s</span> <span class="hljs-type">uv_connect_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_udp_send_s</span> <span class="hljs-type">uv_udp_send_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_fs_s</span> <span class="hljs-type">uv_fs_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_work_s</span> <span class="hljs-type">uv_work_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_random_s</span> <span class="hljs-type">uv_random_t</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvRequest.h#L12-L21" target="_blank">libuvRequest.h</a></div></div></div></div>  <p>但是经过异步线程池的只有下面几种：</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvRequestAsyn.h#L12-L16" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_getaddrinfo_s</span> <span class="hljs-type">uv_getaddrinfo_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_getnameinfo_s</span> <span class="hljs-type">uv_getnameinfo_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_fs_s</span> <span class="hljs-type">uv_fs_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_work_s</span> <span class="hljs-type">uv_work_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_random_s</span> <span class="hljs-type">uv_random_t</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvRequestAsyn.h#L12-L16" target="_blank">libuvRequestAsyn.h</a></div></div></div></div>  <p>在HarmonyOS中，使用频率最高的数据结构是uv_work_t，主要用于自定义异步任务请求。与之配套的接口是uv_queue_work，定义如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">UV_EXTERN <span class="hljs-type">int</span> <span class="hljs-title">uv_queue_work</span><span class="hljs-params">(<span class="hljs-type">uv_loop_t</span>* loop,</span></span></li><li><span class="hljs-function">                            <span class="hljs-type">uv_work_t</span>* req,</span></li><li><span class="hljs-function">                            uv_work_cb work_cb,</span></li><li><span class="hljs-function">                            uv_after_work_cb after_work_cb)</span>;</li></ol></pre></div></div> <p>loop表示请求所在的事件循环，work_cb表示执行在异步线程池的异步任务，after_work_cb表示在事件循环上处理异步任务的执行结果的回调。在HarmonyOS上，uv_queue_work的整个处理过程如下：</p> <ol><li>调用uv_queue_work。</li><li>work_cb被封装成一个函数uv__queue_work，after_work_cb被封装成uv__queue_done。</li><li>异步线程池（ffrt）执行uv__queue_work继而执行真正的work_cb。</li><li>接下来，根据是否是主线程来分开处理。<ol><li>如果是主线程，将uv__queue_done根据优先级不同插入到主线程的eventhandler任务队列上等待执行。</li><li>如果是其他TS线程或是开发者创建的事件循环线程，则将uv__queue_done放在wq队列上，并调用uv_async_send触发fd等待事件循环处理wq队列。</li></ol> </li></ol> <p>了解了uv_queue_work的执行原理后，开发者可以按照下面几种情况使用该接口。</p> <p><strong>异步任务执行一次即删除</strong></p> <p>伪代码写法1：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>Context* context = <span class="hljs-keyword">new</span> Context; <span class="hljs-comment">// context为开发者自定义的对象</span></li><li><span class="hljs-type">uv_work_t</span>* work = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_work_t</span>;</li><li>work-&gt;data = (<span class="hljs-type">void</span>*)context;</li><li><span class="hljs-built_in">uv_queue_work</span>(loop, work, [](<span class="hljs-type">uv_work_t</span>*){</li><li>    Context *ctx = (Context*)work-&gt;data;</li><li>    <span class="hljs-comment">// 业务逻辑</span></li><li>}, [<span class="hljs-type">uv_work_t</span>* work, <span class="hljs-type">int</span> status] {</li><li>    Context *ctx = (Context*)work-&gt;data;</li><li>    <span class="hljs-comment">// 业务逻辑</span></li><li>    <span class="hljs-keyword">delete</span> ctx; <span class="hljs-comment">// 是否删除由开发者决定</span></li><li>    <span class="hljs-keyword">delete</span> work;</li><li>});</li></ol></pre></div></div> <p>伪代码写法2：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">uv_work_t</span> <span class="hljs-variable">work</span>; <span class="hljs-comment">// 该work与Context生命周期保持一致</span></li><li>}</li><li>
</li><li><span class="hljs-variable">Context</span>* <span class="hljs-variable">context</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">Context</span>; <span class="hljs-comment">// context为开发者自定义的对象</span></li><li><span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">work</span>.<span class="hljs-title class_">data</span> = (<span class="hljs-variable">void</span>*)<span class="hljs-variable">context</span>;</li><li><span class="hljs-title function_">uv_queue_work</span>(<span class="hljs-variable">loop</span>, &amp;<span class="hljs-title class_">context</span>-&gt;<span class="hljs-title class_">work</span>, [](<span class="hljs-variable">uv_work_t</span>*){</li><li>    <span class="hljs-variable">Context</span> *<span class="hljs-variable">ctx</span> = (<span class="hljs-variable">Context</span>*)<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>;</li><li>    <span class="hljs-comment">// 业务逻辑</span></li><li>}, [<span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span>, <span class="hljs-variable">int</span> <span class="hljs-variable">status</span>] {</li><li>    <span class="hljs-variable">Context</span> *<span class="hljs-variable">ctx</span> = (<span class="hljs-variable">Context</span>*)<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>;</li><li>    <span class="hljs-comment">// 业务逻辑</span></li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">ctx</span>; <span class="hljs-comment">// 是否删除由开发者决定</span></li><li>});</li></ol></pre></div></div> <p>上述代码遵循了一个基本原则：对于uv_queue_work的调用方式，必须确保释放内存的操作在after_work_cb中完成。开发者应避免自行管理异步任务的生命周期，因为无法确定任务在何时完成。对于在其他线程池中执行的异步请求，这一原则同样适用。</p> <p><strong>多次请求任务共用一个结构体</strong></p> <p>针对这种场景，如果预期的异步任务是在完成上一次异步请求后，继续使用同一个结构体执行相同的请求任务，可以使用以下类似的代码：</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/NapiTaskRunner.h#L78-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">uv_loop_t</span>* loop;</li><li>
</li><li><span class="hljs-type">bool</span> g_done = <span class="hljs-literal">false</span>;</li><li><span class="hljs-type">uv_work_t</span> *work = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_work_t</span>;</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ExecuteCB</span><span class="hljs-params">(<span class="hljs-type">uv_work_t</span> *work)</span> </span>{</li><li>    <span class="hljs-comment">// Business Logic</span></li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CompleteCB</span><span class="hljs-params">(<span class="hljs-type">uv_work_t</span> *work, <span class="hljs-type">int</span> status)</span> </span>{</li><li>    <span class="hljs-comment">// Business Logic</span></li><li>    <span class="hljs-keyword">if</span> (!g_done) {</li><li>        <span class="hljs-built_in">uv_queue_work</span>(work-&gt;loop, work, ExecuteCB, CompleteCB);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">delete</span> work;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-built_in">uv_queue_work</span>(loop, work, ExecuteCB, CompleteCB);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/NapiTaskRunner.h#L78-L99" target="_blank">NapiTaskRunner.h</a></div></div></div></div> <p>这样可以减少对象的频繁申请和释放，降低开销。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果开发者无法确保创建的对象与libuv Requests对象的生命周期是否需要保持一致，最佳做法是将开发者自定义的对象与Requests对象分开创建，并将自定义对象放在Requests对象的data字段中。这样可以保证两者互不影响。即使自定义对象的生命周期管理出现问题，也不会影响系统库的正常执行。如果出现崩溃问题，崩溃栈会显示在具体的业务逻辑上，而不是系统库上，从而便于问题的定位。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section1518713286153">libuv中Handles使用规范<i class="anchor-icon anchor-icon-link" anchorid="section1518713286153" tips="复制节点链接"></i></h3><p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv" target="_blank">libuv开发指南</a>中，Handle表示一个持久的请求，可以被事件循环长期持有。如果开发者不调用uv_close函数，创建的Handle会持久保存在事件循环上，影响事件循环的正常退出。在<a href="https://docs.libuv.org/en/v1.x/" target="_blank">官方文档</a>中，Handle主要有如下几种类型：</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvHandles.h#L10-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/* Handle types. */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_loop_s</span> <span class="hljs-type">uv_loop_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_handle_s</span> <span class="hljs-type">uv_handle_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_dir_s</span> <span class="hljs-type">uv_dir_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_stream_s</span> <span class="hljs-type">uv_stream_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_tcp_s</span> <span class="hljs-type">uv_tcp_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_udp_s</span> <span class="hljs-type">uv_udp_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_pipe_s</span> <span class="hljs-type">uv_pipe_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_tty_s</span> <span class="hljs-type">uv_tty_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_poll_s</span> <span class="hljs-type">uv_poll_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_timer_s</span> <span class="hljs-type">uv_timer_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_prepare_s</span> <span class="hljs-type">uv_prepare_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_check_s</span> <span class="hljs-type">uv_check_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_idle_s</span> <span class="hljs-type">uv_idle_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_async_s</span> <span class="hljs-type">uv_async_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_process_s</span> <span class="hljs-type">uv_process_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_fs_event_s</span> <span class="hljs-type">uv_fs_event_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_fs_poll_s</span> <span class="hljs-type">uv_fs_poll_t</span>;</li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_signal_s</span> <span class="hljs-type">uv_signal_t</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvHandles.h#L10-L28" target="_blank">libuvHandles.h</a></div></div></div></div> <p>但是HarmonyOS中常见的Handles，主要有以下几个：</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvHandleNormal.h#L13-L20" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/* Handle representing an event loop */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_loop_s</span> <span class="hljs-type">uv_loop_t</span>;</li><li><span class="hljs-comment">/* The parent structure of all handles */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_handle_s</span> <span class="hljs-type">uv_handle_t</span>;</li><li><span class="hljs-comment">/* Handle used to represent timer tasks */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_timer_s</span> <span class="hljs-type">uv_timer_t</span>;</li><li><span class="hljs-comment">/* Handle used to represent communication between threads */</span></li><li><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_async_s</span> <span class="hljs-type">uv_async_t</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/libuvHandleNormal.h#L13-L20" target="_blank">libuvHandleNormal.h</a></div></div></div></div>  <p>对于uv_loop_t的使用，不会出现严重问题。开发者在使用时，需在事件循环退出时正确释放事件循环中的资源，避免因事件循环无法退出导致资源泄露。如果开发者创建的事件循环不清楚上层业务如何使用，可以在退出时调用uv_walk遍历事件循环上的Handles，并在回调中调用uv_close将Handles从事件循环中移除。然后执行uv_run，确保异步任务执行完毕。这样可以保证事件循环的正常退出，前提是此过程中没有其他业务向事件循环中添加任务。具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv#libuv中的事件循环" target="_blank">libuv中的事件循环</a>。</p> <p>在使用libuv中的Handles时，确保在不使用时调用uv_close，并且必须在事件循环所在的线程中调用，以避免多线程数据竞争问题。如果需要在多线程环境中操作Handles，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/libuv#libuv中的handles和requests" target="_blank">libuv开发指南</a>的“<strong>libuv timer使用规范</strong>“章节。</p> <p>特别注意uv_close的使用，它并不会同步从事件循环中移除handle。在说明uv_close的运行逻辑之前，开发者需要了解几个背景知识：</p> <ul><li>libuv中的事件循环上有多个任务队列，依次串行执行。例如，使用uv_idle_t，该Handle会依次插入到loop-&gt;idle_handles上；使用uv_async_t，便会插入到loop-&gt;async_handles。</li><li>事件循环里面又包含了一个handle_queue，它记录了初始化在事件循环上的所有的Handles。</li><li>每一个Handle上都有两个成员变量：一个是queue，它挂在对应的任务队列上，例如uv_async_t中的queue就挂在loop-&gt;async_handles；一个是handle_queue，它挂在loop-&gt;handle_queue上。<p>以摘除uv_async_t为例，uv_close运行逻辑如下：</p> </li></ul> <ol><li>调用uv_close，将uv_async_t从loop-&gt;async_handles上摘除，然后将uv_async_t结点挂到loop-&gt;closing_handles上，表示该结点正在关闭，并设置一些标志位。</li><li>事件循环在本次迭代中继续往下执行，直到执行到uv__run_closing_handles这个函数。</li><li>在2中的函数里，将uv_async_t中的handle_queue从loop-&gt;handle_queue摘下来，然后执行该结点的close_cb回调。该close_cb为开发者调用uv_close时传入的参数。<p>因此，开发者需要注意的是：避免在调用uv_close后到事件循环执行在uv__run_closing_handles期间内，释放Handle句柄。</p> </li></ol> </div> <div class="tiledSection"><h2 id="section922044185915">与libuv相关的Crash案例<i class="anchor-icon anchor-icon-link" anchorid="section922044185915" tips="复制节点链接"></i></h2><p>本章将介绍应用调用uv接口引发的Crash案例。</p> <p><strong>案例一、某应用使用uv_close错误</strong></p> <p>问题描述：应用在native层调用libuv接口时，由于使用不当导致偶尔出现崩溃，崩溃栈位于libuv。崩溃栈如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">44250</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020034</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-number">8</span><span class="hljs-title class_">s</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV</span> <span class="hljs-title class_">MAPERR</span>)<span class="hljs-number">0000000000000000000</span> <span class="hljs-title class_">probably</span> <span class="hljs-title class_">caused</span> <span class="hljs-title class_">by</span> <span class="hljs-title class_">NULL</span> <span class="hljs-title class_">pointer</span> <span class="hljs-title class_">dereference</span></li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">44250</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000018528</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uv_run</span>+<span class="hljs-number">724</span>)(<span class="hljs-number">1616669436</span><span class="hljs-variable">a9c6d4bcaf8ae1f5989855</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000083518</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libruntime</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AbilityRuntime</span>::<span class="hljs-title class_">OHOSLoopHandler</span>::<span class="hljs-title class_">OnTriggered</span>()+<span class="hljs-number">268</span>)(<span class="hljs-variable">d061df412ec8b3260629e85ba1a6344b</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000833</span><span class="hljs-variable">dc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libruntime</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AbilityRuntime</span>::<span class="hljs-title class_">OHOSLoopHandler</span>::<span class="hljs-title class_">OnReadable</span>(<span class="hljs-title class_">int</span>)+<span class="hljs-number">244</span>) (<span class="hljs-variable">dO61df412ec8b3260629e85ba1a6344b</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000016710</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">std</span>:: <span class="hljs-title class_">__h</span>::<span class="hljs-title class_">_</span> <span class="hljs-title class_">function</span>::<span class="hljs-title class_">_</span> <span class="hljs-keyword">func</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EpollIoWaiter</span>::<span class="hljs-title class_">HandleFileDescriptorEvent</span>(<span class="hljs-title class_">i</span></li><li>#<span class="hljs-number">04</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000001</span>aOdO <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">EventHandler</span>::<span class="hljs-title class_">DistributeEvent</span>(<span class="hljs-variable">std</span>:: <span class="hljs-title class_">hocunique</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-title class_">Ir</span> </li><li>#<span class="hljs-number">05</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000028418</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-variable">EventRunnerImpl</span>::<span class="hljs-title class_">ExecuteEventHandler</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">_</span> <span class="hljs-title class_">hoste</span></li><li>#<span class="hljs-number">06</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000027</span>cbc <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-variable">EventRunnerImpl</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">880</span>)(<span class="hljs-title class_">a83d7f5ebf4fe67105b5</span> </li><li>#<span class="hljs-number">07</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002</span>a9d0 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">EventRunner</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">320</span>)(<span class="hljs-title class_">a83d7f5ebf4fe67105b53501f28aa078</span>)</li><li>#<span class="hljs-number">08</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">00000000000</span>ba48c <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/platformsdk</span><span class="hljs-variable">/libappkit_native</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">MainThread</span>::<span class="hljs-title class_">Start</span>()+<span class="hljs-number">872</span>)(<span class="hljs-number">8</span><span class="hljs-title class_">f59740ee20585693a5c2814e1e9f6dd</span>)</li><li>#<span class="hljs-number">09</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000004</span>ac4 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/libappspawn_ace</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-title class_">RunChildProcessor</span>(<span class="hljs-variable">AppSpawnContent</span>*, <span class="hljs-variable">AppSpawnClient</span>*)+<span class="hljs-number">216</span>)(<span class="hljs-title class_">c368de983182514a8ea3Odaa3ba41</span></li><li>#<span class="hljs-number">10</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000008688</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnChild</span>+<span class="hljs-number">436</span>)(<span class="hljs-number">8e25</span><span class="hljs-title class_">bd745a01ef608e0816fd1eabcce2</span>)    </li><li>#<span class="hljs-number">11</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000008368</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnProcessMsg</span>+<span class="hljs-number">564</span>)(<span class="hljs-number">8e25</span><span class="hljs-title class_">bd745a01ef608e0816fd1eabcce2</span>)    </li><li>#<span class="hljs-number">12</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>ff28 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">OnReceiveRequest</span>+<span class="hljs-number">676</span>)(<span class="hljs-number">8e25</span><span class="hljs-title class_">bd745a01ef608e0816fd1eabcce2</span>)</li><li>#<span class="hljs-number">13</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000017</span>af8 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">HandleRecvMsg_</span>+<span class="hljs-number">260</span>)(<span class="hljs-title class_">fcd62c07eOd7d3c70d75c3c61180bc55</span>)</li><li>#<span class="hljs-number">14</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000017618</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">HandleStreamEvent_</span>+<span class="hljs-number">168</span>)(<span class="hljs-title class_">fcd62c07eOd7d3c70d75c3c61180bc55</span>)</li></ol></pre></div></div> <p>原因分析：反编译解栈得到如下调用链：</p> <p>uv_run-&gt;uv__run_closing_handles-&gt;uv__finish_close-&gt;uv__queue_remove</p> <p>uv__queue_remove表示将某结点从事件循环队列上摘除。现在崩溃在这个函数上面，又是空指针解引用。这种情况下，开发者只需要参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-asan-detection">使用ASan检测内存错误</a>这篇文档，开启ASan后复现，即可将具体崩溃栈获取到。通过解栈定位到具体代码行。在本例中，出错代码如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NapiTaskRunner</span> : <span class="hljs-keyword">public</span> <span class="hljs-title class_">AbstractTaskRunner</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">NapiTaskRunner</span> (</li><li>        <span class="hljs-variable">napi</span> <span class="hljs-variable">env</span> <span class="hljs-variable">env</span>,</li><li>        <span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">exceptionHandler</span> = <span class="hljs-variable">defaultExceptionHandler</span>);</li><li>    ~<span class="hljs-title function_">NapiTaskRunner</span>() <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-title function_">NapiTaskRunner</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">NapiTaskRunner</span>&amp;) = <span class="hljs-variable">delete</span>;</li><li>    <span class="hljs-variable">NapiTaskRunner</span>&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> <span class="hljs-variable">NapiTaskRunner</span>&amp;) = <span class="hljs-variable">delete</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">runAsyncTask</span>(<span class="hljs-variable">Task</span>&amp;&amp; <span class="hljs-variable">task</span>) <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">runSyncTask</span>(<span class="hljs-variable">Task</span>&amp;&amp; <span class="hljs-variable">task</span>) <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-title function_">isOnCurrentThread</span>() <span class="hljs-keyword">const</span> <span class="hljs-variable">override</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-variable">setExceptionHandler</span> (<span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">handler</span>) <span class="hljs-keyword">override</span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">napi</span> <span class="hljs-variable">env</span> <span class="hljs-variable">env</span>;</li><li>    <span class="hljs-variable">uv_loop_t</span>* <span class="hljs-title function_">getLoop</span>() <span class="hljs-keyword">const</span>;</li><li>    <span class="hljs-variable">uv_async_t</span>    <span class="hljs-variable">asyncHandle</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">tasksMutex</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">Task</span>&gt; <span class="hljs-title class_">tasksQueue</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>::<span class="hljs-title class_">id</span> <span class="hljs-title class_">threadId</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">cv</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic_bool</span>&gt; <span class="hljs-title class_">running</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic_bool</span>&gt;(<span class="hljs-keyword">true</span>);</li><li>    <span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">exceptionHandler</span>;</li><li>};</li><li>
</li><li><span class="hljs-comment">//构造函数部分代码</span></li><li><span class="hljs-variable">NapiTaskRunner</span>::<span class="hljs-title class_">NapiTaskRunner</span> (<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">ExceptionHandler</span> <span class="hljs-title class_">exceptionHandler</span>)</li><li>    : <span class="hljs-title class_">env</span>(<span class="hljs-title class_">env</span>), <span class="hljs-title function_">exceptionHandler</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">move</span> (<span class="hljs-title class_">exceptionHandler</span>)) {</li><li>    <span class="hljs-variable">threadId</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">get</span> <span class="hljs-title class_">id</span>();</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">loop</span> = <span class="hljs-title function_">getLoop</span>() ;</li><li>    <span class="hljs-variable">asyncHandle</span>.<span class="hljs-variable">data</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span>*&gt;(<span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-title function_">uv_async_init</span>(<span class="hljs-variable">loop</span>, &amp;<span class="hljs-title class_">asyncHandle</span>, [](<span class="hljs-variable">auto</span> <span class="hljs-variable">handle</span>) {});</li><li>}</li><li>
</li><li><span class="hljs-comment">//析构函数部分代码</span></li><li><span class="hljs-variable">NapiTaskRunner</span>::~<span class="hljs-title class_">NapiTaskRunner</span>() {</li><li>    <span class="hljs-variable">running</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>    <span class="hljs-variable">cv</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    <span class="hljs-title function_">uv_close</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uv_handle_t</span>*&gt;(&amp;<span class="hljs-title class_">asyncHandle</span>), <span class="hljs-variable">nullptr</span>);</li><li>}</li></ol></pre></div></div> <p>将内存操作放在析构函数中执行是个好习惯，但开发者可能并未完全理解uv_close的调用时序。当uv_async_t作为NapiTaskRunner的普通成员变量时，asyncHandle的生命周期与NapiTaskRunner保持一致。在析构函数中调用uv_close将该句柄从事件循环中移除，但由于uv_close是一个异步操作，调用后并不能立即完成整个移除过程。因此，当析构函数执行完毕后，asyncHandle会被释放。如果事件循环随后尝试操作该节点，将会导致崩溃。</p> <p>崩溃原因如下：</p> <p><span><img originheight="616" originwidth="1365" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.06896649700230875674424734328613:50001231000000:2800:C8C2D6AB96E27E57A6045ED4B9800678039D318EAA3B87EB35B42D71E9A3E15F.png" width="920" height="415.1794871794872"></span></p> <p>解决方法：</p> <p>如果开发者需要将asyncHandle放在自定义对象中，可以将其作为指针放在NapiTaskRunner中。在构造函数中使用new创建asyncHandle，在析构函数中调用uv_close。这样，NapiTaskRunner和asyncHandle可以互不影响。</p> <div class="screenLinkPre"><div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/NapiTaskRunner.h#L30-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">NapiTaskRunner</span> : <span class="hljs-keyword">public</span> <span class="hljs-title class_">AbstractTaskRunner</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">NapiTaskRunner</span> (</li><li>        <span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>,</li><li>        <span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">exceptionHandler</span> = <span class="hljs-variable">defaultExceptionHandler</span>);</li><li>    ~<span class="hljs-title function_">NapiTaskRunner</span>() <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-title function_">NapiTaskRunner</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">NapiTaskRunner</span>&amp;) = <span class="hljs-variable">delete</span>;</li><li>    <span class="hljs-variable">NapiTaskRunner</span>&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> <span class="hljs-variable">NapiTaskRunner</span>&amp;) = <span class="hljs-variable">delete</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">runAsyncTask</span>(<span class="hljs-variable">Task</span>&amp;&amp; <span class="hljs-variable">task</span>) <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">runSyncTask</span>(<span class="hljs-variable">Task</span>&amp;&amp; <span class="hljs-variable">task</span>) <span class="hljs-keyword">override</span>;</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-title function_">isOnCurrentThread</span>() <span class="hljs-keyword">const</span> <span class="hljs-variable">override</span>;</li><li>    <span class="hljs-variable">void</span> <span class="hljs-variable">setExceptionHandler</span> (<span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">handler</span>) <span class="hljs-keyword">override</span>;</li><li><span class="hljs-keyword">private</span>:</li><li>    <span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>;</li><li>    <span class="hljs-variable">uv_loop_t</span>* <span class="hljs-title function_">getLoop</span>() <span class="hljs-keyword">const</span>;</li><li>    <span class="hljs-variable">uv_async_t</span>*    <span class="hljs-variable">asyncHandle</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">mutex</span> <span class="hljs-title class_">tasksMutex</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">queue</span>&lt;<span class="hljs-title class_">Task</span>&gt; <span class="hljs-title class_">tasksQueue</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>::<span class="hljs-title class_">id</span> <span class="hljs-title class_">threadId</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">condition_variable</span> <span class="hljs-title class_">cv</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic_bool</span>&gt; <span class="hljs-title class_">running</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">atomic_bool</span>&gt;(<span class="hljs-keyword">true</span>);</li><li>    <span class="hljs-variable">ExceptionHandler</span> <span class="hljs-variable">exceptionHandler</span>;</li><li>};</li><li>
</li><li>
</li><li><span class="hljs-comment">//Constructor code section</span></li><li><span class="hljs-variable">NapiTaskRunner</span>::<span class="hljs-title class_">NapiTaskRunner</span> (<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">ExceptionHandler</span> <span class="hljs-title class_">exceptionHandler</span>)</li><li>    : <span class="hljs-title class_">env</span>(<span class="hljs-title class_">env</span>), <span class="hljs-title function_">exceptionHandler</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">move</span> (<span class="hljs-title class_">exceptionHandler</span>)) {</li><li>    <span class="hljs-variable">threadId</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">get_id</span>();</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">loop</span> = <span class="hljs-title function_">getLoop</span>() ;</li><li>    <span class="hljs-variable">asyncHandle</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">uv_async_t</span>;</li><li>    <span class="hljs-variable">asyncHandle</span>-&gt;<span class="hljs-title class_">data</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">void</span>*&gt;(<span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-title function_">uv_async_init</span>(<span class="hljs-variable">loop</span>, <span class="hljs-variable">asyncHandle</span>, [](<span class="hljs-variable">auto</span> <span class="hljs-variable">handle</span>) {});</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">//Destructor section code</span></li><li><span class="hljs-variable">NapiTaskRunner</span>::~<span class="hljs-title class_">NapiTaskRunner</span>() {</li><li>    <span class="hljs-variable">running</span>-&gt;<span class="hljs-title class_">store</span>(<span class="hljs-keyword">false</span>);</li><li>    <span class="hljs-variable">cv</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    <span class="hljs-title function_">uv_close</span>(<span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">uv_handle_t</span>*&gt;(<span class="hljs-variable">asyncHandle</span>), [](<span class="hljs-variable">uv_handle_t</span>* <span class="hljs-variable">handle</span>) {</li><li>        <span class="hljs-variable">delete</span> (<span class="hljs-variable">uv_async_t</span>*)<span class="hljs-variable">handle</span>;</li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/LibuvDevelopment/entry/src/main/cpp/NapiTaskRunner.h#L30-L73" target="_blank">NapiTaskRunner.h</a></div></div></div></div> <p><strong>案例二、异步任务执行过程中崩溃</strong></p> <p>异步任务执行过程中出现崩溃，可以分为三种场景进行分析：</p> <ul><li>崩溃在主线程的after_work_cb的封装函数uv__queue_done执行之前。</li><li>崩溃在主线程的after_work_cb的封装函数uv__queue_done执行期间。</li><li>崩溃在异步线程的work_cb执行之前。</li></ul> <p>场景一</p> <p>问题描述：应用在主线程执行after_work_cb之前，函数地址被破坏，导致崩溃。部分调用栈如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">13724</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020032</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGBUS</span>(<span class="hljs-title class_">BUS_ADRALN</span>)@<span class="hljs-number">0xddde2ddf82f7dddd</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-number">24</span><span class="hljs-title class_">s</span></li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">13724</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-variable">ddde2ddf82f7dddd</span> <span class="hljs-variable">Not</span> <span class="hljs-variable">mapped</span></li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000007</span><span class="hljs-variable">c2fc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libruntime</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>    (<span class="hljs-number">430e3</span><span class="hljs-variable">acd9544f1f7ca5b27a4cecc0195</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-variable">ad94</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>: :<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventHandler</span>::<span class="hljs-title class_">DistributeEvent</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">_h</span>::<span class="hljs-title class_">unique</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-title class_">InnerEvent</span>, <span class="hljs-title class_">void</span> (*)(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">InnerEvent</span>*)&gt; <span class="hljs-title class_">con</span>=</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002</span><span class="hljs-variable">bcf4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>):<span class="hljs-title class_">EventRunnerImpl</span>::<span class="hljs-title class_">ExecuteEventHandler</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">unique</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-title class_">InnerEvent</span>, <span class="hljs-title class_">void</span> (*)(<span class="hljs-variable">OHOS</span>:</li><li>#<span class="hljs-number">04</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002</span>b5cc <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-variable">EventRunnerImpl</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">880</span>)(<span class="hljs-title class_">b89cf5c314801ffd0e29111078d34982</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002e96</span>c <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">EventRunner</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">524</span>)(<span class="hljs-title class_">b89cf5c314801ffd0e29111078d34982</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">00000000000</span>b3fb4 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/platformsdk</span><span class="hljs-variable">/libappkit_native</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">MainThread</span>::<span class="hljs-title class_">Start</span>()+<span class="hljs-number">616</span>)(<span class="hljs-title class_">e9ba1356486e1df571afbc78c5f9d693</span>)</li><li>#<span class="hljs-number">07</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000004e28</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/libappspawn_ace</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-title class_">RunChildProcessor</span>(<span class="hljs-variable">AppSpawnContent</span>*, <span class="hljs-variable">AppSpawnClient</span>*)+<span class="hljs-number">568</span>)(<span class="hljs-number">9</span><span class="hljs-title class_">f5d8e5303d934ad8210339181dca305</span>)</li><li>#<span class="hljs-number">08</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>b308 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnChild</span>+<span class="hljs-number">576</span>)(<span class="hljs-title class_">ea1fc238c52f4e7577605cb35a5238b7</span>)</li><li>#<span class="hljs-number">09</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>af9c <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnProcessMsg</span>+<span class="hljs-number">712</span>)(<span class="hljs-title class_">ea1fc238c52f4e7577605cb35a5238b7</span>)</li><li>#<span class="hljs-number">10</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">00000000000138e0</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">ProcessSpawnReqMsg</span>+<span class="hljs-number">228</span>)(<span class="hljs-title class_">ea1fc238c52f4e7577605cb35a5238b7</span>)</li></ol></pre></div></div> <p>问题分析：</p> <p>根据崩溃栈，第0帧为Notmapped，表明after_work_cb的地址为ddde2ddf82f7dddd，该地址已不是正常的PC地址，且ddd和末尾的ddd表示这块内存已被释放。因此，可以判定这是由于UAF（useafterfree）导致的崩溃。对于这类问题，开发者可以根据崩溃栈的寄存器信息找到一些现场信息，但异步任务的崩溃通常离问题现场较远。因此，HarmonyOS还提供了ASan检测工具，使用该工具复现问题，可以轻松找到问题现场。下面是通过工具抓到的现场：</p> <p>初次分配的调用栈如下：</p> <p><span><img originheight="257" originwidth="1392" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.93531777555604884805301302646482:50001231000000:2800:FEAF73EBFBF0591F79C73711CA0EC00CC8CC97CE5A371082123E5BC3FD7E374D.png" width="920" height="169.85632183908046"></span></p> <p>第一次释放的调用栈如下：</p> <p><span><img originheight="145" originwidth="1359" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.25211166560155555947208053971361:50001231000000:2800:2D4E7C737B9A3BEB0B9508CEC3D08CCBF2386F38FFDAB85976320EA619D166F5.png" width="920" height="98.16041206769684"></span></p> <p>经过相关开发者的反编译，定位到现场，代码如下：</p> <p><span><img originheight="823" originwidth="726" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.71966486501165136358535276027009:50001231000000:2800:C69C2AF23FDFB34F5FE3508A0BE2B40F63237FF6DC1E1B78F27292F1EC3A2448.png" width="726" height="823"></span></p> <p>问题结论：调用uv_work_t相关的函数时，内存的释放动作一定要放在after_work_cb里面。如果开发者没法控制好自定义对象的生命周期，就可以通过uv_work_t和自定义对象分开的方式，将uv_work_t的内存释放放在after_work_cb里，自定义对象的内存由开发者自行管理。</p> <p><strong>场景二</strong></p> <p>问题描述：应用在异步任务生命周期管理中出现问题，导致在uv__queue_done期间崩溃。崩溃栈如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">26268</span></li><li><span class="hljs-variable">uid</span>:<span class="hljs-number">20020114</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-number">18</span><span class="hljs-title class_">s</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV</span> <span class="hljs-title class_">MAPERR</span>)@<span class="hljs-number">0x0000007400650073</span></li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">26268</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">crasher_cpp</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000112</span><span class="hljs-variable">fc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uv_queue_done</span>+<span class="hljs-number">8</span>)(<span class="hljs-variable">a90636dbbfd39960db73e29590075d11</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000007</span><span class="hljs-variable">c28c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libruntime</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-number">92</span><span class="hljs-variable">caabbc4aec7feb10ce78ccb2755b86</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-variable">ad8c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libeventhandler</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AppExecFwk</span>::<span class="hljs-title class_">EventHandler</span>::<span class="hljs-title class_">DistributeEvent</span> (<span class="hljs-variable">std</span>::<span class="hljs-variable">h</span>:<span class="hljs-title class_">unique</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-title class_">InnerEvent</span>, <span class="hljs-title class_">void</span> (*)</li><li>#<span class="hljs-number">03</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002</span>b580 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-variable">EventRunnerImpl</span>::<span class="hljs-title class_">ExecuteEventHandler</span> (<span class="hljs-variable">std</span>:: <span class="hljs-variable">h</span>::<span class="hljs-title class_">unique</span> <span class="hljs-title class_">ptr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Apr</span></li><li>#<span class="hljs-number">04</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002</span>ae58 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-variable">EventRunnerImpl</span>::<span class="hljs-title class_">Run</span>()+<span class="hljs-number">880</span>)(<span class="hljs-number">6394</span><span class="hljs-title class_">acafle4743acfbb25998ee37297b</span>)</li><li>#<span class="hljs-number">05</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000002e1</span>£<span class="hljs-number">8</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libeventhandler</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">EventRunner</span>::<span class="hljs-title class_">Run</span> ()+<span class="hljs-number">524</span>)(<span class="hljs-number">6394</span><span class="hljs-title class_">acaf1e4743acfbb25998ee37297b</span>)</li><li>#<span class="hljs-number">06</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">00000000000</span>b4408 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/platformsdk</span><span class="hljs-variable">/libappkit_native</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">AppExecFwk</span>::<span class="hljs-variable">MainThread</span>::<span class="hljs-title class_">Start</span>()+<span class="hljs-number">408</span>)(<span class="hljs-number">7771</span><span class="hljs-title class_">dOfba84d0fcd69</span>£<span class="hljs-number">48428</span><span class="hljs-title class_">a264274a</span>)</li><li>#<span class="hljs-number">07</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000004</span>d18 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/appspawn</span><span class="hljs-variable">/libappspawn_ace</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span> (<span class="hljs-title class_">RunChildProcessor</span>(<span class="hljs-variable">AppSpawnContent</span>*, <span class="hljs-variable">AppSpawnClient</span>*)+<span class="hljs-number">560</span>)(<span class="hljs-title class_">e33c30d195115715c46ece122</span>£<span class="hljs-number">278</span><span class="hljs-title class_">d5</span>£)</li><li>#<span class="hljs-number">08</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>a4a4 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnChild</span>+<span class="hljs-number">484</span>)(<span class="hljs-title class_">f60d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">09</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>a194 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnProcessMsg</span>+<span class="hljs-number">688</span>)(<span class="hljs-title class_">f60d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">10</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000011</span>c18 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">ProcessSpawnReqMsg</span>+<span class="hljs-number">228</span>)(<span class="hljs-title class_">f60d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">11</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000011238</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">OnReceiveRequest</span>+<span class="hljs-number">172</span>)(£<span class="hljs-number">60</span><span class="hljs-title class_">d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">12</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000016058</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">HandleRecvMsg_</span>+<span class="hljs-number">292</span>)(<span class="hljs-title class_">bc25e5f0f7a71</span>£<span class="hljs-number">78</span><span class="hljs-title class_">a286</span>£<span class="hljs-number">419</span><span class="hljs-title class_">d13c202</span>£)</li><li>#<span class="hljs-number">13</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000015</span>b58 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">HandleStreamEvent_</span>+<span class="hljs-number">172</span>) (<span class="hljs-title class_">bc25e5f0f7a71</span>£<span class="hljs-number">78</span><span class="hljs-title class_">a286</span>£<span class="hljs-number">419</span><span class="hljs-title class_">d13c202f</span>)</li><li>#<span class="hljs-number">14</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000013230</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">ProcessEvent</span>+<span class="hljs-number">108</span>)(<span class="hljs-title class_">bc25e5f0f7a71</span>£<span class="hljs-number">78</span><span class="hljs-title class_">a286</span>£<span class="hljs-number">419</span><span class="hljs-title class_">d13c202f</span>)</li><li>#<span class="hljs-number">15</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">0000000000012</span>df0 <span class="hljs-variable">/system</span><span class="hljs-variable">/lib64</span><span class="hljs-variable">/chipset</span><span class="hljs-variable">-pub</span><span class="hljs-variable">-sdk</span><span class="hljs-variable">/libbegetutil</span>.<span class="hljs-title class_">z</span>.<span class="hljs-title class_">so</span>(<span class="hljs-variable">RunLoop_</span>+<span class="hljs-number">356</span>)(<span class="hljs-title class_">bc25e5f0f7a71f78a286</span>£<span class="hljs-number">419</span><span class="hljs-title class_">d13c202f</span>)</li><li>#<span class="hljs-number">16</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>£<span class="hljs-number">3</span>c0 <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-variable">AppSpawnRun</span>+<span class="hljs-number">136</span>)(<span class="hljs-title class_">f60d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">17</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">000000000000</span>cd4c <span class="hljs-variable">/system</span><span class="hljs-variable">/bin</span><span class="hljs-variable">/appspawn</span>(<span class="hljs-keyword">main</span>+<span class="hljs-number">744</span>)(£<span class="hljs-number">60</span><span class="hljs-title class_">d4361d8bc8fe7e6b3a73529a98031</span>)</li><li>#<span class="hljs-number">18</span>    <span class="hljs-title class_">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-title class_">a05</span>£<span class="hljs-number">4</span> <span class="hljs-variable">/system</span><span class="hljs-variable">/lib</span><span class="hljs-variable">/ld</span><span class="hljs-variable">-musl</span><span class="hljs-variable">-aarch64</span>.<span class="hljs-title class_">so</span><span class="hljs-number">.1</span>(<span class="hljs-number">1</span><span class="hljs-title class_">ibc</span> <span class="hljs-title class_">start</span> <span class="hljs-keyword">main</span> <span class="hljs-variable">stage2</span>+<span class="hljs-number">64</span>)(<span class="hljs-number">73</span>£<span class="hljs-number">87e7</span><span class="hljs-title class_">c2e4e0d3e8e0510b97431a820</span>)</li></ol></pre></div></div> <p>问题分析：</p> <p>此类问题通常源于开发者对uv_work_t对象生命周期管理不当导致的崩溃。然而，如何溯源一直是个难题。本案例介绍了一种特殊方法，即利用crash文件中的寄存器信息推测问题现场。</p> <p>首先，经过反编译，可以看到具体的代码行和汇编指令，如下：</p> <p><span><img originheight="497" originwidth="1531" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.11007272723648171473605384871434:50001231000000:2800:1D400FA352FA00CEFA562F459F23C631528EE394DEC3F791564DFF3750E22278.png" width="920" height="298.65447419986936"></span></p> <p>上图红框中的汇编指令含义：</p> <p><strong>112fc</strong><strong>：</strong>表示将x8寄存器的值加上十进制的32作为地址，然后将该地址的内容取出来放在w9寄存器中。（其实w9就是x9，一个是32位，一个是64位）<strong>w9 = [x8+32]</strong></p> <p><strong>112f8</strong><strong>：</strong>将x0寄存器的值减去十进制的24作为地址，将该地址的内容放在x8寄存器里头。<strong>x8 = [x0 - 24]</strong> 。 []表示取内容</p> <p>再来解释一下上述两个寄存器存放的是什么内容。这里有个基本的知识，在C++函数中，x0寄存器往往对应着函数的第一个形参。所以x0寄存器放的就是形参w的地址。然后根据112f8这条指令，可以知道从x0对应的地址向前偏移24个字节就是x8寄存器的内容。x8表示的内容可由下面的结构体推测出来：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv_work_s</span> {</li><li>  UV_REQ_FIELDS</li><li>  <span class="hljs-type">uv_loop_t</span>* loop;                     <span class="hljs-comment">//x0 -24</span></li><li>  uv_work_cb work_cb;                  <span class="hljs-comment">//x0 -16</span></li><li>  uv_after_work_cb after_work_cb;      <span class="hljs-comment">//x0 -8</span></li><li>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uv__work</span> work_req;            <span class="hljs-comment">//x0</span></li><li>};</li></ol></pre></div></div> <p>根据上述内存布局，x8寄存器存放的是loop的地址。当前的错误出现在x8寄存器上，这验证了上述结论，表明这是一个异步任务的UAF问题。</p> <p>接下来，通过分析uv_work_s结构体，可以发现该结构体包含uv__queue_done的第一个参数w，以及最重要的after_work_cb函数指针。</p> <p>after_work_cb是开发者传入的函数指针，通常在开发者编写的代码文件中定义，并最终编译到动态库（so）中。HarmonyOS上的crash文件包含当前应用进程映射的so文件的地址范围。因此，开发者可以通过after_work_cb的地址在crash文件中找到对应的so文件，并通过起始地址定位到具体代码行。检查x0寄存器是否仍然保留after_work_cb的信息。</p> <p><span><img originheight="638" originwidth="920" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.34372306637406792332298446568654:50001231000000:2800:F4273AF97CF960C13480EFC2F9422DAFBA65AC25D4AFB0DC19C4BDE14449C3E8.png" width="920" height="638"></span></p> <p>x0包含after_work_cb的地址。根据该地址确定其所在的so文件地址范围，再用该地址减去so文件的起始地址，即可得到其偏移地址。通过反编译可以找到具体的代码行。</p> <p><span><img originheight="143" originwidth="550" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.01736669219650391386528553522082:50001231000000:2800:7503B457066FF7F1A0516F1979CBC9B6CC7A2C25F224DB00620DB2EC477CCFC6.png" width="550" height="143"></span></p> <p>具体的代码：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">DataShareUvQueue</span>::<span class="hljs-title class_">LambdaForWork</span>(<span class="hljs-variable">uv_work_t</span> <span class="hljs-variable">*work</span>, <span class="hljs-title class_">int</span> <span class="hljs-title class_">uvstatus</span>)</li><li>{</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">LOG_ERROR</span>(<span class="hljs-string">"invalid work or work-&gt;data."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">entry</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">UvEntry</span>*&gt;(<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>);</li><li>    {</li><li>        <span class="hljs-comment">// 报错在这一行，加锁失败。</span></li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">entry</span>-&gt;<span class="hljs-title class_">mutex</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">entry</span>-&gt;<span class="hljs-keyword">func</span>) {</li><li>            <span class="hljs-variable">entry</span>-&gt;<span class="hljs-keyword">func</span>();</li><li>        }</li><li>        <span class="hljs-variable">entry</span>-&gt;<span class="hljs-title class_">done</span> = <span class="hljs-keyword">true</span>;</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">entry</span>-&gt;<span class="hljs-title class_">purge</span>) {</li><li>            <span class="hljs-variable">entry</span>-&gt;<span class="hljs-title class_">condition</span>.<span class="hljs-title class_">notify_all</span>();</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-variable">DataShareUvQueue</span>::<span class="hljs-title class_">Purge</span>(<span class="hljs-title class_">work</span>);</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">DataShareUvQueue</span>::<span class="hljs-title class_">SyncCall</span>(<span class="hljs-title class_">NapiVoidFunc</span> <span class="hljs-keyword">func</span>, <span class="hljs-title class_">NapiBoolFunc</span> <span class="hljs-title class_">retFunc</span>)</li><li>{</li><li>    <span class="hljs-comment">// 动态申请uv_work_t</span></li><li>    <span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span> = <span class="hljs-variable">new</span> (<span class="hljs-variable">std</span>::<span class="hljs-title class_">nothrow</span>) <span class="hljs-variable">uv_work_t</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">LOG_ERROR</span>(<span class="hljs-string">"invalid work."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 申请一个UvEntry赋值给work-&gt;data</span></li><li>    <span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">UvEntry</span> {<span class="hljs-variable">env_</span>, <span class="hljs-variable">std</span>::<span class="hljs-title class_">move</span>(<span class="hljs-keyword">func</span>), <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, {}, {}, <span class="hljs-variable">std</span>::<span class="hljs-title class_">move</span>(<span class="hljs-title class_">retFunc</span>)};</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">work</span>;</li><li>        <span class="hljs-title function_">LOG_ERROR</span>(<span class="hljs-string">"invalid uvEntry."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">bool</span> <span class="hljs-variable">noNeedPurge</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-variable">auto</span> *<span class="hljs-variable">uvEntry</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">UvEntry</span>*&gt;(<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>);</li><li>    {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">uvEntry</span>-&gt;<span class="hljs-title class_">mutex</span>);</li><li>        <span class="hljs-comment">// 抛异步任务，一切都是正常的</span></li><li>        <span class="hljs-variable">auto</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">uv_queue_work</span>(</li><li>            <span class="hljs-variable">loop_</span>, <span class="hljs-variable">work</span>, [](<span class="hljs-variable">uv_work_t</span> *<span class="hljs-variable">work</span>) {}, <span class="hljs-variable">LambdaForWork</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">status</span> != <span class="hljs-variable">napi_ok</span>) {</li><li>            <span class="hljs-title function_">LOG_ERROR</span>(<span class="hljs-string">"queue work failed"</span>);</li><li>            <span class="hljs-variable">DataShareUvQueue</span>::<span class="hljs-title class_">Purge</span>(<span class="hljs-title class_">work</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// 异步转同步，实际上只要不在同一个线程，其实也没问题，就是代码实现比较难看</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">uvEntry</span>-&gt;<span class="hljs-title class_">condition</span>.<span class="hljs-title class_">wait_for</span>(<span class="hljs-title class_">lock</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">seconds</span>(<span class="hljs-title class_">WAIT_TIME</span>), [<span class="hljs-title class_">uvEntry</span>] { <span class="hljs-keyword">return</span> <span class="hljs-title class_">uvEntry</span>-&gt;<span class="hljs-title class_">done</span>; })) {</li><li>            <span class="hljs-variable">auto</span> <span class="hljs-variable">time</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint64_t</span>&gt;(<span class="hljs-title class_">duration_cast</span>&lt;<span class="hljs-title class_">milliseconds</span>&gt;(</li><li>                <span class="hljs-variable">system_clock</span>::<span class="hljs-title class_">now</span>().<span class="hljs-title class_">time_since_epoch</span>()).<span class="hljs-title function_">count</span>());</li><li>            <span class="hljs-title function_">LOG_INFO</span>(<span class="hljs-string">"function ended successfully. times %{public}"</span> <span class="hljs-variable">PRIu64</span> <span class="hljs-string">"."</span>, <span class="hljs-variable">time</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 好了，到这里就开始出现问题了。这个本质上是在处理异常，也就是任务都执行不到的时候，需要调用uv_cancel取消该任务。然后往下执行Purge做清理动作。</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">uvEntry</span>-&gt;<span class="hljs-title class_">done</span> &amp;&amp; <span class="hljs-title class_">uv_cancel</span>((<span class="hljs-variable">uv_req_t</span>*)<span class="hljs-title class_">work</span>) != <span class="hljs-variable">napi_ok</span>) {</li><li>            <span class="hljs-title function_">LOG_ERROR</span>(<span class="hljs-string">"uv_cancel failed."</span>);</li><li>            <span class="hljs-variable">uvEntry</span>-&gt;<span class="hljs-title class_">purge</span> = <span class="hljs-keyword">true</span>;</li><li>            <span class="hljs-variable">noNeedPurge</span> = <span class="hljs-keyword">true</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">CheckFuncAndExec</span>(<span class="hljs-variable">uvEntry</span>-&gt;<span class="hljs-title class_">retFunc</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">noNeedPurge</span>) {</li><li>        <span class="hljs-comment">// Purge是做清理动作的，包括delete uv_work_t和delete uvEntry</span></li><li>        <span class="hljs-variable">DataShareUvQueue</span>::<span class="hljs-title class_">Purge</span>(<span class="hljs-title class_">work</span>);</li><li>    }</li><li>}</li></ol></pre></div></div> <p>上述代码出错的原因是开发者对uv_cancel函数不熟悉。uv_cancel函数的运行逻辑如下：</p> <ol><li>首先它会根据uv_work_t中的异步任务work_cb的状态判断该任务可否被取消，如果不可以则返回。</li><li>然后，将work_cb置为uv__cancelled。并将异步流程继续往下执行，然后将status设为UV_ECANCELED传给after_work_cb</li><li>最后，继续执行after_work_cb。<p>uv_cancel实际上不会真正取消异步任务，也不会阻止after_work_cb回调的执行。如果开发者调用uv_cancel但不在回调中检查status是否等于UV_ECANCELED，代码将不会按预期执行。这可能导致清理工作不到位，进而引发double free或UAF问题。</p> </li></ol> <p>问题结论：确保在after_work_cb中释放异步任务对象的内存。</p> <p><strong>场景三</strong></p> <p>问题描述：某应用调用异步任务，在异步线程池中执行work_cb之前发生崩溃，崩溃栈如下：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">Thread</span> <span class="hljs-selector-tag">name</span>:<span class="hljs-selector-tag">OS_FFRT</span></li><li><span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000000000</span> <span class="hljs-selector-tag">Not</span> <span class="hljs-selector-tag">mapped</span></li><li><span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000012790</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">platformsdk</span>/<span class="hljs-selector-tag">libuv</span><span class="hljs-selector-class">.so</span>(uv_ffrt_work+<span class="hljs-number">56</span>)(e51f7fcef979b717a8cfda493466e715)</li><li><span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000647</span><span class="hljs-selector-tag">bc</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">ndk</span>/<span class="hljs-selector-tag">libffrt</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">ffrt</span>:<span class="hljs-attribute">CPUWorker</span>:<span class="hljs-built_in">Run</span>(ffrt_executor_task*, int)+<span class="hljs-number">488</span>)(<span class="hljs-number">2922</span>cbbd7fc6ad47a9cdddf7480a607e)</li><li><span class="hljs-selector-id">#03</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000064</span><span class="hljs-selector-tag">fe8</span> /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">ndk</span>/<span class="hljs-selector-tag">libffrt</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">ffrt</span>:<span class="hljs-attribute">CPUWorker</span>::<span class="hljs-built_in">RunTask</span>(ffrt_executor_task*, <span class="hljs-attribute">ffrt</span>::CPUWorker*)+<span class="hljs-number">124</span>)(<span class="hljs-number">2922</span>cbbd7fc6ad47a9cdddf7480a607e)</li><li><span class="hljs-selector-id">#04</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000006553</span><span class="hljs-selector-tag">c</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">ndk</span>/<span class="hljs-selector-tag">libffrt</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">ffrt</span>:<span class="hljs-attribute">CPUWorker</span>:<span class="hljs-built_in">WorkerLooperDefault</span>(<span class="hljs-attribute">ffrt</span>::WorkerThread*)+<span class="hljs-number">588</span>)(<span class="hljs-number">2922</span>cbbd7fc6ad47a9cdddf7480a607e)</li><li><span class="hljs-selector-id">#05</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000064</span><span class="hljs-selector-tag">e84</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">ndk</span>/<span class="hljs-selector-tag">libffrt</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">ffrt</span>:<span class="hljs-attribute">CPUWorker</span>:<span class="hljs-built_in">Dispatch</span>(<span class="hljs-attribute">ffrt</span>:CPUWorker*)+<span class="hljs-number">144</span>)(<span class="hljs-number">2922</span>cbbd7fc6ad47a9cdddf7480a607e)</li><li><span class="hljs-selector-id">#06</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000064</span><span class="hljs-selector-tag">ddc</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">ndk</span>/<span class="hljs-selector-tag">libffrt</span><span class="hljs-selector-class">.so</span>(<span class="hljs-attribute">ffrt</span>:<span class="hljs-attribute">CPUWorker</span>:<span class="hljs-built_in">WrapDispatch</span>(void*)+<span class="hljs-number">28</span>)(<span class="hljs-number">2922</span>cbbd7fc6ad47a9cdddf7480a607e)    </li><li><span class="hljs-selector-id">#07</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000001</span><span class="hljs-selector-tag">bc964</span> /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib</span>/<span class="hljs-selector-tag">ld-musl-aarch64</span><span class="hljs-selector-class">.so</span><span class="hljs-selector-class">.1</span>(start+<span class="hljs-number">236</span>)(<span class="hljs-number">9</span>df691eca4c7c964a4d25c8af1c7a550)</li></ol></pre></div></div> <p>问题分析：</p> <p>由于该问题场景复现极其困难，只能依赖大数据复现，因此工具的作用并不大。最终只能排查代码，将前文伪代码写法2的代码全部分离，采用自定义对象与uv对象独立创建的形式，修改完毕后，该问题不再复现。修改如下：</p> <p><span><img height="106.25434854936434" originheight="284" originwidth="2459" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.91699645193818115052825185660792:50001231000000:2800:DFF6850C3587C14EB5F6482CFEA00BB64487CD297CE0721772FA2D86F38CACA1.png" title="点击放大" width="920"></span></p> <p>问题结论：参考场景一，如果不确定自定义创建的对象与UV异步任务对象的生命周期管理是否同步，建议将两者分离开来，独立进行管理。</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>Context* context = <span class="hljs-keyword">new</span> Context;<span class="hljs-comment">//context为开发者自定义的对象</span></li><li><span class="hljs-type">uv_work_t</span>* work = <span class="hljs-keyword">new</span> <span class="hljs-type">uv_work_t</span>;</li><li>work-&gt;data = (<span class="hljs-type">void</span>*)context;</li><li><span class="hljs-built_in">uv_queue_work</span>(loop, work, [](<span class="hljs-type">uv_work_t</span>*){</li><li>    Context *ctx = (Context*)work-&gt;data;</li><li>    <span class="hljs-comment">//业务逻辑</span></li><li>}, [<span class="hljs-type">uv_work_t</span>* work, <span class="hljs-type">int</span> status] {</li><li>    Context *ctx = (Context*)work-&gt;data;</li><li>    <span class="hljs-comment">//业务逻辑</span></li><li>    <span class="hljs-keyword">delete</span> ctx; <span class="hljs-comment">//是否删除由开发者决定</span></li><li>    <span class="hljs-keyword">delete</span> work;</li><li>});</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section9369612205912">与libuv相关的Freeze案例<i class="anchor-icon anchor-icon-link" anchorid="section9369612205912" tips="复制节点链接"></i></h2><p>libuv作为框架提供给开发者一些异步IO的能力，它本身不会造成死锁。如果freeze栈体现的是libuv相关接口在栈顶，都是开发者在主线程（UI线程）调用了libuv一些阻塞式的接口导致。这种情况下，就需要开发者尽量避免在主线程调用libuv的阻塞接口，比如文件的同步读取。另外，开发者使用libuv接口不当也会造成卡死在事件循环框架上，这个后面会介绍到。</p> <p><strong>案例一、主线程调用uv阻塞接口</strong></p> <p>问题描述：某应用在主线程调用文件模块的同步接口，该TS接口底层使用uv底层能力。导致在sendfile的时候，阻塞主线程产生freeze。</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li>Tid:19473, Name:app_name</li><li>#00 pc 00000000000a457c /system/lib/ld-musl-aarch64.so.1(fbb1eb526bb54f59c5dc4f2521b68e52)</li><li>#01 pc 0000000000019f88 /system/lib64/platformsdk/libuv.so(uv__fs_work+2956)(afecd0c8f506e5fc1661ef2cb46dea9d)</li><li>#02 pc 000000000001c048 /system/lib64/platformsdk/libuv.so(uv_fs_sendfile+148)(afecd0c8f506e5fc1661ef2cb46dea9d)</li><li>#03 pc 000000000011d27c /system/lib64/module/file/libfs.z.so(OHOS::FileManagement::ModuleFileIO::OpenFile(OHOS::FileManagement::ModuleFileIO::FileInfo&amp;, OHOS::FileManagement::ModuleFileIO::FileInfo&amp;)+732)(c8dbb978ac2472548e07ccb7f6f9eb18)</li><li>#04 pc 000000000011c99c /system/lib64/module/file/libfs.z.so(OHOS::FileManagement::ModuleFileIO::CopyFile::Sync(napi_env__*, napi_callback_info__*) (.cfi)+756)(c8dbb978ac2472548e07ccb7f6f9eb18)</li><li>#05 pc 000000000003dec8 /system/lib64/platformsdk/libace_napi.z.so(panda::JSValueRef ArkNativeFunctionCallBack&lt;true&gt;(panda::JsiRuntimeCallInfo*)+216)(e9eee6ffeb9040c06af8fe2188c7ee8e)</li><li>#06 pc 00000000003f3b6c /system/lib64/module/arkcompiler/stub.an(RTStub_PushCallArgsAndDispatchNative+40)</li><li>#07 at handleSendVideo (entry|feat_chat|1.0.0|<span class="hljs-attribute">src/main/ets/viewmodel/ChatViewModel.ts</span>:<span class="hljs-number">874</span>:<span class="hljs-number">1</span>)</li><li>#<span class="hljs-number">08</span> pc <span class="hljs-number">00000000003</span>a1500 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">InterpreterAssembly</span>::<span class="hljs-built_in">GeneratorReEnterInterpreter</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSThread*, <span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSHandle&lt;<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::GeneratorContext&gt;)+<span class="hljs-number">104</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">09</span> pc <span class="hljs-number">00000000003</span>db234 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">EcmaInterpreter</span>::<span class="hljs-built_in">GeneratorReEnterInterpreter</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSThread*, <span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSHandle&lt;<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::GeneratorContext&gt;)+<span class="hljs-number">144</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">10</span> pc <span class="hljs-number">000000000038</span>fc34 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">GeneratorHelper</span>::<span class="hljs-built_in">Next</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSThread*, <span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSHandle&lt;<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::GeneratorContext&gt; const&amp;, <span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSTaggedValue)+<span class="hljs-number">156</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">11</span> pc <span class="hljs-number">000000000046</span>c6c0 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">12</span> pc <span class="hljs-number">00000000002757</span>ac /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">builtins</span>::<span class="hljs-attribute">BuiltinsPromiseHandler</span>::<span class="hljs-built_in">AsyncAwaitFulfilled</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaRuntimeCallInfo*)+<span class="hljs-number">112</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">13</span> pc <span class="hljs-number">00000000003</span>f37b0 /system/lib64/module/arkcompiler/stub.<span class="hljs-built_in">an</span>(RTStub_AsmInterpreterEntry+<span class="hljs-number">208</span>)</li><li>#<span class="hljs-number">14</span> pc <span class="hljs-number">00000000003</span>a12b8 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">InterpreterAssembly</span>::<span class="hljs-built_in">Execute</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaRuntimeCallInfo*)+<span class="hljs-number">216</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">15</span> pc <span class="hljs-number">0000000000277568</span> /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">builtins</span>::<span class="hljs-attribute">BuiltinsPromiseJob</span>::<span class="hljs-built_in">PromiseReactionJob</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaRuntimeCallInfo*)+<span class="hljs-number">344</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">16</span> pc <span class="hljs-number">00000000003</span>f37b0 /system/lib64/module/arkcompiler/stub.<span class="hljs-built_in">an</span>(RTStub_AsmInterpreterEntry+<span class="hljs-number">208</span>)</li><li>#<span class="hljs-number">17</span> pc <span class="hljs-number">00000000003</span>a12b8 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">InterpreterAssembly</span>::<span class="hljs-built_in">Execute</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaRuntimeCallInfo*)+<span class="hljs-number">216</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">18</span> pc <span class="hljs-number">0000000000408</span>d18 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">job</span>::<span class="hljs-attribute">MicroJobQueue</span>::<span class="hljs-built_in">ExecutePendingJob</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSThread*, <span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::JSHandle&lt;<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">job</span>::MicroJobQueue&gt;)+<span class="hljs-number">552</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">19</span> pc <span class="hljs-number">0000000000367</span>d78 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::<span class="hljs-attribute">EcmaContext</span>::<span class="hljs-built_in">ExecutePromisePendingJob</span>()+<span class="hljs-number">92</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">20</span> pc <span class="hljs-number">000000000058</span>ebcc /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">PromiseCapabilityRef</span>::<span class="hljs-built_in">Resolve</span>(<span class="hljs-attribute">panda</span>::<span class="hljs-attribute">ecmascript</span>::EcmaVM const*, unsigned long)+<span class="hljs-number">256</span>)(<span class="hljs-number">77423</span>abf0869226a2e04e046a4b743b7)</li><li>#<span class="hljs-number">21</span> pc <span class="hljs-number">0000000000060</span>c28 /system/lib64/platformsdk/libace_napi.z.<span class="hljs-built_in">so</span>(napi_resolve_deferred+<span class="hljs-number">120</span>)(e9eee6ffeb9040c06af8fe2188c7ee8e)</li><li>#<span class="hljs-number">22</span> pc <span class="hljs-number">00000000005455</span>c0 /system/lib64/libmedialibrary_nutils.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">Media</span>::<span class="hljs-attribute">MediaLibraryNapiUtils</span>::<span class="hljs-built_in">InvokeJSAsyncMethod</span>(napi_env__*, napi_deferred__*, napi_ref__*, napi_async_work__*, <span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">Media</span>::JSAsyncContextOutput const&amp;) (.cfi)+<span class="hljs-number">264</span>)(c9ee202598f64bfbd76934922ac5a1e8)</li><li>#<span class="hljs-number">23</span> pc <span class="hljs-number">00000000004729</span>d0 /system/lib64/libmedialibrary_nutils.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">Media</span>::<span class="hljs-built_in">JSGetThumbnailCompleteCallback</span>(napi_env__*, napi_status, <span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">Media</span>::FileAssetAsyncContext*) (.cfi)+<span class="hljs-number">504</span>)(c9ee202598f64bfbd76934922ac5a1e8)</li><li>#<span class="hljs-number">24</span> pc <span class="hljs-number">000000000006652</span>c /system/lib64/platformsdk/libace_napi.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">NativeAsyncWork</span>::<span class="hljs-built_in">AsyncAfterWorkCallback</span>(uv_work_s*, int)+<span class="hljs-number">524</span>)(e9eee6ffeb9040c06af8fe2188c7ee8e)</li><li>#<span class="hljs-number">25</span> pc <span class="hljs-number">000000000007</span>c9c0 /system/lib64/platformsdk/libruntime.z.<span class="hljs-built_in">so</span>(<span class="hljs-number">929</span>be9ac71f5f1b8c50d931718342ac3)</li><li>#<span class="hljs-number">26</span> pc <span class="hljs-number">000000000001</span>bdb4 /system/lib64/chipset-pub-sdk/libeventhandler.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::<span class="hljs-attribute">EventHandler</span>::<span class="hljs-built_in">DistributeEvent</span>(<span class="hljs-attribute">std</span>::<span class="hljs-attribute">__h</span>::unique_ptr&lt;<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::InnerEvent, void (*)(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::InnerEvent*)&gt; const&amp;)+<span class="hljs-number">1140</span>)(ea7c9b930d7b542607af81677dd531e7)</li><li>#<span class="hljs-number">27</span> pc <span class="hljs-number">000000000002</span>d6a8 /system/lib64/chipset-pub-sdk/libeventhandler.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::(anonymous namespace)::<span class="hljs-attribute">EventRunnerImpl</span>::<span class="hljs-built_in">ExecuteEventHandler</span>(<span class="hljs-attribute">std</span>::<span class="hljs-attribute">__h</span>::unique_ptr&lt;<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::InnerEvent, void (*)(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::InnerEvent*)&gt;&amp;)+<span class="hljs-number">348</span>)(ea7c9b930d7b542607af81677dd531e7)</li><li>#<span class="hljs-number">28</span> pc <span class="hljs-number">000000000002</span>cf64 /system/lib64/chipset-pub-sdk/libeventhandler.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::(anonymous namespace)::<span class="hljs-attribute">EventRunnerImpl</span>::<span class="hljs-built_in">Run</span>()+<span class="hljs-number">908</span>)(ea7c9b930d7b542607af81677dd531e7)</li><li>#<span class="hljs-number">29</span> pc <span class="hljs-number">0000000000030308</span> /system/lib64/chipset-pub-sdk/libeventhandler.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::<span class="hljs-attribute">EventRunner</span>::<span class="hljs-built_in">Run</span>()+<span class="hljs-number">528</span>)(ea7c9b930d7b542607af81677dd531e7)</li><li>#<span class="hljs-number">30</span> pc <span class="hljs-number">00000000000</span>b19ac /system/lib64/platformsdk/libappkit_native.z.<span class="hljs-built_in">so</span>(<span class="hljs-attribute">OHOS</span>::<span class="hljs-attribute">AppExecFwk</span>::<span class="hljs-attribute">MainThread</span>::<span class="hljs-built_in">Start</span>()+<span class="hljs-number">400</span>)(fe61820fe652b04577747dfc89270211)</li><li>#<span class="hljs-number">31</span> pc <span class="hljs-number">0000000000004</span>e34 /system/lib64/appspawn/appspawn/libappspawn_ace.z.<span class="hljs-built_in">so</span>(<span class="hljs-built_in">RunChildProcessor</span>(AppSpawnContent*, AppSpawnClient*)+<span class="hljs-number">568</span>)(<span class="hljs-number">7</span>c113fbf97a325774d8a727348d15388)</li><li>#<span class="hljs-number">32</span> pc <span class="hljs-number">000000000000</span>ba7c /system/bin/<span class="hljs-built_in">appspawn</span>(AppSpawnChild+<span class="hljs-number">576</span>)(<span class="hljs-number">3</span>d47202f3e52b59a2a29815389a567f0)</li><li>#<span class="hljs-number">33</span> pc <span class="hljs-number">0000000000015320</span> /system/bin/<span class="hljs-built_in">appspawn</span>(ProcessSpawnReqMsg+<span class="hljs-number">3180</span>)(<span class="hljs-number">3</span>d47202f3e52b59a2a29815389a567f0)</li><li>#<span class="hljs-number">34</span> pc <span class="hljs-number">00000000000134</span>b8 /system/bin/<span class="hljs-built_in">appspawn</span>(OnReceiveRequest+<span class="hljs-number">132</span>)(<span class="hljs-number">3</span>d47202f3e52b59a2a29815389a567f0)</li><li>#<span class="hljs-number">35</span> pc <span class="hljs-number">0000000000016</span>cf8 /system/lib64/chipset-pub-sdk/libbegetutil.z.<span class="hljs-built_in">so</span>(HandleRecvMsg_+<span class="hljs-number">344</span>)(<span class="hljs-number">3</span>e5c25bc70c753fec6381de8070a97e0)</li><li>#<span class="hljs-number">36</span> pc <span class="hljs-number">00000000000167</span>cc /system/lib64/chipset-pub-sdk/libbegetutil.z.<span class="hljs-built_in">so</span>(HandleStreamEvent_+<span class="hljs-number">192</span>)(<span class="hljs-number">3</span>e5c25bc70c753fec6381de8070a97e0)</li><li>#<span class="hljs-number">37</span> pc <span class="hljs-number">0000000000013</span>eac /system/lib64/chipset-pub-sdk/libbegetutil.z.<span class="hljs-built_in">so</span>(ProcessEvent+<span class="hljs-number">88</span>)(<span class="hljs-number">3</span>e5c25bc70c753fec6381de8070a97e0)</li><li>#<span class="hljs-number">38</span> pc <span class="hljs-number">0000000000013</span>a68 /system/lib64/chipset-pub-sdk/libbegetutil.z.<span class="hljs-built_in">so</span>(RunLoop_+<span class="hljs-number">308</span>)(<span class="hljs-number">3</span>e5c25bc70c753fec6381de8070a97e0)</li><li>#<span class="hljs-number">39</span> pc <span class="hljs-number">00000000000113</span>b4 /system/bin/<span class="hljs-built_in">appspawn</span>(AppSpawnRun+<span class="hljs-number">212</span>)(<span class="hljs-number">3</span>d47202f3e52b59a2a29815389a567f0)</li><li>#<span class="hljs-number">40</span> pc <span class="hljs-number">000000000000</span>ecd4 /system/bin/<span class="hljs-built_in">appspawn</span>(main+<span class="hljs-number">764</span>)(<span class="hljs-number">3</span>d47202f3e52b59a2a29815389a567f0)</li><li>#<span class="hljs-number">41</span> pc <span class="hljs-number">00000000000</span>a12c0 /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(libc_start_main_stage2+<span class="hljs-number">64</span>)(fbb1eb526bb54f59c5dc4f2521b68e52)</li></ol></pre></div></div> <p>问题结论：</p> <p>开发者在使用文件同步接口时，不要在主线程上调用。建议在worker线程或taskpool中调用。</p> <p><strong>案例二、pdf必现卡死在事件循环</strong></p> <p>问题描述：应用在taskpool场景中调用其他SDK中的so接口时，会导致在libuv上卡死。</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-shell" data-highlighted="yes"><ol class="linenums"><li>Tid:61139, Name:example.pdftest</li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">00 pc 0000000000018044 /system/lib64/platformsdk/libuv.so(uv async_io+360)(fe4a9f2630458fa5b8b7b0e4dacc5f9a)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">01 pc 0000000000017720 /system/lib64/platformsdk/libuv.so(uv_io_poll+1268)(fe4a9f2630458fa5b8b7b0e4dacc5f9a)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">02 pc 0000000000018540 /system/lib64/platformsdk/libuv.so(uv_run+376)(fe4a9f2630458fa5b8b7b0e4dacc5f9a)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">03 pc 00000000000768b4 /system/lib64/platformsdk/libruntime.z.so(OHOS::AbilityRuntime::OHOSLoopHandler:OnTriggered()+148)(09902ebffe1260cecd7be3e24ad58df5)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">04 pc 00000000000195b8 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(96fe4d4a21391569c237423eae1d16df)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">05 pc 0000000000015324 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EventHandler:DistributeEvent(std: h:unique ptrOHOS::AppExecFwk:In</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">06 pc 0000000000023f78 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk:(anonymous namespace):EventRunnerImpl:ExecuteEventHandler(std:: hu</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">07 pc 0000000000023850 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::(anonymous namespace)::EventRunnerImpl:Run()+872)(96fe4d4a2139156S</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">08 pc 0000000000026628/system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EventRunner:Run()+284)(96fe4d4a21391569c237423eae1d16df)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">09 pc 00000000000a5bb4 /system/lib64/platformsdk/libappkit_native.z.so(OHOS::AppExecFwk:MainThread::Start()+764)(b926a67fe9460965838f4a20dbd3a020)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">10 pc 0000000000004880 /system/lib64/appspawn/appspawn/libappspawn_ace.z.so(RunChildProcessor(AppSpawnContent*, AppSpawnClient*)+216)(1f4858241fab18c5ee268</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">11 pc 0000000000008788 /system/bin/appspawn(AppSpawnChild+404)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">12 pc 00000000000084c8 /system/bin/appspawn(AppSpawnProcessMsg+636)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">13 pc 000000000000f974 /system/bin/appspawn(ProcessSpawnReqMsg+228)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">14 pc 000000000000f224 /system/bin/appspawn(OnReceiveRequest+172)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">15 pc 0000000000017c9c /system/lib64/chipset-pub-sdk/libbegetutil.z.so(HandleRecvMsg_+260)(6725d8c1610eb726305c093a8f27148c)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">16 pc 00000000000177bc /system/lib64/chipset-pub-sdk/libbegetutil.z.so(HandleStreamEvent_+168)(6725d8c1610eb726305c093a8f27148c)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">17 pc 0000000000014ee0/system/lib64/chipset-pub-sdk/libbegetutil.z.so(ProcessEvent+108)(6725d8c1610eb726305c093a8f27148c)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">18 pc 0000000000014aa0/system/lib64/chipset-pub-sdk/libbegetutil.z.so(RunLoop_+356)(6725d8c1610eb726305c093a8f27148c)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">19 pc 000000000000d3bc /system/bin/appspawn(AppSpawnRun+136)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">20 pc 000000000000ad20 /system/bin/appspawn(main+708)(3d1b41c7794e59721bc566882e35a530)</span></li><li><span class="hljs-meta prompt_">#</span><span class="language-bash">21 pc 000000000009eac0 /system/lib/ld-musl-aarch64.so.1(libc start main stage2+64)(82429be6ea2851745621f83dce721120)</span></li></ol></pre></div></div> <p>问题分析：</p> <p>首先经过反编译，看一下卡死在哪一行：</p> <p><span><img originheight="448" originwidth="597" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.80500465711761315812604236905660:50001231000000:2800:44CC29E2294297B55A9365886E185C30ACEDAFFFFFF24CE33B59773C4D4640D5.png" width="597" height="448"></span></p> <p>这段代码的逻辑是依次遍历loop上的队列，判断内部的pending是否已更改。如果已更改，则往下执行传入的回调函数。</p> <p>Freeze发生在这个循环里，一直处于死循环。造成这种现象的原因主要有两种。</p> <ul><li>队列无限长。</li><li>摘下来的结点又挂在了队列上。</li></ul> <p>针对第一种情况，可能性较低。经过加日志验证，确实不是该原因导致的。对于第二种情况，通过GDB调试，模拟出卡死时链表的操作过程：</p> <p><span><img originheight="1095" originwidth="1213" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.28624111487690702026685175708974:50001231000000:2800:9DC52C17ECE316C1CDB772BA7BE083497C8900DFE77320C30947D87B2E2B078A.png" width="920" height="830.5028854080791"></span></p> <p>该图显示，在卡死发生时，遍历loop上的async_handles队列会将之前取出的节点重新挂载到当前队列上，导致死循环。这种现象可能是由于同一个句柄在两个事件循环中初始化，导致两个链表互相交织。为了验证这一推断，我们再次加日志复现，日志如下：</p> <p><span><img originheight="345" originwidth="1036" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.10770398288655806460707117839592:50001231000000:2800:0270A0F7B2D98B439C23F65B56550AAF64F2C0B1A904523EE396E562E173B2B8.png" width="920" height="306.3706563706564"></span></p> <p>该日志证明了同一个句柄在主线程的loop和taskpool的TaskWorker线程上进行了初始化。</p> <p>接下来查看该SDK下的so代码，代码如下：</p> <p><span><img originheight="612" originwidth="765" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.77433558846899496550093996711356:50001231000000:2800:15C9AA9E1A253F2F63552B10E1843C072D1A7545B650A3B4B856D02BE99F9FD2.png" width="765" height="612"></span></p> <p><span><img originheight="146" originwidth="645" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.76487472642557529137919160803581:50001231000000:2800:AE96F1FAF5C6922FEF357504706BF77097F69FCD66EA2C796EC7246463D34929.png" width="645" height="146"></span></p> <p>该代码保存了一个普通的uv_async_t对象在静态对象中，但未进行call_once处理，导致每次导入组件时都会初始化，从而造成同一个句柄在不同的事件循环中被多次初始化。</p> <p>问题结论：开发者应使用call_once处理单例，避免同一个句柄在不同事件循环中初始化，这会导致事件循环死循环。如果在主线程上，可能会出现系统冻结。此外，一个句柄在一个事件循环中初始化两次会导致之前初始化的节点丢失，进而引发功能失效。如果开发者遇到创建了多个napi_threadsafe_function或uv_async_t，且触发这些句柄时回调未执行，可以考虑上述问题。</p> </div> <div class="tiledSection"><h2 id="section194211622175919">double close问题导致的libuv的crash<i class="anchor-icon anchor-icon-link" anchorid="section194211622175919" tips="复制节点链接"></i></h2><p><strong>double close详解</strong></p> <p>问题描述：libuv作为异步I/O的事件调度框架，核心逻辑使用文件描述符（fd）驱动。其内部代码在调用fd相关的系统调用后，如果检测到errno不符合预期，会终止程序。在HarmonyOS上，事件循环延续了这一做法，但在终止之前会获取更多信息。以下是fd异常时的崩溃栈：</p> <div _ngcontent-qvy-c106="" class="highlight-div"><div _ngcontent-qvy-c106="" class="highlight-div-header"><div _ngcontent-qvy-c106="" class="highlight-div-header-left"><div _ngcontent-qvy-c106="" class="handle-button expand-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvy-c106="" class="highlight-div-header-right"><div _ngcontent-qvy-c106="" class="handle-button ai-button"></div><div _ngcontent-qvy-c106="" class="handle-button line-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvy-c106="" class="handle-button theme-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvy-c106="" class="handle-button copy-button"><div _ngcontent-qvy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-number">569</span><span class="hljs-title class_">s</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGABRT</span>(<span class="hljs-title class_">SI_TKILL</span>)@<span class="hljs-number">0x01317b430000996b</span> <span class="hljs-keyword">from</span>:<span class="hljs-number">39275</span>:<span class="hljs-number">20020035</span></li><li><span class="hljs-variable">LastFatalMessage</span>:<span class="hljs-title class_">errno</span> <span class="hljs-keyword">is</span> <span class="hljs-number">9</span>, <span class="hljs-variable">loop</span> <span class="hljs-variable">addr</span> <span class="hljs-keyword">is</span> <span class="hljs-number">385399404800</span>, <span class="hljs-variable">fd</span> <span class="hljs-keyword">is</span> <span class="hljs-number">315</span> (../../../<span class="hljs-variable">third_party</span>/<span class="hljs-variable">libuv</span>/<span class="hljs-variable">src</span>/<span class="hljs-variable">unix</span>/<span class="hljs-variable">async</span>.<span class="hljs-variable">c</span>:<span class="hljs-title class_">uv_async_send</span>:<span class="hljs-number">170</span>)</li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">39304</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">OS</span> <span class="hljs-title class_">TaskManager</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000197420</span>./<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span> (<span class="hljs-variable">raise</span>+<span class="hljs-number">228</span>)(<span class="hljs-variable">b168</span>£<span class="hljs-number">10</span><span class="hljs-variable">a179c</span>£<span class="hljs-number">6050</span><span class="hljs-variable">a309242262e6a17</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000145760</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">abort</span>+<span class="hljs-number">20</span>)(<span class="hljs-variable">b168f10a179cf6050a309242262e6a17</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000017814</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uv_async_send</span>+<span class="hljs-number">360</span>)(<span class="hljs-number">23</span><span class="hljs-variable">ffblfca6d55d23fe917788b2334b12</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-variable">bb3c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">libtaskpool</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">Commonlibrary</span>::<span class="hljs-title class_">Concurrent</span>:: <span class="hljs-title class_">TaskPoolModule</span>::<span class="hljs-title class_">TaskManager</span>:: <span class="hljs-title class_">TryExpand</span> ()+<span class="hljs-number">60</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000017</span><span class="hljs-variable">be0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uvasync_io</span>+<span class="hljs-number">352</span>)(<span class="hljs-number">23</span><span class="hljs-variable">ffb1fca6d55d23fe917788b2334b12</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000017258</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uvio</span> <span class="hljs-variable">poll</span>+<span class="hljs-number">956</span>)(<span class="hljs-number">23</span><span class="hljs-variable">ffblfca6d55d23fe917788b2334b12</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000180e4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libuv</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">uv</span> <span class="hljs-variable">_run</span>+<span class="hljs-number">376</span>)(<span class="hljs-number">23</span><span class="hljs-variable">ffblfca6d55d23fe917788b2334b12</span>)</li><li>#<span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-variable">cc88</span>./<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">libtaskpool</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">Commonlibrary</span>::<span class="hljs-title class_">Concurrent</span>::<span class="hljs-title class_">TaskPoolModule</span>:: <span class="hljs-title class_">TaskManager</span>:: <span class="hljs-title class_">RunTaskManager</span> ()+<span class="hljs-number">172</span>)</li><li>#<span class="hljs-number">08</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001e058</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">libtaskpool</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">e18ade536547e34d8ef7a614e073</span>£<span class="hljs-number">74</span><span class="hljs-variable">a</span>)</li><li>#<span class="hljs-number">09</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000001</span><span class="hljs-variable">b87ac</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">start</span>+<span class="hljs-number">236</span>)(<span class="hljs-variable">b168</span>£<span class="hljs-number">10</span><span class="hljs-variable">a179c</span>£<span class="hljs-number">6050</span><span class="hljs-variable">a309242262e6a17</span>)</li></ol></pre></div></div> <p>当前上面的崩溃栈只是libuv异常终止的其中一处，其余的栈与上述崩溃栈类似，都有LastFatalMessage信息，且第0、1帧都是musl库raise和abort，第2帧为libuv的代码。其中LastFatalMessage字段的含义是指，操作的是哪个fd，返回的errno是多少，这个fd属于哪个事件循环（一个ArkTS线程对应一个事件循环，开发者自己创建的uv_loop_t也是一个事件循环）。</p> <p>问题分析：</p> <p>针对上述崩溃栈，errno为9，表示该问题为double close问题。如果errno为22，也是double close问题。double close的模型为：</p> <p>三个模块A，B，C，接下来按照顺序执行。</p> <ol><li>A申请一个fd，假设fd为100，并将其共享给B。</li><li>B使用完，将数值为100的fd关闭。</li><li>C此时去申请fd，假设内核此时分配的fd也为100（极有可能），C拿着进行操作。</li><li>A此时还不知道为100的fd已经被B关闭了，现在到了A关闭fd操作的时候了，因此A调用了一次close操作。</li><li>C使用该fd的时候崩溃。</li></ol> <p>经过大量的试验，double close可能造成的影响主要有三种：</p> <ol><li>如果A创建的fd被B关闭后，此时该fd未被分配给其他模块，在使用时会报errno = 9的错误。</li><li>如果A创建的fd被B关闭后，该fd已经被分配给其他模块，但与之前的类型不一致（比如旧的fd是eventfd类型，新创建的fd是一个文件类型），会报错errno=22。</li><li>如果A创建的文件描述符（fd）被B关闭后，该fd被分配给其他模块且类型相同，就会发生文件冲突。例如，A线程有一个事件循环，触发回调需要往A的fd写字符。如果B线程创建的事件循环获取了这个fd，所有原本应触发到A线程的回调将无法正常执行，而是会触发到B线程的事件循环中。</li></ol> <p>排查方法：</p> <ol><li>如果应用进程内包含native侧代码并涉及文件操作，在对文件描述符 (fd) 进行操作时，必须遵循谁申请谁释放的原则。若有特殊业务需求，例如透传fd，需明确约定：透传方不得对透传的fd执行close操作，确保每个fd仅创建一次并仅关闭一次。</li><li>如果没有ArkTS层有使用TS接口，返回了具体的fd数字，需要按照第一条方法操作fd。另外，fd是从0开始的，开发者一定要保证关闭后，将该变量设为-1，而不是0。</li></ol> <p><strong>案例一、某应用退出账号，重新启动闪退（偶现）</strong></p> <p>问题描述：应用存在double close导致偶现崩溃。复现步骤为退出账号后点击应用，出现crash。崩溃栈与文章第一幅图中的崩溃栈一致，主要集中在worker线程或与taskpool相关的线程（TaskManager线程、TaskWorker线程）。</p> <p><span><img originheight="142" originwidth="899" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.03368155938468741193701088703127:50001231000000:2800:5A04A4010AA7F7DDCAB4AD107AB0543E0E6EE5A4C11FDB5DA2BC2618C88B50DE.png" width="899" height="142"></span></p> <p>问题分析：</p> <p>排查应用方代码，代码如下：</p> <p><span><img originheight="744" originwidth="900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163458.83469508696289970149260803003279:50001231000000:2800:DD4B7707ED42EE5917EDD8A2B54FF57916DD834761A95039EE8CF17D8BA6A2B6.png" width="900" height="744"></span></p> <p>其中rawFileDescriptor是资源管理子系统通过rawFilePath获取的文件描述符的管理对象。</p> <p>注释部分表示第一次关闭操作是通过文件管理子系统的close接口完成的。第二次关闭操作是通过rawFilePath文件路径，传入资源管理子系统的closeRawFd接口进行的。这两次关闭操作正好对应了插件捕获的两次调用栈。</p> <p>解决方法：</p> <p>按照上图中的代码注释，将多余的close操作进行删除即可。</p> </div> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/LibuvDevelopment" target="_blank">libuv使用规范及案例</a></li></ul> </div> </div> <div></div></div>