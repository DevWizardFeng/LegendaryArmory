<h1 _ngcontent-tnw-c119="" class="doc-title ng-star-inserted" title="三方动态链接库集成"> 三方动态链接库集成 </h1>

<div _ngcontent-tnw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section14752131219546">概述<i class="anchor-icon anchor-icon-link" anchorid="section14752131219546" tips="复制节点链接"></i></h2><p>在实际项目中，业务功能可能由不同“团队/组织”提供，如：团队A开发功能编译生成so库，团队B引用so库进行后续开发。so库可以将项目的不同功能模块化，提升代码的复用性和工程的可维护性。团队开发过程中引用三方so库的场景可分为两种：</p> <ol><li>在Native侧引用三方so库。</li><li>在ArkTS侧引用三方so库。</li></ol> <p>下面针对这两种场景给出具体的实现方案。</p> </div> <div class="tiledSection"><h2 id="section97550424131">在Native侧引用三方so库<i class="anchor-icon anchor-icon-link" anchorid="section97550424131" tips="复制节点链接"></i></h2><p>按照实际开发场景可分为两部分：编译生成so库和在Native侧引用so库。</p> <p>第一部分：开发功能函数，编译生成so库。具体操作可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-cmake" target="_blank">使用命令行CMake构建NDK工程</a>。</p> <p>第二部分：在Native侧引用so库调用功能函数。可以采用如下两种方案：</p> <ul><li>方案一：通过编译动态链接库的方式引用。</li><li>方案二：通过调用dlopen的方式引用。</li></ul> </div> <div class="tiledSection"><h3 id="section119581494293" class="firsth2">通过编译动态链接库的方式引用<i class="anchor-icon anchor-icon-link" anchorid="section119581494293" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>将so库加入到工程中，在Native侧使用CMake编译动态链接库，通过include引用头文件调用功能函数。</p> <p><strong>开发步骤</strong></p> <p>以引用一个加法计算so库为例，具体实现步骤如下：</p> <ol><li>将第一部分生成的so库文件置于entry/libs对应的架构目录下，将其对应的头文件置于src/main/cpp目录下。<p><span><img originheight="194" originwidth="198" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.89910127045403063680118492631622:50001231000000:2800:FB553781B4F058DD50CF0BBFA36E487EFE68C45EF916DA547F0A5F159C8EE459.png" class="notEnlarge" width="198" height="194"></span></p> <p><span><img originheight="138" originwidth="168" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.22050060919280559071350858355796:50001231000000:2800:CB44BEBD3FE5215BF8F3BC5245A67F4CA11162E4818D64BD9EE2BB8AEBCB4FB3.png" class="notEnlarge" width="168" height="138"></span></p> </li><li>修改src/main/cpp目录下CMakeLists.txt文件配置，使用target_link_libraries命令将需要预加载的加法so库链接到项目中。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/CMakeLists.txt#L18-L19" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># Compile and link third-party SO libraries</span></li><li>target_link_libraries(entry PUBLIC <span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span>/../../../libs/<span class="hljs-variable">${OHOS_ARCH}</span>/libnativeAdd.so)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/CMakeLists.txt#L18-L19" target="_blank">CMakeLists.txt</a></div></div></div></div> </li><li>在Native侧通过头文件引用加法so库。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/napi_init.cpp#L29-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_nativeAdd</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>
</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    napi_valuetype valuetype0;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">0</span>], &amp;valuetype0);</li><li>
</li><li>    napi_valuetype valuetype1;</li><li>    <span class="hljs-built_in">napi_typeof</span>(env, args[<span class="hljs-number">1</span>], &amp;valuetype1);</li><li>
</li><li>    <span class="hljs-type">double</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>
</li><li>    <span class="hljs-type">double</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>
</li><li>    napi_value ret;</li><li>    <span class="hljs-built_in">napi_create_double</span>(env, <span class="hljs-built_in">add</span>(value0, value1), &amp;ret);</li><li>
</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"nativeAdd"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_nativeAdd, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/napi_init.cpp#L29-L103" target="_blank">napi_init.cpp</a></div></div></div></div> </li><li>在index.d.ts文件中导出Native侧提供的接口，在ArkTS侧进行结果验证。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L16-L17" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Export the addition calculation APIs provided on the Native side</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">nativeAdd</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L16-L17" target="_blank">Index.d.ts</a></div></div></div></div> <p>在ArkTS侧调用Native侧提供的接口进行加法计算。</p> <div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L80-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Integrate the SO library on the Native side directly to complete the addition operation</span></li><li><span class="hljs-keyword">let</span> result = testNapi.<span class="hljs-title function_">nativeAdd</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramX</span>), <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramY</span>));</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L80-L81" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <div class="fignone"><span class="figcap"><b>图1 </b>在Native侧通过编译动态链接库的方式引用so库完成加法运算效果展示</span><br><span><img height="551.95" originheight="664" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.81753240922684549843888514928831:50001231000000:2800:97AF04059F7A5C80E82C196510845B6C410C5ACD0FD77D25116D20A7C69072F0.png" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section20854112911591">通过调用dlopen的方式引用<i class="anchor-icon anchor-icon-link" anchorid="section20854112911591" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>将so库加入到工程中，在ArkTS侧将so库的沙箱路径传递至Native侧，在Native侧使用dlopen解析so库调用功能函数。但是需要注意，该方案只能引用C语言编译模式生成的so库，因此用于生成so库的.h头文件需要用extern "C" {}包裹。</p> <p><strong>开发步骤</strong></p> <p>以引用一个减法计算so库为例，具体实现步骤如下：</p> <ol><li>将第一部分生成的so库文件置于entry/libs对应的架构目录下。<p><span><img originheight="197" originwidth="201" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.31551360985572235862450576967207:50001231000000:2800:358CB6C95F4BE94BED73D560F64219A0DC40520283A8C52E3A3A3EA7E0EF5131.png" class="notEnlarge" width="201" height="197"></span></p> </li><li>在ArkTS侧将so库的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-sandbox-directory" target="_blank">沙箱路径</a>传递至Native侧。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>此处需要使用so库的沙箱路径，而不是其真实路径。</p> <p>为保障用户隐私安全，dlopen具有命名空间隔离能力，应用可以加载的动态库受到命名空间的限制。一般应用只能够加载应用安装包目录/data/storage/el1/bundle下的动态库，以及系统内置对外开放的动态库，若加载自定义路径动态库会报错：MUSL-LDSO bundlename E Open absolute_path library: check ns accessible failed, pathname libxxx.so namespace moduleNs_default。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L96-L98" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> projectPath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">bundleCodeDir</span>; <span class="hljs-comment">// Get the project path</span></li><li><span class="hljs-keyword">let</span> abiPath = deviceInfo.<span class="hljs-property">abiList</span> === <span class="hljs-string">'x86_64'</span> ? <span class="hljs-string">'x86_64'</span> : <span class="hljs-string">'arm64'</span>;</li><li><span class="hljs-keyword">let</span> soLibPath = <span class="hljs-string">`<span class="hljs-subst">${projectPath}</span>/libs/<span class="hljs-subst">${abiPath}</span>/libnativeSub.so`</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L96-L98" target="_blank">Index.ets</a></div></div></div></div> </li><li>在Native侧引入dlfcn.h，通过调用dlopen解析so库实现减法计算。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/napi_init.cpp#L61-L104" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">double</span> <span class="hljs-params">(*Sub)</span><span class="hljs-params">(<span class="hljs-type">double</span>, <span class="hljs-type">double</span>)</span></span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">NAPI_Global_nativeSub</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    napi_value args[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-type">double</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>    <span class="hljs-type">double</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_double</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;</li><li>    napi_status status = <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">2</span>], <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;length);</li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-type">char</span> *path = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[length + <span class="hljs-number">1</span>];</li><li>    std::<span class="hljs-built_in">memset</span>(path, <span class="hljs-number">0</span>, length + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, args[<span class="hljs-number">2</span>], path, length + <span class="hljs-number">1</span>, &amp;length); <span class="hljs-comment">// Get the SO library path information</span></li><li>    <span class="hljs-type">void</span> *handle = <span class="hljs-built_in">dlopen</span>(path, RTLD_LAZY);                              <span class="hljs-comment">// Open a SO library and get the path</span></li><li>    napi_value result = <span class="hljs-literal">nullptr</span>;</li><li>    Sub sub_func = (Sub)<span class="hljs-built_in">dlsym</span>(handle, <span class="hljs-string">"sub"</span>); <span class="hljs-comment">// Get the function named sub</span></li><li>    status = <span class="hljs-built_in">napi_create_double</span>(env, <span class="hljs-built_in">sub_func</span>(value0, value1), &amp;result);</li><li>    <span class="hljs-keyword">delete</span>[] path;</li><li>    <span class="hljs-built_in">dlclose</span>(handle); <span class="hljs-comment">// Remember to close the SO library</span></li><li>    <span class="hljs-keyword">if</span> (status != napi_ok) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> result;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        <span class="hljs-comment">// ...</span></li><li>        {<span class="hljs-string">"nativeSub"</span>, <span class="hljs-literal">nullptr</span>, NAPI_Global_nativeSub, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/napi_init.cpp#L61-L104" target="_blank">napi_init.cpp</a></div></div></div></div> </li><li>在index.d.ts文件中导出Native侧提供的接口，在ArkTS侧进行结果验证。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L21-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Export the subtraction calculation interface provided by the Native side</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">nativeSub</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, path: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L21-L22" target="_blank">Index.d.ts</a></div></div></div></div> <p>在ArkTS侧调用Native侧提供的接口进行减法计算。</p> <div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L101-L102" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Integrate the SO library on the Native side by dlopen to complete the subtraction operation</span></li><li><span class="hljs-keyword">let</span> result = testNapi.<span class="hljs-title function_">nativeSub</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramX</span>), <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramY</span>), soLibPath);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L101-L102" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <div class="fignone"><span class="figcap"><b>图2 </b>在Native侧通过调用dlopen引用三方so库完成减法运算效果展示</span><br><span><img height="551.95" originheight="664" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.86213722214405182470030443561553:50001231000000:2800:BAD77E671FD3259D605E34C3D70A988CFD5B6FDF50D3330C5FF49ABAF4D558A6.png" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h2 id="section166546365376">在ArkTS侧引用三方so库<i class="anchor-icon anchor-icon-link" anchorid="section166546365376" tips="复制节点链接"></i></h2><p>按照实际开发场景可分为两部分：生成适配Native的so库和在ArkTS侧引用so库。</p> <p>第一部分：开发功能函数，编译生成so库并适配Native。具体操作可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-cmake" target="_blank">使用命令行CMake构建NDK工程</a>。</p> <p>第二部分：在ArkTS侧通过配置模块动态依赖的方式引用so库。</p> </div> <div class="tiledSection"><h3 id="section1077016378413" class="firsth2">通过配置模块动态依赖引用<i class="anchor-icon anchor-icon-link" anchorid="section1077016378413" tips="复制节点链接"></i></h3><p><strong>实现原理</strong></p> <p>将so库和对应的Native侧接口文件加入到工程中，在工程中配置so库对应的模块动态依赖，在ArkTS侧通过import引入依赖接口调用so库。但是需要注意该方案只能引用适配Native的so库，因此在编译生成so库时需要实现功能函数并<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-napi-process#native侧方法的实现" target="_blank">向Napi注册其Native侧接口</a>，提供对应的Native侧接口文件index.d.ts和配置文件oh-package.json5。</p> <p></p> <p><strong>开发步骤</strong></p> <p>以引用一个乘法计算so库为例，具体实现步骤如下：</p> </div> <ol><li>将第一部分生成的so库文件置于entry/libs对应的架构目录下。<p><span><img originheight="201" originwidth="198" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.03400974152290359321815531602029:50001231000000:2800:6725BEEA98706CE44A668466BEA02C6E94536FE6547FF89508A845366D110586.png" class="notEnlarge" width="198" height="201"></span></p> </li><li>在src/main/cpp/types下新建目录并将so库模块src/main/cpp/types目录下的index.d.ts、oh-package.json5移动到该目录下。<p><span><img originheight="177" originwidth="239" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.14989083443059735640779620311378:50001231000000:2800:F2C759556988C261464533C40648F0D95D992203634CB7073C3A810B106752CC.png" class="notEnlarge" width="239" height="177"></span></p> </li><li>在模块级oh-package.json5中声明乘法so库根目录路径。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/oh-package.json5#L2-L18" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-string">"dependencies"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// The declared dependency name should match the name of the referenced SO library</span></li><li>    <span class="hljs-string">"libmultiply.so"</span>: <span class="hljs-string">"file:./src/main/cpp/types/libmultiply"</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/oh-package.json5#L2-L18" target="_blank">oh-package.json5</a></div></div></div></div> </li><li>在ArkTS侧使用import引用oh-package.json5中声明的依赖并进行结果验证。<div class="screenLinkPre"><div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L117-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Integrate the SO library that has been adapted to Native On the ArkTS side to complete the multiplication operation</span></li><li><span class="hljs-keyword">let</span> result = multiplyNapi.<span class="hljs-title function_">multiply</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramX</span>), <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">paramY</span>));</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration/blob/master/entry/src/main/ets/pages/Index.ets#L117-L118" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <div class="fignone"><span class="figcap"><b>图3 </b>在ArkTS侧引用已经适配Native的三方so库完成乘法运算效果展示</span><br><span><img height="551.95" originheight="664" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.02317017708142896694263466579210:50001231000000:2800:6768883C41FE6ACE40AA4AF51A07D1966B4CFEC36F32878C8D2E9F33D859247D.png" title="点击放大" width="266"></span></div> <div class="tiledSection"><h2 id="section184428465196">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section184428465196" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section418228154916" class="firsth2">如何在同一个工程中实现三方so库的编译和引用<i class="anchor-icon anchor-icon-link" anchorid="section418228154916" tips="复制节点链接"></i></h3><p>可以在工程中创建两个Module，通过其中一个Module编译生成加法、减法和乘法运算so库，通过另外一个Module引用三方so库，进行结果验证。</p> <p><strong>参考链接</strong></p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-cmake" target="_blank">使用命令行CMake构建NDK工程</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/build-with-ndk-prebuilts" target="_blank">在NDK工程中使用预构建库</a></li></ul> </div> <div class="tiledSection"><h3 id="section15862162419491">在集成三方so库时，.so库文件和.h头文件一定要置于上述方法的路径下吗<i class="anchor-icon anchor-icon-link" anchorid="section15862162419491" tips="复制节点链接"></i></h3><p>不一定。原则上.so库文件和.h头文件可以置于需要引用so库的工程目录的任意位置，但是需要在工程的CMakeLists.txt文件中修改文件配置。如：将add.h头文件和libnativeAdd.so库文件放置在entry的根目录下，需要在CMakeLists.txt文件中通过include_directories命令添加entry的根目录作为头文件路径，并修改target_link_libraries命令中需要预加载的加法so库的路径，才能保证so库链接成功。</p> <p><strong>代码示例</strong></p> <div _ngcontent-tnw-c106="" class="highlight-div"><div _ngcontent-tnw-c106="" class="highlight-div-header"><div _ngcontent-tnw-c106="" class="highlight-div-header-left"><div _ngcontent-tnw-c106="" class="handle-button expand-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tnw-c106="" class="highlight-div-header-right"><div _ngcontent-tnw-c106="" class="handle-button ai-button"></div><div _ngcontent-tnw-c106="" class="handle-button line-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tnw-c106="" class="handle-button theme-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tnw-c106="" class="handle-button copy-button"><div _ngcontent-tnw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tnw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment"># src/main/cpp/CMakeLists.txt</span></li><li>include_directories(<span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span>/../../..)</li><li>target_link_libraries(entry PUBLIC <span class="hljs-variable">${NATIVERENDER_ROOT_PATH}</span>/../../../libnativeAdd.so)</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section9711155044918">在纯ArkTS工程中如何引用三方so库<i class="anchor-icon anchor-icon-link" anchorid="section9711155044918" tips="复制节点链接"></i></h3><p>纯ArkTS工程可以通过配置模块动态依赖的方式引用so库。但是需要注意，在引用过程中除了将已经适配Native的xxx.so库文件置于entry/libs对应的架构目录下外，还需要将编译三方so库时配套产生的libc++_xxx.so库文件置于该目录下。</p> <p><strong>示例如下</strong></p> <p><span><img originheight="396" originwidth="268" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.62852090202934766659663383005009:50001231000000:2800:6F72D18DA478C4BAA312668206AEDCB55A7EECBB261B7D338D85430B624A6073.png" class="notEnlarge" width="268" height="396"></span><span><img originheight="237" originwidth="200" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.58444259625063189635987637266186:50001231000000:2800:53E5CD0116A7052C747F070A4EAFD0858E8F0C9CB46CE9384126397C093C70DC.png" class="notEnlarge" width="200" height="237"></span></p> </div> <div class="tiledSection"><h2 id="section153898587185">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section153898587185" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/NativeSoIntegration" target="_blank">实现动态链接库（.so）的引用</a></li></ul> </div> </div> <div></div></div>