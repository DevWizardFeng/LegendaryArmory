<h1 _ngcontent-mlb-c119="" class="doc-title ng-star-inserted" title="主线程耗时操作优化"> 主线程耗时操作优化 </h1>

<div _ngcontent-mlb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section141403815138">概述<i class="anchor-icon anchor-icon-link" anchorid="section141403815138" tips="复制节点链接"></i></h2><p>在应用开发实践中，有效避免主线程执行冗余与易耗时操作是至关重要的策略。此举能有效降低主线程负载，提升UI的响应速度。面对高频回调接口在短时间内密集触发的场景，需要避免接口内的耗时操作，尽量保证主线程不被长时间占用，从而防止阻塞UI渲染，引发界面卡顿。本文介绍开发过程中常见的冗余操作，常见的高频回调场景以及其他主线程优化思路。</p> </div> <div class="tiledSection"><h2 id="section1193294163616">常见冗余操作<i class="anchor-icon anchor-icon-link" anchorid="section1193294163616" tips="复制节点链接"></i></h2><p>在软件开发中，冗余操作指的是那些不必要、重复执行且对程序功能无实质性贡献的操作。这些操作不仅会浪费计算资源，还可能降低程序的运行效率，特别是在高频调用的场景下，其负面影响更为显著。下面列举一些release版本中常见的冗余操作：</p> <ul><li>debug日志打印</li><li>Trace打点</li><li>冗余空回调<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide_hp-arkui-avoid-empty-callback" target="_blank">@performance/hp-arkui-avoid-empty-callback</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> </li></ul> <p>【反例】：release版本中冗余日志打印，Trace打点，以及无业务代码的空回调</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/RedundantOperation.ets#L17-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span>, <span class="hljs-variable">hiTraceMeter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-comment">// Redundant operations are counterexamples</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RedundantOperation</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">arr</span>: <span class="hljs-title class_">number</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">500</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">arr</span>[<span class="hljs-variable">i</span>] = <span class="hljs-variable">i</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-variable">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Redundant operations'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>      <span class="hljs-title function_">Scroll</span>() {</li><li>        <span class="hljs-title function_">List</span>() {</li><li>          <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">arr</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>            <span class="hljs-title function_">ListItem</span>() {</li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-string">'TextItem'</span> + <span class="hljs-variable">item</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">12</span> })</li><li>            }</li><li>            .<span class="hljs-title function_">onAreaChange</span>(() =&gt; {</li><li>              <span class="hljs-comment">// No business operations</span></li><li>              <span class="hljs-comment">// Negative example.</span></li><li>            })</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">48</span>)</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">divider</span>({ <span class="hljs-variable">strokeWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">color</span>: <span class="hljs-string">'#F5F5F5'</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'86%'</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">8</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">onWillScroll</span>(() =&gt; {</li><li>        <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>
</li><li>        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'Debug %{public}s'</span>, <span class="hljs-string">'contents: logs'</span>);</li><li>        <span class="hljs-comment">// Business logic</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">16</span>, <span class="hljs-variable">right</span>: <span class="hljs-number">16</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-number">16</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/RedundantOperation.ets#L17-L99" target="_blank">RedundantOperation.ets</a></div></div></div></div> <p>【正例】：release版本中删除冗余的debug日志，Trace打点以及无业务代码的空回调</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NoRedundantOperation.ets#L19-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Redundancy operation example</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NoRedundantOperation</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">arr</span>: <span class="hljs-title class_">number</span>[] = [];</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">500</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">arr</span>[<span class="hljs-variable">i</span>] = <span class="hljs-variable">i</span>;</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-variable">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'No redundant operations'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>      <span class="hljs-title function_">Scroll</span>() {</li><li>        <span class="hljs-title function_">List</span>() {</li><li>          <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">arr</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>            <span class="hljs-title function_">ListItem</span>() {</li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-string">'TextItem'</span> + <span class="hljs-variable">item</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">12</span> })</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">48</span>)</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">divider</span>({ <span class="hljs-variable">strokeWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">color</span>: <span class="hljs-string">'#F5F5F5'</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">8</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'86%'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">onWillScroll</span>(() =&gt; {</li><li>        <span class="hljs-comment">// Business logic</span></li><li>        <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NoRedundantOperation.ets#L19-L92" target="_blank">NoRedundantOperation.ets</a></div></div></div></div> <div class="fignone"><span class="figcap"><b>图1 </b>反例标签"H:ScrollSlide"Trace图</span><br><span><img height="189.25549999999998" originheight="287" originwidth="1388" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.46486754843174237372289013405382:50001231000000:2800:DB1A66CEE66BD005DC239BB7168F262CD8A9875E8E1DCDDD52A9453FBEBA7B51.png" title="点击放大" width="920"></span></div> <p>通过上图可知，在3.5s的滑动过程中，总计触发了424次日志打印以及Trace追踪，打印一次日志的平均耗时为84μs，由此可以计算出冗余的debug日志浪费了35.616ms。release版本建议删除无效日志的打印。</p> <p>对于回调函数体内不包含任何业务逻辑代码的冗余回调而言，即使开发者在回调函数内部未进行任何实质性的操作，只要注册了回调接口，如onAreaChange，系统底层仍会耗费资源去监测对应事件的发生，例如计算组件的位置或大小变化，并将这些数据传递给ArkTS侧。即使这些数据最终在ArkTS层没有被有效利用，底层的计算和通信开销已然存在。所以，为了避免不必要的资源消耗，提升应用性能，应当仔细审查并移除这类无实际用途的回调函数注册。开发过程中，除了需要避免冗余操作，还需要注意避免在高频回调场景执行耗时操作，接下来介绍一下高频回调场景以及需要避免的耗时操作。</p> </div> <div class="tiledSection"><h2 id="section10112623611">高频回调场景<i class="anchor-icon anchor-icon-link" anchorid="section10112623611" tips="复制节点链接"></i></h2><p>高频回调接口通常是指在应用程序运行过程中会被频繁触发的事件或回调函数，以下常见高频回调场景中需要避免执行耗时操作:</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section204221336134312">高频事件回调</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section20815336174316">组件复用回调</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section418843713435">组件生命周期回调</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section4551193714439">循环渲染</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section166841738154316">组件属性</a></li></ul> </div> <div class="tiledSection"><h3 id="section204221336134312" class="firsth2">高频事件回调<i class="anchor-icon anchor-icon-link" anchorid="section204221336134312" tips="复制节点链接"></i></h3><p>例如，触摸事件、拖拽事件、移动事件、组件区域变化事件、滑动事件等系统事件在应用程序运行过程中会被频繁触发，如果在这些回调接口中执行耗时操作，将导致引用出现卡顿丢帧的问题。下方是基于Scroll组件滑动时会高频调用onWillScroll的场景，分析性能差异。</p> <p><strong>场景案例</strong></p> <p>【案例一】在onWillScroll回调中执行耗时操作</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfOnScroll.ets#L19-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// onWillScroll high-frequency event callback counterexample</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NegativeOfOnScroll</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">arr</span>: <span class="hljs-title class_">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>];</li><li>
</li><li>  <span class="hljs-title function_">count</span>(): <span class="hljs-title class_">number</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">temp</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">1000000</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-variable">temp</span> += <span class="hljs-number">1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">temp</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-variable">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.negative_of_onScroll'</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title function_">Scroll</span>() {</li><li>        <span class="hljs-title function_">List</span>() {</li><li>          <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">arr</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>            <span class="hljs-title function_">ListItem</span>() {</li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-string">'TextItem'</span> + <span class="hljs-variable">item</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">12</span> })</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">48</span>)</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">divider</span>({ <span class="hljs-variable">strokeWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-variable">color</span>: <span class="hljs-string">'#F5F5F5'</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">492</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">8</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">onWillScroll</span>(() =&gt; {</li><li>        <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Scroll TextItem'</span>);</li><li>        <span class="hljs-comment">// Time-consuming operation</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">count</span>();</li><li>        <span class="hljs-comment">// Business logic</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfOnScroll.ets#L19-L97" target="_blank">NegativeOfOnScroll.ets</a></div></div></div></div> <p>【案例二】onWillScroll回调中不执行耗时操作</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfOnScroll.ets#L19-L87" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// onWillScroll high-frequency event callback positive example</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PositiveOfOnScroll</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>];</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.positive_of_onScroll'</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">Scroll</span>() {</li><li>        <span class="hljs-title class_">List</span>() {</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">ListItem</span>() {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">'TextItem'</span> + item)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">12</span> })</li><li>            }</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">48</span>)</li><li>          }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        .<span class="hljs-title function_">divider</span>({ <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#F5F5F5'</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">492</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">8</span> })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">onWillScroll</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        hiTraceMeter.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Scroll TextItem'</span>);</li><li>        <span class="hljs-comment">// Business logic</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        hiTraceMeter.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'ScrollSlide'</span>, <span class="hljs-number">1001</span>);</li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfOnScroll.ets#L19-L87" target="_blank">PositiveOfOnScroll.ets</a></div></div></div></div> </div> <p><strong>结果对比</strong></p> <p>下面将通过自定义Trace打点，统计不同案例场景下，单次onWillScroll事件回调的耗时差异，帧率差异以及分析。</p> <ul><li>耗时对比</li></ul> <div class="fignone"><span class="figcap"><b>图2 </b>案例一onWillScroll事件回调耗时</span><br><span><img height="201.526" originheight="329" originwidth="1501" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.12643955950188453960488975856507:50001231000000:2800:CB0422C960F9BA6B2615A3B3139C79A8D7A9CE17E360B14E1E9FE773C137881A.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图3 </b>案例二onWillScroll事件回调耗时</span><br><span><img height="198.0185" originheight="337" originwidth="1552" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.38206727262318733806466886796038:50001231000000:2800:6794745024B57CCD05C8874B79B902BCADCAC00D32920E911153B9B3C8E3EAB2.png" title="点击放大" width="920"></span></div> <ul><li>帧率对比</li></ul> <div class="fignone"><span class="figcap"><b>图4 </b>onWillScroll执行耗时操作的丢帧率</span><br><span><img height="178.74450000000002" originheight="294" originwidth="1510" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.33011213231561761003105124303010:50001231000000:2800:81ABC8B17636D8A5D14981FB63ABE721DE51712F22422EA98F8A698C9649EB01.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图5 </b>onWillScroll不执行耗时操作的丢帧率</span><br><span><img height="191.01500000000001" originheight="314" originwidth="1508" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.47210750328402610046864832093080:50001231000000:2800:9FF8C8B80DD607447F6A82DAA2DA2EE76695305EEA39BF36CA52B59889A22605.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图6 </b>首帧Trace详细信息</span><br><span><img height="223.42850548761365" originheight="375" originwidth="1544" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163427.55141242579854503577119980683285:50001231000000:2800:12F2E1646513F3A9E3B096CFD162D3732BCF13B4A107F33A6C25675C5904C006.png" title="点击放大" width="920"></span></div> <p>通过图2、图3可知，onWillScroll事件回调中带有耗时操作，会占用主线程20ms左右的时间。由图4可知在具有耗时操作的滑动过程中，丢帧率高达87.5%。观察图6卡顿首帧Trace的详细信息发现，原本期望完成时间为8.3ms。因为onWillScroll中耗时操作的影响，使得实际处理时间为25ms，远超期望时间，短时间内连续触发该回调就会导致发生连续丢帧现象。因此在开发过程中，开发者应该尽量避免在高频事件回调中处理耗时操作，否则将导致应用性能大幅下降。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>本案例在onWillScroll事件回调的开始开启打点追踪，在事件回调结束前停止性能打点追踪，用以测试有无耗时操作的性能差异。关于本例中使用性能打点的介绍，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hitracemeter" target="_blank">@ohos.hiTraceMeter (性能打点)</a>。案例中关于帧率检测，丢帧分析，请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-zhenlv" target="_blank">帧率问题分析</a>。</p> <p>由于本章节各场景的帧率数据统计以及分析步骤与方式大体一致，下文将不再对各场景的帧率进行重复统计分析。</p> </div></div></div> <div class="tiledSection"><h3 id="section20815336174316">组件复用回调<i class="anchor-icon anchor-icon-link" anchorid="section20815336174316" tips="复制节点链接"></i></h3><p>在滑动场景中，使用组件复用通常需要用生命周期回调aboutToReuse去更新组件的状态变量。在滑动时，aboutToReuse会被频繁调用。如果在aboutToReuse中进行了耗时操作，将导致应用出现卡顿丢帧的问题。下面的案例将基于Grid懒加载组件复用场景进行分析。</p> <p><strong>场景案例</strong></p> <p>【反例】：在aboutToReuse中进行耗时操作</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfGrid.ets#L110-L130" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Simulate time-consuming operations with loop functions</span></li><li><span class="hljs-title function_">count</span>(): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">temp</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">index</span> &lt; <span class="hljs-number">1000000</span>; <span class="hljs-title class_">index</span>++) {</li><li>    <span class="hljs-variable">temp</span> += <span class="hljs-number">1</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">temp</span>;</li><li>}</li><li>
</li><li><span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">number</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'ReuseOfGrid'</span>, <span class="hljs-number">1001</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">item</span>;</li><li>  <span class="hljs-comment">// Simulate time-consuming operations</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">count</span>();</li><li>  <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'ReuseOfGrid'</span>, <span class="hljs-number">1001</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfGrid.ets#L110-L130" target="_blank">NegativeOfGrid.ets</a></div></div></div></div> <p>【正例】：在aboutToReuse中不进行耗时操作</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfGrid.ets#L110-L117" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li>aboutToReuse(<span class="hljs-keyword">params</span>: Record&lt;<span class="hljs-built_in">string</span>, number&gt;): <span class="hljs-keyword">void</span> {</li><li>  hiTraceMeter.startTrace(<span class="hljs-string">'ReuseOfGrid'</span>, <span class="hljs-number">1001</span>);</li><li>  <span class="hljs-keyword">this</span>.item = <span class="hljs-keyword">params</span>.item;</li><li>  hiTraceMeter.finishTrace(<span class="hljs-string">'ReuseOfGrid'</span>, <span class="hljs-number">1001</span>)</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfGrid.ets#L110-L117" target="_blank">PositiveOfGrid.ets</a></div></div></div></div> <p><strong>结果对比</strong></p> <div class="fignone"><span class="figcap"><b>图7 </b>反例滑动时单个aboutToReuse耗时</span><br><span><img height="212.037" originheight="351" originwidth="1511" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.84066878923586027337016515318102:50001231000000:2800:84020891D077428C4DF21943BF5A26067E1AC6401B2CC6BED0110862F554D956.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图8 </b>正例滑动时单个aboutToReuse耗时</span><br><span><img height="246.45614299153343" originheight="378" originwidth="1411" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.95865634591870224841567144396508:50001231000000:2800:50611378C5604611EEF07F11D1EFE9909F4D2B919849E99D99B3404B97A207BF.png" title="点击放大" width="920"></span></div> <p>如图7所示，从反例Trace中“H:ReuseOfGrid”标签可以看出，单个aboutToReuse执行耗时20ms。而从图8正例Trace中“H:ReuseOfGrid”标签看，单个aboutToReuse执行耗时仅56μs。带有耗时操作的单个aboutToReuse执行耗时远超期望时间8.3ms，在Grid滑动高频调用aboutToReuse的场景中，将会导致应用连续丢帧卡顿，性能大幅下降。因此，组件复用时应避免在aboutToReuse中执行耗时操作。</p> </div> <div class="tiledSection"><h3 id="section418843713435">组件生命周期回调<i class="anchor-icon anchor-icon-link" anchorid="section418843713435" tips="复制节点链接"></i></h3><p>在需要频繁创建和销毁组件的场景中，将会频繁调用组件生命周期回调aboutToAppear，aboutToDisappear。下面是一个使用条件渲染，通过点击按钮切换自定义组件A和B来模拟频繁创建和销毁组件的场景示例。</p> <p>在自定义组件A，B的生命周期回调函数aboutToAppear和aboutToDisappear中加入耗时操作。</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/ConditionalRendering.ets#L17-L129" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MyComponent</span> {</li><li>  <span class="hljs-comment">// Toggles the custom component flag</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">flag</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-comment">// $r('app.media.chevron_left') It needs to be replaced with the resources required by the developers</span></li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Conditional rendering'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>      <span class="hljs-comment">// Use conditional rendering to simulate a scene where components are frequently created and destroyed with the click of a button</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">flag</span>) {</li><li>        <span class="hljs-comment">// Custom component A</span></li><li>        <span class="hljs-title class_">CustomComponentA</span>()</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// Custom component B</span></li><li>        <span class="hljs-title class_">CustomComponentB</span>()</li><li>      }</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'switch custom component'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0A59F7'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// Click the button to switch to the custom component</span></li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">flag</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">flag</span>;</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">44</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CustomComponentA</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> temp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {</li><li>      temp += <span class="hljs-number">1</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">`%{public}s', 'CustomComponentA aboutToAppear <span class="hljs-subst">${temp}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> temp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {</li><li>      temp += <span class="hljs-number">1</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`CustomComponentA aboutToDisappear <span class="hljs-subst">${temp}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>()</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">CustomComponentB</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> temp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {</li><li>      temp += <span class="hljs-number">1</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`CustomComponentB aboutToAppear <span class="hljs-subst">${temp}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> temp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {</li><li>      temp += <span class="hljs-number">1</span>;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`CustomComponentB aboutToDisappear <span class="hljs-subst">${temp}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>()</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/ConditionalRendering.ets#L17-L129" target="_blank">ConditionalRendering.ets</a></div></div></div></div> <p>因为示例中使用了条件渲染，每次销毁前一个自定义组件都会调用一次aboutToDisappear函数，然后创建新的自定义组件时，又会调用一次aboutToAppear，所以调用较为频繁。因此，在频繁创建和销毁组件的场景中，应尽量避免在aboutToAppear，aboutToDisappear中执行耗时操作。</p> </div> <div class="tiledSection"><h3 id="section4551193714439">循环渲染<i class="anchor-icon anchor-icon-link" anchorid="section4551193714439" tips="复制节点链接"></i></h3><p>在懒加载滑动场景中，框架会根据滚动容器可视区域按需创建组件，关于懒加载接口的描述如下</p> <div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">LazyForEach</span>(</li><li>    <span class="hljs-attr">dataSource</span>: <span class="hljs-title class_">IDataSource</span>,  <span class="hljs-comment">// Data sources requiring iterative data processing</span></li><li>    <span class="hljs-attr">itemGenerator</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>,  <span class="hljs-comment">// Subcomponent build function</span></li><li>    keyGenerator?: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">string</span> <span class="hljs-comment">// Key-value generation function</span></li><li>): <span class="hljs-built_in">void</span></li></ol></pre></div></div> <p>所以在滑动时框架会频繁调用子组件生成函数itemGenerator，键值生成函数keyGenerator以及dataSource获取索引数据函数的getData函数。如果在itemGenerator，keyGenerator，getData中执行了耗时操作（比如传入耗时的函数作为入参），就会导致应用出现卡顿丢帧的问题。</p> <p>三种函数的正反例效果类似，故本次只针对itemGenerator进行测试，下面依然基于Grid懒加载组件复用场景进行分析。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>本案例中子组件生成函数itemGenerator以及键值生成函数keyGenerator详细信息，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">LazyForEach</a>。获取索引数据函数getData的说明，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach#idatasource" target="_blank">IDataSource说明</a>。</p> </div></div></div> <p>本案例中懒加载的子组件生成函数即GridItem组件的生成函数。</p> <div class="p">【反例】：在itemGenerator中执行itemGeneratorFunc()耗时函数<div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfLazyForEach.ets#L50-L122" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Simulate time-consuming operations</span></li><li><span class="hljs-title function_">itemGeneratorFunc</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">temp</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">index</span> &lt; <span class="hljs-number">1000000</span>; <span class="hljs-title class_">index</span>++) {</li><li>    <span class="hljs-variable">temp</span> += <span class="hljs-number">1</span>;</li><li>  }</li><li>  <span class="hljs-variable">item</span> += <span class="hljs-variable">temp</span>;</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">item</span>;</li><li>}</li><li>
</li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">Column</span>() {</li><li>    <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>          <span class="hljs-variable">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>        });</li><li>      })</li><li>
</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Loop rendering counterexamples'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">16</span>, <span class="hljs-variable">right</span>: <span class="hljs-number">16</span> })</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title function_">Grid</span>() {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">data</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">GridItem</span>() {</li><li>            <span class="hljs-comment">// Use reusable custom components</span></li><li>            <span class="hljs-title function_">ReusableChildComponent</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> })</li><li>          }</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">12</span> })</li><li>  }</li><li>  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfLazyForEach.ets#L50-L122" target="_blank">NegativeOfLazyForEach.ets</a></div></div></div></div> </div> </div> <p>【正例】：itemGenerator不执行耗时操作</p> <p><strong>结果对比</strong></p> <div class="fignone"><span class="figcap"><b>图9 </b>itemGenerator中执行耗时操作的滑动效果</span><br><span><img originheight="406" originwidth="300" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.39649949152316313978067344785182:50001231000000:2800:37417481BFC15EC64F2B43749B981452B8EF1519520DF8A242558C78B8118FE3.gif" width="300" height="406"></span></div> <div class="fignone"><span class="figcap"><b>图10 </b>itemGenerator中不执行耗时操作的滑动效果</span><br><span><img originheight="405" originwidth="300" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.91481562268084394895783652636966:50001231000000:2800:4B52DED7F04EEEF1A093F01288C64C81BB9628445E6C15B49E65779D1CF2641B.gif" width="300" height="405"></span></div> <p>图9是在itemGenerator入参函数中执行耗时操作的滑动效果，可以明显看出滑动时存在卡顿，item节点刷新慢等问题。图10是在aboutToAppear中执行耗时操作，把耗时操作计算的值timeConsumingValue传入itemGenerator的滑动效果，可以看出滑动效果流畅，无卡顿问题。</p> <p>因此，在懒加载滑动场景中，应避免在LazyForEach的itemGenerator，keyGenerator，getData中执行耗时操作，可以有效减少应用卡顿丢帧的问题，提升用户体验。</p> <div class="tiledSection"><h3 id="section166841738154316">组件属性<i class="anchor-icon anchor-icon-link" anchorid="section166841738154316" tips="复制节点链接"></i></h3><p>组件单一属性刷新时，组件的其他属性也会同时进行刷新。在需要频繁刷新组件属性的场景中，如果组件中其他不需要刷新的属性使用了耗时的函数作为入参。那么在刷新组件某个属性时，组件中那些实际上不需要去刷新的属性将会去调用耗时函数，导致不必要的性能损耗，同时也会引起应用卡顿丢帧的问题。</p> <p>下面是一个点击按钮改变Row组件宽度的示例</p> <p>【反例】：Row组件的高度以耗时函数作为入参</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfProperty.ets#L18-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">NegativeOfProperty</span> {</li><li>  <span class="hljs-comment">// Row Width</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">rowWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">200</span>;</li><li>
</li><li>  <span class="hljs-title function_">getHeight</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// Simulate time-consuming operations with loop functions</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">1000000</span>; index++) {</li><li>      height += <span class="hljs-number">0.0001</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> height;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Component property counterexamples'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>      <span class="hljs-title class_">Row</span>()</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHeight</span>())</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change row width'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> + <span class="hljs-number">20</span>;</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> &gt; <span class="hljs-number">300</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> = <span class="hljs-number">200</span>;</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0A59F7'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">44</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/NegativeOfProperty.ets#L18-L83" target="_blank">NegativeOfProperty.ets</a></div></div></div></div> <p>【正例】：使用任务池taskpool处理耗时操作后返回结果给Row的高度rowHeight</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfProperty.ets#L17-L98" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { taskpool } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>; <span class="hljs-comment">// Task pools</span></li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getHeight</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// Simulate time-consuming operations with loop functions</span></li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">1000000</span>; index++) {</li><li>    height += <span class="hljs-number">0.0001</span>;</li><li>  }</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Scenario 4 call getHeight'</span>);</li><li>  <span class="hljs-keyword">return</span> height;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Execute getHeight</span></li><li>taskpool.<span class="hljs-title function_">execute</span>(getHeight).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>  <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'height'</span>, value);</li><li>})</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PositiveOfProperty</span> {</li><li>  <span class="hljs-comment">// Row width</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">rowWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">200</span>;</li><li>  <span class="hljs-comment">// Row height</span></li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'height'</span>) <span class="hljs-attr">rowHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The number of times you click the button to change the width of the row</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Component property examples'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">36</span> })</li><li>
</li><li>      <span class="hljs-title class_">Row</span>()</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rowHeight</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>
</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change row width'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0A59F7'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> + <span class="hljs-number">20</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'Scenario 4 call getHeight: %{public}s'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> &gt; <span class="hljs-number">300</span>) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">rowWidth</span> = <span class="hljs-number">200</span>;</li><li>          }</li><li>        })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">44</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/PositiveOfProperty.ets#L17-L98" target="_blank">PositiveOfProperty.ets</a></div></div></div></div> </div> <p>在组件单一属性刷新时，组件的其他属性也会同时进行刷新。每次点击按钮改变Row组件宽度时，Row的高度也会同时刷新。反例每次改变Row组件宽度rowWidth，都会调用一次耗时的Row高度入参函数getHeight()。正例在页面加载时通过taskpool方式仅执行一次耗时的getHeight()。然后返回结果直接赋值给Row高度变量rowHeight。后续每次改变Row组件宽度rowWidth时,不需要重复调用耗时的getHeight()，有效减少了不必要的性能开销。</p> <p>因此，在高频刷新组件属性的场景中，应避免在组件的属性中执行耗时操作（如属性使用耗时的函数入参），能有效减少应用卡顿丢帧的情况，提升用户体验。</p> <div class="tiledSection"><h2 id="section4365993361">其他主线程优化思路<i class="anchor-icon anchor-icon-link" anchorid="section4365993361" tips="复制节点链接"></i></h2><p>当主线程中遇到一些难以避免的耗时操作时，可以从以下角度进行性能优化：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section193673511440">避免使用耗时接口</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section32971936174416">使用多线程能力</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-time-optimization-of-the-main-thread#section7359185917239">@Sendable装饰器</a></li></ul> </div> <div class="tiledSection"><h3 id="section193673511440" class="firsth2">避免使用耗时接口<i class="anchor-icon anchor-icon-link" anchorid="section193673511440" tips="复制节点链接"></i></h3><p>在应用开发中，经常会调用系统提供的接口，比如读取本地文件、处理服务端数据等等。若对接口使用不合理，可能引起延迟、卡顿、丢帧等性能问题。以如下系统提供的接口为例，总结了使用中的注意事项。下面以ResourceManager同步获取资源的接口为例进行分析。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hp-arkui-use-taskpool-for-web-request" target="_blank">@performance/hp-arkui-use-taskpool-for-web-request</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> <p><strong>ResourceManager</strong></p> <p>ResourceManager通过getXXXSync接口同步获取资源的方式有两种，1、通过resource对象获取resourceManager.getStringSync($r('app.string.test'))；2、通过id获取resourceManager.getStringSync($r('app.string.test').id)。 下面以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getstringsync9" target="_blank">getStringSync</a>为例，测试一下这两种参数在方法中的使用是否会有耗时区别。</p> <ul><li>通过resource对象获取<div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/GetStrOfResource.ets#L17-L69" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hiTraceMeter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GetStrOfResource</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'getStringSync'</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'getStringSync'</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// The input parameter of the getStringSync operation directly uses the resource and does not use the resource ID</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.test'</span>))</li><li>    <span class="hljs-variable">hiTraceMeter</span>.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'getStringSync'</span>, <span class="hljs-number">1</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-variable">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Through resource objects'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title function_">TextArea</span>({<span class="hljs-variable">text</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">message</span>})</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/GetStrOfResource.ets#L17-L69" target="_blank">GetStrOfResource.ets</a></div></div></div></div> </li></ul> <ul><li>通过id获取<div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/GetStrOfId.ets#L17-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog, hiTraceMeter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">GetStrOfId</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'getStringSyncAfter'</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    hiTraceMeter.<span class="hljs-title function_">startTrace</span>(<span class="hljs-string">'getStringSyncAfter'</span>, <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// The input parameter of the getStringSync operation directly uses the resource and resource ID</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>($r(<span class="hljs-string">'app.string.test'</span>).<span class="hljs-property">id</span>)</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>,<span class="hljs-string">''</span>,<span class="hljs-string">`getStringSync failed. code=<span class="hljs-subst">${error.code}</span>, message=<span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    hiTraceMeter.<span class="hljs-title function_">finishTrace</span>(<span class="hljs-string">'getStringSyncAfter'</span>, <span class="hljs-number">1</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>            <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>          });</li><li>        })</li><li>
</li><li>        <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.get_str_of_id'</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>      <span class="hljs-title class_">TextArea</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> })</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/GetStrOfId.ets#L17-L72" target="_blank">GetStrOfId.ets</a></div></div></div></div> </li></ul> </div> <p><strong>结果对比</strong></p> <div class="fignone"><span class="figcap"><b>图11 </b>通过资源对象获取数据的耗时</span><br><span><img height="210.28900000000002" originheight="302" originwidth="1319" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.87998780273943419295448412720678:50001231000000:2800:8C54C89B98E2B0B4F2A6A16B2C14676554C8835DDF7450461C868B9B9FF8C57F.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图12 </b>通过资源id获取数据的耗时</span><br><span><img height="213.78500000000003" originheight="308" originwidth="1317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.49559838846838076534349862488041:50001231000000:2800:EF00C96B0F7B70A92256EFB3EA2970A6D33DC648332C6C4B039B773C13BBC7E3.png" title="点击放大" width="920"></span></div> <p>getStringSync参数为资源信息时（1.956ms）比参数为资源ID值时（0.071ms）耗时更多，因为通过resource对象获取资源时，获取的是拷贝对象，获取过程中发生了一次深拷贝，而通过资源ID获取子元素，直接获取原对象的引用。所以当需要使用类似方法时，使用资源ID值作为参数更优。</p> <p>通过本案例可以发现，同一接口的不同使用方式存在着性能差异，在开发过程中应该选择耗时更少、性能更优的接口，避免因此引起的延迟卡顿丢帧等性能问题。</p> <p><strong>wordBreak</strong><strong>属性</strong></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide_hp-arkui-use-word-break-in-space" target="_blank">@performance/hp-arkui-use-word-break-to-replace-zero-width-space</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> <p>零宽空格（Zero Width Space, ZWSP）是一个特殊的Unicode字符。它是一个不可见的字符，其宽度为零，不占用任何可见空间。在文本处理系统中，尽管它在视觉上是不可见的，但它在文本中确实存在，并可以作为潜在的断点，即允许在此位置断开行。这意味着如果一行文本过长需要自动换行时，文本可以在零宽空格的位置进行折行，而不影响单词的完整性。</p> <p>虽然零宽空格在许多情况下都是有用的，但它也可能引起问题，特别是在文本处理和数据清洗中。不注意这些看不见的字符可能导致数据的意外错误、搜索失败、数据不一致等问题。因此，在处理来自不同源的文本数据时，了解和考虑这些不可见字符是非常重要的。</p> <p>避免在文本组件内使用零宽空格(\u200b)的形式来设置断行规则，推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-text#wordbreak11" target="_blank">wordBreak</a>，wordBreak在使用性能方面优于零宽空格。例如推荐用法为：Text(this.diskName).wordBreak(WordBreak.BREAK_ALL)。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>常见高耗时接口有：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#getinspectorbykey9" target="_blank">getInspectorByKey</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#getinspectortree9" target="_blank">getInspectorTree</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#sendeventbykey9" target="_blank">sendEventByKey</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#sendtouchevent9" target="_blank">sendTouchEvent</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#sendkeyevent9" target="_blank">sendKeyEvent</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#sendmouseevent9" target="_blank">sendMouseEvent</a>。</p> <p>以上接口由于耗时长，建议仅用于应用测试阶段。</p> </div></div></div> <div class="tiledSection"><h3 id="section32971936174416">使用多线程能力<i class="anchor-icon anchor-icon-link" anchorid="section32971936174416" tips="复制节点链接"></i></h3><p>在主线程面临耗时操作时，采用多线程能力是一种高效的优化手段。通过将耗时任务分配给后台线程并行执行，主线程可以继续处理其他任务，保持应用的流畅性和响应性。这种方式能够充分利用多核处理器的计算能力，提高程序的执行效率，减少用户等待时间，从而提升整体的用户体验。</p> <p><strong>场景案例</strong></p> <p>列表无限滑动的场景，在即将触底的时候需要进行数据请求，如果在主线程中直接处理请求数据，可能会导致滑动动画被中断。如果回调函数处理的耗时较长，会直接阻塞主线程，卡顿就会非常明显。使用异步执行的方式进行异步调用，回调函数的执行还是会在主线程，一样会阻塞UI绘制和渲染。</p> <p>以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#示例1使用基本瀑布流" target="_blank">瀑布流使用案例</a>为基础进行代码改造,得到如下代码,瀑布流在即将触底时调用异步函数mockRequestData获取新数据，并将新数据写入数据源。异步函数mockRequestData用于模拟耗时的网络请求，从rawfile目录下读取数据，将数据处理后返回。</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseAsync.ets#L48-L130" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>    <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>          <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>        });</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Use asynchronous'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>
</li><li>    <span class="hljs-title class_">WaterFlow</span>() {</li><li>      <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">FlowItem</span>() {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// Add data in advance when you are about to hit the bottom</span></li><li>          <span class="hljs-keyword">if</span> (item + <span class="hljs-number">20</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>            <span class="hljs-comment">// Simulate the time it takes for the network to acquire data</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mockRequestData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: Item[]</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addLastItem</span>();</li><li>              }</li><li>            })</li><li>          }</li><li>        })</li><li>        <span class="hljs-comment">// ...</span></li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">mockRequestData</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Item</span>[]&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">ResponseData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>();</li><li>  <span class="hljs-comment">// data.json is the local json data, which is about 20 MB in size, and simulates getting data from the network</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'data.json'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">Uint8Array</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// parse json</span></li><li>    <span class="hljs-keyword">let</span> str = buffer.<span class="hljs-title function_">from</span>(data).<span class="hljs-title function_">toString</span>();</li><li>    res = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(str);</li><li>  })</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">dataToItem</span>(res.<span class="hljs-property">data</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseAsync.ets#L48-L130" target="_blank">UseAsync.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/common/Item.ets#L18-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/common/Item.ets#L18-L29" target="_blank">Item.ets</a></div></div></div></div> </div> <p>使用profiler工具抓取Trace：</p> <div class="fignone"><span class="figcap"><b>图13 </b>不使用多线程的Trace信息</span><br><span><img height="208.52950000000004" originheight="338" originwidth="1479" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.09836602349708668671194771969728:50001231000000:2800:113AF53D37196662139038E84BA0E7DD5F7367F6C35FEB8DAB3D2F3E8022B4AC.png" title="点击放大" width="920"></span></div> <p>从图中可以看到，在主线程中出现了大块的耗时，直接导致用户在滑动的时候能感受到明显的卡顿。异步回调函数最后也由主线程执行，所以应该尽量避免在回调函数中执行耗时操作。可以使用系统自带的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">@ohos.taskpool（启动任务池）</a>多线程能力，将耗时任务交由子线程执行，避免主线程的长时间阻塞，以下为使用TaskPool优化后的代码：</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseTaskPool.ets#L48-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>    <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">5</span> }) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.chevron_left'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">16</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E8E8E8'</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>({</li><li>          <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Index'</span></li><li>        });</li><li>      })</li><li>
</li><li>      <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.use_async'</span>))</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">26</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">56</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })</li><li>
</li><li>    <span class="hljs-title class_">WaterFlow</span>() {</li><li>      <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">FlowItem</span>() {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        .<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-comment">// Add data in advance when you are about to hit the bottom</span></li><li>          <span class="hljs-keyword">if</span> (item + <span class="hljs-number">20</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">totalCount</span>()) {</li><li>            <span class="hljs-comment">// Simulate the time it takes for the network to acquire data</span></li><li>            <span class="hljs-title function_">taskPoolExecute</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">UIContext</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: Item[]</span>) =&gt;</span> {</li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">addLastItem</span>();</li><li>              }</li><li>            })</li><li>          }</li><li>        })</li><li>        <span class="hljs-comment">// ...</span></li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .<span class="hljs-title function_">padding</span>(<span class="hljs-number">16</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseTaskPool.ets#L48-L118" target="_blank">UseTaskPool.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseTaskPool.ets#L123-L140" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// The following methods are defined outside of the component</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">taskPoolExecute</span>(<span class="hljs-params">UIContext: UIContext</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Item</span>[]&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(mockRequestData, <span class="hljs-title class_">UIContext</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Item</span>[];</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mockRequestData</span>(<span class="hljs-params">context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Item</span>[]&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">ResponseData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseData</span>();</li><li>  <span class="hljs-comment">// data.json is the local json data, which is about 20 MB in size, and simulates getting data from the network</span></li><li>  <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">'data.json'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">Uint8Array</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// parse json</span></li><li>    <span class="hljs-keyword">let</span> str = buffer.<span class="hljs-title function_">from</span>(data).<span class="hljs-title function_">toString</span>();</li><li>    res = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(str);</li><li>  })</li><li>  <span class="hljs-keyword">let</span> arr = <span class="hljs-title function_">dataToItem</span>(res.<span class="hljs-property">data</span>);</li><li>  <span class="hljs-keyword">return</span> arr;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/views/UseTaskPool.ets#L123-L140" target="_blank">UseTaskPool.ets</a></div></div></div></div> <div class="fignone"><span class="figcap"><b>图14 </b>使用多线程的Trace信息</span><br><span><img height="220.8" originheight="371" originwidth="1534" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.39905081090781657395091219339572:50001231000000:2800:F47F60E2BB0E7E0137697A7ABD193D1C651055A5CD746F35F2BE433752D4EA95.png" title="点击放大" width="920"></span></div> <p>通过上图可以看出，使用多线程能力TaskPool后，将原先在主线程中的获取资源的任务getRawFileContent转移到了TaskWorker线程，避免了获取资源导致的主线程长时间阻塞，但是TaskWorker将结果返回给主线程，主线程反序列化数据的过程中依然会消耗一定时间，接下来在泳道图中搜索"H:Deserialize"标签查看主线程反序列化耗时。</p> <div class="fignone"><span class="figcap"><b>图15 </b>主线程反序列化耗时</span><br><span><img height="266.36300000000006" originheight="449" originwidth="1542" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163428.28993731451064722029975333366764:50001231000000:2800:FE45BD8C740FA3460132B6F865C17465A70EBEEB20578A44AD695F06F415B375.png" title="点击放大" width="920"></span></div> <p>从图中可以看出主线程在反序列化TaskWorker线程返回的数据依然存在12ms的耗时，超过当前测试设备的Vsync周期（8.3ms），应用可能会因此引起卡顿。针对跨线程的序列化耗时问题，系统提供了@Sendable装饰器来实现内存共享，可以在返回的Item类上使用@Sendable装饰器，继续优化性能。</p> <div class="tiledSection"><h3 id="section7359185917239">@Sendable装饰器<i class="anchor-icon anchor-icon-link" anchorid="section7359185917239" tips="复制节点链接"></i></h3><p>@Sendable装饰器可以实现数据在多线程间的传递行为是引用传递，使用方式如下：</p> <div class="screenLinkPre"><div _ngcontent-mlb-c106="" class="highlight-div"><div _ngcontent-mlb-c106="" class="highlight-div-header"><div _ngcontent-mlb-c106="" class="highlight-div-header-left"><div _ngcontent-mlb-c106="" class="handle-button expand-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mlb-c106="" class="highlight-div-header-right"><div _ngcontent-mlb-c106="" class="handle-button ai-button"></div><div _ngcontent-mlb-c106="" class="handle-button line-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mlb-c106="" class="handle-button theme-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mlb-c106="" class="handle-button copy-button"><div _ngcontent-mlb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mlb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/common/Item.ets#L18-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AvoidTimeComsume/entry/src/main/ets/common/Item.ets#L18-L29" target="_blank">Item.ets</a></div></div></div></div> </div> <p>关于@Sendable装饰器的详细介绍以及使用限制，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable" target="_blank">Sendable对象简介</a>。</p> <p>上述示例代码中在TaskWorker线程返回的Item对象上使用了@Sendable，系统会使用共享内存的方式处理使用了@Sendable的类，从而降低反序列化的开销，抓取Trace图如下：</p> <div class="fignone"><span class="figcap"><b>图16 </b>使用@Sendable装饰器后主线程反序列化耗时</span><br><span><img height="248.837" originheight="421" originwidth="1551" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163429.09518699418019858361982453236439:50001231000000:2800:14EAA014D17C765075B4748E3D7D2E752F54ACF06CCC11D3E7878AC109A83D1A.png" title="点击放大" width="920"></span></div> <p>从图中可以看出反序列化的耗时由12ms减少到1.6ms，明显减少了主线程的阻塞时间，所以当主线程需要反序列化其他线程返回的大量数据时，可以使用@Sendable装饰器减少主线程的时间消耗。</p> <p>开发过程中，在主线程执行一些耗时任务，可能会阻塞UI渲染导致卡顿、掉帧等性能问题。具有如下优化思路</p> <ul><li>正式发布版本避免冗余日志，Trace打点以及没有业务操作的系统回调；</li><li>在高频回调的场景中，避免执行耗时操作；</li><li>避免使用耗时接口，同一接口的不同使用方式存在性能差异，开发者应该选择耗时更少，性能更优的接口；</li><li>使用多线程能力，将一些必要的耗时操作交由子线程执行，减小主线程的阻塞耗时；</li><li>主线程与其他线程存在大量数据交互时，使用@Sendable装饰器，可以提升线程间数据的传输与同步效率。</li></ul> <div class="tiledSection"><h2 id="section10796715181211">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section10796715181211" tips="复制节点链接"></i></h2><p><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/AvoidTimeComsume" target="_blank">主线程耗时操作优化指导</a></p> </div> </div> <div></div></div>