<h1 _ngcontent-afp-c119="" class="doc-title ng-star-inserted" title="位置定位"> 位置定位 </h1>

<div _ngcontent-afp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section185751522244">概述<i class="anchor-icon anchor-icon-link" anchorid="section185751522244" tips="复制节点链接"></i></h2><p>在实际应用开发过程中，经常需要用到移动终端设备的位置信息，比如查看所在城市天气、出行打车、旅行导航以及观察运动轨迹等。关于位置定位，位置服务提供了两种<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-kit-intro#section884410581151" target="_blank">定位方式</a>，分别为GNSS定位和网络定位，如下表所示：</p>  <div class="tablenoborder"><div class="tbBox"><table id="table1916823418349" class="layoutFixed idpTab"><caption><b>表1 </b>定位方式介绍</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.1" valign="top" width="11.95119511951195%"><p>定位方式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.2" valign="top" width="67.62676267626763%"><p>说明</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.2.4.1.3" valign="top" width="20.42204220422042%"><p>优点</p> </th> </tr> </thead> <tbody><tr><td align="left" class="cellrowborder" valign="top" width="11.95119511951195%"><p>GNSS定位</p> </td> <td align="left" class="cellrowborder" valign="top" width="67.62676267626763%"><p>基于全球导航卫星系统，包含GPS、GLONASS、北斗、Galileo等，通过导航卫星、设备芯片提供的定位算法，来确定设备准确位置。</p> </td> <td align="left" class="cellrowborder" valign="top" width="20.42204220422042%"><p>定位精准</p> </td> </tr> <tr><td align="left" class="cellrowborder" valign="top" width="11.95119511951195%"><p>网络定位</p> </td> <td align="left" class="cellrowborder" valign="top" width="67.62676267626763%"><p>通过网络进行定位，包括WLAN、蓝牙定位、基站定位。</p> </td> <td align="left" class="cellrowborder" valign="top" width="20.42204220422042%"><p>定位速度快</p> </td> </tr>  </tbody></table></div> </div> <p>利用系统的位置定位能力，可以在多种开发场景中获得实时准确的位置信息。本文将介绍如下四种常见的定位场景，并给出其具体实现方案，帮助开发者更好地掌握位置定位的基本原理和开发流程。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-positioning#section15711161035812">当前位置定位</a>：获取设备的当前位置信息。开发者可以根据实际需求将其应用于多种业务场景，如外卖定位、打车定位等。</li><li><a href="/consumer/cn/doc/best-practices/bpta-positioning#section189692202585">实时位置定位</a>：持续获取设备的实时位置信息。开发者可以将此能力应用于需要实时定位的场景，如步行导航、驾车出行等。</li><li><a href="/consumer/cn/doc/best-practices/bpta-positioning#section32954110416">应用后台定位</a>：将应用切换到后台仍然可以持续获取位置信息。该能力可以用于实现后台应用实时记录运动轨迹等业务场景。</li><li><a href="/consumer/cn/doc/best-practices/bpta-positioning#section1920418138118">历史定位获取</a>：获取系统缓存的最新位置，即最近一次的历史定位信息。该能力可以用于在设备网络信号较弱或对系统功耗比较敏感的场景下获取位置信息。</li></ul> </div> <div class="tiledSection"><h2 id="section15711161035812">当前位置定位<i class="anchor-icon anchor-icon-link" anchorid="section15711161035812" tips="复制节点链接"></i></h2><p>开发者可以根据实际业务诉求，设置相应的定位策略获取设备的当前位置信息，不同定位策略对应<a href="/consumer/cn/doc/best-practices/bpta-positioning#table1916823418349">表1 定位方式介绍</a>中不同的定位方式。</p> <p><strong>实现原理</strong></p> <p>位置服务提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetcurrentlocation-2" target="_blank">getCurrentLocation()</a>接口来获取当前位置信息，该接口需要用户设置关键参数——定位请求信息。定位请求信息包含定位方式优先级、单次定位超时时间等，分为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#currentlocationrequest" target="_blank">CurrentLocationRequest</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#singlelocationrequest12" target="_blank">SingleLocationRequest</a>两种类型。两种类型对应的定位优先级分别为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#locationrequestpriority" target="_blank">LocationRequestPriority</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#locatingpriority12" target="_blank">LocatingPriority</a>。</p> <p><strong>开发步骤</strong></p> <ol><li>申请定位权限，具体内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-permission-guidelines" target="_blank">申请位置权限开发指导</a>。</li><li>实例化位置信息请求对象，确认当前定位策略。以实例化SingleLocationRequest对象为例，将其定位方式优先级设置为快速获取位置优先，定位超时时间设置为10秒，具体代码如下：<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L101-L104" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">request</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">SingleLocationRequest</span> = {</li><li>  <span class="hljs-variable">locatingPriority</span>: <span class="hljs-number">0x502</span>,</li><li>  <span class="hljs-variable">locatingTimeoutMs</span>: <span class="hljs-number">10000</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L101-L104" target="_blank">Index.ets</a></div></div></div></div> </li><li>根据定位策略，调用getCurrentLocation()接口获取当前位置信息。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L107-L119" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-title function_">getCurrentLocation</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">location: geoLocationManager.Location</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getCurrentLocationPosition failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L107-L119" target="_blank">Index.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetaddressesfromlocation" target="_blank">getAddressesFromLocation()</a>接口进行逆地理编码转化，将位置坐标信息转换为对应的地理位置描述。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>(reverseGeocodeRequest, <span class="hljs-keyword">async</span> (err, data) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = data[<span class="hljs-number">0</span>]?.<span class="hljs-property">placeName</span> || <span class="hljs-string">''</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getAddressesFromLocation failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" target="_blank">Index.ets</a></div></div></div></div> </li><li>运行效果如下图所示<div class="fignone"><span class="figcap"><b>图1 </b>获取当前位置信息效果展示</span><br><span><img height="547.9733" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.65234248681579069339867035250289:50001231000000:2800:2FFAE7B53FA768D62A5731E9AEF65219BBC6A0AC44F761106CD79A9BA37B19F8.png" title="点击放大" width="266"></span></div> </li></ol> </div> <div class="tiledSection"><h2 id="section189692202585">实时位置定位<i class="anchor-icon anchor-icon-link" anchorid="section189692202585" tips="复制节点链接"></i></h2><p>开发者可以根据实际<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#useractivityscenario12" target="_blank">用户活动场景</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#powerconsumptionscenario12" target="_blank">功耗场景</a>，设置相应的定位策略持续获取设备的位置信息，不同定位策略对应<a href="/consumer/cn/doc/best-practices/bpta-positioning#table1916823418349">表1 定位方式介绍</a>中不同的定位方式。</p> <p><strong>实现原理</strong></p> <p>位置服务通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanageronlocationchange" target="_blank">on('locationChange')</a>接口订阅位置变化情况，实现持续获取设备位置信息的场景诉求。该订阅服务需要申请定位请求信息<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#locationrequest" target="_blank">LocationRequest</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#continuouslocationrequest12" target="_blank">ContinuousLocationRequest</a>，并在请求信息中设置定位场景类型和位置信息上报时间间隔。</p> <p><strong>开发步骤</strong></p> <ol><li>申请定位权限，具体内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-permission-guidelines" target="_blank">申请位置权限开发指导</a>。</li><li>实例化位置信息请求对象，确认持续定位策略。以实例化ContinuousLocationRequest为例，将定位场景类型设置为导航场景，位置信息上报时间间隔设置为1秒，具体代码如下：<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L129-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">request</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">ContinuousLocationRequest</span> = {</li><li>  <span class="hljs-variable">interval</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-variable">locationScenario</span>: <span class="hljs-number">0x401</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L129-L132" target="_blank">Index.ets</a></div></div></div></div> </li><li>根据定位策略，调用on('locationChange')开启位置变化订阅，并发起定位请求，持续获取当前位置信息。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L136-L136" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-keyword">on</span>(<span class="hljs-string">'locationChange'</span>, request, <span class="hljs-keyword">this</span>.locationChange);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L136-L136" target="_blank">Index.ets</a></div></div></div></div> </li><li>在on('locationChange')的回调函数中，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetaddressesfromlocation" target="_blank">getAddressesFromLocation()</a>接口进行逆地理编码转化，将坐标信息转换为对应的地理位置描述。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>(reverseGeocodeRequest, <span class="hljs-keyword">async</span> (err, data) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = data[<span class="hljs-number">0</span>]?.<span class="hljs-property">placeName</span> || <span class="hljs-string">''</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getAddressesFromLocation failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" target="_blank">Index.ets</a></div></div></div></div> </li><li>在不需要获取位置信息时，及时关闭位置变化订阅，并删除对应的定位请求，减少设备功耗。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L163-L167" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">try</span> {</li><li>  geoLocationManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationChange</span>);</li><li>} <span class="hljs-keyword">catch</span> (err) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`offLocationChange failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L163-L167" target="_blank">Index.ets</a></div></div></div></div> </li><li>运行效果如下图所示<div class="fignone"><span class="figcap"><b>图2 </b>持续获取实时位置信息效果展示</span><br><span><img height="549.5161" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.53022068391411580623254110541037:50001231000000:2800:2B9EA325865E768C60E2D75578A9B618BE6EC6210D8EB9A88276083423992F28.png" title="点击放大" width="266"></span></div> <p><span><img originheight="66" originwidth="1007" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.75013814918208631498675047265395:50001231000000:2800:4E2068948A7343057E83B91B4706B8FF2153A414CF5BD2D269EE6EC97D755F28.png" width="920" height="60.29791459781529"></span></p> </li></ol> </div> <div class="tiledSection"><h2 id="section32954110416">应用后台定位<i class="anchor-icon anchor-icon-link" anchorid="section32954110416" tips="复制节点链接"></i></h2><p>当用户将应用切至后台且依然需要获取设备的位置信息时，可以使用该方式进行后台定位。</p> <p><strong>实现原理</strong></p> <p>应用后台定位需要申请后台定位权限ohos.permission.LOCATION_IN_BACKGROUND和长时任务权限ohos.permission.KEEP_BACKGROUND_RUNNING。申请了相关权限后，开启<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resourceschedule-backgroundtaskmanager#backgroundmode" target="_blank">任务模式</a>为定位导航的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task" target="_blank">长时任务</a>，并在其回调接口中通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanageronlocationchange" target="_blank">on('locationChange')</a>订阅位置变化情况，在应用后台持续获取当前位置信息。</p> <p><strong>开发步骤</strong></p> <ol><li>申请后台定位权限，具体内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-permission-guidelines" target="_blank">申请位置权限开发指导</a>。</li><li>在模块的module.json5文件中，申请长时任务权限，并将长时任务模式设置为定位导航类型。<p>申请长时任务权限</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/module.json5#L93-L102" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span>,</li><li>  <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:running_background"</span>,</li><li>  <span class="hljs-string">"usedScene"</span>: {</li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      <span class="hljs-string">"EntryAbility"</span></li><li>    ],</li><li>    <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span></li><li>  }</li><li>},</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/module.json5#L93-L102" target="_blank">module.json5</a></div></div></div></div> <p>设置长时任务模式为定位导航类型</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/module.json5#L31-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>  <span class="hljs-punctuation">{</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-attr">"backgroundModes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>      <span class="hljs-string">"location"</span></li><li>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-punctuation">}</span></li><li><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/module.json5#L31-L59" target="_blank">module.json5</a></div></div></div></div> </li><li>开启任务模式为定位导航类型的长时任务，在其回调接口中开启位置变化订阅，并发起定位请求，在应用后台持续获取当前位置信息。<p>开启长时任务</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L246-L274" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">startContinuousTask</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">context</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITY</span>,</li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>  };</li><li>
</li><li>  <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">wantAgentObj</span>) =&gt; {</li><li>    <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-variable">context</span>,</li><li>      <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-variable">BackgroundMode</span>.<span class="hljs-variable">LOCATION</span>, <span class="hljs-variable">wantAgentObj</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">onLocationChange</span>();</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'startBackgroundRunning succeeded'</span>);</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">startBackgroundRunning</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">cause</span>:  ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>    });</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">cause</span>:  ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L246-L274" target="_blank">Index.ets</a></div></div></div></div> <p>订阅位置变化情况</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L127-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onLocationChange</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">request</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">ContinuousLocationRequest</span> = {</li><li>    <span class="hljs-variable">interval</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">locationScenario</span>: <span class="hljs-number">0x401</span></li><li>  };</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">geoLocationManager</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable">request</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">locationChange</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onLocationChange</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L127-L154" target="_blank">Index.ets</a></div></div></div></div> </li><li>在位置变化的回调中，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetaddressesfromlocation" target="_blank">getAddressesFromLocation()</a>接口进行逆地理编码转化，将坐标信息转换为对应的地理位置描述。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>(reverseGeocodeRequest, <span class="hljs-keyword">async</span> (err, data) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = data[<span class="hljs-number">0</span>]?.<span class="hljs-property">placeName</span> || <span class="hljs-string">''</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getAddressesFromLocation failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" target="_blank">Index.ets</a></div></div></div></div> </li><li>当不需要在应用后台获取位置信息时，及时关闭长时任务和位置变化订阅，并删除对应的定位请求，减少设备功耗。<p>关闭长时任务</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L281-L294" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">stopContinuousTask</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">let</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>  <span class="hljs-keyword">if</span> (!context) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isOnLocationChange</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">offLocationChange</span>();</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'stopBackgroundRunning succeeded'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`stopBackgroundRunning failed, cause:  <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L281-L294" target="_blank">Index.ets</a></div></div></div></div> <p>关闭位置变化订阅</p> <div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L161-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">offLocationChange</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    geoLocationManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationChange</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`offLocationChange failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L161-L169" target="_blank">Index.ets</a></div></div></div></div> </li><li>运行效果如下图所示</li></ol> <div class="fignone"><span class="figcap"><b>图3 </b>在应用后台持续获取位置信息效果展示</span><br><span><img height="550.3407000000001" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.60975170897126210960027950255687:50001231000000:2800:68270447735308D9CED70CFED4006D19C6AD92F8D766A5CBADAA8EF202A9C025.gif" title="点击放大" width="266"></span></div> <p><span><img originheight="77" originwidth="996" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.09106835150118973755266866564232:50001231000000:2800:BBFAABEB76839D3CFC4DF3CA85BF1ECFDEA6CFB86A8F29550C79DCB1BC541FB5.png" width="920" height="71.12449799196787"></span></p> </div> <div class="tiledSection"><h2 id="section1920418138118">历史定位获取<i class="anchor-icon anchor-icon-link" anchorid="section1920418138118" tips="复制节点链接"></i></h2><p>当用户设备网络信号较弱或者对系统功耗比较敏感时，可以先获取系统缓存的最新位置，即最近一次的历史定位信息。</p> <p><strong>实现原理</strong></p> <p>位置服务通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetlastlocation" target="_blank">getLastLocation()</a>接口来获取系统缓存的最新位置信息。该接口参数列表为空，返回值为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#location" target="_blank">Location</a>位置信息。</p> <p><strong>开发步骤</strong></p> <ol><li>申请定位权限，具体内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/location-permission-guidelines" target="_blank">申请位置权限开发指导</a>。</li><li>调用getLastLocation()接口获取系统缓存的最新位置信息。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L84-L84" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> location = geoLocationManager.getLastLocation();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L84-L84" target="_blank">Index.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetaddressesfromlocation" target="_blank">getAddressesFromLocation()</a>接口进行逆地理编码转化，将坐标信息转换为对应的地理位置描述。<div class="screenLinkPre"><div _ngcontent-afp-c106="" class="highlight-div"><div _ngcontent-afp-c106="" class="highlight-div-header"><div _ngcontent-afp-c106="" class="highlight-div-header-left"><div _ngcontent-afp-c106="" class="handle-button expand-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-afp-c106="" class="highlight-div-header-right"><div _ngcontent-afp-c106="" class="handle-button ai-button"></div><div _ngcontent-afp-c106="" class="handle-button line-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-afp-c106="" class="handle-button theme-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-afp-c106="" class="handle-button copy-button"><div _ngcontent-afp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-afp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>(reverseGeocodeRequest, <span class="hljs-keyword">async</span> (err, data) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">address</span> = data[<span class="hljs-number">0</span>]?.<span class="hljs-property">placeName</span> || <span class="hljs-string">''</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getAddressesFromLocation failed, code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/location-service/blob/master/entry/src/main/ets/pages/Index.ets#L216-L235" target="_blank">Index.ets</a></div></div></div></div> </li><li>运行效果如下图所示<div class="fignone"><span class="figcap"><b>图4 </b>获取缓存位置信息效果展示</span><br><span><img height="549.5161" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.28426137911781470249014119213470:50001231000000:2800:8AEA6C564FAB0FFBF27BD695E1F2A241A3C453900BB2A36B58BB27C9A285B2C8.png" title="点击放大" width="266"></span></div> </li></ol> </div> <div class="tiledSection"><h2 id="section292052218396">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section292052218396" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1747255154017" class="firsth2">位置定位不准或者位置信息有偏差<i class="anchor-icon anchor-icon-link" anchorid="section1747255154017" tips="复制节点链接"></i></h3><p><strong>问题现象</strong></p> <p>在定位过程中，获取的定位结果不准确，或者将定位结果标记在地图上时出现偏差。</p> <p><strong>可能原因</strong></p> <ul><li>定位权限设置错误，例如设置的定位权限为模糊定位而非精准定位。</li><li>定位策略设置错误，例如设置的策略为快速获取位置优先（蓝牙、基站、WLAN等网络定位方式）而非精度优先（GNSS卫星定位方式）。</li><li>在获取定位结果后，未进行坐标纠偏就将结果标记在地图上。华为地图在中国大陆、中国香港和中国澳门使用的是GCJ02坐标系，而定位返回结果使用的是WGS84坐标系，若直接将结果标记在华为地图上，因坐标值不同，展示位置会有偏移。</li></ul> <p><strong>解决措施</strong></p> <ul><li>针对定位权限设置错误问题，需要申请精准定位权限ohos.permission.LOCATION，并在应用中授权获取精准位置。</li><li>针对定位策略设置错误问题，需要将定位策略设置为精度优先，采用GNSS卫星定位方式。</li><li>针对定位结果在地图上的标记偏差问题，在中国大陆、中国香港和中国澳门如果使用WGS84坐标调用Map Kit服务，需要先将其转换为GCJ02坐标系再访问，详情见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/map-convert-coordinate" target="_blank">坐标纠偏</a>。</li></ul> </div> <div class="tiledSection"><h3 id="section19969105262618">位置定位失败<i class="anchor-icon anchor-icon-link" anchorid="section19969105262618" tips="复制节点链接"></i></h3><p><strong>问题现象</strong></p> <p>无法使用定位功能获取位置信息。</p> <p><strong>可能原因</strong></p> <ul><li>系统位置开关为关闭状态。</li><li>网络信号不佳，导致定位超时。</li><li>系统无缓存位置信息，导致获取上一次位置失败。</li></ul> <p><strong>解决措施</strong></p> <ul><li>打开系统位置开关。</li><li>检查设备是否联网、是否插入SIM卡、WiFi开关是否开启等。</li><li>移动至开阔地带再发起定位。</li><li>在系统无缓存位置的情况下，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetcurrentlocation-2" target="_blank">getCurrentLocation()</a>接口获取当前位置信息。</li></ul> </div> <div class="tiledSection"><h3 id="section924075153919">系统缓存位置信息不准确<i class="anchor-icon anchor-icon-link" anchorid="section924075153919" tips="复制节点链接"></i></h3><p><strong>问题现象</strong></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetcurrentlocation-2" target="_blank">getCurrentLocation()</a>接口获取当前定位信息后，再使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetlastlocation" target="_blank">getLastLocation()</a>接口获取缓存定位信息，两次获取的定位信息不一致。</p> <p><strong>可能原因</strong></p> <p>所有应用公用系统中的同一份缓存定位信息，有可能在两次接口调用之间有其他应用发起定位，刷新了系统中的缓存定位信息。</p> <p><strong>解决措施</strong></p> <p>对比获取定位信息的时间，根据时间判断缓存定位信息是否更新。</p> </div> <div class="tiledSection"><h2 id="section1774418211717">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1774418211717" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/location-service" target="_blank">基于位置服务获取设备定位信息</a></li></ul> </div> </div></div>