<h1 _ngcontent-qcm-c119="" class="doc-title ng-star-inserted" title="低功耗蓝牙基础使用"> 低功耗蓝牙基础使用 </h1>

<div _ngcontent-qcm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section51681673409">概述<i class="anchor-icon anchor-icon-link" anchorid="section51681673409" tips="复制节点链接"></i></h2><p>蓝牙（Bluetooth）是一种无线通信技术，被广泛应用于各种电子设备之间的短距离连接与数据传输。而低功耗蓝牙（Bluetooth Low Energy，简称 BLE）是一种能够在低功耗条件下进行通信的蓝牙技术，支持发起BLE扫描、发送BLE广播报文以及基于通用属性协议（Generic Attribute Profile，GATT）的连接与数据传输。与传统蓝牙相比，BLE功耗更低，适用于需要长时间运行的低功耗设备，例如智能手表、健康监测设备、智能家居等。</p> <p>本文针对BLE开发，以心跳监控仪场景为例，主要介绍蓝牙扫描管理、蓝牙连接状态管理和蓝牙设备特征值同步三个场景，并分别从服务端和客户端描述其相关实现。</p> </div> <div class="tiledSection"><h2 id="section13761330111617">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section13761330111617" tips="复制节点链接"></i></h2><p>实现低功耗蓝牙通信的主要步骤如下：</p> <ol><li>广播与扫描阶段：服务端创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#gattserver" target="_blank">GattServer</a>实例，定义服务特征并配置广播参数，验证蓝牙状态后启动广播，使自身可被发现；客户端确保蓝牙开启，设置扫描过滤条件，注册设备发现回调并启动扫描，收集可连接设备。</li><li>连接管理阶段：服务端调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onconnectionstatechange" target="_blank">on('connectionStateChange')</a>订阅GATT profile协议的连接状态变化事件，管理连接生命周期；客户端基于扫描到的服务端广播地址创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#gattclientdevice" target="_blank">GattClientDevice</a>实例，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>订阅GATT profile协议的连接状态变化事件，发起连接请求，成功后获取服务与特征，启用特征值通知功能，为数据传输做准备。</li><li>数据传输阶段：服务端订阅描述符写请求事件，准备数据（如心率值），通过特征通知机制向已连接客户端发送数据；客户端监听特征值变化事件，接收并解析数据内容，根据业务需求更新用户界面或执行相应逻辑。</li><li>断开连接阶段：服务端在连接状态回调中处理断开事件，可以停止广播并清理资源；客户端主动断开连接，关闭GATT客户端，注销监听器，重置连接状态，可选择将设备ID持久化以便后续自动重连。</li></ol> <p><span><img height="479.7975" originheight="2420" originwidth="2637" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163024.19501795179904903059247059443884:50001231000000:2800:BF45888AD4927831B846E60127AADC0D3EC2814E9693E1A0854A73385A6D37AE.jpg" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section1245563882414" class="firsth2">关键技术<i class="anchor-icon anchor-icon-link" anchorid="section1245563882414" tips="复制节点链接"></i></h3><p>实现BLE通信能力主要需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble" target="_blank">@ohos.bluetooth.ble (蓝牙ble模块)</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access" target="_blank">@ohos.bluetooth.access (蓝牙access模块)</a>中提供的API能力，服务端主要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">开启蓝牙</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blecreategattserver" target="_blank">创建服务器实例</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising" target="_blank">发送BLE广播</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristicchanged" target="_blank">特征值变化通知</a>等API；客户端主要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">开启蓝牙</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bleonbledevicefind" target="_blank">订阅BLE设备扫描结果</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartblescan" target="_blank">BLE设备扫描</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#connect" target="_blank">蓝牙连接</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onblecharacteristicchange" target="_blank">订阅蓝牙低功耗设备的特征值变化</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">订阅蓝牙低功耗设备的连接状态变化事件</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">持久化存储蓝牙设备的虚拟MAC地址</a>等API。</p> </div> <div class="tiledSection"><h3 id="section1757419118252">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section1757419118252" tips="复制节点链接"></i></h3><p>在需要使用低功耗蓝牙进行通信的场景中：</p> <p><strong>服务端</strong></p> <ol><li>检查蓝牙是否开启，若未开启则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">enableBluetooth()</a>接口开启蓝牙；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blecreategattserver" target="_blank">createGattServer()</a>接口创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#gattserver" target="_blank">GattServer</a>实例，即表示创建GATT连接中的服务端；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#addservice" target="_blank">addService()</a>接口在服务端添加服务；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising" target="_blank">startAdvertising()</a>接口开始发送BLE广播，向连接的客户端设备提供数据；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onconnectionstatechange" target="_blank">on('connectionStateChange')</a>方法在服务端订阅GATT profile协议的连接状态变化事件；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristicchanged" target="_blank">notifyCharacteristicChanged()</a>接口，在服务端特征值发生变化时，主动通知已连接的客户端设备。</li></ol> <p><strong>客户端</strong></p> <ol><li>检查蓝牙是否开启，若未开启则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">enableBluetooth()</a>接口开启蓝牙；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbledevicefind15" target="_blank">on('BLEDeviceFind')</a>接口订阅BLE设备扫描结果上报事件，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartblescan" target="_blank">startBLEScan()</a>接口发起BLE扫描流程；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blecreategattclientdevice" target="_blank">createGattClientDevice(deviceId)</a>接口，基于扫描到的服务端的广播地址创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#gattclientdevice" target="_blank">GattClientDevice</a>实例，即表示创建GATT连接中的客户端；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>接口订阅GATT profile协议的连接状态变化事件，随后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#connect" target="_blank">connect()</a>接口发起连接远端BLE设备；</li><li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>回调函数返回的连接状态为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_CONNECTED</a>时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices" target="_blank">getServices()</a>进行服务发现，获取服务端设备支持的所有服务；</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices" target="_blank">getServices()</a>发现服务后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>启用接收服务端特征值内容变更通知，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onblecharacteristicchange" target="_blank">on('BLECharacteristicChange')</a>接口订阅蓝牙低功耗设备的特征值变化事件；</li><li>启用接收服务端特征值内容变更通知成功后，客户端调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a>向指定的服务端特征值或描述符写入数据。</li></ol> </div> <div class="tiledSection"><h2 id="section512717851815">蓝牙扫描管理<i class="anchor-icon anchor-icon-link" anchorid="section512717851815" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section672324171915" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section672324171915" tips="复制节点链接"></i></h3><p>在日常生活中，BLE设备无处不在。当用户开启手机上的蓝牙设备发现功能时，常常会发现周围存在数十甚至上百个BLE广播设备。若无有效的管理机制，应用将面临以下挑战：</p> <ul><li>资源消耗过大，处理大量无关设备会增加额外的CPU和电量消耗；</li><li>用户体验不佳，设备列表过长，用户难以找到目标设备；</li><li>连接成功率降低，在复杂的BLE环境中，难以准确识别目标设备。</li></ul> <p>在本示例代码中，模拟了心率监测场景，用户只需连接到特定的心率监测设备，而非环境中的所有BLE设备。此时，BLE扫描管理就显得尤为重要。通过使用自定义扫描过滤器，可以实现：</p> <ul><li>仅显示支持心率服务的设备；</li><li>过滤掉非目标厂商的设备；</li><li>减少UI刷新频率，提高应用响应速度；</li><li>降低功耗，延长设备电池寿命。</li></ul> <p>这样的管理机制使用户能够快速找到并连接到正确的心率监测设备，提升使用体验。</p> </div> <div class="tiledSection"><h3 id="section19218151810220">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section19218151810220" tips="复制节点链接"></i></h3><p>在BLE通信的扫描阶段，服务端与客户端遵循明确的工作流程，以实现高效设备发现。</p> <p>服务端（如心率监测设备）首先初始化BLE服务，配置广播参数，其中关键步骤是设置服务UUID（如心率服务<a href="/consumer/cn/doc/best-practices/bpta-bluetooth-low-energy#table3846141532818">0000180D</a>）和自定义制造商数据，随后开始周期性广播。这种广播不仅包含标准服务标识，还嵌入了特定的制造商ID（如<a href="/consumer/cn/doc/best-practices/bpta-bluetooth-low-energy#table3846141532818">0x027D</a>）与数据模式，为客户端提供精准过滤的基础，确保在复杂的无线环境中能被正确识别。</p> <p>在此基础上，客户端启动受控的扫描过程：先确认蓝牙功能已启用，然后创建定制化扫描过滤器，该过滤器匹配目标服务UUID、制造商ID及特定数据模式。通过配置低功耗扫描模式与合理间隔，平衡发现速度与电量消耗。当扫描捕获到广播包时，系统依据过滤条件自动筛选，仅将匹配设备回调至应用层，应用进一步对结果进行去重和缓存，最终在UI上呈现精简后的可用设备列表。</p> <p>值得注意的是，BLE广播和扫描为高功耗操作，应用应在适当时机主动停止这些过程。例如，客户端成功连接至目标设备后应立即停止扫描；服务端完成预期连接或达到预设时间上限后应及时停止广播。这种功耗意识不仅能显著延长设备电池寿命，亦是专业蓝牙应用开发的关键实践。</p> <p>这种协同工作机制大幅提升了BLE连接效率。服务端的精准广播与客户端的智能过滤形成互补，避免了传统全量扫描带来的资源浪费。当用户在应用中看到设备列表时，背后已完成多层筛选：硬件层过滤掉非BLE设备，协议层过滤掉不匹配服务的设备，应用层进一步通过制造商数据确认目标设备身份。这种分层过滤策略不仅加速了设备发现过程，也显著降低了系统功耗，为后续的连接与数据传输奠定了高效基础。</p> <p><span><img height="338.15250000000003" originheight="1899" originwidth="2936" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163024.07810459415369205194551297995220:50001231000000:2800:5712906D9F6F746FC2029E4CB38C0E058732D1617757D6E00C4AF399D538F0A7.jpg" title="点击放大" width="523.6875"></span></p> <p><strong>关键技术</strong></p> <p>服务端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessgetstate" target="_blank">access.getState()</a>接口查询设备的蓝牙状态，根据返回的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#bluetoothstate" target="_blank">BluetoothState</a>值判断蓝牙是否开启，若未开启则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">enableBluetooth()</a>接口开启蓝牙；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising11-1" target="_blank">startAdvertising()</a>接口，开启广播，只有服务端先开启广播，客户端才能搜索到设备；</li><li>完成广播后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopadvertising" target="_blank">stopAdvertising()</a>接口，停止广播。</li></ol> <p>客户端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessgetstate" target="_blank">access.getState()</a>接口查询设备的蓝牙状态，根据返回的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#bluetoothstate" target="_blank">BluetoothState</a>值判断蓝牙是否开启，若未开启则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">enableBluetooth()</a>接口开启蓝牙；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartblescan" target="_blank">startBLEScan()</a>接口，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#scanoptions" target="_blank">ScanOptions</a>参数设置扫描参数配置，通过Array&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#scanfilter" target="_blank">ScanFilter</a>&gt;参数设置扫描结果的过滤策略集合，进行扫描，同时调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bleonbledevicefind" target="_blank">on('BLEDeviceFind')</a>方法订阅BLE设备扫描结果上报事件，处理扫描结果；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#connect" target="_blank">connect()</a>接口连接远端BLE设备；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopblescan" target="_blank">stopBLEScan()</a>接口停止蓝牙扫描。开发者可根据具体业务需求，在适当时机停止蓝牙扫描，例如扫描到目标设备后或断开连接时。</li></ol> </div> <div class="tiledSection"><h3 id="section94661431134418">实现流程<i class="anchor-icon anchor-icon-link" anchorid="section94661431134418" tips="复制节点链接"></i></h3><p><strong>服务端</strong></p> </div> <ol><li>开启广播前，需要先查询蓝牙是否可用，根据返回结果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#bluetoothstate" target="_blank">BluetoothState</a>的值来判断蓝牙是否开启，当取值是STATE_ON 或STATE_TURNING_ON返回true，表示蓝牙已开启。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L373-L389" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Check whether Bluetooth is enabled or turning on.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> True if enabled or turning on; false otherwise.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">isBluetoothEnabled</span>(): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">state</span>: access.<span class="hljs-property">BluetoothState</span> = access.<span class="hljs-property">BluetoothState</span>.<span class="hljs-property">STATE_OFF</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    state = access.<span class="hljs-title function_">getState</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`BluetoothServerModel, isBluetoothEnabled failed, error info: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`isBluetoothEnabled: state = <span class="hljs-subst">${state}</span>`</span>);</li><li>  <span class="hljs-keyword">if</span> (state === access.<span class="hljs-property">BluetoothState</span>.<span class="hljs-property">STATE_ON</span> || state === access.<span class="hljs-property">BluetoothState</span>.<span class="hljs-property">STATE_TURNING_ON</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L373-L389" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li><li id="li384712431593"><a name="ZH-CN_TOPIC_0000002524569711__li384712431593"></a><a name="li384712431593"></a>如果蓝牙未开启，服务端设备需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessenablebluetooth" target="_blank">access.enableBluetooth()</a>接口开启蓝牙。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L399-L399" data-highlighted="yes"><ol class="linenums"><li>access<span class="hljs-selector-class">.enableBluetooth</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L399-L399" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blecreategattserver" target="_blank">createGattServer()</a>创建一个Gatt服务的实例，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#addservice" target="_blank">addService()</a>接口，添加服务。服务添加成功后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartadvertising" target="_blank">startAdvertising()</a>接口开始广播。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L88-L185" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Start BLE advertising and initialize a simple Heart Rate service.</span></li><li><span class="hljs-comment"> * Also registers connection and descriptor write listeners.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> `StartAdvertiserResult` status code.</span></li><li><span class="hljs-comment"> */</span></li><li>startAdvertiser(): StartAdvertiserResult {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isBluetoothEnabled()) {</li><li>    <span class="hljs-keyword">this</span>.enableBluetooth();</li><li>    <span class="hljs-keyword">return</span> StartAdvertiserResult.BLUETOOTH_ENABLING;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isStateChangeListening) {</li><li>    <span class="hljs-comment">// Register Bluetooth state change listener.</span></li><li>    <span class="hljs-keyword">this</span>.onBTStateChange();</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mGattServer) {</li><li>    Logger.warn(<span class="hljs-string">'[BluetoothServerModel] Existing GATT server detected. Releasing previous instance before starting a new one.'</span>);</li><li>    <span class="hljs-comment">// Release GATT server resources and reset state flags.</span></li><li>    <span class="hljs-keyword">this</span>.releaseGattServer();</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.mGattServer = ble.createGattServer();</li><li>  <span class="hljs-keyword">this</span>.onDescriptorWriteChange();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Construct server-side service data.</span></li><li>  <span class="hljs-keyword">const</span> service: ble.GattService = {</li><li>    serviceUuid: BLE_SERVICE_UUID,</li><li>    isPrimary: <span class="hljs-literal">true</span>,</li><li>    characteristics: characteristics,</li><li>    includeServices: []</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.mGattServer.addService(service);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`addService: err = ${JSON.stringify(err)}`);</li><li>    <span class="hljs-keyword">this</span>.releaseGattServer();</li><li>    <span class="hljs-keyword">return</span> StartAdvertiserResult.FAILURE;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Register connection state change listener on GATT server.</span></li><li>    <span class="hljs-keyword">this</span>.onConnectStateChange();</li><li>    <span class="hljs-comment">// ...</span></li><li>    ble.startAdvertising(setting, advData, advResponse);</li><li>    <span class="hljs-keyword">return</span> StartAdvertiserResult.SUCCESS;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`startAdvertiser: err = ${JSON.stringify(err)}`);</li><li>    <span class="hljs-keyword">this</span>.releaseGattServer();</li><li>  }</li><li>  <span class="hljs-keyword">return</span> StartAdvertiserResult.FAILURE;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L88-L185" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> <p>如下表格为本文以心跳监控仪场景为例，对应示例代码中使用部分常量的说明，包括自定义厂商数据及蓝牙技术联盟（SIG）定义的标准服务、特征值和描述符。</p>  <div class="tablenoborder"><a name="ZH-CN_TOPIC_0000002524569711__table3846141532818"></a><a name="table3846141532818"></a><div class="tbBox"><table id="table3846141532818" class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.9.3.6.1.4.1.1" valign="top" width="29.060000000000002%"><p>项</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.6.1.4.1.2" valign="top" width="29.520000000000003%"><p>值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.9.3.6.1.4.1.3" valign="top" width="41.42%"><p>备注</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="29.060000000000002%"><p>服务 UUID（BLE_SERVICE_UUID）</p> </td> <td class="cellrowborder" valign="top" width="29.520000000000003%"><p>0000180D-0000-1000-8000-00805F9B34FB</p> </td> <td class="cellrowborder" valign="top" width="41.42%"><p>标准的Heart Rate Service（心率服务）UUID，用于心率监测设备。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="29.060000000000002%"><p>特征 UUID（BLE_CHARACTERISTIC_UUID）</p> </td> <td class="cellrowborder" valign="top" width="29.520000000000003%"><p>00002A37-0000-1000-8000-00805F9B34FB</p> </td> <td class="cellrowborder" valign="top" width="41.42%"><p>标准的Heart Rate Measurement Characteristic（心率测量特征值）UUID，用于传输心率数据。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="29.060000000000002%"><p>描述符 UUID（BLE_DESCRIPTOR_UUID）</p> </td> <td class="cellrowborder" valign="top" width="29.520000000000003%"><p>00002902-0000-1000-8000-00805F9B34FB</p> </td> <td class="cellrowborder" valign="top" width="41.42%"><p>标准的Client Characteristic Configuration Descriptor（客户端特征值配置描述符）UUID，用于控制客户端对服务端特征值通知（Notify）或指示（Indication）的订阅状态。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="29.060000000000002%"><p>厂商 ID（CUSTOM_MANUFACTURE_ID）</p> </td> <td class="cellrowborder" valign="top" width="29.520000000000003%"><p>0x027D</p> </td> <td class="cellrowborder" valign="top" width="41.42%"><p>可自定义，在客户端发起BLE扫描时，该数据可用于配置扫描结果的过滤策略。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="29.060000000000002%"><p>厂商数据</p> </td> <td class="cellrowborder" valign="top" width="29.520000000000003%"><p>[0x01, 0x02, 0x03, 0x04]（掩码 [FF,FF,00,00]）</p> </td> <td class="cellrowborder" valign="top" width="41.42%"><p>可自定义，在客户端发起BLE扫描时，该数据可用于配置扫描结果的过滤策略。</p> </td> </tr>  </tbody></table></div> </div> </li><li>广播目的达成后（如被目标设备扫描到），调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopadvertising" target="_blank">stopAdvertising()</a>接口，停止广播。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L189-L206" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Stop BLE advertising and disable Bluetooth (for demo cleanup).</span></li><li><span class="hljs-comment"> */</span></li><li>stopAdvertiser() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.mGattServer) {</li><li>    Logger.warn(<span class="hljs-string">'[BluetoothServerModel] stopAdvertiser invoked but GATT server is not initialized.'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.offBTStateChange();</li><li>  <span class="hljs-keyword">try</span> {</li><li>    ble.stopAdvertising();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`stopAdvertiser: err = ${JSON.stringify(err)}`);</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.releaseGattServer();</li><li>  <span class="hljs-keyword">this</span>.cachedDeviceId = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">this</span>.notifyDeviceIdChanged();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L189-L206" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li></ol> <p><strong>客户端</strong></p> <ol><li>客户端设备使用蓝牙功能时，同样需要开启蓝牙，开启方法与<a href="/consumer/cn/doc/best-practices/bpta-bluetooth-low-energy#li384712431593">服务端</a>相同。<p>开启蓝牙后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestartblescan" target="_blank">startBLEScan()</a>接口启动BLE扫描流程。扫描时，可通过配置过滤策略集合Array&lt;<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#scanfilter" target="_blank">ScanFilter</a>&gt;和扫描参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#scanoptions" target="_blank">ScanOptions</a>，主动扫描发现周围广播中特定类型的低功耗蓝牙设备。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L231-L250" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Start BLE scan with custom filter;</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> `StartBLEScanResult` status code.</span></li><li><span class="hljs-comment"> */</span></li><li>startBLEScan(): StartBLEScanResult {</li><li>  clearTimeout(<span class="hljs-keyword">this</span>.mTimeoutID);</li><li>  <span class="hljs-keyword">this</span>.mTimeoutID = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isBluetoothEnabled()) {</li><li>    Logger.info(<span class="hljs-string">'startBLEScan: bluetooth is disable'</span>);</li><li>    <span class="hljs-keyword">this</span>.enableBluetooth();</li><li>    <span class="hljs-keyword">return</span> StartBLEScanResult.BLUETOOTH_ENABLING;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.onBLEDeviceFind();</li><li>  <span class="hljs-keyword">const</span> ret = <span class="hljs-keyword">this</span>.startBLEScanInner();</li><li>  <span class="hljs-keyword">if</span> (ret) {</li><li>    <span class="hljs-comment">// BLE Scanning Timeout Protection</span></li><li>    <span class="hljs-keyword">this</span>.startScanTimeoutCountdown();</li><li>  }</li><li>  <span class="hljs-keyword">return</span> ret ? StartBLEScanResult.SUCCESS : StartBLEScanResult.FAILURE;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L231-L250" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L744-L780" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Internal helper to start scanning using a custom filter.</span></li><li><span class="hljs-comment"> * @returns True if scan started successfully.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">startBLEScanInner</span>(): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">scanFilter</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">createCustomScanFilter</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">scanOptions</span>: <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">ScanOptions</span> = {</li><li>      <span class="hljs-variable">interval</span>: <span class="hljs-number">500</span>,</li><li>      <span class="hljs-variable">dutyMode</span>: <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">ScanDuty</span>.<span class="hljs-title class_">SCAN_MODE_LOW_POWER</span>,</li><li>      <span class="hljs-variable">matchMode</span>: <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">MatchMode</span>.<span class="hljs-title class_">MATCH_MODE_AGGRESSIVE</span></li><li>    }</li><li>    <span class="hljs-variable">ble</span>.<span class="hljs-title function_">startBLEScan</span>([<span class="hljs-variable">scanFilter</span>], <span class="hljs-variable">scanOptions</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">startBLEScanInner</span>: <span class="hljs-title class_">err</span> = ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Create a custom scan filter that matches the demo server's manufacturer data and service UUID.</span></li><li><span class="hljs-comment"> * @returns ble.ScanFilter object.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">createCustomScanFilter</span>(): <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">ScanFilter</span> {</li><li>  <span class="hljs-comment">// Manufacturer data broadcast by the server.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">manufactureValueBuffer</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);</li><li>  <span class="hljs-comment">// Mask: 0xFF means match required, 0x00 means ignore that position.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">manufactureDataMask</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>([<span class="hljs-number">0xFF</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">scanFilter</span>: <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">ScanFilter</span> = {</li><li>    <span class="hljs-variable">serviceUuid</span>: <span class="hljs-title class_">BLE_SERVICE_UUID</span>,</li><li>    <span class="hljs-variable">manufactureId</span>: <span class="hljs-title class_">CUSTOM_MANUFACTURE_ID</span>,</li><li>    <span class="hljs-variable">manufactureData</span>: <span class="hljs-title class_">manufactureValueBuffer</span>.<span class="hljs-title class_">buffer</span>,</li><li>    <span class="hljs-variable">manufactureDataMask</span>: <span class="hljs-title class_">manufactureDataMask</span>.<span class="hljs-title class_">buffer</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">scanFilter</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L744-L780" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在发起BLE扫描并构建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#scanfilter" target="_blank">ScanFilter</a>扫描过滤器时，建议根据具体业务需求设定过滤条件，以精准捕获符合特定条件的广播数据包。典型过滤维度包括但不限于：</p> <ul><li>制造商ID（manufactureId）、制造商数据（manufactureData）及掩码（manufactureDataMask）</li><li>服务UUID（serviceUuid）及掩码（serviceUuidMask）</li><li>服务数据（serviceData）及掩码（serviceDataMask）</li></ul> <p>此外，不建议使用真实MAC地址（deviceId）作为过滤条件，原因如下：</p> <ul><li>信息安全机制：BLE底层会对真实MAC地址进行特殊处理，生成虚拟MAC地址（随机地址）。若在代码中使用真实MAC地址作为过滤条件，则无法匹配到设备。</li><li>地址可能改变：设备取消配对或蓝牙服务下电时，随机MAC地址会变更，导致过滤失效。</li></ul> <p>综上所述，在发起BLE扫描时，通过合理配置这些过滤参数，可以有效降低无效数据接收率，提升扫描效率，减少系统资源消耗。</p> </div></div></div> <p>onBLEDeviceFind方法中通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#bleonbledevicefind" target="_blank">ble.on('BLEDeviceFind')</a>订阅BLE设备扫描结果上报事件，并将扫描到的设备存放到可用设备列表中。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L550-L589" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Device discovery handler; de-duplicates、 update and insert devices.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> arr List of scan results.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title class_">BLEDeviceFindFunc</span> = (<span class="hljs-attr">arr</span>: <span class="hljs-title class_">Array</span>&lt;ble.<span class="hljs-property">ScanResult</span>&gt;): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!arr.<span class="hljs-property">length</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> result <span class="hljs-keyword">of</span> arr) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceId</span>: <span class="hljs-built_in">string</span> = result.<span class="hljs-property">deviceId</span>;</li><li>    <span class="hljs-keyword">if</span> (!deviceId) {</li><li>      <span class="hljs-keyword">continue</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">deviceName</span>: <span class="hljs-built_in">string</span> = result.<span class="hljs-property">deviceName</span>;</li><li>    <span class="hljs-keyword">if</span> (!deviceName) {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ArrayBuffer</span> = result.<span class="hljs-property">data</span>;</li><li>        deviceName = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>, {</li><li>          <span class="hljs-attr">ignoreBOM</span>: <span class="hljs-literal">true</span></li><li>        }).<span class="hljs-title function_">decodeToString</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data), { <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span> });</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`decode deviceName fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">upsertAvailableDevice</span>(deviceId, deviceName);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Subscribe to BLE device discovery events.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">onBLEDeviceFind</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    ble.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEDeviceFind'</span>, <span class="hljs-function">(<span class="hljs-params">arr: <span class="hljs-built_in">Array</span>&lt;ble.ScanResult&gt;</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">BLEDeviceFindFunc</span>(arr);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`onBLEDeviceFind: err = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L550-L589" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li><li>扫描到设备后，用户选择对应的蓝牙设备进行连接。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L797-L816" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Internal helper to connect, set listeners, and update state to CONNECTING.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> gattClientDevice Target GATT client device.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> True if connect() call was issued without throwing.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> connectInner(gattClientDevice: ble.GattClientDevice): boolean {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (!gattClientDevice) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.onBLEConnectionStateChange();</li><li>    <span class="hljs-keyword">this</span>.onBLECharacteristicChange();</li><li>    <span class="hljs-keyword">this</span>.markConnectionState(ConnectionState.STATE_CONNECTING);</li><li>    gattClientDevice.connect();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`connectInner: err = ${JSON.stringify(err)}`);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L797-L816" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li><li>根据具体业务需求，在适当时机调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#blestopblescan" target="_blank">stopBLEScan()</a>接口停止蓝牙扫描。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L254-L265" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Stop BLE scanning and remove discovery callbacks.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> `StopBLEScanResult` status code.</span></li><li><span class="hljs-comment"> */</span></li><li>stopBLEScan(): StopBLEScanResult {</li><li>  clearTimeout(<span class="hljs-keyword">this</span>.mTimeoutID);</li><li>  <span class="hljs-keyword">this</span>.mTimeoutID = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">this</span>.offBLEDeviceFind();</li><li>  <span class="hljs-comment">// This method calls ble.stopBLEScan() to stop the BLE scan.</span></li><li>  <span class="hljs-keyword">const</span> ret = <span class="hljs-keyword">this</span>.stopBLEScanInner();</li><li>  <span class="hljs-keyword">return</span> ret ? StopBLEScanResult.SUCCESS : StopBLEScanResult.FAILURE;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L254-L265" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>为优化资源利用并降低功耗，应及时停止BLE扫描/广播，其合理时机包括但不限于：</p> <ul><li>目的达成，客户端发现目标设备并建立连接后，应立即停止扫描；服务端在成功连接后可考虑降低广播频率或完全停止。</li><li>用户离开场景，例如示例代码中客户端的aboutToDisappear()生命周期方法中的逻辑，当用户离开设备列表页面时，应停止扫描并关闭GATT连接。</li><li>超时保护，设置合理的扫描超时阈值（如<a href="/consumer/cn/doc/best-practices/bpta-bluetooth-low-energy#li1575819531669">示例代码</a>中的SCAN_TIMEOUT_MS常量），超过时限自动停止，以防止异常情况下的资源泄露。</li><li>用户显式操作，提供UI控件（如“停止扫描”按钮），允许用户手动终止过程。</li></ul> <p><strong>实施建议</strong>：通过主动管理BLE扫描/广播的启停时机，可有效降低设备功耗，同时避免内存泄漏和连接冲突等异常情况。建议结合具体业务场景，建立包含状态监听、超时处理、用户交互的完整资源管理闭环。</p> </div></div></div> <div class="tiledSection"><h2 id="section19336939151819">蓝牙连接状态管理<i class="anchor-icon anchor-icon-link" anchorid="section19336939151819" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section15557171714332" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section15557171714332" tips="复制节点链接"></i></h3><p>蓝牙连接状态管理能够实时监测蓝牙连接的质量，包括信号强度、数据传输速率和误码率等指标。蓝牙设备连接后，常遇到服务端与客户端连接状态变化的情况，例如客户端连接后，服务端停止广播导致连接中断。针对此类问题，在蓝牙设备开发过程中，应对蓝牙连接状态进行有效管理。</p> <p>在使用BLE通信服务时，用户期望实现“一次配对，持久连接”的无缝体验，而非每次使用时重复繁琐的搜索配对流程。此时，BLE连接状态管理可通过固化对端设备的虚拟MAC地址，实现智能自动重连机制。该机制在应用重启或系统恢复后，无需用户重复扫描建立连接，可快速与之前已连接的蓝牙设备重新建立连接，显著提升应用的专业性和使用便捷性，为用户提供稳定可靠的蓝牙连接体验。</p> </div> <div class="tiledSection"><h3 id="section937934311424">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section937934311424" tips="复制节点链接"></i></h3><p>在服务端与客户端进行连接操作时，需注册相应的监听事件，例如监听蓝牙设备开关状态和蓝牙状态变化。当状态发生变化时，可通过回调函数处理相应逻辑。</p> <p><strong>关键技术</strong></p> <p>服务端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessonstatechange" target="_blank">on('stateChange')</a>方法订阅蓝牙设备开关状态事件；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onconnectionstatechange" target="_blank">on('connectionStateChange')</a>方法订阅GATT profile协议的连接状态变化事件。</li></ol> <p>客户端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessonstatechange" target="_blank">on('stateChange')</a>方法订阅蓝牙设备开关状态事件；</li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>方法订阅GATT profile协议的连接状态变化事件；</li><li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>方法返回的状态值为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_CONNECTED</a>时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">addPersistentDeviceId()</a>方法持久化存储蓝牙设备的虚拟MAC地址；</li><li>当应用启动或者页面显示时，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessgetpersistentdeviceids16" target="_blank">getPersistentDeviceIds()</a>方法获取应用持久化存储过的蓝牙虚拟MAC地址，并向对端设备发起连接。</li></ol> </div> <div class="tiledSection"><h3 id="section663132014468">实现流程<i class="anchor-icon anchor-icon-link" anchorid="section663132014468" tips="复制节点链接"></i></h3><p><strong>服务端</strong></p> </div> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessonstatechange" target="_blank">access.on('stateChange')</a>方法订阅蓝牙设备开关状态事件。<p>服务端需先监听系统蓝牙开关状态，确保在蓝牙开启时提供BLE服务。若蓝牙被关闭，服务端应及时释放GATT服务资源，避免资源浪费和异常状态。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L262-L293" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Internal: Bluetooth adapter state change handler to reflect enable/disable.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data Current Bluetooth state.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> stateChangeFunc = (<span class="hljs-keyword">data</span>: access.BluetoothState): void =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> === access.BluetoothState.STATE_ON) {</li><li>    <span class="hljs-keyword">this</span>.cachedBluetoothEnable = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.notifyBluetoothEnableChanged(<span class="hljs-literal">true</span>);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> === access.BluetoothState.STATE_OFF) {</li><li>    <span class="hljs-keyword">this</span>.cachedBluetoothEnable = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.notifyBluetoothEnableChanged(<span class="hljs-literal">false</span>);</li><li>    <span class="hljs-keyword">this</span>.notifyEnabledMap.clear();</li><li>    <span class="hljs-keyword">this</span>.cachedDeviceId = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">this</span>.notifyDeviceIdChanged();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Register Bluetooth state change listener.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> onBTStateChange() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isStateChangeListening) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    access.on(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">this</span>.stateChangeFunc);</li><li>    <span class="hljs-keyword">this</span>.isStateChangeListening = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">this</span>.isStateChangeListening = <span class="hljs-literal">false</span>;</li><li>    Logger.error(`onBTSateChange: err = ${JSON.stringify(err)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L262-L293" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onconnectionstatechange" target="_blank">on('connectionStateChange')</a>订阅GATT profile协议的连接状态变化事件。<p>服务端通过GATT服务器实例监听连接状态变化，当有设备连接或断开时，更新内部状态并通知UI层。特别地，在设备连接成功时，服务端记录客户端的设备ID，为后续数据传输（如心率通知）做准备；在设备断开时，清理相关状态，并提供友好的断连提示。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L318-L353" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Internal: Connection state change handler to track the connected device id.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data Connection state payload.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> connectionStateChangeFunc = (<span class="hljs-keyword">data</span>: ble.BLEConnectionChangeState): void =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.state === constant.ProfileConnectionState.STATE_CONNECTED) {</li><li>      let deviceId = <span class="hljs-keyword">data</span>.deviceId;</li><li>      <span class="hljs-keyword">this</span>.notifyEnabledMap.<span class="hljs-keyword">set</span>(deviceId, <span class="hljs-literal">false</span>);</li><li>      <span class="hljs-keyword">this</span>.cachedDeviceId = deviceId;</li><li>      <span class="hljs-keyword">this</span>.notifyDeviceIdChanged();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.state === constant.ProfileConnectionState.STATE_DISCONNECTED) {</li><li>      <span class="hljs-keyword">const</span> deviceId = <span class="hljs-keyword">data</span>.deviceId;</li><li>      <span class="hljs-keyword">this</span>.notifyEnabledMap.delete(deviceId);</li><li>      <span class="hljs-keyword">this</span>.cachedDeviceId = <span class="hljs-string">''</span>;</li><li>      <span class="hljs-keyword">this</span>.notifyDeviceIdChanged();</li><li>      CommonUtils.showToast(CommonUtils.getUIContext(), $r(<span class="hljs-string">'app.string.disconnection_prompt'</span>));</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Register connection state change listener on GATT server.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> onConnectStateChange() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.mGattServer || <span class="hljs-keyword">this</span>.isConnectStateChangeListening) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.mGattServer.on(<span class="hljs-string">'connectionStateChange'</span>, <span class="hljs-keyword">this</span>.connectionStateChangeFunc);</li><li>    <span class="hljs-keyword">this</span>.isConnectStateChangeListening = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`connectInner: err = ${JSON.stringify(err)}`);</li><li>    <span class="hljs-keyword">this</span>.isConnectStateChangeListening = <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L318-L353" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li></ol> <p><strong>客户端</strong></p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessonstatechange" target="_blank">access.on('stateChange')</a>订阅蓝牙设备开关状态事件。<p>客户端需监听蓝牙开关状态，蓝牙开启时自动触发设备扫描流程，避免用户手动操作；蓝牙关闭时，清理已发现设备列表及当前连接状态，防止UI显示不一致。此主动状态管理确保应用行为与系统蓝牙状态同步，提供流畅的用户体验。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L490-L530" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Bluetooth adapter state change listener.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data New Bluetooth state.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> stateChangeFunc = (<span class="hljs-keyword">data</span>: access.BluetoothState): void =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> === access.BluetoothState.STATE_ON) {</li><li>    <span class="hljs-keyword">this</span>.bluetoothEnabled = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.notifyBluetoothStateChanged(<span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">this</span>.startBLEScan();</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> === access.BluetoothState.STATE_OFF) {</li><li>    <span class="hljs-comment">// Clear discovered device list and current connection status.</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Subscribe to Bluetooth adapter state changes.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> subscribeBTStateChange() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isBTStateChangeSubscribed) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    access.on(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">this</span>.stateChangeFunc);</li><li>    <span class="hljs-keyword">this</span>.isBTStateChangeSubscribed = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">this</span>.isBTStateChangeSubscribed = <span class="hljs-literal">false</span>;</li><li>    Logger.error(`onBTSateChange: err = ${JSON.stringify(err)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L490-L530" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>订阅GATT profile协议的连接状态变化事件，并调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">addPersistentDeviceId()</a>方法持久化存储蓝牙设备的虚拟MAC地址。<p>客户端通过GattClientDevice实例监听连接状态变化，当连接成功时，将对端设备的虚拟MAC地址通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">addPersistentDeviceId()</a>接口固化到系统存储中。这一步骤至关重要，它使应用在下次启动时无需重新扫描，可直接使用已保存的设备ID发起连接，显著提升连接效率。同时，客户端还将启用特征值通知功能，为后续数据传输做准备。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L87-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Handler for connection state changes emitted by ble.GattClientDevice.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data BLE connection state payload.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title class_">BLEConnectionStateChangeFunc</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">data</span>: ble.<span class="hljs-property">BLEConnectionChangeState</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">state</span>: constant.<span class="hljs-property">ProfileConnectionState</span> = data.<span class="hljs-property">state</span>;</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleGattConnected</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_DISCONNECTED</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleGattDisconnected</span>();</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`GATT link disconnected. GattDisconnectReason reason code: <span class="hljs-subst">${data.reason}</span>`</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTING</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`GATT link is connecting.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L87-L103" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L604-L666" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Subscribe to connection state changes on the current GATT client device.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> onBLEConnectionStateChange() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.mGattClientDevice) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.mGattClientDevice.on(<span class="hljs-string">'BLEConnectionStateChange'</span>, <span class="hljs-keyword">this</span>.BLEConnectionStateChangeFunc);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(`onBLEConnectionStateChange: err = ${JSON.stringify(err)}`);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Handle successful GATT connection: update state, persist device and enable notifications.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> async handleGattConnected(): Promise&lt;void&gt; {</li><li>  <span class="hljs-keyword">this</span>.markConnectionState(ConnectionState.STATE_CONNECTED);</li><li>  <span class="hljs-keyword">this</span>.mLastConnectedDevice = <span class="hljs-keyword">this</span>.cloneDevice(<span class="hljs-keyword">this</span>.mConnectBluetoothDevice);</li><li>  <span class="hljs-keyword">this</span>.notifyLastConnectedDeviceChanged();</li><li>  <span class="hljs-keyword">this</span>.savePersistentDeviceId(<span class="hljs-keyword">this</span>.mConnectBluetoothDevice.deviceId);</li><li>  <span class="hljs-comment">// Stop scanning after connection.</span></li><li>  <span class="hljs-keyword">this</span>.stopBLEScan();</li><li>  await <span class="hljs-keyword">this</span>.enableHeartRateNotification();</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Save a random device id to system persistent list if valid and not already saved.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> deviceId Random device address to persist.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> savePersistentDeviceId(deviceId: string | undefined) {</li><li>  <span class="hljs-comment">// Validate whether the deviceId to be persisted is legal.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  access.addPersistentDeviceId(deviceId)</li><li>    .then(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.syncPersistentDeviceIds();</li><li>    })</li><li>    .<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>      Logger.warn(`Failed to persist Bluetooth device virtual MAC address, error info: ${JSON.stringify(err)}`)</li><li>    })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L604-L666" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessgetpersistentdeviceids16" target="_blank">getPersistentDeviceIds()</a>方法获取应用持久化存储过的蓝牙虚拟MAC地址，实现BLE自动重连。<p>当应用启动或页面重新显示时，客户端会从系统获取所有持久化的设备ID，优先尝试与最近连接的设备建立连接。同时会自动处理连接超时和失败重试逻辑，并在UI上提供连接状态反馈。这一机制实现了快速回连体验，用户无需记忆上次连接的设备，也无需重复扫描配对操作，显著提升了应用的易用性。同时，连接失败时会自动清理无效的持久化ID，确保下次启动时不会尝试连接无效设备。</p> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L127-L177" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Try to auto-reconnect using system persistent device ids.</span></li><li><span class="hljs-comment"> * Only attempts the first id to keep behavior predictable.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> True if a connection attempt was initiated.</span></li><li><span class="hljs-comment"> */</span></li><li>async tryAutoReconnect(): Promise&lt;boolean&gt; {</li><li>  <span class="hljs-comment">// Prevent multiple concurrent reconnection attempts</span></li><li>  let isReconnecting: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.mIsAutoReconnecting) {</li><li>    <span class="hljs-keyword">return</span> isReconnecting;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.mIsAutoReconnecting = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Retrieves the previously persisted Bluetooth virtual MAC addresses by calling the `getPersistentDeviceIds()` method.</span></li><li>    <span class="hljs-keyword">const</span> ids = <span class="hljs-keyword">this</span>.syncPersistentDeviceIds();</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Get the most recent device ID</span></li><li>    <span class="hljs-keyword">const</span> targetId = ids[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-comment">// Retrieve device name and update UI state related</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.mGattClientDevice = ble.createGattClientDevice(targetId);</li><li>      <span class="hljs-keyword">const</span> ret = <span class="hljs-keyword">this</span>.connectInner(<span class="hljs-keyword">this</span>.mGattClientDevice);</li><li>      isReconnecting = ret;</li><li>      <span class="hljs-keyword">if</span> (!ret) {</li><li>        <span class="hljs-keyword">this</span>.resetConnectionState();</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      Logger.error(`BluetoothClientModel, createGattClientDevice failed, error info: ${JSON.stringify(error)}`);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.error(`[BluetoothClientModel.tryAutoReconnect] ${JSON.stringify(error)}`);</li><li>  } <span class="hljs-keyword">finally</span> {</li><li>    <span class="hljs-keyword">this</span>.mIsAutoReconnecting = <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> isReconnecting;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L127-L177" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section3815173833718">蓝牙设备特征值同步<i class="anchor-icon anchor-icon-link" anchorid="section3815173833718" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1604151812385" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1604151812385" tips="复制节点链接"></i></h3><p>在BLE通信中，特征值是数据的基本单元，用于存储或传输特定类型的数据实体。许多蓝牙设备常需实时传输数据，例如，运动传感器将加速度、陀螺仪等数据传输至手机应用。如果特征值不同步，可能导致数据延迟、丢失或顺序错误，从而使接收端（如手机应用）无法准确分析运动状态，如在运动步数统计中可能出现少计或多计步数的情况。</p> </div> <div class="tiledSection"><h3 id="section11590102016411">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section11590102016411" tips="复制节点链接"></i></h3><p>在服务端与客户端连接成功后，服务端通过调用相关接口主动通知客户端特征值的变化；而客户端需要调用接口向服务端来订阅特征值变化，当特征值变化时，客户端即可接收相关变化信息。此外，在低功耗蓝牙通信过程中，确保接口调用顺序正确是保障数据传输可靠性的关键，错误的调用顺序会导致操作阻塞或通信失败。</p> <p><strong>关键技术</strong></p> <p>服务端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristicchanged" target="_blank">notifyCharacteristicChanged()</a>方法，主动通知已连接的客户端设备特征值的变化。</li></ol> <p>客户端：</p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>，订阅GATT profile协议的连接状态变化事件；<ul><li>根据回调返回的连接状态信息处理不同连接状态下的业务逻辑。</li><li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">ProfileConnectionState</a>连接状态为“已连接”时：<ul><li>首先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices" target="_blank">getServices()</a>进行服务发现，获取服务端设备支持的所有服务；</li><li>随后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>，启用接收服务端特征值内容变更通知的能力；</li><li>在启用接收服务端特征值内容变更通知成功后，才能调用下一次读取或写入操作，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readcharacteristicvalue" target="_blank">readCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readdescriptorvalue" target="_blank">readDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication()</a>。</li></ul> </li><li>当<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">ProfileConnectionState</a>连接状态为“已断开连接”时：<ul><li>更新连接状态；</li><li>打印GATT链路断开的原因日志信息。</li></ul> </li></ul> </li><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onblecharacteristicchange" target="_blank">on('BLECharacteristicChange')</a>订阅蓝牙低功耗设备的特征值变化事件。<ul><li>在特征值变化事件中实现对蓝牙设备特征值变化的监听和处理功能（如心率特征变化等）。</li></ul> </li></ol> <p><strong>流程时序总结</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.22.9.1.5.1.1" valign="top" width="20.549999999999997%"><p>步骤</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.22.9.1.5.1.2" valign="top" width="31.81%"><p>操作</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.22.9.1.5.1.3" valign="top" width="25.5%"><p>依赖条件</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.22.9.1.5.1.4" valign="top" width="22.14%"><p>未满足影响</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20.549999999999997%"><p>1. 连接建立</p> </td> <td class="cellrowborder" valign="top" width="31.81%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a> -&gt; <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">STATE_CONNECTED</a></p> </td> <td class="cellrowborder" valign="top" width="25.5%"><p>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#gattclientdevice" target="_blank">GattClientDevice</a>实例</p> </td> <td class="cellrowborder" valign="top" width="22.14%"><p>后续操作均无法执行</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20.549999999999997%"><p>2. 注册通知监听</p> </td> <td class="cellrowborder" valign="top" width="31.81%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a></p> </td> <td class="cellrowborder" valign="top" width="25.5%"><p>1. 需要先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices" target="_blank">getServices()</a>，获取到server端所有支持的能力，且需包含指定的入参特征值UUID；</p> <p>2. 异步回调结果返回后，才能调用下一次读取或者写入操作。</p> </td> <td class="cellrowborder" valign="top" width="22.14%"><p>通知无法触发，操作阻塞</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20.549999999999997%"><p>3. 特征值或者描述符写入</p> </td> <td class="cellrowborder" valign="top" width="31.81%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a></p> </td> <td class="cellrowborder" valign="top" width="25.5%"><p>1. 已建立GATT连接；</p> <p>2. 已成功注册特征值监听；</p> <p>3. 依赖上一次异步操作完成，包括通知、读取、写入等接口；</p> <p>4. 写入的数据格式正确。</p> </td> <td class="cellrowborder" valign="top" width="22.14%"><p>通信失败或忽略配置</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section13605456125115">实现流程<i class="anchor-icon anchor-icon-link" anchorid="section13605456125115" tips="复制节点链接"></i></h3></div> <p><strong>服务端</strong></p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#notifycharacteristicchanged" target="_blank">notifyCharacteristicChanged()</a>，特征值发生变化时，主动通知已连接的客户端设备。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L210-L244" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Notify a connected client with a heart rate value.</span></li><li><span class="hljs-comment"> * @param deviceId Target device random address.</span></li><li><span class="hljs-comment"> * @param heartRate Heart rate (bpm) to send.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">notifyCharacteristicChanged</span>(<span class="hljs-variable">deviceId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">heartRate</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-comment">// Validate deviceId and GattServer for legitimacy</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">sanitizedHeartRate</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-variable">heartRate</span>));</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">notifyCharacteristic</span>: <span class="hljs-title class_">ble</span>.<span class="hljs-title class_">NotifyCharacteristic</span> = {</li><li>    <span class="hljs-variable">serviceUuid</span>: <span class="hljs-title class_">BLE_SERVICE_UUID</span>,</li><li>    <span class="hljs-variable">characteristicUuid</span>: <span class="hljs-title class_">BLE_CHARACTERISTIC_UUID</span>,</li><li>    <span class="hljs-variable">characteristicValue</span>: <span class="hljs-title class_">CommonUtils</span>.<span class="hljs-title class_">byteArray2ArrayBuffer</span>([<span class="hljs-number">0x00</span>, <span class="hljs-title class_">sanitizedHeartRate</span>]),</li><li>    <span class="hljs-variable">confirm</span>: <span class="hljs-keyword">false</span></li><li>  }</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">mGattServer</span>.<span class="hljs-title function_">notifyCharacteristicChanged</span>(<span class="hljs-variable">deviceId</span>, <span class="hljs-variable">notifyCharacteristic</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">notifyCharacteristicChanged</span> <span class="hljs-variable">callback</span> <span class="hljs-variable">failed</span>: <span class="hljs-title class_">err</span> = ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(`[<span class="hljs-variable">BluetoothServerModel</span>] <span class="hljs-variable">Heart</span> <span class="hljs-variable">rate</span> <span class="hljs-variable">notify</span> <span class="hljs-variable">success</span>, <span class="hljs-variable">device</span>=${<span class="hljs-variable">deviceId</span>}, <span class="hljs-variable">value</span>=${<span class="hljs-variable">sanitizedHeartRate</span>}`);</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/server/model/BluetoothServerModel.ets#L210-L244" target="_blank">BluetoothServerModel.ets</a></div></div></div></div> </li></ol> <p><strong>客户端</strong></p> <ol><li>调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>接口，向服务端发送设置通知此特征值请求。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L87-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Handler for connection state changes emitted by ble.GattClientDevice.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data BLE connection state payload.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title class_">BLEConnectionStateChangeFunc</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">data</span>: ble.<span class="hljs-property">BLEConnectionChangeState</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">state</span>: constant.<span class="hljs-property">ProfileConnectionState</span> = data.<span class="hljs-property">state</span>;</li><li>  <span class="hljs-keyword">if</span> (data) {</li><li>    <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTED</span>) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleGattConnected</span>();</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_DISCONNECTED</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleGattDisconnected</span>();</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`GATT link disconnected. GattDisconnectReason reason code: <span class="hljs-subst">${data.reason}</span>`</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state === constant.<span class="hljs-property">ProfileConnectionState</span>.<span class="hljs-property">STATE_CONNECTING</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`GATT link is connecting.`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L87-L103" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L605-L726" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Subscribe to connection state changes on the current GATT client device.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">onBLEConnectionStateChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mGattClientDevice</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mGattClientDevice</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLEConnectionStateChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">BLEConnectionStateChangeFunc</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`onBLEConnectionStateChange: err = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Handle successful GATT connection: update state, persist device and enable notifications.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleGattConnected</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Stop scanning after connection.</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopBLEScan</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enableHeartRateNotification</span>();</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Enable heart rate notifications by toggling notification and writing CCC descriptor.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">enableHeartRateNotification</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> device = <span class="hljs-variable language_">this</span>.<span class="hljs-property">mGattClientDevice</span>;</li><li>  <span class="hljs-keyword">if</span> (!device) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[BluetoothClientModel.enableHeartRateNotification] GATT client device unavailable.'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">services</span>: ble.<span class="hljs-property">GattService</span>[] = <span class="hljs-keyword">await</span> device.<span class="hljs-title function_">getServices</span>();</li><li>    <span class="hljs-comment">// Perform filtering operations to precisely locate target characteristic values and their configuration descriptors within the GATT service structure</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">descriptorObj</span>: <span class="hljs-title class_">BLEDescriptor</span> = {</li><li>      <span class="hljs-attr">serviceUuid</span>: descriptor.<span class="hljs-property">serviceUuid</span>,</li><li>      <span class="hljs-attr">characteristicUuid</span>: descriptor.<span class="hljs-property">characteristicUuid</span>,</li><li>      <span class="hljs-attr">descriptorUuid</span>: descriptor.<span class="hljs-property">descriptorUuid</span>,</li><li>      <span class="hljs-attr">descriptorValue</span>: <span class="hljs-title class_">CommonUtils</span>.<span class="hljs-title function_">byteArray2ArrayBuffer</span>([<span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>])</li><li>    };</li><li>    device.<span class="hljs-title function_">setCharacteristicChangeNotification</span>(characteristic, <span class="hljs-literal">true</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`NotifyCharacteristicChanged callback failed, error info: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>)</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        device.<span class="hljs-title function_">writeDescriptorValue</span>(descriptorObj).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`The descriptor for the BLE peripheral device has been successfully written.`</span>);</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Failed to writes the descriptor of a BLE peripheral device.`</span>);</li><li>        })</li><li>      }</li><li>    });</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'[BluetoothClientModel.enableHeartRateNotification] Notification enabled successfully.'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`BluetoothClientModel, enableHeartRateNotification failed, error info:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L605-L726" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li><li>订阅蓝牙低功耗设备的特征值变化事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onblecharacteristicchange" target="_blank">on('BLECharacteristicChange')</a>。需要先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>接口或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication()</a>接口才能接收server端的通知。<div class="screenLinkPre"><div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L444-L472" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Characteristic change handler that parses a simple HR Measurement (Flags, HR).</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> data Characteristic payload event.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title class_">BLECharacteristicChangeFunc</span> = (<span class="hljs-attr">data</span>: ble.<span class="hljs-property">BLECharacteristic</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">characteristicValue</span>: <span class="hljs-title class_">ArrayBuffer</span> = data.<span class="hljs-property">characteristicValue</span>;</li><li>  <span class="hljs-keyword">let</span> byteArr = <span class="hljs-title class_">CommonUtils</span>.<span class="hljs-title function_">arrayBuffer2ByteArray</span>(characteristicValue);</li><li>  <span class="hljs-keyword">if</span> (!byteArr || byteArr.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[BluetoothClientModel.BLECharacteristicChangeFunc] Invalid heart rate payload: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(byteArr)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> heartRate = byteArr[<span class="hljs-number">1</span>];</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHeartRate</span> = heartRate;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyHeartRateChanged</span>(heartRate);</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Register a listener for characteristic value changes.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">onBLECharacteristicChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">mGattClientDevice</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mGattClientDevice</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'BLECharacteristicChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">BLECharacteristicChangeFunc</span>);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`BluetoothClientModel, onBLECharacteristicChange failed, error info:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy/blob/master/entry/src/main/ets/pages/client/model/BluetoothClientModel.ets#L444-L472" target="_blank">BluetoothClientModel.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section925713220435">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section925713220435" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1178632141920" class="firsth2">设备连接后调用getServices()获取不到数据<i class="anchor-icon anchor-icon-link" anchorid="section1178632141920" tips="复制节点链接"></i></h3><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#onbleconnectionstatechange" target="_blank">on('BLEConnectionStateChange')</a>接口订阅GATT profile协议的连接状态变化事件，当返回的状态值<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-constant#profileconnectionstate" target="_blank">ProfileConnectionState</a>为STATE_CONNECTED时，表示本端与对端蓝牙设备间的Profile已成功连接。随后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices-1" target="_blank">getServices()</a>获取服务端设备支持的所有服务能力。</p> </div> <div class="tiledSection"><h3 id="section7703204916190">扫描获取的deviceId与真实地址不同<i class="anchor-icon anchor-icon-link" anchorid="section7703204916190" tips="复制节点链接"></i></h3><p>基于信息安全考虑，此处获取的设备地址为虚拟MAC地址，真实MAC地址不直接暴露。</p> <p>在API 16及后续版本中，HarmonyOS提供了无需配对即可将蓝牙虚拟MAC地址固化的API接口：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">access.addPersistentDeviceId()</a>。</p> <p>由于应用通过蓝牙扫描获取到的未配对或未固化（参考如下说明）的设备MAC地址为虚拟随机地址，若需该虚拟随机地址不发生改变，可调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">addPersistentDeviceId()</a>接口持久化存储虚拟随机地址。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ol><li>使用蓝牙虚拟MAC地址固化API需申请<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionpersistent_bluetooth_peers_mac" target="_blank">ohos.permission.PERSISTENT_BLUETOOTH_PEERS_MAC</a>权限，并在<a href="https://developer.huawei.com/consumer/cn/doc/app/agc-help-apply-acl-0000002394212138" target="_blank">ACL</a>权限审核通过后方可使用。</li><li>使用此接口时，开发者应明确该虚拟随机地址对应的对端蓝牙设备真实地址保持不变。若对端设备地址变更，持久化保存的地址信息也将失效，无法继续使用。</li><li>蓝牙虚拟MAC地址固化的API接口比喻：想象你常去的咖啡店会给熟客发放一张<strong>专属会员卡</strong>（虚拟MAC地址）。<ul><li><strong>未固化场景</strong>：每次进店，店员都会给你随机更换新卡（虚拟地址变化），你需要反复证明自己是熟客（重新扫描连接）。</li><li><strong>固化后场景</strong>：店员将你的会员卡号永久记录在系统中（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-access#accessaddpersistentdeviceid16" target="_blank">addPersistentDeviceId()</a>）。今后进店，直接刷旧卡（原虚拟地址），系统自动识别你的身份（快速回连），无需重新办理会员卡（无需重复扫描）。</li></ul> </li></ol> </div></div></div> </div> <div class="tiledSection"><h3 id="section928852119312">蓝牙数据传输报错失败<i class="anchor-icon anchor-icon-link" anchorid="section928852119312" tips="复制节点链接"></i></h3><p>请检查应用逻辑，确认双端通信发送新消息需等待前次操作回调完成，例如有如下场景需要注意：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#getservices" target="_blank">getServices()</a>必须在建立GATT连接后优先调用，且需在其完成服务发现后，才能执行后续特征值/描述符操作（如读写、订阅通知等）。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>异步回调结果返回后，才能调用下一次读取或者写入操作，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readcharacteristicvalue" target="_blank">readCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readdescriptorvalue" target="_blank">readDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication()</a>。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a>异步回调结果返回后，才能调用下一次读取或者写入操作，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readcharacteristicvalue" target="_blank">readCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#readdescriptorvalue" target="_blank">readDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writecharacteristicvalue" target="_blank">writeCharacteristicValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#writedescriptorvalue" target="_blank">writeDescriptorValue()</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangenotification" target="_blank">setCharacteristicChangeNotification()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bluetooth-ble#setcharacteristicchangeindication" target="_blank">setCharacteristicChangeIndication()</a>。</li></ul> </div> <div class="tiledSection"><h3 id="section18132102433216">使用connection.pairDevice()发起设备配对并成功后，如何通过代码调用取消配对<i class="anchor-icon anchor-icon-link" anchorid="section18132102433216" tips="复制节点链接"></i></h3><p>基于信息安全考虑，目前不支持通过代码取消配对。若需取消配对，可引导用户进入蓝牙设置页面手动操作。打开系统蓝牙设置页面的方法如下：</p> <div _ngcontent-qcm-c106="" class="highlight-div"><div _ngcontent-qcm-c106="" class="highlight-div-header"><div _ngcontent-qcm-c106="" class="highlight-div-header-left"><div _ngcontent-qcm-c106="" class="handle-button expand-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qcm-c106="" class="highlight-div-header-right"><div _ngcontent-qcm-c106="" class="handle-button ai-button"></div><div _ngcontent-qcm-c106="" class="handle-button line-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qcm-c106="" class="handle-button theme-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qcm-c106="" class="handle-button copy-button"><div _ngcontent-qcm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qcm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Opens the system Bluetooth settings page.</span></li><li><span class="hljs-comment"> * This method uses HarmonyOS Ability framework to launch the system settings ability specifically for Bluetooth configuration.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">openBlueToothSettingsPage</span>() {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span> = {</li><li>    <span class="hljs-variable">bundleName</span>: <span class="hljs-string">'com.huawei.hmos.settings'</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-string">'com.huawei.hmos.settings.MainAbility'</span>,</li><li>    <span class="hljs-variable">uri</span>: <span class="hljs-string">'bluetooth_entry'</span></li><li>  };</li><li>  <span class="hljs-variable">context</span>.<span class="hljs-title function_">startAbility</span>(<span class="hljs-variable">want</span>).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">console</span>.<span class="hljs-title function_">error</span>(`<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-keyword">open</span> <span class="hljs-variable">bluetooth</span> <span class="hljs-variable">settings</span>, <span class="hljs-variable">error</span> <span class="hljs-variable">info</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  });</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section2172947845">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section2172947845" tips="复制节点链接"></i></h2><ul><li id="li1575819531669"><a href="https://gitee.com/harmonyos_samples/BluetoothLowEnergy" target="_blank">低功耗蓝牙开发</a></li></ul> </div> </div> <div></div></div>