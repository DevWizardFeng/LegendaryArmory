<h1 _ngcontent-uor-c119="" class="doc-title ng-star-inserted" title="使用ASan检测内存错误"> 使用ASan检测内存错误 </h1>

<div _ngcontent-uor-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>ASan的能力概述和检测原理可参看<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-sanitizer-overview">地址越界检测能力概述</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-sanitizer-principle#section159561141247">ASan检测原理</a>，适用于开发态调试压测场景。</p> <div class="tiledSection"><h2 id="section19754948133417">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section19754948133417" tips="复制节点链接"></i></h2></div> <ul><li>如果应用内的任一模块使能ASan，那么entry模块需同时使能ASan。如果entry模块未使能ASan，该应用在启动时将闪退，出现CPP Crash报错。</li><li>ASan和其他内存检测工具能力互斥，不能同时开启，TSan、UBSan、HWASan、GWP-ASan五个只能开启其中一个。</li></ul> <div class="tiledSection"><h2 id="section1496994494018">配置参数<i class="anchor-icon anchor-icon-link" anchorid="section1496994494018" tips="复制节点链接"></i></h2><p>ASAN_OPTIONS：在运行时配置ASan的行为，包括设置检测级别、输出格式、内存错误报告的详细程度等。常用参数请查看表1。</p> <p>ASAN_OPTIONS支持在app.json5中配置，也支持在Run/Debug Configurations中配置。app.json5的优先级较高，即两种方式都配置后，以app.json5中的配置为准。</p> </div> <div class="tiledSection"><h3 id="section1938075053915" class="firsth2">在app.json5中配置环境变量<i class="anchor-icon anchor-icon-link" anchorid="section1938075053915" tips="复制节点链接"></i></h3></div> <p>打开AppScope &gt; app.json5文件，添加配置示例如下。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"app"</span>: {</li><li>    <span class="hljs-string">"appEnvironments"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ASAN_OPTIONS"</span>,</li><li>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"log_exe_name=true abort_on_error=0 print_cmdline=true"</span> <span class="hljs-comment">// 示例仅供参考，具体以实际为准</span></li><li>      },</li><li>    ],</li><li>    ...</li><li>  }</li><li>}</li></ol></pre></div></div> <p>配置ASan参数时，建议带上以下各项，并设置成默认值，然后按需进行修改。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ini" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">allow_user_segv_handler</span>=<span class="hljs-number">1</span></li><li><span class="hljs-attr">detect_odr_violation</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">alloc_dealloc_mismatch</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">allocator_may_return_null</span>=<span class="hljs-number">1</span></li><li><span class="hljs-attr">detect_container_overflow</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">abort_on_error</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">halt_on_error</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">report_globals</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">handle_abort</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">allow_user_poisoning</span>=<span class="hljs-number">1</span></li><li><span class="hljs-attr">log_exe_name</span>=<span class="hljs-literal">true</span></li><li><span class="hljs-attr">handle_segv</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">detect_stack_use_after_return</span>=<span class="hljs-number">0</span></li><li><span class="hljs-attr">print_module_map</span>=<span class="hljs-number">2</span></li><li><span class="hljs-attr">handle_sigbus</span>=<span class="hljs-number">0</span></li></ol></pre></div></div> <div class="tiledSection"><h3 id="section676564717413">在Run/Debug Configurations中配置环境变量<i class="anchor-icon anchor-icon-link" anchorid="section676564717413" tips="复制节点链接"></i></h3></div> <p>具体请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-run-debug-configurations#section9413113717532" target="_blank">配置环境变量</a>。</p> <p>表1 常用参数</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.13.1.5.1.1" valign="top" width="25%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.1.5.1.2" valign="top" width="22.400000000000002%"><p>默认值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.1.5.1.3" valign="top" width="14.59%"><p>是否必填</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.1.5.1.4" valign="top" width="38.01%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>log_exe_name</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>true</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>不可修改。指定内存错误日志中是否包含执行文件的名称。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>log_path</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>/dev/hwasan/hwasan.log</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>ROM版本小于NEXT.0.0.68时必填，值不可修改；NEXT.0.0.68及以上版本不再需要该参数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>abort_on_error</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>指定在打印错误报告后调用abort()或_exit()。</p> <ul><li>false(0)：打印错误报告后使用_exit()结束进程。</li><li>true(1)：打印错误报告后使用abort()结束进程，同时会生成cppcrash日志。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>strip_path_prefix</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>内存错误日志的文件路径中去除所配置的前缀。</p> <p>如：/data/storage/el1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>detect_stack_use_after_return</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>指定是否检查访问指向已被释放的栈空间。</p> <ul><li>false(0)：不检查。</li></ul> <ul><li>true(1)：检查。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>halt_on_error</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>检测内存错误后是否继续运行。</p> <ul><li>0表示继续运行。</li><li>1表示结束运行。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>malloc_context_size</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>内存错误发生时，显示的调用栈层数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>suppressions</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>""</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>屏蔽文件名。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>handle_segv</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>检查段错误。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>handle_sigill</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>检查SIGILL信号。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>quarantine_size_mb</p> </td> <td class="cellrowborder" valign="top" width="22.400000000000002%"><p>256</p> </td> <td class="cellrowborder" valign="top" width="14.59%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="38.01%"><p>指定检测访问指向已被释放的栈空间错误的隔离区大小。</p> </td> </tr>  </tbody></table></div> </div> <p>更多可配置参数请参见<a href="https://gitee.com/openharmony/third_party_llvm-project/blob/master/compiler-rt/lib/asan/asan_flags.inc" target="_blank">asan_flags</a>。</p> <div class="tiledSection"><h2 id="section17956115264213">ASan使能<i class="anchor-icon anchor-icon-link" anchorid="section17956115264213" tips="复制节点链接"></i></h2><p>可通过以下两种方式使能ASan。每种方式分为DevEco Studio场景和流水线场景。</p> </div> <div class="tiledSection"><h3 id="section176141949438" class="firsth2">方式一 调试窗口快速使能<i class="anchor-icon anchor-icon-link" anchorid="section176141949438" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> </div> <ol><li>在运行调试窗口，点击<strong>Diagnostics</strong>，勾选<strong>Address Sanitizer</strong>。<p><span><img originheight="72" originwidth="379" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163504.69359673006478421141687606353631:50001231000000:2800:079B1317FFA957B1741F1D0885F6D186F928AA89451FA5B1FC8B11DD8F06246D.png" width="379" height="72"></span></p> </li><li>如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_ASAN=ON”，表示以ASan模式编译so文件。<p><span><img originheight="553" originwidth="774" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163504.44523859981900966429702229746637:50001231000000:2800:6BC81D0EFC915C9FFB490758B9D25B8DE02746E42769E7FFC5238B8EB9BF3926.png" width="774" height="553"></span></p> </li></ol> <p><strong>流水线场景</strong></p> <p>在hvigorw命令后加上<strong>ohos-debug-asan=true</strong>的选项，执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a></p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>hvigorw [taskNames...] ohos-<span class="hljs-built_in">debug</span>-asan=<span class="hljs-literal">true</span>  &lt;options&gt; </li></ol></pre></div></div> <p>同上，如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_ASAN=ON”，表示以ASan模式编译so文件。</p> <div class="tiledSection"><h3 id="section1690171816435">方式二 配置文件方式使能<i class="anchor-icon anchor-icon-link" anchorid="section1690171816435" tips="复制节点链接"></i></h3></div> <p><strong>DevEco Studio场景</strong></p> <ol><li>修改工程目录下AppScope/app.json5，添加ASan配置开关<div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-attr">"asanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p><span><img originheight="467" originwidth="1160" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.40158160334339009638597665066933:50001231000000:2800:6E84007956043B70E7A92FE16E37B701382120A02231435FF75439446EC58C9A.png" width="920" height="370.3793103448276"></span></p> </li><li>设置模块级构建ASan插桩。<p>在需要使能ASan的模块中，通过添加构建参数开启ASan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数：</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_ASAN=ON"</span></li></ol></pre></div></div> <p><span><img originheight="553" originwidth="774" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.54384548598592130909457933965313:50001231000000:2800:C86FAFD0CA1F8C76AFDD0AA0A6F822433D1C56F5189D38FC3B5C563A26157470.png" width="774" height="553"></span></p> </li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>该参数未配置不会报错，但是除包含malloc和free函数等少数内存错误外，出现其他需要插桩检测的内存错误时，ASan无法检测到错误。</p> </div></div></div> <p><strong>流水线场景</strong></p> <p>在AppScope/app.json5和模块build-profile.json5配置对应asan项后，可直接执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a></p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>hvigorw [taskNames...] ohos-<span class="hljs-built_in">debug</span>-asan=<span class="hljs-literal">true</span>  &lt;options&gt;</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>当通过Diagnostics勾选启用ASan后，即便app.json5中asanEnabled设为false仍会生效。</p> </div></div></div> <div class="tiledSection"><h2 id="section1474714118213">ASan插桩验证<i class="anchor-icon anchor-icon-link" anchorid="section1474714118213" tips="复制节点链接"></i></h2></div> <p>当应用依赖未经过ASan插桩的第三方或第四方库时，ASAN无法检测这些库中可能存在的越界错误。因此，对于应用所引用的第三方或第四方动态库，必须单独进行ASan插桩适配处理，以确保内存错误能够被完整捕获。 动态库插桩状态检查方法，可使用llvm-readelf工具检查目标动态库是否已完成ASan插桩，当前默认以动态库去链接，查询是否插桩成功命令如下：</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>llvm-readelf -d libthird_party.so | <span class="hljs-keyword">grep</span> <span class="hljs-string">'libclang_rt.asan.so'</span> </li></ol></pre></div></div> <p>若是静态链接，可使用如下命令查询：</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>llvm-readelf -s libthird_party.so | <span class="hljs-keyword">grep</span> <span class="hljs-string">'__asan_init'</span> </li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>llvm-readelf工具路径为：${DevEco Studio安装目录}/sdk/default/openharmony/native/llvm/bin或者${command-line-tools安装目录}/sdk/default/openharmony/native/llvm/bin/llvm-readelf。</p> </div></div></div> <div class="tiledSection"><h2 id="section3364162918443">运行ASan<i class="anchor-icon anchor-icon-link" anchorid="section3364162918443" tips="复制节点链接"></i></h2></div> <ol><li>运行或调试当前应用。</li><li>当程序出现内存错误时，弹出ASan log信息，点击信息中的链接即可跳转至引起内存错误的代码处（非release版本）。release版本本地无工程代码，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-release-app-stack-analysis" target="_blank">AnalyzeStackTrace功能</a>，提供要解析堆栈的so，解析结果为源码地址。<p><span><img originheight="558" originwidth="1308" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.75295503053604194072940383256522:50001231000000:2800:6EF34CDCAFF044C34D875B008FAB3AA7B017B7C778FABB941813CEA9171ED193.png" width="920" height="392.4770642201835"></span></p> </li></ol> <div class="tiledSection"><h2 id="section12508111110451">ASan异常检测类型<i class="anchor-icon anchor-icon-link" anchorid="section12508111110451" tips="复制节点链接"></i></h2></div> <p>当前提供案例在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#debug版本应用" target="_blank">debug版本应用</a>中可产生ASan，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#release版本应用" target="_blank">release版本应用</a>因为在编译构建期间会进行代码优化，不一定会产生异常。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>对于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#release版本应用" target="_blank">release版本应用</a>，本地无工程代码，可以使用AnalyzeStackTrace功能，提供要解析堆栈的so，解析结果为源码地址。</p> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.41.1.4.1.1" valign="top" width="33.333333333333336%"><p>常见ASan检测异常码</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.41.1.4.1.2" valign="top" width="33.333333333333336%"><p>说明</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.41.1.4.1.3" valign="top" width="33.333333333333336%"><p>可能的Crash信号</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>heap-buffer-overflow</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>超出堆上分配的缓冲区范围。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）、SIGILL（非法指令）、SIGFPE（浮点异常）、SIGTRAP（陷阱）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>stack-buffer-overflow/underflow</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>超出栈上分配的缓冲区范围。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）、SIGILL（非法指令）、SIGFPE（浮点异常）、SIGTRAP（陷阱）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>heap-use-after-free</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>使用了释放后的堆内存。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>stack-use-after-scope</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>栈变量在作用域外被使用。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>attempt-free-nonallocated-memory</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>尝试释放了非堆对象（non-heap object）或未分配内存。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.333333333333336%"><p>double-free</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>重复释放内存。</p> </td> <td class="cellrowborder" valign="top" width="33.333333333333336%"><p>SIGSEGV（段错误）、SIGABRT（异常终止）。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section15252126164510" class="firsth2">heap-buffer-overflow<i class="anchor-icon anchor-icon-link" anchorid="section15252126164510" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>访问堆内存越界（上下界）</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L58-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">HeapBufferOverflow</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* buffer;</li><li>    buffer = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);</li><li>    *(buffer + <span class="hljs-number">101</span>) = <span class="hljs-string">'n'</span>;</li><li>    *(buffer + <span class="hljs-number">102</span>) = <span class="hljs-string">'n'</span>;</li><li>    <span class="hljs-built_in">free</span>(buffer);</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-keyword">return</span> buffer[<span class="hljs-number">1</span>];</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L58-L67" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：AddressSanitizer: heap-buffer-overflow</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">heap</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">17140</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">heap</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x0060019ca8da</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005ec33c3250</span> <span class="hljs-title class_">bp</span> <span class="hljs-number">0x007fe9c392f0</span> <span class="hljs-title class_">sp</span> <span class="hljs-number">0x007fe9c392e8</span></li><li><span class="hljs-variable">WRITE</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x0060019ca8da</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ec33c324c</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x324c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">f31be36da7e9bc00c9b7bad563e7ccfec4d0347</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ec33c38e0</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x38e0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">f31be36da7e9bc00c9b7bad563e7ccfec4d0347</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f850b3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li><span class="hljs-number">0x0060019ca8da</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-number">0</span> <span class="hljs-variable">bytes</span> <span class="hljs-variable">to</span> <span class="hljs-variable">the</span> <span class="hljs-variable">right</span> <span class="hljs-variable">of</span> <span class="hljs-number">10</span>-<span class="hljs-variable">byte</span> <span class="hljs-variable">region</span> [<span class="hljs-number">0x0060019ca8d0</span>,<span class="hljs-number">0x0060019ca8da</span>)</li><li><span class="hljs-variable">allocated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f82652758</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xd2758</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ec33c31ec</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x31ec</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">f31be36da7e9bc00c9b7bad563e7ccfec4d0347</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ec33c38e0</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x38e0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">f31be36da7e9bc00c9b7bad563e7ccfec4d0347</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7f850b3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ec6a1bcd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x1dccd8</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ec6847f4c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x8f4c</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>注意数组的长度，不要访问越界</p> <p><strong>推荐建议</strong></p> <p>已知大小的数组注意访问不要越界，访问已知大小数组前先判断访问位置是否落在边界外</p> <div class="tiledSection"><h3 id="section1842052044614">stack-buffer-overflow<i class="anchor-icon anchor-icon-link" anchorid="section1842052044614" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>访问越栈内存上界</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L88-L94" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">StackBufferOverflow</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> subscript = <span class="hljs-number">43</span>;</li><li>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">42</span>];</li><li>    buffer[subscript] = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L88-L94" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：AddressSanitizer: stack-buffer-overflow</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">stack</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span></li><li>=================================================================</li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">8518</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">stack</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x7ffdbb8a1deb</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x7f4d58ec95a6</span> <span class="hljs-title class_">bp</span> <span class="hljs-number">0x7ffdbb8a1d90</span> <span class="hljs-title class_">sp</span> <span class="hljs-number">0x7ffdbb8a1d88</span></li><li><span class="hljs-variable">WRITE</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x7ffdbb8a1deb</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">e</span>.<span class="hljs-variable">mycppasandemo</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f4d58ec95a5</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">x86_64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x95a5</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">f94771f88ac6f3ed4c63d5c52598c94dc7bca66</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f4d58eca203</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">x86_64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xa203</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">f94771f88ac6f3ed4c63d5c52598c94dc7bca66</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f4dc9c0378f</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x4378f</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">88</span><span class="hljs-title class_">b8b49edb64385b2d6b854950877489</span>)</li><li>
</li><li><span class="hljs-variable">Address</span> <span class="hljs-number">0x7ffdbb8a1deb</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stack</span> <span class="hljs-variable">of</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">e</span>.<span class="hljs-variable">mycppasandemo</span>) <span class="hljs-variable">at</span> <span class="hljs-variable">offset</span> <span class="hljs-number">75</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">frame</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f4d58ec948f</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">x86_64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x948f</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">f94771f88ac6f3ed4c63d5c52598c94dc7bca66</span>)</li></ol></pre></div></div> <p><strong>优化建议</strong></p> <p>访问索引不应大于上界。</p> <div class="tiledSection"><h3 id="section1576381584711">stack-buffer-underflow<i class="anchor-icon anchor-icon-link" anchorid="section1576381584711" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>访问越栈内存下界</p> <div class="p"><strong>代码实例</strong><div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L103-L109" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">StackBufferUnderflow</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> subscript = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">42</span>];</li><li>    buffer[subscript] = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L103-L109" target="_blank">address_problems.cpp</a></div></div></div></div> </div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：AddressSanitizer: stack-buffer-underflow</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">stack</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">underflow</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">17039</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">stack</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">underflow</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x007e07c6027f</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x007f1bdc3994</span> <span class="hljs-title class_">bp</span> <span class="hljs-number">0x007e07c60250</span> <span class="hljs-title class_">sp</span> <span class="hljs-number">0x007e07c60248</span></li><li><span class="hljs-variable">WRITE</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007e07c6027f</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1bdc3990</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3990</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e34349d8024d23ca83c7c7c3b9f69505d2beb3a0</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1bdc3fa8</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3fa8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e34349d8024d23ca83c7c7c3b9f69505d2beb3a0</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e838339a8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x339a8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">f48b24ee6f099a2107ef30b4ace050de</span>)</li><li><span class="hljs-variable">Address</span> <span class="hljs-number">0x007e07c6027f</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stack</span> <span class="hljs-variable">of</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">at</span> <span class="hljs-variable">offset</span> <span class="hljs-number">31</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">frame</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1bdc3820</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3820</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e34349d8024d23ca83c7c7c3b9f69505d2beb3a0</span>)</li></ol></pre></div></div> <p><strong>优化建议</strong></p> <p>访问索引不应小于下界。</p> <div class="tiledSection"><h3 id="section8426131011487">heap-use-after-free<i class="anchor-icon anchor-icon-link" anchorid="section8426131011487" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>当指针指向的内存被释放后，仍然通过该指针访问已经被释放的内存，就会触发heap-use-after-free。</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L23-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">int</span> <span class="hljs-title function_ invoke__">HeapUseAfterFree</span>()</li><li>{</li><li>    <span class="hljs-keyword">int</span> *<span class="hljs-keyword">array</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">100</span>];</li><li>    delete[] <span class="hljs-keyword">array</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>[<span class="hljs-number">5</span>];</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L23-L28" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，显示reason为AddressSanitizer: heap-use-after-free</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">heap</span>-<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">free</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">10126</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">heap</span>-<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">free</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x006121870ce4</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005ee1ec321c</span> <span class="hljs-title class_">bp</span> <span class="hljs-number">0x007ff5959310</span> <span class="hljs-title class_">sp</span> <span class="hljs-number">0x007ff5959308</span></li><li><span class="hljs-variable">READ</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">4</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x006121870ce4</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ee1ec3218</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3218</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ee1ec3714</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3714</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7fa9133780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li><span class="hljs-number">0x006121870ce4</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-number">0</span> <span class="hljs-variable">bytes</span> <span class="hljs-variable">to</span> <span class="hljs-variable">the</span> <span class="hljs-variable">right</span> <span class="hljs-variable">of</span> <span class="hljs-number">20</span>-<span class="hljs-variable">byte</span> <span class="hljs-variable">region</span> [<span class="hljs-number">0x006121870cd0</span>,<span class="hljs-number">0x006121870ce4</span>)</li><li><span class="hljs-variable">freed</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7fa569f0c4</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xdf0c4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ee1ec31b8</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x31b8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ee1ec3714</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3714</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7fa9133780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ee571bcd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x1dccd8</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ee5547f4c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x8f4c</span>)</li><li><span class="hljs-variable">previously</span> <span class="hljs-variable">allocated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7fa569e888</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xde888</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ee1ec3194</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3194</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ee1ec3714</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3714</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">3</span><span class="hljs-title class_">b906822a911c973ab89188662a589eeedf639a4</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7fa9133780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ee571bcd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x1dccd8</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ee5547f4c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x8f4c</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>已经释放的指针不要再使用，将指针设置为NULL/nullptr。</p> <p><strong>推荐建议</strong></p> <p>使用智能指针，或实现一个free()函数的替代版本或者delete析构器来保证指针的重置。</p> <div class="tiledSection"><h3 id="section1636920545486">stack-use-after-scope<i class="anchor-icon anchor-icon-link" anchorid="section1636920545486" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>栈变量在作用域之外被使用。</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L118-L127" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> *gp;</li><li><span class="hljs-type">bool</span> b = <span class="hljs-literal">true</span>;</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">StackUseAfterScope</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (b) {</li><li>        <span class="hljs-type">int</span> x[<span class="hljs-number">5</span>];</li><li>        gp = x + <span class="hljs-number">1</span>;</li><li>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, gp);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> *gp;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L118-L127" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：AddressSanitizer: stack-use-after-scope</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">stack</span>-<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">scope</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">7494</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">stack</span>-<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">scope</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x007ffa213b44</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005ebf0431e4</span> <span class="hljs-title class_">bp</span> <span class="hljs-number">0x007ffa213b10</span> <span class="hljs-title class_">sp</span> <span class="hljs-number">0x007ffa213b08</span></li><li><span class="hljs-variable">READ</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">4</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007ffa213b44</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ebf0431e0</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x31e0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf28a04a79da128bc344416e8d5f860e3e22f495</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ebf0437f4</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x37f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf28a04a79da128bc344416e8d5f860e3e22f495</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f868b3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li><span class="hljs-variable">Address</span> <span class="hljs-number">0x007ffa213b44</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stack</span> <span class="hljs-variable">of</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">at</span> <span class="hljs-variable">offset</span> <span class="hljs-number">36</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">frame</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ebf043024</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3024</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf28a04a79da128bc344416e8d5f860e3e22f495</span>)</li></ol></pre></div></div> <p><strong>优化建议</strong></p> <p>在作用域内使用该变量。</p> <div class="tiledSection"><h3 id="section1710994764912">attempt-free-nonallocated-memory<i class="anchor-icon anchor-icon-link" anchorid="section1710994764912" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>尝试释放了非堆对象（non-heap object）或未分配内存。</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L136-L141" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AttempFreeNonAllocatedMem</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> value = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, &amp;value);</li><li>    <span class="hljs-built_in">free</span>(&amp;value);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L136-L141" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：</p> <p>AddressSanitizer: attempting free on address which was not malloc()-ed</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">bad</span>-<span class="hljs-title class_">free</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">20382</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">attempting</span> <span class="hljs-title class_">free</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-title class_">which</span> <span class="hljs-title class_">was</span> <span class="hljs-title class_">not</span> <span class="hljs-title class_">malloc</span>()-<span class="hljs-title class_">ed</span>: <span class="hljs-number">0x007fd59ae8c0</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">thread</span> <span class="hljs-title class_">T0</span> (<span class="hljs-title class_">easandemo_api12</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f83a92630</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xd2630</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ec45c3120</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3120</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">743109</span><span class="hljs-title class_">db136e66f875a7bc47db74a8095758d4ff</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ec45c3720</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3720</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">743109</span><span class="hljs-title class_">db136e66f875a7bc47db74a8095758d4ff</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7f8a2f3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li><span class="hljs-variable">Address</span> <span class="hljs-number">0x007fd59ae8c0</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stack</span> <span class="hljs-variable">of</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">at</span> <span class="hljs-variable">offset</span> <span class="hljs-number">32</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">frame</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ec45c2fbc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2fbc</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">743109</span><span class="hljs-title class_">db136e66f875a7bc47db74a8095758d4ff</span>)</li></ol></pre></div></div> <p><strong>优化建议</strong></p> <p>不要对非堆对象或未分配的内存使用free()函数。</p> <div class="tiledSection"><h3 id="section118640111510">double-free<i class="anchor-icon anchor-icon-link" anchorid="section118640111510" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>重复释放内存</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L150-L156" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">DoubleFree</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> *x = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">42</span>];</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, &amp;x);</li><li>    <span class="hljs-keyword">delete</span> [] x;</li><li>    <span class="hljs-keyword">delete</span> [] x;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L150-L156" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启ASan检测后，触发demo中的函数，应用闪退报ASan，包含字段：AddressSanitizer: attempting double-free</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-uor-c106="" class="highlight-div"><div _ngcontent-uor-c106="" class="highlight-div-header"><div _ngcontent-uor-c106="" class="highlight-div-header-left"><div _ngcontent-uor-c106="" class="handle-button expand-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-uor-c106="" class="highlight-div-header-right"><div _ngcontent-uor-c106="" class="handle-button ai-button"></div><div _ngcontent-uor-c106="" class="handle-button line-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-uor-c106="" class="handle-button theme-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-uor-c106="" class="handle-button copy-button"><div _ngcontent-uor-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-uor-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">double</span>-<span class="hljs-title class_">free</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">9596</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">AddressSanitizer</span>: <span class="hljs-title class_">attempting</span> <span class="hljs-title class_">double</span>-<span class="hljs-title class_">free</span> <span class="hljs-title class_">on</span> <span class="hljs-number">0x0061303ecc10</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">thread</span> <span class="hljs-title class_">T0</span> (<span class="hljs-title class_">easandemo_api12</span>):</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7fb3292630</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xd2630</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ef0b82ef4</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2ef4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ef0b834bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x34bc</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7fb4af3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li><span class="hljs-number">0x0061303ecc10</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-number">0</span> <span class="hljs-variable">bytes</span> <span class="hljs-variable">inside</span> <span class="hljs-variable">of</span> <span class="hljs-number">32</span>-<span class="hljs-variable">byte</span> <span class="hljs-variable">region</span> [<span class="hljs-number">0x0061303ecc10</span>,<span class="hljs-number">0x0061303ecc30</span>)</li><li><span class="hljs-variable">freed</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7fb3292630</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xd2630</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ef0b82eec</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2eec</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ef0b834bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x34bc</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7fb4af3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ef459bcd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x1dccd8</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ef43c7f4c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x8f4c</span>)</li><li><span class="hljs-variable">previously</span> <span class="hljs-variable">allocated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> (<span class="hljs-variable">easandemo_api12</span>) <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7fb3292758</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xd2758</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">aeec20776cc4e8f96db6c6b5603bb49748cc20ff</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ef0b82ee0</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2ee0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ef0b834bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x34bc</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">5</span><span class="hljs-title class_">b44777ffb29e6665852feeb6f23712aef424077</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7fb4af3780</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x33780</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">25</span><span class="hljs-title class_">f88248f530c20439061db9eb4ed152</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ef459bcd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x1dccd8</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ef43c7f4c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x8f4c</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>已经释放一次的指针，不要再重复释放。</p> <p><strong>推荐建议</strong></p> <p>变量定义声明时初始化为NULL，释放内存后也应立即将变量重置为NULL，这样每次释放之前都可以通过判断变量是否为NULL来判断是否可以释放。</p> <div class="tiledSection"><h3 id="section17774655134410">Other-categories<i class="anchor-icon anchor-icon-link" anchorid="section17774655134410" tips="复制节点链接"></i></h3><p>未知的错误类型，持续更新中。</p> </div> <div class="tiledSection"><h2 id="section1410515365213">日志规格和日志获取方式<i class="anchor-icon anchor-icon-link" anchorid="section1410515365213" tips="复制节点链接"></i></h2><p>请参看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/address-sanitizer-guidelines#日志获取方式" target="_blank">日志获取方式</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/address-sanitizer-guidelines#asan日志规格" target="_blank">ASan日志规格</a>。</p> </div> </div> <div></div></div>