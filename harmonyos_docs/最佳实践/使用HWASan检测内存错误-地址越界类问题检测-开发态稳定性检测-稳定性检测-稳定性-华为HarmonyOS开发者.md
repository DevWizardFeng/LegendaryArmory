<h1 _ngcontent-hun-c119="" class="doc-title ng-star-inserted" title="使用HWASan检测内存错误"> 使用HWASan检测内存错误 </h1>

<div _ngcontent-hun-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>HWASan的能力概述和检测原理可参看<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-sanitizer-overview">地址越界检测能力概述</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-sanitizer-principle#section187526511146">HWASan检测原理</a>，适用于开发态调试压测场景。</p> <div class="tiledSection"><h2 id="section3348134285315">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section3348134285315" tips="复制节点链接"></i></h2></div> <ul><li>ROM版本5.0.0.107及以上支持。</li><li>ASan、TSan、HWASan、UBSan不能同时开启，四个只能开启其中一个。</li></ul> <div class="tiledSection"><h2 id="section1496994494018">配置参数<i class="anchor-icon anchor-icon-link" anchorid="section1496994494018" tips="复制节点链接"></i></h2><p>HWASAN_OPTIONS：在运行时配置HWASan的行为，包括设置检测级别、输出格式、内存错误报告的详细程度等。常用参数请查看<a href="/consumer/cn/doc/best-practices/bpta-stability-hwasan-detection#table152415255816">表1</a>。</p> <p>HWASAN_OPTIONS支持在“app.json5”中配置，也支持在“Run/Debug Configurations”中配置。“app.json5”的优先级较高，即两种方式都配置后，以“app.json5”中的配置为准。</p> </div> <div class="tiledSection"><h3 id="section1210316341315" class="firsth2">在app.json5中配置环境变量<i class="anchor-icon anchor-icon-link" anchorid="section1210316341315" tips="复制节点链接"></i></h3><p>打开AppScope &gt; app.json5文件，添加配置示例如下。</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"app"</span>: {</li><li>    <span class="hljs-string">"appEnvironments"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"HWASAN_OPTIONS"</span>,</li><li>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"abort_on_error=0 heap_history_size_main_thread=102300"</span> <span class="hljs-comment">// 示例仅供参考，具体以实际为准</span></li><li>      },</li><li>    ],</li><li>    ...</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section758814119122">在Run/Debug Configurations中配置环境变量<i class="anchor-icon anchor-icon-link" anchorid="section758814119122" tips="复制节点链接"></i></h3></div> <p>具体请查看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-run-debug-configurations#section9413113717532" target="_blank">配置环境变量</a>。常用参数如下表所示。</p>  <div class="tablenoborder"><a name="ZH-CN_TOPIC_0000002523026773__table152415255816"></a><a name="table152415255816"></a><div class="tbBox"><table id="table152415255816" class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.1.5.1.1" valign="top" width="21.14%"><p>参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.5.1.2" valign="top" width="14.549999999999999%"><p>默认值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.5.1.3" valign="top" width="13.309999999999999%"><p>是否必填</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.1.5.1.4" valign="top" width="51%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="21.14%"><p>log_exe_name</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>true</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>不可修改。指定内存错误日志中是否包含执行文件的名称。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>abort_on_error</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>是</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>指定在打印错误报告后调用abort()或_exit()。</p> <ul><li>false(0)：打印错误后使用exit()结束进程。</li><li>true(1)：打印错误后使用abort()结束进程，同时会生成cppcrash日志。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>strip_path_prefix</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>内存错误日志的文件路径中去除所配置的前缀。</p> <p>如：/data/storage/el1。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>halt_on_error</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>检测内存错误后是否继续运行。</p> <ul><li>0表示继续运行。</li><li>1表示结束运行。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>malloc_context_size</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>-</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>内存错误发生时，显示的调用栈层数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_history_size</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>1023</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>指定各个线程用于保存其堆内存释放记录的RingBuffer容量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_history_size_main_thread</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>102300</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>指定主线程用于保存其堆内存释放记录的RingBuffer容量。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>print_uaf_stacks_with_same_tag</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>1</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>当检测到UAF查找已释放堆内存时，是否打印所有可能的同Tag堆内存。</p> <ul><li>false(0)：打印所有地址有关联的内存分配/释放信息。</li><li>true(1)：仅打印相同Tag的内存分配/释放信息。</li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>freed_threads_history_size</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>100</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>当线程结束后，仍保存其堆内存释放记录。freed_threads_history_size为保留的释放线程数。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_record_min</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>仅记录大于等于heap_record_min的堆内存分配，该值为0时不作判断。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_record_max</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>仅记录小于等于heap_record_max的堆内存分配，该值为0时不作判断。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_thread_max_count</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>128</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>配置每个线程隔离区容量，在HWASAN不完全开启时，用以检测未使能HWASAN组件的UAF行为。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_min</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>仅大于等于heap_quarantine_min的堆内存会进入隔离区，该值必须设置，否则该功能不使能。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_max</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>仅小于等于heap_quarantine_max的堆内存会进入隔离区，该值为0时不作判断。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>memory_around_register_size</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>128</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>当HWASAN检测到内存问题时，如果寄存器中的值指向有效内存，则打印该内存地址周围±memory_around_register_size的内容。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_thread_max_count</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>128</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>MemDebug指定隔离区容量，即free后保存在隔离区中内存块的最大个数，当超过该容量时，最先进入隔离区的内存块会离开隔离区并在检查填充值后返还给分配器。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_min</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>0</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>MemDebug释放后允许放入隔离区中内存块大小的最小值（包含），小于该值内存块不会进入隔离区。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>heap_quarantine_max</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>1025</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>MemDebug释放后允许放入隔离区中内存块大小的最大值（不含），大于等于该值的内存块不会进入隔离区。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.14%"><p>enable_heap_quarantine_debug</p> </td> <td class="cellrowborder" valign="top" width="14.549999999999999%"><p>false</p> </td> <td class="cellrowborder" valign="top" width="13.309999999999999%"><p>否</p> </td> <td class="cellrowborder" valign="top" width="51%"><p>MemDebug开启后可以打印内存块在隔离区中的停留时间，以帮助调整隔离区大小。</p> </td> </tr>  </tbody></table></div> </div> <p>更多可配置参数请参见<a href="https://gitee.com/openharmony/third_party_llvm-project/blob/master/compiler-rt/lib/hwasan/hwasan_flags.inc" target="_blank">hwasan_flags</a>。</p> <div class="tiledSection"><h2 id="section10791454125320">配置HWASan<i class="anchor-icon anchor-icon-link" anchorid="section10791454125320" tips="复制节点链接"></i></h2><p>可通过方式一和方式二整体使能HWASan，每种方式分为DevEco Studio场景和流水线场景，还可通过方式三对单个so库使能HWASan。</p> </div> <div class="tiledSection"><h3 id="section178025596536" class="firsth2">方式一 调试窗口快速使能<i class="anchor-icon anchor-icon-link" anchorid="section178025596536" tips="复制节点链接"></i></h3><p><strong>DevEco Studio</strong><strong>场景</strong></p> </div> <p>点击<strong>Run &gt; Edit Configurations &gt;</strong><strong>Diagnostics</strong>，勾选<strong>Hardware-Assisted Address Sanitizer</strong>开启检测。</p> <p><span><img originheight="258" originwidth="693" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.62007993379311495087238656798961:50001231000000:2800:A528C478CFE1B1EB540ABF225984810945599F3C838015A9D2C2E79F3EC4F81C.png" width="693" height="258"></span></p> <p><strong>流水线场景</strong></p> <ol><li>修改工程目录下的AppScope/app.json5文件，添加HWASan配置开关。<div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"hwasanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p><span><img originheight="203" originwidth="989" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.98252575649326883955001137239154:50001231000000:2800:FF6AF5F6765A2E2BF11283CB89B70A60F00725476EB1E79691179108FFB6DB3D.png" width="920" height="188.8372093023256"></span></p> </li><li>在hvigorw命令后加上<strong>-p </strong><strong>ohos-enable-hwasan=true</strong>的选项，执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a>。<div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">hvigorw</span> [<span class="hljs-variable">taskNames</span>...] -<span class="hljs-variable">p</span> <span class="hljs-variable">ohos</span>-<span class="hljs-variable">enable</span>-<span class="hljs-variable">hwasan</span>=<span class="hljs-title class_">true</span>  &lt;<span class="hljs-title class_">options</span>&gt; </li></ol></pre></div></div> </li></ol> <div class="tiledSection"><h3 id="section1971313945414">方式二 配置文件方式使能<i class="anchor-icon anchor-icon-link" anchorid="section1971313945414" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> </div> <ol><li>修改工程目录下的AppScope/app.json5文件，添加HWASan配置开关。<div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"hwasanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p><span><img originheight="203" originwidth="989" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.54275253241484943363775238962012:50001231000000:2800:9C1B79A07E6C27ABCDB30CDD0778B3E9304B838522A0A550035CC84954BCED1D.png" width="920" height="188.8372093023256"></span></p> </li><li>在需要使能HWASan的模块中，通过添加构建参数开启HWASan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数。<div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_HWASAN=ON"</span></li></ol></pre></div></div> <p><span><img originheight="175" originwidth="443" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.17516338004747882615370713299053:50001231000000:2800:878F3B0BBC0230143D8CDF9EAE4992432BAB810FAF3D6DA14DCAB5A5ABC525C6.png" width="443" height="175"></span></p> </li></ol> <p><strong>流水线场景</strong></p> <p>在AppScope/app.json5和模块build-profile.json5配置对应HWASan项后，可直接执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a>。</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">hvigorw</span> [<span class="hljs-variable">taskNames</span>...] -<span class="hljs-variable">p</span> <span class="hljs-variable">ohos</span>-<span class="hljs-variable">enable</span>-<span class="hljs-variable">hwasan</span>=<span class="hljs-title class_">true</span>  &lt;<span class="hljs-title class_">options</span>&gt; </li></ol></pre></div></div> <div class="tiledSection"><h3 id="section753019383418">方式三 针对单个动态库使能<i class="anchor-icon anchor-icon-link" anchorid="section753019383418" tips="复制节点链接"></i></h3></div> <p><strong>CMAKE编译</strong></p> <p>如果要对单个so文件进行插桩编译，可在其对应的CMakeLists.txt中添加以下编译选项：</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">set</span>(CMAKE_CXX_FLAGS <span class="hljs-string">"<span class="hljs-variable">$CMAKE_CXX_FLAGS</span> -shared-libasan -fsanitize=hwaddress -mllvm -hwasan-globals=0 -fno-emulated-tls -fno-omit-frame-pointer"</span>)</li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ol><li>如果按方式一DevEco Studio场景勾选Hardware-Assisted Address Sanitizer以后，配置app.json5中的hwasanEnabled为false，HWASan仍生效。</li><li>如需同步开启MemDebug，可选择方式一或方式二使能。<p>方式一：在app.json5中增加如下参数：memory_debug=1 heap_quarantine_max=1025 enable_heap_quarantine_debug=1。</p> <p>方式二：进入控制台执行hdc shell param set wrap.bundleName asan_wrapper命令，其中bundleName为需要使能检测能力的应用完整包名。若要关闭MemDebug检测能力，可通过在控制台执行hdc shell param set wrap.bundleName命令。通过以上命令开启或关闭MemDebug，均需要重新启动应用生效。本方式不支持自定义HWASAN_OPTIONS中的参数。</p> </li></ol> </div></div></div> <div class="tiledSection"><h2 id="section14309184913372">插桩验证<i class="anchor-icon anchor-icon-link" anchorid="section14309184913372" tips="复制节点链接"></i></h2><p>当应用依赖未经过HWASan插桩的第三方或第四方库时，HWASan无法检测这些库中可能存在的越界错误。因此，对于应用所引用的第三方或第四方动态库，必须单独进行HWASan插桩适配处理，以确保内存错误能够被完整捕获。 动态库插桩状态检查方法，可使用llvm-readelf工具检查目标动态库是否已完成HWASan插桩，当前默认以动态库去链接，查询是否插桩成功命令如下：</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>llvm-readelf -d libthird_party.so | <span class="hljs-keyword">grep</span> <span class="hljs-string">'libclang_rt.hwasan.so'</span> </li></ol></pre></div></div> <p>若是静态链接，可使用如下命令查询：</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>llvm-readelf -s libthird_party.so | <span class="hljs-keyword">grep</span> <span class="hljs-string">'__hwasan_init'</span> </li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section1974973016542">运行HWASan<i class="anchor-icon anchor-icon-link" anchorid="section1974973016542" tips="复制节点链接"></i></h2></div> <ol><li>运行或调试当前应用。</li><li>当程序出现内存错误时，弹出HWASan log信息，点击信息中的链接即可跳转至引起内存错误的代码处。<p><span><img originheight="635" originwidth="1337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163505.50698906464219508780253578120515:50001231000000:2800:936921FE18E3BB93268C7D489EF2C2FD1BF1AA7788454897D65F0A41037232BE.png" width="920" height="436.94839192221394"></span></p> </li></ol> <div class="tiledSection"><h2 id="section207321025115510">HWASan异常检测类型<i class="anchor-icon anchor-icon-link" anchorid="section207321025115510" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section99973519555" class="firsth2">stack tag-mismatch<i class="anchor-icon anchor-icon-link" anchorid="section99973519555" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>“stack tag-mismatch”在HWASan中指的是栈内存标签不匹配错误。这种错误通常发生在访问栈内存时，指针携带的标签与栈内存中存储的标签不一致，触发其异常检测码字的异常类型有：stack-buffer-overflow/underflow、stack-use-after-return。</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L165-L199" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// stack-buffer-overflow</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">stackBufferOverflowEx</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> subscript = <span class="hljs-number">43</span>;</li><li>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">42</span>];</li><li>    buffer[subscript] = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">// stack-buffer-underflow</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">stackBufferUnderflowEX</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> subscript = <span class="hljs-number">-1</span>;</li><li>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">42</span>];</li><li>    buffer[subscript] = <span class="hljs-number">42</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-comment">// stack-use-after-return</span></li><li><span class="hljs-type">int</span> *ptrEx;</li><li>__attribute__((noinline))</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FunctionThatEscapesLocalObjectEx</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> local[<span class="hljs-number">100</span>];</li><li>    ptrEx = &amp;local[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, local);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Run</span><span class="hljs-params">(<span class="hljs-type">int</span> argc)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">FunctionThatEscapesLocalObjectEx</span>();</li><li>    <span class="hljs-keyword">return</span> ptrEx[argc];</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L165-L199" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启HWASan检测后，触发demo中的函数，应用闪退报HWASAN，包含字段：</p> <p>HWAddressSanitizer: tag-mismatch on address</p> <p>Cause: stack tag-mismatch</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启HWASan检测，debug模式运行后复现该错误，可以触发HWASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">stack</span> <span class="hljs-title class_">tag</span>-<span class="hljs-title class_">mismatch</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">61390</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">HWAddressSanitizer</span>: <span class="hljs-title class_">tag</span>-<span class="hljs-title class_">mismatch</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x007eb11cc05f</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005acf446438</span></li><li><span class="hljs-variable">WRITE</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007eb11cc05f</span> <span class="hljs-variable">tags</span>: <span class="hljs-title class_">f1</span>/<span class="hljs-number">00</span> (<span class="hljs-variable">ptr</span>/<span class="hljs-variable">mem</span>) <span class="hljs-keyword">in</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5acf446438</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6438</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">b0b8d2189a7eb99fff81c6bc8889dfefd4af4a1</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5acf446c08</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6c08</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">b0b8d2189a7eb99fff81c6bc8889dfefd4af4a1</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ab397cdc8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li><li>
</li><li><span class="hljs-variable">Cause</span>: <span class="hljs-title class_">stack</span> <span class="hljs-title class_">tag</span>-<span class="hljs-title class_">mismatch</span></li><li><span class="hljs-variable">Address</span> <span class="hljs-number">0x007eb11cc05f</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">stack</span> <span class="hljs-variable">of</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span></li><li><span class="hljs-variable">Thread</span>: <span class="hljs-title class_">T0</span> <span class="hljs-number">0x005b00002000</span> <span class="hljs-title class_">stack</span>: [<span class="hljs-number">0x007eb09d2000</span>,<span class="hljs-number">0x007eb11d1000</span>) <span class="hljs-variable">sz</span>: <span class="hljs-number">8384512</span> <span class="hljs-title class_">tls</span>: [<span class="hljs-number">0x005aacd0fa98</span>,<span class="hljs-number">0x005aacd10279</span>)</li><li><span class="hljs-variable">Previously</span> <span class="hljs-variable">allocated</span> <span class="hljs-variable">frames</span>:</li><li>  <span class="hljs-variable">record_addr</span>:<span class="hljs-number">0x5ab053c788</span> <span class="hljs-title class_">record</span>:<span class="hljs-number">0xcc0a005acf4463c0</span>  (<span class="hljs-variable">/data</span><span class="hljs-variable">/storage</span><span class="hljs-variable">/el1</span><span class="hljs-variable">/bundle</span><span class="hljs-variable">/libs</span><span class="hljs-variable">/arm64</span><span class="hljs-variable">/libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x63c0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">b0b8d2189a7eb99fff81c6bc8889dfefd4af4a1</span>)</li><li>  <span class="hljs-variable">record_addr</span>:<span class="hljs-number">0x5ab053c780</span> <span class="hljs-title class_">record</span>:<span class="hljs-number">0xcc1a005acf446a68</span>  (<span class="hljs-variable">/data</span><span class="hljs-variable">/storage</span><span class="hljs-variable">/el1</span><span class="hljs-variable">/bundle</span><span class="hljs-variable">/libs</span><span class="hljs-variable">/arm64</span><span class="hljs-variable">/libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6a68</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">b0b8d2189a7eb99fff81c6bc8889dfefd4af4a1</span>)</li><li>  <span class="hljs-variable">record_addr</span>:<span class="hljs-number">0x5ab053c778</span> <span class="hljs-title class_">record</span>:<span class="hljs-number">0xcb81005acf4866ac</span>  (<span class="hljs-variable">/data</span><span class="hljs-variable">/storage</span><span class="hljs-variable">/el1</span><span class="hljs-variable">/bundle</span><span class="hljs-variable">/libs</span><span class="hljs-variable">/arm64</span><span class="hljs-variable">/libmainpage</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x66ac</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">10</span><span class="hljs-title class_">ffa0d04cbc27e12a59f658b5932674185d63ee</span>)</li><li>  <span class="hljs-variable">record_addr</span>:<span class="hljs-number">0x5ab053c770</span> <span class="hljs-title class_">record</span>:<span class="hljs-number">0xcc87005acf4465b4</span>  (<span class="hljs-variable">/data</span><span class="hljs-variable">/storage</span><span class="hljs-variable">/el1</span><span class="hljs-variable">/bundle</span><span class="hljs-variable">/libs</span><span class="hljs-variable">/arm64</span><span class="hljs-variable">/libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x65b4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">b0b8d2189a7eb99fff81c6bc8889dfefd4af4a1</span>)</li></ol></pre></div></div> <p><strong>优化建议</strong></p> <p>stack-buffer-overflow/underflow：访问索引要落在给定的范围内</p> <p>stack-use-after-return：在作用域内使用局部变量，如果需要在函数返回后继续使用某些数据，考虑将它们存储在静态或全局变量中</p> <div class="tiledSection"><h3 id="section18753111385716">heap-buffer-overflow<i class="anchor-icon anchor-icon-link" anchorid="section18753111385716" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>访问堆内存越界（上下界），触发其异常检测码字的异常类型有：heap-buffer-overflow、heap-buffer-underflow</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L208-L228" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// heap-buffer-overflow</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">HeapBufferOverflowEx</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> *buffer;</li><li>    buffer = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);</li><li>    *(buffer + <span class="hljs-number">11</span>) = <span class="hljs-string">'n'</span>;</li><li>    *(buffer + <span class="hljs-number">12</span>) = <span class="hljs-string">'n'</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-built_in">free</span>(buffer);</li><li>}</li><li>
</li><li><span class="hljs-comment">// heap-buffer-underflow</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">HeapBufferUnderflowEx</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> *buffer;</li><li>    buffer = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);</li><li>    *(buffer - <span class="hljs-number">11</span>) = <span class="hljs-string">'n'</span>;</li><li>    *(buffer - <span class="hljs-number">12</span>) = <span class="hljs-string">'n'</span>;</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, buffer);</li><li>    <span class="hljs-built_in">free</span>(buffer);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L208-L228" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启HWASan检测后，触发demo中的函数，应用闪退报HWASan，包含字段：</p> <p>HWAddressSanitizer: tag-mismatch</p> <p>Cause: heap-buffer-overflow</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启HWASan检测，debug模式运行后复现该错误，可以触发HWASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">heap</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">8344</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">HWAddressSanitizer</span>: <span class="hljs-title class_">tag</span>-<span class="hljs-title class_">mismatch</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x000100760332</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005adb286570</span></li><li><span class="hljs-variable">WRITE</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x000100760332</span> <span class="hljs-variable">tags</span>: <span class="hljs-title class_">cb</span>/<span class="hljs-number">08</span>(<span class="hljs-number">44</span>) (<span class="hljs-variable">ptr</span>/<span class="hljs-variable">mem</span>) <span class="hljs-keyword">in</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5adb286570</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6570</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4724</span><span class="hljs-title class_">eac5a66f4994a03c023a9958da3897de5f16</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5adb286c8c</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6c8c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4724</span><span class="hljs-title class_">eac5a66f4994a03c023a9958da3897de5f16</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5abd63cdc8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li><li>
</li><li>[<span class="hljs-number">0x000100760320</span>,<span class="hljs-number">0x000100760340</span>) <span class="hljs-keyword">is</span> <span class="hljs-variable">a</span> <span class="hljs-variable">small</span> <span class="hljs-variable">allocated</span> <span class="hljs-variable">heap</span> <span class="hljs-variable">chunk</span>; <span class="hljs-variable">size</span>: <span class="hljs-number">32</span> <span class="hljs-title class_">offset</span>: <span class="hljs-number">18</span></li><li>
</li><li><span class="hljs-variable">Cause</span>: <span class="hljs-title class_">heap</span>-<span class="hljs-title class_">buffer</span>-<span class="hljs-title class_">overflow</span></li><li><span class="hljs-number">0x000100760332</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-number">110</span> <span class="hljs-variable">bytes</span> <span class="hljs-variable">to</span> <span class="hljs-variable">the</span> <span class="hljs-variable">left</span> <span class="hljs-variable">of</span> <span class="hljs-number">10</span>-<span class="hljs-variable">byte</span> <span class="hljs-variable">region</span> [<span class="hljs-number">0x0001007603a0</span>,<span class="hljs-number">0x0001007603aa</span>)</li><li><span class="hljs-variable">allocated</span> <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5a394625ec</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">hwasan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x225ec</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">2</span><span class="hljs-title class_">b2455ae77181bfdfbfa9561b4e6e3ea376ec93b</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5adb286548</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6548</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4724</span><span class="hljs-title class_">eac5a66f4994a03c023a9958da3897de5f16</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5adb286c8c</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6c8c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4724</span><span class="hljs-title class_">eac5a66f4994a03c023a9958da3897de5f16</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5abd63cdc8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5ad4373b6c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x3f3b6c</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5ad3f8be8c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe8c</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>注意数组长度，不能越界</p> <p>heap-buffer-overflow：数组访问位置不要越上界</p> <p>heap-buffer-underflow：访问数组位置不要越下界</p> <p><strong>推荐建议</strong></p> <p>已知大小的数组注意访问不要越界，访问已知大小数组前先判断访问位置是否落在边界外</p> <div class="tiledSection"><h3 id="section02920712249">Use-after-free<i class="anchor-icon anchor-icon-link" anchorid="section02920712249" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>触发其异常检测码字的异常类型有：heap-use-after-free、double-free</p> <p>heap-use-after-free：当指针指向的内存被释放后，仍然通过该指针访问已经被释放的内存，就会触发heap-use-after-free</p> <p>double-free：重复释放内存</p> <p><strong>代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L237-L252" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// heap-use-after-free</span></li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">UseAfterFreeEx</span><span class="hljs-params">(<span class="hljs-type">int</span> argc)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">int</span> *array = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];</li><li>    <span class="hljs-keyword">delete</span>[] array;</li><li>    <span class="hljs-keyword">return</span> array[argc];</li><li>}</li><li>
</li><li><span class="hljs-comment">// double free</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DoubleFreeEx</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">32</span> * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>));</li><li>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"address: %p"</span>, p);</li><li>    <span class="hljs-built_in">free</span>(p);</li><li>    <span class="hljs-built_in">free</span>(p);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_problems.cpp#L237-L252" target="_blank">address_problems.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启HWASan检测后，触发demo中的函数，应用闪退报HWASan，包含字段：</p> <p>HWAddressSanitizer: tag-mismatch</p> <p>Cause: use-after-free</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启ASan检测，debug模式运行后复现该错误，可以触发ASan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-hun-c106="" class="highlight-div"><div _ngcontent-hun-c106="" class="highlight-div-header"><div _ngcontent-hun-c106="" class="highlight-div-header-left"><div _ngcontent-hun-c106="" class="handle-button expand-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hun-c106="" class="highlight-div-header-right"><div _ngcontent-hun-c106="" class="handle-button ai-button"></div><div _ngcontent-hun-c106="" class="handle-button line-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hun-c106="" class="handle-button theme-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hun-c106="" class="handle-button copy-button"><div _ngcontent-hun-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hun-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">free</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">10741</span>==<span class="hljs-variable">ERROR</span>: <span class="hljs-title class_">HWAddressSanitizer</span>: <span class="hljs-title class_">tag</span>-<span class="hljs-title class_">mismatch</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x000d00036a68</span> <span class="hljs-title class_">at</span> <span class="hljs-title class_">pc</span> <span class="hljs-number">0x005ab24864c4</span></li><li><span class="hljs-variable">READ</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">4</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x000d00036a68</span> <span class="hljs-variable">tags</span>: <span class="hljs-title class_">ae</span>/<span class="hljs-number">6</span><span class="hljs-variable">e</span> (<span class="hljs-variable">ptr</span>/<span class="hljs-variable">mem</span>) <span class="hljs-keyword">in</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ab24864c4</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x64c4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e073772c81ab52894a21e4190a263680198f3e9c</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ab2486c84</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6c84</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e073772c81ab52894a21e4190a263680198f3e9c</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5a96b7cdc8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li><li>
</li><li>[<span class="hljs-number">0x000d00036a60</span>,<span class="hljs-number">0x000d00036c00</span>) <span class="hljs-keyword">is</span> <span class="hljs-variable">a</span> <span class="hljs-variable">small</span> <span class="hljs-variable">unallocated</span> <span class="hljs-variable">heap</span> <span class="hljs-variable">chunk</span>; <span class="hljs-variable">size</span>: <span class="hljs-number">416</span> <span class="hljs-title class_">offset</span>: <span class="hljs-number">8</span></li><li>
</li><li><span class="hljs-variable">Cause</span>: <span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">free</span></li><li><span class="hljs-number">0x000d00036a68</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">located</span> <span class="hljs-number">8</span> <span class="hljs-variable">bytes</span> <span class="hljs-variable">inside</span> <span class="hljs-variable">of</span> <span class="hljs-number">400</span>-<span class="hljs-variable">byte</span> <span class="hljs-variable">region</span> [<span class="hljs-number">0x000d00036a60</span>,<span class="hljs-number">0x000d00036bf0</span>)</li><li><span class="hljs-variable">freed</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T0</span> <span class="hljs-variable">here</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5a90a6844c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">hwasan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2844c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">2</span><span class="hljs-title class_">b2455ae77181bfdfbfa9561b4e6e3ea376ec93b</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ab2486494</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6494</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e073772c81ab52894a21e4190a263680198f3e9c</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ab2486c84</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x6c84</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">e073772c81ab52894a21e4190a263680198f3e9c</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5a96b7cdc8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x5aab6b3b6c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x3f3b6c</span>)</li><li>    #<span class="hljs-number">5</span> <span class="hljs-number">0x5aab2cbe8c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe8c</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>heap-use-after-free：已经释放的指针不要再使用，将指针设置为NULL/nullptr。</p> <p>double-free：已经释放一次的指针，不要再重复释放。</p> <p><strong>推荐建议</strong></p> <p>heap-use-after-free：使用智能指针，或实现一个free()函数的替代版本或者delete析构器来保证指针的重置。</p> <p>double-free：变量定义声明时初始化为NULL，释放内存后也应立即将变量重置为NULL，这样每次释放之前都可以通过判断变量是否为NULL来判断是否可以释放。</p> <div class="tiledSection"><h2 id="section189951812113817">日志规格和日志获取方式<i class="anchor-icon anchor-icon-link" anchorid="section189951812113817" tips="复制节点链接"></i></h2><p>请参看<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/address-sanitizer-guidelines#日志获取方式" target="_blank">日志获取方式</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/address-sanitizer-guidelines#hwasan日志规格" target="_blank">HWASan日志规格</a>。</p> </div> </div> <div></div></div>