<h1 _ngcontent-glm-c119="" class="doc-title ng-star-inserted" title="使用TSan检测线程问题"> 使用TSan检测线程问题 </h1>

<div _ngcontent-glm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1839918281448">原理概述<i class="anchor-icon anchor-icon-link" anchorid="section1839918281448" tips="复制节点链接"></i></h2></div> <p>TSan（ThreadSanitizer）是一个检测数据竞争的工具。它包含一个编译器插桩模块和一个运行时库。TSan开启后，会使性能降低5到15倍，同时使内存占用率提高5到10倍。</p> <p>TSan使能分为两个阶段：Instrumentation阶段（完成代码插桩）和Runtime阶段（负责竞争判断和报告输出）。</p> <div class="tiledSection"><h2 id="section394014764516">功能介绍<i class="anchor-icon anchor-icon-link" anchorid="section394014764516" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1687212175453" class="firsth2">应用场景<i class="anchor-icon anchor-icon-link" anchorid="section1687212175453" tips="复制节点链接"></i></h3><p>TSan能够检测出如下问题：</p> <ul><li>数据竞争检测：数据竞争（Data Race）是指两个或多个线程在没有适当的同步机制情况下同时访问相同的内存位置，其中至少有一个线程在写入。数据竞争是导致多线程程序行为不可预测的主要原因之一。</li></ul> <ul><li>锁错误检测：TSan不仅能检测数据竞争，还能检测与锁相关的错误：<ul><li>死锁（Deadlock）：死锁是指两个或多个线程互相等待对方释放锁，导致程序无法继续执行。</li><li>双重解锁（Double Unlock）：同一线程尝试解锁已经解锁的锁。</li><li>未持有锁解锁：一个线程尝试解锁一个它未持有的锁。</li></ul> </li></ul> <ul><li>条件变量错误检测：条件变量用于线程之间的通信和同步，常见错误包括：<ul><li>未持有锁等待：一个线程在未持有相关锁的情况下调用wait。</li><li>未持有锁唤醒：一个线程在未持有相关锁的情况下调用signal或broadcast。</li></ul> </li></ul> </div> <p>常见TSan异常检测类型有data race，heap-use-after-free，signal handler spoils errno等，详见<a href="/consumer/cn/doc/best-practices/bpta-stability-tsan-detection#section1180812915516">TSan异常检测类型</a>部分。</p> <div class="tiledSection"><h2 id="section158955994516">错误报告<i class="anchor-icon anchor-icon-link" anchorid="section158955994516" tips="复制节点链接"></i></h2><p>当TSan检测到错误时，它会生成详细的报告，包括：</p> <ul><li>错误类型：例如数据竞争、死锁等。</li><li>内存地址：涉及的内存地址。</li><li>线程信息：涉及的线程ID和线程创建的堆栈跟踪。</li><li>源代码位置：每一个内存访问的源代码位置和堆栈跟踪。</li><li>上下文信息：访问类型（读/写）、访问大小等。</li></ul> </div> <div class="tiledSection"><h2 id="section3448163934614">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section3448163934614" tips="复制节点链接"></i></h2><ul><li>TSan仅支持API 12及以上版本。</li><li>ASan、TSan、UBSan、HWASan、GWP-ASan不能同时开启，五个只能开启其中一个。</li><li>TSan开启后会申请大量虚拟内存，其他申请大虚拟内存的功能（如GPU图形渲染）可能会受影响。</li><li>TSan不支持静态链接libc或libc++库。</li></ul> </div> <div class="tiledSection"><h2 id="section14181102916475">使能TSan<i class="anchor-icon anchor-icon-link" anchorid="section14181102916475" tips="复制节点链接"></i></h2><p>可通过以下两种方式使能TSan。每种方式分为DevEco Studio场景和流水线场景。</p> </div> <div class="tiledSection"><h3 id="section916864394711" class="firsth2">方式一<i class="anchor-icon anchor-icon-link" anchorid="section916864394711" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> <ol><li>点击<strong>Run &gt; Edit Configurations &gt;</strong> <strong>Diagnostics</strong>，勾选<strong>Thread Sanitizer</strong>。<p><span><img originheight="233" originwidth="690" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163502.01381947243509400352337219777023:50001231000000:2800:C4AEA07BF1C806881CDBDAF942A354C2171B56DDBBA76AE2E890BD0D4BAE9749.png" width="690" height="233"></span></p> </li><li>如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_TSAN=ON”，表示以TSan模式编译so文件。<p><span><img originheight="519" originwidth="935" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163502.70641761408281016042618463843210:50001231000000:2800:EE6A4ADAB78631431F48CE4B05944AD290593E24B4689607C02205840B1347CD.png" width="920" height="510.67379679144386"></span></p> </li></ol> <p><strong>流水线场景</strong></p> <p>在hvigorw命令后加上<strong>ohos-debug-tsan=true</strong>的选项，执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">命令行构建工具（hvigorw）</a>。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>hvigorw [taskNames...] ohos-<span class="hljs-built_in">debug</span>-tsan=<span class="hljs-literal">true</span>  &lt;options&gt; </li></ol></pre></div></div> <p>同上，如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_TSAN=ON”，表示以TSAN模式编译so文件。</p> </div> <div class="tiledSection"><h3 id="section1537354417498">方式二<i class="anchor-icon anchor-icon-link" anchorid="section1537354417498" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> <ol><li>修改工程目录下AppScope/app.json5，添加TSan配置开关。<div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"tsanEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></li></ol></pre></div></div> <p><span><img originheight="434" originwidth="1307" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163503.47663428057509159023175696863812:50001231000000:2800:CF606CD08438D9243D635B23C7F8EB55E1BA1C03ED05427BCFCC2EF25FE3792F.png" width="920" height="305.49349655700075"></span></p> </li><li>设置模块级构建TSan插桩。<p>在需要使能TSan的模块中，通过添加构建参数开启TSan检测插桩，在对应模块的模块级build-profile.json5中添加命令参数：</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_TSAN=ON"</span></li></ol></pre></div></div> <p><span><img originheight="448" originwidth="1290" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163503.21451399643865028539995726045776:50001231000000:2800:0EB132D14F5BF74C0DAEE5E1E49AB2E1798C0BCB38B2A44B274922DE50827191.png" width="920" height="319.50387596899225"></span></p> </li></ol> <p><strong>流水线场景</strong></p> <p>在hvigorw命令后加上<strong>ohos-debug-tsan=true</strong>的选项，执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">命令行构建工具（hvigorw）</a>。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>hvigorw [taskNames...] ohos-<span class="hljs-built_in">debug</span>-tsan=<span class="hljs-literal">true</span>  &lt;options&gt; </li></ol></pre></div></div> <p>同上，如果有引用本地library，需在library模块的build-profile.json5文件中，配置arguments字段值为“-DOHOS_ENABLE_TSAN=ON”，表示以TSAN模式编译so文件。</p> </div> <div class="tiledSection"><h2 id="section1180812915516">TSan异常检测类型<i class="anchor-icon anchor-icon-link" anchorid="section1180812915516" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section4408522155118" class="firsth2">Data race<i class="anchor-icon anchor-icon-link" anchorid="section4408522155118" tips="复制节点链接"></i></h3><p><strong>背景</strong></p> <p>多个线程在没有正确加锁的情况下，同时访问同一块数据，并且至少有一个线程是写操作，对数据的读取和修改产生了竞争，从而导致各种不可预计的问题</p> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L6-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> Global = <span class="hljs-number">12</span>;</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Set1</span><span class="hljs-params">()</span> </span>{</li><li>    *(<span class="hljs-type">char</span> *)&amp;Global = <span class="hljs-number">4</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Set2</span><span class="hljs-params">()</span> </span>{</li><li>    Global=<span class="hljs-number">43</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">Thread1</span><span class="hljs-params">(<span class="hljs-type">void</span> *x)</span></span>{</li><li>    <span class="hljs-built_in">Set1</span>();</li><li>    <span class="hljs-keyword">return</span> x;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>{</li><li>    ...</li><li>    <span class="hljs-type">pthread_t</span> t;</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;t, <span class="hljs-literal">NULL</span>, Thread1, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">Set2</span>();</li><li>    <span class="hljs-built_in">pthread_join</span>(t, <span class="hljs-literal">NULL</span>);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L6-L32" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> </div> <p><strong>影响</strong></p> <p>对数据的读取和修改产生了竞争，从而导致各种不可预计的问题</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: data race</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">54331</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">data</span> <span class="hljs-title class_">race</span> (<span class="hljs-title class_">pid</span>=<span class="hljs-number">54331</span>)</li><li>  <span class="hljs-variable">Write</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">1</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f1b9c4f84</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T32</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b9c22cc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x22c8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fe67e101795e12687f395b21194511c9d69851c2</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b9c2354</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2350</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fe67e101795e12687f395b21194511c9d69851c2</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>
</li><li>  <span class="hljs-variable">Previous</span> <span class="hljs-variable">write</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">4</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f1b9c4f84</span> <span class="hljs-variable">by</span> <span class="hljs-keyword">main</span> <span class="hljs-variable">thread</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b9c2310</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x230c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fe67e101795e12687f395b21194511c9d69851c2</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b9c25ac</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x25a8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fe67e101795e12687f395b21194511c9d69851c2</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e8df3cb8c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cb88</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">57</span><span class="hljs-title class_">a073cc8fa34c10cb354df9ed7e2e4b</span>)</li><li>
</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>加锁或者其它线程同步的方法</p> <p><strong>推荐建议</strong></p> <p>多线程访问同一内存时，需要注意线程同步机制，必要时加锁</p> <div class="tiledSection"><h3 id="section725190182515">data race on vptr<i class="anchor-icon anchor-icon-link" anchorid="section725190182515" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>一个线程在删除某个对象（obj）、一个线程在调用虚函数（obj-&gt;vcall）</p> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L36-L88" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li>
</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">A</span> {</li><li>  <span class="hljs-built_in">A</span>() {</li><li>    <span class="hljs-built_in">sem_init</span>(&amp;sem_, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>  }</li><li>  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">F</span><span class="hljs-params">()</span> </span>{</li><li>  }</li><li>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Done</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-built_in">sem_post</span>(&amp;sem_);</li><li>  }</li><li>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">A</span>() {</li><li>    <span class="hljs-built_in">sem_wait</span>(&amp;sem_);</li><li>    <span class="hljs-built_in">sem_destroy</span>(&amp;sem_);</li><li>  }</li><li>  <span class="hljs-type">sem_t</span> sem_;</li><li>};</li><li>
</li><li>
</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">B</span> : A {</li><li>  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">F</span><span class="hljs-params">()</span> </span>{</li><li>  }</li><li>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">B</span>() { }</li><li>};</li><li>
</li><li>
</li><li><span class="hljs-type">static</span> A *obj = <span class="hljs-keyword">new</span> B;</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">Thread1</span><span class="hljs-params">(<span class="hljs-type">void</span> *x)</span> </span>{</li><li>  obj-&gt;<span class="hljs-built_in">F</span>();</li><li>  obj-&gt;<span class="hljs-built_in">Done</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">Thread2</span><span class="hljs-params">(<span class="hljs-type">void</span> *x)</span> </span>{</li><li>  <span class="hljs-keyword">delete</span> obj;</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>{</li><li>    ...</li><li>    <span class="hljs-type">pthread_t</span> t[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;t[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>, Thread1, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;t[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, Thread2, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">pthread_join</span>(t[<span class="hljs-number">0</span>], <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">pthread_join</span>(t[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L36-L88" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>线程行为发生冲突，程序崩溃</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: data race on vptr（ctor/dtor vs virtual call）</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">26789</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">data</span> <span class="hljs-title class_">race</span> <span class="hljs-title class_">on</span> <span class="hljs-title class_">vptr</span> (<span class="hljs-variable">ctor</span><span class="hljs-variable">/dtor</span> <span class="hljs-title class_">vs</span> <span class="hljs-title class_">virtual</span> <span class="hljs-title class_">call</span>) (<span class="hljs-title class_">pid</span>=<span class="hljs-number">26789</span>)</li><li>  <span class="hljs-variable">Write</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">8</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f078bb140</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T31</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b943304</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3300</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b943258</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3254</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f1b943298</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3294</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7f1b943138</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3134</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>
</li><li>  <span class="hljs-variable">Previous</span> <span class="hljs-variable">read</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">8</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f078bb140</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T30</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b94301c</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3018</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>
</li><li>  <span class="hljs-variable">Location</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">heap</span> <span class="hljs-variable">block</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">40</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f078bb140</span> <span class="hljs-variable">allocated</span> <span class="hljs-variable">by</span> <span class="hljs-keyword">main</span> <span class="hljs-variable">thread</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7e012b68d4</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x768d0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b8b2438</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libc</span>++<span class="hljs-variable">_shared</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0xb2434</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cdf97be9396a35e8f4806f252f90a11320d26ec6</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f1b942f34</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2f30</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">313582257</span><span class="hljs-title class_">cb30f740bec5d3616a5588b41b7de89</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7e0009125c</span>  (/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>+<span class="hljs-number">0x91258</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ec44c498ff1525a6f5d1a1a23c105a8b</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x7e8bf786ac</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x386a8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">57</span><span class="hljs-title class_">a073cc8fa34c10cb354df9ed7e2e4b</span>)</li><li>
</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>设置合适的线程同步机制，如锁。</p> <p><strong>推荐建议</strong></p> <p>确保设置合适的线程同步机制，来保证线程执行逻辑先后的准确性。</p> <div class="tiledSection"><h3 id="section98631763564">Use After Free<i class="anchor-icon anchor-icon-link" anchorid="section98631763564" tips="复制节点链接"></i></h3></div> <p><strong>heap-use-after-free</strong></p> <p><strong>背景</strong></p> <p>使用了释放的内存（多线程层面）。</p> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L92-L125" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li>
</li><li>
</li><li><span class="hljs-type">int</span> *mem;</li><li><span class="hljs-type">pthread_mutex_t</span> mtx;</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">Thread1</span><span class="hljs-params">(<span class="hljs-type">void</span> *x)</span> </span>{</li><li>  <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;mtx);</li><li>  <span class="hljs-built_in">free</span>(mem);</li><li>  <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;mtx);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li>
</li><li>__attribute__((noinline)) <span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">Thread2</span><span class="hljs-params">(<span class="hljs-type">void</span> *x)</span> </span>{</li><li>  <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;mtx);</li><li>  mem[<span class="hljs-number">0</span>] = <span class="hljs-number">42</span>;</li><li>  <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;mtx);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>{</li><li>    ...</li><li>    mem = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);</li><li>    <span class="hljs-built_in">pthread_mutex_init</span>(&amp;mtx, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">pthread_t</span> t;</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;t, <span class="hljs-literal">NULL</span>, Thread1, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">Thread2</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">pthread_join</span>(t, <span class="hljs-literal">NULL</span>);</li><li>    <span class="hljs-built_in">pthread_mutex_destroy</span>(&amp;mtx);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L92-L125" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: heap-use-after-free</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">4830</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">heap</span>-<span class="hljs-title class_">use</span>-<span class="hljs-title class_">after</span>-<span class="hljs-title class_">free</span> (<span class="hljs-title class_">pid</span>=<span class="hljs-number">4830</span>)</li><li>  <span class="hljs-variable">Write</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">4</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f0764e420</span> <span class="hljs-variable">by</span> <span class="hljs-keyword">main</span> <span class="hljs-variable">thread</span> (<span class="hljs-variable">mutexes</span>: <span class="hljs-title class_">write</span> <span class="hljs-title class_">M0</span>):</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b8026bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x26b8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf997f64a72b3a470193dd0b38a782fc3aef5075</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b80297c</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2978</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf997f64a72b3a470193dd0b38a782fc3aef5075</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e8f77cb8c</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cb88</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">57</span><span class="hljs-title class_">a073cc8fa34c10cb354df9ed7e2e4b</span>)</li><li>
</li><li>  <span class="hljs-variable">Previous</span> <span class="hljs-variable">write</span> <span class="hljs-variable">of</span> <span class="hljs-variable">size</span> <span class="hljs-number">8</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x007f0764e420</span> <span class="hljs-variable">by</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">T31</span> (<span class="hljs-variable">mutexes</span>: <span class="hljs-title class_">write</span> <span class="hljs-title class_">M0</span>):</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7e012b6f94</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x76f90</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b802630</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x262c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cf997f64a72b3a470193dd0b38a782fc3aef5075</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>已释放的内存不要使用，释放的内存需要标记，方便其它线程判断</p> <p><strong>推荐建议</strong></p> <p>使用合理的线程同步机制</p> <div class="tiledSection"><h3 id="section14593143035718">Signal Check<i class="anchor-icon anchor-icon-link" anchorid="section14593143035718" tips="复制节点链接"></i></h3><p><strong>signal handler spoils errno</strong></p> <p><strong>背景</strong></p> <p>信号处理函数中修改了errno变量</p> </div> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L129-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">MyHandler</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">siginfo_t</span> *s, <span class="hljs-type">void</span> *c)</span> </span>{</li><li>  errno = <span class="hljs-number">1</span>;</li><li>  done = <span class="hljs-number">1</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">sendsignal</span><span class="hljs-params">(<span class="hljs-type">void</span> *p)</span> </span>{</li><li>  <span class="hljs-built_in">pthread_kill</span>(mainth, SIGPROF);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-type">static</span> __attribute__((noinline)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{</li><li>  <span class="hljs-keyword">while</span> (done == <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);</li><li>    p[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)p);</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>{</li><li>    ...</li><li>    mainth = <span class="hljs-built_in">pthread_self</span>();</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sigaction</span> act = {};</li><li>    act.sa_sigaction = &amp;MyHandler;</li><li>    <span class="hljs-built_in">sigaction</span>(SIGPROF, &amp;act, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-type">pthread_t</span> th;</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;th, <span class="hljs-number">0</span>, sendsignal, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">loop</span>();</li><li>    <span class="hljs-built_in">pthread_join</span>(th, <span class="hljs-number">0</span>);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L129-L169" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: signal handler spoils errno</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">42144</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">signal</span> <span class="hljs-title class_">handler</span> <span class="hljs-title class_">spoils</span> <span class="hljs-title class_">errno</span> (<span class="hljs-title class_">pid</span>=<span class="hljs-number">42144</span>)</li><li>  <span class="hljs-variable">Signal</span> <span class="hljs-number">27</span> <span class="hljs-variable">handler</span> <span class="hljs-variable">invoked</span> <span class="hljs-variable">at</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7f1b7c2730</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x272c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">6</span><span class="hljs-title class_">c5d69edd55e55ece087ccc4dadb8ffd2712681d</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b7c2868</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2864</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">6</span><span class="hljs-title class_">c5d69edd55e55ece087ccc4dadb8ffd2712681d</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7f1b7c26b4</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x26b0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">6</span><span class="hljs-title class_">c5d69edd55e55ece087ccc4dadb8ffd2712681d</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7e8f03cdcc</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>不要在信号处理函数中修改error变量</p> <p><strong>推荐建议</strong></p> <p>将MyHandler中的error赋值语句去掉</p> <div class="tiledSection"><h3 id="section119610361591">signal unsafe call inside of a signal<i class="anchor-icon anchor-icon-link" anchorid="section119610361591" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>信号处理函数中调用了非信号安全的函数（比如malloc）</p> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L173-L204" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span></li><li>
</li><li>
</li><li><span class="hljs-type">pthread_t</span> mainth;</li><li><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> done;</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">handler</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">siginfo_t</span>*, <span class="hljs-type">void</span>*)</span> </span>{</li><li>  <span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);</li><li>  p[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)p);</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    ...</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sigaction</span> act = {};</li><li>    act.sa_sigaction = &amp;handler;</li><li>    <span class="hljs-built_in">sigaction</span>(SIGPROF, &amp;act, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-built_in">kill</span>(<span class="hljs-built_in">getpid</span>(), SIGPROF);</li><li>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>); </li><li>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"DONE\n"</span>);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L173-L204" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: signal-unsafe call inside of a signal</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置<strong>。</strong></p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">54255</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">signal</span>-<span class="hljs-keyword">unsafe</span> <span class="hljs-title class_">call</span> <span class="hljs-title class_">inside</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">a</span> <span class="hljs-title class_">signal</span> (<span class="hljs-title class_">pid</span>=<span class="hljs-number">54255</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7e012b68d4</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x768d0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b9025fc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x25f8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">872</span><span class="hljs-title class_">d8f3822a374492bda4a455431bcc95f290ad1</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e012bfb34</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x7fb30</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x7f1b902530</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x252c</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">872</span><span class="hljs-title class_">d8f3822a374492bda4a455431bcc95f290ad1</span>)</li><li>    #<span class="hljs-number">4</span> <span class="hljs-number">0x7e8d47cdcc</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3cdc8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">dc293a22b36a4db17dc689ff9413b64e</span>)</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>将信号处理函数中的malloc去掉，在其外部预先分配内存。</p> <p><strong>推荐建议</strong></p> <p>建议信号处理程序之外预先分配内存，或者尽可能避免在信号处理程序中进行内存分配和复杂的操作。如果需要在程序中替换malloc，可以考虑使用__malloc_hook或者宏定义等方法</p> <div class="tiledSection"><h3 id="section191141806111">Mutex Check<i class="anchor-icon anchor-icon-link" anchorid="section191141806111" tips="复制节点链接"></i></h3></div> <p><strong>unlock of an unlocked mutex（or by a wrong thread）</strong></p> <p><strong>背景</strong></p> <p>解锁一个已经解锁/自己不拥有的锁</p> <p><strong>错误代码实例</strong></p> <div class="screenLinkPre"><div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L208-L228" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span></li><li>
</li><li>
</li><li><span class="hljs-type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">unlocker</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span> </span>{</li><li>    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;mutex);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span>{</li><li>    ...</li><li>    <span class="hljs-type">pthread_t</span> tid;</li><li>    <span class="hljs-built_in">pthread_create</span>(&amp;tid, <span class="hljs-literal">nullptr</span>, unlocker, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">pthread_join</span>(tid, <span class="hljs-literal">nullptr</span>);</li><li>    ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/bacbf85d70037d5aad5457a63ce3cb1e9bce283b/ThreadIssueDetection/entry/src/main/ets/cpp/UseTSANToDetectThreadingIssues.cpp#L208-L228" target="_blank">UseTSANToDetectThreadingIssues.cpp</a></div></div></div></div> <p><strong>影响</strong></p> <p>导致程序存在安全漏洞，并有崩溃风险。</p> <p>开启TSan检测后，触发demo中的函数，应用闪退报TSan，包含字段：ThreadSanitizer: unlock of an unlocked mutex（or by a wrong thread）</p> <div _ngcontent-glm-c106="" class="highlight-div"><div _ngcontent-glm-c106="" class="highlight-div-header"><div _ngcontent-glm-c106="" class="highlight-div-header-left"><div _ngcontent-glm-c106="" class="handle-button expand-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-glm-c106="" class="highlight-div-header-right"><div _ngcontent-glm-c106="" class="handle-button ai-button"></div><div _ngcontent-glm-c106="" class="handle-button line-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-glm-c106="" class="handle-button theme-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-glm-c106="" class="handle-button copy-button"><div _ngcontent-glm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-glm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">TSAN</span></li><li>==<span class="hljs-variable">appspawn</span>==<span class="hljs-number">30577</span>==<span class="hljs-variable">ThreadSanitizer</span>: <span class="hljs-title class_">WARNING</span>: <span class="hljs-title class_">unexpected</span> <span class="hljs-title class_">format</span> <span class="hljs-title class_">specifier</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">printf</span> <span class="hljs-title class_">interceptor</span>: %{ (<span class="hljs-variable">reported</span> <span class="hljs-variable">once</span> <span class="hljs-variable">per</span> <span class="hljs-variable">process</span>)</li><li>==================</li><li><span class="hljs-variable">WARNING</span>: <span class="hljs-title class_">ThreadSanitizer</span>: <span class="hljs-title class_">unlock</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">an</span> <span class="hljs-title class_">unlocked</span> <span class="hljs-title class_">mutex</span> (<span class="hljs-title class_">or</span> <span class="hljs-title class_">by</span> <span class="hljs-title class_">a</span> <span class="hljs-title class_">wrong</span> <span class="hljs-title class_">thread</span>) (<span class="hljs-title class_">pid</span>=<span class="hljs-number">30577</span>)</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7e012d4cd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x94cd4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b8421bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x21b8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4221</span><span class="hljs-title class_">fdd9cad8fe19e56e4a38ccf49ffc5c637855</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>
</li><li>  <span class="hljs-variable">Location</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">global</span> <span class="hljs-string">'&lt;null&gt;'</span> <span class="hljs-variable">at</span> <span class="hljs-number">0x000000000000</span> (<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x4db0</span>)</li><li>
</li><li>  <span class="hljs-variable">Mutex</span> <span class="hljs-variable">M0</span> (<span class="hljs-number">0x007f1b844db0</span>) <span class="hljs-variable">created</span> <span class="hljs-variable">at</span>:</li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x7e012d4cd8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x94cd4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x7f1b8421bc</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x21b8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4221</span><span class="hljs-title class_">fdd9cad8fe19e56e4a38ccf49ffc5c637855</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x7e012b84f8</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">tsan</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x784f4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ae7f86a9a081faf0a0a327001ad1c8b20bf33783</span>)</li></ol></pre></div></div> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启TSan检测，debug模式运行后复现该错误，可以触发TSan，直接点击堆栈中的超链接定位到代码行，能看到错误代码的位置。</p> <p><strong>修改方法</strong></p> <p>先使用try_lock()接口获取锁，再使用unlock()接口解锁</p> <p><strong>推荐建议</strong></p> <p>尽量不要释放自己线程未持有的锁</p> </div> <div></div></div>