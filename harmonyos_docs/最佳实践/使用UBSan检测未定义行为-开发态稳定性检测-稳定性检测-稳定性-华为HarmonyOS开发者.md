<h1 _ngcontent-rwp-c119="" class="doc-title ng-star-inserted" title="使用UBSan检测未定义行为"> 使用UBSan检测未定义行为 </h1>

<div _ngcontent-rwp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1217343519599">原理概述<i class="anchor-icon anchor-icon-link" anchorid="section1217343519599" tips="复制节点链接"></i></h2></div> <p>代码中出现未定义行为最初可能不会引发问题，但随着代码复杂度增加，未定义行为可能导致程序崩溃或错误，检测根源也会变得更加困难。UBSan（Undefined Behavior Sanitizer）可以检测代码中的未定义行为，帮助开发者清除由未定义行为引起的运行时错误。</p> <p>常见的未定义UBSan异常检测类型包括：存储到未对齐地址、访问未对齐地址的成员、不是类型“bool”的有效值、除以零等。具体类型详见<a href="/consumer/cn/doc/best-practices/bpta-stability-ubsan-detection#section124211321406">UBSan异常检测类型</a>。</p> <div class="tiledSection"><h2 id="section523464114598">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section523464114598" tips="复制节点链接"></i></h2></div> <p>ASan、TSan、UBSan 和 HWASan 不能同时开启，只能启用其中一个。</p> <div class="tiledSection"><h2 id="section16567949185912">UBSan使能<i class="anchor-icon anchor-icon-link" anchorid="section16567949185912" tips="复制节点链接"></i></h2><p>可以通过以下两种方式启用UBSan。每种方式都包括DevEco Studio场景和流水线场景。</p> </div> <div class="tiledSection"><h3 id="section91981359135911" class="firsth2">方式一<i class="anchor-icon anchor-icon-link" anchorid="section91981359135911" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> </div> <p>点击<strong>Run &gt; Edit Configurations &gt; Diagnostics</strong>，勾选<strong>UndefinedBehaviorSanitizer</strong>开启检测。</p> <p><span><img originheight="274" originwidth="680" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.19047299275632153201685622055298:50001231000000:2800:4D6435DC42EF03F2A2CE189379108FEB1492FF4102C782E8DCC4AA08E95892A5.png" width="680" height="274"></span></p> <p><strong>流水线场景</strong></p> <p>在hvigorw命令后加上<strong>ohos-enable-ubsan=true</strong>的选项，执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">hvigorw</span> [<span class="hljs-variable">taskNames</span>...] <span class="hljs-variable">ohos</span>-<span class="hljs-variable">enable</span>-<span class="hljs-variable">ubsan</span>=<span class="hljs-title class_">true</span>  &lt;<span class="hljs-title class_">options</span>&gt; </li></ol></pre></div></div> <div class="tiledSection"><h3 id="section17863711306">方式二<i class="anchor-icon anchor-icon-link" anchorid="section17863711306" tips="复制节点链接"></i></h3><p><strong>DevEco Studio场景</strong></p> </div> <p>在需要启用UBSan的模块中，通过添加构建参数来开启UBSan检测。在对应模块的build-profile.json5文件中添加命令参数：</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-DOHOS_ENABLE_UBSAN=ON"</span></li></ol></pre></div></div> <p><span><img originheight="199" originwidth="384" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.94905978978971835013869974875718:50001231000000:2800:592077E94E156C735A06F10C9DA71BDAC792F2658C3C96DE36430A39E4968B31.png" width="384" height="199"></span></p> <p><strong>流水线场景</strong></p> <p>在AppScope/app.json5和模块build-profile.json5配置对应UBSan项后，可直接执行hvigorw命令，更多options参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-commandline" target="_blank">hvigorw文档</a></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>hvigorw <span class="hljs-selector-attr">[taskNames...]</span>  &lt;options&gt; </li></ol></pre></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>方式一的勾选操作会覆盖app.json5中的配置项，因此即使设置为false，UBSan仍会生效。</p> </div></div></div> <div class="tiledSection"><h2 id="section124211321406">UBSan异常检测类型<i class="anchor-icon anchor-icon-link" anchorid="section124211321406" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17148335013" class="firsth2">store to misaligned address<i class="anchor-icon anchor-icon-link" anchorid="section17148335013" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>变量使用了不对齐的指针，或未对齐的引用地址。</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int8_t</span> *buffer = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int8_t</span>*&gt; (<span class="hljs-built_in">malloc</span>(<span class="hljs-number">64</span>));</li><li><span class="hljs-type">int32_t</span> *pointer = (<span class="hljs-type">int32_t</span> *)(buffer + <span class="hljs-number">1</span>);</li><li>*pointer = <span class="hljs-number">42</span>; </li></ol></pre></div></div> <p><strong>影响</strong></p> <p>程序存在安全漏洞，有崩溃风险。</p> <p>开启UBSan检测后，触发demo中的函数，faultlog报UBSAN，错误信息为：runtime error: store to misaligned address。</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启UBSAN检测，以debug模式运行并复现错误，可以触发UBSAN，点击堆栈中的超链接即可定位到错误代码的位置。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">8</span>:<span class="hljs-number">5</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-title class_">store</span> <span class="hljs-title class_">to</span> <span class="hljs-title class_">misaligned</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x005acba55c01</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">type</span> <span class="hljs-string">'int32_t'</span> (<span class="hljs-title class_">aka</span> '<span class="hljs-title class_">int</span>'), <span class="hljs-variable">which</span> <span class="hljs-variable">requires</span> <span class="hljs-number">4</span> <span class="hljs-variable">byte</span> <span class="hljs-variable">alignment</span></li><li><span class="hljs-number">0x005acba55c01</span>: <span class="hljs-title class_">note</span>: <span class="hljs-title class_">pointer</span> <span class="hljs-title class_">points</span> <span class="hljs-title class_">here</span></li><li> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">1</span><span class="hljs-variable">f</span> <span class="hljs-variable">dd</span> <span class="hljs-variable">b2</span> <span class="hljs-variable">e1</span> <span class="hljs-number">57</span> <span class="hljs-number">0</span><span class="hljs-variable">f</span> <span class="hljs-number">44</span> <span class="hljs-number">58</span>  <span class="hljs-number">08</span> <span class="hljs-number">6</span><span class="hljs-variable">e</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span><span class="hljs-variable">d</span> <span class="hljs-number">65</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-variable">a0</span> <span class="hljs-number">86</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span></li><li>              ^ </li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5bd3f020e8</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x20e8</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">cb738bedadc1fbdf663f3584c3546b3a16cf896d</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ab8a7d908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5acfc6ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5acf84be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">8</span>:<span class="hljs-number">5</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">25467</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li>    <span class="hljs-number">0x001a60000000</span>-<span class="hljs-number">0x001a90000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li><li>    <span class="hljs-number">0x002890000000</span>-<span class="hljs-number">0x002890080000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">Heap25467non</span> <span class="hljs-title class_">movable</span> <span class="hljs-title class_">space</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>确保指针指向的内存地址是正确对齐的。例如，如果一个类型应该4字节对齐，那么它的地址应该是4的倍数。</p> <p><strong>推荐建议</strong></p> <p>避免用地址加偏移量赋值，确保指针字节对齐。</p> <div class="tiledSection"><h3 id="section14798123516112">member access within misaligned address<i class="anchor-icon anchor-icon-link" anchorid="section14798123516112" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>成员（如struct）使用了不对齐的指针，或未对齐的引用地址。</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">A</span> {</li><li>    <span class="hljs-type">int32_t</span> i32;</li><li>    <span class="hljs-type">int64_t</span> i64;</li><li>};</li><li>
</li><li><span class="hljs-type">int8_t</span> *buffer = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int8_t</span>*&gt;(<span class="hljs-built_in">malloc</span>(<span class="hljs-number">32</span>));</li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">A</span> *pointer = (<span class="hljs-keyword">struct</span> A *)(buffer + <span class="hljs-number">1</span>);</li><li>pointer-&gt;i32 = <span class="hljs-number">7</span>;</li></ol></pre></div></div> <p><strong>影响</strong></p> <p>程序存在安全漏洞和崩溃风险。</p> <p>开启UBSan检测后，触发demo中的函数，faultlog报UBSAN，错误信息包含：runtime error: member access within misaligned address。</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启UBSAN检测，在debug模式下运行并复现该错误，可以触发UBSAN。点击堆栈中的超链接即可定位到代码行，查看错误代码的位置。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">14</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-title class_">member</span> <span class="hljs-title class_">access</span> <span class="hljs-title class_">within</span> <span class="hljs-title class_">misaligned</span> <span class="hljs-title class_">address</span> <span class="hljs-number">0x005be8bbb061</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">type</span> <span class="hljs-string">'struct A'</span>, <span class="hljs-variable">which</span> <span class="hljs-variable">requires</span> <span class="hljs-number">8</span> <span class="hljs-variable">byte</span> <span class="hljs-variable">alignment</span></li><li><span class="hljs-number">0x005be8bbb061</span>: <span class="hljs-title class_">note</span>: <span class="hljs-title class_">pointer</span> <span class="hljs-title class_">points</span> <span class="hljs-title class_">here</span></li><li> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">6</span><span class="hljs-variable">e</span> <span class="hljs-number">6</span><span class="hljs-variable">e</span> <span class="hljs-number">65</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span><span class="hljs-variable">f</span> <span class="hljs-number">6</span><span class="hljs-variable">e</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span></li><li>              ^ </li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5cf0b42128</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2128</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">d6de121f4d1e5fef552a5ff31b02d78637bd108f</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5bdc73d908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5bec62ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5bec20be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">14</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">34776</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li>    <span class="hljs-number">0x001d00000000</span>-<span class="hljs-number">0x001d30000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>确保指针指向的内存地址是正确对齐的。例如，如果一个类型应该4字节对齐，那么它的地址应该是4的倍数。</p> <p><strong>推荐建议</strong></p> <p>避免用地址加偏移量赋值，确保指针字节对齐。</p> <div class="tiledSection"><h3 id="section570214197317">not a valid value for type 'bool'<i class="anchor-icon anchor-icon-link" anchorid="section570214197317" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>使用既不是true也不是false的bool值。通常是由不恰当的类型转换导致的，例如将整数或指针用作bool值。</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span> res = <span class="hljs-number">2</span>;</li><li><span class="hljs-type">bool</span> *predicate = (<span class="hljs-type">bool</span> *)&amp;res;</li><li><span class="hljs-keyword">if</span> (*predicate) { <span class="hljs-comment">// Error: variable is not a valid Boolean</span></li><li>    res+=<span class="hljs-number">2</span>;</li><li>}</li></ol></pre></div></div> <p><strong>影响</strong></p> <p>程序存在安全漏洞和崩溃风险。</p> <p>开启UBSan检测后，触发demo中的函数，faultlog报告UBSAN错误。</p> <p><strong>定位思路</strong></p> <p>如果存在工程代码，直接开启UBSAN检测，在debug模式下运行并复现错误，可以触发UBSAN，点击堆栈中的超链接即可定位到错误代码行。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">9</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-title class_">load</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">value</span> <span class="hljs-number">2</span>, <span class="hljs-variable">which</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">a</span> <span class="hljs-variable">valid</span> <span class="hljs-variable">value</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">type</span> <span class="hljs-string">'bool'</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5bf7842114</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2114</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">bdc801021450256f3247301024c66ba35759bd8e</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5adb1bd908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5af332ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5af2f0be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">9</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">61094</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li><span class="hljs-number">0x001bb0000000</span>-<span class="hljs-number">0x001be0000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>使用恰当的类型转换</p> <p><strong>推荐建议</strong></p> <p>不要使用不恰当的类型转换</p> <div class="tiledSection"><h3 id="section11926182141">index xxx out of bounds for type xxx<i class="anchor-icon anchor-icon-link" anchorid="section11926182141" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>固定长度的数组越界</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">int</span> <span class="hljs-keyword">array</span>[<span class="hljs-number">5</span>];</li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">5</span>; ++i) {</li><li>    <span class="hljs-keyword">array</span>[i] += <span class="hljs-number">1</span>; <span class="hljs-comment">// Error: out-of-bounds access on the last iteration</span></li><li>}</li></ol></pre></div></div> <p><strong>影响</strong></p> <p>程序存在安全漏洞，有崩溃风险。</p> <p>开启UBSan检测后，触发demo中的函数应用闪退，faultlog报UBSAN。</p> <p><strong>定位思路</strong></p> <p>如果有工程代码，直接开启UBSAN检测并在debug模式下运行以复现错误，触发UBSAN后，直接点击堆栈中的超链接即可定位到错误代码的位置。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">9</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-title class_">index</span> <span class="hljs-number">5</span> <span class="hljs-title class_">out</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">bounds</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">type</span> <span class="hljs-string">'int[5]'</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5c2e6820f0</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x20f0</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">ee21ab192e41eb5f030d33e86321164eb1171fae</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5b1217d908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5b2a46ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5b2a04be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">14</span>:<span class="hljs-number">9</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">555</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li>    <span class="hljs-number">0x001c60000000</span>-<span class="hljs-number">0x001c90000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>确保访问数组的位置不超过固定数组的最大索引。</p> <p><strong>推荐建议</strong></p> <p>在访问数组前校验访问位置和数组长度。</p> <div class="tiledSection"><h3 id="section337141913417">xxx is outside the range of representable values of type 'int'<i class="anchor-icon anchor-icon-link" anchorid="section337141913417" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>浮点数转换引起的溢出</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">double</span> n = <span class="hljs-number">10e50</span>;</li><li><span class="hljs-type">int</span> m = (<span class="hljs-type">int</span>)n;</li></ol></pre></div></div> <p><strong>影响</strong></p> <p>程序存在安全漏洞，有崩溃风险。</p> <p>开启UBSan检测后，触发demo中的函数，faultlog报UBSAN。</p> <p><strong>定位思路</strong></p> <p>开启UBSan检测后，触发demo中的函数，faultlog报UBSAN，错误信息为：runtime error: 1e+51 超出 'int' 类型的表示范围。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">13</span>:<span class="hljs-number">18</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-number">1e+51</span> <span class="hljs-keyword">is</span> <span class="hljs-title class_">outside</span> <span class="hljs-title class_">the</span> <span class="hljs-title class_">range</span> <span class="hljs-title class_">of</span> <span class="hljs-title class_">representable</span> <span class="hljs-title class_">values</span> <span class="hljs-title class_">of</span> <span class="hljs-keyword">type</span> <span class="hljs-string">'int'</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5bd2602080</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">patch_3000001</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x2080</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">17</span><span class="hljs-title class_">cfd563ada1f6699d9c7369d90e109ffae4ee1b</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5ab6cbd908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5ace06ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5acdc4be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">13</span>:<span class="hljs-number">18</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">9054</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li>    <span class="hljs-number">0x001ab0000000</span>-<span class="hljs-number">0x001ae0000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>使用更大范围的数据类型</p> <p><strong>推荐建议</strong></p> <p>强转之前检查值，确保不会溢出</p> <div class="tiledSection"><h3 id="section853954611420">division by zero<i class="anchor-icon anchor-icon-link" anchorid="section853954611420" tips="复制节点链接"></i></h3></div> <p><strong>背景</strong></p> <p>/0操作</p> <p><strong>错误代码实例</strong></p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">int</span> <span class="hljs-built_in">sum</span> = <span class="hljs-number">10</span>;</li><li><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; ++i) {</li><li>    <span class="hljs-built_in">sum</span> /= i; </li><li>}</li></ol></pre></div></div> <p><strong>影响报错</strong></p> <p>程序存在安全漏洞，并有崩溃的风险。</p> <p>开启UBSan检测后，触发demo中的函数，faultlog报UBSAN，字段：runtime error: division by zero。</p> <p><strong>定位思路</strong></p> <p>如果工程包含代码，直接启用UBSAN检测，以Debug模式运行并复现错误。触发UBSAN后，点击堆栈中的超链接可直接定位到错误代码行，查看错误代码的具体位置。</p> <div _ngcontent-rwp-c106="" class="highlight-div"><div _ngcontent-rwp-c106="" class="highlight-div-header"><div _ngcontent-rwp-c106="" class="highlight-div-header-left"><div _ngcontent-rwp-c106="" class="handle-button expand-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rwp-c106="" class="highlight-div-header-right"><div _ngcontent-rwp-c106="" class="handle-button ai-button"></div><div _ngcontent-rwp-c106="" class="handle-button line-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rwp-c106="" class="handle-button theme-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rwp-c106="" class="handle-button copy-button"><div _ngcontent-rwp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rwp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">UBSAN</span></li><li><span class="hljs-variable">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">12</span>:<span class="hljs-number">14</span>: <span class="hljs-title class_">runtime</span> <span class="hljs-title class_">error</span>: <span class="hljs-title class_">division</span> <span class="hljs-title class_">by</span> <span class="hljs-title class_">zero</span></li><li>    #<span class="hljs-number">0</span> <span class="hljs-number">0x5ba7a01ff4</span>  (/<span class="hljs-variable">data</span>/<span class="hljs-variable">storage</span>/<span class="hljs-variable">el1</span>/<span class="hljs-variable">bundle</span>/<span class="hljs-variable">libs</span>/<span class="hljs-variable">arm64</span>/<span class="hljs-variable">libentry</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x1ff4</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-number">4</span><span class="hljs-title class_">d6b1a9e31b1ab325be3aabdd184a22476349eaf</span>)</li><li>    #<span class="hljs-number">1</span> <span class="hljs-number">0x5a8edbd908</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-variable">so</span>+<span class="hljs-number">0x3d908</span>) (<span class="hljs-variable">BuildId</span>: <span class="hljs-title class_">fbb88ca45aa4ffefe148b9838dfd0db7</span>)</li><li>    #<span class="hljs-number">2</span> <span class="hljs-number">0x5aa366ca98</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0x42ca98</span>)</li><li>    #<span class="hljs-number">3</span> <span class="hljs-number">0x5aa324be54</span>  (/<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">module</span>/<span class="hljs-variable">arkcompiler</span>/<span class="hljs-variable">stub</span>.<span class="hljs-variable">an</span>+<span class="hljs-number">0xbe54</span>)</li><li>
</li><li><span class="hljs-variable">SUMMARY</span>: <span class="hljs-title class_">UndefinedBehaviorSanitizer</span>: <span class="hljs-title class_">undefined</span>-<span class="hljs-title class_">behavior</span> <span class="hljs-title class_">E</span>:/<span class="hljs-variable">MyCppUbsan</span>/<span class="hljs-variable">entry</span>/<span class="hljs-variable">src</span>/<span class="hljs-keyword">main</span>/<span class="hljs-variable">cpp</span>/<span class="hljs-variable">napi_init</span>.<span class="hljs-variable">cpp</span>:<span class="hljs-number">12</span>:<span class="hljs-number">14</span> <span class="hljs-keyword">in</span> </li><li>==<span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">mycppubsan</span>==<span class="hljs-number">24346</span>==<span class="hljs-variable">Process</span> <span class="hljs-variable">memory</span> <span class="hljs-variable">map</span> <span class="hljs-variable">follows</span>:</li><li>    <span class="hljs-number">0x001170000000</span>-<span class="hljs-number">0x0011a0000000</span>    [<span class="hljs-variable">anon</span>:<span class="hljs-title class_">ArkTS</span> <span class="hljs-title class_">MemPoolCache</span>]</li></ol></pre></div></div> <p><strong>修改方法</strong></p> <p>确保除数不为0</p> <p><strong>推荐建议</strong></p> <p>增加对除数的非零判断</p> <p></p> </div> <div></div></div>