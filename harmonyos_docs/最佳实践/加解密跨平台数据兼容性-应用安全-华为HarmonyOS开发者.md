<h1 _ngcontent-lpm-c119="" class="doc-title ng-star-inserted" title="加解密跨平台数据兼容性"> 加解密跨平台数据兼容性 </h1>

<div _ngcontent-lpm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section4825854104613">概述<i class="anchor-icon anchor-icon-link" anchorid="section4825854104613" tips="复制节点链接"></i></h2><p>为确保数据安全，数据传输过程中需进行加解密操作。实现加密和解密操作在不同环境下的互操作性和跨平台数据的兼容性也极为关键。这一目标受以下两方面影响：</p> <ol><li>数据编码格式差异：不同平台可能使用不同的数据格式，导致跨平台传输和存储时出现不兼容。</li><li>加解密算法使用差异：不同平台支持相同的算法，但算法框架的使用方式会有所不同。</li></ol> </div> <p>本文从<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section1152116421582">数据编码格式差异</a>以及<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section61961942185518">加解密算法使用差异</a>两个方面来深入分析加解密失败的可能原因，并提供相应的解决方案，避免跨平台加解密失败，帮助开发者在HarmonyOS平台上高效、准确地完成加解密任务，实现跨平台数据兼容性。</p> <div class="tiledSection"><h2 id="section1560011463291">加解密开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1560011463291" tips="复制节点链接"></i></h2><p>加解密通常遵循以下流程：</p> <ol><li>选择加解密算法并确定密钥<ul><li>根据具体的安全需求，选择合适的加解密算法。可以是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-encrypt-decrypt-spec" target="_blank">对称密钥加解密算法</a>（例如AES）、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-encrypt-decrypt-spec" target="_blank">非对称密钥加解密算法</a>（例如RSA）等。</li><li>确定加解密所需密钥。对称密钥为随机生成的二进制数据，非对称密钥需生成公钥和私钥。</li></ul> </li><li>准备待加解密的数据<ul><li>明确需要加密的数据，如文本、文件或数据库记录。</li><li>对数据进行预处理，如格式化、编码转换，确保符合加密算法的输入要求。</li></ul> </li><li>初始化加解密引擎<p>根据所选加密算法，初始化加密引擎。设置加密模式（如CBC、ECB）和填充方式等参数，以满足特定安全需求。</p> </li><li>执行加解密操作<ul><li>将明文数据输入加密引擎。</li><li>加密引擎根据设定的算法和密钥对数据进行加密，通常逐块处理。对于大文件，可能需要分块加密。</li></ul> </li><li>输出结果<ul><li>加密后得到密文数据。</li><li>可以将密文存储在文件或数据库中，或通过网络传输给接收方。</li></ul> </li></ol> </div> <div class="tiledSection"><h2 id="section1152116421582">数据编码格式差异<i class="anchor-icon anchor-icon-link" anchorid="section1152116421582" tips="复制节点链接"></i></h2><p>加解密操作常跨平台进行，例如服务端加密的数据需在移动设备上解密。HarmonyOS平台的加解密API要求密钥和待处理数据为Uint8Array格式。因此，需将Uint8Array字节数据与其他编码格式数据互相转换，确保编码格式一致。</p> <p>以下列举三种数据格式之间的转换方法：</p> <ul><li>普通编码格式的字符串与Uint8Array类型的转换<p>建议采用UTF-8编码。UTF-8编码广泛支持大多数语言的字符，且在不同平台间具有良好的兼容性。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L248-L258" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Convert string to uint8Array.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">stringToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>): Uint8Array</span> {</li><li>  <span class="hljs-keyword">let</span> textEncoder = util.TextEncoder.create(<span class="hljs-string">'utf-8'</span>);</li><li>  <span class="hljs-keyword">return</span> textEncoder.encodeInto(str);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Convert uint8Array to string.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">uint8ArrayToString</span>(<span class="hljs-params">input: Uint8Array</span>): <span class="hljs-built_in">string</span></span> {</li><li>  <span class="hljs-keyword">let</span> textDecoder = util.TextDecoder.create(<span class="hljs-string">'utf-8'</span>);</li><li>  <span class="hljs-keyword">return</span> textDecoder.decodeToString(input);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L248-L258" target="_blank">DataConversion.ets</a></div></div></div></div> </li></ul> <ul><li>Base64编码格式字符串与Uint8Array类型的转换<p>在HarmonyOS侧接收数据后，先进行Base64解码，将字符串转换为Uint8Array类型的字节流，再进行解密操作。</p> <p>反之，如果需要将数据从HarmonyOS侧发送到服务端，需要先将数据加密后的字节流进行Base64编码，转换为字符串后再进行传输。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L261-L271" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Convert base64 to uint8Array.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">base64ToUint8Array</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>): Uint8Array</span> {</li><li>  <span class="hljs-keyword">let</span> base64Helper = <span class="hljs-keyword">new</span> util.Base64Helper();</li><li>  <span class="hljs-keyword">return</span> base64Helper.decodeSync(str);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Convert uint8Array to base64.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">uint8ArrayToBase64</span>(<span class="hljs-params">input: Uint8Array</span>): <span class="hljs-built_in">string</span></span> {</li><li>  <span class="hljs-keyword">let</span> base64Helper = <span class="hljs-keyword">new</span> util.Base64Helper();</li><li>  <span class="hljs-keyword">return</span> base64Helper.encodeToStringSync(input);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L261-L271" target="_blank">DataConversion.ets</a></div></div></div></div> </li></ul> <ul><li>16进制编码格式字符串与Uint8Array类型的转换<div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L274-L287" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Convert hex to uint8Array.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">hexStrToUint8Array</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>): Uint8Array</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Uint8Array(buffer.<span class="hljs-keyword">from</span>(data, <span class="hljs-string">'hex'</span>).buffer);</li><li>}</li><li>
</li><li><span class="hljs-comment">// Convert uint8Array to hex.</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">uint8ArrayToHexStr</span>(<span class="hljs-params">input: Uint8Array</span>): <span class="hljs-built_in">string</span></span> {</li><li>  <span class="hljs-keyword">let</span> hexString = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; input.length; i++) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-built_in">char</span> = (<span class="hljs-string">'00'</span> + input[i].toString(<span class="hljs-number">16</span>)).slice(<span class="hljs-number">-2</span>);</li><li>    hexString += <span class="hljs-built_in">char</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> hexString;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L274-L287" target="_blank">DataConversion.ets</a></div></div></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section61961942185518">加解密算法使用差异<i class="anchor-icon anchor-icon-link" anchorid="section61961942185518" tips="复制节点链接"></i></h2><p>不同平台支持相同的算法，但加解密算法在使用时可能存在差异，这些差异可能导致加解密无法跨平台正常工作。</p> <p>HarmonyOS平台与其它平台在加解密使用上存在差异。</p> <ol><li>HarmonyOS平台加解密API要求密钥和待处理的数据为Uint8Array格式，可参考<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section1152116421582">数据编码格式差异</a>实现数据格式的转换。</li><li>在HarmonyOS平台上，默认支持SM2算法。需要注意的是，HarmonyOS仅支持ASN.1格式的数据（如密钥和密文）。因此，SM2算法在跨平台加解密时，需要进行原始裸数据与ASN.1格式数据的转换，包括密钥格式转换和密文格式转换，具体可参考<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section48982572218">SM2加解密</a>。</li><li>HarmonyOS平台在初始化加解密引擎时，需要传入固定的参数，参数格式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-encrypt-decrypt-spec" target="_blank">加解密算法规格</a>。以AES为例，详细分析密钥长度使用问题和偏移量参数的设置问题，具体可参考<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section848458172418">AES加解密</a>。</li></ol> </div> <div class="tiledSection"><h3 id="section48982572218" class="firsth2">SM2加解密<i class="anchor-icon anchor-icon-link" anchorid="section48982572218" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-key-generation-conversion-spec#sm2" target="_blank">SM2</a>，是一种基于椭圆曲线的公钥密码算法。</p> <p>下面介绍并解决在HarmonyOS平台与其他平台交互使用SM2加解密开发时遇到的密钥格式和密文数据格式问题。</p> <ul><li>SM2密钥格式转换<p>SM2加解密中，HarmonyOS平台支持ASN.1序列化后的密钥数据（公钥91字节，私钥51字节），而其他平台的密钥数据通常为未序列化过的原始裸数据（公钥64字节，私钥32字节）。这些密钥不能直接在HarmonyOS平台使用，需要转换为ASN.1格式。下面以其他平台生成的十六进制密钥为例，介绍如何转换为HarmonyOS平台可用的SM2密钥。</p> <p>其他平台生成的公钥格式为04+x+y，私钥为128位字符串。</p> <p>将对应的16进制参数放入对应的位置，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-key-generation-conversion-spec#使用密钥参数生成-3" target="_blank">使用密钥参数生成</a>SM2公钥。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L34-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">convertStrToPubKey</span>(<span class="hljs-variable">keyStr</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">PubKey</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">puKeyStr</span> = <span class="hljs-variable">keyStr</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'04'</span>) ? <span class="hljs-variable">keyStr</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>) : <span class="hljs-title class_">keyStr</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">pkPart1</span> = <span class="hljs-variable">puKeyStr</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">puKeyStr</span>.<span class="hljs-variable">length</span> / <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">pkPart2</span> = <span class="hljs-variable">puKeyStr</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable">puKeyStr</span>.<span class="hljs-variable">length</span> / <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">pks</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">Point</span> = {</li><li>    <span class="hljs-variable">x</span>: <span class="hljs-title class_">BigInt</span>('<span class="hljs-number">0x</span>' <span class="hljs-variable">+ pkPart1</span>),</li><li>    <span class="hljs-variable">y</span>: <span class="hljs-title class_">BigInt</span>('<span class="hljs-number">0x</span>' <span class="hljs-variable">+ pkPart2</span>)</li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">pubKeySpec</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">ECCPubKeySpec</span> = {</li><li>    <span class="hljs-variable">params</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">ECCKeyUtil</span>.<span class="hljs-title class_">genECCCommonParamsSpec</span>('<span class="hljs-title class_">NID_sm2</span>'),</li><li>    <span class="hljs-variable">pk</span>: <span class="hljs-title class_">pks</span>,</li><li>    <span class="hljs-variable">algName</span>: <span class="hljs-string">'SM2'</span>,</li><li>    <span class="hljs-variable">specType</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">AsyKeySpecType</span>.<span class="hljs-title class_">PUBLIC_KEY_SPEC</span></li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">keypairGenerator</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-title function_">createAsyKeyGeneratorBySpec</span>(<span class="hljs-variable">pubKeySpec</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">pksData</span> = <span class="hljs-variable">keypairGenerator</span>.<span class="hljs-title function_">generatePubKeySync</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">pksData</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L34-L51" target="_blank">DataConversion.ets</a></div></div></div></div> <p>同理，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-key-generation-conversion-spec#使用密钥参数生成-3" target="_blank">使用密钥参数生成</a>SM2私钥。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L61-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">convertStrToPriKey</span>(<span class="hljs-variable">keyStr</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">PriKey</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">sks</span> = <span class="hljs-title function_">BigInt</span>(<span class="hljs-string">'0x'</span> + <span class="hljs-variable">keyStr</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">priKeySpec</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">ECCPriKeySpec</span> = {</li><li>    <span class="hljs-variable">params</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">ECCKeyUtil</span>.<span class="hljs-title class_">genECCCommonParamsSpec</span>('<span class="hljs-title class_">NID_sm2</span>'),</li><li>    <span class="hljs-variable">sk</span>: <span class="hljs-title class_">sks</span>,</li><li>    <span class="hljs-variable">algName</span>: <span class="hljs-string">'SM2'</span>,</li><li>    <span class="hljs-variable">specType</span>: <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">AsyKeySpecType</span>.<span class="hljs-title class_">PRIVATE_KEY_SPEC</span></li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">priKeypairGenerator</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-title function_">createAsyKeyGeneratorBySpec</span>(<span class="hljs-variable">priKeySpec</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">sksData</span> = <span class="hljs-variable">priKeypairGenerator</span>.<span class="hljs-title function_">generatePriKeySync</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">sksData</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L61-L72" target="_blank">DataConversion.ets</a></div></div></div></div> </li></ul> </div> <ul><li>SM2密文格式转换<p>SM2是一种国产非对称加密算法，其密文格式由三部分组成：</p> <p>C1：椭圆曲线点，长度为65字节，用于解密过程中的计算。</p> <p>C2：实际加密数据，长度由加密数据决定。</p> <p>C3：32字节的哈希值，用于验证密文完整性。</p> <p>目前SM2密文数据的参数组合顺序有老标准C1C2C3和新标准C1C3C2。</p> <p>HarmonyOS平台支持的SM2密文格式为国密标准的ASN.1格式，参数组合顺序为C1C3C2。具体参数含义请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-asym-encrypt-decrypt-spec#转换sm2密文格式" target="_blank">转换SM2密文格式</a>。</p> <p>对于其他平台加密的C1C2C3顺序的密文，在HarmonyOS平台解密时，需先提取所需要的参数，并构造<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#sm2ciphertextspec12" target="_blank">SM2CipherTextSpec</a>对象，接着调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-cryptoframework#genciphertextbyspec12" target="_blank">genCipherTextBySpec()</a>方法序列化生成ASN.1格式的SM2密文。具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sm2-ciphertext-conversion" target="_blank">使用SM2密文格式转换(ArkTS)</a>。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L193-L245" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">bytesToBigInt</span>(<span class="hljs-variable">bytes</span>: <span class="hljs-title class_">Uint8Array</span>): <span class="hljs-title class_">bigint</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-number">0</span><span class="hljs-variable">n</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">byte</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bytes</span>) {</li><li>    <span class="hljs-variable">result</span> = (<span class="hljs-variable">result</span> &lt;&lt; <span class="hljs-number">8</span><span class="hljs-variable">n</span>) | <span class="hljs-title function_">BigInt</span>(<span class="hljs-variable">byte</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li><li>
</li><li><span class="hljs-title function_">i2dSM2CipherText</span>(<span class="hljs-variable">primal_data</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">Uint8Array</span> {</li><li>  <span class="hljs-comment">// Converting a Hex String to byte array.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">cipherBytes</span> = <span class="hljs-variable">DataConversion</span>.<span class="hljs-title function_">hexStrToUint8Array</span>(<span class="hljs-variable">primal_data</span>);</li><li>
</li><li>  <span class="hljs-comment">// Defines that the length of C1 is 65 bytes (uncompressed format: 04 + x(32) + y(32)).</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">c1Length</span> = <span class="hljs-number">65</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">totalLength</span> = <span class="hljs-variable">cipherBytes</span>.<span class="hljs-variable">length</span>;</li><li>
</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">totalLength</span> &lt; <span class="hljs-title class_">c1Length</span> + <span class="hljs-number">32</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'id2_SM2_Ciphertext'</span>, <span class="hljs-string">'Non-SM2 criterion compliant.'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Extract C1 Part.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">c1Bytes</span> = <span class="hljs-variable">cipherBytes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">c1Length</span>);</li><li>
</li><li>  <span class="hljs-comment">// Verify that C1 is in uncompressed format starting with 04.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">c1Bytes</span>[<span class="hljs-number">0</span>] !== <span class="hljs-number">0x04</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'id2_SM2_Ciphertext'</span>, <span class="hljs-string">'C1 is not in uncompressed format.'</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Extract x and y coordinates.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">xBytes</span> = <span class="hljs-variable">c1Bytes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">33</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">yBytes</span> = <span class="hljs-variable">c1Bytes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">33</span>, <span class="hljs-number">65</span>);</li><li>
</li><li>  <span class="hljs-comment">// Convert to BigInt.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">xBigInt</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">bytesToBigInt</span>(<span class="hljs-variable">xBytes</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">yBigInt</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">bytesToBigInt</span>(<span class="hljs-variable">yBytes</span>);</li><li>
</li><li>  <span class="hljs-comment">// Extract the C3 part (last 32 bytes).</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">c3Start</span> = <span class="hljs-variable">totalLength</span> - <span class="hljs-number">32</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">c3Bytes</span> = <span class="hljs-variable">cipherBytes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable">c3Start</span>);</li><li>
</li><li>  <span class="hljs-comment">// Extract C2 part (middle part).</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">c2Bytes</span> = <span class="hljs-variable">cipherBytes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable">c1Length</span>, <span class="hljs-variable">c3Start</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">spec</span> : <span class="hljs-title class_">cryptoFramework</span>.<span class="hljs-title class_">SM2CipherTextSpec</span> = {</li><li>    <span class="hljs-variable">xCoordinate</span>: <span class="hljs-title class_">xBigInt</span>,</li><li>    <span class="hljs-variable">yCoordinate</span>: <span class="hljs-title class_">yBigInt</span>,</li><li>    <span class="hljs-variable">cipherTextData</span>: <span class="hljs-title class_">c2Bytes</span>,</li><li>    <span class="hljs-variable">hashData</span>: <span class="hljs-title class_">c3Bytes</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-variable">cryptoFramework</span>.<span class="hljs-variable">SM2CryptoUtil</span>.<span class="hljs-title function_">genCipherTextBySpec</span>(<span class="hljs-variable">spec</span>, <span class="hljs-string">'C1C3C2'</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">data</span>.<span class="hljs-variable">data</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L193-L245" target="_blank">DataConversion.ets</a></div></div></div></div> <p>同理，HarmonyOS平台生成的C1C3C2顺序的ASN.1格式密文在其他平台使用时，需要先解码为C1C3C2的裸密文。</p> <div class="screenLinkPre"><div _ngcontent-lpm-c106="" class="highlight-div"><div _ngcontent-lpm-c106="" class="highlight-div-header"><div _ngcontent-lpm-c106="" class="highlight-div-header-left"><div _ngcontent-lpm-c106="" class="handle-button expand-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lpm-c106="" class="highlight-div-header-right"><div _ngcontent-lpm-c106="" class="handle-button ai-button"></div><div _ngcontent-lpm-c106="" class="handle-button line-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lpm-c106="" class="handle-button theme-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lpm-c106="" class="handle-button copy-button"><div _ngcontent-lpm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lpm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L157-L183" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">d2i_SM2_Ciphertext</span>(<span class="hljs-attr">standard_data</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = standard_data;</li><li>  <span class="hljs-keyword">if</span> (!message.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'30'</span>)) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'d2i_SM2_Ciphertext'</span>,</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>($r(<span class="hljs-string">'app.string.format_error'</span>).<span class="hljs-property">id</span>));</li><li>  }</li><li>  message = message.<span class="hljs-title function_">slice</span>(<span class="hljs-string">'30'</span>.<span class="hljs-property">length</span>, message.<span class="hljs-property">length</span>);</li><li>
</li><li>  <span class="hljs-comment">// The length of the SM2 sequence content.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sequence_lexHex</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLenHex</span>(message);</li><li>  message = message.<span class="hljs-title function_">slice</span>(sequence_lexHex.<span class="hljs-property">length</span>, message.<span class="hljs-property">length</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sequence_len</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lenHex2number</span>(sequence_lexHex);</li><li>
</li><li>  <span class="hljs-keyword">if</span> (sequence_len !== message.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'d2i_SM2_Ciphertext'</span>,</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>($r(<span class="hljs-string">'app.string.format_error'</span>).<span class="hljs-property">id</span>));</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> sm2_sequence = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Sequence</span>();</li><li>  message = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readC1</span>(sm2_sequence, message);</li><li>  message = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readC3</span>(sm2_sequence, message);</li><li>  message = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readC2</span>(sm2_sequence, message);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'sm2_sequence'</span>, sm2_sequence.<span class="hljs-title function_">toString</span>());</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">primal_data</span>: <span class="hljs-built_in">string</span> = sm2_sequence.<span class="hljs-property">C1x</span> + sm2_sequence.<span class="hljs-property">C1y</span> + sm2_sequence.<span class="hljs-property">C3</span> + sm2_sequence.<span class="hljs-property">C2</span>;</li><li>  <span class="hljs-keyword">return</span> primal_data;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/crypto-collection/blob/master/entry/src/main/ets/utils/DataConversion.ets#L157-L183" target="_blank">DataConversion.ets</a></div></div></div></div> </li></ul> <div class="tiledSection"><h3 id="section848458172418">AES加解密<i class="anchor-icon anchor-icon-link" anchorid="section848458172418" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-key-generation-conversion-spec#aes" target="_blank">AES</a>（Advanced Encryption Standard），最常见的对称加密算法。</p> <p>下面介绍并解决在HarmonyOS平台与其他平台交互使用AES加解密开发中遇到的问题：密钥长度和指定分组模式后的偏移量参数设置。</p> <ul><li>AES密钥长度使用问题<p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-key-generation-conversion-spec#aes" target="_blank">AES</a>加解密算法中，密钥长度是固定的。</p> <p>初始化HarmonyOS平台的加解密引擎时，需指定算法规格及密钥长度。密钥长度可为128位（对应字符串参数AES128）、192位（对应字符串参数AES192）或256位（对应字符串参数AES256）。AES密钥的字节长度与位数对应关系为：16字节对应128位，24字节对应192位，32字节对应256位。通过密钥位数可推断其字节长度。</p> <p>以指南<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-aes-sym-encrypt-decrypt-gcm" target="_blank">使用AES对称密钥（GCM模式）加解密(ArkTS)</a>为例，使用'AES128|GCM|PKCS7'初始化加解密算法实例。加解密时对应的密钥应为128位，即16个字符。因此，在生成密钥时，传入的字符为newUint8Array([83,217,231,76,28,113,23,219,250,71,209,210,205,97,32,159])。</p> <p><strong>通过字符串获取密钥位数</strong></p> <p>使用HarmonyOS的加解密API时，需明确指定算法规格和密钥长度，且该参数必须与传入的密钥匹配。密钥字符串通常以字节序列或十六进制字符串形式表示，无法直接获取其位数信息。</p> <p>因此，当给定一个表示AES密钥的字符串，需要确定其密钥长度（以位数表示）时，可以按照以下步骤进行：</p> <ol><li>确定密钥字符串的编码：确定密钥字符串的编码方式，常见的编码方式包括Base64、UTF-8、16进制等。</li><li>计算密钥的字节长度：根据密钥字符串的编码，将其转换为Uint8Array格式，计算其对应的字节长度。转换方式可参考<a href="/consumer/cn/doc/best-practices/bpta-cross-platform-compatibility#section1152116421582">数据格式转换</a>。</li><li>推断密钥位数：根据AES密钥的字节长度与位数之间的对应关系，推断密钥的位数。16字节对应128位，24字节对应192位，32字节对应256位。</li></ol> </li><li>AES指定分组模式后偏移量参数设置问题<p>由于AES为分组加密算法，分组长度为128位。在实际应用中，最后一组明文可能不足128位（16字节），此时可以通过不同的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-sym-encrypt-decrypt-spec#填充模式" target="_blank">填充模式</a>进行数据填充。</p> <p>以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-aes-sym-encrypt-decrypt-gcm" target="_blank">GCM模式</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/crypto-aes-sym-encrypt-decrypt-cbc" target="_blank">CBC模式</a>为例，指定字符串参数分别为'AES128|GCM|PKCS7'和'AES128|CBC|PKCS7'，偏移量分别为16字节和12字节。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.4.2.3.1.4.1.1" valign="top" width="33.33333333333333%"><p>分组模式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.4.2.3.1.4.1.2" valign="top" width="33.33333333333333%"><p>所需参数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.4.2.3.1.4.1.3" valign="top" width="33.33333333333333%"><p>备注</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>ECB</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>没有偏移量等参数。</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>-</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>CBC、CTR、OFB、CFB</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>iv长度为16字节。</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>-</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>GCM</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>加解密参数iv，长度为1~16字节，常用为12字节。</p> <p>加解密参数add，长度为0~INT_MAX字节，常用为16字节。</p> <p>加解密参数authTag，长度为16字节。</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>在GCM模式下，需要从加密后的数据中取出末尾16字节，作为解密时初始化的认证信息。</p> </td> </tr>  </tbody></table></div> </div> </li></ul> </div> <div class="tiledSection"><h2 id="section55681610101616">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section55681610101616" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/crypto-collection" target="_blank">加解密算法合集</a></li></ul> </div> </div> <div></div></div>