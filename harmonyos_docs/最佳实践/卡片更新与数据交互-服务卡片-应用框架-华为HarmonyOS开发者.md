<h1 _ngcontent-xhn-c119="" class="doc-title ng-star-inserted" title="卡片更新与数据交互"> 卡片更新与数据交互 </h1>

<div _ngcontent-xhn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section12314152282615">概述<i class="anchor-icon anchor-icon-link" anchorid="section12314152282615" tips="复制节点链接"></i></h2><p>服务卡片给用户提供一目了然的信息内容，具有易用可见、智能可选和多端可变的特点，提供给用户简洁、高效的体验。系统通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/form-kit" target="_blank">卡片开发服务</a>（Form Kit），提供了丰富的服务卡片开发能力，涵盖了卡片的创建、交互、更新与管理等多个方面，使开发者能够高效完成个性化服务卡片的开发。</p> <div class="fignone"><span class="figcap"><b>图1 </b>天气卡片</span></div> <p><span><img height="342.14250000000004" originheight="2435" originwidth="3727" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.21885641009006956453114909526994:50001231000000:2800:92CB3BA6DE8786ADA831F81C0CDE01B6F2FDA8B3633901D0F3521E47C3E18883.jpg" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section430210710274" class="firsth2">卡片更新场景<i class="anchor-icon anchor-icon-link" anchorid="section430210710274" tips="复制节点链接"></i></h3><p>服务卡片通常用于展示最新的信息或数据。通过卡片更新机制，开发者可以确保卡片上展示的内容是最新的，从而满足用户对实时信息的需求。例如，新闻应用可以通过更新卡片来展示最新的新闻标题和摘要，天气应用可以通过更新卡片来提供最新的天气信息。</p> <p>卡片更新的频率和策略直接影响用户体验。如果卡片内容长时间不更新，用户可能会认为应用不活跃或不可靠，从而降低对应用的信任度和使用频率。相反，通过合理的卡片更新机制，可以保持卡片内容的新鲜感和吸引力，提升用户的使用体验和满意度。</p> <p>通常需要进行卡片数据加载或卡片更新的场景有以下几种类型：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>卡片更新场景</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.5.2.5.1.1" valign="top"><p>场景类型</p> </th> <th align="left" class="cellrowborder" colspan="3" id="mcps1.3.2.5.2.5.1.2" valign="top"><p>场景描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="9.75%"><p>主动刷新</p> </td> <td class="cellrowborder" valign="top" width="29.310000000000002%"><ul><li>添加卡片时，初始化卡片数据。<p>例如，从桌面添加卡片，弹出卡片预览弹窗时，进行卡片数据初始化加载。</p> <p><span><img height="510.0226824" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.65084018289966066531563489564772:50001231000000:2800:8466775EAC8361C5D5491D2C937524BC3ACA6E3D09A1BDA28671D8E5ADBF7592.png" title="点击放大" width="245.652"></span></p> </li></ul> </td> <td class="cellrowborder" valign="top" width="30.490000000000002%"><ul><li>卡片UI交互时，进行卡片更新。<p>例如，点击卡片刷新按钮，更新卡片推荐内容；音乐类卡片点击播放按钮，拉起应用至后台播放音乐，更新播放按钮状态。</p> <p><span><img height="526.5980986000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.93881183690734733591532809538896:50001231000000:2800:78322CDADF6D935C11688E2B09E36F49E0DD44ECDDE4BE798196CEEFD3D1A365.gif" title="点击放大" width="256.50800000000004"></span></p> </li></ul> </td> <td class="cellrowborder" valign="top" width="30.45%"><ul><li>应用侧交互引起变化，更新数据到卡片。<p>例如，在应用侧点击收藏按钮改变文章的收藏状态时，同步更新卡片的收藏状态。</p> <p><span><img height="525.842613" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.20955503919617450741550954806113:50001231000000:2800:6838CAF085558B89A5714026EAD6FD5A1EFA5CBEE572DBD4863A58CCC385F1EF.gif" title="点击放大" width="256.14"></span></p> </li></ul> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>被动刷新</p> </td> <td class="cellrowborder" colspan="3" valign="top"><ul><li>定时更新、定点更新以及指定下次刷新时间间隔更新。例如，定时更新新闻卡片的推荐内容。</li></ul> </td> </tr>  </tbody></table></div> </div> <p>本文将以<a href="https://gitee.com/harmonyos_samples/CardInfoRefresh" target="_blank">实现卡片更新与数据交互功能</a>示例应用为例，介绍卡片数据交互流程、如何实现常见的卡片更新场景以及卡片更新开发过程中的常见问题和注意事项。</p> </div> <div class="tiledSection"><h2 id="section41681823294">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section41681823294" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section341665175419" class="firsth2">卡片运行机制简介<i class="anchor-icon anchor-icon-link" anchorid="section341665175419" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图2 </b>卡片提供方和使用方</span><br><span><img height="342.14250000000004" originheight="2435" originwidth="3727" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.26548260184358108392724726664916:50001231000000:2800:371B9BB665719975B45C0AD448C5CFF7841A3D84B06BFAC295C2758BB09A48DF.jpg" title="点击放大" width="523.6875"></span></div> <p>以天气卡片为例，天气应用作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/formkit-overview#服务卡片架构" target="_blank">卡片提供方</a>，提供天气卡片的显示内容、控件布局和卡片交互处理逻辑。例如，天气卡片显示地点、温度和天气情况，点击卡片跳转至天气应用等。此时，桌面作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/formkit-overview#服务卡片架构" target="_blank">卡片使用方</a>，即卡片的宿主应用，控制天气卡片在桌面中展示的位置并展示卡片内容。ArkTS服务卡片的实现依赖ArkTS卡片框架的能力，卡片框架管理卡片生命周期和刷新机制，负责卡片页面的渲染。如下图所示，卡片提供方和使用方都依赖于卡片框架，天气应用提供的天气卡片，其添加、删除和刷新依赖框架的卡片管理服务，桌面展示天气卡片内容依赖框架的卡片渲染服务。关于卡片提供方、使用方和卡片框架的详细内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-form-overview#实现原理" target="_blank">ArkTS卡片实现原理</a>。</p> <div class="fignone"><span class="figcap"><b>图3 </b>卡片运行机制示例</span></div> <p><span><img height="139.2244" originheight="193" originwidth="762" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163009.20188863507362646065338402722601:50001231000000:2800:9289B77721F1AF5B27C7C3B238BAF421B427E6F8FB00629D525854B08CEBA4F7.jpg" title="点击放大" width="532"></span></p> </div> <div class="tiledSection"><h3 id="section9169174313913">卡片数据交互<i class="anchor-icon anchor-icon-link" anchorid="section9169174313913" tips="复制节点链接"></i></h3><p>卡片更新场景的实现，依赖于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>生命周期、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider" target="_blank">formProvider模块</a>提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口和卡片框架提供的卡片刷新机制。如下图所示，应用主进程和应用的卡片进程是两个独立的进程，应用主进程持有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability" target="_blank">UIAbility</a>，应用的卡片进程持有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>。卡片的UI页面由系统服务统一进行渲染，由卡片使用方（例如桌面）进行呈现。如果卡片数据不依赖于应用主进程，在卡片进程中使用卡片框架能力就能实现卡片更新。如果卡片数据依赖于应用主进程，应用主进程使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider" target="_blank">FormProvider模块</a>提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口更新卡片时，需要明确卡片ID，所以卡片ID在添加卡片时需要进行存储，此类场景下需要借助卡片框架和数据存储等系统能力，保证应用主进程和卡片进程的卡片ID数据一致性。</p> <div class="fignone"><span class="figcap"><b>图4 </b>应用主进程与卡片进程</span></div> <p><span><img height="238.4025" originheight="407" originwidth="892" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.47918742744120968065501450987075:50001231000000:2800:41683B7ECC81DCA58D85D0242366E4D303FD5D5B804103971B009137783B388A.jpg" title="点击放大" width="523.6875"></span></p> <p>本文主要介绍由卡片或应用UI交互引起的、由系统刷新机制定时或定点触发的<a href="/consumer/cn/doc/best-practices/bpta-card-update-and-data-interaction#section430210710274">卡片更新场景</a>。一般情况下，卡片实现这几种常见场景就可以满足用户对卡片信息更新的诉求。还有一类是需要实时更新信息的应用卡片，例如出行打车类卡片，用户对信息的实时性要求很高，这类场景可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-kit-guide" target="_blank">Push Kit（推送服务）</a>的能力来实现，详细可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/push-form-update" target="_blank">推送卡片刷新消息</a>。</p> </div> <div class="tiledSection"><h2 id="section1067092916265">卡片数据初始化<i class="anchor-icon anchor-icon-link" anchorid="section1067092916265" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section66448427101" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section66448427101" tips="复制节点链接"></i></h3><p>添加卡片时需要对卡片进行数据初始化，卡片创建及卡片配置参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui" target="_blank">ArkTS卡片开发指导</a>，本章节将对卡片数据初始化的流程进行介绍。</p> <div class="fignone"><span class="figcap"><b>图5 </b>卡片预览页</span><br><span><img height="552.2692000000001" originheight="2258" originwidth="1087" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.66633442151595163295633658742590:50001231000000:2800:B0B5776FF30252CF5ED560EB54179EA88C0304839CDD85AC721161F923E12BD3.png" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section2566201617118">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section2566201617118" tips="复制节点链接"></i></h3><p>添加卡片时，卡片数据初始化流程：</p> <div class="fignone"><span class="figcap"><b>图6 </b>卡片数据初始化流程</span><br><span><img height="306.06784600000003" originheight="299" originwidth="905" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.29129765091811605601645485527915:50001231000000:2800:758C01D1C3B06794F8B096006C6775EF241D0CCF4A053E22C03C2BD232895ED3.jpg" title="点击放大" width="905.73"></span></div> <p>桌面长按应用图标待展示卡片列表时，首先触发<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>生命周期接口onAddForm()。使用卡片参数枚举<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-forminfo#formparam" target="_blank">FormParam</a>可以从生命周期接口onAddForm()的入参<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-want" target="_blank">want</a>中取出卡片的相关信息如卡片标识、卡片名称、卡片宽高等。针对必要的信息可以进行判断或者保存等操作。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L19-L173" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryFormAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): formBindingData.<span class="hljs-property">FormBindingData</span> {</li><li>    <span class="hljs-keyword">if</span> (!want || !want.<span class="hljs-property">parameters</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FormAbility onAddForm want or want.parameters is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>    }</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formName</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">NAME_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">IDENTITY_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L19-L173" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <p>创建需要返回卡片的数据类，可以是包含若干键值对的Object或JSON格式的字符串。使用卡片数据绑定模块<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formbindingdata#formbindingdata" target="_blank">formBindingData</a>的createFormBindingData()接口封装卡片需要使用的数据类，作为生命周期接口onAddForm()的返回值并传递给卡片。</p> <p>说明：若onAddForm()接口中无法直接构建数据类作为接口返回值初始化卡片，例如依赖数据库查询结果或等待网络数据等使用异步的场景，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider" target="_blank">formProvider模块</a>提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口将异步获取的数据推送至卡片。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/common/CommonData.ets#L42-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FormData</span> {</li><li>  <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">formTime</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">isFavor</span>?: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  <span class="hljs-variable">index</span>?: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">cardList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">CardListItemData</span>&gt; = [];</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">formId</span> = <span class="hljs-variable">formId</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/common/CommonData.ets#L42-L52" target="_blank">CommonData.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L17-L174" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, systemDateTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): formBindingData.<span class="hljs-property">FormBindingData</span> {</li><li>    <span class="hljs-keyword">if</span> (!want || !want.<span class="hljs-property">parameters</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FormAbility onAddForm want or want.parameters is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>    }</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formName</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">NAME_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">IDENTITY_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (formName === <span class="hljs-string">'card_info_refresh'</span>) {</li><li>        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>        formData.<span class="hljs-property">formTime</span> = systemDateTime.<span class="hljs-title function_">getTime</span>().<span class="hljs-title function_">toString</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formInfo</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>        <span class="hljs-keyword">return</span> formInfo;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`<span class="hljs-subst">${formId}</span>_show_index`</span>;</li><li>      <span class="hljs-keyword">let</span> data = util.<span class="hljs-title function_">getFormInitData</span>(key, preferences);</li><li>      <span class="hljs-keyword">if</span> (formName === <span class="hljs-string">'card_info_update'</span>) {</li><li>        <span class="hljs-comment">// Save the index of the data items currently displayed on the card.</span></li><li>        util.<span class="hljs-title function_">preferencesPut</span>(preferences, key, data.<span class="hljs-property">id</span>);</li><li>        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>        formData.<span class="hljs-property">cardList</span>.<span class="hljs-title function_">push</span>(data);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formInfo</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>        <span class="hljs-keyword">return</span> formInfo;</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L17-L174" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <p>卡片页面使用页面级的UI状态存储<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage" target="_blank">LocalStorage</a>接收onAddForm()接口传递的数据。使用装饰器@LocalStorageProp装饰的状态变量接收数据类的详细信息，装饰器@LocalStorageProp(key)中的key值需与数据类的键值一一对应。使用获取的数据初始化卡片页面。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L20-L212" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> storageLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span>(storageLocal)</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WidgetCard</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'formTime'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onFormTimeChange'</span>) <span class="hljs-attr">formTime</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'formId'</span>) <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onFormTimeChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L20-L212" target="_blank">WidgetCard.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section3909181512141">卡片UI交互引起卡片更新<i class="anchor-icon anchor-icon-link" anchorid="section3909181512141" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17976425141614" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section17976425141614" tips="复制节点链接"></i></h3></div> <p><span><img height="546.0847" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.21911742724691813764443678439176:50001231000000:2800:D4EC543DC3F7E8D637F7D04FE4573A34B9E5627189FCCFAB1002072CF7710C89.gif" title="点击放大" width="266"></span></p> <p>一般情况下，简单的卡片UI交互会引起卡片更新。例如，智能家电控制类卡片，通过卡片控制家电开关时，卡片上的开关状态会随设备状态而改变；点击新闻类卡片刷新按钮，从网络获取最新数据更新推荐内容列表。这类更新场景可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-formextensionability" target="_blank">通过message事件</a>实现，仅在卡片进程就可以完成卡片更新。</p> <div class="tiledSection"><h3 id="section19573651101617">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section19573651101617" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图7 </b>卡片UI交互引起更新</span><br><span><img height="284.15450000000004" originheight="304" originwidth="969" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.97838238557208979004282827607726:50001231000000:2800:0B3DE31DEDCFA8E92F4383E56E91DC344D8590DD77DF951C1AFB23E5BF06956A.jpg" title="点击放大" width="905.73"></span></div> </div> <p>在卡片页面注册onClick()点击事件，动态卡片使用postCardAction()接口，静态卡片使用FormLink组件触发事件。本文以动态卡片为例，在点击事件回调中调用postCardAction()接口，action参数选择message触发message事件。message事件未设置abilityName参数时，默认拉起FormExtensionAbility。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L172-L182" data-highlighted="yes"><ol class="linenums"><li>Row() {</li><li>  <span class="hljs-keyword">this</span>.buttonBuilder($r(<span class="hljs-string">'app.string.message'</span>))</li><li>}</li><li>.onClick(() =&gt; {</li><li>  postCardAction(<span class="hljs-keyword">this</span>, {</li><li>    action: <span class="hljs-string">'message'</span>,</li><li>    params: {</li><li>      message: <span class="hljs-string">'Message refresh card.'</span></li><li>    }</li><li>  });</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L172-L182" target="_blank">WidgetCard.ets</a></div></div></div></div> <p>message事件拉起FormExtensionAbility后触发onFormEvent()生命周期，构建卡片需要更新的数据类，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口推送数据至卡片。卡片页面中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstorageprop" target="_blank">LocalStorageProp</a>装饰的状态变量更新后触发卡片更新。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L22-L175" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryFormAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onFormEvent</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span>, message: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>      formProvider.<span class="hljs-title function_">updateForm</span>(formId, formMsg).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'updateForm success.'</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed. error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getSync failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L22-L175" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section205161754175">拉起应用至后台时更新卡片<i class="anchor-icon anchor-icon-link" anchorid="section205161754175" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section58536239287" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section58536239287" tips="复制节点链接"></i></h3><p><span><img height="546.0847" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.60226098295031937068883398256940:50001231000000:2800:22F350809CAB17CAEEFD5E30F21BE673C6CF6AD41E71D53BFF1B555648F7E566.gif" title="点击放大" width="266"></span></p> <p>卡片UI交互引起卡片更新，实现和应用在前台时相同的功能。例如，音乐类卡片，点击播放或切换按钮，拉起后台播放音乐，同时更新卡片上的播放状态。这类更新场景可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-call" target="_blank">通过call事件</a>实现，需要在卡片进程拉起应用主进程至后台时更新卡片。</p> </div> <div class="tiledSection"><h3 id="section748210461186">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section748210461186" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图8 </b>拉起应用至后台时更新卡片</span><br><span><img height="315.95480000000003" originheight="315" originwidth="903" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.40089358181981047338482973751597:50001231000000:2800:64DD0F30D7A38BF76637D7EE59DC4440EB59B8BE461DEF9445EB5011BA2532E0.jpg" title="点击放大" width="905.73"></span></div> <p>在卡片页面注册onClick()点击事件，本文以动态卡片为例，在回调中调用postCardAction()接口（静态卡片使用静态用的FormLink），action参数选择call并配置需要调用的方法和传递的数据，触发call事件后台拉起指定UIAbility。配置参数注意以下限制：</p> <ul><li>abilityName参数仅支持配置当前应用下的UIAbility，即配置在module.json5文件中的UIAbility。</li><li>method为必选参数，且类型为string类型，用于触发UIAbility中对应的方法。</li><li>在当前call事件触发指定卡片刷新场景中，需设置formId参数，用于UIAbility接收后更新当前卡片。</li></ul> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L153-L168" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Row</span>() {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">buttonBuilder</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.call'</span>))</li><li>}</li><li>.<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>  <span class="hljs-title function_">postCardAction</span>(<span class="hljs-keyword">this</span>, {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-string">'call'</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-string">'EntryAbility'</span>,</li><li>    <span class="hljs-variable">params</span>: {</li><li>      <span class="hljs-variable">formId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">formId</span>,</li><li>      <span class="hljs-variable">method</span>: <span class="hljs-string">'updateCardInfo'</span>,</li><li>      <span class="hljs-variable">params</span>: {</li><li>        <span class="hljs-variable">message</span>: <span class="hljs-string">'Call refresh card.'</span></li><li>      }</li><li>    }</li><li>  });</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L153-L168" target="_blank">WidgetCard.ets</a></div></div></div></div> <p>在被拉起的UIAbility的onCreate()生命周期中，需要配置监听call事件所需的方法，监听的方法名与call事件配置的method保持一致。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#readstring9" target="_blank">readString()</a>方法读取传递的字符串值后，使用JSON.parse()解析传递的参数。使用传递的formId并构建更新卡片需要的数据类型，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口推送数据至卡片。</p> <p>注意，进程退出时需在onDestroy()生命周期中解除监听；监听配置的方法需返回实现rpc.Parcelable()接口的数据类。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L17-L327" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { formBindingData, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">private</span> callFunc = (<span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageSequence</span>): <span class="hljs-function"><span class="hljs-params">MyParcelable</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data.<span class="hljs-title function_">readString</span>());</li><li>      <span class="hljs-keyword">if</span> (params.<span class="hljs-property">formId</span> !== <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = params.<span class="hljs-property">formId</span>;</li><li>        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>        <span class="hljs-keyword">let</span> util = <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>();</li><li>        <span class="hljs-keyword">let</span> preferences = util.<span class="hljs-title function_">getPreferences</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>        <span class="hljs-keyword">if</span> (!preferences) {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyParcelable</span>(<span class="hljs-number">1</span>);</li><li>        }</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span> = preferences.<span class="hljs-title function_">getSync</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DATA_INDEX</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>        formData.<span class="hljs-property">cardList</span> = <span class="hljs-title class_">CommonData</span>.<span class="hljs-title function_">getData</span>(index);</li><li>        util.<span class="hljs-title function_">preferencesPut</span>(preferences, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DATA_INDEX</span>, index + <span class="hljs-number">1</span>);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>        formProvider.<span class="hljs-title function_">updateForm</span>(formId, formMsg).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'updateForm success.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>          <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed. error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        });</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`callFunc failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyParcelable</span>(<span class="hljs-number">1</span>);</li><li>  };</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">_launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'updateCardInfo'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">callFunc</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`on updateCardInfo failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onDestroy</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'updateCardInfo'</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to disconnect callee. Cause: error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyParcelable</span> <span class="hljs-keyword">implements</span> rpc.<span class="hljs-property">Parcelable</span> {</li><li>  <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">num: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = num;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">marshalling</span>(<span class="hljs-attr">dataOut</span>: rpc.<span class="hljs-property">MessageSequence</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      dataOut.<span class="hljs-title function_">writeInt</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'MyParcelable'</span>, <span class="hljs-string">`marshalling failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">unmarshalling</span>(<span class="hljs-attr">dataIn</span>: rpc.<span class="hljs-property">MessageSequence</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = dataIn.<span class="hljs-title function_">readInt</span>();</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'MyParcelable'</span>, <span class="hljs-string">`unmarshalling failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L17-L327" target="_blank">EntryAbility.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>提供方应用需要具备后台运行权限（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/permissions-for-all#ohospermissionkeep_background_running" target="_blank">ohos.permission.KEEP_BACKGROUND_RUNNING</a>）。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section2046812264180">从卡片跳转到应用后更新卡片<i class="anchor-icon anchor-icon-link" anchorid="section2046812264180" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section811901452819" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section811901452819" tips="复制节点链接"></i></h3><p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.66341368207179872296870149687280:50001231000000:2800:1022543D3FC7656BFA01B0159FCE707FBD0C687A4446024A93AA57269E2C6ABB.gif" title="点击放大" width="266"></span></p> <p>卡片UI交互跳转至应用后，引起卡片更新。用于定时更新类卡片手动触发卡片更新。例如，天气类卡片，点击卡片跳转至应用，应用实时刷新天气，同时更新卡片展示的天气数据。这类更新场景可以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-router" target="_blank">通过router事件</a>实现，需要从卡片进程跳转至应用主进程后进行卡片更新。</p> </div> <div class="tiledSection"><h3 id="section723263731911">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section723263731911" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图9 </b>跳转到应用后更新卡片</span></div> <p><span><img height="316.2208" originheight="324" originwidth="928" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163010.77677836274375231811869381803677:50001231000000:2800:4C4A0D12DB2EEED46475F76D195411D595989133550DF4AB032AE54F262E061D.jpg" title="点击放大" width="905.73"></span></p> <p>在卡片页面注册onClick()点击事件，在回调中调用postCardAction()接口，action参数选择router触发router事件。router事件拉起指定的UIAbility，使用abilityName进行配置。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L138-L149" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_ invoke__">Row</span>(){</li><li>  this.<span class="hljs-title function_ invoke__">buttonBuilder</span>(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.string.router'</span>))</li><li>}</li><li>.<span class="hljs-title function_ invoke__">onClick</span>(() =&gt; {</li><li>  <span class="hljs-title function_ invoke__">postCardAction</span>(this, {</li><li>    <span class="hljs-attr">action</span>: <span class="hljs-string">'router'</span>,</li><li>    <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'EntryAbility'</span>,</li><li>    <span class="hljs-attr">params</span>: {</li><li>      <span class="hljs-attr">message</span>: <span class="hljs-string">'Router refresh card.'</span></li><li>    }</li><li>  });</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/widget/pages/WidgetCard.ets#L138-L149" target="_blank">WidgetCard.ets</a></div></div></div></div> <p>在UIAbility中接收router事件并获取参数。若UIAbility未在后台运行，触发onCreate生命周期回调。若UIAbility已在后台运行，会触发onNewWant()生命周期回调。生命周期参数want包含卡片相关信息，执行卡片相关操作。判断params中包含的参数，构建卡片更新需要的数据类，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>接口推送数据至卡片。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L16-L297" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { formBindingData, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { rpc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.IPCKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">_launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateInfo</span>(want);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">_launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateInfo</span>(want);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateInfo</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-keyword">if</span> (!want || !want.<span class="hljs-property">parameters</span> || want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">IDENTITY_KEY</span>] === <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(want.<span class="hljs-property">parameters</span>?.<span class="hljs-property">params</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>))?.<span class="hljs-property">message</span>;</li><li>    <span class="hljs-keyword">if</span> (message === <span class="hljs-string">'Router refresh card.'</span>) {</li><li>      <span class="hljs-keyword">let</span> formId = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">IDENTITY_KEY</span>].<span class="hljs-title function_">toString</span>();</li><li>      <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>      <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>        formProvider.<span class="hljs-title function_">updateForm</span>(formId, formMsg)</li><li>          .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'updateForm success.'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>          })</li><li>          .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed.error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateInfo failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L16-L297" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section41721146122610">从应用更新数据到卡片<i class="anchor-icon anchor-icon-link" anchorid="section41721146122610" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section112451726191218" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section112451726191218" tips="复制节点链接"></i></h3><p><span><img height="425.6" originheight="782" originwidth="976" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163011.33010733007342874712297169455899:50001231000000:2800:4480451694CD0238B01ADFB562EDA1D7A2361CE6804AF32592181648657E92A6.png" title="点击放大" width="532"></span></p> <p>以应用点击收藏场景为例。卡片展示内容在应用内数据列表中，当点击应用内收藏按钮，收藏状态应同步至卡片。</p> </div> <div class="tiledSection"><h3 id="section116517541126">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section116517541126" tips="复制节点链接"></i></h3><p>应用侧UI交互引起卡片数据变化时：</p> <div class="fignone"><span class="figcap"><b>图10 </b>从应用更新数据到卡片流程</span><br><span><img height="320.1975" originheight="286" originwidth="809" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163011.88906196213072912082391336984235:50001231000000:2800:2DDDC6320AFD22A26E67200B6C5D7C46A055F6945505720E29E52C94293E78E2.jpg" title="点击放大" width="905.73"></span></div> <p>图片展示卡片创建时，在onAddForm()生命周期中使用首选项保存卡片ID至卡片ID列表及卡片当前状态。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L20-L176" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PreferencesUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/utils/PreferencesUtil'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'EntryFormAbility'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>): formBindingData.<span class="hljs-property">FormBindingData</span> {</li><li>    <span class="hljs-keyword">if</span> (!want || !want.<span class="hljs-property">parameters</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`FormAbility onAddForm want or want.parameters is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>    }</li><li>    <span class="hljs-keyword">do</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formName</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">NAME_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = want.<span class="hljs-property">parameters</span>[formInfo.<span class="hljs-property">FormParam</span>.<span class="hljs-property">IDENTITY_KEY</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> util = <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>();</li><li>      <span class="hljs-keyword">let</span> preferences = util.<span class="hljs-title function_">getPreferences</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-keyword">if</span> (!preferences) {</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      <span class="hljs-comment">// Save form id using preferences.</span></li><li>      util.<span class="hljs-title function_">addFormId</span>(preferences, formId);</li><li>
</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`<span class="hljs-subst">${formId}</span>_show_index`</span>;</li><li>      <span class="hljs-keyword">let</span> data = util.<span class="hljs-title function_">getFormInitData</span>(key, preferences);</li><li>      <span class="hljs-keyword">if</span> (formName === <span class="hljs-string">'card_info_update'</span>) {</li><li>        <span class="hljs-comment">// Save the index of the data items currently displayed on the card.</span></li><li>        util.<span class="hljs-title function_">preferencesPut</span>(preferences, key, data.<span class="hljs-property">id</span>);</li><li>        <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>        formData.<span class="hljs-property">cardList</span>.<span class="hljs-title function_">push</span>(data);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">formInfo</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>        <span class="hljs-keyword">return</span> formInfo;</li><li>      }</li><li>    } <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L20-L176" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <p>应用侧收藏按钮注册onClick()事件，事件回调触发时，使用首选项更新收藏状态，查询当前正在展示该收藏状态变化的数据的卡片，更新收藏状态到对应卡片。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/pages/Index.ets#L91-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Row</span>() {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>.<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> util = <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>();</li><li>  <span class="hljs-keyword">let</span> preferences = util.<span class="hljs-title function_">getPreferences</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!);</li><li>  <span class="hljs-keyword">if</span>(!preferences) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusArr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>.<span class="hljs-property">id</span>] = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">statusArr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>.<span class="hljs-property">id</span>];</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>.<span class="hljs-property">favour</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusArr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>.<span class="hljs-property">id</span>!];</li><li>  util.<span class="hljs-title function_">preferencesPut</span>(preferences, <span class="hljs-string">'statusArr'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusArr</span>)</li><li>
</li><li>  <span class="hljs-comment">// Update page display data.</span></li><li>  <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'statusArr'</span>, [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">statusArr</span>]);</li><li>
</li><li>  <span class="hljs-keyword">let</span> idArr = <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getFormIds</span>(preferences);</li><li>  <span class="hljs-keyword">if</span> (idArr.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>    idArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">formId: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (!preferences) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">if</span> (preferences.<span class="hljs-title function_">getSync</span>(<span class="hljs-string">`<span class="hljs-subst">${formId}</span>_show_index`</span>, -<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>.<span class="hljs-property">id</span>) {</li><li>          <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>          formData.<span class="hljs-property">cardList</span> = [<span class="hljs-variable language_">this</span>.<span class="hljs-property">itemData</span>];</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>          formProvider.<span class="hljs-title function_">updateForm</span>(formId, formMsg).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm success.`</span>);</li><li>          }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed: error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>          });</li><li>        }</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getSync failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      }</li><li>    })</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/pages/Index.ets#L91-L142" target="_blank">Index.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section7440131852711">定时、定点更新卡片<i class="anchor-icon anchor-icon-link" anchorid="section7440131852711" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section106515432015" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section106515432015" tips="复制节点链接"></i></h3><p>使用天气类或日历类应用时，卡片需要每日更新当日最新数据，方便用户获取最及时的信息。新闻阅读类卡片展示热点文章列表时，需要随时间变化进行定时更新。</p> <p>服务卡片支持通过定时刷新及定点刷新的方式实现以上场景。</p> <p>在使用定时和定点刷新功能之前，需要在form_config.json配置文件中设置updateEnabled字段为true，以启用周期性刷新功能。出于安全及性能考虑，每张卡片每天最多通过定时方式触发刷新50次，定时刷新包含<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-configuration" target="_blank">卡片配置项updateDuration</a>和调用setFormNextRefreshTime方法两种方式，当达到50次配额后，无法通过定时方式再次触发刷新，刷新次数会在每天的0点重置。</p> </div> <div class="tiledSection"><h3 id="section2071195912205">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section2071195912205" tips="复制节点链接"></i></h3></div> <p><strong>定时刷新</strong></p> <p>定时刷新表示在指定的时间间隔后自动刷新卡片内容。可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-configuration" target="_blank">form_config.json</a>配置文件的updateDuration字段中进行设置。卡片定时刷新的更新周期updateDuration字段的单位为30分钟，即最短为半小时（1 * 30min）刷新一次。当取值为0时，表示该参数不生效，当取值为正整数N时，表示刷新周期为30*N分钟。</p> <p>定时刷新触发后，系统调用onUpdateForm()的生命周期回调函数，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>方法更新卡片内容。</p> <div class="screenLinkPre"><div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L23-L177" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { formBindingData, <span class="hljs-title class_">FormExtensionAbility</span>, formInfo, formProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.FormKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CardListItemData</span>, <span class="hljs-title class_">CommonData</span>, <span class="hljs-title class_">FormData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/CommonData'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onUpdateForm</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(formId);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(formData);</li><li>    formProvider.<span class="hljs-title function_">updateForm</span>(formId, formMsg).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed, error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L23-L177" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <p><strong>定点刷新</strong></p> <p>定点刷新表示在每天的某个指定的时间点自动刷新卡片内容。通过在form_config.json文件中配置scheduledUpdateTime字段实现，例如配置为14:00。定点刷新触发后，系统调用FormExtensionAbility的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability#formextensionabilityonupdateform" target="_blank">onUpdateForm()</a>生命周期回调，相关操作参考定时刷新。</p> <p>注意，当同时配置了定时刷新updateDuration和定点刷新scheduledUpdateTime时，定时刷新的优先级更高。为实现定点刷新updateDuration需要配置为0，配置大于0的数字时会导致定点刷新不生效。</p> <div _ngcontent-xhn-c106="" class="highlight-div"><div _ngcontent-xhn-c106="" class="highlight-div-header"><div _ngcontent-xhn-c106="" class="highlight-div-header-left"><div _ngcontent-xhn-c106="" class="handle-button expand-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xhn-c106="" class="highlight-div-header-right"><div _ngcontent-xhn-c106="" class="handle-button ai-button"></div><div _ngcontent-xhn-c106="" class="handle-button line-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xhn-c106="" class="handle-button theme-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xhn-c106="" class="handle-button copy-button"><div _ngcontent-xhn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xhn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"forms"</span>: [</li><li>    {</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"card_info_refresh"</span>,</li><li>      <span class="hljs-string">"displayName"</span>: <span class="hljs-string">"$string:widget_display_name"</span>,</li><li>      <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:widget_desc"</span>,</li><li>      <span class="hljs-string">"src"</span>: <span class="hljs-string">"./ets/widget/pages/WidgetCard.ets"</span>,</li><li>      <span class="hljs-string">"uiSyntax"</span>: <span class="hljs-string">"arkts"</span>,</li><li>      <span class="hljs-string">"window"</span>: {</li><li>        <span class="hljs-string">"designWidth"</span>: <span class="hljs-number">720</span>,</li><li>        <span class="hljs-string">"autoDesignWidth"</span>: <span class="hljs-keyword">true</span></li><li>      },</li><li>      <span class="hljs-string">"colorMode"</span>: <span class="hljs-string">"auto"</span>,</li><li>      <span class="hljs-string">"isDynamic"</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-string">"isDefault"</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-string">"updateEnabled"</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-string">"scheduledUpdateTime"</span>: <span class="hljs-string">"14:00"</span>,</li><li>      <span class="hljs-string">"updateDuration"</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-string">"defaultDimension"</span>: <span class="hljs-string">"4*4"</span>,</li><li>      <span class="hljs-string">"supportDimensions"</span>: [</li><li>        <span class="hljs-string">"4*4"</span></li><li>      ]</li><li>    },</li><li>    <span class="hljs-comment">// ...</span></li><li>  ]</li><li>}</li></ol></pre></div></div> <p>更多注意事项参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-interaction-overview#被动刷新" target="_blank">卡片定时刷新和定点刷新</a>。</p> <div class="tiledSection"><h2 id="section8174634142711">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section8174634142711" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section7743517705" class="firsth2">如何刷新指定类型的多个卡片<i class="anchor-icon anchor-icon-link" anchorid="section7743517705" tips="复制节点链接"></i></h3><p>刷新所有同类卡片首先需要保存同类卡片的formId。在onAddForm()生命周期中，通过判断卡片名称，卡片宽高等信息，识别同类型卡片，将formId分类并持久化，如使用首选项或RDB。</p> <p>应用侧更新状态需同步卡片时，从持久化的数据中获取该类型的formId数组，遍历数组调用formProvider.updateForm()推送卡片更新需要的数据。当卡片移除时，需要在onRemoveForm()生命周期中判断formId是否在该类型数组中，若存在需删除该数据项并更新持久化数据。</p> </div> <div class="tiledSection"><h3 id="section33248131204">如何管理当前已加桌的所有卡片ID<i class="anchor-icon anchor-icon-link" anchorid="section33248131204" tips="复制节点链接"></i></h3><p>长按App图标，弹出下拉菜单点击卡片，或者长按某张卡片，选择更多卡片，弹出“卡片加桌弹窗”时，所有的卡片都会触发onAddForm()生命周期回调。手动关闭卡片加桌弹窗或息屏，退出“卡片加桌弹窗”时，会触发所有卡片的onRemoveForm()生命周期回调。点击“添加至桌面”添加卡片时，退出“卡片加桌弹窗”，会触发除当前加桌卡片之外的其他卡片的onRemoveForm()生命周期回调。</p> <p>当触发onAddForm()生命周期回调时，将卡片ID存储到数据库。当触发onRemoveForm()生命周期回调时，将卡片ID从数据库删除。数据库中未被删除的卡片ID，即是当前已加桌的所有卡片ID。</p> </div> <div class="tiledSection"><h2 id="section1470214387273">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1470214387273" tips="复制节点链接"></i></h2></div> <ul><li><a href="https://gitee.com/harmonyos_samples/CardInfoRefresh" target="_blank">实现卡片更新与数据交互功能</a></li></ul> </div> <div></div></div>