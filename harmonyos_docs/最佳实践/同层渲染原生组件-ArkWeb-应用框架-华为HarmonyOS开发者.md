<h1 _ngcontent-gak-c119="" class="doc-title ng-star-inserted" title="同层渲染原生组件"> 同层渲染原生组件 </h1>

<div _ngcontent-gak-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1499173995214">概述<i class="anchor-icon anchor-icon-link" anchorid="section1499173995214" tips="复制节点链接"></i></h2><p>在使用Web组件加载H5页面时，经常会有输入框、视频的场景，这些场景在H5中的组件性能体验欠佳。想要更加流畅的体验，必须要将原生组件放到Web组件上。在以下场景应在Web组件上使用原生组件：</p> <ul><li>需要高性能，流畅体验。</li><li>需要使用原生组件功能。</li><li>原生组件已经实现，复用以减少开发成本。</li></ul> <p>目前要实现在Web组件上使用原生组件有两种方案：</p> <p>方案一：直接使用Stack将组件堆叠到H5页面上。</p> <p>方案二：使用同层渲染，使用Web组件和原生组件交互的方式，将原生组件替代Web组件中部分组件，提升交互体验和性能。</p> <p>以上两种方案经过性能对比后，同层渲染比非同层渲染的性能要更好。</p> </div> <div class="tiledSection"><h2 id="section46721051172613">什么是同层渲染<i class="anchor-icon anchor-icon-link" anchorid="section46721051172613" tips="复制节点链接"></i></h2><p>同层渲染是一种混合渲染技术，通过将原生组件嵌入到Web组件的DOM树中同一层级，实现原生组件与Web组件的无缝集成。</p> <p>同层渲染和非同层渲染的区别如下：</p> <ul><li>非同层渲染：通过Z轴的层级关系堆叠在Web组件页面上。此方式实现方式简单，用于原生组件大小位置固定场景。</li><li>同层渲染：通过同层渲染的方式直接渲染到H5页面Embed标签区域上。此方式实现相对复杂，用于原生组件大小位置需要跟随Web组件页面变化场景。</li></ul> <p><strong>图1</strong> 同层渲染和非同层渲染区别</p> <p><span><img height="330.1725" originheight="767" originwidth="1214" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.41863218002264826179432102103428:50001231000000:2800:6A0A78011C228FDC22EB9C59DC1AA184AFB422F6E92898F18593258DDDFFB31D.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h2 id="section9190161825620">场景示例<i class="anchor-icon anchor-icon-link" anchorid="section9190161825620" tips="复制节点链接"></i></h2><p>以下分别采用非同层渲染和同层渲染的两种方式，加载相同的商城组件到相同的H5页面上，并抓取Trace对比两者之间的区别，页面效果与场景实例源码的核心部分如下：</p> <p><strong>图2</strong> 页面效果图</p> <p><span><img height="602.5166" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.59468236532518949097337418382973:50001231000000:2800:3FF3D0DD38FAAF84972EC85EB7F889C95A7216359094BBEB42DA734F420C1731.png" title="点击放大" width="300.0613"></span></p> <p>提供承载的H5页面代码如下：</p> <div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php-template" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/resources/rawfile/nativeembed_view.html#L10-L15" data-highlighted="yes"><ol class="linenums"><li><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bodyId"</span>&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-comment">&lt;!-- On the H5 interface, the same layer elements are identified by the embedded tag, and the native components are rendered to the location of the embedded tag on the H5 page on the application side.--&gt;</span></span></li><li><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">embed</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nativeSearch"</span> <span class="hljs-attr">type</span> = <span class="hljs-string">"native/component"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"view"</span>/&gt;</span></span></li><li><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></li><li><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/resources/rawfile/nativeembed_view.html#L10-L15" target="_blank">nativeembed_view.html</a></div></div></div></div> <p>商品数据代码如下：</p> <div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/mock/GoodsMock.ets#L20-L53" data-highlighted="yes"><ol class="linenums"><li>export const PRODUCT_DATA: Array&lt;ProductDataModel&gt; = [</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">0</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product000'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title000'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.nativeembed_product_price000"</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">1</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product001'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title001'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price001'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">2</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product002'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title002'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price002'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">4</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product003'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title004'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price004'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">0</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product000'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title000'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.nativeembed_product_price000"</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">1</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product001'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title001'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price001'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">2</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product002'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title002'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price002'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">4</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product003'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title004'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price004'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">0</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product000'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title000'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.nativeembed_product_price000"</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">1</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product001'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title001'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price001'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">2</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product002'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title002'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price002'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">4</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product003'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title004'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price004'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">0</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product000'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title000'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">"app.string.nativeembed_product_price000"</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">1</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product001'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title001'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price001'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">2</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product002'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title002'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price002'</span>)),</li><li>  new <span class="hljs-built_in">ProductDataModel</span>(<span class="hljs-number">4</span>, $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_product003'</span>), $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_title004'</span>),</li><li>    $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.nativeembed_product_price004'</span>)),</li><li>];</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/mock/GoodsMock.ets#L20-L53" target="_blank">GoodsMock.ets</a></div></div></div></div> <p>商城组件代码如下：</p> <div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/pages/Index.ets#L63-L126" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>struct SearchComponent {</li><li>  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">searchWidth</span>: number;</li><li>  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">searchHeight</span>: number;</li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>({ space: 8 }) {</li><li>      <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'商城'</span>)</li><li>        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)</li><li>      <span class="hljs-selector-tag">Row</span>() {</li><li>        <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.nativeembed_search_icon'</span>))</li><li>          <span class="hljs-selector-class">.width</span>(<span class="hljs-number">14</span>)</li><li>          <span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">14</span> })</li><li>        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'搜索相关宝贝'</span>)</li><li>          <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)</li><li>          <span class="hljs-selector-class">.opacity</span>(<span class="hljs-number">0.6</span>)</li><li>          <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-string">'#000000'</span>)</li><li>          <span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">14</span>})</li><li>      }</li><li>      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-built_in">margin</span>(<span class="hljs-number">4</span>)</li><li>      .<span class="hljs-built_in">height</span>(<span class="hljs-number">36</span>)</li><li>      .<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-attribute">Color</span>.White)</li><li>      .<span class="hljs-built_in">borderRadius</span>(<span class="hljs-number">18</span>)</li><li>      .<span class="hljs-built_in">onClick</span>(() =&gt; {</li><li>        this.<span class="hljs-built_in">getUIContext</span>().<span class="hljs-built_in">getPromptAction</span>().<span class="hljs-built_in">showToast</span>({</li><li>          <span class="hljs-attribute">message</span>: <span class="hljs-string">'仅演示，可自行实现业务功能'</span></li><li>        });</li><li>      })</li><li>      <span class="hljs-built_in">Grid</span>() {</li><li>        <span class="hljs-selector-tag">ForEach</span>(PRODUCT_DATA, (<span class="hljs-attribute">item</span>: ProductDataModel, <span class="hljs-attribute">index</span>: number) =&gt; {</li><li>          <span class="hljs-selector-tag">GridItem</span>() {</li><li>            <span class="hljs-selector-tag">Column</span>({ space: 8 }) {</li><li>              <span class="hljs-selector-tag">Image</span>(item.uri)</li><li>                <span class="hljs-selector-class">.width</span>(<span class="hljs-number">100</span>)</li><li>                <span class="hljs-selector-class">.height</span>(<span class="hljs-number">100</span>)</li><li>              <span class="hljs-selector-tag">Row</span>({ space: 8 }) {</li><li>                <span class="hljs-selector-tag">Text</span>(item.title)</li><li>                  <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)</li><li>                <span class="hljs-selector-tag">Text</span>(item.price)</li><li>                  <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)</li><li>              }</li><li>            }</li><li>            <span class="hljs-selector-class">.backgroundColor</span>(Color.White)</li><li>            <span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Center)</li><li>            <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)</li><li>            <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)</li><li>            <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)</li><li>            <span class="hljs-selector-class">.padding</span>({ <span class="hljs-attribute">bottom</span>: <span class="hljs-number">12</span> })</li><li>          }</li><li>        }, (<span class="hljs-attribute">item</span>: ProductDataModel) =&gt; <span class="hljs-built_in">`${item.id}`</span>)</li><li>      }</li><li>      <span class="hljs-selector-class">.columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      <span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">8</span>)</li><li>      <span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">8</span>)</li><li>      <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)</li><li>      <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'90%'</span>)</li><li>      <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)</li><li>    }</li><li>    <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">10</span>)</li><li>    <span class="hljs-selector-class">.width</span>(this.searchWidth)</li><li>    <span class="hljs-selector-class">.height</span>(this.searchHeight)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/pages/Index.ets#L63-L126" target="_blank">Index.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section361103619224">Web组件首次加载原生组件方案对比<i class="anchor-icon anchor-icon-link" anchorid="section361103619224" tips="复制节点链接"></i></h2><p>首先的想法是，将原生组件内容使用H5实现，直接用Web组件加载页面。但是，用H5开发页面时，需要使用到JS和CSS，甚至一些前端框架进行页面的开发，并且动效和体验都不如原生组件。因此采用同层渲染和非同层渲染两种方案进行对比。</p> </div> <div class="tiledSection"><h3 id="section72101703171" class="firsth2">使用非同层渲染<i class="anchor-icon anchor-icon-link" anchorid="section72101703171" tips="复制节点链接"></i></h3><p>底层使用空白的H5页面，用任意标签进行占位，然后在H5页面上方层叠一个原生组件。原生组件需要在Web组件加载完成后，获取到标签大小位置后，在对应位置展示。</p> <p>需要在H5侧添加getEmbedSize()方法来获取元素大小，代码如下：</p> <div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/resources/rawfile/nativeembed_view.html#L19-L25" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getEmbedSize</span>() {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">doc</span> = <span class="hljs-variable">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'nativeSearch'</span>);</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-variable">width</span>: <span class="hljs-title class_">doc</span>.<span class="hljs-title class_">offsetWidth</span>,</li><li>      <span class="hljs-variable">height</span>: <span class="hljs-title class_">doc</span>.<span class="hljs-title class_">offsetHeight</span>,</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/resources/rawfile/nativeembed_view.html#L19-L25" target="_blank">nativeembed_view.html</a></div></div></div></div> <p>使用Stack层叠Web组件和SearchComponent组件，代码如下：</p> <div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/pages/Index.ets#L2-L127" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">promptAction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">PRODUCT_DATA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../mock/GoodsMock'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NonSameLayerRendering</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">searchWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">searchHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">isWebInit</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  <span class="hljs-variable">browserTabController</span>: <span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>(); <span class="hljs-comment">// WebviewController controller</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>('<span class="hljs-title class_">nativeembed_view</span>.<span class="hljs-title class_">html</span>'), <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">browserTabController</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)</li><li>        .<span class="hljs-title function_">onPageEnd</span>(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">browserTabController</span>.<span class="hljs-title function_">runJavaScript</span>(</li><li>            <span class="hljs-string">'getEmbedSize()'</span>,</li><li>            (<span class="hljs-variable">error</span>, <span class="hljs-variable">result</span>) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable">result</span>) {</li><li>                <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EmbedSize</span> {</li><li>                  <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>,</li><li>                  <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span></li><li>                }</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-variable">embedSize</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">result</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">EmbedSize</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">searchWidth</span> = <span class="hljs-variable">embedSize</span>.<span class="hljs-variable">width</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">searchHeight</span> = <span class="hljs-variable">embedSize</span>.<span class="hljs-variable">height</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">isWebInit</span> = <span class="hljs-keyword">true</span>;</li><li>              }</li><li>            });</li><li>        })</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">isWebInit</span>){</li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-comment">// Because it needs to be displayed according to the actual size of the Web, it needs to wait for the width and height to be obtained after the Web is initialized, and then it needs to be layered on the Web</span></li><li>          <span class="hljs-title function_">SearchComponent</span>({ <span class="hljs-variable">searchWidth</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">searchWidth</span>, <span class="hljs-variable">searchHeight</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">searchHeight</span> })</li><li>        }</li><li>        .<span class="hljs-title function_">zIndex</span>(<span class="hljs-number">10</span>)</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Set the data class of the item</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDataModel</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">uri</span>: <span class="hljs-title class_">ResourceStr</span>;</li><li>  <span class="hljs-variable">title</span>: <span class="hljs-title class_">ResourceStr</span>;</li><li>  <span class="hljs-variable">price</span>: <span class="hljs-title class_">ResourceStr</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">uri</span>: <span class="hljs-title class_">ResourceStr</span>, <span class="hljs-variable">title</span>: <span class="hljs-title class_">ResourceStr</span>, <span class="hljs-variable">price</span>: <span class="hljs-title class_">ResourceStr</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">id</span> = <span class="hljs-variable">id</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">uri</span> = <span class="hljs-variable">uri</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">title</span> = <span class="hljs-variable">title</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">price</span> = <span class="hljs-variable">price</span>;</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SearchComponent</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">searchWidth</span>: <span class="hljs-title class_">number</span>;</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">searchHeight</span>: <span class="hljs-title class_">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">8</span> }) {</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-string">'商城'</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.nativeembed_search_icon'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">14</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">14</span> })</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'搜索相关宝贝'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)</li><li>          .<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.6</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#000000'</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">14</span>})</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">margin</span>(<span class="hljs-number">4</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">36</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">18</span>)</li><li>      .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>          <span class="hljs-variable">message</span>: <span class="hljs-string">'仅演示，可自行实现业务功能'</span></li><li>        });</li><li>      })</li><li>      <span class="hljs-title function_">Grid</span>() {</li><li>        <span class="hljs-title function_">ForEach</span>(<span class="hljs-variable">PRODUCT_DATA</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">GridItem</span>() {</li><li>            <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">8</span> }) {</li><li>              <span class="hljs-title function_">Image</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">uri</span>)</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>              <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">8</span> }) {</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">title</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">price</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>              }</li><li>            }</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>            .<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>            .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">bottom</span>: <span class="hljs-number">12</span> })</li><li>          }</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>) =&gt; `${<span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>}`)</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'90%'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">searchWidth</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">searchHeight</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NonSameLayerRendering/entry/src/main/ets/pages/Index.ets#L2-L127" target="_blank">Index.ets</a></div></div></div></div> <p>上述的方案只是限于底层H5网页比较简单，如果H5页面比较复杂，就会发现原生组件是很难去定位，而且在性能上，Web组件是整体渲染的，即使被原生组件遮住的部分也需要渲染消耗性能。</p> </div> <div class="tiledSection"><h3 id="section1025022152117">使用同层渲染<i class="anchor-icon anchor-icon-link" anchorid="section1025022152117" tips="复制节点链接"></i></h3><p>同层渲染简单来说就是，底层使用空白的H5页面，用Embed标签进行占位，ArkTS使用NodeContainer来占位，最后将Web侧的surfaceId和原生组件绑定，渲染在NodeContainer上。这里给出一些大致步骤：</p> <ol><li>用Stack组件层叠NodeContainer和Web组件，并开启enableNativeEmbedMode模式。</li><li>因为要使用NodeContainer，所以封装一个继承自NodeController的类SearchNodeController。</li><li>使用Web组件加载nativeembed_view.html文件，Web组件解析到Embed标签后，通过onNativeEmbedLifecycleChange()接口上报Embed标签创建消息通知到应用侧。</li><li>在步骤3的回调内，根据embed.status，将配置传入searchNodeController后，执行rebuild()方法重新触发其makeNode()方法。</li><li>makeNode()方法触发后，NodeContainer组件获取到BuilderNode对象，页面出现原生组件。<div class="screenLinkPre"><div _ngcontent-gak-c106="" class="highlight-div"><div _ngcontent-gak-c106="" class="highlight-div-header"><div _ngcontent-gak-c106="" class="highlight-div-header-left"><div _ngcontent-gak-c106="" class="handle-button expand-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gak-c106="" class="highlight-div-header-right"><div _ngcontent-gak-c106="" class="handle-button ai-button"></div><div _ngcontent-gak-c106="" class="handle-button line-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gak-c106="" class="handle-button theme-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gak-c106="" class="handle-button copy-button"><div _ngcontent-gak-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gak-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/ets/pages/Index.ets#L16-L208" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">PRODUCT_DATA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../viewmodel/GoodsViewModel'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">ProductDataModel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/GoodsModel'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BuilderNode</span>, <span class="hljs-variable">FrameNode</span>, <span class="hljs-variable">NodeController</span>, <span class="hljs-variable">NodeRenderType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">webview</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkWeb'</span>;</li><li>
</li><li><span class="hljs-comment">// Margin vertical</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">MARGIN_VERTICAL</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">8</span>;</li><li><span class="hljs-comment">// Font weight</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">FONT_WEIGHT</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">500</span>;</li><li><span class="hljs-comment">// Placeholder</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">PLACEHOLDER</span>: <span class="hljs-title class_">ResourceStr</span> = $<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.embed_search'</span>);</li><li>
</li><li><span class="hljs-variable">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeControllerParams</span> {</li><li>  <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span>;</li><li>  <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchNodeController</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span> = <span class="hljs-variable">NodeRenderType</span>.<span class="hljs-variable">RENDER_TYPE_DISPLAY</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">componentType</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">setRenderOption</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">NodeControllerParams</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">surfaceId</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">renderType</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">renderType</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">embedId</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">embedId</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentWidth</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">width</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentHeight</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">height</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentType</span> = <span class="hljs-variable">params</span>.<span class="hljs-keyword">type</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">BuilderNode</span>(<span class="hljs-variable">uiContext</span>, { <span class="hljs-variable">surfaceId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">surfaceId</span>, <span class="hljs-keyword">type</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">renderType</span> });</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">componentType</span> === <span class="hljs-string">'native/component'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>.<span class="hljs-title function_">build</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">searchBuilder</span>), { <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">componentWidth</span>, <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">componentHeight</span> });</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>.<span class="hljs-title function_">getFrameNode</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">setBuilderNode</span>(<span class="hljs-variable">rootNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;<span class="hljs-title class_">Params</span>[]&gt; | <span class="hljs-title class_">null</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span> = <span class="hljs-variable">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getBuilderNode</span>(): <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">undefined</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">updateNode</span>(<span class="hljs-variable">arg</span>: <span class="hljs-title class_">Object</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>?.<span class="hljs-title function_">update</span>(<span class="hljs-variable">arg</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getEmbedId</span>(): <span class="hljs-title class_">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">embedId</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">postEvent</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">TouchEvent</span> | <span class="hljs-title class_">undefined</span>): <span class="hljs-title class_">boolean</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">rootNode</span>?.<span class="hljs-title function_">postTouchEvent</span>(<span class="hljs-variable">event</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">boolean</span>;</li><li>  }</li><li>}</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SearchComponent</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">params</span>: <span class="hljs-title class_">Params</span>;</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">SearchController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SearchController</span>()</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>      <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_mall"</span>))</li><li>        .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body4'</span>))</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-variable">FONT_WEIGHT</span>)</li><li>        .<span class="hljs-title function_">fontFamily</span>(<span class="hljs-string">'HarmonyHeiTi-Medium'</span>)</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Search</span>({ <span class="hljs-variable">placeholder</span>: <span class="hljs-title class_">PLACEHOLDER</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>      .<span class="hljs-title function_">margin</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.integer.embed_row_margin"</span>))</li><li>
</li><li>      <span class="hljs-title function_">Grid</span>() {</li><li>        <span class="hljs-title function_">ForEach</span>(<span class="hljs-variable">PRODUCT_DATA</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">GridItem</span>() {</li><li>            <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>              <span class="hljs-title function_">Image</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">uri</span>).<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.integer.embed_image_size"</span>))</li><li>              <span class="hljs-title function_">Row</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">MARGIN_VERTICAL</span> }) {</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">title</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body1'</span>))</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>                  .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>                  .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-variable">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-title class_">Ellipsis</span> })</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>.<span class="hljs-variable">price</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_text_size_body1'</span>))</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)</li><li>                  .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>              }</li><li>            }</li><li>            .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_background'</span>))</li><li>            .<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>            .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>            .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>            .<span class="hljs-title function_">borderRadius</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_corner_radius_default_m'</span>))</li><li>          }</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ProductDataModel</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">index</span>.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">rowsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_elements_margin_vertical_m'</span>))</li><li>      .<span class="hljs-title function_">columnsGap</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_elements_margin_vertical_m'</span>))</li><li>      .<span class="hljs-title function_">width</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_full_percent"</span>))</li><li>      .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">"app.string.embed_sixty_percent"</span>))</li><li>      .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.ohos_id_card_margin_start'</span>))</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">width</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">params</span>.<span class="hljs-variable">height</span>)</li><li>  }</li><li>}</li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">searchBuilder</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">SearchComponent</span>({ <span class="hljs-variable">params</span>: <span class="hljs-title class_">params</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-variable">browserTabController</span>: <span class="hljs-title class_">WebviewController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">webview</span>.<span class="hljs-title function_">WebviewController</span>();</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">componentIdArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt; = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">nodeControllerMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">SearchNodeController</span>&gt; = <span class="hljs-variable">new</span> <span class="hljs-title function_">Map</span>();</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>, (<span class="hljs-variable">componentId</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>        <span class="hljs-title function_">NodeContainer</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>));</li><li>      }, (<span class="hljs-variable">embedId</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">embedId</span>)</li><li>      <span class="hljs-title function_">Web</span>({ <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>("<span class="hljs-title class_">embed_view</span>.<span class="hljs-title class_">html</span>"), <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">browserTabController</span> })</li><li>        .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.ohos_id_color_sub_background'</span>))</li><li>        .<span class="hljs-title function_">zoomAccess</span>(<span class="hljs-keyword">false</span>)</li><li>        .<span class="hljs-title function_">enableNativeEmbedMode</span>(<span class="hljs-keyword">true</span>)</li><li>        .<span class="hljs-title function_">onNativeEmbedLifecycleChange</span>((<span class="hljs-variable">embed</span>) =&gt; {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">componentId</span> = <span class="hljs-variable">embed</span>.<span class="hljs-variable">info</span>?.<span class="hljs-variable">id</span>?.<span class="hljs-title function_">toString</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">embed</span>.<span class="hljs-variable">status</span> === <span class="hljs-variable">NativeEmbedStatus</span>.<span class="hljs-variable">CREATE</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SearchNodeController</span>();</li><li>            <span class="hljs-variable">nodeController</span>.<span class="hljs-title function_">setRenderOption</span>({</li><li>              <span class="hljs-variable">surfaceId</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">surfaceId</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-keyword">type</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-keyword">type</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-variable">renderType</span>: <span class="hljs-title class_">NodeRenderType</span>.<span class="hljs-title class_">RENDER_TYPE_TEXTURE</span>,</li><li>              <span class="hljs-variable">embedId</span>: <span class="hljs-title class_">embed</span>.<span class="hljs-title class_">embedId</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">string</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">width</span>),</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">height</span>)</li><li>            });</li><li>            <span class="hljs-variable">nodeController</span>.<span class="hljs-title function_">rebuild</span>();</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">componentId</span>, <span class="hljs-variable">nodeController</span>);</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">componentId</span>);</li><li>          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">embed</span>.<span class="hljs-variable">status</span> === <span class="hljs-variable">NativeEmbedStatus</span>.<span class="hljs-variable">UPDATE</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">updateNode</span>({</li><li>              <span class="hljs-variable">text</span>: <span class="hljs-string">'update'</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">width</span>),</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">px2vp</span>(<span class="hljs-title class_">embed</span>.<span class="hljs-title class_">info</span>?.<span class="hljs-title class_">height</span>)</li><li>            } <span class="hljs-keyword">as</span> <span class="hljs-variable">ESObject</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">rebuild</span>();</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">setBuilderNode</span>(<span class="hljs-variable">null</span>);</li><li>            <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">rebuild</span>();</li><li>          }</li><li>        })</li><li>        .<span class="hljs-title function_">onNativeEmbedGestureEvent</span>((<span class="hljs-variable">touch</span>) =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">componentIdArr</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">componentId</span>: <span class="hljs-title class_">string</span>) =&gt; {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nodeController</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeControllerMap</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable">componentId</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">getEmbedId</span>() === <span class="hljs-variable">touch</span>.<span class="hljs-variable">embedId</span>) {</li><li>              <span class="hljs-variable">nodeController</span>?.<span class="hljs-title function_">postEvent</span>(<span class="hljs-variable">touch</span>.<span class="hljs-variable">touchEvent</span>);</li><li>            }</li><li>          })</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering/blob/master/entry/src/main/ets/pages/Index.ets#L16-L208" target="_blank">Index.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1020010917525">Web组件加载原生组件性能收益对比<i class="anchor-icon anchor-icon-link" anchorid="section1020010917525" tips="复制节点链接"></i></h2><p>本节以Web组件加载原生组件的场景，抓取Trace图进行分析。下面的Trace图上的红线处Web组件加载完成，蓝线处原生组件加载显示完成。</p> </div> <div class="tiledSection"><h3 id="section0584105917426" class="firsth2">使用非同层渲染加载<i class="anchor-icon anchor-icon-link" anchorid="section0584105917426" tips="复制节点链接"></i></h3><p><strong>图3 </strong>非同层渲染的Trace图</p> <p></p> <p><span><img height="323.6674481514879" originheight="487" originwidth="1414" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163014.82133525008114311817292773307400:50001231000000:2800:915B22CE2C7B8011B68519692597DCDBAD6605D97B6163B4150E13C219689CD9.png" title="点击放大" width="920"></span></p> <p>非同层渲染的分析：</p> <ul><li>在应用侧，红蓝线之间为测量和计算布局，图片加载被延后到了蓝线之外。</li><li>在render_service侧，蓝线之后每一帧ReceiveVsync的耗时大幅增加。</li></ul> </div> <div class="tiledSection"><h3 id="section64925374413">使用同层渲染加载<i class="anchor-icon anchor-icon-link" anchorid="section64925374413" tips="复制节点链接"></i></h3><p><strong>图4</strong> 同层渲染的Trace图</p> <p></p> <p><span><img height="332.67070422535204" originheight="497" originwidth="1417" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163015.52075251621955938941739818825836:50001231000000:2800:1567108B4B67E0ADA1192C5F4AEF82E79E389519E521375EC872CF85A33B249C.png" title="点击放大" width="920"></span></p> <p>同层渲染的分析：</p> <ul><li>在应用侧，红蓝线之间由于NodeContainer的原因，组件布局的测量和绘制划分成了两部分，同时将图片加载提前到了红蓝线之间。</li><li>在render_service侧，每一帧ReceiveVsync的耗时无明显变化。</li></ul> </div> <div class="tiledSection"><h3 id="section13531145519460">页面加载场景总结<i class="anchor-icon anchor-icon-link" anchorid="section13531145519460" tips="复制节点链接"></i></h3><p>下表为各种方法完成原生组件加载（蓝线）前后几帧render_service侧的耗时对比（-1为完成前一帧，1为完成后一帧，以此类推）</p> <p><span><img originheight="314" originwidth="372" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163015.19644982227744289149740172723972:50001231000000:2800:04E3C4EAEAE25BDA8BF6B5906B9BC3A711F1FC505985CED43F8AF6CA125D2781.png" width="372" height="314"></span></p> <p>从此表格可以看出，非同层渲染会导致render_service侧每帧耗时大幅提升，同层渲染相比起非同层渲染，并不影响render_service侧的每帧耗时。</p> </div> <div class="tiledSection"><h2 id="section1425182685617">列表滑动场景性能收益对比<i class="anchor-icon anchor-icon-link" anchorid="section1425182685617" tips="复制节点链接"></i></h2><p>本节以列表滑动场景，抓取Trace图进行分析。在此场景下，对比同层渲染和非同层渲染的每一帧的结构如下所示：</p> </div> <div class="tiledSection"><h3 id="section8766921195418" class="firsth2">使用非同层渲染<i class="anchor-icon anchor-icon-link" anchorid="section8766921195418" tips="复制节点链接"></i></h3><p><strong>图5</strong> 非同层渲染滑动时单帧图。</p> <p></p> <p><span><img height="332.02357388316153" originheight="493" originwidth="1419" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163015.27015791192316451400351261543413:50001231000000:2800:FBAB55C9904FF6ED3C953B4C532A9F847EA06CDE796962D9865C0E82E7481F51.png" title="点击放大" width="920"></span></p> </div> <div class="tiledSection"><h3 id="section62417138552">使用同层渲染<i class="anchor-icon anchor-icon-link" anchorid="section62417138552" tips="复制节点链接"></i></h3><p><strong>图6</strong> 同层渲染滑动时单帧图。</p> <p></p> <p><span><img height="337.20345721694036" originheight="503" originwidth="1400" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163015.23678639180918246566359686805058:50001231000000:2800:CB6A9F762DF7DC0926230323F113FE5AEEF876663F91F0BB71B97EE804C164C8.png" title="点击放大" width="920"></span></p> <p>上述两张图经过对比也可以发现，非同层渲染的render_service每一帧的耗时大幅增加，结论和上述保持一致，再次验证了同样的结果。</p> </div> <div class="tiledSection"><h2 id="section630682113579">总结<i class="anchor-icon anchor-icon-link" anchorid="section630682113579" tips="复制节点链接"></i></h2><p>在Web组件中渲染原生组件时，采用同层渲染方式比起非同层渲染可以将图片渲染提前到原生组件加载完成前，且同层渲染将位于同一个图层的元素一起渲染，降低绘制任务，提升了性能。同时使用同层渲染可以实现更多功能，比如根据尺寸调整组件大小等功能，从而避免繁琐操作。</p> </div> <div class="tiledSection"><h2 id="section1379834417209">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1379834417209" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/arkweb-same-level-rendering" target="_blank">ArkWeb同层渲染</a></li></ul> </div> </div> <div></div></div>