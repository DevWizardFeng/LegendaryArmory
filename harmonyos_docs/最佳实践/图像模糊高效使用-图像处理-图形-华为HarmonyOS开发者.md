<h1 _ngcontent-rtb-c119="" class="doc-title ng-star-inserted" title="图像模糊高效使用"> 图像模糊高效使用 </h1>

<div _ngcontent-rtb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7740113417285"><strong>概述</strong><i class="anchor-icon anchor-icon-link" anchorid="section7740113417285" tips="复制节点链接"></i></h2><p>在图像处理中，模糊效果（Blur Effect）是一种通过算法降低图像局部或整体的清晰度、减少细节或噪声的技术。模糊常用于突出主体、模拟景深、隐藏敏感信息或为后续处理（如边缘检测）做准备。</p> <p>本文介绍的背景模糊属于动态模糊，根据效果区分为材质模糊和普通模糊。背景模糊在实际应用中应用场景广泛，例如：在包含多个卡片的页面中，应用背景模糊效果可突出层次感；在页面转场时，添加背景模糊能使过渡更加平滑。为进一步提升效果，系统通过使用缓存技术优化动态模糊的性能。本文旨在探讨背景模糊技术的高效应用方法，结合应用场景进行说明。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="11.88%"><p>层次类型</p> </td> <td class="cellrowborder" valign="top" width="11.88%"><p>效果分类</p> </td> <td class="cellrowborder" valign="top" width="18.54%"><p>接口</p> </td> <td class="cellrowborder" valign="top" width="57.699999999999996%"><p>使用说明</p> </td> </tr> <tr><td class="cellrowborder" rowspan="3" valign="top" width="11.88%"><p>背景模糊</p> </td> <td class="cellrowborder" rowspan="2" valign="top" width="11.88%"><p>材质模糊</p> </td> <td class="cellrowborder" valign="top" width="18.54%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-background#backgroundblurstyle9" target="_blank">.backgroundBlurStyle()</a></p> </td> <td class="cellrowborder" valign="top" width="57.699999999999996%"><p>通过枚举值的方式封装了不同的模糊半径、亮度、饱和度、蒙版颜色。</p> <p>适用场景：通过设置枚举值来使用系统已经封装好的效果。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-background#backgroundeffect11" target="_blank">.backgroundEffect()</a></p> </td> <td class="cellrowborder" valign="top"><p>可以自定义模糊半径、亮度、饱和度、蒙版颜色、取色方式以及灰阶参数。</p> <p>适用场景：用户需要自定义效果的场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>普通模糊</p> </td> <td class="cellrowborder" valign="top"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-background#backdropblur" target="_blank">.backdropBlur()</a></p> </td> <td class="cellrowborder" valign="top"><p>仅能设置模糊半径和灰阶参数。</p> <p>适用场景：仅需设置模糊半径的场景，如：页面转场。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section13811417203414"><strong>实现原理</strong><i class="anchor-icon anchor-icon-link" anchorid="section13811417203414" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0444113843611" class="firsth2"><strong>系统渲染工作流程</strong><i class="anchor-icon anchor-icon-link" anchorid="section0444113843611" tips="复制节点链接"></i></h3><p><span><img originheight="60" originwidth="721" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.46091268711573563707448326753849:50001231000000:2800:D541C9D2555E36BBD2398E9624995CE2DCD2CECA38F7A0D857B0E87661E920DC.png" width="721" height="60"></span></p> <p><strong>RenderService (RS) ：</strong>系统渲染服务进程，接收来自于其他系统服务进程（如桌面进程）及用户进程（如应用）的自渲染图层及ArkUI控件绘制指令，进行统一的组合以及渲染控制。其渲染动作会调用CPU/GPU等通用计算器件进行。</p> </div> <div class="tiledSection"><h3 id="section15658019123614"><strong>RS模糊缓存工作流程</strong><i class="anchor-icon anchor-icon-link" anchorid="section15658019123614" tips="复制节点链接"></i></h3><p><span><img originheight="340" originwidth="900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.10888846158386071424537038660096:50001231000000:2800:16CDC7A730D5EEB7DDDB6725DD68DC5E437938B08266940C21F93ECB6E41140D.png" width="900" height="340"></span></p> <p><strong>RenderThread (RT) ：</strong>渲染线程，RS进程划分为主线程和RT线程，RT线程负责接收各种渲染参数，渲染各种图像效果并上屏。</p> <p>基本逻辑：根据需要创建或者刷新Drawable，同步模糊参数；做模糊先截图（生成截图的缓存），再做模糊（生成模糊的缓存），最多存在一份缓存（截图或者模糊结果）。</p> <p>（1）主线程：创建/刷新Drawable；判断模糊是否重绘：模糊区域改变、模糊参数改变、是否与脏区相交；同步模糊参数。</p> <p>（2）RT线程：如缓存有效则复用缓存，否则RT线程重做模糊，并重新缓存。</p> </div> <div class="tiledSection"><h2 id="section19917105834920"><strong>合理使用背景模糊的取色方式</strong><i class="anchor-icon anchor-icon-link" anchorid="section19917105834920" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section197321330125017" class="firsth2"><strong>场景描述</strong><i class="anchor-icon anchor-icon-link" anchorid="section197321330125017" tips="复制节点链接"></i></h3><p>如果需要设置背景模糊的蒙版颜色，有两种取色方式可以选择，这里推荐使用ColorPicker取色方式，性能更优。</p> <p><strong>效果图</strong></p> <p><span><img height="689.709405" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.29349802979368940941972336556560:50001231000000:2800:BEBEB990542B6C7F34FE550E9138B88C54E1EB0E74E00C53A2C9271C241A2009.png" title="点击放大" width="333.81829600000003"></span></p> </div> <div class="tiledSection"><h3 id="section2720112455110"><strong>实现原理</strong><i class="anchor-icon anchor-icon-link" anchorid="section2720112455110" tips="复制节点链接"></i></h3><p>如果要设置背景模糊的蒙版颜色，有如下两种取色方式：</p> <p>（1）方式1：直接设置AdaptiveColor.AVERAGE取色。此方式需要RS在CPU计算阶段，先用GPU绘制一遍取色区域，然后再计算区域平均颜色值。优点：开发方式简单，适合轻负载应用使用。缺点：性能较低。</p> <p><span><img originheight="344" originwidth="368" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.09305107324219235445933973843272:50001231000000:2800:F276C770795975CAC4A8F258165D3566A4EB292D567512E15C54761DE12E4D37.png" width="368" height="344"></span></p> <p>（2）方式2：创建ColorPicker取色。此方式先使用EffectKit接口创建ColorPicker进行取色，再赋值给模糊参数中的color属性。优点：由于绘制取色区域的过程在应用层进行，所以性能有所提升，适合静态模糊场景。</p> <p><span><img originheight="348" originwidth="292" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.16352384769320208600229379158670:50001231000000:2800:EB8FE31A58383A977320390E5893150F14EBC1FD5958F8EBC197E56171571735.png" class="notEnlarge" width="292" height="348"></span></p> </div> <div class="tiledSection"><h3 id="section17115830135110"><strong>开发步骤</strong><i class="anchor-icon anchor-icon-link" anchorid="section17115830135110" tips="复制节点链接"></i></h3></div> <p><strong>方式1：设置背景模糊的接口参数adaptiveColor为AdaptiveColor.AVERAGE</strong></p> <p>对背景图片应用backgroundEffect接口设置模糊效果，设置adaptiveColor属性值为AdaptiveColor.AVERAGE。</p> <p><strong>示例代码</strong></p> <div class="screenLinkPre"><div _ngcontent-rtb-c106="" class="highlight-div"><div _ngcontent-rtb-c106="" class="highlight-div-header"><div _ngcontent-rtb-c106="" class="highlight-div-header-left"><div _ngcontent-rtb-c106="" class="handle-button expand-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rtb-c106="" class="highlight-div-header-right"><div _ngcontent-rtb-c106="" class="handle-button ai-button"></div><div _ngcontent-rtb-c106="" class="handle-button line-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rtb-c106="" class="handle-button theme-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rtb-c106="" class="handle-button copy-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rtb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/AdaptiveColorMode.ets#L17-L46" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdaptiveColorMode</span> {</li><li>  @<span class="hljs-title function_">Consume</span>(<span class="hljs-string">'navPathStack'</span>) <span class="hljs-variable">navPathStack</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Flex</span>({ <span class="hljs-variable">alignItems</span>: <span class="hljs-title class_">ItemAlign</span>.<span class="hljs-title class_">Center</span>, <span class="hljs-variable">justifyContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-title class_">Center</span> }) {</li><li>          <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Background Material Blur'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#FFFFFF'</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'50%'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-comment">// just set the parameter adaptiveColor</span></li><li>        .<span class="hljs-title function_">backgroundEffect</span>({</li><li>          <span class="hljs-variable">radius</span>: <span class="hljs-number">20</span>,</li><li>          <span class="hljs-variable">saturation</span>: <span class="hljs-number">1.0</span>,</li><li>          <span class="hljs-variable">brightness</span>: <span class="hljs-number">1.0</span>,</li><li>          <span class="hljs-variable">adaptiveColor</span>: <span class="hljs-title class_">AdaptiveColor</span>.<span class="hljs-title class_">AVERAGE</span></li><li>        })</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-string">'15%'</span>, <span class="hljs-variable">y</span>: <span class="hljs-string">'30%'</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">backgroundImage</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.test'</span>))</li><li>      .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-variable">ImageSize</span>.<span class="hljs-variable">Cover</span>)</li><li>      .<span class="hljs-title function_">expandSafeArea</span>([<span class="hljs-variable">SafeAreaType</span>.<span class="hljs-variable">SYSTEM</span>], [<span class="hljs-variable">SafeAreaEdge</span>.<span class="hljs-variable">TOP</span>, <span class="hljs-variable">SafeAreaEdge</span>.<span class="hljs-variable">BOTTOM</span>])</li><li>    }</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-keyword">true</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/AdaptiveColorMode.ets#L17-L46" target="_blank">AdaptiveColorMode.ets</a></div></div></div></div> <p><strong>方式2：先使用ColorPicker进行取色，再给模糊接口的color参数赋值</strong></p> <p>传入图片资源，创建pixMap，根据pixMap创建ColorPicker，调用ColorPicker的getAverageColor()方法获取颜色，转换成backgroundEffect接口参数color的格式，调用接口时替换成获取到的blurColor。</p> <p><strong>示例代码</strong></p> <div class="screenLinkPre"><div _ngcontent-rtb-c106="" class="highlight-div"><div _ngcontent-rtb-c106="" class="highlight-div-header"><div _ngcontent-rtb-c106="" class="highlight-div-header-left"><div _ngcontent-rtb-c106="" class="handle-button expand-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rtb-c106="" class="highlight-div-header-right"><div _ngcontent-rtb-c106="" class="handle-button ai-button"></div><div _ngcontent-rtb-c106="" class="handle-button line-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rtb-c106="" class="handle-button theme-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rtb-c106="" class="handle-button copy-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rtb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/ColorPickerMode.ets#L17-L84" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">effectKit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkGraphics2D'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ColorPickerMode</span> {</li><li>  @<span class="hljs-title function_">Consume</span>(<span class="hljs-string">'navPathStack'</span>) <span class="hljs-variable">navPathStack</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">pixMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">kitColor</span>: <span class="hljs-title class_">effectKit</span>.<span class="hljs-title class_">Color</span> = {</li><li>    <span class="hljs-variable">red</span>: <span class="hljs-number">255</span>,</li><li>    <span class="hljs-variable">green</span>: <span class="hljs-number">255</span>,</li><li>    <span class="hljs-variable">blue</span>: <span class="hljs-number">255</span>,</li><li>    <span class="hljs-variable">alpha</span>: <span class="hljs-number">255</span></li><li>  };</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">blurColor</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'rgba(255,255,255,255)'</span>;</li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">blurPix</span>(<span class="hljs-variable">resource</span>: <span class="hljs-title class_">Resource</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">context</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">resourceMgr</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>    <span class="hljs-comment">// const fileData = await resourceMgr.getMediaContent(resource)</span></li><li>    <span class="hljs-variable">resourceMgr</span>.<span class="hljs-title function_">getMediaContent</span>(<span class="hljs-variable">resource</span>)</li><li>      .<span class="hljs-title function_">then</span>((<span class="hljs-variable">fileData</span>: <span class="hljs-title class_">Uint8Array</span>) =&gt; {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">buffer</span> = <span class="hljs-variable">fileData</span>.<span class="hljs-variable">buffer</span></li><li>        <span class="hljs-variable">imageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">buffer</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">ArrayBuffer</span>)</li><li>      })</li><li>      .<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, `<span class="hljs-variable">setPreferredOrientation</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span>=${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>=${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`)</li><li>      })</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">pixMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">imageSource</span>!.<span class="hljs-title function_">createPixelMap</span>();</li><li>    <span class="hljs-comment">// create a color picker for color extraction</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">kitColor</span> = (<span class="hljs-variable">await</span> <span class="hljs-variable">effectKit</span>.<span class="hljs-title function_">createColorPicker</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">pixMap</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])).<span class="hljs-title function_">getAverageColor</span>();</li><li>    <span class="hljs-comment">// convert to the format of the blur interface color parameter</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">blurColor</span> = <span class="hljs-string">'rgba('</span> + <span class="hljs-keyword">this</span>.<span class="hljs-variable">kitColor</span>.<span class="hljs-variable">red</span> + <span class="hljs-string">','</span> + <span class="hljs-keyword">this</span>.<span class="hljs-variable">kitColor</span>.<span class="hljs-variable">green</span> + <span class="hljs-string">','</span> + <span class="hljs-keyword">this</span>.<span class="hljs-variable">kitColor</span>.<span class="hljs-variable">blue</span> + <span class="hljs-string">',0)'</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Flex</span>({ <span class="hljs-variable">alignItems</span>: <span class="hljs-title class_">ItemAlign</span>.<span class="hljs-title class_">Center</span>, <span class="hljs-variable">justifyContent</span>: <span class="hljs-title class_">FlexAlign</span>.<span class="hljs-title class_">Center</span> }) {</li><li>          <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Background Material Blur'</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#FFFFFF'</span>)</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'50%'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)</li><li>        <span class="hljs-comment">// assign a value to the color parameter of a blur interface</span></li><li>        .<span class="hljs-title function_">backgroundEffect</span>({</li><li>          <span class="hljs-variable">radius</span>: <span class="hljs-number">20</span>,</li><li>          <span class="hljs-variable">saturation</span>: <span class="hljs-number">1.0</span>,</li><li>          <span class="hljs-variable">brightness</span>: <span class="hljs-number">1.0</span>,</li><li>          <span class="hljs-variable">color</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blurColor</span></li><li>        })</li><li>        .<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-string">'15%'</span>, <span class="hljs-variable">y</span>: <span class="hljs-string">'30%'</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">backgroundImage</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.test'</span>))</li><li>      .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-variable">ImageSize</span>.<span class="hljs-variable">Cover</span>)</li><li>      .<span class="hljs-title function_">onAppear</span>(() =&gt; {</li><li>        <span class="hljs-comment">// import image resources</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">blurPix</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.test'</span>));</li><li>      })</li><li>      .<span class="hljs-title function_">expandSafeArea</span>([<span class="hljs-variable">SafeAreaType</span>.<span class="hljs-variable">SYSTEM</span>], [<span class="hljs-variable">SafeAreaEdge</span>.<span class="hljs-variable">TOP</span>, <span class="hljs-variable">SafeAreaEdge</span>.<span class="hljs-variable">BOTTOM</span>])</li><li>    }</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-keyword">true</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/ColorPickerMode.ets#L17-L84" target="_blank">ColorPickerMode.ets</a></div></div></div></div> <p><strong>性能对比</strong></p> <p>测试使用两种取色方式绘制背景模糊效果的单帧渲染耗时，最终使用DevEco Studio内置的Profiler中的帧率分析工具Frame抓取绘制背景模糊时的性能差异。</p> <p><span><img height="475.6317706943415" originheight="806" originwidth="1559" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.67842602021491663991216396764549:50001231000000:2800:AD08F16C54208C98D83A543D92B4684D93E5E9B1D4C026BD301E129D365BB7DF.png" title="点击放大" width="920"></span></p> <p><span><img height="431.30554074074075" originheight="729" originwidth="1555" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.11325255855685985507218960913200:50001231000000:2800:14BD8B1696E564DCF62AA36FA5E2F60C3E5EF000EC53B53BBFBBB42C867AF419.png" title="点击放大" width="920"></span></p> <p>如上图所示，通过RenderFrame（执行GPU绘制）标签可以看出，使用ColorPicker取色的单帧平均耗时为5.650ms；而直接设置背景模糊的接口参数为AdaptiveColor.Average的单帧平均耗时为9.400ms。</p> <div class="tiledSection"><h2 id="section14181610125714"><strong>在背景模糊场景正确使用混合模式</strong><i class="anchor-icon anchor-icon-link" anchorid="section14181610125714" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1990815568572" class="firsth2"><strong>场景描述</strong><i class="anchor-icon anchor-icon-link" anchorid="section1990815568572" tips="复制节点链接"></i></h3><p>如果需要在背景模糊场景使用混合模式，需要结合实际场景选择合适的混合模式，才能得到预期的效果。以下是同一场景下使用两种不同的方式实现的效果图：</p> <p><span><img originheight="628" originwidth="654" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.63772182223868358716234900979868:50001231000000:2800:5CEBFF6198F72FA09B413E255C309506EB7B94532907FB10524F2F7776C0700E.png" width="654" height="628"></span></p> </div> <div class="tiledSection"><h3 id="section1969518617586"><strong>实现原理</strong><i class="anchor-icon anchor-icon-link" anchorid="section1969518617586" tips="复制节点链接"></i></h3><p><strong>BlendMode</strong><strong>（混合模式）：</strong>这是一种图形处理技术，用于控制两个或多个图层（或图形元素）在叠加时如何混合颜色。它决定了上层像素与下层像素的交互方式，从而产生不同的视觉效果。</p> <p>BlendMode的类型有两种：一种是FAST类型，另一种是OFFSCREEN类型。FAST类型使各个图层的效果按顺序进行混合，而OFFSCREEN类型使用离屏画布，组件内容先绘制到离屏画布上，然后再整体进行混合。</p> <p>因此当场景中同时存在BlendMode和背景模糊时，需要注意BlendMode的类型。BlendMode设置为OFFSCREEN类型时使用离屏画布进行绘制，而模糊处理过程需要对背景进行截图，如果离屏画布未完成绘制，模糊流程已经进行了对背景的截图并绘制，那么绘制结果可能是非预期的。</p> <p>两种类型的差异见下图：</p> <p><span><img originheight="455" originwidth="658" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163052.92483875042073604753736280721498:50001231000000:2800:9C4E6E797018D1CE61FC3BD448F66F1DB3C06DC1ECCD957A467B8725B417A016.png" width="658" height="455"></span></p> </div> <div class="tiledSection"><h3 id="section15692912145818"><strong>开发步骤</strong><i class="anchor-icon anchor-icon-link" anchorid="section15692912145818" tips="复制节点链接"></i></h3><p>如果想得到最底层是背景图片，其上是地图，在地图上叠加模糊的效果，应使用FAST方式。</p> <p><strong>预期效果图</strong></p> <p><span><img height="686.207116" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.13738214347154305052795561258218:50001231000000:2800:8885E25C65CECDEB09C04844716D34F460F8CAB1102A88DF7DD20BCBFB6A74CE.png" title="点击放大" width="332.1675"></span></p> </div> <p>设置blendMode为FAST类型使各个图层的效果按顺序进行混合，所以可以实现预期的效果。</p> <p><strong>示例代码</strong></p> <div class="screenLinkPre"><div _ngcontent-rtb-c106="" class="highlight-div"><div _ngcontent-rtb-c106="" class="highlight-div-header"><div _ngcontent-rtb-c106="" class="highlight-div-header-left"><div _ngcontent-rtb-c106="" class="handle-button expand-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rtb-c106="" class="highlight-div-header-right"><div _ngcontent-rtb-c106="" class="handle-button ai-button"></div><div _ngcontent-rtb-c106="" class="handle-button line-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rtb-c106="" class="handle-button theme-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rtb-c106="" class="handle-button copy-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rtb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/FastMode.ets#L17-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>export struct FastMode {</li><li>  <span class="hljs-variable">@Consume</span>(<span class="hljs-string">'navPathStack'</span>) <span class="hljs-attribute">navPathStack</span>: NavPathStack;</li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">NavDestination</span>() {</li><li>      <span class="hljs-selector-tag">Stack</span>() {</li><li>        <span class="hljs-selector-tag">Stack</span>() {</li><li>          <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.map'</span>))<span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">15</span>)</li><li>          <span class="hljs-selector-tag">Flex</span>({ <span class="hljs-attribute">direction</span>: FlexDirection.ColumnReverse }) {</li><li>          }</li><li>          .<span class="hljs-built_in">height</span>(<span class="hljs-number">80</span>)</li><li>          .<span class="hljs-built_in">backgroundBlurStyle</span>(BlurStyle.COMPONENT_ULTRA_THIN, { <span class="hljs-attribute">scale</span>: <span class="hljs-number">0.3</span> })</li><li>          .<span class="hljs-built_in">flexShrink</span>(<span class="hljs-number">0</span>)</li><li>          .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-built_in">padding</span>(<span class="hljs-number">0</span>)</li><li>          .<span class="hljs-built_in">borderRadius</span>({</li><li>            <span class="hljs-attribute">topLeft</span>: <span class="hljs-number">0</span>,</li><li>            <span class="hljs-attribute">topRight</span>: <span class="hljs-number">0</span>,</li><li>            <span class="hljs-attribute">bottomLeft</span>: <span class="hljs-number">15</span>,</li><li>            <span class="hljs-attribute">bottomRight</span>: <span class="hljs-number">15</span></li><li>          })</li><li>          .<span class="hljs-built_in">position</span>({ <span class="hljs-attribute">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">y</span>: <span class="hljs-number">220</span> })</li><li>        }.<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-string">'16'</span>, <span class="hljs-attribute">right</span>: <span class="hljs-string">'16'</span> })</li><li>        .<span class="hljs-built_in">height</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-built_in">borderRadius</span>(<span class="hljs-number">15</span>)</li><li>        <span class="hljs-comment">// blend mode is set to fast mode</span></li><li>        .<span class="hljs-built_in">blendMode</span>(BlendMode.SRC_OVER, BlendApplyType.FAST)</li><li>      }</li><li>      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-built_in">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-built_in">backgroundImage</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.img'</span>))</li><li>      .<span class="hljs-built_in">backgroundImageSize</span>(ImageSize.Cover)</li><li>      .<span class="hljs-built_in">expandSafeArea</span>([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])</li><li>    }</li><li>    .<span class="hljs-built_in">hideTitleBar</span>(true)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/FastMode.ets#L17-L54" target="_blank">FastMode.ets</a></div></div></div></div> <p><strong>非预期效果图</strong></p> <p>如果使用OFFSCREEN方式，将得到非预期的效果：背景模糊对背景图片进行模糊，而后与地图的图层进行效果混合。</p> <p><span><img height="686.9193309999999" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.97414329833252403983944955291015:50001231000000:2800:AD310126A4B37C2DF90738331DE4C271FAD72E9462BC55BEE6D2990B5A0D7B0B.png" title="点击放大" width="332.49468"></span></p> <p>设置blendMode为OFFSCREEN类型会创建离屏画布，而模糊处理过程需要对背景进行截图，当离屏画布未完成绘制回到屏幕上时，模糊流程已经进行了背景的截图并绘制，所以混合后的效果非预期。</p> <p><strong>示例代码</strong></p> <div class="screenLinkPre"><div _ngcontent-rtb-c106="" class="highlight-div"><div _ngcontent-rtb-c106="" class="highlight-div-header"><div _ngcontent-rtb-c106="" class="highlight-div-header-left"><div _ngcontent-rtb-c106="" class="handle-button expand-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rtb-c106="" class="highlight-div-header-right"><div _ngcontent-rtb-c106="" class="handle-button ai-button"></div><div _ngcontent-rtb-c106="" class="handle-button line-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rtb-c106="" class="handle-button theme-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rtb-c106="" class="handle-button copy-button"><div _ngcontent-rtb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rtb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/OffscreenMode.ets#L17-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>export struct OffscreenMode {</li><li>  <span class="hljs-variable">@Consume</span>(<span class="hljs-string">'navPathStack'</span>) <span class="hljs-attribute">navPathStack</span>: NavPathStack;</li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">NavDestination</span>() {</li><li>      <span class="hljs-selector-tag">Stack</span>() {</li><li>        <span class="hljs-selector-tag">Stack</span>() {</li><li>          <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.map'</span>))<span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">15</span>)</li><li>          <span class="hljs-selector-tag">Flex</span>({ <span class="hljs-attribute">direction</span>: FlexDirection.ColumnReverse }) {</li><li>          }</li><li>          .<span class="hljs-built_in">height</span>(<span class="hljs-number">80</span>)</li><li>          .<span class="hljs-built_in">backgroundBlurStyle</span>(BlurStyle.COMPONENT_ULTRA_THIN, { <span class="hljs-attribute">scale</span>: <span class="hljs-number">0.3</span> })</li><li>          .<span class="hljs-built_in">flexShrink</span>(<span class="hljs-number">0</span>)</li><li>          .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-built_in">padding</span>(<span class="hljs-number">0</span>)</li><li>          .<span class="hljs-built_in">borderRadius</span>({</li><li>            <span class="hljs-attribute">topLeft</span>: <span class="hljs-number">0</span>,</li><li>            <span class="hljs-attribute">topRight</span>: <span class="hljs-number">0</span>,</li><li>            <span class="hljs-attribute">bottomLeft</span>: <span class="hljs-number">15</span>,</li><li>            <span class="hljs-attribute">bottomRight</span>: <span class="hljs-number">15</span></li><li>          })</li><li>          .<span class="hljs-built_in">position</span>({ <span class="hljs-attribute">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">y</span>: <span class="hljs-number">220</span> })</li><li>        }.<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-string">'16'</span>, <span class="hljs-attribute">right</span>: <span class="hljs-string">'16'</span> })</li><li>        .<span class="hljs-built_in">height</span>(<span class="hljs-number">300</span>)</li><li>        .<span class="hljs-built_in">borderRadius</span>(<span class="hljs-number">15</span>)</li><li>        <span class="hljs-comment">// blend mode is set to offscreen mode</span></li><li>        .<span class="hljs-built_in">blendMode</span>(BlendMode.SRC_OVER, BlendApplyType.OFFSCREEN)</li><li>      }</li><li>      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-built_in">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-built_in">backgroundImage</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.img'</span>))</li><li>      .<span class="hljs-built_in">backgroundImageSize</span>(ImageSize.Cover)</li><li>      .<span class="hljs-built_in">expandSafeArea</span>([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])</li><li>    }</li><li>    .<span class="hljs-built_in">hideTitleBar</span>(true)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BackgroundBlur/entry/src/main/ets/pages/OffscreenMode.ets#L17-L54" target="_blank">OffscreenMode.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1728154784211"><strong>总结</strong><i class="anchor-icon anchor-icon-link" anchorid="section1728154784211" tips="复制节点链接"></i></h2><p>本文针对系统的背景模糊特性，深度解析其技术原理与实现机制，并基于不同应用场景提出高效实施方案。在涉及取色功能的开发场景中，建议开发者通过性能开销和视觉效果的量化评估，选择最优实现方案；对于需要使用混合模式进行上下层图层混合的场景，开发者应当结合混合模式和背景模糊的工作原理，选择合适的混合类型。</p> </div> <div class="tiledSection"><h2 id="section2073012194317"><strong>示例代码</strong><i class="anchor-icon anchor-icon-link" anchorid="section2073012194317" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/BackgroundBlur" target="_blank">背景模糊示例</a></li></ul> </div> </div> <div></div></div>