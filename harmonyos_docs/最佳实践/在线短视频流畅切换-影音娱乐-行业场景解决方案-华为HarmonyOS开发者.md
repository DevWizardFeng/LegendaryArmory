<h1 _ngcontent-aam-c119="" class="doc-title ng-star-inserted" title="在线短视频流畅切换"> 在线短视频流畅切换 </h1>

<div _ngcontent-aam-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section77440332148">概述<i class="anchor-icon anchor-icon-link" anchorid="section77440332148" tips="复制节点链接"></i></h2><p>在短视频应用中，用户在快速切换视频时，新视频起播容易出现时延过长的问题。针对该问题，本文提供了如下解决方案：</p> <p></p> <ul><li>视频播放框架AVPlayer和滑块视图容器Swiper进行短视频滑动轮播切换。</li><li>绘制组件XComponent的Surface类型动态渲染视频流。</li><li>使用LazyForEach进行数据懒加载，设置cachedCount属性指定缓存数量，搭配组件复用能力以提升性能。冷启动时创建并初始化AVPlayer到prepared阶段。轮播过程中，每次异步创建一个播放器为下一个视频播放做准备。</li></ul> <p>实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-delay#section12851131281914" target="_blank">在线短视频类应用的快速切换与快速起播</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果使用自研播放器引擎而非AVPlayer，也可以参考该解决方案思路实现优化。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section108881233201612">效果展示<i class="anchor-icon anchor-icon-link" anchorid="section108881233201612" tips="复制节点链接"></i></h2><div class="fignone"><span class="figcap"><b>图1 </b><strong>在线短视频滑动切换效果图</strong></span><p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163341.23987995491722177469111666902452:50001231000000:2800:A9DE0DF669CB6C55F063B4E3A32CD698C06E3958C23E041233AC2BF1A69675DF.gif" title="点击放大" width="266"></span></p> </div> </div> <div class="tiledSection"><h2 id="section103791147151710">场景说明<i class="anchor-icon anchor-icon-link" anchorid="section103791147151710" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section24464124187" class="firsth2">适用范围<i class="anchor-icon anchor-icon-link" anchorid="section24464124187" tips="复制节点链接"></i></h3><p>适用于应用中在线短视频快速切换的场景，该场景下可能会出现播放起始延迟。</p> </div> <div class="tiledSection"><h3 id="section995371121918">场景体验指标<i class="anchor-icon anchor-icon-link" anchorid="section995371121918" tips="复制节点链接"></i></h3><p>起播时延计时标准</p> <p>1、以用户滑动屏幕后抬手、手指离屏的时刻为起点，以视频第二帧画面显示的时刻为终点。</p> <p>2、转场动画时长建议设置为300ms。</p> <p>3、在动画开始时使用预先准备的播放器起播，起播时延不超过230ms。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>描述</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>应用内滑动视频，新视频起播时延应≤230ms。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>类型</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>规则</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>适用设备</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>手机、折叠屏、平板</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>说明</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>无</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1870418298199">场景分析<i class="anchor-icon anchor-icon-link" anchorid="section1870418298199" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section18497839111418" class="firsth2">典型场景及优化方案<i class="anchor-icon anchor-icon-link" anchorid="section18497839111418" tips="复制节点链接"></i></h3><p><strong>典型场景描述</strong></p> <p>短视频：以小于5分钟的短视频为例进行说明。</p> <ol><li>应用内滑动视频，新视频起播时延≤230ms（不包含滑动动画效果耗时）。</li><li>起点时间：松手时的时间。</li><li>终点时间：视频内容开始播放，画面首次变化的时间。</li></ol> <p><strong>场景优化方案</strong></p> </div> <p>AVPlayer：</p> <ol><li>数据懒加载<p>冷启动时创建第一个播放器，播放当前视频时预加载下一个视频（预加载会增加用户流量消耗，需开发者自行决策）。使用XComponent的Surface类型动态渲染视频流，LazyForEach进行数据懒加载，设置cachedCount属性指定缓存数量。结合组件复用能力，以达到高性能效果。</p> </li><li>异步在线视频预加载<p>在轮播过程中，对下一个视频提前进入AVPlayer的prepared状态。</p> </li><li>在线视频播放预接力<p>滑动过程中，手指离开屏幕时，滑动动效开始播放。此时，可以调用AVPlayer的play方法进行播放。</p> </li></ol> <p>三方自研播放器：</p> <ol><li>数据懒加载<p>同上文AVPlayer的数据懒加载方案一致。</p> </li><li>异步在线视频预加载<p>在轮播过程中，对下一个视频提前初始化播放器所需内容（视频源下载、AudioRender初始化、解码器初始化等），并对视频提前预解析首帧画面。</p> </li><li>在线视频播放预接力<p>滑动过程中，手指离开屏幕时，滑动动效开始播放。在动效开始时，可以调用播放引擎进行播放。为了保证用户的起播体验，在前几帧画面送显时应优先送显，而不是等待AudioRender写入音频数据。由于音频硬件时延大于显示时延，播放起始几帧建议不要做强音画同步，而是采用慢追帧策略进行同步，视频帧稍微增大送显间隔，直到完成音画同步。</p> </li></ol> <div class="tiledSection"><h2 id="section12914256122011">场景实现<i class="anchor-icon anchor-icon-link" anchorid="section12914256122011" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6228315142117" class="firsth2">场景整体介绍<i class="anchor-icon anchor-icon-link" anchorid="section6228315142117" tips="复制节点链接"></i></h3><p>基于AVPlayer实现了在线流媒体的短视频流畅播放和控制功能。使用滑块视图容器Swiper进行短视频滑动轮播切换，使用XComponent的Surface类型动态渲染视频流并实现懒加载，最终实现短视频快速切换，起播时间≤230ms。提供开发者解决此类问题的方案。</p> </div> <div class="fignone"><span class="figcap"><b>图2 </b><strong>功能时序图</strong></span><p><span><img height="465.065356" originheight="688" originwidth="959" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163341.11647225224431115281272418860288:50001231000000:2800:A431D91028079383CCF8E654C3718B4C26B8CD488CE0586BFF6F7FF12EE6E2F1.png" title="点击放大" width="645.3825"></span></p> </div> <div class="tiledSection"><h3 id="section916116133237">在线短视频快速切换<i class="anchor-icon anchor-icon-link" anchorid="section916116133237" tips="复制节点链接"></i></h3><div class="fignone"><span class="figcap"><b>图3 </b><strong>实现流程图</strong></span><p><span><img height="414.689611" originheight="689" originwidth="1352" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163342.60753875945609182495152593658641:50001231000000:2800:9992D7EFC6DD8E9C74DAC7020FECF13FFAE96D46F7EB38E46C9D95F8F7747F2A.png" title="点击放大" width="804.9825000000001"></span></p> </div> <p><strong>关键点</strong></p> <p><strong>AVPlayer</strong></p> <p>AVPlayer可以将Audio/Video媒体资源（比如mp4/mp3/mkv/mpeg-ts等）转码为可供渲染的图像和可听见的音频模拟信号，并通过输出设备进行播放。</p> <p><strong>LazyForEach数据懒加载</strong></p> <p>LazyForEach懒加载可以通过设置cachedCount属性来指定缓存数量（目前设置为3），同时搭配组件复用能力以达到高性能效果。</p> <p>每次都会创建新的SurfaceID和AVPlayer，不共用已有的SurfaceID和AVPlayer，进而将提前加载好的视频（prepared阶段）放入缓存池中。</p> <p>在通过Swiper切换时，会根据当前轮询滑动的窗口索引index到缓存池中找到对应的视频（prepared阶段），直接进行播放，从而提高切换性能。</p> <div class="fignone"><span class="figcap"><b>图4 </b><strong>视频懒加载示意图</strong></span><br><span><img height="416.95500000000004" originheight="558" originwidth="762" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163342.57238766599456559434372635004228:50001231000000:2800:74252DAE19AE8F94CD8F9F5A9A9AE773E5A976231C0AF898EB16BA02A4EA1006.png" title="点击放大" width="569.406915"></span></div> <p><strong>异步视频预加载</strong></p> <p>异步视频预加载：在Swiper轮播过程中，在播放当前视频时，提前加载好下一个视频，在缓存中同时存在多个播放器实例，根据视频当前的索引来确定使用缓存中的哪个播放器来播放，从而达到流畅切换的效果。</p> <p>（1）本地播放一个短视频的耗时。</p> <div class="fignone"><span class="figcap"><b>图5 </b><strong>单视频加载示意图</strong></span><br><span><img height="341.63577000000004" originheight="348" originwidth="722" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163342.56856059197070294886205506646543:50001231000000:2800:57F8F744639613AE993DD52625263350B11C5FAF6C3130A8E3C17B597E85F0EC.png" title="点击放大" width="708.796634"></span></div> <p>（2）播放视频A时，提前预加载视频B。切换短视频时，可以立即播放已预加载的视频B，从而减少切换时间，提升切换性能。</p> <div class="fignone"><span class="figcap"><b>图6 </b><strong>异步视频预加载示意图</strong></span><br><span><img height="416.0905000000001" originheight="620" originwidth="1189" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163342.13665219407932203299735715676716:50001231000000:2800:70A17EDEA4C8770C9EF0BA64C2D3620EC0172F1E07C2F1291AE96A7050CAF77B.png" title="点击放大" width="798"></span></div> <p></p> <p><strong>视频播放预启动接力</strong></p> <p>为了提升滑动播放体验，动效开始时即启动播放，实现动效与播放并行：</p> <p>（1）在收到AnimationStart回调时开始播放，而不是在动效结束后再播放。</p> <p>（2）不要使用默认的弹簧曲线（弹簧动效持续560毫秒，而视频窗口在400毫秒左右已完全展开，最后150毫秒的位移变化较小）。可以将曲线改为Curve.Ease，并将持续时间设置为300毫秒（具体时间根据APP UX确定）。</p> <p>视频播放预启动接力：这种预加载机制的工作方式类似于接力赛跑。为了尽快完成接力，当第一个选手接近终点时，第二个选手会提前起跑并与第一个选手完美交接接力棒，从而减少整个接力赛的时间。短视频切换也是如此，如下图所示：</p> <div class="fignone"><span class="figcap"><b>图7 </b><strong>视频播放预启动接力</strong><strong>示意图</strong></span><br><span><img height="439.6049" originheight="633" originwidth="1149" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163342.30355534242398531342354546702745:50001231000000:2800:CD514E7520DBF5F8542006BDBBAB896F6E55C8E72A966C12207FE2446AAC63CE.png" title="点击放大" width="798"></span></div> <p><strong>开发步骤</strong></p> <ol><li>通过组件复用实现单个视频播放的自定义组件VideoPlayView。<div class="screenLinkPre"><div _ngcontent-aam-c106="" class="highlight-div"><div _ngcontent-aam-c106="" class="highlight-div-header"><div _ngcontent-aam-c106="" class="highlight-div-header-left"><div _ngcontent-aam-c106="" class="handle-button expand-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aam-c106="" class="highlight-div-header-right"><div _ngcontent-aam-c106="" class="handle-button ai-button"></div><div _ngcontent-aam-c106="" class="handle-button line-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aam-c106="" class="handle-button theme-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aam-c106="" class="handle-button copy-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aam-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L27-L407" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Key point: Reuse custom video playback components by using the @Reusable decorator.</span></li><li><span class="hljs-variable">@Reusable</span></li><li><span class="hljs-variable">@Component</span></li><li>export struct VideoPlayView {</li><li>  <span class="hljs-variable">@Prop</span> <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onIndexChange'</span>) <span class="hljs-attribute">curIndex</span>: number = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L27-L407" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>在自定义组件VideoPlayView中，设置XComponent组件用于视频流渲染，并获取SurfaceID以设置显示画面。在onLoad时，异步创建并初始化AVPlayer播放器，使其提前进入prepared状态，实现视频的异步预加载。</p> <div class="screenLinkPre"><div _ngcontent-aam-c106="" class="highlight-div"><div _ngcontent-aam-c106="" class="highlight-div-header"><div _ngcontent-aam-c106="" class="highlight-div-header-left"><div _ngcontent-aam-c106="" class="handle-button expand-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aam-c106="" class="highlight-div-header-right"><div _ngcontent-aam-c106="" class="handle-button ai-button"></div><div _ngcontent-aam-c106="" class="handle-button line-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aam-c106="" class="handle-button theme-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aam-c106="" class="handle-button copy-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aam-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L157-L170" data-highlighted="yes"><ol class="linenums"><li>XComponent({</li><li>  id: <span class="hljs-string">'player'</span>,</li><li>  type: XComponentType.SURFACE,</li><li>  controller: <span class="hljs-keyword">this</span>.xComponentController</li><li>})</li><li>  .width(<span class="hljs-keyword">this</span>.XComponentWidth)</li><li>  .height(<span class="hljs-keyword">this</span>.XComponentHeight)</li><li>  .onLoad(async () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.surfaceID = <span class="hljs-keyword">this</span>.xComponentController.getXComponentSurfaceId();</li><li>    hilog.info(<span class="hljs-number">0x0000</span>, TAG,</li><li>      `surfaceID: ${<span class="hljs-keyword">this</span>.surfaceID}, curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}.`);</li><li>    <span class="hljs-comment">// Key point: Initialize the AVPlayer asynchronously so that the AVPlayer enters the prepared state in advance to implement asynchronous video preloading.</span></li><li>    <span class="hljs-keyword">this</span>.initAVPlayer();</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L157-L170" target="_blank">VideoPlayView.ets</a></div></div></div></div> </li><li>在Swiper组件中使用LazyForEach懒加载自定义组件VideoPlayView，实现视频轮播。<p>通过LazyForEach懒加载VideoPlayView自定义组件，确保每个视频拥有独立的SurfaceID和AVPlayer。</p> <p>通过设置cachedCount属性，在XComponent的onLoad中异步初始化AVPlayer，使视频提前进入prepared状态，实现异步预加载。</p> <p>视频切换时，在onAnimationStart阶段更新当前窗口索引curIndex，开始播放下一个视频，实现预接力播放。</p> <p>设置弹簧曲线为.curve(Curve.Ease)。</p> <div class="screenLinkPre"><div _ngcontent-aam-c106="" class="highlight-div"><div _ngcontent-aam-c106="" class="highlight-div-header"><div _ngcontent-aam-c106="" class="highlight-div-header-left"><div _ngcontent-aam-c106="" class="handle-button expand-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aam-c106="" class="highlight-div-header-right"><div _ngcontent-aam-c106="" class="handle-button ai-button"></div><div _ngcontent-aam-c106="" class="handle-button line-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aam-c106="" class="handle-button theme-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aam-c106="" class="handle-button copy-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aam-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/pages/Index.ets#L56-L88" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Swiper</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperController</span>) {</li><li>  <span class="hljs-comment">// Key point: Use LazyForEach to create an independent SurfaceID in the VideoPlayView component. (The AVPlayer is created in the VideoPlayView and does not share the AVPlayer.)</span></li><li>  <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">AVDataSource</span>(<span class="hljs-variable">Const</span>.<span class="hljs-variable">VIDEO_SOURCE</span>), (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-title function_">VideoPlayView</span>({</li><li>      <span class="hljs-variable">curSource</span>: <span class="hljs-title class_">item</span>,</li><li>      <span class="hljs-variable">curIndex</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">curIndex</span>,</li><li>      <span class="hljs-variable">index</span>: <span class="hljs-title class_">index</span>,</li><li>      <span class="hljs-variable">firstFlag</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">firstFlag</span>,</li><li>      <span class="hljs-variable">isPageShow</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isPageShow</span>,</li><li>      <span class="hljs-variable">foldStatus</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">foldStatus</span></li><li>    })</li><li>  }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">item</span>) + <span class="hljs-variable">index</span>)</li><li>}</li><li><span class="hljs-comment">// Key point: Set cachedCount to implement preloading.</span></li><li>.<span class="hljs-title function_">cachedCount</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">firstFlag</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">2</span>)</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>.<span class="hljs-title function_">vertical</span>(<span class="hljs-keyword">true</span>)</li><li>.<span class="hljs-title function_">loop</span>(<span class="hljs-keyword">true</span>)</li><li><span class="hljs-comment">// Key point: Change the spring curve to Curve.Ease.</span></li><li>.<span class="hljs-title function_">curve</span>(<span class="hljs-variable">Curve</span>.<span class="hljs-variable">Ease</span>)</li><li>.<span class="hljs-title function_">duration</span>(<span class="hljs-number">300</span>)</li><li>.<span class="hljs-title function_">indicator</span>(<span class="hljs-keyword">false</span>)</li><li>.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>)</li><li>.<span class="hljs-title function_">onGestureSwipe</span>((<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">extraInfo</span>: <span class="hljs-title class_">SwiperAnimationEvent</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onGestureSwipe</span> <span class="hljs-variable">index</span>: ${<span class="hljs-variable">index</span>}, <span class="hljs-variable">extraInfo</span>: ${<span class="hljs-variable">extraInfo</span>}.`);</li><li>})</li><li>.<span class="hljs-title function_">onAnimationStart</span>((<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">targetIndex</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">extraInfo</span>: <span class="hljs-title class_">SwiperAnimationEvent</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>,</li><li>    `<span class="hljs-variable">onAnimationStart</span> <span class="hljs-variable">index</span>: ${<span class="hljs-variable">index</span>}, <span class="hljs-variable">targetIndex</span>: ${<span class="hljs-variable">targetIndex</span>}, <span class="hljs-variable">extraInfo</span>: ${<span class="hljs-variable">extraInfo</span>}.`);</li><li>  <span class="hljs-comment">// Key point: The curIndex is updated at AnimationStart and the next video starts to be played.</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">curIndex</span> = <span class="hljs-variable">targetIndex</span>;</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/pages/Index.ets#L56-L88" target="_blank">Index.ets</a></div></div></div></div> </li><li>视频播放预加载。<p>在自定义组件VideoPlayView中，使用@Watch装饰器监听Swiper轮播的curIndex值。</p> <div class="screenLinkPre"><div _ngcontent-aam-c106="" class="highlight-div"><div _ngcontent-aam-c106="" class="highlight-div-header"><div _ngcontent-aam-c106="" class="highlight-div-header-left"><div _ngcontent-aam-c106="" class="handle-button expand-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aam-c106="" class="highlight-div-header-right"><div _ngcontent-aam-c106="" class="handle-button ai-button"></div><div _ngcontent-aam-c106="" class="handle-button line-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aam-c106="" class="handle-button theme-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aam-c106="" class="handle-button copy-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aam-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L32-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Prop</span> <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onIndexChange'</span>) <span class="hljs-attribute">curIndex</span>: number = -<span class="hljs-number">1</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L32-L32" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>将视频缓存流中的index与curIndex进行比较，判断视频流中哪个视频播放，其余视频均暂停。</p> <div class="screenLinkPre"><div _ngcontent-aam-c106="" class="highlight-div"><div _ngcontent-aam-c106="" class="highlight-div-header"><div _ngcontent-aam-c106="" class="highlight-div-header-left"><div _ngcontent-aam-c106="" class="handle-button expand-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aam-c106="" class="highlight-div-header-right"><div _ngcontent-aam-c106="" class="handle-button ai-button"></div><div _ngcontent-aam-c106="" class="handle-button line-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aam-c106="" class="handle-button theme-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aam-c106="" class="handle-button copy-button"><div _ngcontent-aam-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aam-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L76-L122" data-highlighted="yes"><ol class="linenums"><li>onIndexChange() {</li><li>  hilog.info(<span class="hljs-number">0x0000</span>, TAG,</li><li>    `enter onIndexChange. curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}, isPageShow: ${<span class="hljs-keyword">this</span>.isPageShow}.`);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.curIndex !== <span class="hljs-keyword">this</span>.index) {</li><li>    pauseVideo(<span class="hljs-keyword">this</span>.avPlayer, <span class="hljs-keyword">this</span>.curIndex, <span class="hljs-keyword">this</span>.index);</li><li>    <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.trackThicknessSize = Const.TRACK_SIZE_MIN;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.info(<span class="hljs-number">0x0000</span>, TAG,</li><li>      `enter indexChange play. curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}, isPageShow: ${<span class="hljs-keyword">this</span>.isPageShow}.`);</li><li>    <span class="hljs-comment">// Key point: When the index(curIndex) of the current window is the same as the index of the this, the playback starts.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flag === <span class="hljs-literal">true</span>) {</li><li>      playVideo(<span class="hljs-keyword">this</span>.avPlayer, <span class="hljs-keyword">this</span>.curIndex, <span class="hljs-keyword">this</span>.index);</li><li>      <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">this</span>.trackThicknessSize = Const.TRACK_SIZE_MIN;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      let countNum = <span class="hljs-number">0</span>;</li><li>      let intervalFlag = setInterval(() =&gt; {</li><li>        countNum++;</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.curIndex !== <span class="hljs-keyword">this</span>.index) {</li><li>          hilog.info(<span class="hljs-number">0x0000</span>, TAG, `enter indexChange play error, clearIntreval. flag: ${<span class="hljs-keyword">this</span>.flag},</li><li>        curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}.`);</li><li>          clearInterval(intervalFlag);</li><li>        }</li><li>        <span class="hljs-comment">// 当视频处于prepared状态，并且页面可见时触发播放</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flag === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">this</span>.isPageShow) {</li><li>          countNum = <span class="hljs-number">0</span>;</li><li>          playVideo(<span class="hljs-keyword">this</span>.avPlayer, <span class="hljs-keyword">this</span>.curIndex, <span class="hljs-keyword">this</span>.index);</li><li>          <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-keyword">this</span>.trackThicknessSize = Const.TRACK_SIZE_MIN;</li><li>          clearInterval(intervalFlag);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          hilog.info(<span class="hljs-number">0x0000</span>, TAG, `enter indexChange play error, clearIntreval. countNum: ${countNum},</li><li>         flag: ${<span class="hljs-keyword">this</span>.flag}, curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}.`);</li><li>          <span class="hljs-keyword">if</span> (countNum &gt; <span class="hljs-number">15</span>) {</li><li>            hilog.info(<span class="hljs-number">0x0000</span>, TAG,</li><li>              `enter indexChange play error, reinit initAVPlayer. countNum: ${countNum}, flag: ${<span class="hljs-keyword">this</span>.flag},</li><li>            curIndex: ${<span class="hljs-keyword">this</span>.curIndex}, index: ${<span class="hljs-keyword">this</span>.index}.`);</li><li>            countNum = <span class="hljs-number">0</span>;</li><li>            <span class="hljs-keyword">this</span>.initAVPlayer();</li><li>          }</li><li>        }</li><li>      }, <span class="hljs-number">100</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos/blob/master/entry/src/main/ets/view/VideoPlayView.ets#L76-L122" target="_blank">VideoPlayView.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section2276653132015">总结<i class="anchor-icon anchor-icon-link" anchorid="section2276653132015" tips="复制节点链接"></i></h2><p>本文介绍数据懒加载、异步在线视频预加载及在线视频播放预接力等优化方案，帮助开发者解决快速切换播放延时问题。开发者可基于<a href="https://gitee.com/harmonyos_samples/SwipePlayer#工程主要模块结构" target="_blank">SwipePlayer</a> 库快速实现短视频流畅滑动的场景开发体验，可以更加聚焦实际场景业务的开发。</p> </div> <div class="tiledSection"><h2 id="section58227122578">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section58227122578" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/SmoothSwitchShortVideos" target="_blank">实现流畅切换短视频</a></li></ul> </div> </div> <div></div></div>