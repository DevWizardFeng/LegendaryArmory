<h1 _ngcontent-cvm-c119="" class="doc-title ng-star-inserted" title="地址越界类问题优化建议"> 地址越界类问题优化建议 </h1>

<div _ngcontent-cvm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section391984472619">优化建议1：增加返回值校验<i class="anchor-icon anchor-icon-link" anchorid="section391984472619" tips="复制节点链接"></i></h2></div> <p>在正常情况下，napi_get_value_string_utf8接口会在字符串末尾添加\0结束符；但若发生异常（如参数非法或类型不符），该接口会提前返回，导致缓冲区未被写入任何内容，也不会添加结束符。这可能导致申请的内存与实际使用不一致，从而引发越界错误。</p> <div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/napi_init.cpp#L24-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">GetStringParam1</span><span class="hljs-params">(napi_env env, napi_value arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> size;</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, arg, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;size);</li><li>    <span class="hljs-type">size_t</span> str_size = size + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">char</span> *buf = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[str_size];</li><li>    <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, arg, buf, str_size, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// 未进行校验</span></li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(buf)</span></span>;</li><li>    <span class="hljs-keyword">delete</span>[] buf;</li><li>    <span class="hljs-keyword">return</span> str;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/napi_init.cpp#L24-L34" target="_blank">napi_init.cpp</a></div></div></div></div> <p>建议：增加返回值校验。</p> <div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/napi_init.cpp#L42-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">GetStringParam2</span><span class="hljs-params">(napi_env env, napi_value arg)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> size;</li><li>    <span class="hljs-comment">// 增加校验</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf8</span>(env, arg, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;size) != napi_ok || size == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>    }</li><li>    <span class="hljs-type">size_t</span> str_size = size + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">char</span> *buf = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[str_size];</li><li>    <span class="hljs-comment">// 增加校验</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">napi_get_value_string_utf8</span>(env, arg, buf, str_size, <span class="hljs-literal">nullptr</span>) != napi_ok) {</li><li>        <span class="hljs-keyword">delete</span>[] buf;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;</li><li>    }</li><li>    <span class="hljs-function">std::string <span class="hljs-title">str</span><span class="hljs-params">(buf)</span></span>;</li><li>    <span class="hljs-keyword">delete</span>[] buf;</li><li>    <span class="hljs-keyword">return</span> str;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/napi_init.cpp#L42-L59" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section1639825610156">优化建议2：异步任务传递this引用<i class="anchor-icon anchor-icon-link" anchorid="section1639825610156" tips="复制节点链接"></i></h2></div> <p>当一个lambda表达式不止在局部作用域中使用，而是被传递到外部函数或另一个线程中时，禁止按引用（&amp;）捕获局部变量（包括 this）。<span style="color: rgb(29,29,26);">lambda按引用捕获就是把局部对象的引用存储起来，如果lambda的生命周期会超过局部变量生命周期，则可能导致内存不安全。</span></p> <div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo1.cpp#L29-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task1</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">Start</span>() {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>([<span class="hljs-keyword">this</span>]() {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_for</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-number">100</span>));</li><li>            <span class="hljs-title function_">DoWork</span>(); <span class="hljs-comment">// 如果 Task 已析构，这里是悬空调用</span></li><li>        }).<span class="hljs-title function_">detach</span>();</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">void</span> <span class="hljs-title function_">DoWork</span>() {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Doing work\n"</span>;</li><li>    }</li><li>
</li><li>    ~<span class="hljs-title function_">Task1</span>() {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">cout</span> &lt;&lt; <span class="hljs-string">"Task destructed\n"</span>;</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Run</span>() {</li><li>    <span class="hljs-variable">Task1</span>* <span class="hljs-variable">task</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Task1</span>();</li><li>    <span class="hljs-variable">task</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-variable">delete</span> <span class="hljs-variable">task</span>; <span class="hljs-comment">// 析构发生在 lambda 执行前</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_for</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-number">1</span>));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo1.cpp#L29-L52" target="_blank">task_demo1.cpp</a></div></div></div></div> <p>建议：</p> <ol><li>异步或跨线程场景中禁止使用[&amp;]捕获局部变量或this</li><li>采用智能指针管理对象生命周期结合weak_from_this获取弱指针，保证对象在访问时仍然有效。</li></ol> <p>实现步骤：</p> <ol><li>对象要从std::enable_shared_from_this继承。<div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L29-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task2</span> : <span class="hljs-keyword">public</span> <span class="hljs-title class_">std</span>::<span class="hljs-title class_">enable_shared_from_this</span>&lt;<span class="hljs-title class_">Task2</span>&gt; {</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L29-L29" target="_blank">task_demo2.cpp</a></div></div></div></div> </li><li>采用智能指针初始化对象。<div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L55-L55" data-highlighted="yes"><ol class="linenums"><li>   <span class="hljs-variable">auto</span> <span class="hljs-variable">task</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_shared</span>&lt;<span class="hljs-title class_">Task2</span>&gt;();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L55-L55" target="_blank">task_demo2.cpp</a></div></div></div></div> </li><li>lambda表达式中调用weak_from_this捕获this。<div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L38-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">Start</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">shared_ptr</span>&lt;<span class="hljs-title class_">Task2</span>&gt; <span class="hljs-title class_">task</span>)</li><li>{</li><li>   <span class="hljs-variable">auto</span> <span class="hljs-variable">weak</span> = <span class="hljs-variable">task</span>-&gt;<span class="hljs-title class_">weak_from_this</span>();</li><li>   <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>([<span class="hljs-title class_">weak</span>]() {</li><li>       <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_for</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">milliseconds</span>(<span class="hljs-number">100</span>));</li><li>       <span class="hljs-variable">auto</span> <span class="hljs-variable">strong</span> = <span class="hljs-variable">weak</span>.<span class="hljs-title function_">lock</span>();</li><li>       <span class="hljs-keyword">if</span> (!<span class="hljs-variable">strong</span>) {</li><li>           <span class="hljs-keyword">return</span>;</li><li>       }</li><li>       <span class="hljs-variable">strong</span>-&gt;<span class="hljs-title class_">DoWork</span>();</li><li>   }).<span class="hljs-title function_">detach</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/task_demo2.cpp#L38-L49" target="_blank">task_demo2.cpp</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ol><li>weak_from_this在C++17开始支持，且对象必须由智能指针管理，否则调用weak.lock()会为空，导致回调不执行。</li><li>如果无法使用weak_from_this，可用C++11支持的shared_from_this方式。</li></ol> </div></div></div> <div class="tiledSection"><h2 id="section1473209162917">优化建议3：指针操作前都增加判空处理，优先使用智能指针代替裸指针<i class="anchor-icon anchor-icon-link" anchorid="section1473209162917" tips="复制节点链接"></i></h2><p>主线程将指针销毁后，子线程依然对此指针变量进行操作导致的崩溃。</p> <div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_sanitizer_case3.cpp#L22-L37" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span>* g_ptr1 = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WorkerThread1</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));</li><li>    *g_ptr1 = <span class="hljs-number">24</span>; <span class="hljs-comment">// 子线程访问已释放的对象，UAF问题</span></li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Demo3</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    g_ptr1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>);</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(WorkerThread1)</span></span>;</li><li>    <span class="hljs-keyword">delete</span> g_ptr1; <span class="hljs-comment">// 主线程提前释放</span></li><li>    t.<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_sanitizer_case3.cpp#L22-L37" target="_blank">address_sanitizer_case3.cpp</a></div></div></div></div> <p>建议：</p> <ol><li>在指针销毁时，对指针置空。</li><li>在子线程对主线程的指针进行操作时，都增加判空处理，以此来避免子线程在主线程销毁时依旧执行后续操作。</li><li>建议使用智能指针代替裸指针。<div class="screenLinkPre"><div _ngcontent-cvm-c106="" class="highlight-div"><div _ngcontent-cvm-c106="" class="highlight-div-header"><div _ngcontent-cvm-c106="" class="highlight-div-header-left"><div _ngcontent-cvm-c106="" class="handle-button expand-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cvm-c106="" class="highlight-div-header-right"><div _ngcontent-cvm-c106="" class="handle-button ai-button"></div><div _ngcontent-cvm-c106="" class="handle-button line-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cvm-c106="" class="handle-button theme-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cvm-c106="" class="handle-button copy-button"><div _ngcontent-cvm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cvm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_sanitizer_case4.cpp#L22-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">int</span>* g_ptr2 = <span class="hljs-literal">nullptr</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WorkerThread2</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));</li><li>    <span class="hljs-keyword">if</span> (g_ptr2 != <span class="hljs-literal">nullptr</span>) { <span class="hljs-comment">// 判空处理</span></li><li>        *g_ptr2 = <span class="hljs-number">24</span>;</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Demo4</span><span class="hljs-params">()</span> </span>{</li><li>    g_ptr2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>);</li><li>    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(WorkerThread2)</span></span>;</li><li>    <span class="hljs-keyword">delete</span> g_ptr2; <span class="hljs-comment">// 主线程提前释放</span></li><li>    g_ptr2 = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// 指针置空</span></li><li>    t.<span class="hljs-built_in">join</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/address_sanitizer_case4.cpp#L22-L39" target="_blank">address_sanitizer_case4.cpp</a></div></div></div></div> </li></ol> </div> </div> <div></div></div>