<h1 _ngcontent-qua-c119="" class="doc-title ng-star-inserted" title="地址越界类问题案例"> 地址越界类问题案例 </h1>

<div _ngcontent-qua-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>本文按照<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-address-illegal-way">地址越界类问题分析方法</a>的流程展开，以实际案例的形式指导开发者如何从CppCrash日志出发，分析、定位，修复地址越界问题。开发者可阅读<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-ram-detection">地址越界类问题检测</a>了解系统检测地址越界问题的原理和机制。</p> <div class="tiledSection"><h2 id="section6663185144211">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section6663185144211" tips="复制节点链接"></i></h2><p>地址越界问题在应用的故障现象通常为应用崩溃，且仅通过CppCrash的调用栈难以定位到问题现场。</p> </div> <div class="tiledSection"><h2 id="section158981114434">分析过程<i class="anchor-icon anchor-icon-link" anchorid="section158981114434" tips="复制节点链接"></i></h2><p><strong>第一步 问题类型分析</strong></p> <p>当进程崩溃时，首先从faultlogger下获取CppCrash日志，明确Crash的类型，判断是否为地址越界问题。</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Generated</span> <span class="hljs-variable">by</span> <span class="hljs-variable">HiviewDFX</span>@<span class="hljs-title function_">OpenHarmony</span></li><li>================================================================</li><li><span class="hljs-variable">Device</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">HXX</span></li><li><span class="hljs-variable">Build</span> <span class="hljs-variable">info</span>:<span class="hljs-title class_">HAD</span>-<span class="hljs-title class_">W24</span> <span class="hljs-number">5.0</span><span class="hljs-number">.0.313</span>(<span class="hljs-title class_">C00E200R5P1log</span>)</li><li><span class="hljs-variable">Fingerprint</span>:<span class="hljs-number">89</span><span class="hljs-title class_">ae25972aa871bc94a3324de12f14d3367eb0be78c2e0229f96a4cf387bad45</span></li><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">ohos</span>.<span class="hljs-title class_">sceneboard</span></li><li><span class="hljs-variable">Version</span>:<span class="hljs-number">1.0</span><span class="hljs-number">.2.44</span></li><li><span class="hljs-variable">VersionCode</span>:<span class="hljs-number">10002044</span></li><li><span class="hljs-variable">PreInstalled</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Foreground</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">2025</span>-<span class="hljs-number">04</span>-<span class="hljs-number">07</span> <span class="hljs-number">17</span>:<span class="hljs-number">14</span>:<span class="hljs-number">10.834</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">3820</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020031</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">ohos</span>.<span class="hljs-title class_">sceneboard</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">life</span> <span class="hljs-variable">time</span>:<span class="hljs-number">6729</span><span class="hljs-title class_">s</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV_MAPERR</span>)@<span class="hljs-number">0x0045fadb69fb3553</span> </li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">3820</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">ohos</span>.<span class="hljs-title class_">sceneboard</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000</span><span class="hljs-variable">a5f83c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_compatible</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">AceType</span>::<span class="hljs-title class_">DynamicCast</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>, <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt;(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">40</span>)(<span class="hljs-variable">f9b03bc71db8776fed1a1bedec5c4048</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000286947</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_compatible</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">Framework</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-title class_">GetFramenodeByAccessibilityId</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">FrameNode</span>&gt; <span class="hljs-keyword">const</span>&amp;, <span class="hljs-title class_">long</span>)+<span class="hljs-number">464</span>)(<span class="hljs-variable">f9b03bc71db8776fed1a1bedec5c4048</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000287</span><span class="hljs-variable">c888</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_compatible</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">Framework</span>::<span class="hljs-title class_">JsAccessibilityManager</span>::<span class="hljs-title class_">FindNodeFromPipeline</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">WeakPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">PipelineBase</span>&gt; <span class="hljs-keyword">const</span>&amp;, <span class="hljs-title class_">long</span>)+<span class="hljs-number">172</span>)(<span class="hljs-variable">f9b03bc71db8776fed1a1bedec5c4048</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000002864</span><span class="hljs-variable">d4c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_compatible</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">Framework</span>::<span class="hljs-title class_">JsAccessibilityManager</span>::<span class="hljs-title class_">FindPipelineByElementId</span>(<span class="hljs-title class_">long</span>, <span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">FrameNode</span>&gt;&amp;)+<span class="hljs-number">76</span>)(<span class="hljs-variable">f9b03bc71db8776fed1a1bedec5c4048</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000002864</span><span class="hljs-variable">abc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_compatible</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">Framework</span>::<span class="hljs-title class_">JsAccessibilityManager</span>::<span class="hljs-title class_">GetDelayTimeBeforeSendEvent</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">AccessibilityEvent</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">AceType</span>&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">820</span>)(<span class="hljs-variable">f9b03bc71db8776fed1a1bedec5c4048</span>)</li><li>...</li><li>#<span class="hljs-number">51</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001286</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">bin</span>/<span class="hljs-title function_">appspawn</span>(<span class="hljs-variable">AppSpawnRun</span>+<span class="hljs-number">212</span>)(<span class="hljs-number">5</span><span class="hljs-variable">b32b2b72482af0bcb596742e983267f</span>)</li><li>#<span class="hljs-number">52</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000010184</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">bin</span>/<span class="hljs-title function_">appspawn</span>(<span class="hljs-keyword">main</span>+<span class="hljs-number">728</span>)(<span class="hljs-number">5</span><span class="hljs-variable">b32b2b72482af0bcb596742e983267f</span>)</li><li>#<span class="hljs-number">53</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-variable">a0ac4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">libc_start_main_stage2</span>+<span class="hljs-number">80</span>)(<span class="hljs-number">8630</span><span class="hljs-variable">db2fad668ca54158b85db8e122b0</span>)</li><li><span class="hljs-variable">Registers</span>:</li><li><span class="hljs-variable">x0</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c3eb6ad60</span> <span class="hljs-title class_">x1</span>:<span class="hljs-title class_">bdb5745bf3302164</span> <span class="hljs-title class_">x2</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba0874f0</span> <span class="hljs-title class_">x3</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba0874e8</span></li><li><span class="hljs-variable">x4</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c0fca7800</span> <span class="hljs-title class_">x5</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c0fca77f8</span> <span class="hljs-title class_">x6</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c19476000</span> <span class="hljs-title class_">x7</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c19462000</span></li><li><span class="hljs-variable">x8</span>:<span class="hljs-number">0</span><span class="hljs-title class_">d45fadb69fb35a3</span> <span class="hljs-title class_">x9</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c3ec2f400</span> <span class="hljs-title class_">x10</span>:<span class="hljs-number">0000000000000001</span> <span class="hljs-title class_">x11</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c19462000</span></li><li><span class="hljs-variable">x12</span>:<span class="hljs-number">0000000000000090</span> <span class="hljs-title class_">x13</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c19462000</span> <span class="hljs-title class_">x14</span>:<span class="hljs-number">0000000000000001</span> <span class="hljs-title class_">x15</span>:<span class="hljs-number">0000000000000000</span></li><li><span class="hljs-variable">x16</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af3021e38</span> <span class="hljs-title class_">x17</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af2070044</span> <span class="hljs-title class_">x18</span>:<span class="hljs-title class_">ffff000000000006</span> <span class="hljs-title class_">x19</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba087528</span></li><li><span class="hljs-variable">x20</span>:<span class="hljs-number">00000000000002</span><span class="hljs-title class_">eb</span> <span class="hljs-title class_">x21</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af3014000</span> <span class="hljs-title class_">x22</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c3eb6aa00</span> <span class="hljs-title class_">x23</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">c3eb6aa00</span></li><li><span class="hljs-variable">x24</span>:<span class="hljs-number">0000000000000000</span> <span class="hljs-title class_">x25</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af053c380</span> <span class="hljs-title class_">x26</span>:<span class="hljs-number">0000000000000000</span> <span class="hljs-title class_">x27</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba0874d0</span></li><li><span class="hljs-variable">x28</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af31cb228</span> <span class="hljs-title class_">x29</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba087470</span></li><li><span class="hljs-variable">lr</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af25e9480</span> <span class="hljs-title class_">sp</span>:<span class="hljs-number">0000007</span><span class="hljs-title class_">fba087420</span> <span class="hljs-title class_">pc</span>:<span class="hljs-number">0000005</span><span class="hljs-title class_">af07df83c</span></li></ol></pre></div></div> <p>首先从日志可以看到这是一个SIGSEGV(SEGV_MAPERR) 的问题，这表示进程试图访问一个不存在的内存地址，或者试图访问一个没有映射到进程地址空间的内存地址。这种情况通常是由于程序中的指针错误或内存泄漏引起。接下来就要解栈初步定位出问题的代码行， 根据<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-crash-cpp-way#section14952241528">llvm-address2line</a>反编译#00号栈可以看到栈顶挂如下代码行，也就是在取裸指针做类型转化。</p> <p><span><img height="183.462195" originheight="233" originwidth="978" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.84259108717644155595030615987693:50001231000000:2800:B5E915E3CACDE22346B0A01761E03CFDFC4EC6D12D4F86EE3E05F3CCA142254A.png" title="点击放大" width="770.07"></span></p> <p>用<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-scenario-stability-cppcrash#section10107179911">llvm-objdump</a>工具解该栈的地址，发现出问题的是x8寄存器，从当前指针里面取其中的第一个成员（虚表地址）取到了一个异常地址，从中偏移-80取内容的时候挂了。</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">0000000000</span><span class="hljs-variable">a5f814</span> &lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">AceType</span>::<span class="hljs-title class_">DynamicCast</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>, <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt;(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-keyword">const</span>&amp;)&gt;:</li><li>  <span class="hljs-variable">a5f814</span>: <span class="hljs-title class_">d10203ff</span>         <span class="hljs-title class_">sub</span>    <span class="hljs-title class_">sp</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">128</span></li><li>  <span class="hljs-variable">a5f818</span>: <span class="hljs-title class_">a9057bfd</span>         <span class="hljs-title class_">stp</span>    <span class="hljs-title class_">x29</span>, <span class="hljs-variable">x30</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">80</span>]</li><li>  <span class="hljs-variable">a5f81c</span>: <span class="hljs-title class_">a90657f6</span>         <span class="hljs-title class_">stp</span>    <span class="hljs-title class_">x22</span>, <span class="hljs-variable">x21</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">96</span>]</li><li>  <span class="hljs-variable">a5f820</span>: <span class="hljs-title class_">a9074ff4</span>         <span class="hljs-title class_">stp</span>    <span class="hljs-title class_">x20</span>, <span class="hljs-variable">x19</span>, [<span class="hljs-variable">sp</span>, #<span class="hljs-number">112</span>]</li><li>  <span class="hljs-variable">a5f824</span>: <span class="hljs-number">910143</span><span class="hljs-title class_">fd</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x29</span>, <span class="hljs-variable">sp</span>, #<span class="hljs-number">80</span></li><li>  <span class="hljs-variable">a5f828</span>: <span class="hljs-title class_">f9400009</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x9</span>, [<span class="hljs-variable">x0</span>] <span class="hljs-comment">// 从RefPtr中取出实际对象指针</span></li><li>  <span class="hljs-variable">a5f82c</span>: <span class="hljs-title class_">b4000fc9</span>      <span class="hljs-title class_">cbz</span> <span class="hljs-title class_">x9</span>, ... <span class="hljs-comment">// 取出对象虚表指针</span></li><li>  <span class="hljs-variable">a5f830</span>: <span class="hljs-title class_">aa0803f3</span>         <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x19</span>, <span class="hljs-variable">x8</span></li><li>  <span class="hljs-variable">a5f834</span>: <span class="hljs-title class_">f9400128</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x9</span>] <span class="hljs-comment">// 取出对象虚表指针</span></li><li>  <span class="hljs-variable">a5f838</span>: <span class="hljs-title class_">b00141b5</span>         <span class="hljs-title class_">adrp</span>    <span class="hljs-title class_">x21</span>, <span class="hljs-number">0x3294000</span> &lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">SvgGraphic</span>::<span class="hljs-title class_">OnDraw</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Rosen</span>::<span class="hljs-variable">Drawing</span>::<span class="hljs-title class_">Canvas</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">Size</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">optional</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">Color</span>&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">0x257c</span>&gt;</li><li>  <span class="hljs-variable">a5f83c</span>: <span class="hljs-title class_">f85b0108</span>      <span class="hljs-title class_">ldur</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x8</span>, #-<span class="hljs-number">80</span>] <span class="hljs-comment">// 尝试访问虚表中偏移为-80的位置</span></li></ol></pre></div></div> <p>前方的代码如下，从fnode指针中获取其成员时出现故障，通过汇编和代码初步定位可能是地址中的内存被覆盖。</p> <p><span><img height="649.1331" originheight="955" originwidth="1152" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.98840219115214726725056484450030:50001231000000:2800:6051D37F6AAB43518A8EC538554EBD0A343529EA721D9A2B788476A4615EEC87.png" title="点击放大" width="783.0375"></span></p> <p><span><img height="113.253091" originheight="174" originwidth="895" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.79920098406179145078472077144908:50001231000000:2800:342DCE8571B9FE4A040D20D64F5DB91F0BF47DE8C72A18FDAED6B3EEF6008B49.png" title="点击放大" width="582.5400000000001"></span></p> <p><strong>第二步：场景分析</strong></p> <p>通过走读代码，发现可疑点，几个地址越界问题的流水日志都有一个共同点，存在设置声音的操作。最终决定增加设置声音的测试用例进行压测。</p> <p><span><img originheight="158" originwidth="1213" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.58297713584273303411371627123317:50001231000000:2800:EB3B99B95977D49B0EEB55178199708EF5940F765B41E49F3F15E000936296A9.png" width="920" height="119.83511953833471"></span></p> <p><strong>第三步：内存特征分析</strong></p> <p>继续使用<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-scenario-stability-cppcrash#section10107179911">llvm-objdump</a>进行反汇编分析，关注崩溃栈中的#01栈：</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-shell" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta prompt_">#</span><span class="language-bash">01 pc 000000000286947c /system/lib64/platformsdk/libace_compatible.z.so</span></li></ol></pre></div></div> <p>对应汇编片段如下：</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">286944</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">f94002e8</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x23</span>]</li><li> <span class="hljs-number">2869450</span>: <span class="hljs-title class_">f85c0118</span>         <span class="hljs-title class_">ldur</span>    <span class="hljs-title class_">x24</span>, [<span class="hljs-variable">x8</span>, #-<span class="hljs-number">64</span>]</li><li> <span class="hljs-number">2869454</span>: <span class="hljs-number">08</span><span class="hljs-title class_">dffea8</span>         <span class="hljs-title class_">ldarb</span>    <span class="hljs-title class_">w8</span>, [<span class="hljs-variable">x21</span>]</li><li> <span class="hljs-number">2869458</span>: <span class="hljs-number">360028e8</span>         <span class="hljs-title class_">tbz</span>    <span class="hljs-title class_">w8</span>, #<span class="hljs-number">0</span>, <span class="hljs-number">0x2869974</span> &lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">Framework</span>::(<span class="hljs-title class_">anonymous</span> <span class="hljs-title class_">namespace</span>)::<span class="hljs-title class_">GetFramenodeByAccessibilityId</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">FrameNode</span>&gt; <span class="hljs-keyword">const</span>&amp;, <span class="hljs-title class_">long</span>)+<span class="hljs-number">0x6c8</span>&gt;</li><li> <span class="hljs-number">286945</span><span class="hljs-variable">c</span>: <span class="hljs-number">8</span><span class="hljs-title class_">b1802e0</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x0</span>, <span class="hljs-variable">x23</span>, <span class="hljs-variable">x24</span></li><li> <span class="hljs-number">2869460</span>: <span class="hljs-title class_">f9400381</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x1</span>, [<span class="hljs-variable">x28</span>]</li><li> <span class="hljs-number">2869464</span>: <span class="hljs-title class_">f9400008</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x0</span>]</li><li> <span class="hljs-number">2869468</span>: <span class="hljs-title class_">f9400908</span>         <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x8</span>, #<span class="hljs-number">16</span>]</li><li> <span class="hljs-number">286946</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">d63f0100</span>         <span class="hljs-title class_">blr</span>    <span class="hljs-title class_">x8</span></li><li> <span class="hljs-number">2869470</span>: <span class="hljs-number">910</span><span class="hljs-title class_">d8000</span>     <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x0</span>, <span class="hljs-variable">x0</span>, #<span class="hljs-number">864</span></li><li> <span class="hljs-number">2869474</span>: <span class="hljs-title class_">d10023a8</span>         <span class="hljs-title class_">sub</span>    <span class="hljs-title class_">x8</span>, <span class="hljs-variable">x29</span>, #<span class="hljs-number">8</span></li><li> <span class="hljs-number">2869478</span>: <span class="hljs-title class_">f81f83bf</span>         <span class="hljs-title class_">stur</span>    <span class="hljs-title class_">xzr</span>, [<span class="hljs-variable">x29</span>, #-<span class="hljs-number">8</span>]</li><li> <span class="hljs-number">286947</span><span class="hljs-variable">c</span>: <span class="hljs-number">9787</span><span class="hljs-title class_">d8e6</span>         <span class="hljs-title class_">bl</span>    <span class="hljs-number">0xa5f814</span> &lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">AceType</span>::<span class="hljs-title class_">DynamicCast</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>, <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">Ace</span>::<span class="hljs-title class_">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt;(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-title class_">RefPtr</span>&lt;<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">Ace</span>::<span class="hljs-variable">NG</span>::<span class="hljs-title class_">AccessibilityProperty</span>&gt; <span class="hljs-keyword">const</span>&amp;)&gt;</li><li> <span class="hljs-number">2869480</span>: <span class="hljs-title class_">f85f83a8</span>         <span class="hljs-title class_">ldur</span>    <span class="hljs-title class_">x8</span>, [<span class="hljs-variable">x29</span>, #-<span class="hljs-number">8</span>]</li></ol></pre></div></div> <p>从指令add x0, x0, #864可见，在bl跳转之前，x0寄存器的值被偏移了864（即 0x360），这恰好对应了NG::FrameNode结构体中变量accessibilityProperty_ 的偏移位置，如下图所示。</p> <p><span><img originheight="590" originwidth="978" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.45231557728623788081056175038128:50001231000000:2800:0B7C4AE7F98C7B0D91C570CA0895A1620C321DEB77D88861A86A929C7C06A882.png" width="920" height="555.0102249488752"></span></p> <p>因此可判断，此时的x0指向的就是accessibilityProperty_ 成员的地址。紧随其后的bl指令跳转至0xa5f814（DynamicCast），该函数会以x0为实参，对其执行虚表查找，并尝试进行向下类型转换。看x0的内存布局，和FrameNode结构体内存大小也能对上。说明FrameNode是正常的，但是里面的这个成员的指针指向的内容异常了，如下图所示5c3eb6ad68地址的值异常，可能是accessibilityProperty_这个指针本身被踩，也可能是这个对象的内容被踩。</p> <p><span><img originheight="236" originwidth="889" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.04905906519574703260415047271816:50001231000000:2800:02A6D08BEC23BD418A46C23E7510ACD54C3E96762877152028EA83A9AC2FE7CF.png" width="889" height="236"></span></p> <p><strong>第四步：用例部署</strong></p> <p><strong>用例：</strong>基于第二步的场景分析结果，构建定向测试用例，优先覆盖声音播放路径，以提升问题复现的概率。</p> <p><strong>规模：</strong>该问题的出现概率为0.36次/千小时，意味着平均每运行约2700小时才可能出现一次。以此推算，若不具备高概率复现的测试手段，需部署约100台设备并持续运行24小时，才可能复现一次问题。</p> <p><strong>第五步：应用天网部署</strong></p> <p>通过定位hap包中未插桩的so（共计 6 个），并完成插桩编译，结合场景分析开展压测。最终，在当天即捕获到了地址越界的内存问题，验证了插桩的有效性与场景分析的准确性。</p> <p><strong>第六步：日志分析</strong></p> <p>最终的日志如下：</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGTRAP</span>(<span class="hljs-title class_">TRAP_BRKPT</span>)@<span class="hljs-number">0x0000005993e64380</span> </li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">3609</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">ohos</span>.<span class="hljs-title class_">sceneboard</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002431</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libclang_rt</span>.<span class="hljs-variable">hwasan</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">__hwasan_memcpy</span>+<span class="hljs-number">104</span>)(<span class="hljs-number">923568647</span><span class="hljs-variable">ab45629f49bfc2f49994f3ad1ed78d7</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000005851</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libutils</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">memcpy_s</span>+<span class="hljs-number">92</span>)(<span class="hljs-variable">ccf5dfd85d62df9862da8c793fda4686</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000019</span><span class="hljs-variable">eb8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libsoundpool_client</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Media</span>::<span class="hljs-title class_">CacheBuffer</span>::<span class="hljs-title class_">DealWriteData</span>(<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">long</span>)+<span class="hljs-number">784</span>)(<span class="hljs-variable">eeedf0103bb0362f04cf668b2aacc59c</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001994</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libsoundpool_client</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Media</span>::<span class="hljs-title class_">CacheBuffer</span>::<span class="hljs-title class_">OnWriteData</span>(<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">long</span>)+<span class="hljs-number">316</span>)(<span class="hljs-variable">eeedf0103bb0362f04cf668b2aacc59c</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000112188</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libaudio_client</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">AudioStandard</span>::<span class="hljs-title class_">RendererInClientInner</span>::<span class="hljs-title class_">WriteCallbackFunc</span>()+<span class="hljs-number">1488</span>)(<span class="hljs-number">8</span><span class="hljs-variable">c5f08d14bbf64621f12f008754788e2</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000124</span><span class="hljs-variable">fd4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">asan</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libaudio_client</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-number">8</span><span class="hljs-variable">c5f08d14bbf64621f12f008754788e2</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000010</span><span class="hljs-variable">fe74</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>-<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">start</span>+<span class="hljs-number">244</span>)(<span class="hljs-variable">e9b4aaf89b017030f72cd5cadf60ea8b</span>)</li><li>#<span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-variable">a1b88</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>-<span class="hljs-variable">asan</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">e9b4aaf89b017030f72cd5cadf60ea8b</span>)</li></ol></pre></div></div> <p>解析#00栈，对应的汇编如下</p> <div _ngcontent-qua-c106="" class="highlight-div"><div _ngcontent-qua-c106="" class="highlight-div-header"><div _ngcontent-qua-c106="" class="highlight-div-header-left"><div _ngcontent-qua-c106="" class="handle-button expand-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qua-c106="" class="highlight-div-header-right"><div _ngcontent-qua-c106="" class="handle-button ai-button"></div><div _ngcontent-qua-c106="" class="handle-button line-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qua-c106="" class="handle-button theme-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qua-c106="" class="handle-button copy-button"><div _ngcontent-qua-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qua-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-number">00000000000242</span><span class="hljs-title class_">b4</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>&gt;:</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">b4</span>: <span class="hljs-title class_">aa0103e8</span>     <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x8</span>, <span class="hljs-variable">x1</span> <span class="hljs-comment">// x8 = src</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">b8</span>: <span class="hljs-title class_">aa0003e9</span>     <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x9</span>, <span class="hljs-variable">x0</span> <span class="hljs-comment">// x9 = dest</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">bc</span>: <span class="hljs-title class_">b5000082</span>         <span class="hljs-title class_">cbnz</span>    <span class="hljs-title class_">x2</span>, <span class="hljs-number">0x242cc</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0x18</span>&gt;</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">c0</span>: <span class="hljs-title class_">aa0903e0</span>         <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x0</span>, <span class="hljs-variable">x9</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">c4</span>: <span class="hljs-title class_">aa0803e1</span>         <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x1</span>, <span class="hljs-variable">x8</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">c8</span>: <span class="hljs-number">1400952</span><span class="hljs-title class_">e</span>         <span class="hljs-title class_">b</span>    <span class="hljs-number">0x49780</span> &lt;<span class="hljs-title class_">memcpy</span>@<span class="hljs-title class_">plt</span>&gt;</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">cc</span>: <span class="hljs-title class_">f000012a</span>         <span class="hljs-title class_">adrp</span>    <span class="hljs-title class_">x10</span>, <span class="hljs-number">0x4b000</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0xb4</span>&gt;</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">d0</span>: <span class="hljs-number">9240</span><span class="hljs-title class_">dd2b</span>     <span class="hljs-title class_">and</span>    <span class="hljs-title class_">x11</span>, <span class="hljs-variable">x9</span>, #<span class="hljs-number">0xffffffffffffff</span> <span class="hljs-comment">// x11 = dest地址去tag</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">d4</span>: <span class="hljs-number">8</span><span class="hljs-title class_">b02016e</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x14</span>, <span class="hljs-variable">x11</span>, <span class="hljs-variable">x2</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">d8</span>: <span class="hljs-title class_">f941c94a</span>     <span class="hljs-title class_">ldrx10</span>, [<span class="hljs-variable">x10</span>, #<span class="hljs-number">912</span>]</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">dc</span>: <span class="hljs-title class_">f940014d</span>     <span class="hljs-title class_">ldr</span>    <span class="hljs-title class_">x13</span>, [<span class="hljs-variable">x10</span>] <span class="hljs-comment">// base_addr = *(shadow_table)</span></li><li>   <span class="hljs-number">242e0</span>: <span class="hljs-number">8</span><span class="hljs-title class_">b4b11ac</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x12</span>, <span class="hljs-variable">x13</span>, <span class="hljs-variable">x11</span>, <span class="hljs-variable">lsr</span> #<span class="hljs-number">4</span> <span class="hljs-comment">// shadow_ptr = base + (addr &gt;&gt; 4)</span></li><li>   <span class="hljs-number">242e4</span>: <span class="hljs-number">8</span><span class="hljs-title class_">b4e11ab</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x11</span>, <span class="hljs-variable">x13</span>, <span class="hljs-variable">x14</span>, <span class="hljs-variable">lsr</span> #<span class="hljs-number">4</span> <span class="hljs-comment">// shadow_end = base + ((addr+size) &gt;&gt; 4)</span></li><li>   <span class="hljs-number">242e8</span>: <span class="hljs-title class_">eb0b019f</span>         <span class="hljs-title class_">cmp</span>    <span class="hljs-title class_">x12</span>, <span class="hljs-variable">x11</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">ec</span>: <span class="hljs-number">54000202</span>         <span class="hljs-title class_">b</span>.<span class="hljs-title class_">hs</span>    <span class="hljs-number">0x2432c</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0x78</span>&gt;</li><li>   <span class="hljs-number">242</span><span class="hljs-variable">f0</span>: <span class="hljs-title class_">cb0c016d</span>         <span class="hljs-title class_">sub</span>    <span class="hljs-title class_">x13</span>, <span class="hljs-variable">x11</span>, <span class="hljs-variable">x12</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">f4</span>: <span class="hljs-title class_">d378fd2e</span>     <span class="hljs-title class_">lsr</span>      <span class="hljs-title class_">x14</span>, <span class="hljs-variable">x9</span>, #<span class="hljs-number">56</span> <span class="hljs-comment">// &gt;&gt;56位后得到高8位的指针tag，x14 = tag(x9)</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">f8</span>: <span class="hljs-number">3940018</span><span class="hljs-title class_">f</span>     <span class="hljs-title class_">ldrb</span>    <span class="hljs-title class_">w15</span>, [<span class="hljs-variable">x12</span>] <span class="hljs-comment">// 找到shadow memory中的tag</span></li><li>   <span class="hljs-number">242</span><span class="hljs-variable">fc</span>: <span class="hljs-number">6</span><span class="hljs-title class_">b0e01ff</span>     <span class="hljs-title class_">cmp</span>      <span class="hljs-title class_">w15</span>, <span class="hljs-variable">w14</span> <span class="hljs-comment">// 比较 tag 是否一致</span></li><li>   <span class="hljs-number">24300</span>: <span class="hljs-number">540000</span><span class="hljs-title class_">a1</span>     <span class="hljs-title class_">b</span>.<span class="hljs-title class_">ne</span>     <span class="hljs-number">0x24314</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0x60</span>&gt; <span class="hljs-comment">// 不一致 → 报错</span></li><li>   <span class="hljs-number">24304</span>: <span class="hljs-number">9100058</span><span class="hljs-title class_">c</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x12</span>, <span class="hljs-variable">x12</span>, #<span class="hljs-number">1</span></li><li>   <span class="hljs-number">24308</span>: <span class="hljs-title class_">f10005ad</span>         <span class="hljs-title class_">subs</span>    <span class="hljs-title class_">x13</span>, <span class="hljs-variable">x13</span>, #<span class="hljs-number">1</span></li><li>   <span class="hljs-number">2430</span><span class="hljs-variable">c</span>: <span class="hljs-number">54</span><span class="hljs-title class_">ffff61</span>         <span class="hljs-title class_">b</span>.<span class="hljs-title class_">ne</span>    <span class="hljs-number">0x242f8</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0x44</span>&gt;</li><li>   <span class="hljs-number">24310</span>: <span class="hljs-number">14000007</span>         <span class="hljs-title class_">b</span>    <span class="hljs-number">0x2432c</span> &lt;<span class="hljs-title class_">__hwasan_memcpy</span>+<span class="hljs-number">0x78</span>&gt;</li><li>   <span class="hljs-number">24314</span>: <span class="hljs-title class_">aa0903e0</span>     <span class="hljs-title class_">mov</span>      <span class="hljs-title class_">x0</span>, <span class="hljs-variable">x9</span> <span class="hljs-comment">// x0 = dest (错误地址)</span></li><li>   <span class="hljs-number">24318</span>: <span class="hljs-title class_">aa0203e1</span>     <span class="hljs-title class_">mov</span>    <span class="hljs-title class_">x1</span>, <span class="hljs-variable">x2</span> <span class="hljs-comment">// x1 = size</span></li><li>   <span class="hljs-number">2431</span><span class="hljs-variable">c</span>: <span class="hljs-title class_">d42127e0</span>     <span class="hljs-title class_">brk</span>#<span class="hljs-number">0x93f</span> <span class="hljs-comment">// HWAASan测到问题，tag mismatch</span></li><li>   <span class="hljs-number">24320</span>: <span class="hljs-number">9100058</span><span class="hljs-title class_">c</span>         <span class="hljs-title class_">add</span>    <span class="hljs-title class_">x12</span>, <span class="hljs-variable">x12</span>, #<span class="hljs-number">1</span></li><li>   <span class="hljs-number">24324</span>: <span class="hljs-title class_">f10005ad</span>     <span class="hljs-title class_">subs</span>    <span class="hljs-title class_">x13</span>, <span class="hljs-variable">x13</span>, #<span class="hljs-number">1</span></li></ol></pre></div></div> <p>看汇编hwasan抓到tag不对了，从汇编看就是x0寄存器不对，也就是dest的指针有问题。</p> <p><span><img height="262.72447600000004" originheight="336" originwidth="856" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.04083632174207412325792531519012:50001231000000:2800:FB886499F300E6EA60F85982205177CBA24D26F10E592A3236B72EADF4700F2A.png" title="点击放大" width="669.3225"></span></p> <p>向前回栈看：</p> <p><span><img height="504.78687" originheight="689" originwidth="1111" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163447.48610943798927588161500620438994:50001231000000:2800:71AE89E3D32E9F034753A176598A9DF8AD51770D78C7630E220621E6EC198E45.png" title="点击放大" width="813.96"></span></p> <p>看是buffer存在问题</p> <p><span><img originheight="625" originwidth="624" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.02609066575171401950348819193775:50001231000000:2800:A089B7E0CA57E2672677FA894C040CA8D5BD1126F70644BC1C023E74602AF3EB.png" width="624" height="625"></span></p> <p>结合反编译第一个参数，是音频audiorenderer传过来找soundpool要数据填充的目的地址，看是否提前释放导致野指针了。</p> <p><span><img height="292.1019764379764" originheight="361" originwidth="1137" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.49785346044890287593493790432469:50001231000000:2800:1FDA4AC71D549E9E773ECE29EBBB33608EA9F43F226073C681FC925FC556EC93.png" title="点击放大" width="920"></span></p> <p><span><img height="343.55695499999996" originheight="428" originwidth="1101" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.35382396002886189301838096959715:50001231000000:2800:73471B3521B40D0E285D7A719EC49188D020ECAEFC1E8FCE60001A62CF58FAAC.png" title="点击放大" width="883.7850000000001"></span></p> <p><span><img height="209.85714488257887" originheight="461" originwidth="2021" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163448.15364209216948228355951914503071:50001231000000:2800:F6EE3CD44E35A343671E30CE72AD9D0282819064634A6E001CBE1FAAAC12EEB7.png" title="点击放大" width="920"></span></p> <p>问题已明确是Use-After-Free问题，GetBufferDesc函数将cbBuffer_的裸指针返回出去，另一个线程将RendererInClientInner销毁了，生命周期不一致导致了Use-After-Free问题。</p> </div> </div> <div></div></div>