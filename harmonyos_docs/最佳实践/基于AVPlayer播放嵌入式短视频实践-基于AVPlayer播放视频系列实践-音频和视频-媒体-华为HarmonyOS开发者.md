<h1 _ngcontent-fkq-c119="" class="doc-title ng-star-inserted" title="基于AVPlayer播放嵌入式短视频实践"> 基于AVPlayer播放嵌入式短视频实践 </h1>

<div _ngcontent-fkq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section5449126155620">概述<i class="anchor-icon anchor-icon-link" anchorid="section5449126155620" tips="复制节点链接"></i></h2><p>本文适用于视频播放类应用开发，针对市场上主流视频播放应用常见场景，介绍如何基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>系统播放器实现嵌入式短视频播放。本文指导开发者实现以下几种场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section19871518619">基础播控能力</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section9451174918313">焦点管理</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section1560144415411">前后台感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section92411245940">横竖屏切换和旋转感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section17471045441">画中画播放</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section11121172718716">视频首帧显示</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section1243616221447">嵌入式视频列表自动播放</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#section129361938786">视频无缝转场播放</a></li></ul> </div> <div class="tiledSection"><h2 id="section19871518619">基础播控能力<i class="anchor-icon anchor-icon-link" anchorid="section19871518619" tips="复制节点链接"></i></h2><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实现视频资源加载、播放、暂停、停止、退出操作，包含了静音播放、倍数设置和字幕挂载等功能，实现原理详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-basic-control" target="_blank">《基于AVPlayer基础播控实践》</a>。</p> </div> <div class="tiledSection"><h2 id="section9451174918313">焦点管理<i class="anchor-icon anchor-icon-link" anchorid="section9451174918313" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section656385619479" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section656385619479" tips="复制节点链接"></i></h3><p>前台视频播放过程中，音频被后台闹钟、电话等中断事件打断，完成播放过程音视频焦点管理。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.59757850373656192128643885489679:50001231000000:2800:6E32E2A022EBFB1923A71359E6C6C0A7B4A5D466617502E4D08C136FF1007828.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section1718051810016">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1718051810016" tips="复制节点链接"></i></h3></div> <p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1716082163419" target="_blank">焦点管理开发步骤</a>。</p> <div class="tiledSection"><h2 id="section1560144415411">前后台感知<i class="anchor-icon anchor-icon-link" anchorid="section1560144415411" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1856593314246" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1856593314246" tips="复制节点链接"></i></h3><p>应用从后台切回到前台时，保持原视频播放且会从之前的位置继续播放。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.00312581317774612822679571825857:50001231000000:2800:BAEE8BE1E2B20756B69EECB0FBD442692C62E6A89EF5E784081464EDA58E190A.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section5161191418280">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5161191418280" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1448773335411" target="_blank">前后台感知开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section92411245940">横竖屏切换和旋转感知<i class="anchor-icon anchor-icon-link" anchorid="section92411245940" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1070517693713" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1070517693713" tips="复制节点链接"></i></h3><p>播放视频时可以手动进行横竖屏切换，也支持根据设备旋转方向自动切换横竖屏模式，以适应不同屏幕方向下的视频播放需求。</p> <p><span><img height="266" originheight="1080" originwidth="2306" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.46459975388446693441165539498908:50001231000000:2800:48FB9B3F557E09B76D1590AC57D1B0972E6696CC785687451CA9E9C9C1A729F3.gif" title="点击放大" width="569.9981"></span></p> </div> <div class="tiledSection"><h3 id="section6116162012377">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section6116162012377" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1257185216407" target="_blank">横竖屏切换和旋转感知开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section17471045441">画中画播放<i class="anchor-icon anchor-icon-link" anchorid="section17471045441" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1735504912399" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1735504912399" tips="复制节点链接"></i></h3><p>画中画模式用户可进行其他界面操作，提升使用体验。应用场景包括视频播放、直播、视频通话和视频会议等。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.12808837932443351803164218645461:50001231000000:2800:7B684D826379EBBA52064A3584FC4539476B10E0349C5667157D0F148B66FB6B.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section163281203408">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section163281203408" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section4691194231313" target="_blank">画中画播放开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section11121172718716">视频首帧显示<i class="anchor-icon anchor-icon-link" anchorid="section11121172718716" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section98741039278" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section98741039278" tips="复制节点链接"></i></h3><p>视频播放列表或播放窗口中显示视频首帧作为视频描述信息。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.54466589831641507194439177197340:50001231000000:2800:F3B288968F1FBE64446718F5A38D778D26FEF4DE0C0BABD0A91A6CC43B24C2D9.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section8112152518811">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section8112152518811" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section27212108403" target="_blank">视频首帧显示开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section1243616221447">嵌入式视频列表自动播放<i class="anchor-icon anchor-icon-link" anchorid="section1243616221447" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section937610296410" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section937610296410" tips="复制节点链接"></i></h3><p>用户浏览视频列表时自动播放视频，在用户滑动视频列表时自动切换至首个完全可见的视频播放。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.06496451583802209156046022963818:50001231000000:2800:64EEF9CF71ED667DC750B39B9198AA957E860F22E31373CFD3590D6AE6B69055.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section731529163112">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section731529163112" tips="复制节点链接"></i></h3><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>组件实现视频播放列表页面。通过监听列表滑动<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list#onscrollstop" target="_blank">onScrollStop()</a>事件，在滑动停止时获取滑动偏移量offset，计算首个可完全展示的视频的索引，切换至该视频播放，实现视频列表中首个可见视频自动播放效果。</p> <p>逻辑如下：</p> <p><span><img height="629.7949" originheight="799" originwidth="334" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.84929222244282720785265607792809:50001231000000:2800:6E22D8A62FA37DCDBC0513449C1782BC5358F312DC77A929D889F94D966B7887.png" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section625114541449">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section625114541449" tips="复制节点链接"></i></h3><ol><li><span>创建视频列表的模拟数据。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/model/VideoItemData.ets#L19-L36" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VIDEO_DATA</span>: VideoItemData[] =</li><li>  [</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoItemData</span>(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.string.info_detail'</span>), <span class="hljs-number">0</span>, <span class="hljs-string">'1.mp4'</span>, <span class="hljs-variable">$r</span>(`app.media.preview1`)),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoItemData</span>(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.string.info_detail'</span>), <span class="hljs-number">0</span>, <span class="hljs-string">'2.mp4'</span>, <span class="hljs-variable">$r</span>(`app.media.preview2`)),</li><li>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoItemData</span>(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.string.info_detail'</span>), <span class="hljs-number">0</span>, <span class="hljs-string">'3.mp4'</span>, <span class="hljs-variable">$r</span>(`app.media.preview3`)),</li><li>    <span class="hljs-comment">// ...</span></li><li>  ];</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/model/VideoItemData.ets#L19-L36" target="_blank">VideoItemData.ets</a></div></div></div></div> <p></p></li></ol><ol start="2"><li id="li71231589325"><span>声明initAVPlayer()方法初始化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L50-L124" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// Creates a callback function for state machine changes.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L50-L124" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>创建setStateChangeCallback()状态回调函数，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avplayerstate9" target="_blank">AVPlayerState</a>状态为prepared时，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter#emitteremit" target="_blank">Emitter</a>传递当前<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例的高度和宽度。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L268-L386" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">setStateChangeCallback</span>()</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Callback function for state machine changes</span></li><li>  <span class="hljs-keyword">this</span>.avPlayer.<span class="hljs-keyword">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-keyword">async</span> (state) =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">switch</span> (state) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>: <span class="hljs-comment">// This state machine is reported after the prepare interface is successfully invoked.</span></li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">let</span> eventData: emitter.EventData = {</li><li>          data: {</li><li>            <span class="hljs-string">'percent'</span>: <span class="hljs-keyword">this</span>.avPlayer.width / <span class="hljs-keyword">this</span>.avPlayer.height</li><li>          }</li><li>        };</li><li>        emitter.emit(CommonConstants.AVPLAYER_PREPARED, eventData);</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L268-L386" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-display#displaygetdefaultdisplaysync9" target="_blank">getDefaultDisplaySync()</a>方法获取当前屏幕宽度，以默认16:9的屏幕比例，通过屏幕宽度计算<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-relativecontainer" target="_blank">RelativeContainer</a>组件的高度和宽度，计算<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-listitem" target="_blank">ListItem</a>所需高度；订阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#avplayerstate9" target="_blank">AVPlayerState</a>状态为prepared的事件，获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例的高度和宽度。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L341-L374" data-highlighted="yes"><ol class="linenums"><li>aboutToAppear() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.windowClass.setWindowSystemBarProperties({</li><li>      <span class="hljs-comment">// Status bar color</span></li><li>      statusBarColor: <span class="hljs-string">'#1A1A1A'</span></li><li>    }).<span class="hljs-keyword">catch</span>((error: BusinessError) =&gt; {</li><li>      hilog.error(Constants.DOMAIN, TAG,</li><li>        `setWindowSystemBarProperties failed, Code:${error.code}, message:${error.message}`);</li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// Calculated based on screen width RelativeContainer width</span></li><li>    let winWidth = <span class="hljs-keyword">this</span>.getUIContext().px2vp(display.getDefaultDisplaySync().width);</li><li>    <span class="hljs-keyword">this</span>.frameWidth = winWidth - Constants.LIST_ITEM_LEFT_PADDING - Constants.LIST_ITEM_RIGHT_PADDING;</li><li>    <span class="hljs-keyword">this</span>.frameHeight = Math.floor(<span class="hljs-keyword">this</span>.frameWidth / Constants.WH_RADIO);</li><li>    <span class="hljs-keyword">this</span>.listItemHeight =</li><li>      <span class="hljs-keyword">this</span>.frameHeight + Constants.TITLE_HEIGHT + Constants.LIST_ITEM_TOP_PADDING + Constants.INFO_AREA_HEIGHT;</li><li>    emitter.on(<span class="hljs-string">'prepared'</span>, (eventData: emitter.EventData) =&gt; {</li><li>      let vWidth: number = eventData.<span class="hljs-keyword">data</span>!.width;</li><li>      let vHeight: number = eventData.<span class="hljs-keyword">data</span>!.height;</li><li>      let surfaceID: string = eventData.<span class="hljs-keyword">data</span>!.surfaceID;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.playIdx &lt; <span class="hljs-keyword">this</span>.dataSource.totalCount()) {</li><li>        let playSurfaceID = <span class="hljs-keyword">this</span>.dataSource.getData(<span class="hljs-keyword">this</span>.playIdx).surfaceID;</li><li>        <span class="hljs-keyword">if</span> (playSurfaceID === surfaceID) {</li><li>          <span class="hljs-keyword">this</span>.setXComponentWH(vWidth, vHeight);</li><li>        }</li><li>      }</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">if</span> (error.code !== <span class="hljs-literal">null</span> &amp;&amp; error.message !== <span class="hljs-literal">null</span>) {</li><li>      hilog.error(Constants.DOMAIN, TAG, `aboutToAppear failed, code <span class="hljs-keyword">is</span> ${error.code}, message <span class="hljs-keyword">is</span> ${error.message}`);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L341-L374" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例的高度、宽度计算设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>的高度、宽度。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L58-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/*</span></li><li><span class="hljs-comment"> * Calculate XComponent Width&amp;Height</span></li><li><span class="hljs-comment"> */</span></li><li>setXComponentWH(vWidth: number, vHeight: number) {</li><li>  let radio = vWidth / vHeight;</li><li>  <span class="hljs-keyword">if</span> (radio &gt; <span class="hljs-number">1</span>) {</li><li>    <span class="hljs-comment">// Horizontal video</span></li><li>    <span class="hljs-keyword">this</span>.xWidth = <span class="hljs-keyword">this</span>.frameWidth;</li><li>    <span class="hljs-keyword">this</span>.xHeight = Math.floor(<span class="hljs-keyword">this</span>.xWidth / radio);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xHeight &gt; <span class="hljs-keyword">this</span>.frameHeight) {</li><li>      <span class="hljs-keyword">this</span>.xHeight = <span class="hljs-keyword">this</span>.frameHeight;</li><li>      <span class="hljs-keyword">this</span>.xWidth = Math.floor(<span class="hljs-keyword">this</span>.xHeight * radio);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// Vertical video</span></li><li>    <span class="hljs-keyword">this</span>.xHeight = <span class="hljs-keyword">this</span>.frameHeight;</li><li>    <span class="hljs-keyword">this</span>.xWidth = Math.floor(<span class="hljs-keyword">this</span>.xHeight * radio);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.xWidth &gt; <span class="hljs-keyword">this</span>.frameWidth) {</li><li>      <span class="hljs-keyword">this</span>.xWidth = <span class="hljs-keyword">this</span>.frameWidth;</li><li>      <span class="hljs-keyword">this</span>.xHeight = Math.floor(<span class="hljs-keyword">this</span>.xWidth / radio);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L58-L81" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>声明avPlayerController的实例。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L54-L55" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> avPlayerController: AvPlayerController = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AvPlayerController</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L54-L55" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>在页面的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#ondidbuild12" target="_blank">onDidBuild()</a>函数中加载模拟视频数据，初始化加载首个视频数据。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L333-L337" data-highlighted="yes"><ol class="linenums"><li>onDidBuild(): void {</li><li>  <span class="hljs-keyword">this</span>.dataSource.loadData();</li><li>  <span class="hljs-keyword">this</span>.play(<span class="hljs-keyword">this</span>.playIdx);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L333-L337" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li id="li37514173917"><span>根据所需播放视频的索引，获取视频相关信息，使用videoReset()方法重置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例，随后利用获取的视频信息调用<a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#li71231589325">initAVPlayer()</a>方法重新初始化，设置该实例的surfaceId，确保其在指定surfaceId的组件上播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L99-L137" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">play</span>(<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">startRender</span> = <span class="hljs-keyword">false</span>;</li><li>  <span class="hljs-comment">// Reset AVPlayer</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayerController</span>.<span class="hljs-title function_">videoReset</span>().<span class="hljs-title function_">then</span>(() =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">isMuted</span> = <span class="hljs-keyword">true</span>;</li><li>        <span class="hljs-comment">// Init AVPlayer</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayerController</span>.<span class="hljs-title function_">initAVPlayer</span>({</li><li>          <span class="hljs-keyword">type</span>: <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-title class_">RAW_FILE</span>,</li><li>          <span class="hljs-variable">videoSrc</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">dataSource</span>.<span class="hljs-title class_">getData</span>(<span class="hljs-title class_">index</span>).<span class="hljs-title class_">src</span>!,</li><li>          <span class="hljs-variable">name</span>: $<span class="hljs-title class_">r</span>("<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">app_name</span>"),</li><li>          <span class="hljs-variable">description</span>: <span class="hljs-string">''</span>,</li><li>          <span class="hljs-variable">caption</span>: <span class="hljs-string">''</span>,</li><li>          <span class="hljs-variable">index</span>: <span class="hljs-number">0</span>,</li><li>          <span class="hljs-variable">seekTime</span>: <span class="hljs-title class_">stopTime</span>,</li><li>          <span class="hljs-variable">isMuted</span>: <span class="hljs-keyword">true</span>,</li><li>          <span class="hljs-variable">head</span>: $<span class="hljs-title class_">r</span>("<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">preview1</span>")</li><li>        }, <span class="hljs-variable">surfaceID</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L99-L137" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List</a>显示视频列表，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">LazyForEach</a>对列表数据进行懒加载。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L384-L415" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">List</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">listScroller</span> }) {</li><li>  <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">info</span>: <span class="hljs-title class_">VideoInfo</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-title function_">ListItem</span>() {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">videoItemBuilder</span>(<span class="hljs-variable">info</span>, <span class="hljs-variable">index</span>)</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }, (<span class="hljs-variable">info</span>: <span class="hljs-title class_">VideoInfo</span>) =&gt; <span class="hljs-variable">info</span>.<span class="hljs-variable">id</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L384-L415" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件，其提供用于图形绘制和媒体数据写入的Surface，负责将其嵌入视图中，用于视频播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L215-L218" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">XComponent</span>({</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>,</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">info</span>.<span class="hljs-title class_">xController</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L215-L218" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#onload" target="_blank">onLoad()</a>加载事件中，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#getxcomponentsurfaceid9" target="_blank">getXComponentSurfaceId()</a>获取该播放组件的Id，将其Id设置到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>的surfaceId上，即可实现在该组件上播放视频。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L229-L235" data-highlighted="yes"><ol class="linenums"><li>.<span class="hljs-title function_">onLoad</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> surfaceID = info.<span class="hljs-property">xController</span>!.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>  info.<span class="hljs-property">surfaceID</span> = surfaceID;</li><li>  <span class="hljs-keyword">if</span> (info.<span class="hljs-property">id</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">unloadID</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">play</span>(index);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L229-L235" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li><span>设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list#onscrollstop" target="_blank">onScrollStop()</a>事件，在列表滑动停止时触发，根据滑动偏移量及单个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-listitem" target="_blank">ListItem</a>的高度计算当前屏幕内首个可完整显示的视频索引。若计算得出的视频索引与当前播放视频索引不符，则使用play()方法重新初始化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>，切换至计算得出的视频进行播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L435-L451" data-highlighted="yes"><ol class="linenums"><li>.onScrollStop(() =&gt; {</li><li>  let yOffset = <span class="hljs-keyword">this</span>.listScroller.currentOffset().yOffset;</li><li>  let curIndex = Math.floor(yOffset / (<span class="hljs-keyword">this</span>.listItemHeight + Constants.LIST_DIVIDER_WIDTH));</li><li>  let offsetInItem = yOffset - curIndex * (<span class="hljs-keyword">this</span>.listItemHeight + Constants.LIST_DIVIDER_WIDTH);</li><li>  <span class="hljs-keyword">if</span> (offsetInItem &gt; Constants.LIST_ITEM_TOP_PADDING + <span class="hljs-number">34</span>) {</li><li>    curIndex += <span class="hljs-number">1</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.curIndex = curIndex;</li><li>  <span class="hljs-keyword">if</span> (curIndex !== <span class="hljs-keyword">this</span>.playIdx &amp;&amp; curIndex &lt; <span class="hljs-keyword">this</span>.dataSource.totalCount()) {</li><li>    setTimeout(() =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.curIndex === curIndex &amp;&amp; <span class="hljs-keyword">this</span>.curIndex !== <span class="hljs-keyword">this</span>.playIdx) {</li><li>        <span class="hljs-keyword">this</span>.play(curIndex);</li><li>      }</li><li>    }, Constants.DELAY_MS);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L435-L451" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section129361938786">视频无缝转场播放<i class="anchor-icon anchor-icon-link" anchorid="section129361938786" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section726884619817" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section726884619817" tips="复制节点链接"></i></h3><p>视频播放无缝转场是影音娱乐类应用中的典型场景之一，如视频列表中自动播放的热门视频，点击当前播放视频跳转至视频详情页后继续播放。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.69401073127936108963087267967072:50001231000000:2800:AA1781A1C6739780C1F96489193D536E1BACBD7265C17CBEB41BA570F9F80CDF.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section5279134613305">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section5279134613305" tips="复制节点链接"></i></h3><p>基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>实现视频播放，通过切换AVPlayer的surfaceId控制不同XComponent播放视频，实现转场效果，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>方法跳转至指定位置播放，主要分为两部分：</p> <p><strong>列表页面跳转到详情页面</strong>：当点击正在播放的视频时，记录当前播放视频的索引、播放进度、总时长、surfaceId信息，并在页面跳转<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#pushpathbyname10" target="_blank">pushPathByName()</a>方法中传入此视频信息。在视频播放详情页面使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#getparambyindex10" target="_blank">getParamByIndex()</a>接收传入信息，根据接收的视频信息使用initAVPlayer()初始化AVPlayer实例，初始化新的XComponent组件和surfaceID，将其绑定到AVPlayer上，使用seek()方法从记录的播放进度开始播放；</p> <p><strong>详情页面返回到列表页面</strong>：在详情页面点击返回时，记录当前播放视频的索引、播放进度、总时长、原surfaceId信息，并在页面回调<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability#onbackpressed10" target="_blank">onBackPressed()</a>函数中，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-multinavigation#pop" target="_blank">pop()</a>方法传入此视频信息，根据接收的视频信息，使用play(index)初始化AVPlayer，将其surfaceId设置为原surfaceId，使用seek()方法从记录的播放进度开始播放。</p> <p>逻辑如下：</p> <p><span><img height="342.6612" originheight="587" originwidth="1367" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.68026424023319084330664100560280:50001231000000:2800:56FA1DD1DCBC4857EB93DDDCAF5320A6A57793273585E981EB7B6EAF53C99AFB.png" title="点击放大" width="798"></span></p> </div> <div class="tiledSection"><h3 id="section1589310277327">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1589310277327" tips="复制节点链接"></i></h3><ol><li><span>创建route_map.json路由配置文件，配置视频跳转播放页面参数信息。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/resources/base/profile/route_map.json#L0-L9" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"routerMap"</span>: [</li><li>    {</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"DetailPage"</span>,</li><li>      <span class="hljs-string">"pageSourceFile"</span>: <span class="hljs-string">"src/main/ets/pages/DetailPage.ets"</span>,</li><li>      <span class="hljs-string">"buildFunction"</span>: <span class="hljs-string">"detailPageBuilder"</span></li><li>    }</li><li>  ]</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/resources/base/profile/route_map.json#L0-L9" target="_blank">route_map.json</a></div></div></div></div> <p></p></li><li><span>创建AppRouter.ets文件，声明页面路由相关操作方法。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L33-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">getPathStack</span><span class="hljs-params">()</span>: NavPathStack {</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pathStack;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L33-L36" target="_blank">AppRouter.ets</a></div></div></div></div> <p></p></li><li><span>在首页的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation" target="_blank">Navigation</a>组件中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#getpathstack19" target="_blank">getPathStack()</a>获取页面路由信息。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/pages/PlayVideo.ets#L33-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">build</span>() {</li><li>  <span class="hljs-built_in">Navigation</span>(AppRouter.getInstance()<span class="hljs-selector-class">.getPathStack</span>()) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-selector-class">.hideTitleBar</span>(true)</li><li>  <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>  <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>  <span class="hljs-selector-class">.mode</span>(NavigationMode.Stack)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/pages/PlayVideo.ets#L33-L50" target="_blank">PlayVideo.ets</a></div></div></div></div> <p></p></li><li id="li1647811562593"><span>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#pushpathbyname10" target="_blank">pushPathByName()</a>基础上封装pushByName()方法，用于页面跳转时的参数传递。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L54-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">pushByName</span>(<span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">param</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-variable">onPop</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">PopInfo</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">AppRouter</span>.<span class="hljs-variable">instance</span>.<span class="hljs-title function_">pushPathByName</span>(<span class="hljs-variable">name</span>, <span class="hljs-variable">param</span>, <span class="hljs-variable">onPop</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L54-L57" target="_blank">AppRouter.ets</a></div></div></div></div> <p></p></li><li><span>设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>的点击事件，当用户点击当前播放的视频时，保存当前播放进度，然后使用<a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#li1647811562593">pushByName()</a>方法，在页面跳转的同时将当前播放视频相关信息传递到视频详情页面。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L241-L256" data-highlighted="yes"><ol class="linenums"><li>.onClick(() =&gt; {</li><li>  <span class="hljs-comment">// Save video data</span></li><li>  AppStorage.setOrCreate(Constants.SURFACE_ID_KEY, info.surfaceID);</li><li>  <span class="hljs-keyword">this</span>.avPlayerController.videoPause();</li><li>
</li><li>  info.stopTime = <span class="hljs-keyword">this</span>.avPlayerController.currentTime;</li><li>  info.duration = <span class="hljs-keyword">this</span>.avPlayerController.duration;</li><li>  <span class="hljs-comment">// Jump video play detail</span></li><li>  AppRouter.pushByName(Constants.DETAIL_PAGE_NAME,</li><li>    new VideoParams(info, <span class="hljs-keyword">this</span>.playIdx, index), () =&gt; {</li><li>      let param: VideoParams = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">"BackParam"</span>) <span class="hljs-keyword">as</span> VideoParams;</li><li>      let _index = param.index;</li><li>      <span class="hljs-keyword">this</span>.dataSource.getData(_index).stopTime = param.videoInfo.stopTime;</li><li>      <span class="hljs-keyword">this</span>.play(param.playIdx);</li><li>    })</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L241-L256" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li><li id="li1482553124015"><span>基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#getparambyindex10" target="_blank">getParamByIndex()</a>封装getLastParams()方法，用于页面跳转后获取传递的参数。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L78-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">getLastParams</span>(): Object</span> {</li><li>  <span class="hljs-keyword">return</span> AppRouter.instance.pathStack.getParamByIndex(AppRouter.instance.pathStack.size() - <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> Object;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/common/utils/AppRouter.ets#L78-L81" target="_blank">AppRouter.ets</a></div></div></div></div> <p></p></li><li><span>在视频详情页面的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttoappear" target="_blank">aboutToAppear()</a>事件中，使用<a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#li1482553124015">getLastParams()</a>方法获取传递的参数信息，取消<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例的静音设置。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L568-L642" data-highlighted="yes"><ol class="linenums"><li>aboutToAppear(): void {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.mainWin = <span class="hljs-keyword">this</span>.windowStage.getMainWindowSync();</li><li>    <span class="hljs-keyword">this</span>.windowClass = <span class="hljs-keyword">this</span>.context.windowStage.getMainWindowSync();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    let err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>    hilog.error(Constants.DOMAIN, TAG, `getMainWindowSync error, code: ${err.code};message: ${err.message};`);</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-keyword">this</span>.setOrientation();</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// Get params</span></li><li>  let params = AppRouter.getLastParams() <span class="hljs-keyword">as</span> VideoParams;</li><li>  <span class="hljs-keyword">this</span>.info = params.videoInfo;</li><li>  <span class="hljs-keyword">this</span>.playIdx = params.playIdx;</li><li>  <span class="hljs-keyword">this</span>.index = params.index;</li><li>  <span class="hljs-keyword">this</span>.src = params.videoInfo.src <span class="hljs-keyword">as</span> string;</li><li>  <span class="hljs-keyword">this</span>.currentTime = <span class="hljs-keyword">this</span>.info.stopTime <span class="hljs-keyword">as</span> number;</li><li>  <span class="hljs-keyword">this</span>.duration = <span class="hljs-keyword">this</span>.info.duration;</li><li>  <span class="hljs-keyword">this</span>.avPlayerController.videoMuted(<span class="hljs-literal">false</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L568-L642" target="_blank">VideoDetail.ets</a></div></div></div></div> <p></p></li><li><span>在视频详情页面创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#xcomponent19" target="_blank">XComponent</a>组件。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L653-L657" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">XComponent</span>({</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>,</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">xComponentController</span></li><li>})</li><li>  .<span class="hljs-title function_">id</span>(`<span class="hljs-variable">videoXComponent_</span>${<span class="hljs-keyword">this</span>.<span class="hljs-variable">info</span>?.<span class="hljs-variable">id</span>}`)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L653-L657" target="_blank">VideoDetail.ets</a></div></div></div></div> <p></p></li><li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#xcomponent19" target="_blank">XComponent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#onload" target="_blank">onLoad()</a>事件中重新初始化<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实例，将跳转时的播放时间进度currentTime传递给<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>，然后使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>跳转到currentTime时间帧继续播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L663-L678" data-highlighted="yes"><ol class="linenums"><li>.<span class="hljs-title function_">onLoad</span>(() =&gt; {</li><li>  <span class="hljs-comment">// Init AVPlayer</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">xComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayerController</span> !== <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayerController</span>.<span class="hljs-title function_">initAVPlayer</span>({</li><li>      <span class="hljs-keyword">type</span>: <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-title class_">RAW_FILE</span>,</li><li>      <span class="hljs-variable">videoSrc</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">src</span>,</li><li>      <span class="hljs-variable">name</span>: $<span class="hljs-title class_">r</span>("<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">app_name</span>"),</li><li>      <span class="hljs-variable">description</span>: <span class="hljs-string">''</span>,</li><li>      <span class="hljs-variable">caption</span>: <span class="hljs-string">'captions.srt'</span>,</li><li>      <span class="hljs-variable">index</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">seekTime</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentTime</span>,</li><li>      <span class="hljs-variable">head</span>: $<span class="hljs-title class_">r</span>("<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">preview1</span>")</li><li>    }, <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L663-L678" target="_blank">VideoDetail.ets</a></div></div></div></div> <p></p></li><li><span>声明handleBackAction()方法，当在详情页面点击返回按钮时，记录当前播放视频的信息，包括视频当前进度、总时长、索引等。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L194-L224" data-highlighted="yes"><ol class="linenums"><li>handleBackAction() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isLayoutFullScreen) {</li><li>    <span class="hljs-comment">// Cancel full screen</span></li><li>    <span class="hljs-keyword">this</span>.isLayoutFullScreen = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.setWindowDirection(window.Orientation.PORTRAIT);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">this</span>.isPIPShow = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">this</span>.windowClass?.setWindowSystemBarProperties({</li><li>    <span class="hljs-comment">// Status bar color</span></li><li>    statusBarColor: <span class="hljs-string">'#1A1A1A'</span></li><li>  }).<span class="hljs-keyword">catch</span>((error: BusinessError) =&gt; {</li><li>    hilog.error(Constants.DOMAIN, TAG,</li><li>      `setWindowSystemBarProperties: Failed. code: ${error.code} ;message: ${error.message}`);</li><li>  });</li><li>
</li><li>  <span class="hljs-keyword">this</span>.avPlayerController.videoPause();</li><li>  <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// Save params</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.info !== undefined) {</li><li>    <span class="hljs-keyword">this</span>.info.stopTime = <span class="hljs-keyword">this</span>.avPlayerController.currentTime;</li><li>  }</li><li>  let param: VideoParams = new VideoParams(</li><li>    <span class="hljs-keyword">this</span>.info <span class="hljs-keyword">as</span> VideoInfo,</li><li>    <span class="hljs-keyword">this</span>.playIdx,</li><li>    <span class="hljs-keyword">this</span>.index</li><li>  )</li><li>  AppStorage.setOrCreate(<span class="hljs-string">"BackParam"</span>, param);</li><li>  AppRouter.popWithParam(Object({ result: <span class="hljs-literal">true</span> }));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoDetail.ets#L194-L224" target="_blank">VideoDetail.ets</a></div></div></div></div> <p></p></li><li><span>在视频列表页面的点击跳转事件<a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#li1647811562593">pushByName()</a>方法中，使用回调函数接收详情页面返回参数信息，随后调用<a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-short-video#li37514173917">play()</a>方法，设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seekTime</a>为currentTime以继续播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-fkq-c106="" class="highlight-div"><div _ngcontent-fkq-c106="" class="highlight-div-header"><div _ngcontent-fkq-c106="" class="highlight-div-header-left"><div _ngcontent-fkq-c106="" class="handle-button expand-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fkq-c106="" class="highlight-div-header-right"><div _ngcontent-fkq-c106="" class="handle-button ai-button"></div><div _ngcontent-fkq-c106="" class="handle-button line-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fkq-c106="" class="handle-button theme-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fkq-c106="" class="handle-button copy-button"><div _ngcontent-fkq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fkq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L241-L256" data-highlighted="yes"><ol class="linenums"><li>.onClick(() =&gt; {</li><li>  <span class="hljs-comment">// Save video data</span></li><li>  AppStorage.setOrCreate(Constants.SURFACE_ID_KEY, info.surfaceID);</li><li>  <span class="hljs-keyword">this</span>.avPlayerController.videoPause();</li><li>
</li><li>  info.stopTime = <span class="hljs-keyword">this</span>.avPlayerController.currentTime;</li><li>  info.duration = <span class="hljs-keyword">this</span>.avPlayerController.duration;</li><li>  <span class="hljs-comment">// Jump video play detail</span></li><li>  AppRouter.pushByName(Constants.DETAIL_PAGE_NAME,</li><li>    new VideoParams(info, <span class="hljs-keyword">this</span>.playIdx, index), () =&gt; {</li><li>      let param: VideoParams = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">"BackParam"</span>) <span class="hljs-keyword">as</span> VideoParams;</li><li>      let _index = param.index;</li><li>      <span class="hljs-keyword">this</span>.dataSource.getData(_index).stopTime = param.videoInfo.stopTime;</li><li>      <span class="hljs-keyword">this</span>.play(param.playIdx);</li><li>    })</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/blob/master/entry/src/main/ets/component/VideoList.ets#L241-L256" target="_blank">VideoList.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section069716165712">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section069716165712" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/avplayer-embeded-short-video/tree/master/" target="_blank">基于AVPlayer实现嵌入式短视频播放</a></li></ul> </div> </div> <div></div></div>