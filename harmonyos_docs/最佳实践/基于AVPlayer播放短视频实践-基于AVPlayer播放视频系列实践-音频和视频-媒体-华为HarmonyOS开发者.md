<h1 _ngcontent-vab-c119="" class="doc-title ng-star-inserted" title="基于AVPlayer播放短视频实践"> 基于AVPlayer播放短视频实践 </h1>

<div _ngcontent-vab-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section2052910310123">概述<i class="anchor-icon anchor-icon-link" anchorid="section2052910310123" tips="复制节点链接"></i></h2></div> <p>短视频已成为内容消费的核心场景，用户对“秒开、丝滑、沉浸”的体验阈值极高。本示例基于AVPlayer能力，实现短视频流畅切换，提炼出一套可复制的方案，帮助开发者交付极速、流畅的播放体验。本文指导开发者实现以下几种场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-short-video#section19871518619">基本播控能力</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-short-video#section9451174918313">焦点管理</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-short-video#section1560144415411">前后台感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-short-video#section92411245940">横竖屏切换和旋转感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-short-video#section49561448161814">短视频列表流畅切换</a></li></ul> <div class="tiledSection"><h2 id="section19871518619">基本播控能力<i class="anchor-icon anchor-icon-link" anchorid="section19871518619" tips="复制节点链接"></i></h2><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实现视频资源加载、播放、暂停、停止、退出操作，包含了静音播放、倍数设置和字幕挂载等功能，原理详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-basic-control" target="_blank">《基于AVPlayer基础播控实践》</a>。</p> </div> <div class="tiledSection"><h2 id="section9451174918313">焦点管理<i class="anchor-icon anchor-icon-link" anchorid="section9451174918313" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section656385619479" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section656385619479" tips="复制节点链接"></i></h3><p>前台视频播放过程中，音频被后台闹钟、电话等中断事件打断，完成播放过程音视频焦点管理。</p> </div> <div class="tiledSection"><h3 id="section154361774810">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section154361774810" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section468112791916" target="_blank">焦点管理开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section1560144415411">前后台感知<i class="anchor-icon anchor-icon-link" anchorid="section1560144415411" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1856593314246" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1856593314246" tips="复制节点链接"></i></h3><p>应用从后台切回到前台时，保持原视频播放且会从之前的位置继续播放。</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.08254833446035318793857815744568:50001231000000:2800:614900C671867AF149A08DD738823C319F8C747DEF8BB5528D787FEF1DE85EE5.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section5161191418280">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5161191418280" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1448773335411" target="_blank">前后台感知开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section92411245940">横竖屏切换和旋转感知<i class="anchor-icon anchor-icon-link" anchorid="section92411245940" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1070517693713" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1070517693713" tips="复制节点链接"></i></h3><p>播放视频时可以手动进行横竖屏切换，也支持根据设备旋转方向自动切换横竖屏模式，以适应不同屏幕方向下的视频播放需求。</p> <p><span><img height="252.3675" originheight="800" originwidth="1654" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.56952876532793409873927432244332:50001231000000:2800:D107CC76D72B2E89875C6CD7C2DB8F076EC6F17409CAB45C1F7D0F8E7B3B5494.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section6116162012377">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section6116162012377" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1257185216407" target="_blank">横竖屏切换和旋转感知开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section49561448161814">短视频列表流畅切换<i class="anchor-icon anchor-icon-link" anchorid="section49561448161814" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section163519204199" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section163519204199" tips="复制节点链接"></i></h3></div> <p>短视频：小于5分钟的短视频为例进行说明。</p> <ol><li>应用内滑动视频，新视频起播时延≤230ms（不包含滑动动画效果耗时）。</li><li>起点时间：松手时的时间。</li><li>终点时间：视频内容开始播放，画面首次变化的时间。</li></ol> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.94923853265431898980694868850167:50001231000000:2800:B65D5ED45C5E8F5BE5E974BA40FC2836F5C038C56F1094543C0C042B9F0D9477.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section154709395179">场景体验指标<i class="anchor-icon anchor-icon-link" anchorid="section154709395179" tips="复制节点链接"></i></h3></div> <p>起播时延计时标准</p> <p>1、以用户滑动屏幕后抬手、手指离屏的时刻为起点，以视频第二帧画面显示的时刻为终点。</p> <p>2、转场动画时长建议设置为300ms。</p> <p>3、在动画开始时使用预先准备的播放器起播，起播时延不超过230ms。</p> <div class="tiledSection"><h3 id="section1068530182019">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1068530182019" tips="复制节点链接"></i></h3><ol><li>数据懒加载<p>冷启动时创建第一个播放器，播放当前视频时预加载下一个视频（预加载会增加用户流量消耗，需开发者自行决策）。使用XComponent的Surface类型动态渲染视频流，LazyForEach进行数据懒加载。</p> </li><li>异步在线视频预加载<p>在轮播过程中，对下一个视频提前进入AVPlayer的prepared状态。</p> </li><li>在线视频播放预接力<p>滑动过程中，手指离开屏幕时，滑动动效开始播放。此时，可以调用AVPlayer的play方法进行播放。</p> </li></ol> <div class="fignone"><span class="figcap"><b>图1 </b><strong>流程图</strong></span></div> <p><span><img height="411.91429999999997" originheight="525" originwidth="1014" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.90199599465608464763734970058931:50001231000000:2800:933F4B3E1A3282C5BB8372E47961F8327F5D8C186CC7AFB56B1E31E830ECC613.png" title="点击放大" width="798"></span></p> </div> <p>1. 使用视频播放框架AVPlayer可以将Audio/Video媒体资源（比如mp4/mp3/mkv/mpeg-ts等）转码为可供渲染的图像和可听见的音频模拟信号，并通过输出设备进行播放。</p> <p>2. 使用LazyForEach进行数据懒加载，设置cachedCount属性指定缓存数量，搭配组件复用能力。冷启动时创建并初始化AVPlayer到prepared阶段。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在滚动容器中使用了LazyForEach，框架会根据滚动容器可视区域按需创建组件，当组件滑出可视区域外时，框架会进行组件销毁回收以降低内存占用，详情参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">《LazyForEach》</a>。</p> </div></div></div> <p>3. 在滑块视图容器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-looping" target="_blank">Swiper</a>进行短视频滑动轮播过程中，会根据当前轮询滑动的窗口索引index到缓存池中找到对应的视频（prepared阶段），直接进行播放，从而提高切换性能。</p> <div class="fignone"><span class="figcap"><b>图2 </b><strong>异步加载示意图</strong></span></div> <p><span><img height="393.68" originheight="460" originwidth="932" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163046.39447620838725383615653701447803:50001231000000:2800:73A616113D01B376A6E6DB493BB9F84042F5E979D5867A947F892A2EE998B60E.png" title="点击放大" width="798"></span></p> <p>在缓存池中有多个播放器实例，播放视频A时，提前预加载视频B并进入prepare状态；切换短视频时，可以立即播放已预加载的视频B，减少切换时间。手势上下滑动的时候，在动画开始时就更新当前索引值，最终实现短视频快速切换，综合起播时间≤230ms。</p> <div class="tiledSection"><h3 id="section18650841191919">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section18650841191919" tips="复制节点链接"></i></h3></div> <ol><li><span>在swiper组件中对播放组件AVPlayerView使用懒加载，确保每个视频有单独的Xcomponent、SurfaceID和AVPlayer播放器。</span></li><li><span>通过设置swiper组件cachedCount属性确定缓存池大小，缓存池中的视频提前进入prepared状态；在动画开始的回调函数onAnimationStart()中就更新当前索引curIndex，而不是等动画结束更新。不使用默认的弹簧曲线（弹簧动效持续560毫秒），将曲线改为Curve.Ease，并将持续时间设置为300毫秒。</span><p></p><div class="screenLinkPre"><div _ngcontent-vab-c106="" class="highlight-div"><div _ngcontent-vab-c106="" class="highlight-div-header"><div _ngcontent-vab-c106="" class="highlight-div-header-left"><div _ngcontent-vab-c106="" class="handle-button expand-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vab-c106="" class="highlight-div-header-right"><div _ngcontent-vab-c106="" class="handle-button ai-button"></div><div _ngcontent-vab-c106="" class="handle-button line-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vab-c106="" class="handle-button theme-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vab-c106="" class="handle-button copy-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-short-video/blob/master/entry/src/main/ets/pages/Index.ets#L60-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Swiper</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperController</span>) {</li><li>  <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">AVDataSource</span>(<span class="hljs-variable">SOURCES</span>), (<span class="hljs-variable">item</span>: <span class="hljs-title class_">VideoData</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-title function_">AVPlayerView</span>({</li><li>      <span class="hljs-variable">curSource</span>: <span class="hljs-title class_">item</span>,</li><li>      <span class="hljs-variable">curIndex</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">curIndex</span>,</li><li>      <span class="hljs-variable">index</span>: <span class="hljs-title class_">index</span>,</li><li>      <span class="hljs-variable">isPageShow</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isPageShow</span></li><li>    })</li><li>  })</li><li>}</li><li>.<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">2</span>)</li><li>.<span class="hljs-title function_">vertical</span>(<span class="hljs-keyword">true</span>)</li><li>.<span class="hljs-title function_">loop</span>(<span class="hljs-keyword">true</span>)</li><li>.<span class="hljs-title function_">curve</span>(<span class="hljs-variable">Curve</span>.<span class="hljs-variable">Ease</span>)</li><li>.<span class="hljs-title function_">duration</span>(<span class="hljs-number">300</span>)</li><li>.<span class="hljs-title function_">indicator</span>(<span class="hljs-keyword">false</span>)</li><li>.<span class="hljs-title function_">onGestureSwipe</span>((<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">extraInfo</span>: <span class="hljs-title class_">SwiperAnimationEvent</span>) =&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onGestureSwipe</span> <span class="hljs-variable">index</span>:${<span class="hljs-variable">index</span>} , <span class="hljs-variable">extraInfo</span>: ${<span class="hljs-variable">extraInfo</span>}`);</li><li>})</li><li>.<span class="hljs-title function_">onAnimationStart</span>((<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">targetIndex</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">extraInfo</span>: <span class="hljs-title class_">SwiperAnimationEvent</span>) =&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onAnimationStart</span> <span class="hljs-variable">index</span>:${<span class="hljs-variable">index</span>} , <span class="hljs-variable">targetIndex</span>: ${<span class="hljs-variable">targetIndex</span>},<span class="hljs-variable">extraInfo</span>: ${<span class="hljs-variable">extraInfo</span>}`);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">curIndex</span> = <span class="hljs-variable">targetIndex</span>;</li><li>  <span class="hljs-comment">// key point: Animation starts updating index</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-short-video/blob/master/entry/src/main/ets/pages/Index.ets#L60-L83" target="_blank">Index.ets</a></div></div></div></div> <p></p></li><li><span>使用@Watch监听当前索引curIndex值，对比当前索引curIndex和轮播索引index，仅播放索引相同的视频，缓存池其余视频均暂停。</span><p></p><div class="screenLinkPre"><div _ngcontent-vab-c106="" class="highlight-div"><div _ngcontent-vab-c106="" class="highlight-div-header"><div _ngcontent-vab-c106="" class="highlight-div-header-left"><div _ngcontent-vab-c106="" class="handle-button expand-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vab-c106="" class="highlight-div-header-right"><div _ngcontent-vab-c106="" class="handle-button ai-button"></div><div _ngcontent-vab-c106="" class="handle-button line-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vab-c106="" class="handle-button theme-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vab-c106="" class="handle-button copy-button"><div _ngcontent-vab-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vab-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/HarmonyOS_Samples/avplayer-short-video/blob/master/entry/src/main/ets/pages/AVPlayerView.ets#L31-L40" data-highlighted="yes"><ol class="linenums"><li>async onIndexChange() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.curIndex !== <span class="hljs-keyword">this</span>.index) {</li><li>    <span class="hljs-keyword">this</span>.avPlayerController.videoPause();</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avPlayerController.isReady === <span class="hljs-literal">true</span>) {</li><li>      <span class="hljs-keyword">this</span>.avPlayerController.languageChange(AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'currentLanguageType'</span>))</li><li>      <span class="hljs-keyword">this</span>.avPlayerController.videoPlay();</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/HarmonyOS_Samples/avplayer-short-video/blob/master/entry/src/main/ets/pages/AVPlayerView.ets#L31-L40" target="_blank">AVPlayerView.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection"><h2 id="section12252163216512">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section12252163216512" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/avplayer-short-video" target="_blank">基于AVPlayer播放短视频实践</a></li></ul> </div> </div> <div></div></div>