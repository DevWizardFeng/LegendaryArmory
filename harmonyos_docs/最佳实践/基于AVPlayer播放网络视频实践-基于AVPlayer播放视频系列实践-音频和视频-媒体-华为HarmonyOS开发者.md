<h1 _ngcontent-skc-c119="" class="doc-title ng-star-inserted" title="基于AVPlayer播放网络视频实践"> 基于AVPlayer播放网络视频实践 </h1>

<div _ngcontent-skc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section511124755514">概述<i class="anchor-icon anchor-icon-link" anchorid="section511124755514" tips="复制节点链接"></i></h2></div> <p>本文适用于网络视频播放类应用开发，针对市场上主流网络视频播放类应用常见场景，介绍如何基于AVPlayer系统播放器实现网络视频播放。本文指导开发者实现以下场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section102791912878">基本播控</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section878625410102">焦点管理</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section28801440152211">弹幕发送与显示</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section16229471226">画中画播放</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section178071122418">横竖屏切换与旋转感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section269016599556">网络视频URL设置</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section14584123411115">网络视频缓冲条</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-embeded-network-video#section1383513409117">网络视频边缓冲边播放</a></li></ul> <div class="tiledSection"><h2 id="section102791912878">基础播控<i class="anchor-icon anchor-icon-link" anchorid="section102791912878" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section5235017917" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section5235017917" tips="复制节点链接"></i></h3><p>通过AVPlayer实现视频资源加载、播放、暂停、停止、退出、倍速播放、静音播放、窗口缩放模式、音量调节等操作。详细信息可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-basic-control" target="_blank">《基于AVPlayer基础播控实践》</a>。</p> </div> <div class="tiledSection"><h2 id="section878625410102">焦点管理<i class="anchor-icon anchor-icon-link" anchorid="section878625410102" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1298311549352" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1298311549352" tips="复制节点链接"></i></h3><p>通过正确设置音频流类型、中断事件处理和自定义焦点策略，完成播放过程中的音频焦点管理。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.23886084693394152754588684832786:50001231000000:2800:8CD5841E2270671A461FFCE5CD862F46E402ED6DBC5FDBC1FCC307B77C360D02.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section5777121151411">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5777121151411" tips="复制节点链接"></i></h3><p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1716082163419" target="_blank">焦点管理开发步骤</a>。</p> </div> <div class="tiledSection"><h2 id="section28801440152211">弹幕发送与显示<i class="anchor-icon anchor-icon-link" anchorid="section28801440152211" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section9621106134210" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section9621106134210" tips="复制节点链接"></i></h3></div> <p>视频弹幕发送与显示是影音娱乐类应用中的高频使用场景之一，如用户在播放视频、观看直播时可以发送弹幕，实时评论互动，增强用户参与度。</p> <div class="tiledSection"><h3 id="section132542034111411">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section132542034111411" tips="复制节点链接"></i></h3></div> <p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section168137393711" target="_blank">弹幕发送与显示开发步骤</a>。</p> <div class="tiledSection"><h2 id="section16229471226">画中画播放<i class="anchor-icon anchor-icon-link" anchorid="section16229471226" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1146065915426" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1146065915426" tips="复制节点链接"></i></h3></div> <p>应用在视频播放时，可以使用画中画能力将视频内容以小窗（画中画）模式呈现。切换为小窗（画中画）模式后，用户可以进行其他界面操作，提升使用体验。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163047.12409931456441602782656079903576:50001231000000:2800:A60CD1C1211382C0519444FA0494F208ABDB606B2107DC7478A54E5190D7DEC8.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section12408514111618">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section12408514111618" tips="复制节点链接"></i></h3></div> <p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section4691194231313" target="_blank">画中画播放开发步骤</a>。</p> <div class="tiledSection"><h2 id="section178071122418">横竖屏切换与旋转感知<i class="anchor-icon anchor-icon-link" anchorid="section178071122418" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1564865334317" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1564865334317" tips="复制节点链接"></i></h3></div> <p>用户播放视频时可以根据实际需求进行横竖屏切换。</p> <p><span><img height="244.38750000000002" originheight="1080" originwidth="2306" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163048.13983250088004710634483760062715:50001231000000:2800:20ACC819285EF9D5E94D54C619CDD1788F40FA4C774722F0B852B92D9B332B2D.gif" title="点击放大" width="523.6875"></span></p> <div class="tiledSection"><h3 id="section5407129101812">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5407129101812" tips="复制节点链接"></i></h3></div> <p>具体开发步骤可参考基于AVPlayer播放长视频实践的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1257185216407" target="_blank">横竖屏切换和旋转感知开发步骤</a>。</p> <div class="tiledSection"><h2 id="section269016599556">通过URL设置视频源<i class="anchor-icon anchor-icon-link" anchorid="section269016599556" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section557683410310" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section557683410310" tips="复制节点链接"></i></h3><p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163048.67555347469125243569410413279973:50001231000000:2800:254097242204BB33D75BC3F468EBDD880E85C4F731C7195636CBD38CBA00CED4.gif" title="点击放大" width="266"></span></p> </div> <p>用AVPlayer开发播放功能，在不同场景下如何设置URL。该特性主要用于AVPlayer播放网络流媒体资源，包括在线流媒体链接及本地m3u8流媒体记录文件。在线流媒体支持以下协议：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.29.1.3.1.1" valign="top" width="50%"><p>流媒体协议类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.29.1.3.1.2" valign="top" width="50%"><p>典型链接</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>HLS</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>https://xxxx/index.m3u8</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>DASH</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>https://xxxx.mpd</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>HTTP/HTTPS</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>https://xxxx.mp4</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>HTTP-FLV</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>https://xxxx.flv</p> </td> </tr>  </tbody></table></div> </div> <p>详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/streaming-media-playback-development-guide" target="_blank">使用AVPlayer播放流媒体(ArkTS)</a></p> <p>本章节主要介绍如何配置HLS协议和HTTP/HTTPS协议的在线链接URL，以及如何设置本地M3U8文件和MP4文件的URL，以实现视频播放功能。</p> <div class="tiledSection"><h3 id="section469316156517">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section469316156517" tips="复制节点链接"></i></h3><p>AVPlayer通过URL形式配置播放源，有以下两种方式：</p> <ul><li>一种是直接设置AVPlayer的url属性，适用于不需要额外配置项的场景，例如下文的在线视频配置URL示例。</li><li>另一种是调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreatemediasourcewithurl12" target="_blank">media.createMediaSourceWithUrl()</a>函数通过URL创建播放源，然后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setmediasource12" target="_blank">AVPlayer.setMediaSource()</a>方法设置播放源，适用于需要额外配置媒体类型或者播放策略的场景，例如下文的本地M3U8文件配置URL示例。</li></ul> </div> <div class="tiledSection"><h3 id="section527065914312">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section527065914312" tips="复制节点链接"></i></h3></div> <ol><li><span>创建AVPlayer。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L52-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay avPlayerDemo'</span>);</li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L52-L169" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>设置AVPlayer的url属性，或者调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreatemediasourcewithurl12" target="_blank">media.createMediaSourceWithUrl()</a>函数通过URL创建播放源，并配置到AVPlayer，之后AVPlayer将自动进入initialized状态。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L51-L170" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay avPlayerDemo'</span>);</li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// Creates a callback function for state machine changes.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay setAVPlayerCallback'</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer failed context not set`</span>);</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// Set online video source by url</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">URL</span>:</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>;</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>          <span class="hljs-string">`initPlayer videoPlay url = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">this</span>.avPlayer.url)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// Set the mediaSource by url with playbackStrategy</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">RAW_M3U8_FILE</span>:</li><li>        <span class="hljs-keyword">let</span> m3u8Fd = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>);</li><li>        <span class="hljs-keyword">let</span> fdUrl = <span class="hljs-string">'fd://'</span> + m3u8Fd.<span class="hljs-property">fd</span> + <span class="hljs-string">'?offset='</span> + m3u8Fd.<span class="hljs-property">offset</span> + <span class="hljs-string">'&amp;size='</span> + m3u8Fd.<span class="hljs-property">length</span>;</li><li>        <span class="hljs-comment">// create mediaSource by the URL instead of an assigned URL</span></li><li>        <span class="hljs-keyword">let</span> mediaSource = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(fdUrl);</li><li>        mediaSource.<span class="hljs-title function_">setMimeType</span>(media.<span class="hljs-property">AVMimeTypes</span>.<span class="hljs-property">APPLICATION_M3U8</span>);</li><li>        <span class="hljs-comment">// create PlaybackStrategy</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">playbackStrategy</span>: media.<span class="hljs-property">PlaybackStrategy</span> = { <span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">showFirstFrameOnPrepare</span>: <span class="hljs-literal">true</span> };</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer videoPlay fdUrl = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(fdUrl)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// Set local video source by url</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">RAW_MP4_FILE</span>:</li><li>        <span class="hljs-keyword">let</span> mp4Fd = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>);</li><li>        <span class="hljs-keyword">let</span> mp4FdUrl = <span class="hljs-string">'fd://'</span> + mp4Fd.<span class="hljs-property">fd</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = mp4FdUrl;</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer videoPlay fdUrl = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(mp4FdUrl)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>
</li><li>      <span class="hljs-attr">default</span>:</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer failed VideoDataType is invalid`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCaption</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L51-L170" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection"><h2 id="section14584123411115">网络视频缓冲条<i class="anchor-icon anchor-icon-link" anchorid="section14584123411115" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6237125614121" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section6237125614121" tips="复制节点链接"></i></h3></div> <p>网络视频缓冲进度条是影音娱乐类应用中的典型场景之一，如用户播放在线视频时，进度条显示当前缓冲的可播放进度。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163048.89218666468538032014980577364267:50001231000000:2800:36E40A23F436BE95CB621020D6D2C61F092B9E935E00DDC2BB90BACF55B77EFB.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section15655642105">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section15655642105" tips="复制节点链接"></i></h3><p>本示例基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>实现在线视频播放，基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider</a>实现视频播放和缓冲进度条显示。由于Slider没有多进度特性，这里使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-stack-layout" target="_blank">Stack</a>布局，将缓冲条Slider和进度条Slider重叠显示，来实现缓冲进度和播放进度同时显示的效果。</p> <p>其中缓冲条Slider的value值绑定由@State修饰的状态变量currentBufferTime，并通过注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onbufferingupdate9" target="_blank">bufferingUpdate</a>事件处理函数，在该函数中获取已缓冲内容预计可播放时长，结合已播放时长得到当前缓冲进度。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>由于bufferingUpdate事件的回调函数参数中，infoType为media.BufferingInfoType.CACHED_DURATION时，value为已缓冲内容预计可播放时长，该值为预估值，所以缓冲进度亦为预估值，并不能保证百分百精准。bufferingUpdate事件的回调函数参数详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-t#onbufferingupdatehandler12" target="_blank">OnBufferingUpdateHandler</a>。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section1977016071312">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1977016071312" tips="复制节点链接"></i></h3><ol><li><span>创建AVPlayer，并配置好相应的播放源。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L56-L198" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay avPlayerDemo'</span>);</li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// Creates a callback function for state machine changes.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay setAVPlayerCallback'</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer failed context not set`</span>);</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">URL</span>:</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>;</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>          <span class="hljs-string">`initPlayer videoPlay url = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">this</span>.avPlayer.url)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCaption</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L56-L198" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#ontimeupdate9" target="_blank">timeUpdate</a>事件处理函数，并在函数中更新由@State修饰的状态变量currentTime。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L216-L315" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'timeUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">time: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'CurrentTime'</span>, time);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`setAVPlayerCallback timeUpdate success,and new time is = <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentTime}</span>`</span>);</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L216-L315" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onbufferingupdate9" target="_blank">bufferingUpdate</a>事件处理函数，并在函数中更新由@State修饰的状态变量currentBufferTime。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L218-L317" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setAVPlayerCallback</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Listen to the streaming media buffer status and the estimated playback duration of the buffered data</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'bufferingUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">infoType: media.BufferingInfoType, value: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`BufferedProgressBar bufferingUpdate, infoType is <span class="hljs-subst">${infoType}</span>, value is <span class="hljs-subst">${value}</span>.`</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (infoType === media.<span class="hljs-property">BufferingInfoType</span>.<span class="hljs-property">CACHED_DURATION</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBufferTime</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentBufferTime</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> + value);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`currentBufferTime: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentBufferTime}</span>`</span>)</li><li>    }</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L218-L317" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>绑定currentTime到播放Slider的value属性，绑定currentBufferTime到缓冲Slider的value属性，并利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-stack-layout" target="_blank">Stack</a>布局将播放<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider</a>和缓冲Slider重叠在一起，然后设置播放Slider的trackColor为透明，缓冲Slider的style属性设为SliderStyle.NONE以隐藏滑块。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/pages/BufferBarPlayer.ets#L34-L70" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-title function_">progressBuilder</span>() {</li><li>  <span class="hljs-title function_">Stack</span>() {</li><li>    <span class="hljs-title function_">Slider</span>({</li><li>      <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">currentTime</span>,</li><li>      <span class="hljs-variable">min</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_PROGRESS_MIN</span>,</li><li>      <span class="hljs-variable">max</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">durationTime</span>,</li><li>      <span class="hljs-variable">step</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_PROGRESS_STEP</span>,</li><li>      <span class="hljs-variable">direction</span>: <span class="hljs-title class_">Axis</span>.<span class="hljs-title class_">Horizontal</span></li><li>    })</li><li>      .<span class="hljs-title function_">blockColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">trackColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.track_color_show'</span>))</li><li>      .<span class="hljs-title function_">selectedColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.slider_selected'</span>))</li><li>      .<span class="hljs-title function_">trackThickness</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">zIndex</span>(<span class="hljs-number">1</span>)</li><li>      .<span class="hljs-title function_">onChange</span>((<span class="hljs-variable">value</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">avPlayerController</span>.<span class="hljs-title function_">videoSeek</span>(<span class="hljs-variable">value</span>);</li><li>      })</li><li>
</li><li>    <span class="hljs-title function_">Slider</span>({</li><li>      <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">currentBufferTime</span>,</li><li>      <span class="hljs-variable">min</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_PROGRESS_MIN</span>,</li><li>      <span class="hljs-variable">max</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">durationTime</span>,</li><li>      <span class="hljs-variable">step</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_PROGRESS_STEP</span>,</li><li>      <span class="hljs-variable">direction</span>: <span class="hljs-title class_">Axis</span>.<span class="hljs-title class_">Horizontal</span>,</li><li>      <span class="hljs-variable">style</span>: <span class="hljs-title class_">SliderStyle</span>.<span class="hljs-title class_">NONE</span></li><li>    })</li><li>      .<span class="hljs-title function_">trackColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Grey</span>)</li><li>      .<span class="hljs-title function_">selectedColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">blockColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.track_color_show'</span>))</li><li>      .<span class="hljs-title function_">trackThickness</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">12</span>, <span class="hljs-variable">right</span>: <span class="hljs-number">12</span> })</li><li>      .<span class="hljs-title function_">zIndex</span>(<span class="hljs-number">0</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/pages/BufferBarPlayer.ets#L34-L70" target="_blank">BufferBarPlayer.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section1383513409117">网络视频边缓冲边播放<i class="anchor-icon anchor-icon-link" anchorid="section1383513409117" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17579852138" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section17579852138" tips="复制节点链接"></i></h3></div> <p>网络视频边缓冲边播放是影音娱乐类应用中的典型场景之一，如用户播放在线视频时，不用等待视频资源完全加载（缓冲）后再进行播放，可以缓冲到一定资源后，就可直接起播。AVPlayer自带边缓冲边播放的特性，本章节介绍AVPlayer缓冲区相关参数配置。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163048.13224519204229034432199937151430:50001231000000:2800:E9265DD78A80CB4D38CDF9F8B4FA0AA32D687F247F969E34515F9734FB7A650C.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section1838919784617">AVPlayer缓冲区工作过程<i class="anchor-icon anchor-icon-link" anchorid="section1838919784617" tips="复制节点链接"></i></h3><p>对于缓冲区而言，下载线程是生产端，读取线程则是消费端。生产端将数据写入到缓冲区中，消费端则从缓冲区读取数据，下面将介绍缓冲区中的几个水位线概念。</p> <p><span><img height="366.52139999999997" originheight="570" originwidth="1241" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163048.89642700276381051860753485511363:50001231000000:2800:5CA7973EC6432D643C0F80A70C1E6B6918A3052BDCE85FAF9E8948156AAED043.png" title="点击放大" width="798"></span></p> <p>以上四个水位线取值情况如下，其中起播水位线，和下载暂停水位线（缓冲区大小）可通过配置AVPlayer的播放策略来控制，其他两个暂未提供配置接口。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.45.5.1.4.1.1" valign="top" width="33.33333333333333%"><p>水位线</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.45.5.1.4.1.2" valign="top" width="33.33333333333333%"><p>默认值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.45.5.1.4.1.3" valign="top" width="33.33333333333333%"><p>说明</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>起播水位线</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>若下载速率 &gt;= 码率场景，起播水位线取值：0.3秒 * 码率</p> <p>若下载速率 &lt; 码率场景，起播水位线取值：5秒 * 码率</p> <p>若起播水位线小于10KB，取10KB</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>在快速起播和顺滑播放间进行一个相对合理的分割。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>止播水位线</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>单次读取数据量，若小于5KB则取5KB</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>避免将缓冲区中的可用数据耗尽。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>下载启动水位线</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>480KB</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>降低线程启动频率，进行集中下载，降低cpu及指令数消耗。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>下载暂停水位线</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>缓冲区大小</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>当缓冲区写满时，停止下载，支持修改。</p> </td> </tr>  </tbody></table></div> </div> <p>起播水位线的默认值是根据下载速率确定，下载速率 &gt;= 码率时，取值：0.3秒 * 码率，即缓冲速度大于播放速度时，缓冲到0.3秒，开始播放；下载速率 &lt; 码率时，起播水位线取值：5秒 * 码率，即在缓冲内容累计满5秒后开始播放。这样可以在网络好的情况下快起播，减少用户等待时间，在网络差的情况下慢起播，避免播放和暂停状态间频繁来回切换，影响用户体验。若开发者不满足默认设置，可通过配置AVPlayer播放策略<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>来控制起播水位线。</p> <p>下载暂停水位线是指已缓冲，但还未被消费（播放）数据最大占用空间，该值的大小依赖于缓冲区大小，可通过配置缓冲区大小间接控制该参数值。该值设置太小的话，在网络波动较大的环境，可能会影响视频播放的顺滑度；设置太大的情况下，一定程度会浪费用户网络资源。该参数默认为最大值20M，开发者可根据需要自行配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>中的preferredBufferDuration参数来控制缓冲区大小。preferredBufferDuration的单位为秒，缓冲区大小将被设定为preferredBufferDuration * 1MB。例如，将preferredBufferDuration设为20秒，缓冲区大小将被设置为20MB。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.45.8.1.3.1.1" valign="top" width="50%"><p>默认缓冲区大小</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.45.8.1.3.1.2" valign="top" width="50%"><p>用户自定义缓冲区大小</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>20MB</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>5MB ~ 20MB</p> </td> </tr>  </tbody></table></div> </div> <p>起播水位线和下载暂停水位线（缓冲区大小）的配置方式均由AVPlayer的播放策略控制，播放策略的配置方式有两种：</p> <ul><li>一种是通过AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setmediasource12" target="_blank">setMediaSource()</a>方法将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>实例配置进AVPlayer，详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-online-video-playback-lags-practice#section1411814743015" target="_blank">在线视频播放卡顿优化</a>。</li><li>另一种是通过AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setplaybackstrategy12" target="_blank">setPlaybackStrategy()</a>方法将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>实例配置进AVPlayer，第二种需要在AVPlayer状态为initialized或者stopped时，才可生效。</li></ul> </div> <div class="tiledSection"><h3 id="section143207341132">通过setMediaSource()方法配置<i class="anchor-icon anchor-icon-link" anchorid="section143207341132" tips="复制节点链接"></i></h3><ol><li><span>创建AVPlayer，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-f#mediacreatemediasourcewithurl12" target="_blank">media.createMediaSourceWithUrl()</a>方法生成MediaSource实例。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L57-L201" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay avPlayerDemo'</span>);</li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// Creates a callback function for state machine changes.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay setAVPlayerCallback'</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer failed context not set`</span>);</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">RAW_M3U8_FILE</span>:</li><li>        <span class="hljs-keyword">let</span> m3u8Fd = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>);</li><li>        <span class="hljs-keyword">let</span> fdUrl = <span class="hljs-string">'fd://'</span> + m3u8Fd.<span class="hljs-property">fd</span> + <span class="hljs-string">'?offset='</span> + m3u8Fd.<span class="hljs-property">offset</span> + <span class="hljs-string">'&amp;size='</span> + m3u8Fd.<span class="hljs-property">length</span>;</li><li>        <span class="hljs-comment">// create mediaSource by the URL instead of an assigned URL</span></li><li>        <span class="hljs-keyword">let</span> mediaSource = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(fdUrl);</li><li>        mediaSource.<span class="hljs-title function_">setMimeType</span>(media.<span class="hljs-property">AVMimeTypes</span>.<span class="hljs-property">APPLICATION_M3U8</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCaption</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L57-L201" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>创建PlaybackStrategy实例，并通过AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setmediasource12" target="_blank">setMediaSource()</a>方法，将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>实例配置进AVPlayer。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L58-L202" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">RAW_M3U8_FILE</span>:</li><li>        <span class="hljs-keyword">let</span> m3u8Fd = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>);</li><li>        <span class="hljs-keyword">let</span> fdUrl = <span class="hljs-string">'fd://'</span> + m3u8Fd.<span class="hljs-property">fd</span> + <span class="hljs-string">'?offset='</span> + m3u8Fd.<span class="hljs-property">offset</span> + <span class="hljs-string">'&amp;size='</span> + m3u8Fd.<span class="hljs-property">length</span>;</li><li>        <span class="hljs-comment">// create mediaSource by the URL instead of an assigned URL</span></li><li>        <span class="hljs-keyword">let</span> mediaSource = media.<span class="hljs-title function_">createMediaSourceWithUrl</span>(fdUrl);</li><li>        mediaSource.<span class="hljs-title function_">setMimeType</span>(media.<span class="hljs-property">AVMimeTypes</span>.<span class="hljs-property">APPLICATION_M3U8</span>);</li><li>        <span class="hljs-comment">// create PlaybackStrategy</span></li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">playbackStrategy</span>: media.<span class="hljs-property">PlaybackStrategy</span> = { <span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">showFirstFrameOnPrepare</span>: <span class="hljs-literal">true</span> };</li><li>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setMediaSource</span>(mediaSource, playbackStrategy);</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer videoPlay fdUrl = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(fdUrl)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCaption</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L58-L202" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section152868350236">通过setPlaybackStrategy()方法配置<i class="anchor-icon anchor-icon-link" anchorid="section152868350236" tips="复制节点链接"></i></h3><ol><li><span>创建AVPlayer，并直接通过赋值AVPlayer.url属性，对AVPlayer初始化。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L59-L198" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create an AVPlayer instance</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVPlayer</span>(<span class="hljs-params">source: VideoData, surfaceId: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay avPlayerDemo'</span>);</li><li>    <span class="hljs-comment">// Creates the avPlayer instance object.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>();</li><li>    <span class="hljs-comment">// Creates a callback function for state machine changes.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAVPlayerCallback</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'initPlayer videoPlay setAVPlayerCallback'</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`initPlayer failed context not set`</span>);</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">type</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-keyword">case</span> <span class="hljs-title class_">VideoDataType</span>.<span class="hljs-property">URL</span>:</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">url</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">curSource</span>.<span class="hljs-property">videoSrc</span>;</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>          <span class="hljs-string">`initPlayer videoPlay url = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">this</span>.avPlayer.url)}</span>`</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCaption</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`initPlayer initPlayer, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L59-L198" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>注册AVPlayer的状态回调函数，并在initialized状态回调中配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">PlaybackStrategy</a>实例。</span><p></p><div class="screenLinkPre"><div _ngcontent-skc-c106="" class="highlight-div"><div _ngcontent-skc-c106="" class="highlight-div-header"><div _ngcontent-skc-c106="" class="highlight-div-header-left"><div _ngcontent-skc-c106="" class="handle-button expand-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-skc-c106="" class="highlight-div-header-right"><div _ngcontent-skc-c106="" class="handle-button ai-button"></div><div _ngcontent-skc-c106="" class="handle-button line-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-skc-c106="" class="handle-button theme-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-skc-c106="" class="handle-button copy-button"><div _ngcontent-skc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-skc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L392-L481" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Callback function for state machine changes</span></li><li><span class="hljs-keyword">this</span>.avPlayer.on(<span class="hljs-string">'stateChange'</span>, async (state) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayer) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  switch (state) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    case <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// This status is reported after the playback source is set on the AVPlayer.</span></li><li>      hilog.info(CommonConstants.LOG_DOMAIN, TAG, <span class="hljs-string">'setAVPlayerCallback AVPlayerState initialized called.'</span>);</li><li>      <span class="hljs-comment">// Set the display screen. This parameter is not required when the resource to be played is audio-only.</span></li><li>      <span class="hljs-keyword">this</span>.avPlayer.surfaceId = <span class="hljs-keyword">this</span>.surfaceID;</li><li>      hilog.info(CommonConstants.LOG_DOMAIN, TAG,</li><li>        `setAVPlayerCallback <span class="hljs-keyword">this</span>.avPlayer.surfaceId = ${<span class="hljs-keyword">this</span>.avPlayer.surfaceId}`);</li><li>      await <span class="hljs-keyword">this</span>.avPlayer.setPlaybackStrategy({</li><li>        preferredBufferDurationForPlaying: <span class="hljs-number">0.3</span>,</li><li>        preferredBufferDuration: <span class="hljs-number">20</span>,</li><li>        showFirstFrameOnPrepare: <span class="hljs-literal">true</span></li><li>      });</li><li>      <span class="hljs-keyword">this</span>.avPlayer.prepare();</li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-online-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L392-L481" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section622943814174">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section622943814174" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/avplayer-online-video" target="_blank">基于AVPlayer播放网络视频实践</a></li></ul> </div> </div> <div></div></div>