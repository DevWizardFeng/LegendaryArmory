<h1 _ngcontent-nch-c119="" class="doc-title ng-star-inserted" title="基于AVPlayer播放长视频实践"> 基于AVPlayer播放长视频实践 </h1>

<div _ngcontent-nch-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted renderOptimization" style="position: relative;"> <div><div class="tiledSection" style="contain-intrinsic-size: auto 32px;"><h2 id="section9194548141919">概述<i class="anchor-icon anchor-icon-link" anchorid="section9194548141919" tips="复制节点链接"></i></h2></div> <p>本文适用于视频播放类应用的开发，针对市场上主流视频播放类应用的常见场景，介绍了如何基于AVPlayer系统播放器实现长视频播放。本文指导开发者实现基本播控、精准跳转、静音播放、窗口缩放模式设置、倍速播放、音量控制、亮度控制、焦点管理、前后台感知、弹幕发送与显示、字幕挂载、视频截图、画中画播放、后台播放与接入播控中心、视频首帧显示等开发场景。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section512331617222">亮度控制</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section745373252219">焦点管理</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section141437368229">前后台感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section28801440152211">弹幕发送与显示</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section3655185020221">视频截图</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section16229471226">画中画播放</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1489902163313">接入播控中心</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section19176174913234">后台播放</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section96024162316">视频首帧显示</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section178071122418">横竖屏切换与旋转感知</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section86364193363">视频无缝转场播放</a></li></ul> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 116px;"><h2 id="section23701512203110">基本播控<i class="anchor-icon anchor-icon-link" anchorid="section23701512203110" tips="复制节点链接"></i></h2><p>基本播控、精准跳转、静音播放、窗口缩放设置、倍速播放、音量控制、字幕挂载场景参见<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-avplayer-basic-control" target="_blank">《基于AVPlayer基础播控实践》</a>。</p> </div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 80px;"><h2 id="section512331617222">亮度控制<i class="anchor-icon anchor-icon-link" anchorid="section512331617222" tips="复制节点链接"></i></h2></div> <div class="subsection" id="section13187145951711"><a name="section13187145951711"></a><a name="section13187145951711"></a></div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 56px;"><h3 id="section1014164123211" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1014164123211" tips="复制节点链接"></i></h3></div> <p>用户在横屏播放视频时可通过手势滑动调节屏幕亮度。</p> <p><span><img height="266" originheight="720" originwidth="1537" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163043.10947942311896016279930426893810:50001231000000:2800:592DC0B64752E1AEB60970F67A1FF224A0078BBC4B9EB151B18EB5FDC457A011.gif" title="点击放大" width="567.8302"></span></p> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 116px;"><h3 id="section198217114716">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section198217114716" tips="复制节点链接"></i></h3><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>设置亮度面板，绑定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>滑动手势事件，当Pan手势在移动过程中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setwindowbrightness9" target="_blank">setWindowBrightness()</a>方法，实现上滑增加亮度、下滑减少亮度的功能。</p> </div> <div class="tiledSection scroll-inwindow" style="contain-intrinsic-size: auto 56px;"><h3 id="section177392484915">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section177392484915" tips="复制节点链接"></i></h3></div> <ol><li><span>当进入全屏播放模式时，在视频播放界面右侧区域添加Slider组件，用来展示屏幕亮度变化情况。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/VolumeAndBrightnessView.ets#L27-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">Stack</span>() {</li><li>    <span class="hljs-title function_">Slider</span>({</li><li>      <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">screenBrightness</span>,</li><li>      <span class="hljs-variable">min</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">max</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-variable">step</span>: <span class="hljs-number">0.05</span>,</li><li>      <span class="hljs-variable">style</span>: <span class="hljs-title class_">SliderStyle</span>.<span class="hljs-title class_">NONE</span>,</li><li>      <span class="hljs-variable">direction</span>: <span class="hljs-title class_">Axis</span>.<span class="hljs-title class_">Vertical</span>,</li><li>      <span class="hljs-variable">reverse</span>: <span class="hljs-keyword">true</span></li><li>    })</li><li>      .<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">visible</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">Hidden</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">160</span>)</li><li>      .<span class="hljs-title function_">selectedColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">trackColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>)</li><li>      .<span class="hljs-title function_">trackThickness</span>(<span class="hljs-number">40</span>)</li><li>
</li><li>    <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.sun_max_fill'</span>))</li><li>      .<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">visible</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">Hidden</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">120</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">20</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">margin</span>({</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">0</span></li><li>  })</li><li>}</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li><li>.<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">End</span>)</li><li>.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>.<span class="hljs-title function_">padding</span>({</li><li>  <span class="hljs-variable">right</span>: <span class="hljs-number">30</span>,</li><li>  <span class="hljs-variable">bottom</span>: <span class="hljs-number">20</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/VolumeAndBrightnessView.ets#L27-L62" target="_blank">VolumeAndBrightnessView.ets</a></div></div></div></div> <p></p></li><li><span>在视频播放界面绑定PanGesture滑动手势事件，设置触发条件为仅在屏幕右侧区域且垂直方向滑动Pan手势时，调用setWindowBrightness()方法，实现亮度的调节。</span><p></p><div class="p">补充说明：此处setScreenBrightness()为setWindowBrightness()的封装。<div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L660-L690" data-highlighted="yes"><ol class="linenums"><li>.gesture(</li><li>  <span class="hljs-comment">// Sliding in the vertical direction</span></li><li>  PanGesture({ direction: PanDirection.Vertical })</li><li>    .onActionStart(() =&gt; {</li><li>    })</li><li>    .onActionUpdate((event: GestureEvent) =&gt; {</li><li>      <span class="hljs-comment">// The area on the right side of the screen</span></li><li>      <span class="hljs-keyword">if</span> (event.fingerList[<span class="hljs-number">0</span>].globalX &gt; (<span class="hljs-keyword">this</span>.screenWidth / <span class="hljs-number">2</span>)) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isInputtingBulletComment) {</li><li>          <span class="hljs-keyword">return</span>; <span class="hljs-comment">// When inputting bullet comment, disable screen brightness change</span></li><li>        }</li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">true</span>;</li><li>        let curBrightness = <span class="hljs-keyword">this</span>.screenBrightness -</li><li>          <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.getUIContext().vp2px(<span class="hljs-keyword">this</span>.screenHeight);</li><li>        curBrightness = <span class="hljs-keyword">this</span>.getValidValue(curBrightness, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);</li><li>        <span class="hljs-keyword">this</span>.screenBrightness = curBrightness;</li><li>        <span class="hljs-keyword">this</span>.setScreenBrightness(<span class="hljs-keyword">this</span>.screenBrightness);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>        let curVolume = <span class="hljs-keyword">this</span>.volume - <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.screenHeight;</li><li>        curVolume = <span class="hljs-keyword">this</span>.getValidValue(curVolume, <span class="hljs-number">0.0</span>, <span class="hljs-number">15.0</span>);</li><li>        <span class="hljs-keyword">this</span>.volume = curVolume;</li><li>      }</li><li>    })</li><li>    .onActionEnd(() =&gt; {</li><li>      setTimeout(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>      }, <span class="hljs-number">3000</span>)</li><li>    })</li><li>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L660-L690" target="_blank">AVPlayer.ets</a></div></div></div></div> </div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section745373252219">焦点管理<i class="anchor-icon anchor-icon-link" anchorid="section745373252219" tips="复制节点链接"></i></h2></div> <div class="subsection" id="section1186118818197"><a name="section1186118818197"></a><a name="section1186118818197"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section4977337163312" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section4977337163312" tips="复制节点链接"></i></h3></div> <p>通过正确设置音频流类型、中断事件处理和自定义焦点策略，完成播放过程音频焦点管理。</p> <p><span><img height="266" originheight="480" originwidth="1025" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163043.97485345706284589497118431600403:50001231000000:2800:28BC7A22886F0F7016E713A59FE34D0EEEA7E731876024AD23048505E6FBBBA1.gif" title="点击放大" width="568.0164"></span></p> <div class="subsection" id="section16107725151910"><a name="section16107725151910"></a><a name="section16107725151910"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1341674917337">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1341674917337" tips="复制节点链接"></i></h3></div> <p>通过AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiointerrupt9" target="_blank">on('audioInterrupt')</a>方法，监听音频焦点变化，根据不同的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#interruptforcetype9" target="_blank">打断类型</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#interrupthint" target="_blank">中断提示</a>作相应的处理，更多焦点管理相关说明可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-audio-focus-management" target="_blank">音频焦点管理</a>。</p> <ul><li>当闹钟或电话等外部打断事件发生时，打断类型为强制打断（INTERRUPT_FORCE），视频会自动中断播放。</li><li>当闹钟或电话的提示音结束后，系统将发送打断类型为共享打断类型(INTERRUPT_SHARE)、中断提示为音频可继续播放(INTERRUPT_HINT_RESUME)的事件，应用在监听到该事件时调用AVPlayer的play()函数恢复播放。</li></ul> <div class="subsection" id="section468112791916"><a name="section468112791916"></a><a name="section468112791916"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1716082163419">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1716082163419" tips="复制节点链接"></i></h3></div> <ol><li><span>通过AVPlayer实例注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiointerrupt9" target="_blank">on('audioInterrupt')</a>方法，监听外部打断事件，当打断类型为INTERRUPT_FORCE时，视频会自动中断播放。</span></li><li><span>当打断类型为INTERRUPT_SHARE、中断提示为INTERRUPT_HINT_RESUME时，调用videoPlay()函数恢复播放视频。</span><p></p><p>补充说明：此处videoPlay()为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#play9" target="_blank">play()</a>的封装。</p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L159-L198" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">setInterruptCallback</span>()</span> {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayer) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.avPlayer.<span class="hljs-keyword">on</span>(<span class="hljs-string">'audioInterrupt'</span>, <span class="hljs-keyword">async</span> (interruptEvent: audio.InterruptEvent) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (interruptEvent.forceType === audio.InterruptForceType.INTERRUPT_FORCE) {</li><li>      <span class="hljs-comment">// For the INTERRUPT_FORCE type: Audio-related processing has been performed by the system, and the</span></li><li>      <span class="hljs-comment">// application needs to update its own state and make the corresponding adjustments.</span></li><li>      <span class="hljs-keyword">switch</span> (interruptEvent.hintType) {</li><li>        <span class="hljs-comment">// This branch indicates that the system has paused the audio stream (temporarily lost focus).</span></li><li>        <span class="hljs-keyword">case</span> audio.InterruptHint.INTERRUPT_HINT_PAUSE:</li><li>        <span class="hljs-comment">// This branch indicates that the system has stopped the audio stream (permanently lost focus).</span></li><li>        <span class="hljs-keyword">case</span> audio.InterruptHint.INTERRUPT_HINT_STOP:</li><li>          <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">false</span>;</li><li>          <span class="hljs-keyword">this</span>.updateIsPlay();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-comment">// This branch indicates that the system has reduced the audio volume (default to 20% of the normal volume).</span></li><li>        <span class="hljs-keyword">case</span> audio.InterruptHint.INTERRUPT_HINT_DUCK:</li><li>        <span class="hljs-comment">// This branch indicates that the system has restored the audio volume to normal.</span></li><li>        <span class="hljs-keyword">case</span> audio.InterruptHint.INTERRUPT_HINT_UNDUCK:</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-literal">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptEvent.forceType === audio.InterruptForceType.INTERRUPT_SHARE) {</li><li>      <span class="hljs-comment">// For the INTERRUPT_SHARE type: The application can choose to perform related actions or ignore the</span></li><li>      <span class="hljs-comment">// audio interruption event.</span></li><li>      <span class="hljs-keyword">switch</span> (interruptEvent.hintType) {</li><li>        <span class="hljs-comment">// This branch indicates that the audio stream, which was paused due to temporary loss of focus,</span></li><li>        <span class="hljs-comment">// can resume playing.</span></li><li>        <span class="hljs-keyword">case</span> audio.InterruptHint.INTERRUPT_HINT_RESUME:</li><li>          <span class="hljs-keyword">this</span>.videoPlay();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-literal">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L159-L198" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section141437368229">前后台感知<i class="anchor-icon anchor-icon-link" anchorid="section141437368229" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section16143320153410" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section16143320153410" tips="复制节点链接"></i></h3></div> <p>应用从前台切到后台，再从后台切回前台时，能够保持原有进度继续播放原视频。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163043.92787760593371462216086607560820:50001231000000:2800:0FAD11B4288C6CD3873CDA180FF4CF82707A3DA8B60AFD638EF0369429B5CAD8.gif" title="点击放大" width="266"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section12634273515">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section12634273515" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section4115161712015"><a name="section4115161712015"></a><a name="section4115161712015"></a><p>在切换到前台的生命周期方法onPageShow()里调用AVPlayer的播放方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#play9" target="_blank">play()</a>，并在切换到后台的生命周期方法onPageHide()里调用AVPlayer的暂停方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#pause9" target="_blank">pause()</a>。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1448773335411">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1448773335411" tips="复制节点链接"></i></h3></div> <ol><li><span>在主页面的onPageShow()和onPageHide()里变更状态变量。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L75-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">onPageHide</span>(): <span class="hljs-type">void</span> {</li><li>  <span class="hljs-keyword">this</span>.isPageShow = <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L75-L78" target="_blank">IndexPage.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L82-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">onPageShow</span>(): <span class="hljs-type">void</span> {</li><li>  <span class="hljs-keyword">this</span>.isPageShow = <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L82-L85" target="_blank">IndexPage.ets</a></div></div></div></div> <p></p></li><li><span>在视频播放组件里对该状态变量添加@Watch装饰器。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L43-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Prop</span> <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onPageShowChange'</span>) <span class="hljs-attribute">isPageShow</span>: boolean = false; <span class="hljs-comment">// Whether the app is on the front end or back end</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L43-L43" target="_blank">AVPlayer.ets</a></div></div></div></div> <p></p></li><li><span>通过监听事件onPageShowChange调用AVPlayer的播放/暂停方法，以实现切换到后台时视频暂停播放、切回前台时视频恢复播放。</span><p></p><p>补充说明：此处avPlayerController为基于AVPlayer实现基本播控的控制器实例，resumePlayback()和pausePlay()分别为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#play9" target="_blank">play()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#pause9" target="_blank">pause()</a>的封装。</p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L161-L166" data-highlighted="yes"><ol class="linenums"><li>onPageShowChange() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isPIPShow &amp;&amp; <span class="hljs-keyword">this</span>.curIndex === <span class="hljs-keyword">this</span>.index) {</li><li>    <span class="hljs-keyword">this</span>.isPageShow ? <span class="hljs-keyword">this</span>.resumePlayback() : <span class="hljs-keyword">this</span>.pausePlay();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L161-L166" target="_blank">AVPlayer.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L498-L503" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">resumePlayback</span>()</span> {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayerController.isPlaying) {</li><li>    <span class="hljs-keyword">this</span>.avPlayerController.videoPlay();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L498-L503" target="_blank">AVPlayer.ets</a></div></div></div></div> <div class="p"><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L489-L494" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">pausePlay</span>()</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avPlayerController.isPlaying) {</li><li>    <span class="hljs-keyword">this</span>.avPlayerController.videoPause();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L489-L494" target="_blank">AVPlayer.ets</a></div></div></div></div> </div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section28801440152211">弹幕发送与显示<i class="anchor-icon anchor-icon-link" anchorid="section28801440152211" tips="复制节点链接"></i></h2></div> <div class="subsection" id="section55201331122016"><a name="section55201331122016"></a><a name="section55201331122016"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section33370693617" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section33370693617" tips="复制节点链接"></i></h3></div> <p>视频弹幕发送与显示是影音娱乐类应用中的高频使用场景之一，如用户在播放视频、观看直播时可以发送弹幕，实时评论互动，增强用户参与度。</p> <p><span><img height="266" originheight="480" originwidth="1025" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163044.08715407706903952020233093040138:50001231000000:2800:78B9E778EF61E2057CE42943C3702FB66251E220B41CFAE6553E1B7FDDDF438F.gif" title="点击放大" width="568.0164"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section6427121610368">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section6427121610368" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section1462474713201"><a name="section1462474713201"></a><a name="section1462474713201"></a><p>通过数组保存实现弹幕发送，基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-timer#setinterval" target="_blank">setInterval()</a>函数和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-page-transition-animation#translate" target="_blank">translate</a>属性实现弹幕水平移动的动画效果。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section168137393711">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section168137393711" tips="复制节点链接"></i></h3></div> <ol><li><span>在视频播放组件里定义一个空数组，用来保存发送的弹幕，用户输入弹幕点击发送后将输入内容存入当前数组中。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L507-L517" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> sendBulletComment() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.bulletCommentInput.trim()) {</li><li>    <span class="hljs-keyword">this</span>.bulletComments = [...<span class="hljs-keyword">this</span>.bulletComments, new BulletComment(<span class="hljs-keyword">this</span>.bulletCommentInput, <span class="hljs-literal">true</span>)];</li><li>    <span class="hljs-keyword">this</span>.bulletCommentInput = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.bulletComments.length &gt; <span class="hljs-number">50</span>) {</li><li>      <span class="hljs-keyword">this</span>.bulletComments = <span class="hljs-keyword">this</span>.bulletComments.slice(<span class="hljs-number">1</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.resumePlayback(); <span class="hljs-comment">// Resume video playback after sending</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L507-L517" target="_blank">AVPlayer.ets</a></div></div></div></div> <p></p></li><li><span>在弹幕展示组件中，通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-timer#setinterval" target="_blank">setInterval</a>函数设置定时器，定时器定时刷新承载弹幕内容的Text组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-page-transition-animation#translate" target="_blank">translate</a>属性，刷新所有弹幕位置。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/BulletCommentView.ets#L36-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start bullet comment animation</span></li><li><span class="hljs-keyword">private</span> startAnimation() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timerId &gt; <span class="hljs-number">0</span>) {</li><li>    clearInterval(<span class="hljs-keyword">this</span>.timerId);</li><li>  }</li><li>  <span class="hljs-comment">// Refresh the postion of bullet comments by timer</span></li><li>  <span class="hljs-keyword">this</span>.timerId = setInterval(() =&gt; {</li><li>    let needUpdate = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.bulletComments.forEach(item =&gt; {</li><li>      <span class="hljs-keyword">const</span> positionX = item.translateX - item.speed;</li><li>      <span class="hljs-keyword">if</span> (positionX !== item.translateX) {</li><li>        item.translateX = positionX; <span class="hljs-comment">// Set new X position of bullet comment</span></li><li>        needUpdate = <span class="hljs-literal">true</span>;</li><li>      }</li><li>    });</li><li>    <span class="hljs-keyword">const</span> beforeLength = <span class="hljs-keyword">this</span>.bulletComments.length;</li><li>    <span class="hljs-keyword">this</span>.bulletComments =</li><li>      <span class="hljs-keyword">this</span>.bulletComments.filter(item =&gt; item.translateX &gt; -<span class="hljs-number">20</span>); <span class="hljs-comment">// Remove the bullet comment which beyond the screen</span></li><li>    <span class="hljs-keyword">if</span> (needUpdate || <span class="hljs-keyword">this</span>.bulletComments.length !== beforeLength) {</li><li>      <span class="hljs-keyword">this</span>.forceUpdate = !<span class="hljs-keyword">this</span>.forceUpdate; <span class="hljs-comment">// Trigger ui refresh</span></li><li>    }</li><li>  }, <span class="hljs-number">16</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/BulletCommentView.ets#L36-L59" target="_blank">BulletCommentView.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section3655185020221">视频截图<i class="anchor-icon anchor-icon-link" anchorid="section3655185020221" tips="复制节点链接"></i></h2></div> <div class="subsection" id="section34081372214"><a name="section34081372214"></a><a name="section34081372214"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section669217344362" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section669217344362" tips="复制节点链接"></i></h3></div> <p>视频截图是影音娱乐类应用中的典型场景之一，如用户可在观看视频时截取画面，并对截图的前后帧进行微调，避免所截图片与预期不符。</p> <p><span><img height="266" originheight="720" originwidth="1537" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163044.85374815335072647071455546063867:50001231000000:2800:E88C66EB0FB05617ECD6209A82FA3CAFCC251A72115BBCFC106614C57CD20F71.gif" title="点击放大" width="567.8302"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section1277413419109">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1277413419109" tips="复制节点链接"></i></h3><p>以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>作为媒体流播放组件，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-uicontext-component-snapshot" target="_blank">ComponentSnapshot</a>对象获取组件截图的能力。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section108559482920">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section108559482920" tips="复制节点链接"></i></h3></div> <ol><li><span>通过getUIContext().getComponentSnapshot().get()方法获取视频播放组件XComponent当前截图。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L539-L546" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">screenshot</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixmap</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getComponentSnapshot</span>().<span class="hljs-title function_">get</span>(<span class="hljs-string">`videoXComponent_<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.curSource.index}</span>`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`screenshot failed: code: <span class="hljs-subst">${exception.code}</span>, message: <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L539-L546" target="_blank">AVPlayer.ets</a></div></div></div></div> <p></p></li><li><span>调用AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>方法跳转到视频播放的上一秒或下一秒，再次通过步骤1的方法获取当前截图。</span><p></p><div class="p">补充说明：此处avPlayerController为基于AVPlayer实现基本播控的控制器实例，videoSeek()为seek()的封装。<div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L550-L558" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> async clickPreviousFrame() {</li><li>  <span class="hljs-keyword">this</span>.avPlayerController?.videoSeek(<span class="hljs-keyword">this</span>.screenshotTime - <span class="hljs-number">1000</span> / ScreenShotConstants.FRAME_RATE);</li><li>  <span class="hljs-keyword">this</span>.pausePlay();</li><li>  setTimeout(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.screenshot()</li><li>  }, <span class="hljs-number">500</span>)</li><li>  <span class="hljs-keyword">this</span>.screenshotTime -= <span class="hljs-number">1000</span> / ScreenShotConstants.FRAME_RATE</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L550-L558" target="_blank">AVPlayer.ets</a></div></div></div></div> </div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L562-L570" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> async clickNextFrame() {</li><li>  <span class="hljs-keyword">this</span>.avPlayerController?.videoSeek(<span class="hljs-keyword">this</span>.screenshotTime + <span class="hljs-number">1000</span> / ScreenShotConstants.FRAME_RATE);</li><li>  <span class="hljs-keyword">this</span>.pausePlay();</li><li>  setTimeout(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.screenshot()</li><li>  }, <span class="hljs-number">500</span>)</li><li>  <span class="hljs-keyword">this</span>.screenshotTime += <span class="hljs-number">1000</span> / ScreenShotConstants.FRAME_RATE</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/view/AVPlayer.ets#L562-L570" target="_blank">AVPlayer.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section16229471226">画中画播放<i class="anchor-icon anchor-icon-link" anchorid="section16229471226" tips="复制节点链接"></i></h2></div> <div class="subsection" id="section16531938214"><a name="section16531938214"></a><a name="section16531938214"></a></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1347175719361" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1347175719361" tips="复制节点链接"></i></h3></div> <p>应用在视频播放时，可以使用画中画能力将视频内容以小窗（画中画）模式呈现。切换为小窗（画中画）模式后，用户可以进行其他界面操作，提升使用体验。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163044.91487175827871706894652756298165:50001231000000:2800:537CD052C2EAD552A55AD606E25DDB12CA353FF958E94A76647638AEEBDDF4C5.gif" title="点击放大" width="266"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section17292179153714">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section17292179153714" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section16889623132119"><a name="section16889623132119"></a><a name="section16889623132119"></a><p>以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>作为媒体流播放组件，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pipwindow#导入模块" target="_blank">PiPWindow</a>模块实现画中画基础功能。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>仅支持以XComponent作为媒体流播放组件的界面进入画中画模式，XComponent的type必须为XComponentType.SURFACE。</li><li>在API version 20之前，支持在Phone、Tablet设备使用XComponent实现画中画功能开发；从API version 20开始，支持在Phone、PC/2in1、Tablet设备使用XComponent实现画中画功能开发。</li></ul> </div></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section4691194231313">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section4691194231313" tips="复制节点链接"></i></h3></div> <ol><li><span>创建画中画控制器，设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-pipwindow#setautostartenabled" target="_blank">setAutoStartEnabled()</a>为true以在应用返回桌面时启动画中画。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L37-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create PIPWindows</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">createPipController</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-title function_">create</span>({</li><li>        <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>,</li><li>        <span class="hljs-attr">componentController</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">xComponentController</span>,</li><li>        <span class="hljs-attr">templateType</span>: <span class="hljs-title class_">PiPWindow</span>.<span class="hljs-property">PiPTemplateType</span>.<span class="hljs-property">VIDEO_PLAY</span></li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`pipController init failed, Code:<span class="hljs-subst">${exception.code}</span>, message:<span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">State: PiPWindow.PiPState, reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStateChange</span>(<span class="hljs-title class_">State</span>, reason);</li><li>  })</li><li>
</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'controlPanelActionEvent'</span>, <span class="hljs-function">(<span class="hljs-params">event: PiPWindow.PiPActionEventType, status?: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onActionEvent</span>(event, status);</li><li>  })</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipController</span>?.<span class="hljs-title function_">setAutoStartEnabled</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// Key point:  Set the animation to start when the application returns to the desktop</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L37-L60" target="_blank">PipWindowController.ets</a></div></div></div></div> <p></p></li><li><span>注册生命周期事件和控制事件回调。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L78-L105" data-highlighted="yes"><ol class="linenums"><li>onStateChange(state: PiPWindow.PiPState, reason: string) {</li><li>  switch (state) {</li><li>    case PiPWindow.PiPState.ABOUT_TO_START:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'ABOUT_TO_START'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PiPWindow.PiPState.STARTED:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'STARTED'</span>;</li><li>      let status: PiPWindow.PiPControlStatus =</li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.isPlaying ? PiPWindow.PiPControlStatus.PLAY : PiPWindow.PiPControlStatus.PAUSE;</li><li>      <span class="hljs-keyword">this</span>.pipController?.updatePiPControlStatus(PiPWindow.PiPControlType.VIDEO_PLAY_PAUSE, status);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PiPWindow.PiPState.ABOUT_TO_STOP:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'ABOUT_TO_STOP'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PiPWindow.PiPState.STOPPED:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'STOPPED'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PiPWindow.PiPState.ABOUT_TO_RESTORE:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'ABOUT_TO_RESTORE'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PiPWindow.PiPState.ERROR:</li><li>      <span class="hljs-keyword">this</span>.curState = <span class="hljs-string">'ERROR'</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    default:</li><li>      <span class="hljs-keyword">break</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L78-L105" target="_blank">PipWindowController.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L109-L122" data-highlighted="yes"><ol class="linenums"><li>onActionEvent(<span class="hljs-keyword">event</span>: PiPWindow.PiPActionEventType, status?: number) {</li><li>  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">event</span>) {</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-string">'playbackStateChanged'</span>:</li><li>      <span class="hljs-keyword">if</span> (status === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.videoPause();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.videoPlay();</li><li>      }</li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-literal">default</span>:</li><li>      <span class="hljs-keyword">break</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L109-L122" target="_blank">PipWindowController.ets</a></div></div></div></div> <p></p></li><li><span>销毁画中画控制器，设置setAutoStartEnabled()为false以关闭画中画。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L64-L74" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Destroy PIPWindows</span></li><li>destroyPipController() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.pipController) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.pipController.setAutoStartEnabled(<span class="hljs-literal">false</span>);</li><li>  <span class="hljs-keyword">this</span>.pipController.off(<span class="hljs-string">'stateChange'</span>);</li><li>  <span class="hljs-keyword">this</span>.pipController.off(<span class="hljs-string">'controlPanelActionEvent'</span>);</li><li>  <span class="hljs-keyword">this</span>.pipController = undefined;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/PipWindowController.ets#L64-L74" target="_blank">PipWindowController.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section1489902163313">接入播控中心<i class="anchor-icon anchor-icon-link" anchorid="section1489902163313" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1278044114373" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1278044114373" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section26442792811"><a name="section26442792811"></a><a name="section26442792811"></a><p>通过播控中心，控制播放、暂停、切换上下视频。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163044.58789578460475972509178218489424:50001231000000:2800:50CAA251BC79EF52E7831FA6F81EDAB7DB530BD3F96A680C2FCBF7F23AB4BB9D.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 92px;"><h3 id="section941361112717">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section941361112717" tips="复制节点链接"></i></h3><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-kit" target="_blank">AVSessionKit</a>音频播控服务实现视频应用接入播控中心。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 3576px;"><h3 id="section5773204092814">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5773204092814" tips="复制节点链接"></i></h3><ol><li><span>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-f#avsessioncreateavsession10" target="_blank">createAVSession()</a>创建AVSession实例并激活媒体会话，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-t#avsessiontype10" target="_blank">AVSessionType</a>设置为video。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L43-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> initAvSession() {</li><li>  <span class="hljs-keyword">this</span>.context = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'context'</span>);</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context) {</li><li>    Logger.error(TAG, <span class="hljs-string">'session create failed : context is undefined'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  avSession.createAVSession(<span class="hljs-keyword">this</span>.context, <span class="hljs-string">'LONG_VIDEO_SESSION'</span>, <span class="hljs-string">'video'</span>).then(async (avSession) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.avSession = avSession;</li><li>    BackgroundTaskManager.startContinuousTask(<span class="hljs-keyword">this</span>.context);</li><li>    <span class="hljs-keyword">this</span>.setLaunchAbility();</li><li>    <span class="hljs-keyword">this</span>.avSession.activate().<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>      Logger.error(TAG, `avSession activate failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>    });</li><li>  }).<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>    Logger.error(TAG, `createAVSession failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L43-L60" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p></li><li><span>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#setavmetadata10" target="_blank">setAVMetadata()</a>把会话的一些元数据信息设置给系统，从而在播控中心界面进行展示。如媒体ID（assetId）、标题（title）、播控中心显示的图片（mediaImage）、媒体时长（duration）等。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L72-L91" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set video session metadata</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setAVMetadata</span>(<span class="hljs-params">curSource: VideoData, duration: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (curSource === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVMetadata Error, curSource is null'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">metadata</span>: avSession.<span class="hljs-property">AVMetadata</span> = {</li><li>    <span class="hljs-attr">assetId</span>: <span class="hljs-string">`<span class="hljs-subst">${curSource.index}</span>`</span>,</li><li>    <span class="hljs-attr">title</span>: curSource.<span class="hljs-property">name</span>,</li><li>    <span class="hljs-attr">duration</span>: duration <span class="hljs-comment">// Video duration</span></li><li>  };</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>.<span class="hljs-title function_">setAVMetadata</span>(metadata).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSessionMetadata</span> = metadata;</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVMetadata BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L72-L91" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p></li><li><span>设置用于被播控中心拉起的UIAbility。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L95-L120" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setLaunchAbility</span>() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITIES</span>,</li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>  };</li><li>  <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">agent</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>.<span class="hljs-title function_">setLaunchAbility</span>(<span class="hljs-variable">agent</span>).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setLaunchAbility</span> <span class="hljs-variable">failed</span>: <span class="hljs-title class_">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>: <span class="hljs-title class_">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L95-L120" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p></li><li><span>注册播控命令事件监听，便于响应用户通过播控中心下发的播控命令，比如播放<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#onplay10" target="_blank">on('play')</a>、暂停<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#onpause10" target="_blank">on('pause')</a>、上一曲<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#onplayprevious10" target="_blank">on('playPrevious')</a>、下一曲<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#onplaynext10" target="_blank">on('playNext')</a>等。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L306-L329" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set background control monitor the callback events</span></li><li><span class="hljs-keyword">public</span> async setAvSessionListener() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avSessionController) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'play'</span>, () =&gt; <span class="hljs-keyword">this</span>.sessionPlayCallback());</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'pause'</span>, () =&gt; <span class="hljs-keyword">this</span>.sessionPauseCallback());</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'seek'</span>, (seekTime: number) =&gt; <span class="hljs-keyword">this</span>.sessionSeekCallback(seekTime));</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'setLoopMode'</span>, (mode: avSession.LoopMode) =&gt; {</li><li>      Logger.info(`on setLoopMode: ${mode}`)</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'playPrevious'</span>, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.sessionPlayPreviousCallback();</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'playNext'</span>, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.sessionPlayNextCallback();</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    Logger.error(TAG,</li><li>      `Invoke setAvSessionListener failed, code <span class="hljs-keyword">is</span> ${exception.code}, message <span class="hljs-keyword">is</span> ${exception.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L306-L329" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li><li><span>应用状态上报播控中心，当视频状态发生改变时，需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#setavplaybackstate10" target="_blank">setAVPlaybackState()</a>向播控中心上报视频状态，来达到播控中心与应用的状态同步，包括播放状态（state）、播放位置（position）、当前媒体播放时长（duration）等。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L333-L345" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Report the video state to background control</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">updateIsPlay</span>() {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSessionController</span>.<span class="hljs-title function_">setAvSessionPlayState</span>({</li><li>    <span class="hljs-variable">state</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isPlaying</span> ? <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">PlaybackState</span>.<span class="hljs-title class_">PLAYBACK_STATE_PLAY</span> :</li><li>      <span class="hljs-variable">avSession</span>.<span class="hljs-variable">PlaybackState</span>.<span class="hljs-variable">PLAYBACK_STATE_PAUSE</span>,</li><li>    <span class="hljs-variable">position</span>: {</li><li>      <span class="hljs-variable">elapsedTime</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentTime</span>,</li><li>      <span class="hljs-variable">updateTime</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title class_">getTime</span>()</li><li>    },</li><li>    <span class="hljs-variable">duration</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentTime</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L333-L345" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L124-L135" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">setAvSessionPlayState</span>(<span class="hljs-params">playbackState: avSession.AVPlaybackState</span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>.<span class="hljs-title function_">setAVPlaybackState</span>(playbackState, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVPlaybackState BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVPlaybackState successfully'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L124-L135" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section19176174913234">后台播放<i class="anchor-icon anchor-icon-link" anchorid="section19176174913234" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section3755105214382" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section3755105214382" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section1417612496233"><a name="section1417612496233"></a><a name="section1417612496233"></a></div> <p>视频切换到后台播放。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163044.09820479444742502291541082118138:50001231000000:2800:E6653059F0FB904A58B3139B878147E4916A36FEF1C0C9B461D8BB9F515E2B29.gif" title="点击放大" width="266"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 208px;"><h3 id="section1474516294346">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1474516294346" tips="复制节点链接"></i></h3><p>首先需实现播控中心的接入，在此基础上申请后台运行权限并设置后台模式，同时为视频应用创建长时后台任务，从而实现视频在后台持续播放的功能。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>后台播放的实现依赖于播控中心，建议开发者先完成<a href="/consumer/cn/doc/best-practices/bpta-avplayer-long-video#section1489902163313">接入播控中心</a>章节的学习。</p> </div></div></div> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section2382104019386">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2382104019386" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section61761349102318"><a name="section61761349102318"></a><a name="section61761349102318"></a><ol><li><span>在module.json5配置文件中配置ohos.permission.KEEP_BACKGROUND_RUNNING权限和后台模式audioPlayback。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L45-L56" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:reason_background"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span></li><li>    }</li><li>  }</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L45-L56" target="_blank">module.json5</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-json" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L28-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">"backgroundModes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span></li><li>  <span class="hljs-string">"audioPlayback"</span></li><li><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L28-L30" target="_blank">module.json5</a></div></div></div></div> <p></p></li><li><span>创建后台任务管理类，实现后台任务的申请（startContinuousTask）与取消（stopContinuousTask），长时任务类型选择<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resourceschedule-backgroundtaskmanager#backgroundmode" target="_blank">AUDIO_PLAYBACK</a>，表示视频后台播放。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/BackgroundTaskManager.ets#L25-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">startContinuousTask</span>(<span class="hljs-variable">context</span>?: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITY</span>,</li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>  };</li><li>  <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">wantAgentObj</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.ResourceSchedule.BackgroundTaskManager.Core'</span>)) {</li><li>      <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-variable">context</span>,</li><li>        <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-variable">BackgroundMode</span>.<span class="hljs-variable">AUDIO_PLAYBACK</span>, <span class="hljs-variable">wantAgentObj</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">startBackgroundRunning</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/BackgroundTaskManager.ets#L25-L52" target="_blank">BackgroundTaskManager.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/BackgroundTaskManager.ets#L56-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">stopContinuousTask</span>(context?: common.<span class="hljs-property">UIAbilityContext</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">if</span> (!context) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.ResourceSchedule.BackgroundTaskManager.Core'</span>)) {</li><li>    backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`stopBackgroundRunning failed, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/BackgroundTaskManager.ets#L56-L67" target="_blank">BackgroundTaskManager.ets</a></div></div></div></div> <p></p></li><li><span>在AVSession创建和释放时，分别申请和销毁后台长时任务。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L43-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> initAvSession() {</li><li>  <span class="hljs-keyword">this</span>.context = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'context'</span>);</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.context) {</li><li>    Logger.error(TAG, <span class="hljs-string">'session create failed : context is undefined'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  avSession.createAVSession(<span class="hljs-keyword">this</span>.context, <span class="hljs-string">'LONG_VIDEO_SESSION'</span>, <span class="hljs-string">'video'</span>).then(async (avSession) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.avSession = avSession;</li><li>    BackgroundTaskManager.startContinuousTask(<span class="hljs-keyword">this</span>.context);</li><li>    <span class="hljs-keyword">this</span>.setLaunchAbility();</li><li>    <span class="hljs-keyword">this</span>.avSession.activate().<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>      Logger.error(TAG, `avSession activate failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>    });</li><li>  }).<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>    Logger.error(TAG, `createAVSession failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L43-L60" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L139-L155" data-highlighted="yes"><ol class="linenums"><li>async unregisterSessionListener() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avSession) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'play'</span>);</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'pause'</span>);</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'playNext'</span>);</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'playPrevious'</span>);</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'setLoopMode'</span>);</li><li>    <span class="hljs-keyword">this</span>.avSession.off(<span class="hljs-string">'seek'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    Logger.error(TAG, `unregisterSessionListener failed: code: ${exception.code}, message: ${exception.message}`);</li><li>  }</li><li>  BackgroundTaskManager.stopContinuousTask(<span class="hljs-keyword">this</span>.context);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvSessionController.ets#L139-L155" target="_blank">AvSessionController.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section96024162316">视频首帧显示<i class="anchor-icon anchor-icon-link" anchorid="section96024162316" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1148855473910" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1148855473910" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section638310772218"><a name="section638310772218"></a><a name="section638310772218"></a></div> <p>在播放列表或者窗口中显示视频的首帧。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.56721082822131716199550478555351:50001231000000:2800:19492B15DFBEE29D6594290A94130324C5CC26ACA8FCB82420245CE16A459F88.gif" title="点击放大" width="266"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 136px;"><h3 id="section143310356446">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section143310356446" tips="复制节点链接"></i></h3><ul><li>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avimagegenerator#fetchframebytime12" target="_blank">fetchFrameByTime()</a>方法获取本地视频的首帧图片在视频列表展示。</li><li>通过设置播放策略<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#setplaybackstrategy12" target="_blank">setPlaybackStrategy</a>的showFirstFrameOnPrepare属性为true来实现AVPlayer显示视频起播首帧。</li></ul> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section27212108403">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section27212108403" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section1321820266221"><a name="section1321820266221"></a><a name="section1321820266221"></a></div> <p>播放列表中显示视频首帧的实现步骤：</p> <ol><li><span>使用media.AVImageGenerator实例的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avimagegenerator#fetchframebytime12" target="_blank">fetchFrameByTime()</a>方法获取本地视频的首帧图片在列表展示。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/ImageUtil.ets#L24-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getThumbnailFromVideo</span>(<span class="hljs-params">src: <span class="hljs-built_in">string</span>, timeUs: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">let</span> queryOption = media.<span class="hljs-property">AVImageQueryOptions</span>.<span class="hljs-property">AV_IMAGE_QUERY_NEXT_SYNC</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">param</span>: media.<span class="hljs-property">PixelMapParams</span> = {</li><li>    <span class="hljs-attr">width</span>: <span class="hljs-number">540</span>,</li><li>    <span class="hljs-attr">height</span>: <span class="hljs-number">304</span></li><li>  };</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">generator</span>: media.<span class="hljs-property">AVImageGenerator</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVImageGenerator</span>();</li><li>    <span class="hljs-keyword">let</span> fileDescriptor = <span class="hljs-keyword">await</span> uiContext?.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>?.<span class="hljs-title function_">getRawFd</span>(src);</li><li>    generator.<span class="hljs-property">fdSrc</span> = fileDescriptor;</li><li>    pixelMap = <span class="hljs-keyword">await</span> generator.<span class="hljs-title function_">fetchFrameByTime</span>(timeUs, queryOption, param);</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ImageUtil'</span>,</li><li>      <span class="hljs-string">`getThumbnailFromVideo failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>)</li><li>  }</li><li>  <span class="hljs-keyword">return</span> pixelMap;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/ImageUtil.ets#L24-L42" target="_blank">ImageUtil.ets</a></div></div></div></div> <p></p></li></ol> <p>播放窗口中显示视频首帧的实现步骤：</p> <ol><li><span>确认AVPlayer实例中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onstatechange9" target="_blank">on('stateChange')</a>方法在prepared状态下没有调用this.avPlayer.play()，如有调用，则去掉，避免视频在加载完毕后自动播放。</span></li><li><span>在on('stateChange')方法中initialized状态下，设置播放策略<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#playbackstrategy12" target="_blank">setPlaybackStrategy</a>的showFirstFrameOnPrepare为true。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L215-L232" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>: <span class="hljs-comment">// This status is reported after the playback source is set on the AVPlayer.</span></li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setAVPlayerCallback AVPlayerState initialized called.'</span>);</li><li>  <span class="hljs-comment">// Set the display screen. This parameter is not required when the resource to be played is audio-only.</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">surfaceId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">surfaceID</span>;</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">setPlaybackStrategy</span>({</li><li>      <span class="hljs-attr">preferredBufferDuration</span>: <span class="hljs-number">20</span>,</li><li>      <span class="hljs-attr">showFirstFrameOnPrepare</span>: <span class="hljs-literal">true</span></li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`setPlaybackStrategy failed. Cause code: <span class="hljs-subst">${exception.code}</span>, message: <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">prepare</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`prepare failed. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  });</li><li>  <span class="hljs-keyword">break</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/controller/AvPlayerController.ets#L215-L232" target="_blank">AvPlayerController.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section178071122418">横竖屏切换与旋转感知<i class="anchor-icon anchor-icon-link" anchorid="section178071122418" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1126143744014" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1126143744014" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section18807919246"><a name="section18807919246"></a><a name="section18807919246"></a></div> <p>用户播放视频时可以根据实际需求进行横竖屏切换。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.01943822232962439096855444309678:50001231000000:2800:E300400C02FE78A64A81FBA8211EB066143C3904386501926BA5FA973893453A.gif" title="点击放大" width="266"></span></p> <p><span><img height="266" originheight="720" originwidth="1537" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.97484442745304709892971592732488:50001231000000:2800:40B628C9D7109C4D0509DFD62728CD25AAFC3847EF7A763234E4B9117F66CE3E.gif" title="点击放大" width="569.9981"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 136px;"><h3 id="section18410113902317">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section18410113902317" tips="复制节点链接"></i></h3><ul><li>通过设置orientation为auto_rotation_restricted实现传感器自动感知。</li><li>通过设置window.Orientation为USER_ROTATION_LANDSCAPE/USER_ROTATION_PORTRAIT实现横竖屏的手动切换。</li></ul> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1257185216407">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1257185216407" tips="复制节点链接"></i></h3></div> <p>通过传感器旋转自动感知切换：</p> <ol><li><span>在模块级配置文件module.json5中设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-e#orientation9" target="_blank">窗口显示方向</a>为AUTO_ROTATION_RESTRICTED。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L25-L25" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"orientation"</span>: <span class="hljs-string">"auto_rotation_restricted"</span>,</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/module.json5#L25-L25" target="_blank">module.json5</a></div></div></div></div> <p></p></li></ol> <p>通过点击按钮实现横竖屏切换：</p> <ol><li><span>封装横竖屏切换的实现方法。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/WindowUtil.ets#L60-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setMainWindowOrientation</span>(<span class="hljs-attr">orientation</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>, callback?: <span class="hljs-title class_">Function</span>): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mainWindowClass</span> === <span class="hljs-literal">undefined</span>) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'MainWindowClass is undefined'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainWindowClass</span>.<span class="hljs-title function_">setPreferredOrientation</span>(orientation).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    callback?.();</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`Failed to set the <span class="hljs-subst">${orientation}</span> of main window. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/common/utils/WindowUtil.ets#L60-L72" target="_blank">WindowUtil.ets</a></div></div></div></div> <p></p></li><li><span>点击横屏播放按钮时，设置window.Orientation为USER_ROTATION_LANDSCAPE。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L161-L161" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">windowUtil</span>.<span class="hljs-title function_">setMainWindowOrientation</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">USER_ROTATION_LANDSCAPE</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L161-L161" target="_blank">IndexPage.ets</a></div></div></div></div> <p></p></li><li><span>点击返回按钮时，设置window.Orientation为USER_ROTATION_PORTRAIT。</span><p></p><div class="screenLinkPre"><div _ngcontent-nch-c106="" class="highlight-div"><div _ngcontent-nch-c106="" class="highlight-div-header"><div _ngcontent-nch-c106="" class="highlight-div-header-left"><div _ngcontent-nch-c106="" class="handle-button expand-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nch-c106="" class="highlight-div-header-right"><div _ngcontent-nch-c106="" class="handle-button ai-button"></div><div _ngcontent-nch-c106="" class="handle-button line-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nch-c106="" class="handle-button theme-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nch-c106="" class="handle-button copy-button"><div _ngcontent-nch-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nch-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L94-L94" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">windowUtil</span>.<span class="hljs-title function_">setMainWindowOrientation</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">USER_ROTATION_PORTRAIT</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avplayer-long-video/blob/master/entry/src/main/ets/pages/IndexPage.ets#L94-L94" target="_blank">IndexPage.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection" style="contain-intrinsic-size: auto 80px;"><h2 id="section86364193363">视频无缝转场播放<i class="anchor-icon anchor-icon-link" anchorid="section86364193363" tips="复制节点链接"></i></h2></div> <div class="tiledSection" style="contain-intrinsic-size: auto 56px;"><h3 id="section1486001320417" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1486001320417" tips="复制节点链接"></i></h3></div> <div class="subsection" id="section9637719173618"><a name="section9637719173618"></a><a name="section9637719173618"></a></div> <p>用户在横竖屏切换后，视频保持原有进度继续播放。</p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.41808464377466293079386789172960:50001231000000:2800:A69CB37AAFEDE1FEE5D18BDED8EA36EC23C1EE2E528ACC7774F23E98A995E199.gif" title="点击放大" width="266"></span></p> <p><span><img height="266" originheight="720" originwidth="1537" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163045.21613341829832362494871147064322:50001231000000:2800:58875C0A0E2DBF1142B2593146AC2B109620C05702F4950C0B4BA150808CACBC.gif" title="点击放大" width="569.9981"></span></p> <div class="tiledSection" style="contain-intrinsic-size: auto 116px;"><h3 id="section116221447153912">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section116221447153912" tips="复制节点链接"></i></h3><p>基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>实现视频播放，在横竖屏来回切换时，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>本身具有保持原有进度继续播放的特性，开发者无需进行额外开发。</p> </div> <div class="tiledSection" style="contain-intrinsic-size: auto 116px;"><h2 id="section18902142614512">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section18902142614512" tips="复制节点链接"></i></h2><p><a href="https://gitee.com/harmonyos_samples/avplayer-long-video" target="_blank">基于AVPlayer播放长视频实践</a></p> </div> </div> <div></div></div>