<h1 _ngcontent-sbs-c119="" class="doc-title ng-star-inserted" title="基于AVScreenCapture实现屏幕录制"> 基于AVScreenCapture实现屏幕录制 </h1>

<div _ngcontent-sbs-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section175201342123314">概述<i class="anchor-icon anchor-icon-link" anchorid="section175201342123314" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/media-kit-intro-V5#avscreencapture" target="_blank">AVScreenCapture</a>是系统提供的用于实现屏幕录制功能的模块，属于媒体子系统的核心能力之一。AVScreenCapture主要应用于需要捕获屏幕内容的场景，例如在线教育录课、游戏直播、会议录制、远程协作等。AVScreenCapture主要工作是捕获音频信号、视频信号，并通过音视频编码保存屏幕信息，提供录屏写文件和录屏转码流两套接口，能够输出原始码流和文件两种不同形式的信息。该模块允许调用者指定屏幕录制的编码格式、封装格式和文件路径等参数，同时支持全屏录制、指定窗口录制或指定物理屏录制的配置。</p> <ul><li>转码流形式：连续的二进制数据包（如：01001011 01100101...），无边界标记，不区分数据块。其存在形式为内存/网络传输中的瞬时状态，类似网络传输中的TCP流、摄像头实时视频流。其生命周期为实时生成、实时消费、立即销毁。</li><li>写文件形式：静态的存储容器，结构化存储单元（如：文件头 + 数据区 + 文件尾）， 具有明确的边界，通过文件系统标记起始和结束位置。其存在形式为存储介质中的持久实体，其生命周期包括创建、写入、关闭和长期存储。</li></ul> <p>原始码流</p> <p>本文主要针对以下几种实现方案详细讲解其实现原理和开发流程。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-avscreencapture-for-screen-recording#section162864319340">使用AVScreenCaptureRecorder模块录屏写文件（ArkTS）</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avscreencapture-for-screen-recording#section6121629163710">使用AVScreenCapture模块录屏写文件（C/C++）</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-avscreencapture-for-screen-recording#section15553154512379">使用AVScreenCapture模块录屏转码流（C/C++）</a></li></ul> <p>三种实现方案对比情况如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.8.1.5.1.1" valign="top" width="28.74%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.1.8.1.5.1.2" valign="top" width="21.26%"><p>优点</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.8.1.5.1.3" valign="top" width="25%"><p>缺点</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.8.1.5.1.4" valign="top" width="25%"><p>适用场景</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="28.74%"><p>使用AVScreenCaptureRecorder模块录屏写文件（ArkTS）</p> </td> <td class="cellrowborder" valign="top" width="21.26%"><ul><li>开发逻辑简单，代码维护成本低，无需具备Native相关知识，开发效率相对较高。</li><li>内存管理相对安全，无需手动释放资源，GC自动回收。</li><li>与UI界面无缝联动，可以实时更新界面元素。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>功能缺失，仅支持文件输出模式（OH_CAPTURE_FILE），无法获取原始数据码流。</li><li>受JS运行时限制，高负载场景下性能相对较差。</li><li>实时性不佳，不适用于延迟敏感场景。</li><li>格式受限，仅支持输出MP4格式。</li><li>CPU占用率高。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>该方案适用于重视开发交互效率和UI界面交互，同时对实时性要求不高的常规场景，例如在线教育课程录制、简单屏幕录制等文件录制场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.74%"><p>使用AVScreenCapture模块录屏写文件（C/C++）</p> </td> <td class="cellrowborder" valign="top" width="21.26%"><ul><li>开发逻辑简单，开发效率适中。</li><li>实时性表现一般，延迟低于ArkTS方法，但高于C/C++转码流方法。</li><li>支持动态音频切换。</li><li>CPU占用率相对较低</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>开发逻辑较为复杂，需要掌握C++/NDK相关知识。</li><li>需要手动释放资源。</li><li>仍依赖系统封装器，仅支持MP4视频格式。</li><li>无法获取原始数据码流，对数据进行相关操作。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>该方案适用于对实时性、视频画质有较高要求，且需要动态音频切换的高性能场景，例如游戏高帧率录制、会议录制等文件录制场合。。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="28.74%"><p>使用AVScreenCapture模块录屏转码流（C/C++）</p> </td> <td class="cellrowborder" valign="top" width="21.26%"><ul><li>极致性能，实时性强，延迟极低。</li><li>可以自由掌控数据，支持自定义编码、多源合成及逐帧处理等。</li><li>资源优化，内存占用率极低。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>开发成本极高，需要具备音视频编码的专业知识。</li><li>风险较高，需要自行管理线程和内存安全风险。</li><li>容易出现编码器碎片化问题。</li><li>维护和调试都较为困难。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>该方案适用于对实时性要求极高、需要多源合成及逐帧处理的专业场景，例如游戏直播、远程桌面控制和定制格式输出等。</p> </td> </tr>  </tbody></table></div> </div> <p>开发者可以对比三种方式的优缺点及其适用场景，自行选择最适合的实现方案。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在进行屏幕录制开发前需要申请相应权限：麦克风权限（<strong>ohos.permission.MICROPHONE</strong>）、后台长时任务权限（<strong>ohos.permission.KEEP_BACKGROUND_RUNNING</strong>）。其他权限可根据需要申请，例如：若需访问公共目录，则应申请公共目录的读写权限。</p> <p>开发者如果想要了解音视频编码相关内容，可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-encoding" target="_blank">音频编码</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding" target="_blank">视频编码</a>。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section162864319340">使用AVScreenCaptureRecorder模块录屏写文件（ArkTS）<i class="anchor-icon anchor-icon-link" anchorid="section162864319340" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1424817175348" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1424817175348" tips="复制节点链接"></i></h3><p>HarmonyOS 提供了用于实现录屏功能的ArkTS接口，能够支持屏幕录制及音频数据采集。然而，ArkTS侧的实现方案仅能通过文件形式将数据流转至其他模块进行播放或处理。</p> <p>本节将通过一个案例介绍如何在ArkTS侧实现录屏存文件。在该案例中，用户点击屏幕录制按钮即可启动屏幕录制，期间可以切换至后台录制桌面或其他应用页面。当用户点击停止按钮或屏幕左上角录屏胶囊中的停止按钮时，屏幕录制将停止。录屏内容将保存至应用沙箱文件中，点击结束录屏后出现的播放按钮，即可播放录制的视频文件。</p> <p><strong>案例展示图：</strong></p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163041.78377621831429412828092623667886:50001231000000:2800:B661D2850E532D7DEA5DEBE106F76AA1381BB41F4BD91BA348497F51E43EF888.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section698142653410">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section698142653410" tips="复制节点链接"></i></h3><p><strong>调用流程图</strong></p> <p><span><img originheight="695" originwidth="800" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163041.71290889695550896327198537254259:50001231000000:2800:45A392DD94B305BD7B4DE87122D7CBC474CF256F70B271F042B64D050E60E4F2.png" width="800" height="695"></span></p> <p>当点击录制按钮时，会调用异步方法进行屏幕录制。关键过程如下：</p> <ol><li>等到异步任务得到调度后，会先获取文件信息，用于保存录屏视频。</li><li>接着会通过createAVScreenCaptureRecorder()方法构建出AVScreenCaptureRecorder的实例化对象。</li><li>然后为该实例对象绑定状态变化监听函数和异常监听函数。</li><li>接着还需要配置屏幕录制参数，然后根据参数配置对实例化对象进行初始化。</li><li>初始化完成之后即可调用startRecording()方法开启屏幕录制。</li></ol> <p>当点击停止按钮时，同样系统会调用异步方法来停止录制。等到异步任务被调度后，将调用stopRecording()方法停止屏幕录制，随后关闭文件fd。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>EventLoop事件循环是ArkTS异步编程模型的核心（单线程+任务队列），其在JS/TS的基础上结合了HarmonyOS的UI框架和任务调度特性，主要用于管理代码执行顺序、处理异步操作（如网络请求、定时器、用户交互、I/O）以及更新UI等。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section1822133773410">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1822133773410" tips="复制节点链接"></i></h3><ol><li>获取文件信息。<p>首先，通过时间戳和应用沙箱目录拼接出文件路径，然后利用文件管理模块的openSync()接口获取文件信息。后续的录屏文件将存储在该文件中。</p> <p>获取沙箱路径。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/ArkTSAVScreenCapture.ets#L27-L27" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> filesDir = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()?.filesDir;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/ArkTSAVScreenCapture.ets#L27-L27" target="_blank">ArkTSAVScreenCapture.ets</a></div></div></div></div> <p>拼接文件路径并获取文件信息。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L143-L148" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> updateFileFd(filesDir: string) {</li><li>  <span class="hljs-comment">// 获取文件fd</span></li><li>  <span class="hljs-keyword">this</span>.fileName = systemDateTime.getTime(<span class="hljs-literal">true</span>).toString() + <span class="hljs-string">'.mp4'</span>;</li><li>  <span class="hljs-keyword">this</span>.path = filesDir + <span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.fileName;</li><li>  <span class="hljs-keyword">this</span>.file = fs.openSync(<span class="hljs-keyword">this</span>.path, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L143-L148" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> </li><li>创建AVScreenCaptureRecorder实例化对象并绑定监听函数。<p>通过MediaKit提供的createAVScreenCaptureRecorder()接口构建实例对象，然后使用.on接口为其绑定可选的监听回调函数。在以下示例中，订阅了两个回调事件：stateChange（状态切换事件回调）和error（错误事件回调）。对于同一个回调事件，用户只能订阅一次，若重复订阅，则以最后一次订阅的回调接口为准。已订阅的回调事件还可以通过off接口取消订阅。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L35-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取fd</span></li><li><span class="hljs-keyword">this</span>.updateFileFd(filesDir);</li><li><span class="hljs-comment">// 实例化对象</span></li><li><span class="hljs-keyword">this</span>.screenCapture = await media.createAVScreenCaptureRecorder();</li><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.screenCapture != undefined) {</li><li>  hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'ScreenCapture has been created successfully.'</span>);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'ScreenCapture creation failed.'</span>);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// 监听屏幕捕获的状态更改</span></li><li><span class="hljs-keyword">this</span>.screenCapture?.on(<span class="hljs-string">'stateChange'</span>, async (infoType: media.AVScreenCaptureStateCode) =&gt; {</li><li>  switch (infoType) {</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_STARTED:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏成功开始后会收到的回调.'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_CANCELED:</li><li>      <span class="hljs-keyword">this</span>.screenCapture?.release();</li><li>      <span class="hljs-keyword">this</span>.screenCapture = undefined;</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'不允许使用录屏功能.'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_STOPPED_BY_USER:</li><li>      <span class="hljs-keyword">this</span>.screenCapture?.release();</li><li>      <span class="hljs-keyword">this</span>.screenCapture = undefined;</li><li>      AppStorage.setOrCreate(<span class="hljs-string">'isRecordOne'</span>, <span class="hljs-literal">false</span>);</li><li>      AppStorage.setOrCreate(<span class="hljs-string">'fileNameOne'</span>, <span class="hljs-keyword">this</span>.fileName);</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG,</li><li>        <span class="hljs-string">'通过屏幕录制胶囊结束屏幕录制，底层录制停止'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_INTERRUPTED_BY_OTHER:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'屏幕录制因其他中断而停止'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_STOPPED_BY_CALL:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'屏幕录制被电话打断'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_MIC_UNAVAILABLE:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏麦克风不可用'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_MIC_MUTED_BY_USER:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏麦克风被用户静音'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_MIC_UNMUTED_BY_USER:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏麦克风被用户取消静音'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_ENTER_PRIVATE_SCENE:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏进入隐私场景'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_EXIT_PRIVATE_SCENE:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'录屏退出隐私场景'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case media.AVScreenCaptureStateCode.SCREENCAPTURE_STATE_STOPPED_BY_USER_SWITCHES:</li><li>      hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'用户账号切换，底层录制会停止'</span>);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    default:</li><li>      <span class="hljs-keyword">break</span>;</li><li>  }</li><li>})</li><li>
</li><li><span class="hljs-comment">// 监听异常</span></li><li><span class="hljs-keyword">this</span>.screenCapture?.on(<span class="hljs-string">'error'</span>, (err) =&gt; {</li><li>  hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'Handle exception cases.'</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L35-L97" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> </li><li>配置录制参数并初始化AVScreenCaptureRecorder对象。<p>示例中通过 getDefaultDisplaySync() 方法获取屏幕宽高。开发者也可以自定义屏幕宽高，但需注意，若设置不当，可能会导致录制的视频界面出现黑边。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> displayInfo = display.getDefaultDisplaySync();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>以下配置了屏幕录制参数，除了fd配置外，其余配置均为可选。未配置时，将采用默认值。默认值可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-i#avscreencapturerecordconfig12" target="_blank">AVScreenCaptureRecordConfig</a>。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L101-L114" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 配置屏幕录制参数</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">captureConfig</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">AVScreenCaptureRecordConfig</span> = {</li><li>  <span class="hljs-comment">// 开发者可以根据自己的需要设置宽度和高度</span></li><li>  <span class="hljs-variable">frameWidth</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">displayInfo</span>.<span class="hljs-title class_">width</span>,</li><li>  <span class="hljs-variable">frameHeight</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">displayInfo</span>.<span class="hljs-title class_">height</span>,</li><li>  <span class="hljs-comment">// 用于写入文件的文件描述符（fd）</span></li><li>  <span class="hljs-variable">fd</span>: (<span class="hljs-keyword">this</span>.<span class="hljs-title class_">file</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">fs</span>.<span class="hljs-title class_">File</span>).<span class="hljs-title class_">fd</span>,</li><li>  <span class="hljs-comment">// 可选参数及其默认值</span></li><li>  <span class="hljs-variable">videoBitrate</span>: <span class="hljs-number">10000000</span>,</li><li>  <span class="hljs-variable">audioSampleRate</span>: <span class="hljs-number">48000</span>,</li><li>  <span class="hljs-variable">audioChannelCount</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-variable">audioBitrate</span>: <span class="hljs-number">96000</span>,</li><li>  <span class="hljs-variable">displayId</span>: <span class="hljs-number">0</span>,</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L101-L114" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> <p>基于上述配置信息初始化screenCapture实例对象。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L118-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.screenCapture?.<span class="hljs-keyword">init</span>(captureConfig);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L118-L118" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> </li><li>通过startRecording()接口开启录制。<p>startRecording()接口以异步方式启动录屏，启动后录屏不会影响页面操作。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L122-L122" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.screenCapture?.startRecording();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L122-L122" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> </li><li>通过stopRecording()停止录制并关闭文件。<p>同样的，stopRecording()接口也是异步接口，示例中首先通过stopRecording()接口停止录制，然后调用release()方法销毁实例，释放资源。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L126-L139" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 停止录屏</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">stopRecording</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span> == <span class="hljs-literal">undefined</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0xFF00</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">LOG_TAG</span>, <span class="hljs-string">'ScreenCapture exception.'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">stopRecording</span>();</li><li>
</li><li>  <span class="hljs-comment">// 调用release()方法来销毁实例并释放资源</span></li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenCapture</span>?.<span class="hljs-title function_">release</span>();</li><li>
</li><li>  <span class="hljs-comment">// 关闭文件</span></li><li>  fs.<span class="hljs-title function_">close</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span> <span class="hljs-keyword">as</span> fs.<span class="hljs-property">File</span>).<span class="hljs-property">fd</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/model/MyAVScreenCapture.ets#L126-L139" target="_blank">MyAVScreenCapture.ets</a></div></div></div></div> </li></ol> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>除了通过主动点击按钮调用stopRecording()来停止录屏外，还可以通过点击录屏胶囊中的结束按钮来停止录制。该方案主要依赖于回调函数实现，当用户点击胶囊中的停止按钮时，录屏对象实例screenCapture会触发SCREENCAPTURE_STATE_STOPPED_BY_USER的回调，通知应用录屏已停止，无需开发者主动调用stopRecording()方法。在C/C++方法中，对应的回调是OH_SCREEN_CAPTURE_STATE_STOPPED_BY_USER。</p> </div></div></div> <div class="tiledSection"><h2 id="section6121629163710">使用AVScreenCapture模块录屏写文件（C/C++）<i class="anchor-icon anchor-icon-link" anchorid="section6121629163710" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1463810183373" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1463810183373" tips="复制节点链接"></i></h3><p>除了ArkTS侧接口，系统还提供实现录屏功能相应的C语言版本的API接口。该API接口支持文件和码流两种格式，本小节主要介绍其进行屏幕录制时，直接存文件的实现方案，该方案需要配置录屏的数据类型为OH_CAPTURE_FILE。</p> <p>案例实现的页面效果与上一章节一致，主要区别在于代码层面。同样的，在该案例中用户点击屏幕录制按钮会开启屏幕录制，当用户点击停止按钮或者点击屏幕左上角录屏胶囊中的停止按钮会停止屏幕录制并将录屏信息保存到应用沙箱文件中。点击播放按钮会播放录制的视频文件。</p> <p><strong>案例展示图：</strong></p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163041.51901567317920301640809396456460:50001231000000:2800:2C7710CFECC737385F7A5D72ECE33A0A763C5EA38410965F33A3549C4FA259CF.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section1363851893714">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1363851893714" tips="复制节点链接"></i></h3><p><strong>调用流程图</strong></p> <p><span><img height="544.0897" originheight="729" originwidth="1072" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163041.61522665070032073764928230438849:50001231000000:2800:A476551AAF9F567F37BE1B27F340E3DD91FA6927644A97ADDBA1C5E6B5FEB0AA.png" title="点击放大" width="798"></span></p> <p>当点击录制按钮时，会调用异步方法进行屏幕录制。关键过程如下：</p> <ol><li>当异步任务被调度，会先获取一个文件信息，用于保存录屏视频。</li><li>然后调用Native侧的方法，并传递文件fd、设备宽高等参数至Native侧。</li><li>在Native侧，首先创建一个AVScreenCapture实例对象，并使用从ArkTS传递过来的参数（文件fd、设备宽高等）配置屏幕录制参数并进行初始化。</li><li>初始化完成后，还需为该实例对象绑定可选的回调函数，如状态变更和数据处理等。</li><li>最后，在完成所有配置后，调用OH_AVScreenCapture_StartScreenRecording()方法开始屏幕录制。</li></ol> <p>当点击停止按钮时，会调用相应的Native方法，Native侧通过调用OH_AVScreenCapture_StopScreenRecording()方法来停止屏幕录制；随后，控制权返回到ArkTS侧，在此调用异步方法以关闭文件fd。</p> </div> <div class="tiledSection"><h3 id="section16251317173711">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section16251317173711" tips="复制节点链接"></i></h3><ol><li>获取文件信息并调用Native侧方法传递参数。<p>与上述方案类似，通过时间戳和应用沙箱目录拼接生成文件路径，然后利用文件管理模块提供的openSync()接口获取文件信息。该文件的fd将传递到Native侧，用于配置录屏数据的最终存储位置。在以下示例中，可以看到通过调用Native方法startScreenCaptureToFile()，将文件fd和屏幕的宽度及高度三个参数传递到Native侧。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToFile.ets#L44-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取保存文件信息并调用Native方法</span></li><li>async createVideoFd(): Promise&lt;void&gt; {</li><li>  <span class="hljs-comment">// 拼接文件路径</span></li><li>  <span class="hljs-keyword">this</span>.tmpFileNameTwo = systemDateTime.getTime(<span class="hljs-literal">true</span>) + <span class="hljs-string">'.mp4'</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.filepath = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()?.filesDir + <span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.tmpFileNameTwo;</li><li>  hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'filepath uri: %{public}s'</span>, <span class="hljs-keyword">this</span>.filepath);</li><li>
</li><li>  <span class="hljs-comment">// 获取文件信息</span></li><li>  <span class="hljs-keyword">this</span>.file = fs.openSync(<span class="hljs-keyword">this</span>.filepath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// 调用native方法开启录制并传递fd、宽高</span></li><li>  avScreenCapture.startScreenCaptureToFile(<span class="hljs-keyword">this</span>.file.fd, <span class="hljs-keyword">this</span>.displayInfo.width, <span class="hljs-keyword">this</span>.displayInfo.height);</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToFile.ets#L44-L67" target="_blank">CAVScreenCaptureToFile.ets</a></div></div></div></div> <p>这里获取屏幕宽高的实现代码与上述内容一致，都是通过ArkTS接口获取的。开发者也可以选择在Native侧获取，参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-display-manager-h" target="_blank">oh_display_manager.h</a>。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> displayInfo = display.getDefaultDisplaySync();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>创建AVScreenCapture实例化对象并初始化。<p>首先，获取了ArkTS侧的参数信息，这些参数在配置录屏参数时将被使用。接着，调用OH_AVScreenCapture_Create()创建实例对象，随后配置录制参数并初始化AVScreenCapture对象。</p> <p>创建实例化对象。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L205-L287" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">napi_value <span class="hljs-title">CAVScreenCaptureToFile::StartScreenCaptureToFile</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">3</span>;</li><li>    napi_value args[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> outputFd, videoWidth, videoHeight;</li><li>    <span class="hljs-comment">// 获取参数：文件fd和宽高</span></li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">0</span>], &amp;outputFd);</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">1</span>], &amp;videoWidth);</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">2</span>], &amp;videoHeight);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"文件FD为 %{public}d"</span>, outputFd);</li><li>    <span class="hljs-keyword">if</span> (outputFd &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"FD ERROR: %{public}d"</span>, outputFd);</li><li>        napi_value res;</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, <span class="hljs-number">-1</span>, &amp;res);</li><li>        <span class="hljs-keyword">return</span> res;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (g_avCapture_ != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">StopScreenCaptureRecording</span>(g_avCapture_);</li><li>        <span class="hljs-built_in">OH_AVScreenCapture_Release</span>(g_avCapture_);</li><li>    }</li><li>    <span class="hljs-comment">// 创建实例化对象</span></li><li>    g_avCapture_ = <span class="hljs-built_in">OH_AVScreenCapture_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (g_avCapture_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"CAVScreenCaptureToFile create screen capture failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L205-L287" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>录屏模式，录屏流数据类型以及录屏文件参数配置。</p> <p>上面获取的文件fd信息也是在此处配置的。直接将录屏保存到文件时，需要将dataType值设置为OH_CAPTURE_FILE。当数据格式为OH_CAPTURE_FILE时，必须配置录制文件参数（recorderInfo），其中包含文件保存的路径信息。在将录屏保存为文件时，默认录制内部音频，但也可以同时录制内外音频，且麦克风可以动态开启或关闭。可以使用OH_AVScreenCapture_SetMicrophoneEnabled()函数动态控制麦克风的开关。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L235-L255" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">OH_AVScreenCaptureConfig</span> <span class="hljs-variable">config_</span>;</li><li><span class="hljs-variable">OH_RecorderInfo</span> <span class="hljs-variable">recorderInfo</span>;</li><li>
</li><li><span class="hljs-comment">// 转文件fd为url</span></li><li><span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">fileUrl</span> = <span class="hljs-string">"fd://"</span> + <span class="hljs-variable">std</span>::<span class="hljs-title class_">to_string</span>(<span class="hljs-title class_">outputFd</span>);</li><li><span class="hljs-variable">recorderInfo</span>.<span class="hljs-variable">url</span> = <span class="hljs-title class_">const_cast</span>&lt;<span class="hljs-title class_">char</span> *&gt;(<span class="hljs-variable">fileUrl</span>.<span class="hljs-title function_">c_str</span>());</li><li><span class="hljs-comment">// 文件格式MP4</span></li><li><span class="hljs-variable">recorderInfo</span>.<span class="hljs-variable">fileFormat</span> = <span class="hljs-variable">OH_ContainerFormatType</span>::<span class="hljs-title class_">CFT_MPEG_4</span>;</li><li><span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"CAVScreenCaptureToFile ScreenCapture fileUrl %{public}s"</span>, <span class="hljs-variable">fileUrl</span>.<span class="hljs-title function_">c_str</span>());</li><li>
</li><li><span class="hljs-comment">// 调用音视频录制参数配置函数</span></li><li><span class="hljs-title function_">SetConfigAsFile</span>(<span class="hljs-variable">config_</span>, <span class="hljs-variable">videoWidth</span>, <span class="hljs-variable">videoHeight</span>);</li><li><span class="hljs-variable">config_</span>.<span class="hljs-variable">captureMode</span> = <span class="hljs-variable">OH_CAPTURE_HOME_SCREEN</span>;</li><li><span class="hljs-variable">config_</span>.<span class="hljs-variable">dataType</span> = <span class="hljs-variable">OH_CAPTURE_FILE</span>;</li><li><span class="hljs-variable">config_</span>.<span class="hljs-variable">recorderInfo</span> = <span class="hljs-variable">recorderInfo</span>;</li><li>    </li><li><span class="hljs-comment">// 设置麦克风开关</span></li><li><span class="hljs-variable">bool</span> <span class="hljs-variable">isMicrophone</span> = <span class="hljs-keyword">true</span>;</li><li><span class="hljs-title function_">OH_AVScreenCapture_SetMicrophoneEnabled</span>(<span class="hljs-variable">g_avCapture_</span>, <span class="hljs-variable">isMicrophone</span>);</li><li>
</li><li><span class="hljs-title function_">OH_AVScreenCapture_SetCanvasRotation</span>(<span class="hljs-variable">g_avCapture_</span>, <span class="hljs-keyword">true</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L235-L255" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>音视频录制参数配置。</p> <p>上面获取到的屏幕宽高数据是在这里配置的。请注意，内录参数为必填项。如果同时设置了内录和外录参数，内录和麦克风（即外录）的参数设置需要保持一致。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L143-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> CAVScreenCaptureToFile::SetConfigAsFile(OH_AVScreenCaptureConfig &amp;config, int32_t videoWidth,</li><li>                                             int32_t videoHeight) {</li><li>    <span class="hljs-comment">// 音频配置</span></li><li>    <span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">micCapInfo</span> <span class="hljs-operator">=</span> {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_SOURCE_DEFAULT};</li><li>    <span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">innerCapInfo</span> <span class="hljs-operator">=</span> {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_ALL_PLAYBACK};</li><li>    <span class="hljs-type">OH_AudioEncInfo</span> <span class="hljs-variable">audioEncInfo</span> <span class="hljs-operator">=</span> {.audioBitrate = <span class="hljs-number">96000</span>, .audioCodecformat = OH_AudioCodecFormat::OH_AAC_LC};</li><li>    <span class="hljs-type">OH_AudioInfo</span> <span class="hljs-variable">audioInfo</span> <span class="hljs-operator">=</span> {.micCapInfo = micCapInfo, .innerCapInfo = innerCapInfo, .audioEncInfo = audioEncInfo};</li><li>
</li><li>    <span class="hljs-comment">// 视频配置</span></li><li>    <span class="hljs-type">OH_VideoCaptureInfo</span> <span class="hljs-variable">videoCapInfo</span> <span class="hljs-operator">=</span> {</li><li>        .videoFrameWidth = videoWidth, .videoFrameHeight = videoHeight, .videoSource = OH_VIDEO_SOURCE_SURFACE_RGBA};</li><li>    <span class="hljs-type">OH_VideoEncInfo</span> <span class="hljs-variable">videoEncInfo</span> <span class="hljs-operator">=</span> {</li><li>        .videoCodec = OH_VideoCodecFormat::OH_H264, .videoBitrate = <span class="hljs-number">10000000</span>, .videoFrameRate = <span class="hljs-number">30</span>};</li><li>    <span class="hljs-type">OH_VideoInfo</span> <span class="hljs-variable">videoInfo</span> <span class="hljs-operator">=</span> {.videoCapInfo = videoCapInfo, .videoEncInfo = videoEncInfo};</li><li>
</li><li>    config = {</li><li>        .captureMode = OH_CAPTURE_HOME_SCREEN,</li><li>        .dataType = OH_ORIGINAL_STREAM,</li><li>        .audioInfo = audioInfo,</li><li>        .videoInfo = videoInfo,</li><li>        .recorderInfo = {},</li><li>    };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L143-L165" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>根据配置初始化AVScreenCapture实例对象。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L259-L259" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">OH_AVSCREEN_CAPTURE_ErrCode</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> OH_AVScreenCapture_Init(g_avCapture_, config_);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L259-L259" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> </li><li>绑定回调函数<p>这里设置了 stateChange（状态切换事件回调）和 error（错误事件回调）。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L268-L270" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 设置回调</span></li><li><span class="hljs-built_in">OH_AVScreenCapture_SetErrorCallback</span>(g_avCapture_, OnErrorSaveFile, nullptr);</li><li><span class="hljs-built_in">OH_AVScreenCapture_SetStateCallback</span>(g_avCapture_, OnStateChangeSaveFile, nullptr);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L268-L270" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>回调具体实现如下：</p> <p>状态变化回调。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L64-L136" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CAVScreenCaptureToFile::OnStateChangeSaveFile</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> OH_AVScreenCapture *capture,</span></span></li><li><span class="hljs-function">                                                   OH_AVScreenCaptureStateCode stateCode, <span class="hljs-type">void</span> *userData)</span> {</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    <span class="hljs-keyword">switch</span> (stateCode) {</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_STARTED: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"录屏开始状态变更"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_CANCELED: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"录屏取消状态变更 "</span>);</li><li>        <span class="hljs-built_in">StopScreenCaptureRecording</span>(capture);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_STOPPED_BY_CALL: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏被电话打断状态处理"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_MIC_UNAVAILABLE: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏中途麦克风无法获取状态"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_INTERRUPTED_BY_OTHER: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏状态被被打断"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_MIC_MUTED_BY_USER: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏中途用户将麦克风禁音"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_MIC_UNMUTED_BY_USER: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏中途用户将麦克风解除禁音"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_ENTER_PRIVATE_SCENE: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏进入隐私状态"</span>);</li><li>        <span class="hljs-function">std::thread <span class="hljs-title">releaseSCInstanceThread</span><span class="hljs-params">(ReleaseSCWorker, capture)</span></span>;</li><li>        releaseSCInstanceThread.<span class="hljs-built_in">detach</span>();</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_EXIT_PRIVATE_SCENE: {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏退出隐私模式状态"</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">case</span> OH_SCREEN_CAPTURE_STATE_STOPPED_BY_USER: {</li><li>        <span class="hljs-built_in">napi_acquire_threadsafe_function</span>(tsFn);</li><li>        <span class="hljs-built_in">napi_call_threadsafe_function</span>(tsFn, <span class="hljs-literal">nullptr</span>, napi_tsfn_nonblocking);</li><li>        <span class="hljs-built_in">napi_release_threadsafe_function</span>(tsFn, napi_tsfn_release);</li><li>        tsFn = <span class="hljs-literal">nullptr</span>;</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP,</li><li>                    <span class="hljs-string">"录屏被用户切换打断"</span>);</li><li>        <span class="hljs-function">std::thread <span class="hljs-title">releaseSCInstanceThread</span><span class="hljs-params">(ReleaseSCWorker, capture)</span></span>;</li><li>        releaseSCInstanceThread.<span class="hljs-built_in">detach</span>();</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">default</span>:</li><li>        <span class="hljs-keyword">break</span>;</li><li>    }</li><li>    </li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L64-L136" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>错误监听回调。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L45-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CAVScreenCaptureToFile::OnErrorSaveFile</span><span class="hljs-params">(OH_AVScreenCapture *capture, <span class="hljs-type">int32_t</span> errorCode, <span class="hljs-type">void</span> *userData)</span> </span>{</li><li>    (<span class="hljs-type">void</span>)capture;</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"录屏发生错误，错误码为 %{public}d"</span>, errorCode);</li><li>    (<span class="hljs-type">void</span>)userData;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L45-L49" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> </li><li>通过OH_AVScreenCapture_StartScreenRecording()开启录制。<div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ini" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L274-L274" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">result</span> = OH_AVScreenCapture_StartScreenRecording(g_avCapture_)<span class="hljs-comment">;</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L274-L274" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> </li><li>通过调用OH_AVScreenCapture_StopScreenRecording()停止录制，然后释放ScreenCapture实例。<div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-wasm" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L169-L201" data-highlighted="yes"><ol class="linenums"><li>napi_value CAVScreenCaptureToFile::StopScreenCaptureToFile<span class="hljs-punctuation">(</span>napi_env env, napi_callback_info info<span class="hljs-punctuation">)</span> {</li><li>    // ...</li><li>
</li><li>        OH_LOG_INFO<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"停止屏幕录制"</span><span class="hljs-punctuation">)</span>;</li><li>        <span class="hljs-keyword">result</span> = OH_AVScreenCapture_StopScreenRecording<span class="hljs-punctuation">(</span>g_avCapture_<span class="hljs-punctuation">)</span>;</li><li>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-keyword">result</span> != AV_SCREEN_CAPTURE_ERR_BASE<span class="hljs-punctuation">)</span> {</li><li>            OH_LOG_ERROR<span class="hljs-punctuation">(</span></li><li>                LOG_APP,</li><li>                <span class="hljs-string">"停止屏幕录制错误，结果为：%{public}d"</span>,</li><li>                <span class="hljs-keyword">result</span><span class="hljs-punctuation">)</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            OH_LOG_INFO<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"停止屏幕录制成功"</span><span class="hljs-punctuation">)</span>;</li><li>        }</li><li>        <span class="hljs-keyword">result</span> = OH_AVScreenCapture_Release<span class="hljs-punctuation">(</span>g_avCapture_<span class="hljs-punctuation">)</span>;</li><li>        <span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-keyword">result</span> != AV_SCREEN_CAPTURE_ERR_BASE<span class="hljs-punctuation">)</span> {</li><li>            OH_LOG_ERROR<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"释放实例化对象异常，错误为: %{public}d"</span>,</li><li>                         <span class="hljs-keyword">result</span><span class="hljs-punctuation">)</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            OH_LOG_INFO<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"释放实例化对象成功"</span><span class="hljs-punctuation">)</span>;</li><li>        }</li><li>        // ...</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L169-L201" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> <p>然后在ArkTS侧关闭文件。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToFile.ets#L71-L76" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseFD</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>?.<span class="hljs-property">fd</span> != <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>.<span class="hljs-property">fd</span>?.<span class="hljs-title function_">valueOf</span>() &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 关闭文件</span></li><li>    fs.<span class="hljs-title function_">close</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>.<span class="hljs-property">fd</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToFile.ets#L71-L76" target="_blank">CAVScreenCaptureToFile.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section15553154512379">使用AVScreenCapture模块录屏转码流（C/C++）<i class="anchor-icon anchor-icon-link" anchorid="section15553154512379" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1833511983810" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1833511983810" tips="复制节点链接"></i></h3><p>本小节主要介绍通过C语言版本的API实现屏幕录制的另一种方法，即将录屏数据提取为码流，然后通过该码流合成视频文件。此方案需要将录屏的数据类型配置为OH_ORIGINAL_STREAM，实现过程较为复杂，涉及绑定音频和视频编码器以及封装器对数据进行处理。</p> <p>案例实现的页面效果与前两个章节一致，通过点击对应按钮开启/关闭录屏，录屏结束后可以播放录屏视频。</p> <p><strong>案例展示图：</strong></p> <p><span><img height="567.7504" originheight="1080" originwidth="506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163041.50479526765183696254528694757812:50001231000000:2800:76342709E0576834430527C36C91C4D5D769720D02C345CC7738E50EC3787D25.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section333514943815">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section333514943815" tips="复制节点链接"></i></h3><p><strong>调用流程图</strong></p> <p><span><img height="569.6523000000001" originheight="690" originwidth="969" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163042.40829619692999867454500003495869:50001231000000:2800:563F15624A9598228B67DED5C769C15B7DECA207643329AE7214E79045AF1320.png" title="点击放大" width="798"></span></p> <p>当点击录制按钮时，系统会调用异步方法来执行屏幕录制。关键过程如下：</p> <ol><li>当异步任务被调度后，系统会先获取文件信息，用于保存录屏视频。</li><li>然后调用Native侧方法，并传递文件fd、设备宽度等参数至Native侧。</li><li>Native侧首先会创建音频编码器、视频编码器以及封装器对应的实例对象并绑定相应的数据处理回调函数。</li><li>然后配置音频录制参数并初始化音频录制实例对象（OH_AudioCapturer类型），同时配置屏幕录制参数并初始化屏幕录制实例对象（OH_AVScreenCapture类型）。</li><li>最后，启动音视频录制，并创建音视频编码器及封装器的子线程，这些子线程主要用于处理采集的音视频码流数据并进行封装。</li></ol> <p>当点击停止按钮时，会调用相应的Native方法。Native侧首先等待数据写入完成，随后启动子线程来释放音视频编码器及封装器的相关资源。此时，Native主线程将等待这些资源释放完毕，然后调用OH_AVScreenCapture_StopScreenRecording()方法停止屏幕录制。之后，控制权返回到ArkTS侧，在ArkTS侧调用异步方法关闭文件fd。</p> </div> <div class="tiledSection"><h3 id="section18335189123817">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section18335189123817" tips="复制节点链接"></i></h3><ol><li>获取文件信息并调用Native侧方法传递参数。<p>这一步与C/C++侧录屏存文件的方法一致。通过时间戳和应用沙箱目录拼接出文件路径，然后获取文件信息。接着调用Native方法startScreenCaptureToStream()并传递参数。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToStream.ets#L44-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 获取保存文件信息并调用Native方法</span></li><li>async createVideoFd(): Promise&lt;void&gt; {</li><li>  <span class="hljs-comment">// 拼接文件路径</span></li><li>  <span class="hljs-keyword">this</span>.tmpFileNameThree = systemDateTime.getTime(<span class="hljs-literal">true</span>) + <span class="hljs-string">'.mp4'</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.filepath = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()?.filesDir + <span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.tmpFileNameThree;</li><li>  hilog.info(<span class="hljs-number">0xFF00</span>, CommonConstants.LOG_TAG, <span class="hljs-string">'filepath uri: %{public}s'</span>, <span class="hljs-keyword">this</span>.filepath);</li><li>
</li><li>  <span class="hljs-comment">// 获取文件信息</span></li><li>  <span class="hljs-keyword">this</span>.file = fs.openSync(<span class="hljs-keyword">this</span>.filepath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// 调用native方法开启录制并传递fd、宽高</span></li><li>  avScreenCapture.startScreenCaptureToStream(<span class="hljs-keyword">this</span>.file.fd, <span class="hljs-keyword">this</span>.displayInfo.width, <span class="hljs-keyword">this</span>.displayInfo.height)</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToStream.ets#L44-L68" target="_blank">CAVScreenCaptureToStream.ets</a></div></div></div></div> <p>通过ArkTS侧接口获取屏幕宽高，Native侧获取方法参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-display-manager-h" target="_blank">oh_display_manager.h</a>。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> displayInfo = display.getDefaultDisplaySync();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/entryability/EntryAbility.ets#L103-L103" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>初始化音频编码器、视频编码器以及封装器。<p>首先，也需要获取ArkTS侧的参数，这部分内容在前面已经介绍过，这里不再赘述。具体可参考使用AVScreenCapture模块进行录屏存文件的章节。</p> <p>音视频编码器的相关配置中，sampleInfo用于存储参数配置信息，这些信息将在后续配置音频编码器、视频编码器及封装器配置项时使用。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L234-L274" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">InitConfig</span>(<span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">outputFd</span>, <span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">videoWidth</span>, <span class="hljs-title class_">int32_t</span> <span class="hljs-title class_">videoHeight</span>) {</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">outputFd</span> = <span class="hljs-variable">outputFd</span>;</li><li>
</li><li>    <span class="hljs-comment">// 视频编码器配置</span></li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">videoWidth</span> = <span class="hljs-variable">videoWidth</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">videoHeight</span> = <span class="hljs-variable">videoHeight</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span> = <span class="hljs-number">30</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">bitrate</span> = <span class="hljs-number">10000000</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">videoCodecMime</span> = <span class="hljs-string">"video/avc"</span>;</li><li>
</li><li>    <span class="hljs-comment">// 音频编码器配置</span></li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioCodecMime</span> = <span class="hljs-variable">OH_AVCODEC_MIMETYPE_AUDIO_AAC</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioSampleFormat</span> = <span class="hljs-variable">OH_BitsPerSample</span>::<span class="hljs-title class_">SAMPLE_S16LE</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioSampleRate</span> = <span class="hljs-number">48000</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioChannelCount</span> = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioBitRate</span> = <span class="hljs-number">96000</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioChannelLayout</span> = <span class="hljs-variable">OH_AudioChannelLayout</span>::<span class="hljs-title class_">CH_LAYOUT_STEREO</span>;</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioMaxInputSize</span> = <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioSampleRate</span> * <span class="hljs-number">0.02</span> * <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">audioChannelCount</span> * <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">short</span>);</li><li>
</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>
</li><li>    <span class="hljs-comment">// 声明音视频编码器、音频采集器及封装器类对象</span></li><li>    <span class="hljs-variable">audioEncoder_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">AudioEncoder</span>&gt;();</li><li>    <span class="hljs-variable">audioCapturer_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">AudioCapturer</span>&gt;();</li><li>    <span class="hljs-variable">videoEncoder_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">VideoEncoder</span>&gt;();</li><li>    <span class="hljs-variable">muxer_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">Muxer</span>&gt;();</li><li>
</li><li>    <span class="hljs-comment">// 根据文件fd创建封装器并初始化</span></li><li>    <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">Create</span>(<span class="hljs-title class_">sampleInfo_</span>.<span class="hljs-title class_">outputFd</span>);</li><li>    <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">Config</span>(<span class="hljs-title class_">sampleInfo_</span>);</li><li>
</li><li>    <span class="hljs-comment">// 创建音视频编码器</span></li><li>    <span class="hljs-title function_">CreateEncoder</span>();</li><li>
</li><li>    <span class="hljs-comment">// 初始化音频采集器对象</span></li><li>    <span class="hljs-variable">audioCapturer_</span>-&gt;<span class="hljs-title class_">AudioCapturerInit</span>(<span class="hljs-title class_">sampleInfo_</span>, <span class="hljs-title class_">audioEncContext_</span>);</li><li>    </li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L234-L274" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> <p>创建封装器对象。</p> <p>需要提供文件fd及封装器的输出格式，此处配置为MP4格式。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L30-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Create</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd)</span> </span>{</li><li>    muxer_ = <span class="hljs-built_in">OH_AVMuxer_Create</span>(fd, AV_OUTPUT_FORMAT_MPEG_4);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L30-L33" target="_blank">Muxer.cpp</a></div></div></div></div> <p>配置封装器配置项。</p> <p>通过调用OH_AVFormat_CreateVideoFormat()创建视频格式来添加视频轨道。</p> <p>配置完成后，即可调用OH_AVMuxer_Start()开始封装音视频数据。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L37-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Config</span><span class="hljs-params">(SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    <span class="hljs-comment">// 创建并添加音频轨</span></li><li>    OH_AVFormat *formatAudio = <span class="hljs-built_in">OH_AVFormat_CreateAudioFormat</span>(sampleInfo.audioCodecMime.<span class="hljs-built_in">data</span>(),</li><li>                                                             sampleInfo.audioSampleRate, sampleInfo.audioChannelCount);</li><li>    <span class="hljs-comment">// 设置相关参数</span></li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_PROFILE, AAC_PROFILE_LC);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;audioTrackId_, formatAudio);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatAudio);</li><li>
</li><li>    <span class="hljs-comment">// 创建并添加视频轨</span></li><li>    OH_AVFormat *formatVideo =</li><li>        <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>(), sampleInfo.videoWidth, sampleInfo.videoHeight);</li><li>    </li><li>    <span class="hljs-comment">// 设置相关参数</span></li><li>    <span class="hljs-built_in">OH_AVFormat_SetDoubleValue</span>(formatVideo, OH_MD_KEY_FRAME_RATE, sampleInfo.frameRate);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_WIDTH, sampleInfo.videoWidth);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_HEIGHT, sampleInfo.videoHeight);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(formatVideo, OH_MD_KEY_CODEC_MIME, sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>());</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;videoTrackId_, formatVideo);</li><li>    <span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"AddTrack failed"</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatVideo);</li><li>    formatVideo = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L37-L64" target="_blank">Muxer.cpp</a></div></div></div></div> <p>创建音频编码器。</p> <p>从mime类型创建音频编码器实例。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioEncoder.cpp#L24-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 创建音频编码器</span></li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">AudioEncoder::Create</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;codecMime)</span> </span>{</li><li>    encoder_ = <span class="hljs-built_in">OH_AudioCodec_CreateByMime</span>(codecMime.<span class="hljs-built_in">c_str</span>(), <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioEncoder.cpp#L24-L28" target="_blank">AudioEncoder.cpp</a></div></div></div></div> <p>配置音频编码器。</p> <p>首先，将配置信息写入format，然后通过OH_AudioCodec_Configure()接口配置编码器。接下来，使用OH_AudioCodec_RegisterCallback()方法注册回调函数。这些回调函数包括：监控编解码器操作错误、监控编解码器流变化、监控编解码器需要输入数据、监控编解码器已生成输出数据。请注意，音频编码器目前不支持监控编解码器流变化的回调。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioEncoder.cpp#L35-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">AudioEncoder</span>::<span class="hljs-title class_">Config</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>, <span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*codecUserData</span>) {</li><li>    <span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">format</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"AVFormat create failed"</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 配置相关参数</span></li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUDIO_SAMPLE_FORMAT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioSampleFormat</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUD_CHANNEL_COUNT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioChannelCount</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_AUD_SAMPLE_RATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioSampleRate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioBitRate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_CHANNEL_LAYOUT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioChannelLayout</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_MAX_INPUT_SIZE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioMaxInputSize</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Configure</span>(<span class="hljs-variable">encoder_</span>, <span class="hljs-variable">format</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Config failed, ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    }</li><li>    <span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li><li>    <span class="hljs-variable">format</span> = <span class="hljs-variable">nullptr</span>;</li><li>    </li><li>    <span class="hljs-comment">// 设置音频编码器处理回调</span></li><li>    <span class="hljs-title function_">OH_AudioCodec_RegisterCallback</span>(<span class="hljs-variable">encoder_</span>,</li><li>                                   {<span class="hljs-variable">AudioEncoder</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">AudioEncoder</span>::<span class="hljs-title class_">OnCodecFormatChange</span>,</li><li>                                    <span class="hljs-variable">AudioEncoder</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">AudioEncoder</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>},</li><li>                                   <span class="hljs-variable">codecUserData</span>);</li><li>    <span class="hljs-comment">// 准备编码器内部资源，必须在调用此接口之前调用配置接口</span></li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AudioCodec_Prepare</span>(<span class="hljs-variable">encoder_</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Prepare failed, ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioEncoder.cpp#L35-L66" target="_blank">AudioEncoder.cpp</a></div></div></div></div> <p></p> <p>创建视频编码器。</p> <p>同样从mime类型创建视频编码器实例。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L20-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> <span class="hljs-title class_">VideoEncoder</span>::<span class="hljs-title function_ invoke__">Create</span>(<span class="hljs-keyword">const</span> std::<span class="hljs-variable constant_">string</span> &amp;videoCodecMime) {</li><li>    encoder_ = <span class="hljs-title function_ invoke__">OH_VideoEncoder_CreateByMime</span>(videoCodecMime.<span class="hljs-title function_ invoke__">c_str</span>());</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L20-L22" target="_blank">VideoEncoder.cpp</a></div></div></div></div> <p>配置视频编码器。</p> <p>与音频编码器配置方法相同，将配置信息写入format，然后通过OH_VideoEncoder_Configure()接口进行编码器配置。接下来，使用OH_VideoEncoder_RegisterCallback()方法注册回调函数。这些回调函数用于监控编解码器操作错误、编解码器流变化、编解码器需要输入数据以及编解码器已生成输出数据。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L26-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">Config</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>, <span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*codecUserData</span>) {</li><li>    <span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li>    </li><li>    <span class="hljs-comment">// 配置相关参数</span></li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">videoWidth</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">videoHeight</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">frameRate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">pixelFormat</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">bitrateMode</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">bitrate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">hevcProfile</span>);</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">encoder_</span>, <span class="hljs-variable">format</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Config failed, ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    }</li><li>    <span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li><li>    <span class="hljs-variable">format</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// 根据视频编码器获取Surface</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_GetSurface</span>(<span class="hljs-variable">encoder_</span>, &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">window</span>);</li><li>
</li><li>    <span class="hljs-comment">// 设置视频编码器处理回调</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_RegisterCallback</span>(<span class="hljs-variable">encoder_</span>,</li><li>                                     {<span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnCodecFormatChange</span>,</li><li>                                      <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>},</li><li>                                     <span class="hljs-variable">codecUserData</span>);</li><li>    <span class="hljs-comment">// 准备编码器内部资源，必须在调用此接口之前调用配置接口</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_Prepare</span>(<span class="hljs-variable">encoder_</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L26-L57" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>初始化音频采集（音频录制）器。<p>首先，创建一个音频流构造器，然后设置其相关属性值，并设置输入音频流的回调。OnReadData回调用于读取音频数据。接着，通过OH_AudioStreamBuilder_GenerateCapturer()方法，根据音频流构造器创建音频流实例。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioCapturer.cpp#L43-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 初始化音频采集器</span></li><li><span class="hljs-variable">void</span> <span class="hljs-variable">AudioCapturer</span>::<span class="hljs-title class_">AudioCapturerInit</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>, <span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*audioEncContext</span>)</li><li>{</li><li>    <span class="hljs-title function_">AudioCapturerRelease</span>();</li><li>
</li><li>    <span class="hljs-comment">// 创建builder</span></li><li>    <span class="hljs-variable">OH_AudioStream_Type</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">AUDIOSTREAM_TYPE_CAPTURER</span>;</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_Create</span>(&amp;<span class="hljs-title class_">builder_</span>, <span class="hljs-keyword">type</span>);</li><li>    <span class="hljs-comment">// 设置参数和回调</span></li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetSamplingRate</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioSampleRate</span>);</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetChannelCount</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioChannelCount</span>);</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetSampleFormat</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">AUDIOSTREAM_SAMPLE_S16LE</span>);</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetLatencyMode</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">AUDIOSTREAM_LATENCY_MODE_NORMAL</span>);</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetEncodingType</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">AUDIOSTREAM_ENCODING_TYPE_RAW</span>);</li><li>    <span class="hljs-variable">OH_AudioCapturer_Callbacks</span> <span class="hljs-variable">callbacks</span>;</li><li>    <span class="hljs-variable">callbacks</span>.<span class="hljs-variable">OH_AudioCapturer_OnReadData</span> = <span class="hljs-variable">AudioCapturerOnReadData</span>;</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetCapturerCallback</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">callbacks</span>, <span class="hljs-variable">audioEncContext</span>);</li><li>    <span class="hljs-comment">// 创建 OH_AudioCapturer对象</span></li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_GenerateCapturer</span>(<span class="hljs-variable">builder_</span>, &amp;<span class="hljs-title class_">audioCapturer_</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/AudioCapturer.cpp#L43-L62" target="_blank">AudioCapturer.cpp</a></div></div></div></div> </li><li>初始化视频采集（视频录制）器。<p>类似于上述C/C+文件存储方法，首先创建实例化对象，接着配置相关回调函数及参数。随后，调用OH_AVScreenCapture_Init()方法初始化视频采集器。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L278-L363" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CAVScreenCaptureToStream::StartScreenCapture</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> outputFd, <span class="hljs-type">int32_t</span> videoWidth, <span class="hljs-type">int32_t</span> videoHeight)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    </li><li>    <span class="hljs-keyword">if</span> (g_avCapture != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">StopScreenCaptureRecording</span>(g_avCapture);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 创建实例化对象</span></li><li>    g_avCapture = <span class="hljs-built_in">OH_AVScreenCapture_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (g_avCapture == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"create screen capture failed"</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture after create sc"</span>);</li><li>
</li><li>    <span class="hljs-comment">// 设置回调</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetErrorCallback</span>(g_avCapture, OnErrorToStream, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetStateCallback</span>(g_avCapture, OnSurfaceStateChangeToStream, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetCanvasRotation</span>(g_avCapture, <span class="hljs-literal">true</span>);</li><li>
</li><li>    <span class="hljs-comment">// 初始化配置</span></li><li>    OH_AVScreenCaptureConfig config_;</li><li>    <span class="hljs-built_in">SetConfigToStream</span>(config_, videoWidth, videoHeight);</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVScreenCapture_Init</span>(g_avCapture, config_);</li><li>    <span class="hljs-keyword">if</span> (result != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture OH_AVScreenCapture_Init failed %{public}d"</span>, result);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture OH_AVScreenCapture_Init %{public}d"</span>, result);</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L278-L363" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li><li>通过OH_AVScreenCapture_StartScreenCaptureWithSurface()接口开启屏幕录制。<p>这里使用Surface模式启动录屏。通过OH_AVScreenCapture_StartScreenCaptureWithSurface()方法指定Surface并启动录屏。同时启动封装器。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-wasm" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L311-L316" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">result</span> = OH_AVScreenCapture_StartScreenCaptureWithSurface<span class="hljs-punctuation">(</span>g_avCapture, sampleInfo_.window<span class="hljs-punctuation">)</span>;</li><li>OH_LOG_INFO<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"OH_VideoEncoder_Start Started 2 %{public}d"</span>, <span class="hljs-keyword">result</span><span class="hljs-punctuation">)</span>;</li><li><span class="hljs-keyword">if</span> <span class="hljs-punctuation">(</span><span class="hljs-keyword">result</span> != AV_SCREEN_CAPTURE_ERR_OK<span class="hljs-punctuation">)</span> {</li><li>    OH_LOG_INFO<span class="hljs-punctuation">(</span>LOG_APP, <span class="hljs-string">"ScreenCapture Started failed %{public}d"</span>, <span class="hljs-keyword">result</span><span class="hljs-punctuation">)</span>;</li><li>    OH_AVScreenCapture_Release<span class="hljs-punctuation">(</span>g_avCapture<span class="hljs-punctuation">)</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L311-L316" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li><li>拆分音视频编码器以及封装器子线程。<p>启动音视频编码器和封装器，并将音视频编码器及封装器的数据处理子线程分离以进行数据处理。详细处理逻辑请参见示例代码。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L321-L360" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 开启封装器</span></li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li><span class="hljs-comment">// 开启视频编码器</span></li><li><span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// 启动视频输出线程</span></li><li><span class="hljs-variable">encOutputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">EncOutputThread</span>, <span class="hljs-keyword">this</span>);</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">encOutputThread_</span> == <span class="hljs-variable">nullptr</span>) {</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncContext_</span>) {</li><li>    <span class="hljs-comment">// 开启音频采集器</span></li><li>    <span class="hljs-variable">audioCapturer_</span>-&gt;<span class="hljs-title class_">AudioCapturerStart</span>();</li><li>
</li><li>    <span class="hljs-comment">// 开启音频编码器</span></li><li>    <span class="hljs-variable">audioEncoder_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>        </li><li>    <span class="hljs-comment">// ...</span></li><li>        </li><li>    <span class="hljs-comment">// 启动音频输入输出线程</span></li><li>    <span class="hljs-variable">audioEncInputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">AudioEncInputThread</span>, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-variable">audioEncOutputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">AudioEncOutputThread</span>, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncInputThread_</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">audioEncOutputThread_</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">StartRelease</span>();</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// 清空播放缓存队列</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncContext_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">ClearCache</span>();</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L321-L360" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li><li>停止屏幕录制并释放相应资源。<p>首先，等待数据写入完成，然后启动子线程以释放音视频编码器及封装器的相关资源。在资源完全释放后，调用OH_AVScreenCapture_StopScreenRecording()方法停止屏幕录制，最后释放ScreenCapture实例。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L370-L407" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 停止屏幕录制</span></li><li><span class="hljs-variable">void</span> <span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">StopScreenCapture</span>() {</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">NotifyEndOfStream</span>();</li><li>
</li><li>    <span class="hljs-comment">// 等待数据写入</span></li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>    <span class="hljs-variable">doneCond_</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-variable">lock</span>);</li><li>    <span class="hljs-comment">// 等待资源释放</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">releaseThread_</span> &amp;&amp; <span class="hljs-variable">releaseThread_</span>-&gt;<span class="hljs-title class_">joinable</span>()) {</li><li>        <span class="hljs-variable">releaseThread_</span>-&gt;<span class="hljs-title class_">join</span>();</li><li>        <span class="hljs-variable">releaseThread_</span>.<span class="hljs-title function_">reset</span>();</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// 停止录屏</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVScreenCapture_StopScreenCapture</span>(<span class="hljs-variable">g_avCapture</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_SCREEN_CAPTURE_ERR_BASE</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"StopScreenCapture OH_AVScreenCapture_StopScreenCapture Result: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"StopScreenCapture OH_AVScreenCapture_StopScreenCapture"</span>);</li><li>        }</li><li>        <span class="hljs-comment">// 释放实例对象</span></li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_AVScreenCapture_Release</span>(<span class="hljs-variable">g_avCapture</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_SCREEN_CAPTURE_ERR_BASE</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"StopScreenCapture OH_AVScreenCapture_Release: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"OH_AVScreenCapture_Release success"</span>);</li><li>        }</li><li>        </li><li>        <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L370-L407" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> <p>音视频编码器及封装器资源释放。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L445-L507" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// 释放线程</span></li><li><span class="hljs-variable">void</span> <span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">Release</span>() {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>    <span class="hljs-variable">isStarted_</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-comment">// 视频输出线程</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">encOutputThread_</span> &amp;&amp; <span class="hljs-variable">encOutputThread_</span>-&gt;<span class="hljs-title class_">joinable</span>()) {</li><li>        <span class="hljs-variable">encOutputThread_</span>-&gt;<span class="hljs-title class_">join</span>();</li><li>        <span class="hljs-variable">encOutputThread_</span>.<span class="hljs-title function_">reset</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 音频输入线程</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncInputThread_</span> &amp;&amp; <span class="hljs-variable">audioEncInputThread_</span>-&gt;<span class="hljs-title class_">joinable</span>()) {</li><li>        <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">inputCond</span>.<span class="hljs-title class_">notify_all</span>();</li><li>        <span class="hljs-variable">audioEncInputThread_</span>-&gt;<span class="hljs-title class_">join</span>();</li><li>        <span class="hljs-variable">audioEncInputThread_</span>.<span class="hljs-title function_">reset</span>();</li><li>    }</li><li>    <span class="hljs-comment">// 音频输出线程</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncOutputThread_</span> &amp;&amp; <span class="hljs-variable">audioEncOutputThread_</span>-&gt;<span class="hljs-title class_">joinable</span>()) {</li><li>        <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">notify_all</span>();</li><li>        <span class="hljs-variable">audioEncOutputThread_</span>-&gt;<span class="hljs-title class_">join</span>();</li><li>        <span class="hljs-variable">audioEncOutputThread_</span>.<span class="hljs-title function_">reset</span>();</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 释放封装器</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">muxer_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">Release</span>();</li><li>        <span class="hljs-variable">muxer_</span>.<span class="hljs-title function_">reset</span>();</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Muxer release successful"</span>);</li><li>    }</li><li>    <span class="hljs-comment">// 释放编码器</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoEncoder_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">Stop</span>();</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">window</span> != <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-title function_">OH_NativeWindow_DestroyNativeWindow</span>(<span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">window</span>);</li><li>            <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">nullptr</span>;</li><li>        }</li><li>        <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">Release</span>();</li><li>        <span class="hljs-variable">videoEncoder_</span>.<span class="hljs-title function_">reset</span>();</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Video encoder release successful"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncoder_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">audioEncoder_</span>-&gt;<span class="hljs-title class_">Stop</span>();</li><li>        <span class="hljs-variable">audioEncoder_</span>-&gt;<span class="hljs-title class_">Release</span>();</li><li>        <span class="hljs-variable">audioEncoder_</span>.<span class="hljs-title function_">reset</span>();</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Audio encoder release successful"</span>);</li><li>    }</li><li>    </li><li>    <span class="hljs-comment">// 释放资源</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioCapturer_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">audioCapturer_</span>-&gt;<span class="hljs-title class_">AudioCapturerRelease</span>();</li><li>        <span class="hljs-variable">audioCapturer_</span>.<span class="hljs-title function_">reset</span>();</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Audio Capturer release successful"</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncContext_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">audioEncContext_</span>;</li><li>        <span class="hljs-variable">audioEncContext_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoEncContext_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-variable">delete</span> <span class="hljs-variable">videoEncContext_</span>;</li><li>        <span class="hljs-variable">videoEncContext_</span> = <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">doneCond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Release successful"</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L445-L507" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> <p>最后在ArkTS侧关闭文件。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToStream.ets#L72-L77" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">releaseFD</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>?.<span class="hljs-property">fd</span> != <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>.<span class="hljs-property">fd</span>?.<span class="hljs-title function_">valueOf</span>() &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// 关闭文件</span></li><li>    fs.<span class="hljs-title function_">close</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>.<span class="hljs-property">fd</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/ets/pages/CAVScreenCaptureToStream.ets#L72-L77" target="_blank">CAVScreenCaptureToStream.ets</a></div></div></div></div> </li></ol> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>AVScreenCapture在屏幕录制过程中无法动态调整参数。 若要实现动态调整参数，可以通过配置编码器来完成。</p> </div></div></div> <div class="tiledSection"><h2 id="section17543152115911">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section17543152115911" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section88234491599" class="firsth2">如何配置音频内录和音频外录<i class="anchor-icon anchor-icon-link" anchorid="section88234491599" tips="复制节点链接"></i></h3><p>内录和外录是指在录音设备中进行录音的两种不同方式。内录是使用设备内部的音频输入接口来录制声音，而外录则是通过外部麦克风或其他音频源连接到设备来录制声音。</p> <p>配置内录外录的代码如下：</p> <p>其中micCapInfo对应外录（麦克风）配置，innerCapInfo对应内录配置。</p> <div class="screenLinkPre"><div _ngcontent-sbs-c106="" class="highlight-div"><div _ngcontent-sbs-c106="" class="highlight-div-header"><div _ngcontent-sbs-c106="" class="highlight-div-header-left"><div _ngcontent-sbs-c106="" class="handle-button expand-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-sbs-c106="" class="highlight-div-header-right"><div _ngcontent-sbs-c106="" class="handle-button ai-button"></div><div _ngcontent-sbs-c106="" class="handle-button line-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-sbs-c106="" class="handle-button theme-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-sbs-c106="" class="handle-button copy-button"><div _ngcontent-sbs-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-sbs-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-java" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L143-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">void</span> CAVScreenCaptureToFile::SetConfigAsFile(OH_AVScreenCaptureConfig &amp;config, int32_t videoWidth,</li><li>                                             int32_t videoHeight) {</li><li>    <span class="hljs-comment">// 音频配置</span></li><li>    <span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">micCapInfo</span> <span class="hljs-operator">=</span> {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_SOURCE_DEFAULT};</li><li>    <span class="hljs-type">OH_AudioCaptureInfo</span> <span class="hljs-variable">innerCapInfo</span> <span class="hljs-operator">=</span> {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_ALL_PLAYBACK};</li><li>    <span class="hljs-type">OH_AudioEncInfo</span> <span class="hljs-variable">audioEncInfo</span> <span class="hljs-operator">=</span> {.audioBitrate = <span class="hljs-number">96000</span>, .audioCodecformat = OH_AudioCodecFormat::OH_AAC_LC};</li><li>    <span class="hljs-type">OH_AudioInfo</span> <span class="hljs-variable">audioInfo</span> <span class="hljs-operator">=</span> {.micCapInfo = micCapInfo, .innerCapInfo = innerCapInfo, .audioEncInfo = audioEncInfo};</li><li>
</li><li>    <span class="hljs-comment">// 视频配置</span></li><li>    <span class="hljs-type">OH_VideoCaptureInfo</span> <span class="hljs-variable">videoCapInfo</span> <span class="hljs-operator">=</span> {</li><li>        .videoFrameWidth = videoWidth, .videoFrameHeight = videoHeight, .videoSource = OH_VIDEO_SOURCE_SURFACE_RGBA};</li><li>    <span class="hljs-type">OH_VideoEncInfo</span> <span class="hljs-variable">videoEncInfo</span> <span class="hljs-operator">=</span> {</li><li>        .videoCodec = OH_VideoCodecFormat::OH_H264, .videoBitrate = <span class="hljs-number">10000000</span>, .videoFrameRate = <span class="hljs-number">30</span>};</li><li>    <span class="hljs-type">OH_VideoInfo</span> <span class="hljs-variable">videoInfo</span> <span class="hljs-operator">=</span> {.videoCapInfo = videoCapInfo, .videoEncInfo = videoEncInfo};</li><li>
</li><li>    config = {</li><li>        .captureMode = OH_CAPTURE_HOME_SCREEN,</li><li>        .dataType = OH_ORIGINAL_STREAM,</li><li>        .audioInfo = audioInfo,</li><li>        .videoInfo = videoInfo,</li><li>        .recorderInfo = {},</li><li>    };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/avscreen-capture-screen-record-master/entry/src/main/cpp/CAVScreenCaptureToFile/CAVScreenCaptureToFile.cpp#L143-L165" target="_blank">CAVScreenCaptureToFile.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section78642401508">如何减少录制文件的大小<i class="anchor-icon anchor-icon-link" anchorid="section78642401508" tips="复制节点链接"></i></h3></div> <p>可以通过修改视频压缩标准或者降低屏幕录制的帧率来实现。</p> <p>具体方法如下：</p> <ul><li>使用H265（HEVC）替代H264（AVC）。H265（HEVC）的压缩效率更高。</li><li>通过调用OH_AVScreenCapture_SetMaxVideoFrameRate()将最高帧率设置为30，以降低录制的帧率。</li></ul> <div class="tiledSection"><h3 id="section057411299019">如何单独录制视频或者音频<i class="anchor-icon anchor-icon-link" anchorid="section057411299019" tips="复制节点链接"></i></h3><p>屏幕录制时，涉及的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture-oh-avscreencaptureconfig" target="_blank">OH_AVScreenCaptureConfig</a>相关配置项包括录制模式（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avscreen-capture-base-h#oh_capturemode" target="_blank">OH_CaptureMode</a> ）、数据格式（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avscreen-capture-base-h#oh_datatype" target="_blank">OH_DataType</a>）、音频参数（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture-oh-audioinfo" target="_blank">OH_AudioInfo</a>）、视频参数（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture-oh-videoinfo" target="_blank">OH_VideoInfo</a>）以及录制文件参数（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-avscreencapture-oh-recorderinfo" target="_blank">OH_RecorderInfo</a>）。</p> <p>其中包含了音频录制参数与视频录制参数。如果单录音频，只配OH_AudioInfo即可，如果单录视频，只配OH_VideoInfo即可。</p> </div> <div class="tiledSection"><h2 id="section622943814174">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section622943814174" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record" target="_blank">基于AVScreenCapture实现屏幕录制</a></li></ul> </div> </div> <div></div></div>