<h1 _ngcontent-kos-c119="" class="doc-title ng-star-inserted" title="基于Canvas实现录像回放时间轴"> 基于Canvas实现录像回放时间轴 </h1>

<div _ngcontent-kos-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section787482181317"><strong>概述</strong><i class="anchor-icon anchor-icon-link" anchorid="section787482181317" tips="复制节点链接"></i></h2><p>在安防监控、车载回放等场景中，录像回放是核心功能。用户通过滑动时间轴，查看不同时间节点的历史视频。本文基于Canvas绘图能力和视频组件，提供功能完备的录像回放时间轴解决方案，封装了<a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets" target="_blank">核心组件TimeBarView</a>，助力开发者快速实现时间轴功能。该组件集成了时间轴绘制、单指滑动浏览、双指缩放切换时间粒度等功能。</p> <p></p> <p>本文主要介绍如何实现TimeBarView时间轴组件，并结合“滑动时间轴控制视频播放”的核心场景，阐述TimeBarView组件的使用方法。</p> <p></p> <p>TimeBarView时间轴组件提供以下核心功能：</p> <ul><li>支持自定义时间轴样式，可配置刻度线、中间指示线、视频区域的外观（如颜色、尺寸、位置）。</li><li>支持双指缩放以调整时间刻度精度，单指滑动以定位至目标时间点。</li><li>支持设置时间轴当前进度。</li><li>支持基于时间轴组件的二次自定义绘制。</li></ul> </div> <div class="tiledSection"><h2 id="section101251697148"><strong>实现原理</strong><i class="anchor-icon anchor-icon-link" anchorid="section101251697148" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1950932261518" class="firsth2">关键技术<i class="anchor-icon anchor-icon-link" anchorid="section1950932261518" tips="复制节点链接"></i></h3><p>TimeBarView组件采用分层绘制，依次为刻度线、中间线、视频区域及顶层自定义绘制区域。通过滑动和缩放手势事件，实时更新状态并触发时间轴重绘。详细实现参考本章<a href="/consumer/cn/doc/best-practices/bpta-implement-timeline-based-on-canvas#section42461138131619">开发流程</a>。</p> <p>刻度线绘制主要将时间戳转换为Canvas像素坐标。例如，开发者自定义刻度间隔的宽度为intervalWidth（如intervalWidth = 10vp），相同长度的时间间隔对应10分钟，实现“固定时间对应固定像素”的精准映射，确保任意时间戳均能通过公式计算出唯一的画布坐标。</p> <div class="fignone"><span class="figcap"><b>图1 </b>时间-像素映射示意图</span><br><span><img height="322.7112" originheight="313" originwidth="516" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.74006688944932043801827466062171:50001231000000:2800:927EE9D7163CD2635528F6A79C36A2131C6ECF2F6B444F78BE8DC30FB059DE8F.png" title="点击放大" width="532"></span></div> </div> <div class="tiledSection"><h3 id="section42461138131619">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section42461138131619" tips="复制节点链接"></i></h3><ol><li>绘制时间轴<ol><li>时间刻度绘制<p><strong>计算基本参数</strong></p> <ul><li>scaleNum属性：表示当前画布上需绘制的时间间隔数量。viewWidth属性表示时间轴画布的总宽度，intervalWidth属性表示每个时间格子在画布上占用的宽度（intervalWidth值为自定义，例如组件内为10vp/格）。加2是为了预留左右两边的额外格子，避免滚动或缩放时边缘出现空白。</li><li>middleLineDuration属性：计算画布左半部分对应的实际时间。</li><li>leftTime：表示画布最左侧边缘对应的实际时间戳（毫秒）。</li></ul> <p>时间轴根据画布大小、缩放比例动态调整显示的时间范围，同时始终以中心点为视觉锚点，确保交互的连贯性。</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L456-L464" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Number of small divisions visible</span></li><li><span class="hljs-keyword">const</span> scaleNum = Math.floor(viewWidth / <span class="hljs-keyword">this</span>.intervalWidth) + <span class="hljs-number">2</span>;</li><li>
</li><li><span class="hljs-comment">// Duration represented from left edge to the middle line</span></li><li><span class="hljs-comment">// keep sub-minute precision to avoid truncation that caused a visual gap near the end when zoomed in.</span></li><li><span class="hljs-keyword">const</span> middleLineDuration = (viewWidth / <span class="hljs-number">2</span>) * (TimeMsUnit.TEN_MINUTE / <span class="hljs-keyword">this</span>.intervalWidth);</li><li>
</li><li><span class="hljs-comment">// Time at the far left edge</span></li><li><span class="hljs-keyword">this</span>.leftTime = <span class="hljs-keyword">this</span>._currentTime - middleLineDuration;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L456-L464" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> <p><strong>绘制刻度线</strong></p> <p>以10分钟为最小单位生成刻度，在小时模式（MODE_HOUR）下，每60分钟绘制一次大刻度及时间文本；在分钟模式（MODE_MINUTE）下，将10分钟划分为10个细分刻度，因此循环10次绘制刻度线。drawTickLine()方法用于绘制大、小刻度，drawTimeText()方法用于绘制大刻度对应的时间文本。</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L468-L497" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Find the first tick (aligned to 10 minutes)</span></li><li>let minuteNum = Math.floor(<span class="hljs-keyword">this</span>.leftTime / TimeMsUnit.TEN_MINUTE);</li><li>let xPosition =</li><li>  (minuteNum * TimeMsUnit.TEN_MINUTE - <span class="hljs-keyword">this</span>.leftTime) * (<span class="hljs-keyword">this</span>.intervalWidth / TimeMsUnit.TEN_MINUTE);</li><li>
</li><li><span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; scaleNum; i++) {</li><li>  <span class="hljs-keyword">const</span> currentX = xPosition + i * <span class="hljs-keyword">this</span>.intervalWidth;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.divisorMode == ScaleMode.MODE_HOUR) {</li><li>    <span class="hljs-keyword">const</span> isMajorTick = minuteNum % <span class="hljs-number">6</span> === <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">const</span> tickLength =</li><li>      isMajorTick ? <span class="hljs-keyword">this</span>.timeScaleOption.scaleLineHeight * <span class="hljs-number">2</span> : <span class="hljs-keyword">this</span>.timeScaleOption.scaleLineHeight;</li><li>    <span class="hljs-keyword">const</span> tickRange = <span class="hljs-keyword">this</span>.drawTickLine(currentX, tickLength);</li><li>    <span class="hljs-keyword">if</span> (isMajorTick) {</li><li>      <span class="hljs-keyword">this</span>.drawTimeText(currentX, minuteNum, tickRange);</li><li>    }</li><li>
</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.divisorMode === ScaleMode.MODE_MINUTE) {</li><li>    <span class="hljs-keyword">for</span> (let j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span>; j++) {</li><li>      <span class="hljs-keyword">const</span> positionX = j === <span class="hljs-number">0</span> ? currentX : currentX + j * <span class="hljs-keyword">this</span>.intervalWidth * <span class="hljs-number">0.1</span>;</li><li>      <span class="hljs-keyword">const</span> isMajorTick = j === <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">const</span> tickLength =</li><li>        isMajorTick ? <span class="hljs-keyword">this</span>.timeScaleOption.scaleLineHeight * <span class="hljs-number">2</span> : <span class="hljs-keyword">this</span>.timeScaleOption.scaleLineHeight;</li><li>      <span class="hljs-keyword">const</span> tickRange = <span class="hljs-keyword">this</span>.drawTickLine(positionX, tickLength);</li><li>      <span class="hljs-keyword">if</span> (isMajorTick) {</li><li>        <span class="hljs-keyword">this</span>.drawTimeText(positionX, minuteNum, tickRange);</li><li>      }</li><li>    }</li><li>  }</li><li>  minuteNum++;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L468-L497" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> </li><li>中间指示线绘制<p>中间线是时间轴上的当前时间标记，固定在画布中央，用于标识当前选中或播放的时间点。</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L431-L440" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/** Draw middle indicator line at canvas center. */</span></li><li><span class="hljs-keyword">private</span> drawMiddleLine() {</li><li>  <span class="hljs-keyword">this</span>.context.beginPath();</li><li>  <span class="hljs-keyword">this</span>.context.moveTo(<span class="hljs-keyword">this</span>.context.width / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);</li><li>  <span class="hljs-keyword">this</span>.context.lineTo(<span class="hljs-keyword">this</span>.context.width / <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.middleIndicatorOption.length);</li><li>  <span class="hljs-keyword">this</span>.context.strokeStyle = <span class="hljs-keyword">this</span>.middleIndicatorOption.fillColor;</li><li>  <span class="hljs-keyword">this</span>.context.lineWidth = <span class="hljs-number">2</span>;</li><li>  <span class="hljs-keyword">this</span>.context.stroke();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L431-L440" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> </li><li>视频区域绘制<p><strong>获取图片pixelMap对象</strong></p> <p>视频区域用于显示视频片段的时间分布（如录制片段、有效视频区间），采用离屏预渲染，避免滑动缩放时重复计算绘制。</p> <ul><li>预渲染时机：当视频片段数据timeRange变化时（通过@Watch('onTimeRangeChange')监听），执行预渲染。</li><li>预渲染规则：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d" target="_blank">OffscreenCanvasRenderingContext2D</a>构造离屏Canvas画布对象offPaint，按1vp等于1分钟的比例绘制所有视频片段，调用offPaint.getPixelMap()方法生成videoPixelMap像素图。</li></ul> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L304-L335" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Offscreen canvas (height uses current view height option)</span></li><li><span class="hljs-keyword">const</span> offSettings: RenderingContextSettings = new RenderingContextSettings(<span class="hljs-literal">false</span>);</li><li><span class="hljs-keyword">const</span> offCanvas: OffscreenCanvas = new OffscreenCanvas(videoAreaWidth, <span class="hljs-keyword">this</span>.timeBarOption.height);</li><li><span class="hljs-keyword">const</span> offPaint = offCanvas.getContext(<span class="hljs-string">'2d'</span>, offSettings);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Draw each segment; clamp and floor pixel coordinates to avoid overlap</span></li><li>segArr.forEach((recordSegment) =&gt; {</li><li>  <span class="hljs-keyword">const</span> beginTime = parseTimeString(recordSegment.beginTime).getTime();</li><li>  <span class="hljs-keyword">const</span> endTime = parseTimeString(recordSegment.endTime).getTime();</li><li>
</li><li>  let leftX = (beginTime - <span class="hljs-keyword">this</span>._minTime) / TimeMsUnit.ONE_MINUTE;</li><li>  let rightX = (endTime - <span class="hljs-keyword">this</span>._minTime) / TimeMsUnit.ONE_MINUTE;</li><li>
</li><li>  <span class="hljs-comment">// Clamp</span></li><li>  leftX = Math.max(<span class="hljs-number">0</span>, Math.min(videoAreaWidth - <span class="hljs-number">1</span>, leftX));</li><li>  rightX = Math.max(leftX + <span class="hljs-number">1</span>, Math.min(videoAreaWidth, rightX));</li><li>
</li><li>  <span class="hljs-keyword">const</span> width = Math.max(<span class="hljs-number">1</span>, rightX - leftX);</li><li>  <span class="hljs-keyword">const</span> videoAreaHeight = <span class="hljs-keyword">this</span>.videoAreaOption.topOffset + <span class="hljs-keyword">this</span>.videoAreaOption.height &gt; <span class="hljs-keyword">this</span>.timeBarOption.height</li><li>    ? <span class="hljs-keyword">this</span>.timeBarOption.height - <span class="hljs-keyword">this</span>.videoAreaOption.topOffset : <span class="hljs-keyword">this</span>.videoAreaOption.height;</li><li>  offPaint.fillRect(leftX, <span class="hljs-keyword">this</span>.videoAreaOption.topOffset, width, videoAreaHeight);</li><li>});</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = offPaint.getPixelMap(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, videoAreaWidth, <span class="hljs-keyword">this</span>.timeBarOption.height);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L304-L335" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> <p><strong>实时绘制</strong></p> <p>缩放时，通过矩阵变换（缩放）将预渲染图适配当前画布比例，避免重复绘制。</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L355-L369" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Disable smoothing to keep crisp edges on narrow color bars</span></li><li><span class="hljs-keyword">this</span>.context.imageSmoothingEnabled = <span class="hljs-literal">false</span>;</li><li>
</li><li><span class="hljs-comment">// Offscreen bitmap uses 1px/minute base.</span></li><li><span class="hljs-comment">// Compute the left bitmap x that corresponds to current leftTime.</span></li><li><span class="hljs-keyword">const</span> bitmapLeftBase = (<span class="hljs-keyword">this</span>._minTime - <span class="hljs-keyword">this</span>.leftTime) / TimeMsUnit.ONE_MINUTE;</li><li>
</li><li><span class="hljs-comment">// Front-scale: intervalWidth=10px =&gt; 1px/minute; so scale factor is intervalWidth/10.</span></li><li><span class="hljs-keyword">const</span> videoZoomSize = <span class="hljs-keyword">this</span>.intervalWidth / <span class="hljs-number">10</span>;</li><li>
</li><li><span class="hljs-comment">// Draw with transform; do not clear the canvas here (we already cleared in drawScales)</span></li><li><span class="hljs-keyword">this</span>.context.save();</li><li><span class="hljs-keyword">this</span>.context.scale(videoZoomSize, <span class="hljs-number">1</span>);</li><li><span class="hljs-keyword">this</span>.context.drawImage(<span class="hljs-keyword">this</span>.videoPixelMap, bitmapLeftBase, <span class="hljs-number">0</span>);</li><li><span class="hljs-keyword">this</span>.context.restore();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L355-L369" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> </li></ol> </li><li>滑动时间轴<p>滑动功能允许用户通过单指拖拽浏览时间轴，核心逻辑如下：</p> <ul><li>手势监听：通过PanGesture()回调监听手指按下、移动、抬起事件。</li><li>灵敏度控制：当累计位移（_panResidual）超过灵敏度阈值（MOVE_SENSITIVE）时，将其作为有效位移（effectiveDelta ）处理，避免手指轻微抖动触发频繁更新。</li><li>边界限制：通过clampToBounds()方法限制滑动范围，防止滑动至无数据区域。</li><li>回调通知：滑动过程中实时触发onMoveScaleCallback()回调，通知外部当前选中时间。</li><li>帧同步合并渲染：将一帧内的多次重绘请求合并为一次，确保每次重绘均在新帧开始时执行。重绘的scheduleRedraw()方法基于DisplaySync实现帧同步刷新。</li></ul> <p>将有效位移（effectiveDelta）通过刻度密度（intervalWidth）属性转换为时间偏移量，更新时间轴当前时间（_currentTime属性），同步至TimeBarModel组件控制器，供外部获取。调用scheduleRedraw()方法，延迟绘制至下一帧，减少频繁绘制引起的性能消耗，确保滑动过程的视觉流畅性。</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L666-L687" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Capture raw delta for accumulation.</span></li><li><span class="hljs-keyword">const</span> rawDelta = event.offsetX - <span class="hljs-keyword">this</span>._touchDownPosition;</li><li><span class="hljs-keyword">this</span>._touchDownPosition = event.offsetX;</li><li>
</li><li><span class="hljs-comment">// Accumulate sub-pixel movement for smoother tracking.</span></li><li><span class="hljs-keyword">this</span>._panResidual += rawDelta;</li><li><span class="hljs-keyword">if</span> (Math.abs(<span class="hljs-keyword">this</span>._panResidual) &lt; <span class="hljs-keyword">this</span>.MOVE_SENSITIVE) {</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">const</span> effectiveDelta = <span class="hljs-keyword">this</span>._panResidual;</li><li><span class="hljs-keyword">this</span>._panResidual = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// Update middle-line time, then clamp into [min, max]</span></li><li><span class="hljs-keyword">const</span> nextTime = <span class="hljs-keyword">this</span>._currentTime - (effectiveDelta * (TimeMsUnit.TEN_MINUTE / <span class="hljs-keyword">this</span>.intervalWidth));</li><li><span class="hljs-keyword">this</span>._currentTime = <span class="hljs-keyword">this</span>.clampToBounds(nextTime);</li><li>
</li><li><span class="hljs-keyword">this</span>.model.currentTime = <span class="hljs-keyword">this</span>._currentTime;</li><li>
</li><li><span class="hljs-comment">// Redraw and notify</span></li><li><span class="hljs-keyword">this</span>.scheduleRedraw(); <span class="hljs-comment">// Defer redraw to next frame for smoother visuals.</span></li><li><span class="hljs-keyword">this</span>._onTimeBarMoveListener?.onMoveScaleCallback(<span class="hljs-keyword">this</span>._currentTime, PlayStatus.PLAYING);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L666-L687" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> </li><li>缩放时间轴<p>缩放功能允许通过双指捏合/张开切换时间粒度。核心逻辑如下：</p> <ul><li>手势监听：通过PinchGesture()回调监听双指缩放事件。</li><li>缩放因子过滤：设置scaleChange &gt; 0.1，避免微小缩放动作触发频繁更新。</li><li>intervalWidth调整：缩放时修改intervalWidth属性（10分钟对应的像素宽度），放大时增加，缩小时减少。</li><li>模式切换：根据intervalWidth阈值切换显示模式（小时/分钟）。<ul><li>intervalWidth &lt; 60：小时模式（10分钟/刻度，6个刻度 = 1小时）。</li><li>60≤intervalWidth &lt; 180：分钟模式（1分钟/细分刻度）。</li><li>intervalWidth ≥ 180：最大缩放限制，锁定分钟模式。</li></ul> </li><li>边界限制：设置最小（10vp）和最大（180vp）缩放阈值，避免过度缩放。</li></ul> <div class="fignone"><span class="figcap"><b>图2 </b>缩放时间轴示意图</span><br><span><img height="412.96500000000003" originheight="528" originwidth="669" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.80203188088892817615404233435059:50001231000000:2800:15027BDA940A57B72E05D04A04BCF6C4C2F31293991EBC2044E611A62B82221A.png" title="点击放大" width="532"></span></div> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L717-L735" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Update per-division width</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.zoomSize &gt; <span class="hljs-number">1</span>) {</li><li>  <span class="hljs-keyword">this</span>.intervalWidth += <span class="hljs-number">10</span>;</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-keyword">this</span>.intervalWidth -= <span class="hljs-number">10</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Switch modes and enforce bounds</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.intervalWidth &lt; <span class="hljs-number">60</span>) {</li><li>  <span class="hljs-keyword">this</span>.divisorMode = ScaleMode.MODE_HOUR;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.intervalWidth &lt; <span class="hljs-number">10</span>) {</li><li>    <span class="hljs-keyword">this</span>.intervalWidth = <span class="hljs-number">10</span>;</li><li>  }</li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.intervalWidth &lt; <span class="hljs-number">180</span>) {</li><li>  <span class="hljs-keyword">this</span>.divisorMode = ScaleMode.MODE_MINUTE;</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-keyword">this</span>.divisorMode = ScaleMode.MODE_MINUTE;</li><li>  <span class="hljs-keyword">this</span>.intervalWidth = <span class="hljs-number">180</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/TimeBarView.ets#L717-L735" target="_blank">TimeBarView.ets</a></div></div></div></div> <p></p> </li><li>数据驱动交互<p>为实现时间轴组件与外部（如视频控制器）的数据联动，构建了TimeBarModel类。TimeBarModel封装了时间轴的两个核心数据：timeRange（视频片段集合）和currentTime（当前时间戳）。</p> <ul><li>timeRange：当外部传入录像片段时，自动对timeRange排序并计算有效时间边界（minTime/maxTime），确保时间轴仅显示有录像的时段。<div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L50-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">set</span> timeRange(segments: RecordSegment[]) {</li><li>  <span class="hljs-keyword">if</span> (!segments || segments.length === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">this</span>._timeRange = [];</li><li>    <span class="hljs-keyword">this</span>.updateTimeBounds();</li><li>    <span class="hljs-keyword">this</span>.notifyDataChange(<span class="hljs-string">'timeRange'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">const</span> segArr: RecordSegment[] = [...segments];</li><li>
</li><li>  segArr.sort((a, b) =&gt; {</li><li>    <span class="hljs-keyword">const</span> ta = parseTimeString(a.beginTime).getTime();</li><li>    <span class="hljs-keyword">const</span> tb = parseTimeString(b.beginTime).getTime();</li><li>    <span class="hljs-keyword">return</span> ta - tb;</li><li>  });</li><li>
</li><li>  <span class="hljs-keyword">this</span>._timeRange = [...segArr];</li><li>
</li><li>  <span class="hljs-comment">// Update time bounds (min/max time)</span></li><li>  <span class="hljs-keyword">this</span>.updateTimeBounds();</li><li>  <span class="hljs-comment">// Ensure current time stays within valid bounds</span></li><li>  <span class="hljs-keyword">this</span>.currentTime = <span class="hljs-keyword">this</span>.clampToBounds(<span class="hljs-keyword">this</span>._currentTime);</li><li>  <span class="hljs-comment">// Notify external listeners of the data change</span></li><li>  <span class="hljs-keyword">this</span>.notifyDataChange(<span class="hljs-string">'timeRange'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L50-L75" target="_blank">TimeBarModel.ets</a></div></div></div></div> <p></p> </li><li>currentTime：通过getter和setter机制实现双向同步，既接收外部视频播放进s度的更新，也在时间轴滑动时将最新时间输出给外部。<div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L91-L104" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">set</span> currentTime(time: number) {</li><li>  <span class="hljs-keyword">if</span> (!Number.isFinite(time) || time &lt;= <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  } <span class="hljs-comment">// ignore invalid time values</span></li><li>
</li><li>  <span class="hljs-keyword">const</span> clampedTime = <span class="hljs-keyword">this</span>.clampToBounds(time);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._currentTime === clampedTime) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  } <span class="hljs-comment">// do not trigger update if time hasn't changed</span></li><li>
</li><li>  <span class="hljs-keyword">this</span>._currentTime = clampedTime;</li><li>  <span class="hljs-keyword">this</span>.notifyDataChange(<span class="hljs-string">'currentTime'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L91-L104" target="_blank">TimeBarModel.ets</a></div></div></div></div> <p></p> </li><li>数据变更通知：通过onDataChange()回调，监听timeRange和currentTime的变化，简化了开发者调用。<div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L163-L166" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">notifyDataChange</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-string">'timeRange'</span> | <span class="hljs-string">'currentTime'</span></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_onDataChange</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_onDataChange</span>(<span class="hljs-keyword">type</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/time_bar/src/main/ets/components/viewModel/TimeBarModel.ets#L163-L166" target="_blank">TimeBarModel.ets</a></div></div></div></div> </li></ul> </li></ol> </div> <div class="tiledSection"><h2 id="section7761652162020">时间轴控制视频播放场景<i class="anchor-icon anchor-icon-link" anchorid="section7761652162020" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section153671518122110" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section153671518122110" tips="复制节点链接"></i></h3><p>TimeBarView时间轴与视频播放联动，滑动时间轴可快速定位至目标录像片段。</p> <p>滑动停止时，若时间轴中线对应的时间点在录像片段有效时间内，视频立即跳转并继续播放。若处于两端录像间的空白区域，系统自动跳转至最近的录像起始时间点，避免无画面时段，提高效率。时间轴滑动存在硬性边界限制，用户试图将时间轴向右滑动至所有录像片段的最末端（即最新一段录像的结束时间）时，将无法继续拖动，防止超出录像数据范围导致播放异常。</p> <div class="fignone"><span class="figcap"><b>图3 </b>效果图</span><br><span><img height="550.3407000000001" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163053.92006912716060007746485422755829:50001231000000:2800:C5A6E70C46C9739C656147E39C449D765E541EEDF0D8B3F6D98A38A5BE5863EB.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section5203829224">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5203829224" tips="复制节点链接"></i></h3><ol><li>引入TimeBarView时间轴组件<p>创建TimeBarModel实例作为数据载体，实例对象viewModel通过组件参数传入TimeBarView时间轴组件，即可渲染基本的时间轴。核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L17-L174" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> {</li><li>  <span class="hljs-title class_">TimeBarView</span>,</li><li>  <span class="hljs-title class_">TimeBarModel</span>,</li><li>  <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@samples/time_bar'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">TimeBarVideoLinkage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">viewModel</span>: <span class="hljs-title class_">TimeBarModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeBarModel</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">NavDestination</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">TimeBarView</span>({</li><li>              <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>,</li><li>              <span class="hljs-comment">// ...</span></li><li>            })</li><li>          }</li><li>          <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">title</span>($r(<span class="hljs-string">'app.string.route_title2'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L17-L174" target="_blank">TimeBarVideoLinkage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>TimeBarView组件属性参考：<a href="https://gitee.com/harmonyos_samples/timebar#具体实现" target="_blank">TimeBarView 接口信息</a>。</p> </div></div></div> </li><li>时间轴展示视频区域<p>开发者处理视频片段，生成RecordSegment类型的集合。通过viewModel对象的timeRange属性传递给组件，在时间轴上即可绘制视频区域。核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L85-L119" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">getTimeInfoFromVideo</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">videosInfo</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videosInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">extractOnlineVideosInfo</span>(<span class="hljs-variable constant_">LEGITIMATE_VIDEO_URLS</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videosInfo</span> = [];</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">fileInfoList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">RecordSegment</span>&gt; = [];</li><li>  <span class="hljs-keyword">const</span> initialTimeISO = <span class="hljs-title function_">getTodayStartMs</span>();</li><li>
</li><li>  <span class="hljs-comment">// Generate segments aligned to the time bar (including gaps)</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">videosInfo</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">curInfo, index</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> seg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecordSegment</span>();</li><li>
</li><li>    <span class="hljs-keyword">const</span> startOffset = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timelineOffsets</span>[index] || <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">const</span> durMs = <span class="hljs-title class_">Number</span>(curInfo.<span class="hljs-property">duration</span>) || <span class="hljs-number">0</span>;</li><li>
</li><li>    seg.<span class="hljs-property">beginTime</span> = <span class="hljs-title function_">dayjs</span>(initialTimeISO).<span class="hljs-title function_">add</span>(startOffset, <span class="hljs-string">'millisecond'</span>).<span class="hljs-title function_">format</span>(<span class="hljs-variable constant_">MILLISECOND_FORMAT</span>);</li><li>    seg.<span class="hljs-property">endTime</span> = <span class="hljs-title function_">dayjs</span>(initialTimeISO).<span class="hljs-title function_">add</span>(startOffset + durMs, <span class="hljs-string">'millisecond'</span>).<span class="hljs-title function_">format</span>(<span class="hljs-variable constant_">MILLISECOND_FORMAT</span>);</li><li>
</li><li>    fileInfoList.<span class="hljs-title function_">push</span>(seg)</li><li>  });</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewModel</span>.<span class="hljs-property">timeRange</span> = fileInfoList;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L85-L119" target="_blank">TimeBarVideoLinkage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>可向TimeBarView组件传递videoAreaOption属性，以修改时间区域的背景色及在时间轴垂直方向的位置；传递timeScaleOption属性，以修改时间轴刻度的长度、颜色及对齐方式。</p> </div></div></div> </li><li>绑定时间轴事件监听器，同步时间状态<p>在onContextReady()回调中，获取TimeBarView实例并绑定setTimeBarMoveListener()方法，监听时间轴滑动事件，实时同步当前选中时间（curTime）与操作状态（timeBarStatus）。核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L68-L77" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> handleContextReady = <span class="hljs-function">(<span class="hljs-params">_ctx: CanvasRenderingContext2D, component: TimeBarView</span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeBarRef</span> = component;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeBarRef</span>.<span class="hljs-title function_">setTimeBarMoveListener</span>({</li><li>    <span class="hljs-attr">onMoveScaleCallback</span>: <span class="hljs-function">(<span class="hljs-params">curTime: <span class="hljs-built_in">number</span>, status?: PlayStatus</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = curTime;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeBarStatus</span> = status;</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L68-L77" target="_blank">TimeBarVideoLinkage.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L145-L152" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">TimeBarView</span>({</li><li>    <span class="hljs-variable">model</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">viewModel</span>,</li><li>    <span class="hljs-variable">onContextReady</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">handleContextReady</span></li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/pages/TimeBarVideoLinkage.ets#L145-L152" target="_blank">TimeBarVideoLinkage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>onMoveScaleCallback()回调会在时间轴开始滑动（START）、滑动过程中（PLAYING）、松手后（STOP）触发，curTime为时间轴中间线对应的绝对时间戳，是视频跳转的核心依据。</p> </div></div></div> </li><li>实现时间同步逻辑，处理视频跳转<p>时间轴滑动时，通过@Watch监听currentTime属性变化，处理视频跳转逻辑。</p> <ul><li>有效区域滑动：拖动时间轴至某段视频内，松手后视频精准跳转至对应时间并播放。</li><li>空白区域滑动：拖动至两段视频的空白间隔，视频自动跳转至下一段视频的起始位置。</li><li>边界滑动：拖动至视频范围最右侧（最后一段视频结束时间），时间轴无法继续右滑，视频停留在最后一帧。<ol><li>计算目标视频位置（时间映射与边界处理）<p>从时间轴拖动的currentTime（选中时间）出发，通过“时间偏移计算→片段定位→进度校正”，确定视频需跳转的目标进度。核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/components/VideoView.ets#L114-L139" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> totalTimelineMs = <span class="hljs-keyword">this</span>.totalTimelineMs || <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">const</span> rawOffset = (<span class="hljs-keyword">this</span>.curTime ?? <span class="hljs-keyword">this</span>.initialTime) - <span class="hljs-keyword">this</span>.initialTime; <span class="hljs-comment">// relative offset (ms)</span></li><li><span class="hljs-keyword">const</span> clampedOffset = clamp(rawOffset, <span class="hljs-number">0</span>, totalTimelineMs);</li><li>
</li><li><span class="hljs-comment">// Resolve segment index (including gaps) and derive target segment window</span></li><li><span class="hljs-keyword">const</span> info = findSegmentIndexByTimeline(<span class="hljs-keyword">this</span>.timelineOffsets ?? [], <span class="hljs-keyword">this</span>.videosInfo, clampedOffset);</li><li><span class="hljs-keyword">const</span> prevIndex = <span class="hljs-keyword">this</span>.curIndex;</li><li><span class="hljs-keyword">const</span> nextIndex = info.index !== -<span class="hljs-number">1</span> ? info.index : prevIndex;</li><li>
</li><li><span class="hljs-comment">// Start time and duration of the target segment</span></li><li><span class="hljs-keyword">const</span> segStartMs = <span class="hljs-keyword">this</span>.timelineOffsets?.[nextIndex] ?? <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">const</span> segDurMs = Number(<span class="hljs-keyword">this</span>.videosInfo[nextIndex]?.duration) || <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-comment">// Whether dragged to the "absolute end"</span></li><li><span class="hljs-keyword">const</span> playEnd = (nextIndex === <span class="hljs-keyword">this</span>.videosInfo.length - <span class="hljs-number">1</span>) &amp;&amp; (clampedOffset === totalTimelineMs);</li><li>
</li><li><span class="hljs-comment">// Compute the preview/target progress inside the segment (seconds)</span></li><li><span class="hljs-keyword">const</span> videoProgressSec = <span class="hljs-keyword">this</span>.computeProgressSeconds(clampedOffset, segStartMs, segDurMs, info, playEnd);</li><li>
</li><li><span class="hljs-keyword">const</span> prevSrc = <span class="hljs-keyword">this</span>.videoSrcArray[prevIndex] ?? <span class="hljs-string">''</span>;</li><li><span class="hljs-keyword">const</span> nextSrc = <span class="hljs-keyword">this</span>.videoSrcArray[nextIndex] ?? <span class="hljs-string">''</span>;</li><li><span class="hljs-keyword">const</span> indexChanged = nextIndex !== prevIndex;</li><li><span class="hljs-keyword">const</span> willReload = indexChanged &amp;&amp; nextSrc !== prevSrc;</li><li>
</li><li><span class="hljs-comment">// Decide whether player source must reload (URL change) and apply index switch side-effects</span></li><li><span class="hljs-keyword">this</span>.decideAndApplyIndexChange(indexChanged, willReload, nextIndex, segStartMs);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/components/VideoView.ets#L114-L139" target="_blank">VideoView.ets</a></div></div></div></div> <p></p> </li><li>执行视频跳转与播放控制<p>根据视频进度属性（目标进度）videoProgressSec，结合视频加载状态执行跳转，并控制播放行为。核心代码如下：</p> <div class="screenLinkPre"><div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/components/VideoView.ets#L199-L214" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> performSeek(videoProgressSec: number, willReload: boolean) {</li><li>  <span class="hljs-keyword">if</span> (willReload) {</li><li>    <span class="hljs-comment">// Source will reload: cache and let onPrepared execute precise seek</span></li><li>    <span class="hljs-keyword">this</span>.pendingSeekSec = videoProgressSec;</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// No reload (or no segment change): attempt immediate precise seek</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.durationTime === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// Duration is not available yet: still cache the seek</span></li><li>    <span class="hljs-keyword">this</span>.pendingSeekSec = videoProgressSec;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.controller.setCurrentTime(videoProgressSec, SeekMode.Accurate);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/timebar/blob/master/entry/src/main/ets/components/VideoView.ets#L199-L214" target="_blank">VideoView.ets</a></div></div></div></div> </li></ol> </li></ul> </li></ol> </div> <div class="tiledSection"><h2 id="section763762422215">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section763762422215" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1641972014332" class="firsth2"><strong>canvas画的时间轴，在手势捏合缩放时画面不停闪烁，是否有解决方案</strong><i class="anchor-icon anchor-icon-link" anchorid="section1641972014332" tips="复制节点链接"></i></h3><p>在Canvas画布进行缩放操作时，尤其是在处理手势缩放时，可能会出现画面闪烁的问题。这是由于缩放操作导致画布上的图形重新计算和绘制，引起视觉上的闪烁效果。为减少这种现象，可采取以下方法：设置临界点，在手势捏合持续回调中，不是每次移动都重新绘制图形，而是设定特定条件，当满足这些条件时才重新绘制。例如，可检查手势移动的距离，当移动超过特定阈值时才更新画面。</p> <div _ngcontent-kos-c106="" class="highlight-div"><div _ngcontent-kos-c106="" class="highlight-div-header"><div _ngcontent-kos-c106="" class="highlight-div-header-left"><div _ngcontent-kos-c106="" class="handle-button expand-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kos-c106="" class="highlight-div-header-right"><div _ngcontent-kos-c106="" class="handle-button ai-button"></div><div _ngcontent-kos-c106="" class="handle-button line-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kos-c106="" class="handle-button theme-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kos-c106="" class="handle-button copy-button"><div _ngcontent-kos-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kos-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (Math.abs(offsetX - <span class="hljs-keyword">this</span>.lastOffsetX) &lt; <span class="hljs-number">0.5</span> &amp;&amp; Math.abs(offsetY - <span class="hljs-keyword">this</span>.lastOffsetY) &lt; <span class="hljs-number">0.5</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li><li><span class="hljs-keyword">this</span>.lastOffsetX = offsetX;</li></ol></pre></div></div> <p>此段代码表示仅当X轴与Y轴的位移均超过0.5时，才更新画布，从而减少不必要的重绘。</p> </div> <div class="tiledSection"><h2 id="section1036454411229">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1036454411229" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/timebar" target="_blank">可缩放时间轴</a></li></ul> </div> </div> <div></div></div>