<h1 _ngcontent-kdh-c119="" class="doc-title ng-star-inserted" title="基于HMRouter的页面跳转"> 基于HMRouter的页面跳转 </h1>

<div _ngcontent-kdh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1292012171119">概述<i class="anchor-icon anchor-icon-link" anchorid="section1292012171119" tips="复制节点链接"></i></h2><p>HMRouter是HarmonyOS上页面跳转的场景解决方案，主要解决页面间相互跳转的问题，开发者可以参考<a href="https://gitee.com/harmonyos_samples/HMRouter#hmrouter使用说明" target="_blank">HMRouter使用说明</a>进行安装配置与快速上手，本文主要以实际开发中的各项场景为例，介绍HMRouter路由框架的使用。HMRouter路由框架提供了下列功能特性：</p> <ul><li>使用自定义注解实现路由跳转。</li><li>支持HAR/HSP。</li><li>支持路由拦截、路由生命周期。</li><li>简化自定义动画配置：配置全局动画，单独指定某个页面的切换动画。</li><li>支持不同的页面类型：单例页面、Dialog页面。</li></ul> <p>该框架底层对Navigation相关能力进行了封装，帮助开发者减少对Navigation相关细节内容的关注、提高开发效率，同时该框架对页面跳转能力进行了增强，例如其中的路由拦截、单例页面等。下文以页面跳转、弹窗提示、转场动效、数据加载、维测场景为切入点，介绍HMRouter路由框架的使用。</p> </div> <div class="tiledSection"><h2 id="section048581325720">页面跳转场景<i class="anchor-icon anchor-icon-link" anchorid="section048581325720" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section16933185617575" class="firsth2">页面跳转与返回<i class="anchor-icon anchor-icon-link" anchorid="section16933185617575" tips="复制节点链接"></i></h3><p>HMRouter提供了基于自定义注解的页面跳转与返回功能，使用步骤如下：</p> <ol><li>为需要跳转的页面添加@HMRouter注解，并配置其中的pageUrl参数，例如此处配置为ProductContent。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/product/ProductContent.ets#L28-L69" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMRouter</span>({ <span class="hljs-variable">pageUrl</span>: <span class="hljs-string">'ProductContent'</span> })</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProductContent</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">param</span>: <span class="hljs-title class_">ParamsType</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">param</span> = <span class="hljs-variable">HMRouterMgr</span>.<span class="hljs-title function_">getCurrentParam</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">ParamsType</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/product/ProductContent.ets#L28-L69" target="_blank">ProductContent.ets</a></div></div></div></div> </li><li>在需要进行页面跳转的位置，使用HMRouterMgr提供的to方法进行页面跳转，在参数中配置目标页面的页面地址，如需传参可配置withParam参数。此外，也可以配置页面栈唯一标识navigationId，当使用多个HMNavigation时建议开发者手动指定navigationId，当使用单个HMNavigation时，开发者可以不传递navigationId参数，系统会默认处理。onResult参数可用于配置当从其他页面返回到当前页面时的回调函数，在回调函数内可以通过参数的srcPagelnfo.name属性获取由哪个页面跳转到当前页，还可以通过参数的result属性获取返回当前页面时携带的参数。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/home/HomeContent.ets#L257-L265" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">HMRouterMgr</span>.<span class="hljs-title function_">to</span>(<span class="hljs-string">'ProductContent'</span>)</li><li>  .<span class="hljs-title function_">withNavigation</span>(<span class="hljs-string">'mainNavigationId'</span>)</li><li>  .<span class="hljs-title function_">withParam</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> })</li><li>  .<span class="hljs-title function_">onResult</span>(<span class="hljs-function">(<span class="hljs-params">popInfo: HMPopInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">const</span> pageName = popInfo.<span class="hljs-property">srcPageInfo</span>.<span class="hljs-property">name</span>;</li><li>    <span class="hljs-keyword">const</span> params = popInfo.<span class="hljs-property">result</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`page name is <span class="hljs-subst">${pageName}</span>, params is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(params)}</span>`</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">pushAsync</span>()</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/home/HomeContent.ets#L257-L265" target="_blank">HomeContent.ets</a></div></div></div></div> </li><li>在跳转的目标页面使用HMRouterMgr.getCurrentParam()获取到传递的页面参数。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/product/elements/ProductContent.ets#L7-L22" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProductContent</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">param</span>: <span class="hljs-title class_">ParamsType</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">param</span> = <span class="hljs-variable">HMRouterMgr</span>.<span class="hljs-title function_">getCurrentParam</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">ParamsType</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/product/elements/ProductContent.ets#L7-L22" target="_blank">ProductContent.ets</a></div></div></div></div> </li><li>如需使用页面返回功能，在对应的业务逻辑位置使用HMRouterMgr提供的pop方法实现页面返回，同样的pop方法支持传入navigationId，同时HMRouter还支持在返回时通过配置param参数向其所返回的页面传递参数。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/segment/segment1.ets#L33-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">HMRouterMgr</span>.<span class="hljs-title function_">pop</span>({ <span class="hljs-variable">navigationId</span>: <span class="hljs-string">'mainNavigationId'</span>, <span class="hljs-variable">param</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">param</span> })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/segment/segment1.ets#L33-L33" target="_blank">segment1.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section833531118581">多次页面跳转，返回指定页面<i class="anchor-icon anchor-icon-link" anchorid="section833531118581" tips="复制节点链接"></i></h3><p>当页面跳转路径如HomePage-&gt;PageA-&gt;PageB-&gt;PageC，开发者希望在PageC的页面逻辑中直接返回到HomePage并携带参数，开发者仅需使用HMRouterMgr提供的to方法，并传入需要返回的目标页面的地址以及携带的参数，即可直接带参返回到指定页面。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PaySuccessPageComponent.ets#L94-L97" data-highlighted="yes"><ol class="linenums"><li>HMRouterMgr<span class="hljs-selector-class">.to</span>('MainPage')</li><li>  <span class="hljs-selector-class">.withNavigation</span>('mainNavigationId')</li><li>  <span class="hljs-selector-class">.withParam</span>(<span class="hljs-number">0</span>)</li><li>  <span class="hljs-selector-class">.pushAsync</span>()</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PaySuccessPageComponent.ets#L94-L97" target="_blank">PaySuccessPageComponent.ets</a></div></div></div></div> </div> <div class="fignone"><span class="figcap"><b>图1 </b>返回指定页面示意图</span><br><span><img height="132.66750000000002" originheight="1119" originwidth="4400" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162942.09203430499522332441711298489326:50001231000000:2800:AFA576A259849316BE606B4C462988AFA66F4C8D7C79F563EA1E5E0EDB608A33.png" title="点击放大" width="523.6875"></span></div> <div class="tiledSection"><h3 id="section177754175585">应用未登录，点击跳转登录页的校验场景<i class="anchor-icon anchor-icon-link" anchorid="section177754175585" tips="复制节点链接"></i></h3><p>应用中经常会有当用户未登录应用时，点击某些应用内容会自动跳转到登录页面的场景，在使用HMRouter对此场景进行实现时，可以采用以下步骤：</p> <ol><li>定义拦截器类LoginCheckInterceptor实现IHMInterceptor接口。</li><li>为定义的拦截器类添加@HMInterceptor注解，通过interceptorName配置拦截器名称LoginCheckInterceptor。</li><li>实现IHMInterceptor的intercept异步拦截器方法，在该方法中根据当前的登录状态来控制页面跳转的目标。<ol><li>当用户已登录，通过执行chain.onContinue()，正常执行后续页面跳转逻辑。</li><li>当用户未登录，通过Toast弹窗向用户提示登录，然后跳转到登录页面，最后通过执行chain.onIntercept()来拦截此次跳转请求。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/interceptor/LoginCheckInterceptor.ets#L25-L60" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMInterceptor</span>({ <span class="hljs-variable">interceptorName</span>: <span class="hljs-string">'LoginCheckInterceptor'</span> })</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginCheckInterceptor</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">IHMInterceptor</span> {</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">intercept</span>(<span class="hljs-variable">chain</span>: <span class="hljs-title class_">IHMInterceptorChain</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">info</span> = <span class="hljs-variable">chain</span>.<span class="hljs-title function_">getRouterInfo</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">context</span> = <span class="hljs-variable">chain</span>.<span class="hljs-title function_">getContext</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (!!<span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'isLogin'</span>)) {</li><li>        <span class="hljs-variable">await</span> <span class="hljs-variable">chain</span>.<span class="hljs-title function_">onContinue</span>()</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">info</span>.<span class="hljs-variable">context</span>.<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-variable">message</span>: <span class="hljs-string">'请先登录'</span> });</li><li>        <span class="hljs-variable">HMRouterMgr</span>.<span class="hljs-title function_">push</span>({</li><li>          <span class="hljs-variable">pageUrl</span>: <span class="hljs-string">'loginPage'</span>,</li><li>          <span class="hljs-variable">skipAllInterceptor</span>: <span class="hljs-keyword">true</span></li><li>        });</li><li>        <span class="hljs-variable">await</span> <span class="hljs-variable">chain</span>.<span class="hljs-title function_">onIntercept</span>();</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/interceptor/LoginCheckInterceptor.ets#L25-L60" target="_blank">LoginCheckInterceptor.ets</a></div></div></div></div> </li></ol> </li><li>在需要进行拦截的页面中配置@HMRouter的interceptors参数即可，由于一个页面可以配置多个拦截器，所以需要将关联的拦截器名称封装为一个数组进行传入。</li></ol> <p>运行效果如下图所示。</p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162942.73579013210438332730756785728576:50001231000000:2800:ADE61EC6BBA7F20442AE0EA9BACE447D2B20FAAA23E490B25F0753E164780FA9.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section133201725105816">实现单例页面的跳转<i class="anchor-icon anchor-icon-link" anchorid="section133201725105816" tips="复制节点链接"></i></h3><p>当应用中存在初始化加载资源消耗大且有复用需求的页面时，就可以使用单例页面。典型的业务场景如视频类应用中的视频播放页面，此类页面通常需要加载视频解码器资源并对其初始化，且该页面在视频类应用中会频繁出现。实现上开发者只需要配置@HMRouter注解参数中的singleton参数为true即可。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L161-L197" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@HMRouter</span>({</li><li>  <span class="hljs-attribute">pageUrl</span>: <span class="hljs-string">'liveHome'</span>,</li><li>  <span class="hljs-attribute">singleton</span>: true,</li><li>  <span class="hljs-attribute">animator</span>: <span class="hljs-string">'liveInteractiveAnimator'</span>,</li><li>  <span class="hljs-attribute">lifecycle</span>: <span class="hljs-string">'liveHomeLifecycle'</span></li><li>})</li><li><span class="hljs-variable">@Component</span></li><li>export struct LiveHome {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L161-L197" target="_blank">LiveHome.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section2050722816116">弹窗提示场景<i class="anchor-icon anchor-icon-link" anchorid="section2050722816116" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section88121519162011" class="firsth2">实现弹窗类型的页面<i class="anchor-icon anchor-icon-link" anchorid="section88121519162011" tips="复制节点链接"></i></h3><p>在HMRouter路由框架中，开发者只需要设置@HMRouter注解的dialog配置为true即可将当前页面作为弹窗使用。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/privacy/PrivacyDialogContent.ets#L28-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@HMRouter</span>({ <span class="hljs-attribute">pageUrl</span>: <span class="hljs-string">'privacyDialog'</span>, <span class="hljs-attribute">dialog</span>: true })</li><li><span class="hljs-variable">@Component</span></li><li>export struct PrivacyDialogContent {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/privacy/PrivacyDialogContent.ets#L28-L52" target="_blank">PrivacyDialogContent.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section559322412202">返回时弹窗，提示用户是否确认返回<i class="anchor-icon anchor-icon-link" anchorid="section559322412202" tips="复制节点链接"></i></h3><div class="p">当从某些页面返回时，应用希望通过弹窗方式让用户确认是否要执行返回操作，例如在订单支付页面中用户执行返回操作时，通常会弹窗提示用户是否确认退出，当用户点击确认后才会执行页面退出逻辑，此场景下就可以考虑使用弹窗类型页面加上自定义生命周期来实现。操作步骤如下：<ol><li>开发者首先需要根据自己的业务需求，来进行自定义弹窗的开发。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayCancel.ets#L61-L104" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMRouter</span>({ <span class="hljs-variable">pageUrl</span>: <span class="hljs-string">'PayCancel'</span>, <span class="hljs-variable">dialog</span>: <span class="hljs-keyword">true</span>,<span class="hljs-variable">animator</span>:<span class="hljs-string">'PayCancelDialog'</span> })</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PayCancel</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">Center</span> }) {</li><li>      <span class="hljs-title function_">ConfirmDialog</span>({</li><li>        <span class="hljs-variable">title</span>: <span class="hljs-string">'取消订单'</span>,</li><li>        <span class="hljs-variable">content</span>: <span class="hljs-string">'您确认要取消此订单吗?'</span>,</li><li>        <span class="hljs-variable">leftButtonName</span>: <span class="hljs-string">'再看看'</span>,</li><li>        <span class="hljs-variable">rightButtonName</span>: <span class="hljs-string">'取消订单'</span>,</li><li>        <span class="hljs-variable">leftButtonFunc</span>: () =&gt; {</li><li>          <span class="hljs-variable">HMRouterMgr</span>.<span class="hljs-title function_">popAsync</span>({</li><li>            <span class="hljs-variable">navigationId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">queryNavigationInfo</span>()?.<span class="hljs-title class_">navigationId</span></li><li>          });</li><li>        },</li><li>        <span class="hljs-variable">rightButtonFunc</span>: () =&gt; {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>      });</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">position</span>({</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-string">'50%'</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-string">'50%'</span></li><li>    })</li><li>    .<span class="hljs-title function_">markAnchor</span>({</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-string">'50%'</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-string">'50%'</span></li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayCancel.ets#L61-L104" target="_blank">PayCancel.ets</a></div></div></div></div> </li><li>定义ExitPayLifecycle类来实现IHMLifecycle接口，为ExitPayLifecycle加上@HMLifecycle注解，传入生命周期名称ExitPayLifecycle，在类的内部，重写onBackPressed回调函数，当用户执行返回操作时，该回调函数触发，弹出刚刚定义的PayCancel弹窗。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayDialogContent.ets#L169-L180" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@HMLifecycle({ lifecycleName: <span class="hljs-string">'ExitPayLifecycle'</span> })</span></li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExitPayLifecycle</span> <span class="hljs-title">implements</span> <span class="hljs-title">IHMLifecycle</span> {</li><li>  model: ObservedModel = new ObservedModel();</li><li>
</li><li>  onBackPressed(): boolean {</li><li>    HMRouterMgr.to(<span class="hljs-string">'PayCancel'</span>)</li><li>      .withParam(<span class="hljs-keyword">this</span>.model.pageUrl)</li><li>      .pushAsync()</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayDialogContent.ets#L169-L180" target="_blank">PayDialogContent.ets</a></div></div></div></div> </li><li>将定义的生命周期与支付页面绑定，只需要将刚刚定义的生命周期传入对应组件@HMRouter注解的lifecycle参数即可。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayDialogContent.ets#L78-L152" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@HMRouter</span>({</li><li>  <span class="hljs-attribute">pageUrl</span>: <span class="hljs-string">'PayDialogContent'</span>,</li><li>  <span class="hljs-attribute">dialog</span>: true,</li><li>  <span class="hljs-attribute">lifecycle</span>: <span class="hljs-string">'ExitPayDialog'</span>,</li><li>  <span class="hljs-attribute">interceptors</span>: [<span class="hljs-string">'LoginCheckInterceptor'</span>]</li><li>})</li><li><span class="hljs-variable">@Component</span></li><li>export struct PayDialogContent {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/pay/PayDialogContent.ets#L78-L152" target="_blank">PayDialogContent.ets</a></div></div></div></div> </li></ol> </div> </div> <p>运行效果如下图所示。</p> <p><span><img height="600.0827" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.33085070445097844283213720138836:50001231000000:2800:F1BDE1C012502916930343178F963F397AF0CCF200C796DFD50BD4C86670F5E6.gif" title="点击放大" width="292.6"></span></p> <p></p> <div class="tiledSection"><h3 id="section1582032972017">首页两次返回退出应用<i class="anchor-icon anchor-icon-link" anchorid="section1582032972017" tips="复制节点链接"></i></h3><p>该场景下用户第一次触发应用返回退出时向用户提示“再次返回退出”，第二次用户触发返回操作时应用真正退出。实现上可参考以下步骤：</p> <ol><li>定义一个生命周期类ExitAppLifecycle实现IHMLifecycle接口。</li><li>使用@HMLifecycle注解传入生命周期名称参数lifecycleName为ExitAppLifecycle。</li><li>重写其中的onBackPressed方法（此处是由于上述业务场景需要，实际开发中根据实际业务场景按需重写方法），通过判断上次返回操作与当前返回操作的时间间隔，按如下逻辑处理：<ol><li>当两次返回操作的时间间隔大于设置值时（此处为1000ms），重新弹窗对用户进行提示，此处返回true，表示不执行默认返回逻辑。</li><li>当两次返回操作的时间间隔小于设置值时（此处为1000ms），返回为false表示执行默认返回逻辑，退出应用。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/lifecycle/ExitAppLifecycle.ets#L24-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@HMLifecycle</span>({ <span class="hljs-attr">lifecycleName</span>: <span class="hljs-string">'ExitAppLifecycle'</span> })</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExitAppLifecycle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHMLifecycle</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lastTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">onBackPressed</span>(<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">HMLifecycleContext</span>): <span class="hljs-built_in">boolean</span> {</li><li>    <span class="hljs-keyword">let</span> time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>    <span class="hljs-keyword">if</span> (time - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> &gt; <span class="hljs-number">1000</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = time;</li><li>      ctx.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>        <span class="hljs-attr">message</span>: <span class="hljs-string">'Return to exit the application again.'</span>,</li><li>        <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span></li><li>      });</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/lifecycle/ExitAppLifecycle.ets#L24-L42" target="_blank">ExitAppLifecycle.ets</a></div></div></div></div> </li></ol> </li><li>将定义好的生命周期类与页面进行关联，开发者只需在@HMRouter注解中配置lifecycle为要关联的生命周期名称即可。</li></ol> </div> <p>运行效果如下图所示。</p> <p><span><img height="600.0827" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.44190361639939082013768802107013:50001231000000:2800:7D922493A2593398AF8BC81D48A1E5952626AE417E156B8A7FD7C0E9542DDB4E.gif" title="点击放大" width="292.6"></span></p> <p></p> <div class="tiledSection"><h2 id="section26031048719">转场动效场景<i class="anchor-icon anchor-icon-link" anchorid="section26031048719" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section196701753610" class="firsth2">全局自定义转场动效<i class="anchor-icon anchor-icon-link" anchorid="section196701753610" tips="复制节点链接"></i></h3><ul><li>定义全局页面转场效果。开发者只需要创建出IHMAnimator.Effect实例，在参数中按照业务需求对动画方向direction，透明度opacity，横纵方向页面缩放效果scale进行配置即可。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L24-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable">globalPageTransitionEffect</span>: <span class="hljs-title class_">IHMAnimator</span>.<span class="hljs-title class_">Effect</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">IHMAnimator</span>.<span class="hljs-title function_">Effect</span>({</li><li>  <span class="hljs-variable">direction</span>: <span class="hljs-title class_">IHMAnimator</span>.<span class="hljs-title class_">Direction</span>.<span class="hljs-title class_">BOTTOM_TO_TOP</span>,</li><li>  <span class="hljs-variable">opacity</span>: { <span class="hljs-variable">opacity</span>: <span class="hljs-number">0.5</span> },</li><li>  <span class="hljs-variable">scale</span>: { <span class="hljs-variable">x</span>: <span class="hljs-number">0.5</span>, <span class="hljs-variable">y</span>: <span class="hljs-number">0.2</span> }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L24-L29" target="_blank">DialogAnimator.ets</a></div></div></div></div> <p>定义完成后，只需要将实例传入HMNavigation组件的dialogAnimator参数即可。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L38-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">HMNavigation</span>({</li><li>  <span class="hljs-variable">navigationId</span>: <span class="hljs-string">'mainNavigationId'</span>, <span class="hljs-variable">homePageUrl</span>: <span class="hljs-string">'HomeContent'</span>, <span class="hljs-variable">options</span>: {</li><li>    <span class="hljs-variable">dialogAnimator</span>: <span class="hljs-title class_">globalPageTransitionEffect</span>,</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L38-L42" target="_blank">DialogAnimator.ets</a></div></div></div></div> </li><li>定义全局弹窗效果。同样的，开发者也只需要按照业务需求创建出对应的IHMAnimator.Effect实例，代码示例如下。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L24-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable">globalPageTransitionEffect</span>: <span class="hljs-title class_">IHMAnimator</span>.<span class="hljs-title class_">Effect</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">IHMAnimator</span>.<span class="hljs-title function_">Effect</span>({</li><li>  <span class="hljs-variable">direction</span>: <span class="hljs-title class_">IHMAnimator</span>.<span class="hljs-title class_">Direction</span>.<span class="hljs-title class_">BOTTOM_TO_TOP</span>,</li><li>  <span class="hljs-variable">opacity</span>: { <span class="hljs-variable">opacity</span>: <span class="hljs-number">0.5</span> },</li><li>  <span class="hljs-variable">scale</span>: { <span class="hljs-variable">x</span>: <span class="hljs-number">0.5</span>, <span class="hljs-variable">y</span>: <span class="hljs-number">0.2</span> }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L24-L29" target="_blank">DialogAnimator.ets</a></div></div></div></div> <p>将创建好的实例作为dialogAnimator的参数进行传入即可。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L38-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">HMNavigation</span>({</li><li>  <span class="hljs-variable">navigationId</span>: <span class="hljs-string">'mainNavigationId'</span>, <span class="hljs-variable">homePageUrl</span>: <span class="hljs-string">'HomeContent'</span>, <span class="hljs-variable">options</span>: {</li><li>    <span class="hljs-variable">dialogAnimator</span>: <span class="hljs-title class_">globalPageTransitionEffect</span>,</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/DialogAnimator.ets#L38-L42" target="_blank">DialogAnimator.ets</a></div></div></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section27681826217">特定页面设置自定义转场<i class="anchor-icon anchor-icon-link" anchorid="section27681826217" tips="复制节点链接"></i></h3><p>开发者可以自定义动画类并实现IHMAnimator接口中的effect方法，该方法会将页面进出场的效果对象enterHandle与exitHandle作为参数传入，可通过参数对象上的start、finish方法，设置对应效果的起止状态，支持设置的常用属性还有：</p> <ul><li>curve：设置动画速度曲线，支持通过Curve枚举传入值，默认Curve.EaseInOut。</li><li>duration：动画持续时长，单位ms。</li></ul> <p>以下代码示例表示入场时由屏幕底部以线性速度向屏幕顶部运动，入场动画持续时长为400ms。出场时从屏幕顶部以线性速度向屏幕底部运动，出场动画持续时长也为400ms。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomCutToAnimator.ets#L29-L52" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMAnimator</span>({ <span class="hljs-variable">animatorName</span>: <span class="hljs-string">'CustomAnimator'</span> })</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomAnimator</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">IHMAnimator</span> {</li><li>  <span class="hljs-title function_">effect</span>(<span class="hljs-variable">enterHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>, <span class="hljs-variable">exitHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// to animator</span></li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'100%'</span> }).<span class="hljs-title function_">scale</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">0.7</span> }).<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.3</span>)</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'0'</span> }).<span class="hljs-title function_">scale</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">1</span> }).<span class="hljs-title function_">opacity</span>(<span class="hljs-number">1</span>)</li><li>    })</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-variable">duration</span> = <span class="hljs-number">400</span>;</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-variable">curve</span> = <span class="hljs-variable">Curve</span>.<span class="hljs-variable">Linear</span>;</li><li>
</li><li>    <span class="hljs-comment">// cut animator</span></li><li>    <span class="hljs-variable">exitHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'0'</span> }).<span class="hljs-title function_">scale</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">1</span> }).<span class="hljs-title function_">opacity</span>(<span class="hljs-number">1</span>)</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'100%'</span> }).<span class="hljs-title function_">scale</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">0.7</span> }).<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.3</span>)</li><li>    })</li><li>    <span class="hljs-variable">exitHandle</span>.<span class="hljs-variable">duration</span> = <span class="hljs-number">400</span>;</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-variable">curve</span> = <span class="hljs-variable">Curve</span>.<span class="hljs-variable">Linear</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomCutToAnimator.ets#L29-L52" target="_blank">CustomCutToAnimator.ets</a></div></div></div></div> <p>自定义动画定义完成后，其实例可以作为新版链式API跳转方法的animator参数进行传入。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomCutToAnimator.ets#L58-L60" data-highlighted="yes"><ol class="linenums"><li>HMRouterMgr<span class="hljs-selector-class">.to</span>('ProductContent')</li><li>  <span class="hljs-selector-class">.withAnimator</span>(new CustomAnimator())</li><li>  <span class="hljs-selector-class">.pushAsync</span>()</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomCutToAnimator.ets#L58-L60" target="_blank">CustomCutToAnimator.ets</a></div></div></div></div> </div> <p>运行效果如下图所示。</p> <p><span><img height="600.0827" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.57848058982500898527931673830780:50001231000000:2800:F0271D304CE76E65B4E8D5B6F86B2C9672419DC3030187E70D4B5759599A0484.gif" title="点击放大" width="292.6"></span></p> <p></p> <div class="tiledSection"><h3 id="section543118711215">根据条件呈现不同转场动效<i class="anchor-icon anchor-icon-link" anchorid="section543118711215" tips="复制节点链接"></i></h3><p>相同的页面可能在不同情况下出现不同的转场效果，常见的有短视频播放时的评论页面弹出时的转场：</p> <ul><li>当短视频横屏播放时，评论页面由右至左弹出，视频向左缩放。</li><li>当短视频竖屏播放时，评论页面由下至上弹出，视频向上缩放。</li></ul> <p>此处以评论区组件打开的视角进行动画定义，定义竖屏播放时评论区进出场动画如下：</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L29-L45" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMAnimator</span>({ <span class="hljs-variable">animatorName</span>: <span class="hljs-string">'myAnimator1'</span> })</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAnimator1</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">IHMAnimator</span> {</li><li>  <span class="hljs-title function_">effect</span>(<span class="hljs-variable">enterHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>, <span class="hljs-variable">exitHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'100%'</span> })</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'0'</span> })</li><li>    })</li><li>
</li><li>    <span class="hljs-variable">exitHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'0'</span> })</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">y</span>: <span class="hljs-string">'100%'</span> })</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L29-L45" target="_blank">CustomDifferentTransition.ets</a></div></div></div></div> <p>定义短视频横屏播放时评论区进出场动画如下：</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L49-L67" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMAnimator</span>({ <span class="hljs-variable">animatorName</span>: <span class="hljs-string">'myAnimator2'</span> })</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAnimator2</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">IHMAnimator</span> {</li><li>  <span class="hljs-title function_">effect</span>(<span class="hljs-variable">enterHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>, <span class="hljs-variable">exitHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-variable">y</span>: <span class="hljs-string">'0'</span> })</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">0</span> })</li><li>    })</li><li>    <span class="hljs-variable">enterHandle</span>.<span class="hljs-variable">duration</span> = <span class="hljs-number">500</span>;</li><li>
</li><li>    <span class="hljs-variable">exitHandle</span>.<span class="hljs-title function_">start</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: <span class="hljs-string">'0'</span> })</li><li>    }).<span class="hljs-title function_">finish</span>((<span class="hljs-variable">modifier</span>: <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">NavDestinationAttribute</span>&gt;) =&gt; {</li><li>      <span class="hljs-variable">modifier</span>.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: <span class="hljs-string">'100%'</span> })</li><li>    })</li><li>    <span class="hljs-variable">exitHandle</span>.<span class="hljs-variable">duration</span> = <span class="hljs-number">500</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L49-L67" target="_blank">CustomDifferentTransition.ets</a></div></div></div></div> <p>最后根据条件选择不同的动效，例如此处根据视频播放方向是否为横向，在页面跳转时使用不同的animator值。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L71-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">CommentInput</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon_comments'</span>))</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">24</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: <span class="hljs-number">16</span> })</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isLandscape</span>) {</li><li>            <span class="hljs-title class_">HMRouterMgr</span>.<span class="hljs-title function_">to</span>(<span class="hljs-string">'liveComments'</span>)</li><li>              .<span class="hljs-title function_">withNavigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queryNavigationInfo</span>()?.<span class="hljs-property">navigationId</span>)</li><li>              .<span class="hljs-title function_">withParam</span>({<span class="hljs-attr">commentRenderNode</span>: <span class="hljs-string">''</span>})</li><li>              .<span class="hljs-title function_">withAnimator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAnimator2</span>())</li><li>              .<span class="hljs-title function_">onResult</span>(<span class="hljs-function">(<span class="hljs-params">paramInfo: PopInfo</span>)=&gt;</span>{</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoWidth</span> = <span class="hljs-string">'100%'</span>;</li><li>              })</li><li>              .<span class="hljs-title function_">pushAsync</span>()</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoWidth</span> = <span class="hljs-string">'50%'</span>;</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title class_">HMRouterMgr</span>.<span class="hljs-title function_">to</span>(<span class="hljs-string">'liveComments'</span>)</li><li>              .<span class="hljs-title function_">withNavigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queryNavigationInfo</span>()?.<span class="hljs-property">navigationId</span>)</li><li>              .<span class="hljs-title function_">withParam</span>({<span class="hljs-attr">commentRenderNode</span>: <span class="hljs-string">''</span>})</li><li>              .<span class="hljs-title function_">withAnimator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAnimator1</span>())</li><li>              .<span class="hljs-title function_">onResult</span>(<span class="hljs-function">(<span class="hljs-params">paramInfo: PopInfo</span>)=&gt;</span>{</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoHeight</span> = <span class="hljs-string">'100%'</span>;</li><li>              })</li><li>              .<span class="hljs-title function_">pushAsync</span>()</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoHeight</span> = <span class="hljs-string">'30%'</span></li><li>          }</li><li>        });</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/animation/CustomDifferentTransition.ets#L71-L112" target="_blank">CustomDifferentTransition.ets</a></div></div></div></div> </div> <p>运行效果如下图所示。</p> <p><span><img height="597.4892000000001" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.67269439430623801681574846056591:50001231000000:2800:E4B6994DE69BF9A27139CA798BC57C4264910CD0DE224D02BE971964728EFA30.gif" width="292.6" class="notEnlarge"></span></p> <p></p> <div class="tiledSection"><h3 id="section151018013496">交互式转场<i class="anchor-icon anchor-icon-link" anchorid="section151018013496" tips="复制节点链接"></i></h3><p>当应用中有页面的进出场效果与用户手势操作同步的诉求时，即当用户手指在屏幕上移动时，页面跟随用户手势移动，可以参考以下实现，通过IHMAnimator的interactive函数控制动画播放进度，在actionStart中判断向右移动执行页面返回操作，在updateProgress更新动画进度，在actionEnd中获取到动画的最终状态，根据最终状态判断是继续执行动画与页面返回还是关闭动画取消页面返回。</p> <div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L96-L157" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@HMAnimator</span>({ <span class="hljs-attr">animatorName</span>: <span class="hljs-string">'liveInteractiveAnimator'</span> })</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiveInteractiveAnimator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHMAnimator</span> {</li><li>  <span class="hljs-title function_">effect</span>(<span class="hljs-attr">enterHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>, <span class="hljs-attr">exitHandle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">interactive</span>(<span class="hljs-attr">handle</span>: <span class="hljs-title class_">HMAnimatorHandle</span>): <span class="hljs-built_in">void</span> {</li><li>    handle.<span class="hljs-title function_">actionStart</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">offsetX</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title class_">HMRouterMgr</span>.<span class="hljs-title function_">pop</span>();</li><li>      }</li><li>    });</li><li>    handle.<span class="hljs-title function_">updateProgress</span>(<span class="hljs-function">(<span class="hljs-params">event, proxy, operation, startOffset</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (!proxy?.<span class="hljs-property">updateTransition</span> || !startOffset) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>]) {</li><li>        offset = event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">localX</span> - startOffset;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>) {</li><li>        proxy?.<span class="hljs-title function_">updateTransition</span>(<span class="hljs-number">0</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> rectWidth = event.<span class="hljs-property">target</span>.<span class="hljs-property">area</span>.<span class="hljs-property">width</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>      <span class="hljs-keyword">let</span> rate = offset / rectWidth;</li><li>      proxy?.<span class="hljs-title function_">updateTransition</span>(rate);</li><li>    });</li><li>    handle.<span class="hljs-title function_">actionEnd</span>(<span class="hljs-function">(<span class="hljs-params">event, proxy, operation, startOffset</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (!startOffset) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> rectWidth = event.<span class="hljs-property">target</span>.<span class="hljs-property">area</span>.<span class="hljs-property">width</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>      <span class="hljs-keyword">let</span> rate = <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>]) {</li><li>        rate = (event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">localX</span> - startOffset) / rectWidth;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (rate &gt; <span class="hljs-number">0.4</span>) {</li><li>        proxy?.<span class="hljs-title function_">finishTransition</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        proxy?.<span class="hljs-property">cancelTransition</span>?.();</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L96-L157" target="_blank">LiveHome.ets</a></div></div></div></div> </div> <p>运行效果如下图所示。</p> <p><span><img height="600.0827" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.69945020127721232921387889422471:50001231000000:2800:1D0D4E8AFC0DF876C297A6177D8CB156D2D984AE220B350147B4B53BFCDCA6CA.gif" title="点击放大" width="292.6"></span></p> <p></p> <div class="tiledSection"><h2 id="section11681184635515">数据加载场景<i class="anchor-icon anchor-icon-link" anchorid="section11681184635515" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section66821381824" class="firsth2">数据请求预加载，与页面跳转并行化<i class="anchor-icon anchor-icon-link" anchorid="section66821381824" tips="复制节点链接"></i></h3><p>该场景下，开发者希望提前网络请求的位置并在其他线程中执行网络请求而不阻塞主线程，代码实现参考如下步骤。</p> <ol><li>定义网络请求函数，可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction" target="_blank">TaskPool</a>在其他线程执行网络请求并返回请求结果。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/shoppingBag/ShoppingBagContent.ets#L36-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">networkRequest</span>(<span class="hljs-params">lifecycle: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/shoppingBag/ShoppingBagContent.ets#L36-L46" target="_blank">ShoppingBagContent.ets</a></div></div></div></div> </li><li>定义生命周期，在onPrepare回调函数中，执行对应的网络请求函数，该回调触发时机为拦截器执行后，路由栈真正push前。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/shoppingBag/ShoppingBagContent.ets#L52-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@HMLifecycle</span>({ <span class="hljs-attr">lifecycleName</span>: <span class="hljs-string">'requestLifecycle'</span> })</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleLifecycle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHMLifecycle</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">requestModel</span>: <span class="hljs-title class_">RequestModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestModel</span>();</li><li>
</li><li>  <span class="hljs-title function_">onPrepare</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestModel</span>.<span class="hljs-property">data</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(networkRequest, <span class="hljs-string">'onPrepare'</span>);</li><li>    taskpool.<span class="hljs-title function_">execute</span>(task).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res + <span class="hljs-string">''</span>);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/shoppingBag/ShoppingBagContent.ets#L52-L72" target="_blank">ShoppingBagContent.ets</a></div></div></div></div> </li><li>关联生命周期与对应组件。将生命周期的lifecycleName作为@HMRouter注解的lifecycle参数进行传入完成关联。</li></ol> </div> <div class="fignone"><span class="figcap"><b>图2 </b>数据请求预加载流程</span><br><span><img height="210.47250000000003" originheight="1393" originwidth="3452" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162943.90328126822755091260033709409912:50001231000000:2800:67DDF67E8DAB8F645FCFF5071B46F195EE1B854B6E86E61CE0C21ADE5C60CA08.png" title="点击放大" width="523.6875"></span></div> <div class="tiledSection"><h3 id="section49731443521">页面重开数据恢复<i class="anchor-icon anchor-icon-link" anchorid="section49731443521" tips="复制节点链接"></i></h3><p>该场景下当页面关闭时，之前浏览的相关记录依然存在，典型的场景例如短视频评论，当用户打开评论区页进行翻阅后停留在某处，此时关闭评论区再打开，评论内容会仍然停留在上一次浏览的位置。实现上可以参考如下步骤。</p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode" target="_blank">BuilderNode</a>构造出评论区组件，在makeNode函数中，若评论区不存在则创建，存在便直接返回。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/CommentInput.ets#L134-L200" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li>function buildComment(liveComments: LiveCommentsProduct[]) {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommentNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  commentList: BuilderNode&lt;[LiveCommentsProduct[]]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  commentListData: LiveCommentsProduct[] = new LiveCommentsModel().getLiveCommentsList();</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>() {</li><li>    <span class="hljs-keyword">super</span>();</li><li>  }</li><li>
</li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.commentList === <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.nodeBuild(context);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.commentList!.getFrameNode();</li><li>  }</li><li>
</li><li>  nodeBuild(context: UIContext) {</li><li>    <span class="hljs-keyword">this</span>.commentList = new BuilderNode(context);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.commentList !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.commentList.build(wrapBuilder&lt;[LiveCommentsProduct[]]&gt;(buildComment), <span class="hljs-keyword">this</span>.commentListData);</li><li>    }</li><li>  }</li><li>
</li><li>  dispose() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.commentList !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.commentList.dispose();</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/CommentInput.ets#L134-L200" target="_blank">CommentInput.ets</a></div></div></div></div> </li><li>通过在@HMLifecycle生命周期中，将CommentNodeController类的实例跟随视频播放页面的生命周期创建与释放，而非跟随评论区组件的生命周期创建与释放，使得当用户处在视频播放页时，内存中保存着评论区组件的BuilderNode，从而达成当用户关闭评论区再打开，浏览进度与关闭前一致的诉求。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L53-L92" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">HMLifecycle</span>({ <span class="hljs-variable">lifecycleName</span>: <span class="hljs-string">'liveHomeLifecycle'</span> })</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiveHomeLifecycle</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">IHMLifecycle</span> {</li><li>  <span class="hljs-variable">commentRenderNode</span>: <span class="hljs-title class_">CommentNodeController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">CommentNodeController</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onAppear</span>(<span class="hljs-variable">ctx</span>: <span class="hljs-title class_">HMLifecycleContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">commentRenderNode</span>.<span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">ctx</span>.<span class="hljs-variable">uiContext</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDisAppear</span>(<span class="hljs-variable">ctx</span>: <span class="hljs-title class_">HMLifecycleContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">commentRenderNode</span>.<span class="hljs-title function_">dispose</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/LiveHome.ets#L53-L92" target="_blank">LiveHome.ets</a></div></div></div></div> </li><li>在对应的UI组件处获取到生命周期内的commentRenderNode，并在后续业务逻辑中使用NodeContainer进行挂载。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/CommentInput.ets#L52-L129" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CommentInput</span> {</li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'changeVideoHeight'</span>) <span class="hljs-variable">videoHeight</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span> = <span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_PERCENT</span>;</li><li>  <span class="hljs-variable">commentRenderNode</span>: <span class="hljs-title class_">CommentNodeController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">CommentNodeController</span>();</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/component/live/CommentInput.ets#L52-L129" target="_blank">CommentInput.ets</a></div></div></div></div> </li></ol> </div> <div class="fignone"><span class="figcap"><b>图3 </b>页面重开数据恢复流程</span><br><span><img height="106.7325" originheight="897" originwidth="4400" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162944.14598064970574342550754371740020:50001231000000:2800:B7A37F063267E08B9360ABBD4DA7ECB01215C0FCF888C61B63536193F34EB5B2.png" title="点击放大" width="523.6875"></span></div> <div class="tiledSection"><h2 id="section32861613869">维测场景<i class="anchor-icon anchor-icon-link" anchorid="section32861613869" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section56587381536" class="firsth2">页面埋点开发<i class="anchor-icon anchor-icon-link" anchorid="section56587381536" tips="复制节点链接"></i></h3><p>当需要统计类似于页面加载耗时等数据，或者有其他自定义打点数据需要统计时，可以使用生命周期回调，在对应的位置进行打点，以下示例为页面停留时长的数据打点统计，实现上参考以下步骤：</p> <ol><li>定义一个类PageDurationLifecycle实现IHMLifecycle接口。</li><li>为该类添加@HMLifecycle注解，并配置global为true，将该生命周期配置到全局，所有页面都会执行该生命周期。</li><li>在页面显示时（onShown）记录当前的时间戳，在页面隐藏时（onHidden）计算页面停留时长。<div class="screenLinkPre"><div _ngcontent-kdh-c106="" class="highlight-div"><div _ngcontent-kdh-c106="" class="highlight-div-header"><div _ngcontent-kdh-c106="" class="highlight-div-header-left"><div _ngcontent-kdh-c106="" class="handle-button expand-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kdh-c106="" class="highlight-div-header-right"><div _ngcontent-kdh-c106="" class="handle-button ai-button"></div><div _ngcontent-kdh-c106="" class="handle-button line-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kdh-c106="" class="handle-button theme-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kdh-c106="" class="handle-button copy-button"><div _ngcontent-kdh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kdh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/lifecycle/PageDurationLifecycle.ets#L23-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@HMLifecycle</span>({ <span class="hljs-attr">lifecycleName</span>: <span class="hljs-string">'PageDurationLifecycle'</span>, <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span> })</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageDurationLifecycle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IHMLifecycle</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">onShown</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">time</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onHidden</span>(<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">HMLifecycleContext</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> duration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">time</span>;</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Page <span class="hljs-subst">${ctx.navContext?.pathInfo.name}</span> stay <span class="hljs-subst">${duration}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMRouter/blob/master/entry/src/main/ets/lifecycle/PageDurationLifecycle.ets#L23-L36" target="_blank">PageDurationLifecycle.ets</a></div></div></div></div> </li></ol> </div> <div class="fignone"><span class="figcap"><b>图4 </b>页面埋点日志记录</span><p><span><img height="54.016088" originheight="141" originwidth="1367" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162944.07818303340621099422303648598365:50001231000000:2800:252E726D31CBE57E20D8EFE0C9F98EC959FBF589169C9CB5D5B6708A7CBCE6E0.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h2 id="section134481746123919">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section134481746123919" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/HMRouter" target="_blank">HMRouter</a></li></ul> </div> </div> <div></div></div>