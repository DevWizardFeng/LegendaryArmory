<h1 _ngcontent-omm-c119="" class="doc-title ng-star-inserted" title="基于RAG框架实现邮件智能问答"> 基于RAG框架实现邮件智能问答 </h1>

<div _ngcontent-omm-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1225944642810">概述<i class="anchor-icon anchor-icon-link" anchorid="section1225944642810" tips="复制节点链接"></i></h2><p>RAG（检索增强生成）是一种结合了信息检索与文本生成技术的混合型自然语言处理方法。其核心思想是通过引入外部知识库，动态检索与输入问题相关的信息，并基于这些信息生成更准确、可靠的回答，被广泛用于问答系统、对话助手、文档摘要等任务，尤其在需要结合外部知识的场景（如医疗、法律、学术研究）中表现突出。</p> <p>当RAG作用于私人信息领域，就可结合私人信息形成定制化的问答系统、检索助手，本文将从以下关键步骤介绍如何基于RAG框架实现邮件系统的智能问答。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-ai-ragqa#section147555014915">知识库构建</a>：将用户邮件信息写入数据库中，便于后续查找。</li><li><a href="/consumer/cn/doc/best-practices/bpta-ai-ragqa#section29233013420">LLM部署与调用</a>：部署大模型和配置request请求。</li><li><a href="/consumer/cn/doc/best-practices/bpta-ai-ragqa#section1939152912915">RAG会话</a>：配置并开启RAG会话，包括配置知识加工schema、检索配置retrieval.RetrievalConfig、检索条件retrieval.RetrievalCondition和LLM会话。</li></ul> </div> <div class="tiledSection"><h2 id="section1893885012813">用户体验<i class="anchor-icon anchor-icon-link" anchorid="section1893885012813" tips="复制节点链接"></i></h2><p><span><img height="292.26750000000004" originheight="857" originwidth="1535" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163352.82042030581287943336568665733674:50001231000000:2800:2148A625737ED011DF45DC4C48F9553EF43DE00D9A44F02A6BD8A185C92E1FC9.png" title="点击放大" width="523.6875"></span></p> <p>本文案例依托用户自定义的邮件数据库进行智能问答，准确识别语义并提供精确答案，并有以下基本功能：</p> <ol><li>自由增加数据： 系统能接收、存储新的数据源。</li><li>精准问答： 构建一个基于上述数据和模型的、能够提供准确答案的问答系统。</li></ol> </div> <div class="tiledSection"><h2 id="section568651992910">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section568651992910" tips="复制节点链接"></i></h2><p><span><img height="382.8937" originheight="452" originwidth="785" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163352.67943355149140518266672542252677:50001231000000:2800:11C775FA99B6E619DD3A180B1F8EE99506327816C6D6AD2FF5B9CB467D3D5557.png" title="点击放大" width="665"></span></p> <p>RAG提供用于进行流式问答的接口，整体问答流程分为两个阶段：</p> <ul><li><strong>检索阶段</strong>：根据用户输入的问题或指令，利用稠密向量检索、关键词匹配等技术，从数据库或文档库中筛选出最相关的文本片段。</li><li><strong>生成阶段</strong>：将检索结果与原始输入拼接，输入大语言模型（如千问等），生成结合上下文知识的最终回答。</li></ul> </div> <div class="tiledSection"><h2 id="section147555014915">知识库构建<i class="anchor-icon anchor-icon-link" anchorid="section147555014915" tips="复制节点链接"></i></h2><p>本章节介绍如何将原始的邮件数据存储到数据库中，以便后续问答使用。</p> </div> <div class="tiledSection"><h3 id="section1189910390283" class="firsth2">原始数据准备<i class="anchor-icon anchor-icon-link" anchorid="section1189910390283" tips="复制节点链接"></i></h3><p>将邮件数据进行提取和清理，存储为如下例所示的结构，包含包括发件人、收件人、时间、邮件文本等基本信息，便于后续的搜索查找。</p> <div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"subject"</span>: <span class="hljs-string">"【请阅】Mate系列手机优惠政策"</span>,</li><li>  <span class="hljs-string">"sender_name"</span>: <span class="hljs-string">"zhangsan"</span>,</li><li>  <span class="hljs-string">"sender_email"</span>: <span class="hljs-string">"zhangsan@xxx.com"</span>,</li><li>  <span class="hljs-string">"received_time"</span>: <span class="hljs-string">"2025-05-15 15:49:04.135"</span>,</li><li>  <span class="hljs-string">"recipients"</span>: [</li><li>    {</li><li>      <span class="hljs-string">"Address"</span>: <span class="hljs-string">"lisi@xxx.com"</span>,</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"lisi"</span>,</li><li>      <span class="hljs-string">"Type"</span>: <span class="hljs-number">1</span></li><li>    },</li><li>    {</li><li>      <span class="hljs-string">"Address"</span>: <span class="hljs-string">"wangwu@xxx.com"</span>,</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"wangwu"</span>,</li><li>      <span class="hljs-string">"Type"</span>: <span class="hljs-number">2</span></li><li>    },</li><li>    {</li><li>      <span class="hljs-string">"Address"</span>: <span class="hljs-string">"zhaoliu@xxx.com"</span>,</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"zhaoliu"</span>,</li><li>      <span class="hljs-string">"Type"</span>: <span class="hljs-number">3</span></li><li>    }</li><li>  ],</li><li>  <span class="hljs-string">"to"</span>: [</li><li>    <span class="hljs-string">"lisi"</span></li><li>  ],</li><li>  <span class="hljs-string">"cc"</span>: [</li><li>    <span class="hljs-string">"wangwu"</span></li><li>  ],</li><li>  <span class="hljs-string">"bcc"</span>: [</li><li>    <span class="hljs-string">"zhaoliu"</span></li><li>  ],</li><li>  <span class="hljs-string">"attachment"</span>: [],</li><li>  <span class="hljs-string">"body"</span>: <span class="hljs-string">"优惠政策：\r\n\r\nMate60系列优惠xxx！！ Mate70系列优惠xxx！！。"</span>,</li><li>  <span class="hljs-string">"unread"</span>: <span class="hljs-keyword">false</span></li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section1954214551390">初始化数据库<i class="anchor-icon anchor-icon-link" anchorid="section1954214551390" tips="复制节点链接"></i></h3><p>首先需要构建一个数据库，获取一个RdbStore，其中包括建库、建表、插入数据的操作步骤。</p> <p>1、通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-f#relationalstoregetrdbstore" target="_blank">relationalStore.getRdbStore()</a>接口创建或打开已有关系型数据库。</p> <p>2、通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#execute12" target="_blank">execute()</a>接口执行建表操作，包含id、subject text、content text、image_text text、attachment_names text等字段。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>数据库创建时StoreConfig的enableSemanticIndex需要为true才能触发知识加工。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/SetUp.ets#L26-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">storeName</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"testmail_store.db"</span>;</li><li><span class="hljs-comment">// keep same with the db name in knowledge_schema.json</span></li><li><span class="hljs-variable">storeConfig</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span> = {</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">storeName</span>,</li><li>  <span class="hljs-variable">securityLevel</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">SecurityLevel</span>.<span class="hljs-title class_">S3</span>,</li><li>  <span class="hljs-variable">tokenizer</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">Tokenizer</span>.<span class="hljs-title class_">CUSTOM_TOKENIZER</span>,</li><li>  <span class="hljs-variable">enableSemanticIndex</span>: <span class="hljs-keyword">true</span></li><li>};</li><li><span class="hljs-variable">store</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">RdbStore</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li><span class="hljs-variable">dataIndexNow</span> = <span class="hljs-number">0</span>;</li><li>
</li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">InitTable</span>() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">context</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-variable">get</span>&lt;<span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>&gt;(<span class="hljs-string">"Context"</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">store</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">store</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">relationalStore</span>.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable">context</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">storeConfig</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">store</span> != <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">createTableSql</span> =</li><li>        <span class="hljs-string">"CREATE TABLE IF NOT EXISTS email(id integer primary key, subject text, content text, image_text text,"</span> +</li><li>          <span class="hljs-string">" attachment_names text, inlineFiles text, sender text, toReceivers text, ccReceivers text, "</span> +</li><li>          <span class="hljs-string">"bccReceivers text, received_date text);"</span>;</li><li>      <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">store</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-variable">createTableSql</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">undefined</span>);</li><li>      <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">InsertData</span>(<span class="hljs-variable">context</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">e</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Init</span> <span class="hljs-variable">DB</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">e</span>.<span class="hljs-variable">code</span>},<span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">e</span>.<span class="hljs-variable">message</span>}.`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/SetUp.ets#L26-L54" target="_blank">SetUp.ets</a></div></div></div></div> <p>依次读取原始数据文件，将读出的数据使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-data-relationalstore-rdbstore#execute12" target="_blank">execute()</a>接口插入到新建的数据库中。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/SetUp.ets#L60-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title class_">InsertData</span>(<span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> fileList = context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileListSync</span>(<span class="hljs-string">''</span>);</li><li>  <span class="hljs-keyword">let</span> dataIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataIndexNow</span>;</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> file <span class="hljs-keyword">of</span> fileList) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> rawFileData = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(file);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">fileData</span>: <span class="hljs-built_in">string</span> = buffer.<span class="hljs-title function_">from</span>(rawFileData).<span class="hljs-title function_">toString</span>();</li><li>      <span class="hljs-keyword">const</span> resultObjArr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fileData) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">object</span>&gt;;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">jsonObj</span>: <span class="hljs-built_in">object</span> | <span class="hljs-literal">undefined</span>;</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; resultObjArr.<span class="hljs-property">length</span>; i++) {</li><li>        jsonObj = resultObjArr[i];</li><li>        dataIndex = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">InsertSingleDataJson</span>(jsonObj, <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>, dataIndex)</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Load file failed, code is <span class="hljs-subst">${e.code}</span>,message is <span class="hljs-subst">${e.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataIndexNow</span> = dataIndex;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/SetUp.ets#L60-L93" target="_blank">SetUp.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section29233013420">LLM部署与调用<i class="anchor-icon anchor-icon-link" anchorid="section29233013420" tips="复制节点链接"></i></h2><p>本章节介绍LLM模型的部署和调用，在实际开发过程中可根据业务诉求自行选择LLM大模型进行配置，这里以华为云部署的大模型接入作为参考。</p> </div> <div class="tiledSection"><h3 id="section95311018122" class="firsth2">模型部署<i class="anchor-icon anchor-icon-link" anchorid="section95311018122" tips="复制节点链接"></i></h3><ol><li>进入并登录网址<a href="https://console.huaweicloud.com/modelarts/?locale=zh-cn&amp;region=cn-southwest-2#/model-studio/authmanage" target="_blank">ModelArts - Console</a>，在左侧菜单中选择API Key管理，点击右上角创建API key，生成Key。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>生成的key值只在弹窗中出现一次，请立刻保存后再关闭弹窗。</p> </div></div></div> </li><li>在左侧菜单中选择在线推理，在商用服务列表中开通商用服务Qwen3-235B-A22B-32K。</li><li>在<a href="https://account.huaweicloud.com/usercenter/?agencyId=4a4d3a21c84e4c94b7995314981bf802&amp;region=cn-southwest-2&amp;locale=zh-cn#/userindex/allview" target="_blank">费用中心</a>管理页面进行服务充值。</li></ol> </div> <div class="tiledSection"><h3 id="section199271313181712">模型调用<i class="anchor-icon anchor-icon-link" anchorid="section199271313181712" tips="复制节点链接"></i></h3><p>1、初始化请求，配置请求参数，在header中需要配置生成的API生成的key，extraData中需要传入相关的提问和模型参数，参考<a href="https://support.huaweicloud.com/usermanual-maas-modelarts/maas-modelarts-0011.html" target="_blank">请求参数说明</a>设置frequency_penalty频率奖惩、presence_penalty新词语奖惩、top_p浮点数累计概率控制确保大模型回答偏向简短精准，提升系统的回答速度和准确度。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L22-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">httpRequest</span>: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">HttpRequest</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li><span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">"https://api.modelarts-maas.com/v1/chat/completions"</span>;</li><li><span class="hljs-variable">isFinished</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>
</li><li><span class="hljs-comment">//initialize the llm option</span></li><li><span class="hljs-title function_">initOption</span>(<span class="hljs-variable">question</span>: <span class="hljs-title class_">string</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">option</span>: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">HttpRequestOptions</span> = {</li><li>    <span class="hljs-comment">// request</span></li><li>    <span class="hljs-variable">method</span>: <span class="hljs-title class_">http</span>.<span class="hljs-title class_">RequestMethod</span>.<span class="hljs-title class_">POST</span>,</li><li>    <span class="hljs-variable">header</span>: {</li><li>      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,</li><li>      <span class="hljs-comment">// API-KEY from Model</span></li><li>      <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></li><li>    },</li><li>    <span class="hljs-variable">extraData</span>: {</li><li>      <span class="hljs-string">"stream"</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,</li><li>      <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">10000</span>,</li><li>      <span class="hljs-string">"frequency_penalty"</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3-235b-a22b"</span>,</li><li>      <span class="hljs-string">"top_p"</span>: <span class="hljs-number">0.1</span>,</li><li>      <span class="hljs-string">"presence_penalty"</span>: -<span class="hljs-number">1</span>,</li><li>      <span class="hljs-string">"messages"</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title class_">parse</span>(<span class="hljs-title class_">question</span>)</li><li>    }</li><li>  };</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">option</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L22-L48" target="_blank">LLMHttpUtils.ets</a></div></div></div></div> <p>2、使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-http#requestinstream10-1" target="_blank">requestInStream()</a>根据URL地址和相关配置项，发起HTTP网络请求并返回流式响应。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L52-L58" data-highlighted="yes"><ol class="linenums"><li>async requestInStream(question: string) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.httpRequest === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">this</span>.httpRequest = http.createHttp();</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.httpRequest.requestInStream(<span class="hljs-keyword">this</span>.url, <span class="hljs-keyword">this</span>.initOption(question));</li><li>  <span class="hljs-keyword">this</span>.isFinished = <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L52-L58" target="_blank">LLMHttpUtils.ets</a></div></div></div></div> <p>3、设置监听，订阅HTTP流式响应数据接收事件和HTTP流式响应数据接收完毕事件。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L62-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">on</span>(callback: Callback&lt;ArrayBuffer&gt;, endCallback: Callback&lt;<span class="hljs-keyword">void</span>&gt;) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.httpRequest === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">this</span>.httpRequest = http.createHttp();</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.httpRequest.<span class="hljs-keyword">on</span>(<span class="hljs-string">"dataReceive"</span>, callback);</li><li>  <span class="hljs-keyword">this</span>.httpRequest.<span class="hljs-keyword">on</span>(<span class="hljs-string">'dataEnd'</span>, endCallback);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/common/utils/LLMHttpUtils.ets#L62-L68" target="_blank">LLMHttpUtils.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1939152912915">RAG会话<i class="anchor-icon anchor-icon-link" anchorid="section1939152912915" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section75248344329" class="firsth2">配置会话<i class="anchor-icon anchor-icon-link" anchorid="section75248344329" tips="复制节点链接"></i></h3><p>1、配置知识库加工，如下所示配置resources/rawfile/arkdata/knowledge/knowledge_schema.json文件，倒排表、向量库、向量表将会根据schema配置自动生成。</p> <div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"knowledgeSource"</span>: [{</li><li>    <span class="hljs-string">"version"</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-string">"dbName"</span>: <span class="hljs-string">"testmail_store.db"</span>,</li><li>    <span class="hljs-string">"tables"</span>: [{</li><li>      <span class="hljs-string">"tableName"</span>: <span class="hljs-string">"email"</span>,</li><li>      <span class="hljs-string">"referenceFields"</span>: [<span class="hljs-string">"id"</span>],</li><li>      <span class="hljs-string">"knowledgeFields"</span>: [{</li><li>        <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"subject"</span>,</li><li>        <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Text"</span>]</li><li>      },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"content"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Text"</span>]</li><li>        },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"image_text"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Text"</span>]</li><li>        },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"attachment_names"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Text"</span>]</li><li>        },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"sender"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Scalar"</span>],</li><li>          <span class="hljs-string">"description"</span>: <span class="hljs-string">"sender"</span></li><li>        },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"receivers"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Scalar"</span>],</li><li>          <span class="hljs-string">"description"</span>: <span class="hljs-string">"receivers"</span></li><li>        },</li><li>        {</li><li>          <span class="hljs-string">"columnName"</span>: <span class="hljs-string">"received_date"</span>,</li><li>          <span class="hljs-string">"type"</span>: [<span class="hljs-string">"Scalar"</span>],</li><li>          <span class="hljs-string">"description"</span>: <span class="hljs-string">"received_date"</span></li><li>        }]</li><li>    }]</li><li>  }]</li><li>}</li></ol></pre></div></div> <p>2、构建检索配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-retrieval-api#section95236010016" target="_blank">retrieval.RetrievalConfig</a>，配置向量数据库和倒排索引数据库的参数，并将这些配置绑定到相应的检索通道中，构建了一个用于多数据源检索的配置对象retrievalConfig。这个配置对象可以被后续的检索操作使用，以从指定的数据库中检索数据。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L23-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getRetrievalConfig</span>(): <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalConfig</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">storeConfigVector</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span> = {</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-string">"testmail_store_vector.db"</span>, <span class="hljs-comment">// VectorBase</span></li><li>    <span class="hljs-variable">securityLevel</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">SecurityLevel</span>.<span class="hljs-title class_">S3</span>,</li><li>    <span class="hljs-variable">vector</span>: <span class="hljs-keyword">true</span></li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">storeConfigInvIdx</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span> = {</li><li>    <span class="hljs-variable">name</span>: <span class="hljs-string">"testmail_store.db"</span>, <span class="hljs-comment">// original db is the inverted index db</span></li><li>    <span class="hljs-variable">securityLevel</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">SecurityLevel</span>.<span class="hljs-title class_">S3</span>,</li><li>    <span class="hljs-variable">tokenizer</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">Tokenizer</span>.<span class="hljs-title class_">CUSTOM_TOKENIZER</span></li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">context</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-variable">get</span>&lt;<span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>&gt;(<span class="hljs-string">"Context"</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">common</span>.<span class="hljs-variable">UIAbilityContext</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">channelConfigVector</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelConfig</span> = {</li><li>    <span class="hljs-variable">channelType</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelType</span>.<span class="hljs-title class_">VECTOR_DATABASE</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-title class_">context</span>,</li><li>    <span class="hljs-variable">dbConfig</span>: <span class="hljs-title class_">storeConfigVector</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">channelConfigInvIdx</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelConfig</span> = {</li><li>    <span class="hljs-variable">channelType</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">ChannelType</span>.<span class="hljs-title class_">INVERTED_INDEX_DATABASE</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-title class_">context</span>,</li><li>    <span class="hljs-variable">dbConfig</span>: <span class="hljs-title class_">storeConfigInvIdx</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">retrievalConfig</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalConfig</span> = {</li><li>    <span class="hljs-variable">channelConfigs</span>: [<span class="hljs-variable">channelConfigInvIdx</span>, <span class="hljs-variable">channelConfigVector</span>]</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">retrievalConfig</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L23-L51" target="_blank">Config.ets</a></div></div></div></div> <p>3、配置检索条件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-retrieval-api#section4881955192413" target="_blank">retrieval.RetrievalCondition</a>，从多个数据源（基于逆向索引和向量相似度）召回相关数据，并通过RRF方法对召回结果进行重排，最终返回5条最相关的记录，在信息检索系统中提升召回率和精确率。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L55-L89" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getRetrivalCondition</span>(): <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalCondition</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">recallConditionInvIdx</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">InvertedIndexRecallCondition</span> = {</li><li>    <span class="hljs-variable">ftsTableName</span>: <span class="hljs-string">"email_inverted"</span>,</li><li>    <span class="hljs-variable">fromClause</span>: <span class="hljs-string">"select email_inverted.reference_id as rowid, * from email INNER JOIN email_inverted ON email.id = email_inverted.reference_id"</span>,</li><li>    <span class="hljs-variable">primaryKey</span>: [<span class="hljs-string">"chunk_id"</span>],</li><li>    <span class="hljs-variable">responseColumns</span>: [<span class="hljs-string">"reference_id"</span>, <span class="hljs-string">"chunk_id"</span>, <span class="hljs-string">"chunk_source"</span>, <span class="hljs-string">"chunk_text"</span>, <span class="hljs-string">"subject"</span>, <span class="hljs-string">"image_text"</span>,</li><li>      <span class="hljs-string">"attachment_names"</span>],</li><li>    <span class="hljs-variable">deepSize</span>: <span class="hljs-number">500</span>,</li><li>    <span class="hljs-variable">recallName</span>: <span class="hljs-string">'invertedvectorRecall'</span>,</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">floatArray</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Float32Array</span>(<span class="hljs-number">128</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0.1</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">vectorQuery</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">VectorQuery</span> = {</li><li>    <span class="hljs-variable">column</span>: <span class="hljs-string">"repr"</span>,</li><li>    <span class="hljs-variable">value</span>: <span class="hljs-title class_">floatArray</span>,</li><li>    <span class="hljs-variable">similarityThreshold</span>: <span class="hljs-number">0.1</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">recallConditionVector</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">VectorRecallCondition</span> = {</li><li>    <span class="hljs-variable">vectorQuery</span>: <span class="hljs-title class_">vectorQuery</span>,</li><li>    <span class="hljs-variable">fromClause</span>: <span class="hljs-string">"email_vector"</span>,</li><li>    <span class="hljs-variable">primaryKey</span>: [<span class="hljs-string">"id"</span>],</li><li>    <span class="hljs-variable">responseColumns</span>: [<span class="hljs-string">"reference_id"</span>, <span class="hljs-string">"chunk_id"</span>, <span class="hljs-string">"chunk_source"</span>, <span class="hljs-string">"repr"</span>],</li><li>    <span class="hljs-variable">recallName</span>: <span class="hljs-string">"vectorRecall"</span>,</li><li>    <span class="hljs-variable">deepSize</span>: <span class="hljs-number">500</span></li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rerankMethod</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RerankMethod</span> = {</li><li>    <span class="hljs-variable">rerankType</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RerankType</span>.<span class="hljs-title class_">RRF</span>,</li><li>    <span class="hljs-variable">isSoftmaxNormalized</span>: <span class="hljs-keyword">true</span>,</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">retrievalCondition</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalCondition</span> = {</li><li>    <span class="hljs-variable">rerankMethod</span>: <span class="hljs-title class_">rerankMethod</span>,</li><li>    <span class="hljs-variable">recallConditions</span>: [<span class="hljs-variable">recallConditionInvIdx</span>, <span class="hljs-variable">recallConditionVector</span>],</li><li>    <span class="hljs-variable">resultCount</span>: <span class="hljs-number">5</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">retrievalCondition</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L55-L89" target="_blank">Config.ets</a></div></div></div></div> <p>4、配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1400115191116" target="_blank">LLM会话</a>，在HTTP流式响应数据接收事件中进行数据解析，将问题的答案和是否结束封装在answer中传入回调。此步骤会因大模型的选型受到影响，开发中根据实际选择的大模型进行调整。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/MyChatLlm.ets#L23-L124" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-variable">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyChatLlm</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">rag</span>.<span class="hljs-variable">ChatLLM</span> {</li><li>  <span class="hljs-variable">temp</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">cancel</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-title function_">cancel</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-variable">async</span> <span class="hljs-title function_">streamChat</span>(<span class="hljs-variable">query</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">rag</span>.<span class="hljs-title class_">LLMStreamAnswer</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">rag</span>.<span class="hljs-title class_">LLMRequestInfo</span>&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">rag</span>.<span class="hljs-variable">LLMRequestStatus</span>.<span class="hljs-variable">LLM_SUCCESS</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-title function_">on</span>(</li><li>        <span class="hljs-comment">// data received callback function</span></li><li>        (<span class="hljs-variable">data</span>) =&gt; {</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-variable">isFinished</span>) {</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">decoder</span> = <span class="hljs-variable">util</span>.<span class="hljs-variable">TextDecoder</span>.<span class="hljs-title function_">create</span>(`<span class="hljs-string">"utf-8"</span>`);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">str</span> = <span class="hljs-variable">decoder</span>.<span class="hljs-title function_">decodeToString</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">data</span>));</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">resultStr</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">str</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)[<span class="hljs-number">0</span>];</li><li>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">resultStr</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{"error_code"'</span>)){</li><li>              <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, <span class="hljs-string">'str ='</span> + <span class="hljs-variable">resultStr</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">answer</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">LLMStreamAnswer</span> = {</li><li>                <span class="hljs-variable">isFinished</span>: <span class="hljs-keyword">true</span>,</li><li>                <span class="hljs-variable">chunk</span>: `<span class="hljs-title class_">LLM</span> <span class="hljs-keyword">catch</span> <span class="hljs-title class_">other</span> <span class="hljs-title class_">exception</span>. <span class="hljs-title class_">msg</span>:${<span class="hljs-variable">resultStr</span>}`,</li><li>                <span class="hljs-variable">err</span>:{</li><li>                  <span class="hljs-variable">code</span>: <span class="hljs-number">1021011000</span>,</li><li>                  <span class="hljs-variable">name</span>: `<span class="hljs-title class_">LLM</span> <span class="hljs-keyword">catch</span> <span class="hljs-title class_">other</span> <span class="hljs-title class_">exception</span>`,</li><li>                  <span class="hljs-variable">message</span>: `<span class="hljs-title class_">LLM</span> <span class="hljs-keyword">catch</span> <span class="hljs-title class_">other</span> <span class="hljs-title class_">exception</span>. <span class="hljs-title class_">msg</span>:${<span class="hljs-variable">resultStr</span>}`</li><li>                }</li><li>              }</li><li>              <span class="hljs-keyword">try</span>{</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-variable">obj</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">resultStr</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span>;</li><li>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">obj</span> &amp;&amp; <span class="hljs-variable">obj</span>[<span class="hljs-string">'error_msg'</span>] &amp;&amp; <span class="hljs-variable">obj</span>[<span class="hljs-string">'error_code'</span>] &amp;&amp; <span class="hljs-variable">obj</span>[<span class="hljs-string">'error_msg'</span>] === <span class="hljs-string">'Invalid authorization header.'</span>){</li><li>                  <span class="hljs-variable">answer</span>.<span class="hljs-variable">chunk</span> = `<span class="hljs-variable">LLM</span> <span class="hljs-keyword">catch</span> <span class="hljs-variable">other</span> <span class="hljs-variable">exception</span>. <span class="hljs-variable">msg</span>:${<span class="hljs-variable">obj</span>[<span class="hljs-string">'error_msg'</span>]}`;</li><li>                  <span class="hljs-variable">answer</span>.<span class="hljs-variable">err</span>!.<span class="hljs-variable">message</span> = <span class="hljs-string">'Invalid ChatLLM authorization API key'</span>;</li><li>                }</li><li>              }</li><li>              <span class="hljs-keyword">catch</span>(<span class="hljs-variable">err</span>){</li><li>                <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, <span class="hljs-string">'Parse json failed. String: '</span> + <span class="hljs-variable">resultStr</span>);</li><li>              }</li><li>              <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, <span class="hljs-string">'LLM catch other exception'</span>);</li><li>              <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-variable">isFinished</span> = <span class="hljs-keyword">true</span>;</li><li>              <span class="hljs-title function_">callback</span>(<span class="hljs-variable">answer</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">obj</span> = <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable">resultStr</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>))</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">chunk</span> = <span class="hljs-string">''</span></li><li>            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">obj</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span>)?.[<span class="hljs-string">"choices"</span>].<span class="hljs-variable">length</span> === <span class="hljs-number">0</span>) {</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">obj</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span>)?.[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"delta"</span>][<span class="hljs-string">"reasoning_content"</span>]) {</li><li>              <span class="hljs-variable">chunk</span> = (<span class="hljs-variable">obj</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span>)?.[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"delta"</span>][<span class="hljs-string">"reasoning_content"</span>];</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-variable">chunk</span> = (<span class="hljs-variable">obj</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span>)?.[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"delta"</span>][<span class="hljs-string">"content"</span>];</li><li>            }</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">temp</span> += <span class="hljs-variable">chunk</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">isFinished</span>: <span class="hljs-title class_">boolean</span> = (<span class="hljs-variable">str</span>.<span class="hljs-variable">length</span> &lt; <span class="hljs-number">20</span>);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">answer</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">LLMStreamAnswer</span> = {</li><li>              <span class="hljs-variable">isFinished</span>: <span class="hljs-title class_">isFinished</span>,</li><li>              <span class="hljs-variable">chunk</span>: <span class="hljs-title class_">chunk</span></li><li>            }</li><li>            <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-variable">isFinished</span> = <span class="hljs-variable">isFinished</span>;</li><li>            <span class="hljs-title function_">callback</span>(<span class="hljs-variable">answer</span>);</li><li>          } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>            <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, `<span class="hljs-variable">BusinessError</span>, <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">error</span> <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>          }</li><li>        },</li><li>        <span class="hljs-comment">// data end callback function</span></li><li>        () =&gt; {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-variable">isFinished</span>) {</li><li>            <span class="hljs-keyword">return</span>;</li><li>          }</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">answer</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">LLMStreamAnswer</span> = {</li><li>            <span class="hljs-variable">isFinished</span>: <span class="hljs-keyword">true</span>,</li><li>            <span class="hljs-variable">chunk</span>: <span class="hljs-string">''</span></li><li>          }</li><li>          <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-variable">isFinished</span> = <span class="hljs-keyword">true</span>;</li><li>          <span class="hljs-title function_">callback</span>(<span class="hljs-variable">answer</span>);</li><li>          <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-title function_">end</span>();</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, <span class="hljs-string">'Recv dataEnd callback.'</span>);</li><li>        }</li><li>      );</li><li>      <span class="hljs-variable">LLMHttpUtils</span>.<span class="hljs-title function_">requestInStream</span>(<span class="hljs-variable">query</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'MyChatLlm'</span>, `<span class="hljs-variable">Request</span> <span class="hljs-variable">HuaweiYun</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">error</span> <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span> ===<span class="hljs-number">2300028</span>) {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">rag</span>.<span class="hljs-variable">LLMRequestStatus</span>.<span class="hljs-variable">LLM_TIMEOUT</span>;</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span> === <span class="hljs-number">2300007</span>) {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">rag</span>.<span class="hljs-variable">LLMRequestStatus</span>.<span class="hljs-variable">LLM_LOAD_FAILED</span>;</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span> === <span class="hljs-number">9999999</span>) {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">rag</span>.<span class="hljs-variable">LLMRequestStatus</span>.<span class="hljs-variable">LLM_BUSY</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">rag</span>.<span class="hljs-variable">LLMRequestStatus</span>.<span class="hljs-variable">LLM_REQUEST_ERROR</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> {</li><li>      <span class="hljs-variable">chatId</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">status</span>: <span class="hljs-title class_">ret</span>,</li><li>    };</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/MyChatLlm.ets#L23-L124" target="_blank">MyChatLlm.ets</a></div></div></div></div> <p>5、在完成检索条件、检索配置、LLM会话的配置后，即可配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1033315317182" target="_blank">rag.Config</a>。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L93-L102" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getRAGConfig</span>(): <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">Config</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">retrievalConfig</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalConfig</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getRetrievalConfig</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">retrievalCondition</span>: <span class="hljs-title class_">retrieval</span>.<span class="hljs-title class_">RetrievalCondition</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getRetrivalCondition</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">Config</span> = {</li><li>    <span class="hljs-variable">llm</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">MyChatLlm</span>(),</li><li>    <span class="hljs-variable">retrievalConfig</span>: <span class="hljs-title class_">retrievalConfig</span>,</li><li>    <span class="hljs-variable">retrievalCondition</span>: <span class="hljs-title class_">retrievalCondition</span>,</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">config</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/viewmodel/Config.ets#L93-L102" target="_blank">Config.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section328413693317">开启会话<i class="anchor-icon anchor-icon-link" anchorid="section328413693317" tips="复制节点链接"></i></h3><p>1、使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section14201103320529" target="_blank">rag.createRagSession()</a>接口创建会话，需要传入应用上下文context和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section1033315317182" target="_blank">rag.Config</a>。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L57-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">Config</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">GetConfig</span>();</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">sessionCfg</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">Config</span> = <span class="hljs-variable">config</span>.<span class="hljs-title function_">getRAGConfig</span>();</li><li><span class="hljs-comment">// create the rag session</span></li><li><span class="hljs-variable">rag</span>.<span class="hljs-title function_">createRagSession</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">sessionCfg</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">RagSession</span>) =&gt; {</li><li>  <span class="hljs-variable">AppStorage</span>.<span class="hljs-variable">setOrCreate</span>&lt;<span class="hljs-title class_">rag</span>.<span class="hljs-title class_">RagSession</span>&gt;(<span class="hljs-string">"RagSessionObject"</span>, <span class="hljs-variable">data</span>);</li><li>}).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, `<span class="hljs-variable">createRagSession</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>},<span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}.`);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L57-L64" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>2、使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/dataaugmentation-rag-api#section178721756950" target="_blank">streamRun()</a>接口开始会话，需要传入提问的问题、提问选项和处理的动作，接收返回的字符串进行拼接形成答案。</p> <div class="screenLinkPre"><div _ngcontent-omm-c106="" class="highlight-div"><div _ngcontent-omm-c106="" class="highlight-div-header"><div _ngcontent-omm-c106="" class="highlight-div-header-left"><div _ngcontent-omm-c106="" class="handle-button expand-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-omm-c106="" class="highlight-div-header-right"><div _ngcontent-omm-c106="" class="handle-button ai-button"></div><div _ngcontent-omm-c106="" class="handle-button line-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-omm-c106="" class="handle-button theme-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-omm-c106="" class="handle-button copy-button"><div _ngcontent-omm-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-omm-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/pages/Index.ets#L243-L250" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable">answerTypes</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">rag</span>.<span class="hljs-title class_">StreamType</span>&gt; =</li><li>  [<span class="hljs-variable">rag</span>.<span class="hljs-variable">StreamType</span>.<span class="hljs-variable">THOUGHT</span>, <span class="hljs-variable">rag</span>.<span class="hljs-variable">StreamType</span>.<span class="hljs-variable">REFERENCE</span>, <span class="hljs-variable">rag</span>.<span class="hljs-variable">StreamType</span>.<span class="hljs-variable">ANSWER</span>];</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">option</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">RunConfig</span> = { <span class="hljs-variable">answerTypes</span> }</li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">streamRunStartTime</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Date</span>();</li><li><span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Before</span> <span class="hljs-variable">streamRun</span>, <span class="hljs-variable">time</span>: ${<span class="hljs-keyword">this</span>.<span class="hljs-variable">streamRunStartTime</span>.<span class="hljs-title function_">getTime</span>()}`);</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">ragSession</span>: <span class="hljs-title class_">rag</span>.<span class="hljs-title class_">RagSession</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-variable">get</span>&lt;<span class="hljs-title class_">rag</span>.<span class="hljs-title class_">RagSession</span>&gt;(<span class="hljs-string">"RagSessionObject"</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">rag</span>.<span class="hljs-variable">RagSession</span>;</li><li><span class="hljs-variable">await</span> <span class="hljs-variable">ragSession</span>.<span class="hljs-title function_">streamRun</span>(<span class="hljs-variable">text</span>, <span class="hljs-variable">option</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">onReceived</span>);</li><li><span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">"after streamRun, before responseInStream"</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/RAG_QA/blob/master/entry/src/main/ets/pages/Index.ets#L243-L250" target="_blank">Index.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section12541929482">总结<i class="anchor-icon anchor-icon-link" anchorid="section12541929482" tips="复制节点链接"></i></h2><p>本文介绍了如何使用RAG架构构建问答系统，以提高问答的准确性。在接入RAG架构时，首先需要完成知识库的构建，将原始数据写入数据库中，然后进行LLM的接入，可自由选择大模型，但需要调参以确保回答的准确性和精炼简短，最后按照步骤完成RAG会话的配置与开启。</p> </div> <div class="tiledSection"><h2 id="section13358161254720">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section13358161254720" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/RAG_QA" target="_blank">基于RAG实现智能问答系统</a></li></ul> </div> </div></div>