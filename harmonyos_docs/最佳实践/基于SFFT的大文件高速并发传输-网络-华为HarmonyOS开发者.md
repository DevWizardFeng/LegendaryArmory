<h1 _ngcontent-gcd-c119="" class="doc-title ng-star-inserted" title="基于SFFT的大文件高速并发传输"> 基于SFFT的大文件高速并发传输 </h1>

<div _ngcontent-gcd-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section4967956202911">概述<i class="anchor-icon anchor-icon-link" anchorid="section4967956202911" tips="复制节点链接"></i></h2><p>文件传输（包括上传和下载）是应用程序中极为常见的功能。然而，当应用使用HTTP协议传输长视频、数据集、压缩包等通常超过100MB的大文件时，由于网络不稳定等因素，传输过程可能会耗时较长或直接失败。因此，针对大文件传输的性能优化尤为必要，开发者需要采用特定的策略来确保传输的高效性和可靠性。</p> <p>目前，super_fast_file_trans（以下简称SFFT）库提供了针对大文件传输过程中的多线程下载、分片上传、断点续传、断点续下及自动重试等特性的完整封装，帮助开发者快速实现大文件传输场景，提高开发效率，开发者可参考<a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans" target="_blank">Sample工程</a>进行安装配置与快速上手。下文将以上述SFFT支持的各个特性为例，介绍SFFT的使用。</p> </div> <div class="tiledSection"><h2 id="section71811158133619">多线程下载<i class="anchor-icon anchor-icon-link" anchorid="section71811158133619" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section15405203673820" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section15405203673820" tips="复制节点链接"></i></h3><p>多线程下载是一种通过同时开启多个线程，并行下载文件不同部分的文件传输特性，能够充分利用带宽资源，显著提升下载速度，尤其适用于下载大文件或在网络带宽受限的环境下下载文件。其核心原理是将文件分割为多个小块，由多个线程同时下载这些部分，并发写入到本地文件中，从而实现高效、稳定的下载。</p> <p><span><img height="323.19" originheight="1001" originwidth="1620" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163024.81459717912997876750368258620455:50001231000000:2800:6826E1BF7489F66BC3DA5A73EF0F6B85CA376535C5223596421AA6D0BDACBA83.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section16844104693813">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section16844104693813" tips="复制节点链接"></i></h3><p>SFFT基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool" target="_blank">TaskPool</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp" target="_blank">@kit.RemoteCommunicationKit</a>（后续简称RCP）实现了多线程下载，实现流程如下：</p> <p>当使用多线程下载时：</p> <ol><li>对于每一个下载任务，SFFT都会在正式下载前发送一个“试连”请求。请求使用RCP的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section20139131372817" target="_blank">fetch()</a>接口发送，使用的HTTP请求方法为“HEAD”，该请求仅用于获取文件资源的元数据而不会获取实际文件数据。</li><li>当试连成功后，SFFT会从HEAD请求响应头中的“content-length”字段中获取文件大小，并根据开发者设置的下载策略将远端文件分成包含起始字节和结束字节的若干个数据块。</li><li>对于每一个块，SFFT都会向TaskPool的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskgroup10" target="_blank">TaskGroup</a>中添加一个请求任务，该请求任务请求头中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section838945575618" target="_blank">transferRange</a>字段与文件块中的起始字节和结束字节相对应，在HTTP请求中，transferRange的值会被转为HTTP请求中的Range请求头字段。</li><li>SFFT使用TaskPool的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#taskpoolexecute" target="_blank">taskpool.execute()</a>接口启用多个线程并发执行TaskGroup中的任务，获取服务端文件数据。</li><li>通过指定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section10768169134510" target="_blank">rcp.Request</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section9250173916506" target="_blank">ResponseBodyDestination</a>字段中数据流的写入位置和偏移量，将每个线程请求获取的传输数据并发写入到本地的同一文件中。</li></ol> </div> <div class="tiledSection"><h3 id="section19884173893919">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section19884173893919" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>SFFT三方库使用RCP发送HTTP请求，因此使用了以下权限。权限设置详情参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/remote-communication-preparations#section178884218124" target="_blank">应用权限</a>。</p> <ul><li>ohos.permission.INTERNET：允许应用访问互联网。</li><li>ohos.permission.GET_NETWORK_INFO：允许应用获取数据网络信息。</li></ul> <p>以下代码默认应用已经安装并导入了SFFT三方库，详细的三方库安装教程可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-command-line-tool-13" target="_blank">"如何使用ohpm引入三四方库"</a>。</p> </div></div></div> <ul><li>下载初始化。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L45-L45" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> DownloadManager.getInstance().<span class="hljs-keyword">init</span>(context);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L45-L45" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>开发者开启多线程下载，并指定使用的线程数。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L101-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">downloadConfig</span>: <span class="hljs-title class_">DownloadConfig</span> = {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">url</span>, <span class="hljs-comment">// URL of the remote file.</span></li><li>  <span class="hljs-variable">fileName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">fileName</span>, <span class="hljs-comment">// Local file name.</span></li><li>  <span class="hljs-variable">concurrency</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">concurrency</span>, <span class="hljs-comment">// Number of download threads. The value is an integer ranging from 1 to 8.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>};</li><li><span class="hljs-comment">// Create a download task, with downloadListener specified as an optional callback.</span></li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">downloadInstance</span> = <span class="hljs-variable">DownloadManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">createDownloadTask</span>(<span class="hljs-variable">downloadConfig</span>, <span class="hljs-variable">downloadListener</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">downloadInstance</span>?.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// Enable multi-threaded download.</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L101-L165" target="_blank">DownloadItem.ets</a></div></div></div></div> </li></ul> </div> <ul><li>当开发者未指定下载线程数（concurrency）时，SFFT会根据试连响应中的文件大小信息自动计算启用的线程数。详情可见<a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans" target="_blank">Sample工程</a>。</li></ul> <div class="tiledSection"><h3 id="section1161561794012">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section1161561794012" tips="复制节点链接"></i></h3><p>当使用SFFT进行大文件多线程下载时，下载速率相比于单线程下的普通下载，可以得到明显地提升。</p> <p><span><img height="470.421" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.90353275145008438413687604488192:50001231000000:2800:18F140966F46885C9E13156F780E51F177764AD371F8518E851F0582B3041961.gif" title="点击放大" width="220.183229"></span></p> </div> <div class="tiledSection"><h2 id="section20311257153916">分片上传<i class="anchor-icon anchor-icon-link" anchorid="section20311257153916" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1842488194018" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1842488194018" tips="复制节点链接"></i></h3><p>分片上传是一种将本地大文件分成多个小块（分片）后，分别上传的特性，可提升传输效率并减少网络波动的影响。若某个分片上传失败，只需重传该分片，无需重新上传整个文件。结合断点续传技术，即使传输被中断也能继续上传，确保上传过程的稳定性，特别适合复杂的网络环境。分片上传需要服务端支持将多个小文件合并成完整文件。</p> <p><span><img height="321.195" originheight="752" originwidth="1224" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.48020086407400865221691241895570:50001231000000:2800:F59941129850EC57B96517822B31931C997605597D4C73CF5D1F67E3A0849DBB.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section6424188402">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section6424188402" tips="复制节点链接"></i></h3><p>SFFT基于RCP实现了分片上传，实现步骤如下：</p> <ol><li>对于每一个上传任务，SFFT会先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#fscreatestream" target="_blank">fs.createStream()</a>创建一个基于本地文件路径的文件流。</li><li>根据分片策略，SFFT会将本地文件分成若干个小块（分片），并创建与分片数量对等的Promise请求，每个Promise将计算对应分片在文件中的字节偏移量，使用Stream对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#read" target="_blank">read()</a>接口读取对应的分片数据。</li><li>SFFT控制Promise的并发度，使用RCP的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/remote-communication-rcp#section20139131372817" target="_blank">fetch()</a>接口并发发送上传请求。</li></ol> </div> <div class="tiledSection"><h3 id="section542438174010">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section542438174010" tips="复制节点链接"></i></h3><ul><li>上传初始化。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> UploadManager.getInstance().<span class="hljs-keyword">init</span>(context);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L48" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>开发者主动启用分片上传，并设置了分片大小。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/UploadItem.ets#L100-L152" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">uploadConfig</span>: <span class="hljs-title class_">UploadConfig</span> = {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isChunk</span> ? <span class="hljs-title class_">CONSTANTS_CONFIG</span>.<span class="hljs-title class_">urls</span>.<span class="hljs-title class_">chunkUploadUrl</span> :</li><li>       <span class="hljs-variable">CONSTANTS_CONFIG</span>.<span class="hljs-variable">urls</span>.<span class="hljs-variable">ordinaryUploadUrl</span>, <span class="hljs-comment">// URL of the upload request</span></li><li>  <span class="hljs-variable">filePath</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">filePath</span>, <span class="hljs-comment">// Local file path.</span></li><li>  <span class="hljs-variable">isChunk</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isChunk</span>, <span class="hljs-comment">// Enable chunk upload by setting isChunk to true, which also activates download functionality.</span></li><li>  <span class="hljs-variable">chunkSize</span>: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>, <span class="hljs-comment">// Set chunk size to 10MB. This field is effective only when isChunk is set to true.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>};</li><li><span class="hljs-comment">// Create a upload task, with uploadListener specified as an optional callback.</span></li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span> = <span class="hljs-variable">UploadManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">createUploadTask</span>(<span class="hljs-variable">uploadConfig</span>, <span class="hljs-variable">uploadListener</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span>?.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// Enable chunk upload.</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/UploadItem.ets#L100-L152" target="_blank">UploadItem.ets</a></div></div></div></div> </li></ul> </div> <ul><li>当开发者开启分片上传（isChunk），但并未设置分片大小（chunkSize）时，SFFT会根据本地待上传文件的大小采用默认策略自动计算分片大小，详情可见<a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans" target="_blank">Sample工程</a>。</li></ul> <div class="tiledSection"><h3 id="section82531588409">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section82531588409" tips="复制节点链接"></i></h3><p>当使用SFFT进行大文件分片上传时，上传速率相比于不使用分片上传，可以得到明显地提升。</p> <p><span><img height="469.82250000000005" originheight="716" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.51164259198149686382361713802610:50001231000000:2800:E3A538E20F9AAD01D1CF6C89C033B540CD0130391B89B144ACD9EB2C3C7146CD.gif" title="点击放大" width="219.86895"></span></p> </div> <div class="tiledSection"><h2 id="section141422916414">断点续传/断点续下<i class="anchor-icon anchor-icon-link" anchorid="section141422916414" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section21472944112" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section21472944112" tips="复制节点链接"></i></h3><p>断点续传/断点续下是指在文件下载或上传过程中，因网络中断、程序崩溃等异常导致传输中断后，应用能够从中断处继续传输剩余文件数据的特性。</p> <p>这一特性尤其适用于大文件传输场景。在数据传输过程中，应用会周期性地自动保存断点信息，以应对突发中断。当应用再次恢复到正常运行状态时，即可从本地读取断点信息，继续传输文件的剩余部分。这种传输方式能有效应对网络不稳定的问题，减少因网络波动而造成的传输失败，节省流量消耗，为用户提供流畅、可靠的传输体验。</p> </div> <div class="tiledSection"><h3 id="section1314122944116">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1314122944116" tips="复制节点链接"></i></h3><p><strong>断点续下</strong></p> <p>在SFFT中，断点续下基于上述多线程下载原理，结合关系型数据库<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-relationalstore" target="_blank">RDB</a>实现。</p> <p><span><img height="417.95250000000004" originheight="980" originwidth="1227" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.99322869072975808351943226991775:50001231000000:2800:808016FCEE7816F41474B19A8C315C3619D302C9245E2F88BF11E5B23FCC3C8B.png" title="点击放大" width="523.6875"></span></p> <p>当使用断点续下时：</p> <ol><li>对于每个下载任务，为记录完整的下载任务信息，SFFT会调用RDB接口在本地持久化保存完整的任务信息，任务信息包括：任务ID、下载URL、文件名、下载到的文件路径、使用的线程数等。</li><li>对于每个下载任务，为记录每个线程的下载状况，SFFT会调用RDB接口在本地持久化保存与使用线程数数量相等的“块信息”，每个块信息包括：块ID、对应的任务ID、块序号、该块在完整文件中的起始字节偏移、当前已下载的字节偏移、该块需要下载的完整字节大小等。</li><li>在多线程下载过程中，SFFT会根据实际下载信息周期性地更新上述字段。</li><li>当遇到网络中断或程序崩溃等情况，应用再恢复下载时，SFFT会从RDB数据库读取任务信息和块信息，重新设置每个线程对应请求的transferRange，从断点处继续下载。</li></ol> <p><strong>断点续传</strong></p> <p>在SFFT中，断点续传基于上述分片上传原理，结合RDB实现。</p> <p><span><img height="365.08500000000004" originheight="853" originwidth="1222" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.08304075932455817113472586723391:50001231000000:2800:C31D6A54DDEF0567C6FFDCC049F1731DA8425229A3D57486D82EB473F599C63D.png" title="点击放大" width="523.6875"></span></p> <p>当使用断点续传时：</p> <ol><li>对于每个上传任务，为记录完整的上传任务信息，SFFT会调用RDB接口在本地持久化保存完整的任务信息，任务信息包括：任务ID、上传URL、本地文件路径、文件哈希值、是否启用分片上传、分片大小、未成功上传的分片序号集合等。</li><li>在分片上传过程中，SFFT会根据实际上传信息周期性地更新上述字段。</li><li>当遇到网络中断或程序崩溃等情况，应用再恢复上传时，SFFT会从RDB数据库读取任务信息，遍历还未上传成功的分片序号集合并将这些序号对应的分片数据重新上传。</li></ol> </div> <div class="tiledSection"><h3 id="section1714102974114">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1714102974114" tips="复制节点链接"></i></h3><ul><li>断点续下。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L102-L178" data-highlighted="yes"><ol class="linenums"><li>let downloadConfig: DownloadConfig = {</li><li>  url: <span class="hljs-keyword">this</span>.url, <span class="hljs-comment">// URL of the remote file.</span></li><li>  fileName: <span class="hljs-keyword">this</span>.fileName, <span class="hljs-comment">// Local file name.</span></li><li>  concurrency: <span class="hljs-keyword">this</span>.concurrency, <span class="hljs-comment">// Number of download threads. The value is an integer ranging from 1 to 8.</span></li><li>  isBreakpointResume: <span class="hljs-keyword">this</span>.isResumable, <span class="hljs-comment">// Enable resumable download by setting isBreakpointResume to true.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>};</li><li><span class="hljs-comment">// Create a download task, with downloadListener specified as an optional callback.</span></li><li><span class="hljs-keyword">this</span>.downloadInstance = DownloadManager.getInstance().createDownloadTask(downloadConfig, downloadListener);</li><li><span class="hljs-comment">// ...</span></li><li>await <span class="hljs-keyword">this</span>.downloadInstance?.start(); <span class="hljs-comment">// Enable multi-threaded download.</span></li><li><span class="hljs-comment">// ...</span></li><li>await <span class="hljs-keyword">this</span>.downloadInstance?.pause(); <span class="hljs-comment">// Pause the download manually or through other methods.</span></li><li><span class="hljs-comment">// ...</span></li><li>await <span class="hljs-keyword">this</span>.downloadInstance?.resume(); <span class="hljs-comment">// Resume the download.</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L102-L178" target="_blank">DownloadItem.ets</a></div></div></div></div> </li></ul> </div> <ul><li>断点续传。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/UploadItem.ets#L101-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">uploadConfig</span>: <span class="hljs-title class_">UploadConfig</span> = {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isChunk</span> ? <span class="hljs-title class_">CONSTANTS_CONFIG</span>.<span class="hljs-title class_">urls</span>.<span class="hljs-title class_">chunkUploadUrl</span> :</li><li>       <span class="hljs-variable">CONSTANTS_CONFIG</span>.<span class="hljs-variable">urls</span>.<span class="hljs-variable">ordinaryUploadUrl</span>, <span class="hljs-comment">// URL of the upload request</span></li><li>  <span class="hljs-variable">filePath</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">filePath</span>, <span class="hljs-comment">// Local file path.</span></li><li>  <span class="hljs-variable">isChunk</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isChunk</span>, <span class="hljs-comment">// Enable chunk upload by setting isChunk to true, which also activates download functionality.</span></li><li>  <span class="hljs-variable">chunkSize</span>: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>, <span class="hljs-comment">// Set chunk size to 10MB. This field is effective only when isChunk is set to true.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>};</li><li><span class="hljs-comment">// Create a upload task, with uploadListener specified as an optional callback.</span></li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span> = <span class="hljs-variable">UploadManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">createUploadTask</span>(<span class="hljs-variable">uploadConfig</span>, <span class="hljs-variable">uploadListener</span>);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span>?.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// Enable chunk upload.</span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span>?.<span class="hljs-title function_">pause</span>(); <span class="hljs-comment">// Pause the upload manually or through other methods.</span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">uploadInstance</span>?.<span class="hljs-title function_">resume</span>(); <span class="hljs-comment">// Resume the upload.</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/UploadItem.ets#L101-L165" target="_blank">UploadItem.ets</a></div></div></div></div> </li></ul> <div class="tiledSection"><h3 id="section10141029134115">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section10141029134115" tips="复制节点链接"></i></h3><p>当使用SFFT进行大文件传输时，文件能从应用退出时的传输断点处重新传输。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.19.3.1.3.1.1" valign="top" width="50%"><p>断点续下</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.19.3.1.3.1.2" valign="top" width="50%"><p>断点续传</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p><span><img height="453.93924100000004" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.01212091204421326260726038734837:50001231000000:2800:F0BADBB5B470E02A08B1F1C240F652DB072BA7F6D9E810554F77C310D7F942D2.gif" title="点击放大" width="212.4675"></span></p> </td> <td class="cellrowborder" valign="top" width="50%"><p><span><img height="453.92833500000006" originheight="716" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163025.96563171680162107421731537531407:50001231000000:2800:DE31451E0CDBA9AF97E3C4546850C1748B78EBC8BE763DC8C02277992F689070.gif" title="点击放大" width="212.4675"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section745192124313">自动重连<i class="anchor-icon anchor-icon-link" anchorid="section745192124313" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section11250192244312" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section11250192244312" tips="复制节点链接"></i></h3><p>自动重连是指当文件传输失败时，应用根据异常类型自动尝试重新连接服务端，并继续传输文件数据的特性，目的是为了减少异常情况下的人工干预，确保任务顺利完成。该特性需要断点续下或断点续传支持。</p> </div> <div class="tiledSection"><h3 id="section9250162204310">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section9250162204310" tips="复制节点链接"></i></h3><p>当使用自动重连时：</p> <ul><li>若在文件传输时遇到网络波动、服务器宕机等导致传输中断的状况，SFFT会自动捕捉到异常。</li><li>根据异常的类型，SFFT会自动判断是否需要自动重连，并根据开发者设置的重试间隔、重试次数，周期性地尝试发起连接请求，从断点处继续传输。</li></ul> </div> <div class="tiledSection"><h3 id="section7250162218432">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section7250162218432" tips="复制节点链接"></i></h3><ul><li>以文件下载为例，下面的代码使用了自动重连特性。在下载失败时，将自动尝试进行3次重连，重连间隔为2000毫秒。<div class="screenLinkPre"><div _ngcontent-gcd-c106="" class="highlight-div"><div _ngcontent-gcd-c106="" class="highlight-div-header"><div _ngcontent-gcd-c106="" class="highlight-div-header-left"><div _ngcontent-gcd-c106="" class="handle-button expand-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gcd-c106="" class="highlight-div-header-right"><div _ngcontent-gcd-c106="" class="handle-button ai-button"></div><div _ngcontent-gcd-c106="" class="handle-button line-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gcd-c106="" class="handle-button theme-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gcd-c106="" class="handle-button copy-button"><div _ngcontent-gcd-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gcd-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L103-L119" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">downloadConfig</span>: <span class="hljs-title class_">DownloadConfig</span> = {</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">url</span>, <span class="hljs-comment">// URL of the remote file.</span></li><li>  <span class="hljs-variable">fileName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">fileName</span>, <span class="hljs-comment">// Local file name.</span></li><li>  <span class="hljs-variable">concurrency</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">concurrency</span>, <span class="hljs-comment">// Number of download threads. The value is an integer ranging from 1 to 8.</span></li><li>  <span class="hljs-variable">isBreakpointResume</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isResumable</span>, <span class="hljs-comment">// Enable resumable download by setting isBreakpointResume to true.</span></li><li>  <span class="hljs-variable">maxRetries</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// Set the maximum retry attempts to 3.</span></li><li>  <span class="hljs-variable">retryInterval</span>: <span class="hljs-number">2000</span>, <span class="hljs-comment">// Set the retry interval to 2000 ms.</span></li><li>  <span class="hljs-comment">// ...</span></li><li>};</li><li><span class="hljs-comment">// Create a download task, with downloadListener specified as an optional callback.</span></li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">downloadInstance</span> = <span class="hljs-variable">DownloadManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">createDownloadTask</span>(<span class="hljs-variable">downloadConfig</span>, <span class="hljs-variable">downloadListener</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans/blob/master/entry/src/main/ets/components/DownloadItem.ets#L103-L119" target="_blank">DownloadItem.ets</a></div></div></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section625072214313">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section625072214313" tips="复制节点链接"></i></h3><p>当使用SFFT进行大文件传输时，应用能在网络条件恢复时自动重新连接。</p> <p><span><img height="450.471" originheight="716" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.97001193198883205903106133143068:50001231000000:2800:A4A9704EC071BDFD718B729D638A84CE8DB082D9BAF084C089A90E73DED8725F.gif" title="点击放大" width="210.810719"></span></p> </div> <div class="tiledSection"><h2 id="section959811215442">服务端要求<i class="anchor-icon anchor-icon-link" anchorid="section959811215442" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section5209430445" class="firsth2">下载文件<i class="anchor-icon anchor-icon-link" anchorid="section5209430445" tips="复制节点链接"></i></h3><p>SFFT依赖服务端支持实现多线程下载，因此服务端需满足以下要求：</p> <ol><li>服务端支持HEAD请求。</li><li>服务端必须支持HTTP协议中的Range请求头，支持分块下载。该字段允许客户端在请求中指定所需数据块的字节范围，而非一次性获取整个文件。</li></ol> </div> <div class="tiledSection"><h3 id="section52034312441">上传文件<i class="anchor-icon anchor-icon-link" anchorid="section52034312441" tips="复制节点链接"></i></h3><p>SFFT依赖服务端支持实现分片下载，因此服务端需满足以下要求：</p> <ol><li>服务端必须支持“multipart/form-data”类型的请求，这种格式允许文件数据与其他表单数据在同一个HTTP请求中同时上传。</li><li>服务端需要具备接收并解析分片数据的能力，能够准确提取上传请求中的表单数据（如分片内容、分片信息等），并将这些数据保存到指定的存储位置。此外，服务端还需确保分片数据的完整性和顺序性，以便能够正确合并还原为完整的文件。</li></ol> </div> <div class="tiledSection"><h2 id="section98961205459">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section98961205459" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/SuperFastFileTrans" target="_blank">基于SFFT的大文件高速并发传输</a></li></ul> </div> </div></div>