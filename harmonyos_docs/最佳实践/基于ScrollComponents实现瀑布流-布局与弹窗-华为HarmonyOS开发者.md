<h1 _ngcontent-qom-c119="" class="doc-title ng-star-inserted" title="基于ScrollComponents实现瀑布流"> 基于ScrollComponents实现瀑布流 </h1>

<div _ngcontent-qom-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section6689191185712">概述<i class="anchor-icon anchor-icon-link" anchorid="section6689191185712" tips="复制节点链接"></i></h2><p>瀑布流是应用开发中常见的开发场景。通过容器的布局规则，将元素自上而下排列，形成多列不齐的界面，内容像瀑布一样从上而下倾泻。</p> <p>瀑布流适用于展示图片资讯、购物商品、直播视频等多种数据。当瀑布流上下滑动时，无限加载特性使其能展示大量数据；不同大小的子元素会带来测量和绘制的性能消耗。本文通过跨页面复用、加速首屏渲染、无限滑动、下拉刷新、上拉加载等场景，介绍ScrollComponents库创建高流畅滑动的瀑布流页面。</p> <p>ScrollComponents作为高性能滑动解决方案，主要解决组件复用的问题，支持通过少量的代码实现高性能滑动，同时开发者无需关注复用池管理和其他性能优化方案的交互细节。可以参考<a href="https://gitcode.com/openharmony-sig/scroll_components/blob/master/README.md#快速开始" target="_blank">ScrollComponents使用说明</a>进行安装配置与快速上手。ScrollComponents框架提供了下列功能特性：</p> <ul><li>支持WaterFlow页面的流畅滑动</li><li>默认支持懒加载，开发者不用使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-rendering-control-lazyforeach" target="_blank">LazyForEach</a>和定义IDataSource数据源，减少一定的代码量</li><li>支持组件复用，解决滑动丢帧，提升滑动性能</li><li>支持复用池共享，满足跨页面跨父组件复用能力</li><li>支持预创建，减少冷启动首次滑动丢帧，提升滑动性能</li><li>支持预加载，滑动过程提前加载数据，提升浏览体验</li></ul> <p>ScrollComponents三方库基于系统<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#nodeadapter12" target="_blank">NodeAdapter</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode" target="_blank">BuilderNode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode" target="_blank">FrameNode</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-prefetcher" target="_blank">Prefetcher</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-framecallback" target="_blank">FrameCallback</a>的能力，通过高效率组件复用、组件分帧预创建、内容动态预创建、懒加载等方式，实现高性能滑动。同时基于系统FrameNode创建WaterFlow组件的能力，提供了WaterFlowManager接口支持瀑布流页面渲染，为开发者提供WaterFlow组件的其他各种能力，在满足开发者正常开发的前提下简化用法，便于后续能力扩展。</p> </div> <div class="tiledSection"><h2 id="section9826204316336">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section9826204316336" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1090854153314" class="firsth2">关键技术<i class="anchor-icon anchor-icon-link" anchorid="section1090854153314" tips="复制节点链接"></i></h3></div> <p>ScrollComponents三方库底层封装NodeContainer+FrameNode，结合NodeAdapter+BuilderNode+自定义复用池实现懒加载、组件复用、组件预创建等能力，同时为开发者提供WaterFlowManager视图管理组件，为开发者提供系统滑动组件的其他各种能力，在满足开发者正常开发的前提下提供高性能的滑动能力，只需传入数据源和viewManager即可快速实现懒加载和组件复用的开发，可以更加聚焦业务实现。</p> <p>如图1是RecyclerView整体流程图，当节点从可视区移除时，NodeAdapter会通知视图管理器将组件回收，经NodeFactory回收处理之后，组件最终被存入到组件复用池。当节点需要创建时，NodeAdapter通知视图管理器开始创建，NodeFactory会向复用池请求复用节点，获取到节点之后经过一系列更新组件、组件拼接之后返回，最后由NodeAdapter将节点添加到可视区。</p> <div class="fignone"><span class="figcap"><b>图1 </b>RecyclerView整体流程图</span><br><span><img height="217.86730000000003" originheight="827" originwidth="2011" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162917.76854737751118338331868447769167:50001231000000:2800:91B3983959923A20870070BED10BB2181D8765932C4C68CE36AC8C9FE4B1094F.png" title="点击放大" width="532"></span></div> <div class="tiledSection"><h3 id="section16640155348">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section16640155348" tips="复制节点链接"></i></h3><ol><li>创建瀑布流视图管理器。<p>WaterFlowManager仅具备基础的视图能力，开发者需自定义一个继承自WaterFlowManager的类，可以实现onWillCreateItem()方法，从复用池获取组件，开启复用能力，具体参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-based-on-scrollcomponents#li18448145318540">复用子节点模板</a>。</p> <p>创建视图管理器的实例对象中，defaultNodeItem属性表示默认节点模板名称，context属性表示UI上下文。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L18-L177" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">NodeItem</span>, <span class="hljs-variable">RecyclerView</span>, <span class="hljs-variable">WaterFlowManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hadss/scroll_components'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWaterFlowManager</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">WaterFlowManager</span> {</li><li>  <span class="hljs-title function_">onWillCreateItem</span>(<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">data</span>: <span class="hljs-title class_">BlogData</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">StandardWaterFlowPage</span> {</li><li>  <span class="hljs-variable">waterFlowView</span>: <span class="hljs-title class_">MyWaterFlowManager</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyWaterFlowManager</span>({</li><li>    <span class="hljs-variable">defaultNodeItem</span>: <span class="hljs-string">'StandardGridImageContainer'</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>()</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L18-L177" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果开发者想通过ScrollComponents快速创建瀑布流，方便使用懒加载、预创建等提升滑动效率的能力，而不考虑组件复用，则直接使用ScrollComponents库提供的WaterFlowManager创建瀑布流视图管理器即可。具体可参考<a href="https://gitcode.com/openharmony-sig/scroll_components/blob/master/README.md#快速开始" target="_blank">ScrollComponents使用说明-快速开始</a>。</p> </div></div></div> </li><li>WaterFlow组件初始化<p>页面初始化时，开发者通过视图管理器的setViewStyle()方法，给瀑布流组件视设置属性。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L135-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span> })</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_HEIGHT</span>)</li><li>  .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">WATER_FLOW_COLUMNS_TEMPLATE</span>)</li><li>  .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">COLUMNS_GAP</span>)</li><li>  .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">ROWS_GAP</span>)</li><li>  .<span class="hljs-title function_">padding</span>({</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>  })</li><li>  .<span class="hljs-title function_">fadingEdge</span>(<span class="hljs-keyword">true</span>, { <span class="hljs-variable">fadingEdgeLength</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">vp</span>(<span class="hljs-number">80</span>) })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L135-L145" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> <p></p> </li><li>设置数据源渲染组件<ol><li>通过视图管理器的setDataSource()方法设置数据。ScrollComponents库默认支持懒加载，提供了基于懒加载的数据增删改查能力，开发者无需关心LazyForEach的使用限制，无需定义DataSource，引入即用。懒加载接口可参考：<a href="https://gitcode.com/openharmony-sig/scroll_components/blob/master/docs/Reference.md#lazynodeadapter-类" target="_blank">基于NodeAdapter为视图管理器提供懒加载能力</a>。</li><li>通过视图管理器的registerNodeItem方法注册item子节点模板，需要传入模板名称和子节点@Builder构造函数。</li><li>ScrollComponents提供了视图占位组件 RecyclerView，RecyclerView绑定视图容器实例即可渲染瀑布流列表。</li></ol> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L17-L188" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">NodeItem</span>, <span class="hljs-variable">RecyclerView</span>, <span class="hljs-variable">WaterFlowManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hadss/scroll_components'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">StandardWaterFlowPage</span> {</li><li>  <span class="hljs-variable">waterFlowView</span>: <span class="hljs-title class_">MyWaterFlowManager</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyWaterFlowManager</span>({</li><li>    <span class="hljs-variable">defaultNodeItem</span>: <span class="hljs-string">'StandardGridImageContainer'</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>()</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">dataArray</span>: <span class="hljs-title class_">BlogData</span>[] = [] <span class="hljs-comment">// Bind data source for data iteration</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-title function_">generateRandomBlogData</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">BlogData</span>[]) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setDataSource</span>(<span class="hljs-variable">data</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataArray</span> = <span class="hljs-variable">data</span>;</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">registerNodeItem</span>(<span class="hljs-string">'StandardGridImageContainer'</span>, <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">StandardGridImageContainer</span>));</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-title function_">RecyclerView</span>({</li><li>        <span class="hljs-variable">viewManager</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">waterFlowView</span></li><li>      })</li><li>
</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_HEIGHT</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.home_background_color'</span>))</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// Define an item template</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">StandardGridImageContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">GridImageView</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L17-L188" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1. 注册子节点模板registerNodeItem()方法中使用的@Builder函数目前仅支持全局定义。</p> <p>2. 开发者如果使用this.waterFlowView.preCreate()实现组件预创建，则需要在registerNodeItem()方法注册节点模板后使用。</p> </div></div></div> </li><li id="li18448145318540">复用子节点模板<div class="p">开发者自定义模板后，在定义瀑布流视图管理器时需要实现onWillCreateItem接口，并在此接口中通过dequeueReusableNodeByType()获取可复用node，实现组件复用，同时也需要在复用组件的aboutToReuse生命期中，对数据进行更新。<ol><li>列表项结构类型相同<p>如果复用的FlowItem组件结构相同，直接注册节点模板。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L35-L189" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWaterFlowManager</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">WaterFlowManager</span> {</li><li>  <span class="hljs-title function_">onWillCreateItem</span>(<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">data</span>: <span class="hljs-title class_">BlogData</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">node</span>: <span class="hljs-title class_">NodeItem</span>&lt;<span class="hljs-title class_">Params</span>&gt; | <span class="hljs-title class_">null</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">dequeueReusableNodeByType</span>(<span class="hljs-string">'StandardGridImageContainer'</span>);</li><li>    <span class="hljs-variable">node</span>?.<span class="hljs-title function_">setData</span>({ <span class="hljs-variable">blogItem</span>: <span class="hljs-title class_">data</span> });</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">node</span>;</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">StandardWaterFlowPage</span> {</li><li>  <span class="hljs-variable">waterFlowView</span>: <span class="hljs-title class_">MyWaterFlowManager</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyWaterFlowManager</span>({</li><li>    <span class="hljs-variable">defaultNodeItem</span>: <span class="hljs-string">'StandardGridImageContainer'</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>()</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">registerNodeItem</span>(<span class="hljs-string">'StandardGridImageContainer'</span>, <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">StandardGridImageContainer</span>));</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// Define an item template</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">StandardGridImageContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">GridImageView</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L35-L189" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> <p></p> </li><li>列表项内子组件可拆分组合<p>如果复用的FlowItem组件结构基本相同，存在部分差异，比如头部和尾部组件展示相同，中间内容有渲染Text组件或者Image组件，通常需要定义两个不同的@Builder函数与之对应实现复用。在这个场景下，ScrollComponents提供了PartReuse来保证命中组件复用，只需要定义一个@Builder函数。具体可参考<a href="https://gitcode.com/openharmony-sig/scroll_components/blob/master/README.md#列表项内子组件可拆分" target="_blank">组件复用-列表项子组件可拆分</a>。</p> <p>当组件将要被销毁时，会移出视图容器并进入到item复用池。当组件将要被创建时，会向item复用池获取item节点，当item节点和目标节点类型存在差异时，会先将差异部分即PartReuse中的组件回收到对应的组件复用池，然后将目标组件所需要的差异组件从对应组件复用池中取出，并和item节点拼接，成为目标组件，并进入到视图容器中。</p> <div class="fignone"><span class="figcap"><b>图2 </b>可拆分组件复用创建流程图</span><br><span><img height="330.3454" originheight="1034" originwidth="1662" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.09415341692448742672831792639712:50001231000000:2800:6F4E345CC202F11986B4FA3E198B8DDE164C4F0FB88FC022AA1C6C323DA2AA07.png" title="点击放大" width="532"></span></div> <p>开发者可参考图3日志打印"generateItem reuse "表示复用，检验是否复用成功。</p> <div class="fignone"><span class="figcap"><b>图3 </b>日志效果图</span><br><span><img height="127.68" originheight="446" originwidth="1858" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.11089131199942164047691387131024:50001231000000:2800:BF9319474651DB5859A0C8060D56101064F3E314225854AD38B5C5C88E90D48D.png" title="点击放大" width="532"></span></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>日志默认不开启，开启日志需要在WaterFlowManager的初始化方法中设置Config参数，将debug设置为true。</p> </div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L17-L388" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">NodeItem</span>, <span class="hljs-variable">PartReuse</span>, <span class="hljs-variable">RecyclerView</span>, <span class="hljs-variable">WaterFlowManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hadss/scroll_components'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlogItem</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">blogItem</span>: <span class="hljs-title class_">BlogData</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">BlogData</span>()</li><li>
</li><li>  <span class="hljs-comment">// In reusable components, you must use aboutToReuse to update data, just like native recycling.</span></li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">ESObject</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">blogItem</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span>.<span class="hljs-variable">callback</span> = <span class="hljs-variable">undefined</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span>.<span class="hljs-variable">fetchUrl</span> = <span class="hljs-variable">ImageContent</span>.<span class="hljs-variable">EMPTY</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">12</span> }) {</li><li>      <span class="hljs-title function_">HeaderComponent</span>({ <span class="hljs-variable">blogItem</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blogItem</span> })</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span>?.<span class="hljs-variable">content</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-comment">// cache component</span></li><li>        <span class="hljs-title function_">PartReuse</span>({</li><li>          <span class="hljs-keyword">type</span>: <span class="hljs-string">'AdaptiveTextComponent'</span>,</li><li>          <span class="hljs-variable">builder</span>: <span class="hljs-title class_">wrapBuilder</span>(<span class="hljs-title class_">AdaptiveTextComponentContainer</span>),</li><li>          <span class="hljs-variable">data</span>: { <span class="hljs-variable">blogItem</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blogItem</span> }</li><li>        })</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span>?.<span class="hljs-variable">images</span> &amp;&amp; <span class="hljs-keyword">this</span>.<span class="hljs-variable">blogItem</span>.<span class="hljs-variable">images</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">PartReuse</span>({</li><li>          <span class="hljs-keyword">type</span>: <span class="hljs-string">'GridImageViewContainer'</span>,</li><li>          <span class="hljs-variable">builder</span>: <span class="hljs-title class_">wrapBuilder</span>(<span class="hljs-title class_">GridImageViewContainer</span>),</li><li>          <span class="hljs-variable">data</span>: { <span class="hljs-variable">blogItem</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blogItem</span> }</li><li>        })</li><li>      }</li><li>
</li><li>      <span class="hljs-title function_">BottomContent</span>({ <span class="hljs-variable">blogItem</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blogItem</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">AdaptiveTextComponentContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">AdaptiveTextComponent</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">GridImageViewContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">GridImageView</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L17-L388" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </li><li>列表项结构类型不同<p>如果FlowItem结构差异较大，包括布局差异大、差异的组件数量较多、组件类型不同等因素，导致直接复用同一个FlowItem困难，则可定义多个复用模板。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/MultiFlowItemPage.ets#L37-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWaterFlowManager</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">WaterFlowManager</span> {</li><li>  <span class="hljs-title function_">onWillCreateItem</span>(<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">data</span>: <span class="hljs-title class_">BlogData</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">node</span>: <span class="hljs-title class_">NodeItem</span>&lt;<span class="hljs-title class_">Params</span>&gt;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable">node</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">dequeueReusableNodeByType</span>(<span class="hljs-string">'ImageContainer'</span>);</li><li>    } <span class="hljs-keyword">else</span>  {</li><li>      <span class="hljs-variable">node</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">dequeueReusableNodeByType</span>(<span class="hljs-string">'TextContainer'</span>);</li><li>    }</li><li>    <span class="hljs-variable">node</span>?.<span class="hljs-title function_">setData</span>({ <span class="hljs-variable">blogItem</span>: <span class="hljs-title class_">data</span> });</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">node</span>;</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MultiFlowItemPage</span> {</li><li>  <span class="hljs-variable">waterFlowView</span>: <span class="hljs-title class_">MyWaterFlowManager</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyWaterFlowManager</span>({</li><li>    <span class="hljs-variable">defaultNodeItem</span>: <span class="hljs-string">'ImageContainer'</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>()</li><li>  });</li><li>  <span class="hljs-variable">scroller</span>: <span class="hljs-title class_">Scroller</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Scroller</span>();</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">dataArray</span>: <span class="hljs-title class_">BlogData</span>[] = [] <span class="hljs-comment">// Bind data source for data iteration</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initView</span>();</li><li>    <span class="hljs-variable">taskpool</span>.<span class="hljs-title function_">execute</span>(<span class="hljs-variable">generateRandomBlogData</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">ESObject</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataArray</span> = <span class="hljs-variable">data</span>;</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setDataSource</span>(<span class="hljs-variable">data</span>);</li><li>    })</li><li>
</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">registerNodeItem</span>(<span class="hljs-string">'ImageContainer'</span>, <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">ImageContainer</span>));</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">registerNodeItem</span>(<span class="hljs-string">'TextContainer'</span>, <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-variable">TextContainer</span>));</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initView</span>() {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span> })</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">RecyclerView</span>({</li><li>        <span class="hljs-variable">viewManager</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">waterFlowView</span></li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_HEIGHT</span>)</li><li>    .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.home_background_color'</span>))</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// Reusable Image Component Template</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">ImageContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">ImageContainerView</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li><li>
</li><li><span class="hljs-comment">// Reusable Text Component Template</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">TextContainer</span>($$: <span class="hljs-title class_">Params</span>) {</li><li>  <span class="hljs-title function_">TextContainerView</span>({ <span class="hljs-variable">blogItem</span>: $$.<span class="hljs-title class_">blogItem</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/MultiFlowItemPage.ets#L37-L145" target="_blank">MultiFlowItemPage.ets</a></div></div></div></div> </li></ol> </div> </li></ol> </div> <div class="tiledSection"><h2 id="section839174124116">瀑布流跨页面复用场景<i class="anchor-icon anchor-icon-link" anchorid="section839174124116" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1275710814427" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1275710814427" tips="复制节点链接"></i></h3><p>开发者可能存在多个页面间复用WaterFlow，比如Tab栏切换。ScrollComponents提供了全局复用能力。</p> <div class="fignone"><span class="figcap"><b>图4 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.44268958008285317866755419455071:50001231000000:2800:584FC418F1C2F0A7E6C8D7FA9E0D381291106E8A2DADFD17BEF041F30C46FEFF.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section0291821164217">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section0291821164217" tips="复制节点链接"></i></h3><ol><li>定义复用池单例。<p>ScrollComponents默认会生成一个RecycledPool对象，通过定义复用池单例存储该pool对象，提供跨页面使用。以下单例仅做参考，开发者可自行封装。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/common/util/Utils.ets#L17-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecycledPool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hadss/scroll_components'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Utils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">utils_</span>: <span class="hljs-title class_">Utils</span>;</li><li>  <span class="hljs-attr">nodePool</span>: <span class="hljs-title class_">RecycledPool</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/common/util/Utils.ets#L17-L34" target="_blank">Utils.ets</a></div></div></div></div> </li><li>在首个瀑布流页面使用复用池单例保存RecycledPool对象。<p>WaterFlowManager提供getRecyclePool()方法可获取RecyclePool对象，然后存储到全局单例中。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L60-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (Utils.getInstance().nodePool) {</li><li>  <span class="hljs-comment">// Registration Reuse Pool</span></li><li>  <span class="hljs-keyword">this</span>.waterFlowView.registerRecyclePool(Utils.getInstance().nodePool!);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  Utils.getInstance().nodePool = <span class="hljs-keyword">this</span>.waterFlowView.getRecyclePool();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L60-L65" target="_blank">SharedPoolPage.ets</a></div></div></div></div> </li><li>跨页面共享单例中的RecyclePool对象。<p>跨页面使用registerRecyclePool()方法，将全局单例中的RecyclePool对象注册到该页面定义的WaterFlow视图类对象上，实现跨页面不同RecyclerView视图的复用池共享。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolSecondPage.ets#L39-L143" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SharedPoolSecondPage</span> {</li><li>  <span class="hljs-variable">waterFlowView</span>: <span class="hljs-title class_">MyWaterFlowManager</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyWaterFlowManager</span>({</li><li>    <span class="hljs-variable">defaultNodeItem</span>: <span class="hljs-string">'TestBlogItemContainer'</span>,</li><li>    <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>()</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">Utils</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-variable">nodePool</span>) {</li><li>      <span class="hljs-comment">// Registration Reuse Pool</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">registerRecyclePool</span>(<span class="hljs-variable">Utils</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-variable">nodePool</span>!);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">Utils</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-variable">nodePool</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">getRecyclePool</span>();</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolSecondPage.ets#L39-L143" target="_blank">SharedPoolSecondPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section824133210456">瀑布流加速首屏渲染场景<i class="anchor-icon anchor-icon-link" anchorid="section824133210456" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section116714719156" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section116714719156" tips="复制节点链接"></i></h3><p>冷启动后首次打开瀑布流页面，由于页面的图片或者视频等媒体资源过多，出现白屏或者白块，等好几秒才慢慢刷出内容。ScrollComponents库支持组件预创建，能打开页面后瞬间看到文字、图片骨架，减少卡顿。</p> <div class="fignone"><span class="figcap"><b>图5 </b>效果图</span><br><span><img height="553.5327" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.93328718852758759555146628158429:50001231000000:2800:7633F04AC22637FCEA3966ABAF73684FC1890E918DCFC462552A36904AC7DBA8.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section10870190161510">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section10870190161510" tips="复制节点链接"></i></h3><p>通过preCreate()方法对复用模板进行预创建，核心代码参考如下：</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L110-L137" data-highlighted="yes"><ol class="linenums"><li>aboutToAppear(): void {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// register components</span></li><li>  <span class="hljs-keyword">this</span>.waterFlowView.registerNodeItem(<span class="hljs-string">'BlogItemContainer'</span>, wrapBuilder(BlogItemContainer));</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.registerNodeItem(<span class="hljs-string">'AdaptiveTextComponent'</span>, wrapBuilder(AdaptiveTextComponentContainer));</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.registerNodeItem(<span class="hljs-string">'GridImageViewContainer'</span>, wrapBuilder(GridImageViewContainer));</li><li>
</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.preCreate(<span class="hljs-string">'BlogItemContainer'</span>, <span class="hljs-number">30</span>);</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.preCreate(<span class="hljs-string">'AdaptiveTextComponent'</span>, <span class="hljs-number">30</span>);</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.preCreate(<span class="hljs-string">'GridImageViewContainer'</span>, <span class="hljs-number">30</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L110-L137" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section657215331514">性能测试<i class="anchor-icon anchor-icon-link" anchorid="section657215331514" tips="复制节点链接"></i></h3></div> <p>加载相同数据冷启动场景完成时延情况，通过延迟1s模拟冷启动后网络请求场景。</p> <p>@Reusable：网络请求期间主线程大段空闲，请求结束后首屏组件绘帧耗时较长。</p> <div class="fignone"><span class="figcap"><b>图6 </b>@Reusable测试结果</span><br><span><img height="233.41500000000002" originheight="834" originwidth="1869" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.80130907855298881159336187018499:50001231000000:2800:EF1E08B4EDC596121ED28DA911D8539173E8474827C250B52341F03B9A2BEEEC.png" title="点击放大" width="523.6875"></span></div> <p>ScrollComponents：网络请求期间主线程空闲较少，请求结束后首屏组件绘帧耗时较短</p> <div class="fignone"><span class="figcap"><b>图7 </b>ScrollComponents测试结果</span><br><span><img height="233.41500000000002" originheight="834" originwidth="1869" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.64858682750706406261503840781429:50001231000000:2800:4439AE3A1A33C5966EEB283ED41FBDA65BE535A2EF9FAB1A31D2317B8D24CF89.png" title="点击放大" width="523.6875"></span></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>首屏组件创建时间对比表</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.20.2.5.1.1" valign="top" width="25%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.20.2.5.1.2" valign="top" width="25%"><p>冷启动完成时延</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.2.5.1.3" valign="top" width="25%"><p>主线程空闲时间</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.20.2.5.1.4" valign="top" width="25%"><p>首屏组件创建时间</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>ScrollComponents</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>2.5s</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>281ms</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>223ms</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>@Reusable</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>2.8s</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>997ms</p> </td> <td class="cellrowborder" valign="top" width="25%"><p>467ms</p> </td> </tr>  </tbody></table></div> </div> <p>可以看出，ScrollComponents在冷启动场景下，完成时延优于原生@Reusable。整体完成时延优化300ms。</p> <div class="tiledSection"><h2 id="section1277417185618">瀑布流无限滑动场景<i class="anchor-icon anchor-icon-link" anchorid="section1277417185618" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section104191220493" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section104191220493" tips="复制节点链接"></i></h3><p>当瀑布流页面存在大量图片或视频时，下滑到列表最底端，再快速下滑可能会引起“滑动白块”的现象。尤其用户使用大量在线数据，在弱网和快速滑动的情况下，滑动过程中白块现象更明显。</p> <p>为了减少快速滑动过程中网络不好产生的白块，ScrollComponents内置了内容预取能力Prefetcher，支持动态自适应网络状态。通过提前下载图片或资源，确保资源在需要时立即显示，减少白块出现。动态预加载适用于数据请求耗时较长的场景，如滑动列表中包含大量图片资源。</p> <div class="fignone"><span class="figcap"><b>图8 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.76137130272504772713636434957447:50001231000000:2800:C78F64D15F8771D5976D28074756E9604F5E6BA01AE47A2CE9BB5B4F96E430AD.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section25195498">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section25195498" tips="复制节点链接"></i></h3><ol><li>创建组件实例时，注册fetch和cancel回调到视图管理器，并设置数据源。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L114-L121" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Registers the callback that prefetcher invokes when a data referenced by a data source item needs to be fetched.</span></li><li><span class="hljs-keyword">this</span>.waterFlowView.registerFetchCallback(<span class="hljs-keyword">this</span>.fetchCallback);</li><li><span class="hljs-comment">// Registers the callback that prefetcher invokes when a specific fetch should be canceled to avoid wasting system resources, such as network bandwidth.</span></li><li><span class="hljs-keyword">this</span>.waterFlowView.registerCancelCallback(<span class="hljs-keyword">this</span>.cancelCallback);</li><li>taskpool.execute(generateRandomBlogData).then((<span class="hljs-keyword">data</span>: ESObject) =&gt; {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.setDataSource(<span class="hljs-keyword">data</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L114-L121" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </li><li>实现fetchCallback()和cancelCallback()方法。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L223-L250" data-highlighted="yes"><ol class="linenums"><li>fetchCallback: (item: ESObject, fetchId: number) =&gt; Promise&lt;void&gt; = (item: ESObject, fetchId: number) =&gt; {</li><li>  let <span class="hljs-keyword">data</span> = item <span class="hljs-keyword">as</span> BlogData;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.images.length == <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> Promise.resolve();</li><li>  }</li><li>  let url = <span class="hljs-keyword">data</span>.images[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.imageCaches.has(url)) {</li><li>    <span class="hljs-comment">// If cached, skip re-downloading and load the data directly.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.callback) {</li><li>      <span class="hljs-keyword">data</span>.callback(<span class="hljs-keyword">this</span>.imageCaches.<span class="hljs-keyword">get</span>(url));</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">data</span>.fetchUrl = <span class="hljs-keyword">this</span>.imageCaches.<span class="hljs-keyword">get</span>(url) <span class="hljs-keyword">as</span> string</li><li>    }</li><li>    <span class="hljs-keyword">return</span> Promise.resolve();</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.fetches.<span class="hljs-keyword">set</span>(fetchId, <span class="hljs-keyword">data</span>);</li><li>  <span class="hljs-keyword">this</span>.fetchAgent.postMessageWithSharedSendable({</li><li>    type: <span class="hljs-string">'fetch'</span>,</li><li>    cachePath: <span class="hljs-keyword">this</span>.cachePath,</li><li>    url: <span class="hljs-keyword">data</span>.images[<span class="hljs-number">0</span>],</li><li>    fetchId: fetchId</li><li>  });</li><li>  <span class="hljs-keyword">return</span> Promise.resolve();</li><li>}</li><li>cancelCallback: (fetchId: number) =&gt; void = (fetchId: number) =&gt; {</li><li>  <span class="hljs-keyword">this</span>.fetches.delete(fetchId);</li><li>  <span class="hljs-keyword">this</span>.fetchAgent.postMessageWithSharedSendable({ type: <span class="hljs-string">'cancel'</span>, fetchId: fetchId });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L223-L250" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </li><li>监听滑动组件子组件变化事件。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L148-L192" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span></li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onScrollIndex</span>(<span class="hljs-function">(<span class="hljs-params">start: <span class="hljs-built_in">number</span>, end: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (end &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// Call this method when the visible area boundaries change. The prefetcher will start prefetching after the first call to this method in all cases where the autoStart option is not set to false.</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-title function_">visibleAreaChanged</span>(start, end);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li><li>  .<span class="hljs-title function_">onVisibleAreaChange</span>([<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>], <span class="hljs-function">(<span class="hljs-params">isVisible: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {</li><li>    <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">     * By default, the prefetcher begins invoking user code to fetch data with the first call to the visibleAreaChanged method.</span></li><li><span class="hljs-comment">     * Sometimes, this can waste resources because, in practice, onScrollIndex triggers the callback even when the component is not actually visible to the user.</span></li><li><span class="hljs-comment">     * To avoid this, subscribe to the onVisibleAreaChange event.</span></li><li><span class="hljs-comment">     */</span></li><li>    <span class="hljs-keyword">if</span> (isVisible) {</li><li>      <span class="hljs-comment">// Call this method to start prefetching.</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-property">nodeAdapter</span>.<span class="hljs-property">prefetcher</span>?.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// Call this method to stop prefetching. For instance, this should be done if a related component becomes invisible.</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-property">nodeAdapter</span>.<span class="hljs-property">prefetcher</span>?.<span class="hljs-title function_">stop</span>();</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L148-L192" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </li><li>修改数据结构。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L417-L422" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Preload images using prefetch</span></li><li><span class="hljs-built_in">Image</span>(this.fetchUrl)</li><li>  <span class="hljs-selector-class">.sourceSize</span>({ width: <span class="hljs-number">100</span>, height: <span class="hljs-number">100</span> })</li><li>  <span class="hljs-selector-class">.width</span>(CommonConstants.FULL_WIDTH)</li><li>  <span class="hljs-selector-class">.aspectRatio</span>(<span class="hljs-number">1</span>)</li><li>  <span class="hljs-selector-class">.objectFit</span>(ImageFit.Cover)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/CombineWaterFlowPage.ets#L417-L422" target="_blank">CombineWaterFlowPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section113091594918">性能测试<i class="anchor-icon anchor-icon-link" anchorid="section113091594918" tips="复制节点链接"></i></h3><p>中网和弱网下，瀑布流页面使用相同数据上拉加载滑动，ScrollComponents提供的prefetch能力和不使用prefetch能力，时长超过100ms和超过40ms的白块结果如表2：</p> <ul><li>中网：使用ScrollComponents提供prefetch能力的白块率降低10%；</li><li>弱网:  使用ScrollComponents提供prefetch能力的白块率降低17%；</li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>不同网络白块率对比表</caption><tbody><tr><td class="cellrowborder" rowspan="2" valign="top">&nbsp;&nbsp;</td> <td class="cellrowborder" rowspan="2" valign="top"><p>白块加载时长</p> </td> <td class="cellrowborder" colspan="2" valign="top"><p>白块率</p> </td> <td class="cellrowborder" rowspan="2" valign="top"><p>降低值</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>原生</p> </td> <td class="cellrowborder" valign="top"><p>prefetch</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="20%"><p>中网</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>超100ms</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>18.89%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>8.27%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>10.62%</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>超40ms</p> </td> <td class="cellrowborder" valign="top"><p>19.23%</p> </td> <td class="cellrowborder" valign="top"><p>8.47%</p> </td> <td class="cellrowborder" valign="top"><p>10.76%</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="20%"><p>弱网</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>超100ms</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>55.38%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>38.03%</p> </td> <td class="cellrowborder" valign="top" width="20%"><p>17.35%</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>超40ms</p> </td> <td class="cellrowborder" valign="top"><p>55.43%</p> </td> <td class="cellrowborder" valign="top"><p>38.05%</p> </td> <td class="cellrowborder" valign="top"><p>17.38%</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section6590174065618">瀑布流下拉刷新场景<i class="anchor-icon anchor-icon-link" anchorid="section6590174065618" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1785688133116" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1785688133116" tips="复制节点链接"></i></h3><p>下拉刷新是提升用户体验的关键功能，既要保证数据无缝加载，又要维持流畅的交互效果。推荐使用懒加载刷新数据避免媒体资源加载造成UI渲染阻塞。实现逻辑可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-refresh#示例6实现下拉刷新上拉加载更多" target="_blank">实现下拉刷新上拉加载更多</a>。</p> <div class="fignone"><span class="figcap"><b>图9 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.50526112518896641361518671468769:50001231000000:2800:271AD8259C87DA9E12C2EE7C2748E0430BE35D99062467BD88CF71FEFC77DC9E.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section988615169295">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section988615169295" tips="复制节点链接"></i></h3><p>可通过PullToRefresh组件包裹瀑布流页面，实现下拉加载效果。使用onRefresh()方法新增数据。核心代码参考如下：</p> <ol><li>定义刷新监听函数，模拟数据更新。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L125-L128" data-highlighted="yes"><ol class="linenums"><li>generateRandomBlogData().then((<span class="hljs-keyword">data</span>: ESObject) =&gt; {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.setDataSource(<span class="hljs-keyword">data</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L125-L128" target="_blank">SharedPoolPage.ets</a></div></div></div></div> </li><li>将瀑布流页面绑定到PullToRefresh刷新组件上。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L92-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Builder</span></li><li>getWaterFlow() {</li><li>  <span class="hljs-built_in">RecyclerView</span>({</li><li>    viewManager: this.waterFlowView</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L92-L97" target="_blank">SharedPoolPage.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L114-L144" data-highlighted="yes"><ol class="linenums"><li>PullToRefresh({</li><li>  <span class="hljs-keyword">data</span>: $<span class="hljs-keyword">data</span>,</li><li>  scroller: <span class="hljs-keyword">this</span>.scroller,</li><li>  customList: () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.getWaterFlow()</li><li>  },</li><li>  onRefresh: () =&gt; {</li><li>    <span class="hljs-keyword">return</span> new Promise&lt;string&gt;((resolve) =&gt; {</li><li>      resolve(<span class="hljs-string">'刷新成功'</span>);</li><li>      generateRandomBlogData().then((<span class="hljs-keyword">data</span>: ESObject) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;</li><li>        <span class="hljs-keyword">this</span>.waterFlowView.setDataSource(<span class="hljs-keyword">data</span>);</li><li>      });</li><li>    })</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li><li>})</li><li>  .layoutWeight(<span class="hljs-number">1</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L114-L144" target="_blank">SharedPoolPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section3637165915910">瀑布流上拉加载场景<i class="anchor-icon anchor-icon-link" anchorid="section3637165915910" tips="复制节点链接"></i></h2><p>当开发瀑布流页面涉及大量数据，需要进行分页请求时，结合ScrollComponents提供的懒加载能力实现上拉分页加载的效果。</p> <div class="fignone"><span class="figcap"><b>图10 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162918.04466212523019062623155431044864:50001231000000:2800:64D39FF39564193A8DDB096FB49B4FAABEB96A3C29363C81A8A124842ED721DE.gif" title="点击放大" width="266"></span></div> <p>核心代码参考如下：</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L113-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">PullToRefresh</span>({</li><li>  <span class="hljs-attr">data</span>: $data,</li><li>  <span class="hljs-attr">scroller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>,</li><li>  <span class="hljs-attr">customList</span>: <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getWaterFlow</span>()</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-attr">onLoadMore</span>: <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">''</span>);</li><li>      <span class="hljs-title function_">generateRandomBlogData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: ESObject</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-property">nodeAdapter</span>.<span class="hljs-title function_">pushData</span>(data);</li><li>      });</li><li>    })</li><li>  }</li><li>})</li><li>  .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/SharedPoolPage.ets#L113-L145" target="_blank">SharedPoolPage.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>FrameNode创建WaterFlow目前暂不支持设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#waterflowoptions对象说明" target="_blank">footer和footerContent</a>。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section56841857121616">瀑布流长按删除场景<i class="anchor-icon anchor-icon-link" anchorid="section56841857121616" tips="复制节点链接"></i></h2><p>长按时显示删除按钮，点击按钮可以删除对应item。</p> <div class="fignone"><span class="figcap"><b>图11 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.15578632912349042867758364412293:50001231000000:2800:1F8972B817805FDAD401BBFE3E7DB8638D7CD05C11EFDAAC4D136649E8F5D99D.gif" title="点击放大" width="266"></span></div> <ol><li>绑定长按手势。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L206-L240" data-highlighted="yes"><ol class="linenums"><li>Stack() {</li><li>  Image(<span class="hljs-keyword">this</span>.blogItem.images[<span class="hljs-number">0</span>])</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.priorityGesture(</li><li>  GestureGroup(GestureMode.Exclusive,</li><li>    LongPressGesture().onAction(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.showMenu = <span class="hljs-literal">true</span>;</li><li>    }))</li><li>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L206-L240" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> </li><li>从数据源中删除目标数据，删除组件。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L106-L257" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">eventHub</span>.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EVENT_REMOVE_ITEM</span>, <span class="hljs-function">(<span class="hljs-params">blogItem: BlogData</span>) =&gt;</span> {</li><li>
</li><li>  <span class="hljs-keyword">let</span> foundIndex =</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">value: BlogData</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value) ===</li><li>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(blogItem))</li><li>  <span class="hljs-keyword">if</span> (foundIndex !== <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">NOT_FOUND_INDEX</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span> }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-property">nodeAdapter</span>.<span class="hljs-title function_">deleteData</span>(foundIndex)</li><li>    })</li><li>  }</li><li>})</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-title function_">popUpBuilder</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {</li><li>    <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.not_interested_button_text'</span>))</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)</li><li>  .<span class="hljs-title function_">padding</span>(<span class="hljs-number">5</span>)</li><li>  .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)</li><li>  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">eventHub</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EVENT_REMOVE_ITEM</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">blogItem</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">showMenu</span> = <span class="hljs-literal">false</span>;</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L106-L257" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section182616193174">瀑布流分组混合布局场景<i class="anchor-icon anchor-icon-link" anchorid="section182616193174" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19527173911719" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section19527173911719" tips="复制节点链接"></i></h3><p>分组混排瀑布流中，不同区域展示不同的item效果，例如前三个每行一个item，中间每行两个item，每个item保持高度一致，后面的每行两个item，每个item高度不一致。瀑布流分组功能参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-waterflow#分组混合布局" target="_blank">《创建瀑布流：分组混合布局》</a>。</p> <div class="fignone"><span class="figcap"><b>图12 </b>效果图</span><br><span><img height="563.9200000000001" originheight="2274" originwidth="1072" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.02078507621854795569711933564169:50001231000000:2800:706A01EFEFE19E0E85F6E3ED6051FEF6095621B4F051E6B1FA272F7E8F288B20.png" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section661914941715">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section661914941715" tips="复制节点链接"></i></h3><p>需要创建一个瀑布流分组类型WaterFlowSections对象；然后为该对象绑定不同的FlowItem配置信息，可以指定不同的数量、行列数、间距等参数，具体根据 SectionOptions需要自定义。相关代码如下：</p> <ol><li>设置多个SectionOptions。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L108-L141" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">State</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WaterFlowSections</span>();</li><li><span class="hljs-variable">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>  <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">3</span>,</li><li>  <span class="hljs-variable">crossCount</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-variable">columnsGap</span>: <span class="hljs-number">5</span>,</li><li>  <span class="hljs-variable">rowsGap</span>: <span class="hljs-number">10</span>,</li><li>  <span class="hljs-variable">margin</span>: {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">0</span></li><li>  },</li><li>  <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> === <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>;</li><li>    }</li><li>  }</li><li>};</li><li><span class="hljs-variable">twoColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>  <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-variable">onGetItemMainSizeByIndex</span>: () =&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">250</span>;</li><li>  }</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L108-L141" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> </li><li>初始化时为section绑定SectionOptions，并且绑定到WaterFlow上。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L195-L265" data-highlighted="yes"><ol class="linenums"><li>initView() {</li><li>  let sectionOptions: SectionOptions[] = [];</li><li>  let count = <span class="hljs-number">0</span>;</li><li>  let oneOrTwo = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-keyword">this</span>.dataCount) {</li><li>    <span class="hljs-keyword">if</span> (oneOrTwo++ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {</li><li>      sectionOptions.push(<span class="hljs-keyword">this</span>.oneColumnSection);</li><li>      count += <span class="hljs-keyword">this</span>.oneColumnSection.itemsCount;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      sectionOptions.push(<span class="hljs-keyword">this</span>.twoColumnSection);</li><li>      count += <span class="hljs-keyword">this</span>.twoColumnSection.itemsCount;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.sections.splice(-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, sectionOptions);</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.setViewStyle({ scroller: <span class="hljs-keyword">this</span>.scroller, sections: <span class="hljs-keyword">this</span>.sections })</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L195-L265" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> <p></p> </li><li>滚动时更新section。FrameNode创建的WaterFlow组件，在分组section更新之后必须使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#typedframenode12" target="_blank">initialize</a>更新组件，section的更新才会生效。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L211-L254" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onScrollIndex</span>((<span class="hljs-variable">_first</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">last</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">last</span> + <span class="hljs-number">20</span> &gt;= <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-variable">nodeAdapter</span>.<span class="hljs-variable">totalNodeCount</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">dataArray</span>: <span class="hljs-title class_">number</span>[] = [];</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">100</span>; <span class="hljs-title class_">i</span>++) {</li><li>        <span class="hljs-variable">dataArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">i</span>)</li><li>      }</li><li>      <span class="hljs-comment">// update data when the page is scrolling.</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-variable">nodeAdapter</span>.<span class="hljs-title function_">pushData</span>(<span class="hljs-variable">dataArray</span>)</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">newSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>        <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">100</span>,</li><li>        <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>        <span class="hljs-variable">onGetItemMainSizeByIndex</span>: () =&gt; {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// update section</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">sections</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">newSection</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({</li><li>        <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-comment">// it's very important to do initialize that makes section update.</span></li><li>        <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span>,</li><li>      })</li><li>    }</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L211-L254" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section5865334161810">瀑布流滑动吸顶场景<i class="anchor-icon anchor-icon-link" anchorid="section5865334161810" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section5268950181816" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section5268950181816" tips="复制节点链接"></i></h3><p>向上滑动瀑布流，当横向列表组件滑动到顶部，达到吸顶效果时，其下方的瀑布流列表可以继续滑动。</p> <div class="fignone"><span class="figcap"><b>图13 </b>效果图</span><br><span><img height="553.5194" originheight="720" originwidth="346" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.23575578545042484683022187773354:50001231000000:2800:B92BE61902AB0A23BF894B589B64A88ED65B80EBA3BE4A30AC7AB5C65F70DE17.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h3 id="section1554131181911">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1554131181911" tips="复制节点链接"></i></h3><p>在瀑布流分组中为吸顶的部分预留出位置，监听瀑布流滚动事件，吸顶部分基于瀑布流滚动后的偏移量设置位置，让吸顶部分跟随瀑布流一起滚动，吸顶部分到顶后固定不动。</p> <ol><li>设置SectionOptions信息。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L108-L141" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">State</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WaterFlowSections</span>();</li><li><span class="hljs-variable">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>  <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">3</span>,</li><li>  <span class="hljs-variable">crossCount</span>: <span class="hljs-number">1</span>,</li><li>  <span class="hljs-variable">columnsGap</span>: <span class="hljs-number">5</span>,</li><li>  <span class="hljs-variable">rowsGap</span>: <span class="hljs-number">10</span>,</li><li>  <span class="hljs-variable">margin</span>: {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">0</span></li><li>  },</li><li>  <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> === <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>;</li><li>    }</li><li>  }</li><li>};</li><li><span class="hljs-variable">twoColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>  <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>  <span class="hljs-variable">onGetItemMainSizeByIndex</span>: () =&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">250</span>;</li><li>  }</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L108-L141" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> </li><li>初始化时为section绑定SectionOptions，并且绑定到WaterFlow上。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L195-L265" data-highlighted="yes"><ol class="linenums"><li>initView() {</li><li>  let sectionOptions: SectionOptions[] = [];</li><li>  let count = <span class="hljs-number">0</span>;</li><li>  let oneOrTwo = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-keyword">this</span>.dataCount) {</li><li>    <span class="hljs-keyword">if</span> (oneOrTwo++ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {</li><li>      sectionOptions.push(<span class="hljs-keyword">this</span>.oneColumnSection);</li><li>      count += <span class="hljs-keyword">this</span>.oneColumnSection.itemsCount;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      sectionOptions.push(<span class="hljs-keyword">this</span>.twoColumnSection);</li><li>      count += <span class="hljs-keyword">this</span>.twoColumnSection.itemsCount;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.sections.splice(-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, sectionOptions);</li><li>  <span class="hljs-keyword">this</span>.waterFlowView.setViewStyle({ scroller: <span class="hljs-keyword">this</span>.scroller, sections: <span class="hljs-keyword">this</span>.sections })</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L195-L265" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> </li><li>在预留位置中添加吸顶组件，同时渲染FlowItem排除吸顶组件的索引。<div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L203-L399" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onWillScroll</span>((<span class="hljs-variable">offset</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-comment">// Dynamically get the offset position of a waterfall flow</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">scrollOffset</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">scroller</span>.<span class="hljs-title function_">currentOffset</span>().<span class="hljs-variable">yOffset</span> + <span class="hljs-variable">offset</span>;</li><li>  })</li><li>
</li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">TopStart</span> }) {</li><li>    <span class="hljs-title function_">RecyclerView</span>({</li><li>      <span class="hljs-variable">viewManager</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">waterFlowView</span></li><li>    })</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_WIDTH</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>    .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">left</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>, <span class="hljs-variable">right</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span> })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-variable">HitTestMode</span>.<span class="hljs-variable">Transparent</span>)</li><li>    <span class="hljs-comment">// Set the sticky component's offset</span></li><li>    .<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">y</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scrollOffset</span> &gt;= <span class="hljs-number">220</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">220</span> - <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scrollOffset</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StickyWaterFlowPage.ets#L203-L399" target="_blank">StickyWaterFlowPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section16550359142211">瀑布流动态切换列数场景<i class="anchor-icon anchor-icon-link" anchorid="section16550359142211" tips="复制节点链接"></i></h2></div> <p>通过动态调整瀑布流的列数，应用能够实现在列表模式与瀑布流模式间的切换，或适应屏幕宽度的变化。WaterFlow视图是继承FrameNode，需要使用节点的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#typedframenode12" target="_blank">attribute</a>属性修改WaterFlow的属性，具体代码参考如下：</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L69-L148" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">orientation</span> = <span class="hljs-variable">window</span>.<span class="hljs-variable">Orientation</span>.<span class="hljs-variable">AUTO_ROTATION</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowClass</span>.<span class="hljs-title function_">setPreferredOrientation</span>(<span class="hljs-variable">orientation</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">errCode</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">errCode</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set window orientation. Cause:'</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeed to setting window orientation'</span>);</li><li>  })</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowClass</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, (<span class="hljs-variable">size</span>) =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span> = <span class="hljs-variable">size</span>.<span class="hljs-variable">width</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span> = <span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">node</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-variable">__VIEW_CONTROLLER__</span>.<span class="hljs-variable">parentLayout</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">typeNode</span>.<span class="hljs-variable">WaterFlow</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">viewWidth</span> &gt; <span class="hljs-variable">viewHeight</span>) {</li><li>      <span class="hljs-variable">node</span>.<span class="hljs-variable">attribute</span>.<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">node</span>.<span class="hljs-variable">attribute</span>.<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>);</li><li>    }</li><li>  })</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initView</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-title function_">initView</span>() {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span> })</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_HEIGHT</span>)</li><li>    .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">WATER_FLOW_COLUMNS_TEMPLATE</span>)</li><li>    .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">COLUMNS_GAP</span>)</li><li>    .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">ROWS_GAP</span>)</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>      <span class="hljs-variable">left</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>      <span class="hljs-variable">right</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>    })</li><li>    .<span class="hljs-title function_">fadingEdge</span>(<span class="hljs-keyword">true</span>, { <span class="hljs-variable">fadingEdgeLength</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">vp</span>(<span class="hljs-number">80</span>) })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L69-L148" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section417213132418">瀑布流动效场景<i class="anchor-icon anchor-icon-link" anchorid="section417213132418" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section12214121252413" class="firsth2">边缘渐隐效果<i class="anchor-icon anchor-icon-link" anchorid="section12214121252413" tips="复制节点链接"></i></h3><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scrollable-common#fadingedge14" target="_blank">fadingEdge</a>实现了WaterFlow组件开启边缘渐隐效果，并通过fadingEdgeLength参数设置边缘渐隐长度。效果参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#示例5设置边缘渐隐效果" target="_blank">WaterFlow设置边缘渐隐效果</a>。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L135-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">waterFlowView</span>.<span class="hljs-title function_">setViewStyle</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span> })</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FULL_HEIGHT</span>)</li><li>  .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">WATER_FLOW_COLUMNS_TEMPLATE</span>)</li><li>  .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">COLUMNS_GAP</span>)</li><li>  .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">ROWS_GAP</span>)</li><li>  .<span class="hljs-title function_">padding</span>({</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">PADDING</span>,</li><li>  })</li><li>  .<span class="hljs-title function_">fadingEdge</span>(<span class="hljs-keyword">true</span>, { <span class="hljs-variable">fadingEdgeLength</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">vp</span>(<span class="hljs-number">80</span>) })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L135-L145" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section104836132419">删除滑动错位效果<i class="anchor-icon anchor-icon-link" anchorid="section104836132419" tips="复制节点链接"></i></h3><p>在组件删除时添加动画效果<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#animateto" target="_blank">animateTo</a>即可实现删除过渡效果。</p> <div class="screenLinkPre"><div _ngcontent-qom-c106="" class="highlight-div"><div _ngcontent-qom-c106="" class="highlight-div-header"><div _ngcontent-qom-c106="" class="highlight-div-header-left"><div _ngcontent-qom-c106="" class="handle-button expand-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qom-c106="" class="highlight-div-header-right"><div _ngcontent-qom-c106="" class="handle-button ai-button"></div><div _ngcontent-qom-c106="" class="handle-button line-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qom-c106="" class="handle-button theme-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qom-c106="" class="handle-button copy-button"><div _ngcontent-qom-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qom-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L107-L117" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">eventHub</span>.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EVENT_REMOVE_ITEM</span>, <span class="hljs-function">(<span class="hljs-params">blogItem: BlogData</span>) =&gt;</span> {</li><li>
</li><li>  <span class="hljs-keyword">let</span> foundIndex =</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataArray</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">value: BlogData</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value) ===</li><li>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(blogItem))</li><li>  <span class="hljs-keyword">if</span> (foundIndex !== <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">NOT_FOUND_INDEX</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span> }, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">waterFlowView</span>.<span class="hljs-property">nodeAdapter</span>.<span class="hljs-title function_">deleteData</span>(foundIndex)</li><li>    })</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent/blob/master/entry/src/main/ets/pages/StandardWaterFlowPage.ets#L107-L117" target="_blank">StandardWaterFlowPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section8655361258">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section8655361258" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/WaterFlowScrollComponent" target="_blank">流畅滑动瀑布流页面</a></li></ul> </div> </div> <div></div></div>