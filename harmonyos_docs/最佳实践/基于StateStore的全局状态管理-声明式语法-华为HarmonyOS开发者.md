<h1 _ngcontent-axw-c119="" class="doc-title ng-star-inserted" title="基于StateStore的全局状态管理"> 基于StateStore的全局状态管理 </h1>

<div _ngcontent-axw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1524035011510">概述<i class="anchor-icon anchor-icon-link" anchorid="section1524035011510" tips="复制节点链接"></i></h2><p>使用ArkUI开发页面时，多组件状态共享是我们经常会遇到的场景；ArkUI通过装饰器，例如@State+@Prop/@Link、@Provide+@Consume实现父子组件状态共享，但是这样会造成状态数据耦合。</p> <p>作为ArkUI状态与UI解耦的解决方案，支持全局维护状态，优雅地解决状态共享的问题。让开发者在开发过程中实现状态与UI解耦，多个组件可以方便地共享和更新全局状态，将状态管理逻辑从组件逻辑中分离出来，简化维护。</p> <p>StateStore提供了下列功能特性：</p> <ul><li>状态对象与UI解耦，支持状态全局化操作。</li><li>支持在子线程中进行状态对象更新。</li><li>支持状态更新执行的预处理和后处理。</li></ul> </div> <div class="tiledSection"><h2 id="section1251417123214">ArkUI状态管理现状<i class="anchor-icon anchor-icon-link" anchorid="section1251417123214" tips="复制节点链接"></i></h2><p>在多组件状态共享的场景中，我们常常遇到的问题是，当多个组件需要共享相同的状态时，必须通过它们的共同父组件来传递和维护这些状态数据。</p> <p>例如，我们实现如下图待办列表的新增与删除功能。</p> <div class="fignone"><span class="figcap"><b>图1 </b>待办列表效果图</span></div> <p><span><img height="538.946324" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.88993614541872884841324332951188:50001231000000:2800:E798CCF59BE38677ADA7EFE57677A161BC333F5829343FF131C656832197DDE3.png" title="点击放大" width="266.42732900000004"></span></p> <p>新增和删除功能按钮分别位于两个兄弟组件中。在开发时，父组件需要维护一个listDatas列表，并通过@Link装饰器实现数据的双向同步，从而实现兄弟组件之间的状态同步。删除功能和新增功能逻辑分别由两个子组件处理，但是这两个组件都需要引入与UI渲染无关的listDatas数据，造成了状态与UI的高耦合。使得状态管理变得复杂，难以维护和扩展。组件结构图如下：</p> <p><span><img originheight="591" originwidth="282" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.08677684861973268361364361603582:50001231000000:2800:BB2776CB21601A4FF6FBDA5C455E79BF1F3879ED5172E145E23F7C94419EB0CC.png" class="notEnlarge" width="282" height="591"></span></p> <p>引入StateStore库后，开发者可以将listDatas数据存储在全局仓库（Store）中，组件从Store中获取数据进行UI渲染，并通过向Store发送事件来更新数据。这样，状态更新逻辑被集中管理，组件无需额外引入状态进行逻辑处理，从而实现了状态与UI的低耦合。组件结构图如下：</p> <p><span><img originheight="603" originwidth="469" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.87180499454266411787014298368669:50001231000000:2800:B82EDD69E26940FEFA05CD072CF9EE16F1F8885D475F179156A2C282B2559C71.png" width="469" height="603"></span></p> </div> <div class="tiledSection"><h2 id="section28351374215">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section28351374215" tips="复制节点链接"></i></h2><p>StateStore基于ArkUI的状态管理特性（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink" target="_blank">@Observed</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-observedv2-and-trace" target="_blank">@ObservedV2</a>）实现全局状态管理。统一由UI分发事件指令，状态管理仓库触发对应的状态更新逻辑，实现状态与UI解耦。</p> <p>具体步骤如下</p> <p>1. @ObservedV2装饰类实现数据监听</p> <p>2. Store集中管理被观察对象</p> <p>3. 状态变更通过装饰器触发UI更新</p> <div class="fignone"><span class="figcap"><b>图2 </b><strong>运行原理图</strong></span></div> <p><span><img height="507.90040000000005" originheight="569" originwidth="745" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.70168963961729990761720048643363:50001231000000:2800:3AE15FBB393A205D08A98E83D95D8740F698D5338A693E419C9CD9A31FFF4276.png" title="点击放大" width="665"></span></p> <p><strong>核心概念解释</strong></p> </div> <ul><li>View：视图层<p>View构成了用户界面，它包含了丰富的页面UI组件，并响应用户操作。当用户和UI进行交互时，View会通过dispatch方法分发Action事件，从而触发状态更新的流程。</p> </li><li>Store：状态管理仓库<p>Store作为状态管理的核心，主要向外部提供两个关键方法：getState()和dispatch(action)。getState()方法允许外部获取当前的状态信息，而dispatch(action)方法则用于接收并处理来自UI的Action事件。</p> </li><li>Reducer：状态刷新逻辑处理函数<p>Reducer是一个专门负责状态刷新逻辑的函数。它会根据传入的Action事件指令，对状态进行更新。每一个Action事件都携带着特定的指令，Reducer会根据这些指令来精确地修改状态。</p> </li><li>Dispatch：事件分发方法<p>Dispatch是UI侧与Store进行交互的桥梁，也是UI侧触发状态更新的唯一途径。UI侧通过调用Dispatch方法，将封装了事件类型的Action对象发送到Store，从而触发后续的状态更新流程。</p> </li><li>Action：事件描述对象<p>Action是一个用于描述指示发生了何种事件的对象。它包含了两个重要的属性：type和payload。type属性用于标识事件的类型，而payload属性则携带了事件相关的具体数据。通过这两个属性，Action能够完整地描述一个事件，并引导Reducer进行状态更新。</p> </li></ul> <p><strong>UI刷新原理</strong></p> <p>数据改变刷新UI的能力依赖系统侧@Observed/@ObservedV2对数据的观测能力，StateStore不接管数据驱动UI更新。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>以上概念与基本使用参考<a href="https://gitee.com/hadss/StateStore" target="_blank">StateStore</a></p> </div></div></div> <div class="tiledSection"><h2 id="section15809938161519">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section15809938161519" tips="复制节点链接"></i></h2><ol><li><strong>定义业务数据</strong><p>开发者使用@Observed或@ObservedV2修饰业务数据，并生成实例对象。</p> </li><li><strong>定义状态更新逻辑函数</strong><p>开发者需要定义状态处理函数，该函数类型为Reducer。该函数负责根据业务逻辑来更新数据。</p> </li><li><strong>创建状态管理仓库</strong><p>为了集中管理状态更新，开发者使用StateStore.createStore方法来创建一个状态管理仓库（即Store对象）。在调用createStore方法时，需要传入业务数据的对象实例和业务逻辑函数，以便为Store对象绑定相应的<strong>初始状态</strong>和<strong>Reducer</strong>。</p> </li><li><strong>组件UI的初始渲染</strong><p>在组件内部，开发者通过调用Store对象的getState()方法来获取业务数据，并据此编写UI结构。这样，组件即可根据获取到的数据进行渲染。</p> </li><li><strong>组件UI的刷新</strong><ol><li>创建Action事件对象<p>这一步的目的是告诉store对象，你要做什么；例如，我们需要添加某个数据，则创建一个添加事件——AddAction。</p> </li><li>UI触发事件<p>事件定义好后，需要某个操作来触发事件，即我们在UI中通过dispatch(AddAction)发送该添加事件给store，接受到事件后会通知实际处理者——Reducer，根据接受到的AddAction事件处理对应的添加逻辑，修改状态数据。</p> </li><li>UI刷新<p>Reducer类型函数的逻辑被触发后，状态会随之更新。借助系统提供的@Observed或@ObservedV2装饰器的监听能力，UI能够与状态保持同步刷新。</p> </li></ol> </li></ol> </div> <div class="tiledSection"><h2 id="section17495162622316">使用StateStore实现状态与UI解耦<i class="anchor-icon anchor-icon-link" anchorid="section17495162622316" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section55191524240" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section55191524240" tips="复制节点链接"></i></h3><p>在开发复杂应用时，状态与UI的强耦合常常导致代码臃肿、难以维护，尤其是在多个组件需要共享状态时，这种问题尤为突出。使用StateStore，开发者可以将状态管理逻辑完全从UI中抽离，实现状态的集中式管理和更新，进而简化代码结构、提高可维护性。</p> <p>本节以备忘录应用为例，演示如何通过StateStore实现多个组件的状态共享与更新，同时保持UI层的纯粹性。</p> <div class="fignone"><span class="figcap"><b>图3 </b><strong>效果图</strong></span></div> <p><span><img height="507.02632400000005" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.38940679335670189941092888346444:50001231000000:2800:1D31B0426F005B7EA094BBC81CF68E3283CF9E225094603450F67799F7D777E2.png" title="点击放大" width="259.543515"></span></p> </div> <div class="tiledSection"><h3 id="section3354135417256">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section3354135417256" tips="复制节点链接"></i></h3><ol><li>定义页面数据<p>使用@ObservedV2定义页面需要的数据TodoList、TodoItem。</p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L86-L114" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@ObservedV2</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoStoreModel</span> {</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">todoList</span>: <span class="hljs-title class_">TodoItemData</span>[] = [];</li><li>  <span class="hljs-meta">@Trace</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-attr">addTaskTextInputValue</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">uncompletedTodoList</span>(): <span class="hljs-title class_">TodoItemData</span>[] {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todoList</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> !item.<span class="hljs-property">selected</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Computed</span></li><li>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">completedTodoList</span>(): <span class="hljs-title class_">TodoItemData</span>[] {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todoList</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">selected</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L86-L114" target="_blank">TodoListModel.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L19-L48" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">ObservedV2</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoItemData</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">Trace</span> <span class="hljs-variable">taskDetail</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">Trace</span> <span class="hljs-variable">selected</span>?: <span class="hljs-title class_">boolean</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">taskDetail</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">selected</span>?: <span class="hljs-title class_">boolean</span>, <span class="hljs-variable">id</span>?: <span class="hljs-title class_">number</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">id</span> = <span class="hljs-variable">id</span> ? <span class="hljs-variable">id</span> : <span class="hljs-title class_">Date</span>.<span class="hljs-title class_">now</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">taskDetail</span> = <span class="hljs-variable">taskDetail</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">selected</span> = <span class="hljs-variable">selected</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L19-L48" target="_blank">TodoListModel.ets</a></div></div></div></div> </li><li>创建状态管理仓库<ul><li>定义状态更新事件类型Action<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListActions.ets#L19-L36" data-highlighted="yes"><ol class="linenums"><li>export default class TodoListActions {</li><li>  static getTodoList: Action = StateStore.<span class="hljs-built_in">createAction</span>(<span class="hljs-string">'getTodoList'</span>);</li><li>  static addTodoList: Action = StateStore.<span class="hljs-built_in">createAction</span>(<span class="hljs-string">'addTodoList'</span>);</li><li>  static deleteTodoItem: Action = StateStore.<span class="hljs-built_in">createAction</span>(<span class="hljs-string">'deleteTodoItem'</span>);</li><li>  static updateTaskDetail: Action = StateStore.<span class="hljs-built_in">createAction</span>(<span class="hljs-string">'updateTaskDetail'</span>);</li><li>  static completeTodoItem: Action = StateStore.<span class="hljs-built_in">createAction</span>(<span class="hljs-string">'completeTodoItem'</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListActions.ets#L19-L36" target="_blank">TodoListActions.ets</a></div></div></div></div> </li><li>定义状态处理函数TodoReducer<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListReducer.ets#L26-L168" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">todoReducer</span>: <span class="hljs-title class_">Reducer</span>&lt;<span class="hljs-title class_">TodoStoreModel</span>&gt; = <span class="hljs-function">(<span class="hljs-params">state: TodoStoreModel, action: Action</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">GlobalContent</span> = <span class="hljs-title class_">GlobalContext</span>.<span class="hljs-title function_">getInstance</span>();</li><li>  uiContext = <span class="hljs-title class_">GlobalContent</span>.<span class="hljs-title function_">getUIContext</span>()</li><li>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">getTodoList</span>.<span class="hljs-property">type</span>:</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> () =&gt; {</li><li>        state.<span class="hljs-property">todoList</span> = (<span class="hljs-keyword">await</span> <span class="hljs-title class_">RdbUtil</span>.<span class="hljs-title function_">getInstance</span>(uiContext?.<span class="hljs-title function_">getHostContext</span>()!)).<span class="hljs-title function_">query</span>();</li><li>      };</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">addTodoList</span>.<span class="hljs-property">type</span>:</li><li>      <span class="hljs-keyword">if</span> (state.<span class="hljs-property">addTaskTextInputValue</span> === <span class="hljs-string">''</span>) {</li><li>        uiContext!.<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: $r(<span class="hljs-string">'app.string.empty'</span>) });</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>      }</li><li>      state.<span class="hljs-property">todoList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoItemData</span>(state.<span class="hljs-property">addTaskTextInputValue</span>));</li><li>      state.<span class="hljs-property">isShow</span> = <span class="hljs-literal">false</span>;</li><li>      state.<span class="hljs-property">addTaskTextInputValue</span> = <span class="hljs-string">''</span>;</li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">deleteTodoItem</span>.<span class="hljs-property">type</span>:</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">updateTaskDetail</span>.<span class="hljs-property">type</span>:</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">completeTodoItem</span>.<span class="hljs-property">type</span>:</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">break</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListReducer.ets#L26-L168" target="_blank">TodoListReducer.ets</a></div></div></div></div> </li><li>创建状态管理仓库<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListStore.ets#L22-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TODO_LIST_STORE_ID</span> = <span class="hljs-string">'todoListStore'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TodoStore</span>: <span class="hljs-title class_">Store</span>&lt;<span class="hljs-title class_">TodoStoreModel</span>&gt; =</li><li>  <span class="hljs-title class_">StateStore</span>.<span class="hljs-title function_">createStore</span>(<span class="hljs-variable constant_">TODO_LIST_STORE_ID</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoStoreModel</span>(), todoReducer, [<span class="hljs-title class_">LogMiddleware</span>]);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListStore.ets#L22-L26" target="_blank">TodoListStore.ets</a></div></div></div></div> </li></ul> </li><li>在UI中使用<ul><li>通过getState()拿到Store中的状态数据。</li><li>使用dispatch()派发一个状态更新事件来刷新UI。</li></ul> <p>如下例子中：Index组件内，通过getState()方法获取状态数据并绑定UI，通过dispatch触发GetTodoList事件获取全量数据并更新状态；TodoItem子组件中通过dispatch方法派发一个CompleteTodoItem事件来改变全局状态，将当前项设置为已完成。</p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/pages/Index.ets#L26-L168" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">ComponentV2</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  @<span class="hljs-title function_">Local</span> <span class="hljs-variable">viewModel</span>: <span class="hljs-title class_">TodoStoreModel</span> = <span class="hljs-variable">TodoStore</span>.<span class="hljs-title function_">getState</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// The dispatch triggers a GetTodoList event to get the full data and update the status</span></li><li>    <span class="hljs-variable">TodoStore</span>.<span class="hljs-title function_">dispatch</span>(<span class="hljs-variable">TodoListActions</span>.<span class="hljs-variable">getTodoList</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">viewModel</span>.<span class="hljs-variable">todoList</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-title function_">List</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">12</span> }) {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">viewModel</span>.<span class="hljs-variable">uncompletedTodoList</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-title function_">ListItemGroup</span>({ <span class="hljs-variable">header</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">todayGroupHeader</span>(), <span class="hljs-variable">space</span>: <span class="hljs-number">12</span> }) {</li><li>              <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">viewModel</span>.<span class="hljs-variable">uncompletedTodoList</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">TodoItemData</span>) =&gt; {</li><li>                <span class="hljs-title function_">ListItem</span>() {</li><li>                  <span class="hljs-title function_">TodoItem</span>({ <span class="hljs-variable">itemData</span>: <span class="hljs-title class_">item</span> });</li><li>                };</li><li>              }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">TodoItemData</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>.<span class="hljs-title function_">toString</span>());</li><li>            };</li><li>          }</li><li>          <span class="hljs-comment">// ...</span></li><li>        }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>);</li><li>
</li><li>        <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/pages/Index.ets#L26-L168" target="_blank">Index.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/components/TodoItem.ets#L21-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@ComponentV2</span></li><li>export struct TodoItem {</li><li>  <span class="hljs-variable">@Param</span> <span class="hljs-variable">@Require</span> <span class="hljs-attribute">itemData</span>: TodoItemData;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Row</span>({ space: 8 }) {</li><li>      <span class="hljs-selector-tag">Checkbox</span>({ name: 'checkbox1', group: 'checkboxGroup' })</li><li>        <span class="hljs-selector-class">.select</span>(this.itemData.selected)</li><li>        <span class="hljs-selector-class">.shape</span>(CheckBoxShape.CIRCLE)</li><li>        <span class="hljs-selector-class">.onChange</span>((_value) =&gt; {</li><li>          <span class="hljs-comment">// The child component changes the global state by sending a CompleteTodoItem event through the dispatch method, setting the current item to complete</span></li><li>          <span class="hljs-selector-tag">TodoStore</span><span class="hljs-selector-class">.dispatch</span>(TodoListActions.completeTodoItem.<span class="hljs-built_in">setPayload</span>({ <span class="hljs-attribute">id</span>: this.itemData.id, <span class="hljs-attribute">value</span>: _value }));</li><li>        });</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/components/TodoItem.ets#L21-L101" target="_blank">TodoItem.ets</a></div></div></div></div> </li></ol> </div> <p>通过StateStore库的使用，在UI上就没有任何状态更新逻辑，UI层面只需要关注界面描述和事件分发，保持了UI层的纯粹性。UI界面通过事件触发dispatch操作发送Action给Store来执行具体的逻辑，达到UI和状态解耦的效果。</p> <div class="tiledSection"><h2 id="section115917187334">子线程同步数据库<i class="anchor-icon anchor-icon-link" anchorid="section115917187334" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section71921942183311" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section71921942183311" tips="复制节点链接"></i></h3><p>在HarmonyOS开发中，子线程无法直接修改或者操作UI状态。这种限制导致子线程在完成复杂任务处理后，需要额外的逻辑将任务结果同步到主线程进行状态更新。</p> <p>为了解决这一问题，StateStore提供了SendableAction机制，使开发者可以在子线程中采用与主线程一致的方式分发Action，无需关注状态更新逻辑。</p> <p>在本节中，我们将通过在子线程中同步数据库的场景，介绍如何在子线程中发送状态更新事件。</p> <div class="fignone"><span class="figcap"><b>图4 </b><strong>效果图</strong></span></div> <p><span><img originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162940.98222161437268591597206286778002:50001231000000:2800:B1246314F286E979BF1B2F48AEB041F772FDCF0237504C7FB4FD61E61EC9E094.gif" class="notEnlarge" width="232" height="480"></span></p> <p>上图效果图中，用户点击同步数据库按钮，子线程去读写数据库，同时更新进度条。</p> </div> <div class="tiledSection"><h3 id="section1114725293318">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1114725293318" tips="复制节点链接"></i></h3><ol><li>定义数据<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L52-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToDoItemSendable</span> <span class="hljs-keyword">implements</span> lang.<span class="hljs-property">ISendable</span> {</li><li>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">detail</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">selected</span>: <span class="hljs-built_in">boolean</span>;</li><li>  <span class="hljs-attr">state</span>: <span class="hljs-built_in">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, detail: <span class="hljs-built_in">string</span>, selected: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selected</span> = selected;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">detail</span> = detail;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-number">0</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/model/TodoListModel.ets#L52-L66" target="_blank">TodoListModel.ets</a></div></div></div></div> </li><li>定义子线程操作函数并发送SendableAction<p>通过StateStore.createSendableAction方法定义一个sendableAction事件，它的作用于Action的作用一致，在子线程中需要使用taskpool的sendData发送一个sendableAction事件。</p> <p>createSendableAction方法接受三个参数分别是：</p> <ul><li>storeId: string，必选参数，用于描述当前的sendableAction事件需要操作的数据仓库。</li><li>type: string，必选参数，用于描述当前的sendableAction的事件类型，需要在reducer中有对应的类型逻辑事件。</li><li>payload?: ESObject，可选参数，事件的参数。<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/utils/TaskpoolUtil.ets#L44-L81" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentUpdateProgress</span>(<span class="hljs-params">context: Context, data: ToDoItemSendable[]</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> rdb = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RdbUtil</span>.<span class="hljs-title function_">getInstance</span>(context);</li><li>    <span class="hljs-keyword">const</span> originalIds = rdb.<span class="hljs-title function_">getAllIds</span>();</li><li>    <span class="hljs-keyword">const</span> toAdd = data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span>!originalIds.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> todo.<span class="hljs-property">id</span> === id));</li><li>    <span class="hljs-keyword">const</span> toUpdate = data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">state</span> === <span class="hljs-number">0</span> &amp;&amp; originalIds.<span class="hljs-title function_">indexOf</span>(todo.<span class="hljs-property">id</span>) &gt; -<span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">const</span> toDelete = originalIds.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span>!data.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === id));</li><li>    <span class="hljs-comment">// send setTotal event to set the total number of progress bars</span></li><li>    taskpool.<span class="hljs-property">Task</span>.<span class="hljs-title function_">sendData</span>(<span class="hljs-title class_">StateStore</span>.<span class="hljs-title function_">createSendableAction</span>(<span class="hljs-variable constant_">TODO_LIST_STORE_ID</span>, <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">setTotal</span>.<span class="hljs-property">type</span>,</li><li>      toAdd.<span class="hljs-property">length</span> + toUpdate.<span class="hljs-property">length</span> + toDelete.<span class="hljs-property">length</span>));</li><li>
</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> todo <span class="hljs-keyword">of</span> toAdd) {</li><li>      rdb.<span class="hljs-title function_">inset</span>(todo);</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">500</span>);</li><li>      <span class="hljs-comment">// send the update progress bar event updateProgress</span></li><li>      taskpool.<span class="hljs-property">Task</span>.<span class="hljs-title function_">sendData</span>(<span class="hljs-title class_">StateStore</span>.<span class="hljs-title function_">createSendableAction</span>(<span class="hljs-variable constant_">TODO_LIST_STORE_ID</span>, <span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">updateProgress</span>.<span class="hljs-property">type</span>,</li><li>        todo.<span class="hljs-property">id</span>));</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err.message}</span>\n<span class="hljs-subst">${err.stack}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/utils/TaskpoolUtil.ets#L44-L81" target="_blank">TaskpoolUtil.ets</a></div></div></div></div> </li></ul> </li><li>主线程接受后触发dispatch修改状态数据<p>主线程中使用onReceiveData接收sendData发送的sendableAction事件，然后调用StateStore.receiveSendableAction来执行这个事件通知reducer修改状态。</p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/utils/TaskpoolUtil.ets#L26-L40" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">syncDatabase</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">todos</span>: <span class="hljs-title class_">TodoItemData</span>[] = <span class="hljs-title class_">TodoStore</span>.<span class="hljs-title function_">getState</span>().<span class="hljs-property">todoList</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ToBeSynced</span> = todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">toDoItemSendable</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: taskpool.<span class="hljs-property">Task</span> = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(concurrentUpdateProgress, uiContext?.<span class="hljs-title function_">getHostContext</span>()!, <span class="hljs-title class_">ToBeSynced</span>);</li><li>    task.<span class="hljs-title function_">onReceiveData</span>(<span class="hljs-function">(<span class="hljs-params">data: SendableAction</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// Use the receiveSendableAction method to trigger the Action sent by the child thread to refresh the state</span></li><li>      <span class="hljs-title class_">StateStore</span>.<span class="hljs-title function_">receiveSendableAction</span>(data);</li><li>    });</li><li>    <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task);</li><li>    <span class="hljs-title class_">TodoStore</span>.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title class_">TodoListActions</span>.<span class="hljs-property">clearProgress</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err.message}</span>\n<span class="hljs-subst">${err.stack}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/utils/TaskpoolUtil.ets#L26-L40" target="_blank">TaskpoolUtil.ets</a></div></div></div></div> </li><li>Reducer定义数据操作逻辑<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListReducer.ets#L147-L155" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">case</span> TodoListActions.updateProgress.<span class="hljs-built_in">type</span>:</li><li>  <span class="hljs-built_in">let</span> item = state.syncTodoList.find(item =&gt; item.id === action.payload);</li><li>  item?.updateState(1);</li><li>  state.progress.value++;</li><li>  <span class="hljs-built_in">break</span>;</li><li><span class="hljs-keyword">case</span> TodoListActions.setTotal.<span class="hljs-built_in">type</span>:</li><li>  state.syncTodoList = state.todoList.filter(item =&gt; item.state === 0);</li><li>  state.progress.total = action.payload;</li><li>  <span class="hljs-built_in">break</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListReducer.ets#L147-L155" target="_blank">TodoListReducer.ets</a></div></div></div></div> </li><li>UI渲染<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/components/AsyncProgress.ets#L20-L76" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">CustomDialog</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AsyncProgressBuilder</span> {</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">CustomDialogController</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title function_">Progress</span>({</li><li>        <span class="hljs-variable">value</span>: <span class="hljs-title class_">TodoStore</span>.<span class="hljs-title class_">getState</span>().<span class="hljs-title class_">progress</span>.<span class="hljs-title class_">value</span>,</li><li>        <span class="hljs-variable">total</span>: <span class="hljs-title class_">TodoStore</span>.<span class="hljs-title class_">getState</span>().<span class="hljs-title class_">progress</span>.<span class="hljs-title class_">total</span>,</li><li>        <span class="hljs-keyword">type</span>: <span class="hljs-title class_">ProgressType</span>.<span class="hljs-title class_">Linear</span></li><li>      }).<span class="hljs-title function_">style</span>({ <span class="hljs-variable">enableSmoothEffect</span>: <span class="hljs-keyword">true</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">24</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/components/AsyncProgress.ets#L20-L76" target="_blank">AsyncProgress.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section8204163733611">状态更新日志埋点<i class="anchor-icon anchor-icon-link" anchorid="section8204163733611" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section13703154683615" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section13703154683615" tips="复制节点链接"></i></h3><p>在状态管理过程中，复杂业务逻辑往往需要在状态更新前后插入额外的处理逻辑，例如记录状态更新日志、请求鉴权等。这些逻辑如果直接耦合在状态管理的核心流程中，会导致代码冗杂且难以维护。</p> <p>为了解决这一问题，中间件应运而生。中间件是一种灵活的扩展机制，能够在Action分发到Reducer处理的流程中插入自定义逻辑，从而解耦通用功能和核心状态管理逻辑。</p> <p>在本节中，我们将通过日志埋点场景，展示如何利用中间件优雅地扩展状态管理功能。</p> <div class="fignone"><span class="figcap"><b>图5 </b><strong>日志效果图</strong></span><br><span><img height="116.3723541275471" originheight="219" originwidth="1731" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162941.19356272806077948118233637610954:50001231000000:2800:B4704C78A20B2254FED137DA3B45FED4752194A0FFA4C024A38C8B1392D9536D.png" title="点击放大" width="920"></span></div> <div class="fignone"><span class="figcap"><b>图6 </b><strong>中间件执行流程图</strong></span></div> <p><span><img originheight="317" originwidth="1135" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162941.64916322145200456669798436521253:50001231000000:2800:A8B0DE6758ACB8C5716947ECE599A998C8E9184040DE2D87951DEFEFFE7D80E6.png" width="920" height="256.9515418502203"></span></p> </div> <div class="tiledSection"><h3 id="section7342855133612">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section7342855133612" tips="复制节点链接"></i></h3><ol><li>定义中间件<p>开发者根据业务逻辑需要来实现beforeAction和afterAction两个钩子方法，分别在状态更新前后执行自定义逻辑。</p> <div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/middleware/LoggerMiddleware.ets#L21-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MiddlewareInstance</span>&lt;<span class="hljs-title class_">T</span>&gt; <span class="hljs-variable">extends</span> <span class="hljs-title class_">Middleware</span>&lt;<span class="hljs-title class_">T</span>&gt; {</li><li>  <span class="hljs-variable">beforeAction</span>: <span class="hljs-title class_">MiddlewareFuncType</span>&lt;<span class="hljs-title class_">T</span>&gt;;</li><li>  <span class="hljs-variable">afterAction</span>: <span class="hljs-title class_">MiddlewareFuncType</span>&lt;<span class="hljs-title class_">T</span>&gt;;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">beforeAction</span>: <span class="hljs-title class_">MiddlewareFuncType</span>&lt;<span class="hljs-title class_">T</span>&gt;, <span class="hljs-variable">afterAction</span>: <span class="hljs-title class_">MiddlewareFuncType</span>&lt;<span class="hljs-title class_">T</span>&gt;) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">beforeAction</span> = <span class="hljs-variable">beforeAction</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">afterAction</span> = <span class="hljs-variable">afterAction</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">LogMiddleware</span> = <span class="hljs-variable">new</span> <span class="hljs-title class_">MiddlewareInstance</span>&lt;<span class="hljs-title class_">TodoStoreModel</span>&gt;((<span class="hljs-variable">state</span>: <span class="hljs-title class_">TodoStoreModel</span>, <span class="hljs-variable">action</span>: <span class="hljs-title class_">Action</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'StateStoreSample'</span>, `<span class="hljs-variable">logMiddleware</span>-<span class="hljs-variable">before1</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">state</span>.<span class="hljs-variable">todoList</span>)}, ${<span class="hljs-variable">action</span>.<span class="hljs-keyword">type</span>}`);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">MiddlewareStatus</span>.<span class="hljs-variable">NEXT</span>;</li><li>}, (<span class="hljs-variable">state</span>: <span class="hljs-title class_">TodoStoreModel</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'StateStoreSample'</span>, `<span class="hljs-variable">logMiddleware</span>-<span class="hljs-variable">after</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">state</span>.<span class="hljs-variable">todoList</span>)}`);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">MiddlewareStatus</span>.<span class="hljs-variable">NEXT</span>;</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/middleware/LoggerMiddleware.ets#L21-L39" target="_blank">LoggerMiddleware.ets</a></div></div></div></div> </li><li>使用中间件<div class="screenLinkPre"><div _ngcontent-axw-c106="" class="highlight-div"><div _ngcontent-axw-c106="" class="highlight-div-header"><div _ngcontent-axw-c106="" class="highlight-div-header-left"><div _ngcontent-axw-c106="" class="handle-button expand-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-axw-c106="" class="highlight-div-header-right"><div _ngcontent-axw-c106="" class="handle-button ai-button"></div><div _ngcontent-axw-c106="" class="handle-button line-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-axw-c106="" class="handle-button theme-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-axw-c106="" class="handle-button copy-button"><div _ngcontent-axw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-axw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListStore.ets#L22-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TODO_LIST_STORE_ID</span> = <span class="hljs-string">'todoListStore'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TodoStore</span>: <span class="hljs-title class_">Store</span>&lt;<span class="hljs-title class_">TodoStoreModel</span>&gt; =</li><li>  <span class="hljs-title class_">StateStore</span>.<span class="hljs-title function_">createStore</span>(<span class="hljs-variable constant_">TODO_LIST_STORE_ID</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoStoreModel</span>(), todoReducer, [<span class="hljs-title class_">LogMiddleware</span>]);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/StateStore/blob/master/entry/src/main/ets/store/TodoListStore.ets#L22-L26" target="_blank">TodoListStore.ets</a></div></div></div></div> </li></ol> </div> <p>在Store中注册LogMiddleware后，所有状态更新逻辑执行前都会触发LogMiddleware的beforeAction 逻辑打印日志，状态更新逻辑执行后也会触发afterAction 逻辑打印日志。</p> <div class="tiledSection"><h2 id="section1956917563715">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1956917563715" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/StateStore" target="_blank">TodoList</a></li></ul> </div> </div></div>