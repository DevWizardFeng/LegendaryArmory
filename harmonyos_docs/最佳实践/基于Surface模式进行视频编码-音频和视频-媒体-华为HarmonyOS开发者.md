<h1 _ngcontent-aol-c119="" class="doc-title ng-star-inserted" title="基于Surface模式进行视频编码"> 基于Surface模式进行视频编码 </h1>

<div _ngcontent-aol-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section8133725114410">概述<i class="anchor-icon anchor-icon-link" anchorid="section8133725114410" tips="复制节点链接"></i></h2><p>视频编码是指通过压缩技术，将原始视频数据转换成压缩数据的过程。HarmonyOS提供了媒体文件的解析和封装、音视频的编解码。基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式" target="_blank">Surface模式</a>进行视频编码指通过NativeWindow来传递编码的输入数据，使用AVCodec提供的视频编码能力实现视频编码的过程。开发者可以通过OHNativeWindow与其他模块进行对接，如相机模块、屏幕录制模块等。</p> </div> <div class="tiledSection"><h2 id="section823854616235">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section823854616235" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section18935720165916" class="firsth2">Surface轮转原理<i class="anchor-icon anchor-icon-link" anchorid="section18935720165916" tips="复制节点链接"></i></h3><p>在Surface模式下，视频编码依赖NativeWindow传递编码数据。其中，NativeWindow是本地平台化窗口，表示图形队列的生产者端，包含了Surface对象。</p> <p>Surface主要是用于管理、传递图形和媒体的共享内存，具体场景如图形的生产、消费、合成，媒体的播放、录制等。Surface通过共享内存的方式传递图形/媒体数据，避免了进程之间图形/媒体数据的拷贝，减少了进程之间数据传递的开销。</p> <p>Surface分为生产者ProducerSurface和消费者ConsumerSurface。NativeWindow依赖生产者ProducerSurface，所以表示图形队列的生产者端。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>相对于Buffer模式，Surface模式避免了进程之间的媒体数据拷贝，所以Surface模式的性能会更高。</p> </div></div></div> <p>Surface轮转流程如下所示，生产者先申请到一块Buffer，填充数据后将Buffer返回给BufferQueue。在触发回调函数后，通知消费者Buffer已经被生产者填充好数据。之后，消费者可以获取填充好数据的Buffer，直到不再需要该Buffer后，释放对应的Buffer。</p> <p><span><img height="229.85060000000001" originheight="426" originwidth="986" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.77779159012157041502205638955741:50001231000000:2800:DA57D35D48C6BFA826D4670E90E2D9FA68E9A6C9403B14CEBB173556C2E80E55.png" title="点击放大" width="532"></span></p> <p>视频编码器提供了获取NativeWindow的接口，通过NativeWindow可以将相机产生的数据与视频编码器进行对接。视频编码器作为消费者，将Buffer数据进行消费编码，从而实现视频编码的操作。下面我们将通过相机录制和屏幕录制，介绍基于Surface模式进行视频编码。</p> </div> <div class="tiledSection"><h2 id="section1129263034410">使用AVScreenCapture+AVCodec进行视频编码<i class="anchor-icon anchor-icon-link" anchorid="section1129263034410" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section156021113451" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section156021113451" tips="复制节点链接"></i></h3><p>系统中提供了AVScreenCapture用于屏幕录制，AVScreenCapture可以支持屏幕录制并直接保存到视频文件中，还可以将录制的数据通过NativeWindow对接编码器进行数据编码。在基于Surface实现屏幕录制的方案中，开发者可以根据自己的需求保存对应的格式。</p> </div> <div class="tiledSection"><h3 id="section1385317434513">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1385317434513" tips="复制节点链接"></i></h3><p>Surface模式是通过NativeWindow包含的Surface传递录屏数据进行视频编码。在使用AVScreenCapture实现屏幕录制的场景中，开发者需要提前在编码器中获取NativeWindow对象，然后将获取的NativeWindow设置到AVScreenCapture中实现屏幕录制。具体开发步骤如下所示。</p> <ol><li>初始化视频封装器，创建并配置视频封装器。</li><li>初始化视频编码器，创建并配置视频编码器，并从编码器中获取NativeWindow对象。</li><li>初始化AVScreenCapture，创建并配置AVScreenCapture。</li><li>启动视频封装器。</li><li>启动视频编码器。</li><li>创建并启动编码输出子线程。</li><li>将从编码器中获取的NativeWindow对象设置给AVScreenCapture，启动屏幕录制。</li></ol> <p><span><img height="500.0667" originheight="924" originwidth="983" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.09731287574972090088137702573414:50001231000000:2800:78512B2EC6858E0D8B90B15EB5ED27CC472C194592758364E50AF818D3132282.png" title="点击放大" width="532"></span></p> </div> <div class="tiledSection"><h3 id="section12634710164516">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section12634710164516" tips="复制节点链接"></i></h3><ol><li>初始化视频封装器，创建并配置视频封装器。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L30-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Create</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fd)</span> </span>{</li><li>    muxer_ = <span class="hljs-built_in">OH_AVMuxer_Create</span>(fd, AV_OUTPUT_FORMAT_MPEG_4);</li><li>    <span class="hljs-keyword">if</span> (muxer_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Config</span><span class="hljs-params">(SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    OH_AVFormat *formatAudio = <span class="hljs-built_in">OH_AVFormat_CreateAudioFormat</span>(sampleInfo.audioCodecMime.<span class="hljs-built_in">data</span>(),</li><li>                                                             sampleInfo.audioSampleRate, sampleInfo.audioChannelCount);</li><li>
</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatAudio, OH_MD_KEY_PROFILE, AAC_PROFILE_LC);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;audioTrackId_, formatAudio);</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatAudio);</li><li>
</li><li>    OH_AVFormat *formatVideo =</li><li>        <span class="hljs-built_in">OH_AVFormat_CreateVideoFormat</span>(sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>(), sampleInfo.videoWidth, sampleInfo.videoHeight);</li><li>
</li><li>    <span class="hljs-built_in">OH_AVFormat_SetDoubleValue</span>(formatVideo, OH_MD_KEY_FRAME_RATE, sampleInfo.frameRate);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_WIDTH, sampleInfo.videoWidth);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetIntValue</span>(formatVideo, OH_MD_KEY_HEIGHT, sampleInfo.videoHeight);</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(formatVideo, OH_MD_KEY_CODEC_MIME, sampleInfo.videoCodecMime.<span class="hljs-built_in">data</span>());</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_AVMuxer_AddTrack</span>(muxer_, &amp;videoTrackId_, formatVideo);</li><li>    <span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"AddTrack failed"</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_AVFormat_Destroy</span>(formatVideo);</li><li>    formatVideo = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L30-L62" target="_blank">Muxer.cpp</a></div></div></div></div> </li><li>初始化视频编码器，创建并配置视频编码器，并从编码器中获取NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L20-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">Create</span>(<span class="hljs-keyword">const</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> &amp;<span class="hljs-title class_">videoCodecMime</span>) {</li><li>    <span class="hljs-variable">encoder_</span> = <span class="hljs-title function_">OH_VideoEncoder_CreateByMime</span>(<span class="hljs-variable">videoCodecMime</span>.<span class="hljs-title function_">c_str</span>());</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">encoder_</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">Config</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>, <span class="hljs-variable">CodecUserData</span> <span class="hljs-variable">*codecUserData</span>) {</li><li>    <span class="hljs-comment">// Configure video encoder</span></li><li>    <span class="hljs-variable">OH_AVFormat</span> *<span class="hljs-variable">format</span> = <span class="hljs-title function_">OH_AVFormat_Create</span>();</li><li>
</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_WIDTH</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">videoWidth</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_HEIGHT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">videoHeight</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetDoubleValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_FRAME_RATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">frameRate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PIXEL_FORMAT</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">pixelFormat</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_VIDEO_ENCODE_BITRATE_MODE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">bitrateMode</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetLongValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_BITRATE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">bitrate</span>);</li><li>    <span class="hljs-title function_">OH_AVFormat_SetIntValue</span>(<span class="hljs-variable">format</span>, <span class="hljs-variable">OH_MD_KEY_PROFILE</span>, <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">hevcProfile</span>);</li><li>
</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_VideoEncoder_Configure</span>(<span class="hljs-variable">encoder_</span>, <span class="hljs-variable">format</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AV_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Config failed, ret: %{public}d"</span>, <span class="hljs-variable">ret</span>);</li><li>    }</li><li>    <span class="hljs-title function_">OH_AVFormat_Destroy</span>(<span class="hljs-variable">format</span>);</li><li>    <span class="hljs-variable">format</span> = <span class="hljs-variable">nullptr</span>;</li><li>
</li><li>    <span class="hljs-comment">// GetSurface from video encoder</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_GetSurface</span>(<span class="hljs-variable">encoder_</span>, &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">window</span>);</li><li>
</li><li>    <span class="hljs-comment">// SetCallback for video encoder</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_RegisterCallback</span>(<span class="hljs-variable">encoder_</span>,</li><li>                                     {<span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnCodecError</span>, <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnCodecFormatChange</span>,</li><li>                                      <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>, <span class="hljs-variable">VideoEncoder</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>},</li><li>                                     <span class="hljs-variable">codecUserData</span>);</li><li>    <span class="hljs-comment">// Prepare video encoder</span></li><li>    <span class="hljs-title function_">OH_VideoEncoder_Prepare</span>(<span class="hljs-variable">encoder_</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L20-L59" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>初始化AVScreenCapture，创建并配置AVScreenCapture。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L129-L175" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CAVScreenCaptureToStream::InitAVScreenCapture</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> videoWidth,</span></span></li><li><span class="hljs-function">                                                 <span class="hljs-type">int32_t</span> videoHeight)</span> {</li><li>    <span class="hljs-keyword">if</span> (g_avCapture != <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">StopScreenCaptureRecording</span>(g_avCapture);</li><li>    }</li><li>
</li><li>    g_avCapture = <span class="hljs-built_in">OH_AVScreenCapture_Create</span>();</li><li>    <span class="hljs-keyword">if</span> (g_avCapture == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"create screen capture failed"</span>);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture after create sc"</span>);</li><li>
</li><li>    <span class="hljs-comment">// Set callback</span></li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetErrorCallback</span>(g_avCapture, OnErrorToStream, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetStateCallback</span>(g_avCapture, OnSurfaceStateChangeToStream, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetMicrophoneEnabled</span>(g_avCapture, <span class="hljs-literal">true</span>);</li><li>    <span class="hljs-built_in">OH_AVScreenCapture_SetCanvasRotation</span>(g_avCapture, <span class="hljs-literal">true</span>);</li><li>
</li><li>    <span class="hljs-comment">// Initialize configuration information</span></li><li>    OH_AVScreenCaptureConfig config;</li><li>    OH_AudioCaptureInfo micCapInfo = {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_SOURCE_DEFAULT};</li><li>    OH_AudioCaptureInfo innerCapInfo = {.audioSampleRate = <span class="hljs-number">48000</span>, .audioChannels = <span class="hljs-number">2</span>, .audioSource = OH_ALL_PLAYBACK};</li><li>    OH_AudioEncInfo audioEncInfo = {.audioBitrate = <span class="hljs-number">96000</span>, .audioCodecformat = OH_AudioCodecFormat::OH_AAC_LC};</li><li>    OH_AudioInfo audioInfo = {.micCapInfo = micCapInfo, .innerCapInfo = innerCapInfo, .audioEncInfo = audioEncInfo};</li><li>
</li><li>    OH_VideoCaptureInfo videoCapInfo = {</li><li>        .videoFrameWidth = videoWidth, .videoFrameHeight = videoHeight, .videoSource = OH_VIDEO_SOURCE_SURFACE_RGBA};</li><li>
</li><li>    OH_VideoEncInfo videoEncInfo = {</li><li>        .videoCodec = OH_VideoCodecFormat::OH_H264, .videoBitrate = <span class="hljs-number">10000000</span>, .videoFrameRate = <span class="hljs-number">30</span>};</li><li>
</li><li>    OH_VideoInfo videoInfo = {.videoCapInfo = videoCapInfo, .videoEncInfo = videoEncInfo};</li><li>
</li><li>    config = {</li><li>        .captureMode = OH_CAPTURE_HOME_SCREEN,</li><li>        .dataType = OH_ORIGINAL_STREAM,</li><li>        .audioInfo = audioInfo,</li><li>        .videoInfo = videoInfo,</li><li>    };</li><li>
</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVScreenCapture_Init</span>(g_avCapture, config);</li><li>    <span class="hljs-keyword">if</span> (result != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture OH_AVScreenCapture_Init failed %{public}d"</span>, result);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture OH_AVScreenCapture_Init %{public}d"</span>, result);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L129-L175" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li><li>启动视频封装器。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L66-L69" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::Start</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_AVMuxer_Start</span>(muxer_);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/Muxer.cpp#L66-L69" target="_blank">Muxer.cpp</a></div></div></div></div> </li><li>启动视频编码器。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L68-L71" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoEncoder::Start</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_VideoEncoder_Start</span>(encoder_);</li><li>    <span class="hljs-keyword">return</span> ret;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/VideoEncoder.cpp#L68-L71" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>创建并启动编码输出子线程。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L210-L255" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">CAVScreenCaptureToStream</span>::<span class="hljs-title class_">EncOutputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>()) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_SYNC_FRAME</span>) ||</li><li>            (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>)) {</li><li>            <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span> * <span class="hljs-title class_">MICROSECOND</span> / <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-number">0</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">WriteSample</span>(<span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">GetVideoTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                            <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Encoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Exit, frame count: %{public}u"</span>, <span class="hljs-variable">videoEncContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L210-L255" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li><li>将从编码器中获取的NativeWindow对象设置给AVScreenCapture，启动屏幕录制。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L335-L350" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CAVScreenCaptureToStream::StartScreenCapture</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> outputFd, <span class="hljs-type">int32_t</span> videoWidth, <span class="hljs-type">int32_t</span> videoHeight)</span> </span>{</li><li>    <span class="hljs-built_in">InitMuxerAndEncoder</span>(outputFd, videoWidth, videoHeight);</li><li>
</li><li>    <span class="hljs-built_in">InitAVScreenCapture</span>(videoWidth, videoHeight);</li><li>    </li><li>    m_IsRunning = <span class="hljs-literal">true</span>;</li><li>
</li><li>    <span class="hljs-built_in">StartMuxerAndEncoder</span>();</li><li>
</li><li>    <span class="hljs-type">int</span> result = <span class="hljs-built_in">OH_AVScreenCapture_StartScreenCaptureWithSurface</span>(g_avCapture, sampleInfo_.window);</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"OH_VideoEncoder_Start Started 2 %{public}d"</span>, result);</li><li>    <span class="hljs-keyword">if</span> (result != AV_SCREEN_CAPTURE_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ScreenCapture Started failed %{public}d"</span>, result);</li><li>        <span class="hljs-built_in">OH_AVScreenCapture_Release</span>(g_avCapture);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record/blob/master/entry/src/main/cpp/CAVScreenCaptureToStream/CAVScreenCaptureToStream.cpp#L335-L350" target="_blank">CAVScreenCaptureToStream.cpp</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section15360034104415">使用Camera+AVCodec进行视频编码<i class="anchor-icon anchor-icon-link" anchorid="section15360034104415" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1347531654515" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1347531654515" tips="复制节点链接"></i></h3><p>在相机录制的场景中，可以Camera相机对接AVRecorder实现录制，还可以通过Surface将相机与视频编码器进行对接，从而实现视频录制。在基于Surface实现相机录制的场景中，开发者可以自行配置对应的格式，如录制HDR视频。</p> </div> <div class="tiledSection"><h3 id="section144758165455">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section144758165455" tips="复制节点链接"></i></h3><p>在使用Camera实现相机录制中，需要通过NativeWindow传递相机数据。开发者需要提前从视频编码器中获取NativeWindow，并从NativeWindow中获取对应的surfaceId。最后，在相机配置时，通过surfaceId创建相机输出流。具体开发步骤如下所示。</p> <ol><li>初始化视频封装器，创建并配置视频封装器。</li><li>初始化视频编码器，创建并配置视频编码器，从编码器中获取NativeWindow对象。从NativeWindow对象获取对应的surfaceId。</li><li>初始化相机配置，并通过createVideoOutput接口创建相机输出流。</li><li>在开启相机时，启动视频封装器。</li><li>启动视频编码器。</li><li>创建并启动编码输出子线程。</li></ol> <p><span><img height="436.4262" originheight="895" originwidth="1091" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.84932194283527041470818582614949:50001231000000:2800:5CB4A2F3F5152AA12BFA651A625F78D39B9F67982EAD8ECDA0A79499BAC9C48E.png" title="点击放大" width="532"></span></p> </div> <div class="tiledSection"><h3 id="section164751016114512">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section164751016114512" tips="复制节点链接"></i></h3></div> <ol><li>初始化视频封装器，创建并配置视频封装器。（此代码与屏幕录制一致）</li><li>初始化视频编码器，创建并配置视频编码器，从编码器中获取NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L164-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoEncoder::GetSurface</span><span class="hljs-params">(SampleInfo &amp;sampleInfo)</span> </span>{</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_VideoEncoder_GetSurface</span>(encoder_, &amp;sampleInfo.window);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK &amp;&amp; sampleInfo.window, AVCODEC_SAMPLE_ERR_ERROR,</li><li>                             <span class="hljs-string">"Get surface failed, ret: %{public}d"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L164-L169" target="_blank">VideoEncoder.cpp</a></div></div></div></div> <p>从NativeWindow对象获取对应的surfaceId。</p> <div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/sample/recorder/RecorderNative.cpp#L56-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">NativeInit</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">data</span>) {</li><li>    <span class="hljs-variable">AsyncCallbackInfo</span> *<span class="hljs-variable">asyncCallbackInfo</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">AsyncCallbackInfo</span> *&gt;(<span class="hljs-variable">data</span>);</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Init</span>(<span class="hljs-variable">asyncCallbackInfo</span>-&gt;<span class="hljs-title class_">sampleInfo</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">SetCallBackResult</span>(<span class="hljs-variable">asyncCallbackInfo</span>, -<span class="hljs-number">1</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">id</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeWindow_GetSurfaceId</span>(<span class="hljs-variable">asyncCallbackInfo</span>-&gt;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-title class_">window</span>, &amp;<span class="hljs-title class_">id</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">SetCallBackResult</span>(<span class="hljs-variable">asyncCallbackInfo</span>, -<span class="hljs-number">1</span>);</li><li>    }</li><li>    <span class="hljs-variable">asyncCallbackInfo</span>-&gt;<span class="hljs-title class_">surfaceId</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">to_string</span>(<span class="hljs-title class_">id</span>);</li><li>    <span class="hljs-title function_">SurfaceIdCallBack</span>(<span class="hljs-variable">asyncCallbackInfo</span>, <span class="hljs-variable">asyncCallbackInfo</span>-&gt;<span class="hljs-title class_">surfaceId</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/sample/recorder/RecorderNative.cpp#L56-L70" target="_blank">RecorderNative.cpp</a></div></div></div></div> </li><li>初始化相机配置，并通过createVideoOutput接口创建相机输出流。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L313-L321" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Add the encoder video stream to the session.</span></li><li><span class="hljs-keyword">try</span> {</li><li>  videoSession.<span class="hljs-title function_">addOutput</span>(encoderVideoOutput);</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to add encoderVideoOutput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L313-L321" target="_blank">Recorder.ets</a></div></div></div></div> <p>点击相机录制时，启动相机输出流。</p> <div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L351-L360" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start the video output stream</span></li><li>encoderVideoOutput.<span class="hljs-title function_">start</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to start the encoder video output. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Callback invoked to indicate the encoder video output start success.'</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/ets/pages/Recorder.ets#L351-L360" target="_blank">Recorder.ets</a></div></div></div></div> </li><li>在开启相机时，启动视频封装器。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L74-L80" data-highlighted="yes"><ol class="linenums"><li>int32_t Muxer::Start() {</li><li>    CHECK_AND_RETURN_RET_LOG(muxer_ != nullptr, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Muxer is null"</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> ret = OH_AVMuxer_Start(muxer_);</li><li>    CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span>, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Start failed, ret: %{public}d"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L74-L80" target="_blank">Muxer.cpp</a></div></div></div></div> </li><li>启动视频编码器。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L57-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start Encoder</span></li><li>int32_t VideoEncoder::Start() {</li><li>    CHECK_AND_RETURN_RET_LOG(encoder_ != nullptr, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Encoder is null"</span>);</li><li>
</li><li>    <span class="hljs-type">int</span> ret = OH_VideoEncoder_Start(encoder_);</li><li>    CHECK_AND_RETURN_RET_LOG(ret == <span class="hljs-built_in">AV_ERR_OK</span>, <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Start failed, ret: %{public}d"</span>, ret);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/capbilities/VideoEncoder.cpp#L57-L64" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </li><li>创建并启动编码输出子线程。<div class="screenLinkPre"><div _ngcontent-aol-c106="" class="highlight-div"><div _ngcontent-aol-c106="" class="highlight-div-header"><div _ngcontent-aol-c106="" class="highlight-div-header-left"><div _ngcontent-aol-c106="" class="handle-button expand-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-aol-c106="" class="highlight-div-header-right"><div _ngcontent-aol-c106="" class="handle-button ai-button"></div><div _ngcontent-aol-c106="" class="handle-button line-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-aol-c106="" class="handle-button theme-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-aol-c106="" class="handle-button copy-button"><div _ngcontent-aol-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-aol-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/sample/recorder/Recorder.cpp#L112-L144" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">EncOutputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_CONTINUE_LOG</span>(!<span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(),</li><li>                               <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(!(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>), <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_SYNC_FRAME</span>) ||</li><li>            (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>)) {</li><li>            <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span> * <span class="hljs-title class_">MICROSECOND</span> / <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-number">0</span>;</li><li>        }</li><li>        <span class="hljs-title function_">AVCODEC_SAMPLE_LOGW</span>(<span class="hljs-string">"Out buffer count: %{public}u, size: %{public}d, flag: %{public}u, pts: %{public}"</span> <span class="hljs-variable">PRId64</span>,</li><li>                            <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span>,</li><li>                            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>);</li><li>
</li><li>        <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">WriteSample</span>(<span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">GetVideoTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                            <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-string">"Encoder output thread out"</span>);</li><li>    }</li><li>    <span class="hljs-title function_">AVCODEC_SAMPLE_LOGI</span>(<span class="hljs-string">"Exit, frame count: %{public}u"</span>, <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>);</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AVCodecVideo/blob/master/entry/src/main/cpp/sample/recorder/Recorder.cpp#L112-L144" target="_blank">Recorder.cpp</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section4860543134914">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section4860543134914" tips="复制节点链接"></i></h2><ul><li>使用AVScreenCapture+AVCodec进行视频编码参考代码：<a href="https://gitee.com/harmonyos_samples/avscreen-capture-screen-record" target="_blank">基于AVScreenCapture实现录屏功能</a></li><li>使用Camera+AVCodec进行视频编码参考代码：<a href="https://gitee.com/harmonyos_samples/AVCodecVideo" target="_blank">基于AVCodec能力的视频编解码</a></li></ul> </div> </div> <div></div></div>