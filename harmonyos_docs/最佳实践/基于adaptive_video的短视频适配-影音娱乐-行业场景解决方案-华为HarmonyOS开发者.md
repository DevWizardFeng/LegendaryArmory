<h1 _ngcontent-qni-c119="" class="doc-title ng-star-inserted" title="基于adaptive_video的短视频适配"> 基于adaptive_video的短视频适配 </h1>

<div _ngcontent-qni-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section10114148144013">概述<i class="anchor-icon anchor-icon-link" anchorid="section10114148144013" tips="复制节点链接"></i></h2><p>短视频是一种时长较短、内容直观的视频内容形式，单条视频通常为数秒至数分钟。为提升用户的观感体验，短视频页面常采用沉浸式模式展示视频内容，并支持根据用户持握设备的方向自动旋转屏幕页面。然而，由于设备本身、设备屏幕尺寸的差异，不同设备短视频页面的沉浸效果、旋转属性可能会有所不同，这通常需要开发者额外适配。</p> <p>对此，adaptive_video三方库提供了完整的适配方案，能够使短视频页面在遵循当前主流沉浸、旋转规则下达到多端一致的观感体验，简化短视频页面开发，开发者可参考<a href="https://gitcode.com/openharmony-sig/hadss_adaptive/tree/master/adaptive_video" target="_blank">adaptive_video使用说明</a>进行安装配置与快速上手。下文将介绍adaptive_video支持的短视频页面开发适配场景。</p> </div> <div class="tiledSection"><h2 id="section1173123518403">短视频自适应沉浸<i class="anchor-icon anchor-icon-link" anchorid="section1173123518403" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section44417219413" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section44417219413" tips="复制节点链接"></i></h3><p>短视频沉浸是一种通过全屏展示、弱化界面干扰，让用户专注于视频内容的呈现模式。在开发过程中，通常结合屏幕适配、视频裁剪等技术，以增强视觉沉浸感。在当前主流的沉浸式策略中，短视频的呈现方式会根据设备屏幕尺寸进行调整：大屏设备通常会完整呈现视频内容，而小屏设备则根据窗口比例对视频进行适当裁剪，以提升用户的沉浸体验。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th align="center" class="firstcol" id="mcps1.3.3.3.1.4.1.1" valign="top" width="11.88%"><p>设备</p> </th> <td align="center" class="cellrowborder" valign="top" width="40.62%"><p>手机</p> </td> <td align="center" class="cellrowborder" valign="top" width="47.5%"><p>折叠屏展开</p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.3.3.1.4.2.1" valign="top" width="11.88%"><p>实现效果图</p> </th> <td align="center" class="cellrowborder" valign="top" width="40.62%"><p><span><img height="563.4146000000001" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.23939853900478190711529213101997:50001231000000:2800:423B48CAD2702A90011AE6E8A9E63278AB8E0B8DECE6CA661563016C687BEB35.png" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="47.5%"><p><span><img height="460.2055882107139" originheight="2425" originwidth="2176" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.82549039563330902793605539986734:50001231000000:2800:307430F231D35D1BD04281463631252EC5C8AB3DA41146AA7F4C0706D27D5A9E.png" title="点击放大" width="413"></span></p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.3.3.1.4.3.1" valign="top" width="11.88%"><p>设备</p> </th> <td align="center" class="cellrowborder" valign="top" width="40.62%"><p>平板</p> </td> <td align="center" class="cellrowborder" valign="top" width="47.5%"><p>2in1</p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.3.3.1.4.4.1" valign="top" width="11.88%"><p>实现效果图</p> </th> <td align="center" class="cellrowborder" valign="top" width="40.62%"><p><span><img height="225.8121589771736" originheight="2278" originwidth="3524" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.16409545508038234146518711812454:50001231000000:2800:48D1F4E0701A43892BE19E883E4BFC6053EEF45852F350F3492FCAB761DAC83F.png" title="点击放大" width="349.70399999999995"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="47.5%"><p><span><img height="235.21371415553716" originheight="1928" originwidth="3378" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.85167628384517275167100048118685:50001231000000:2800:8E1C0F6E8AF173F5845C1F2EEE70549316874894EB26AAFA974EC46206FA3710.png" title="点击放大" width="413"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section8896175210417">规则描述<i class="anchor-icon anchor-icon-link" anchorid="section8896175210417" tips="复制节点链接"></i></h3><p>adaptive_video提供短视频自适应沉浸的能力，以降低开发者在多端设备上实现短视频沉浸布局的工作量。为确保短视频滑动播放页面在不同设备上均能呈现最佳视觉效果，adaptive_video将综合考虑页面窗口尺寸、视频比例、Tab导航栏高度等信息，根据沉浸规则计算沉浸式布局方案，并依此生成视频播放组件的尺寸与位置建议，同时提供状态栏和Tab导航栏的沉浸建议。</p> <p>以下是adaptive_video使用的自适应沉浸布局计算规则：</p> <div class="p"> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.4.4.1.1.6.1.1" valign="top" width="9.25%"><p>序号</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.4.1.1.6.1.2" valign="top" width="16.04%"><p>视频宽高比 r</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.4.1.1.6.1.3" valign="top" width="15.120000000000001%"><p>窗口宽高比 x</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.4.1.1.6.1.4" valign="top" width="15.58%"><p>窗口宽 w (vp)</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.4.1.1.6.1.5" valign="top" width="44.01%"><p>沉浸规则描述</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="9.25%"><p>1</p> </td> <td align="center" class="cellrowborder" rowspan="6" valign="top" width="16.04%"><p>9:16.1 &lt;= r &lt; 9:15.9</p> <p></p> <p></p> </td> <td align="center" class="cellrowborder" valign="top" width="15.120000000000001%"><p>x &lt; 9:20</p> </td> <td align="center" class="cellrowborder" rowspan="4" valign="top" width="15.58%"><p>320 &lt;= w &lt; 600</p> <p></p> <p></p> <p></p> </td> <td align="left" class="cellrowborder" valign="top" width="44.01%"><p>窗口高度减去底部导航栏高度，状态栏高度后，等比例缩放视频至视频可视区域宽高比为9:17.8，并居中显示在剩余区域，左右超出窗口部分自适应裁剪;</p> <p>状态栏、底部tab都不沉浸</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>2</p> </td> <td align="center" class="cellrowborder" valign="top"><p>9:20 &lt;= x &lt; 9:18</p> </td> <td align="left" class="cellrowborder" valign="top"><p>窗口高度减去底部导航栏高度后，视频内容自适应缩放至剩余区域高撑满，左右超出部分自适应裁剪;</p> <p>状态栏沉浸、底部tab不沉浸</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>3</p> </td> <td align="center" class="cellrowborder" valign="top"><p>9:18 ≤ x&lt; 9:14.4</p> <p></p> </td> <td align="left" class="cellrowborder" valign="top"><ol><li>9:18 &lt;= x &lt; r：视频自适应缩放至窗口高撑满，左右超出窗口部分自适应裁剪<p>状态栏和底部tab都沉浸</p> </li><li>r &lt; x &lt; 9:14.4：视频自适应缩放至将窗口宽撑满，上下超出窗口部分自适应裁剪<p>状态栏和底部tab都沉浸</p> </li></ol> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>4</p> </td> <td align="center" class="cellrowborder" valign="top"><p>9:14.4 &lt;= x &lt; 9:10.8</p> </td> <td align="left" class="cellrowborder" rowspan="3" valign="top"><p>视频将窗口高撑满，视频宽自适应等比例缩放</p> <p>状态栏和底部tab都沉浸</p> <p></p> <p></p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>5</p> </td> <td align="center" class="cellrowborder" valign="top"><p>x &lt;= 9:10.8</p> </td> <td align="center" class="cellrowborder" valign="top"><p>600 &lt;= w</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>6</p> </td> <td align="center" class="cellrowborder" valign="top"><p>9:10.8 &lt;= x</p> </td> <td align="center" class="cellrowborder" valign="top"><p>320 &lt;= w</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="9.25%"><p>7</p> </td> <td align="center" class="cellrowborder" rowspan="3" valign="top" width="16.04%"><p>r &gt;= 9:15.9 或 r &lt; 9:16.1</p> <p>(非9:16区间的视频)</p> <p></p> <p></p> </td> <td align="center" class="cellrowborder" valign="top" width="15.120000000000001%"><p>x &lt; 9:20</p> </td> <td align="center" class="cellrowborder" rowspan="3" valign="top" width="15.58%"><p>320 &lt;= w</p> </td> <td align="left" class="cellrowborder" valign="top" width="44.01%"><p>窗口高度减去底部导航栏高度，状态栏高度后，视频自适应放大至撑满剩余区域</p> <p>状态栏、底部tab都不沉浸</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>8</p> </td> <td align="center" class="cellrowborder" valign="top"><p>9:18 &lt;= x &lt; 9:20</p> </td> <td align="left" class="cellrowborder" valign="top"><p>窗口高度减去底部导航栏高度、后，视频自适应放大至撑满剩余区域</p> <p>状态栏沉浸、底部tab不沉浸</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top"><p>9</p> </td> <td align="center" class="cellrowborder" valign="top"><p>x &lt; 9:18</p> </td> <td align="left" class="cellrowborder" valign="top"><p>视频自适应放大至撑满剩余区域</p> <p>状态栏沉浸、底部tab根据视频区域大小决定是否沉浸</p> </td> </tr>  </tbody></table></div> </div> </div> <p>按照上述沉浸规则进行适配后，视频宽高比处于9:16区间的短视频在窗口宽为320vp至600vp设备上的沉浸效果图如下（红色部分为视频显示区域）<span><img height="246.6593757886767" originheight="465" originwidth="1808" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.49827232318124320820824771210602:50001231000000:2800:93EB9773183869D282DCD786368FB8A77495E3B79D427A6DBADC16FF5ED93A41.png" title="点击放大" width="920"></span>视频宽高比处于9:16区间的短视频在完整断点区间上的沉浸效果图如下（红色部分为视频显示区域）：</p> <p><span><img height="558.9073753840471" originheight="899" originwidth="1495" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.47055284042216003753846855915179:50001231000000:2800:745882A1CBD06EA973C9B7BFEDA6B0B46DCF2C1BFFE37F5F5328086CCA70FE44.png" title="点击放大" width="920"></span>视频宽高比处于非9:16区间的短视频在窗口宽为320vp以上设备的沉浸效果如下（虚线框内为视频可能显示的区域）：</p> <p><span><img height="387.31888918701367" originheight="661" originwidth="1613" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.92348865703130836198962224372051:50001231000000:2800:FAD870B9C4EB053B7BDB225F154F3DD04EC79BE9EDE7F4FBBBEC64132DD5880A.png" title="点击放大" width="920"></span></p> </div> <div class="tiledSection"><h3 id="section4604530184211">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section4604530184211" tips="复制节点链接"></i></h3><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>adaptive_video三方库中的视频自适应沉浸组件支持网络视频链接，因此三方库使用了以下权限。权限设置详情参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。</p> <ul><li>ohos.permission.INTERNET：允许应用访问互联网。</li></ul> <p>以下代码默认应用已经安装并导入了adaptive_video三方库，详细的三方库安装教程可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-command-line-tool-13" target="_blank">如何使用ohpm引入三四方库</a>。</p> </div></div></div> <ul><li>沉浸模式要求将视频页面的内容扩展至状态栏和导航栏，因此需设置窗口为全屏模式，此时组件的布局范围将从安全区域延伸至整个窗口。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/products/entry/src/main/ets/entryability/EntryAbility.ets#L54-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set full screen</span></li><li>windowClass.setWindowLayoutFullScreen(<span class="hljs-literal">true</span>).<span class="hljs-keyword">catch</span>(() =&gt; {</li><li>  hilog.error(DOMAIN, LOG_TAG, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Set WindowLayoutFullScreen failed.'</span>);</li><li>})</li><li><span class="hljs-keyword">let</span> deviceTypeInfo: <span class="hljs-built_in">string</span> = deviceInfo.deviceType;</li><li><span class="hljs-keyword">if</span> (deviceTypeInfo === <span class="hljs-string">'2in1'</span>) {</li><li>  <span class="hljs-keyword">if</span> (canIUse(<span class="hljs-string">'SystemCapability.Window.SessionManager'</span>)) {</li><li>    <span class="hljs-comment">// 2in1 device settings hide title bar and title bar height</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      windowClass.setWindowDecorVisible(<span class="hljs-literal">false</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.error(DOMAIN, LOG_TAG, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Set WindowDecorVisible failed.'</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/products/entry/src/main/ets/entryability/EntryAbility.ets#L54-L75" target="_blank">EntryAbility.ets</a></div></div></div></div> <p></p> </li></ul> <ul><li>从adaptive_video三方库导入AdaptiveImmersion自适应沉浸工具并初始化。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L22-L645" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AdaptiveImmersion</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hadss/adaptive_video'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> adaptiveImmersion = <span class="hljs-title class_">AdaptiveImmersion</span>.<span class="hljs-title function_">getInstance</span>(); <span class="hljs-comment">// get AdaptiveImmersion instance</span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">AdaptiveAVPlayer</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    adaptiveImmersion.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) <span class="hljs-comment">// The UIAbilityContext is initialized with the adaptive immersion tool</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L22-L645" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> </li><li>调用AdaptiveImmersion的接口，根据视频宽高及底部Tab导航栏高度计算页面沉浸信息，并根据计算结果调整页面布局（包括视频组件的宽高、视频组件的位置等），以实现页面的沉浸式布局。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L104-L558" data-highlighted="yes"><ol class="linenums"><li>build() {</li><li>  RelativeContainer() {</li><li>    Stack() {</li><li>      Column() {</li><li>        XComponent({</li><li>          id: <span class="hljs-string">'AdaptiveAVPlayer'</span>, <span class="hljs-comment">// Playback component ID</span></li><li>          type: XComponentType.SURFACE, <span class="hljs-comment">// Playback component type</span></li><li>          controller: <span class="hljs-keyword">this</span>.xComponentController <span class="hljs-comment">// Playback Component Controller</span></li><li>        })</li><li>          .width(<span class="hljs-keyword">this</span>.surfaceWidth)<span class="hljs-comment">// Playback component width</span></li><li>          .height(<span class="hljs-keyword">this</span>.surfaceHeight)<span class="hljs-comment">// Playback component height</span></li><li>          .position(<span class="hljs-keyword">this</span>.videoPosition)<span class="hljs-comment">// The playback component is positioned relative to the upper left corner of the window</span></li><li>            <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Non-full-screen video playback</span></li><li><span class="hljs-keyword">private</span> async changePortraitVideo() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">const</span> immersionInfo = adaptiveImmersion</li><li>      .getImmersionInfo({ width: <span class="hljs-keyword">this</span>.oriSurfaceWidth <span class="hljs-keyword">as</span> number, height: <span class="hljs-keyword">this</span>.oriSurfaceHeight <span class="hljs-keyword">as</span> number },</li><li>        <span class="hljs-keyword">this</span>.bottomTabHeight); <span class="hljs-comment">// Input the width and height of the current video and the height of the tab navigation bar at the bottom to obtain the immersive layout information</span></li><li>    <span class="hljs-comment">// Adjust the page layout based on the immersive information</span></li><li>    <span class="hljs-keyword">if</span> (immersionInfo) {</li><li>      hilog.info(DOMAIN, LOG_TAG, `changePortraitVideo immersionInfo = ${JSON.stringify(immersionInfo)}`);</li><li>      <span class="hljs-keyword">this</span>.surfaceWidth = immersionInfo.videoSize.width; <span class="hljs-comment">// Video component width</span></li><li>      <span class="hljs-keyword">this</span>.surfaceHeight = immersionInfo.videoSize.height; <span class="hljs-comment">// Video component height</span></li><li>      <span class="hljs-keyword">this</span>.videoPosition = immersionInfo.videoPosition; <span class="hljs-comment">// Position of the video component relative to the upper left corner of the window</span></li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.error(DOMAIN, LOG_TAG, `changePortraitVideo error = ${JSON.stringify(err)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L104-L558" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>短视频滑动播放页面通常懒加载了多个视频播放组件，这些组件包括不同宽高比例的视频。在视频切换时，需要重新调用AdaptiveImmersion的接口来计算当前页面的沉浸式布局；此外，当设备窗口发生变化时，也需要重新计算页面的沉浸式布局。有关AdaptiveImmersion接口的详细说明，请参阅<a href="https://gitcode.com/openharmony-sig/hadss_adaptive/tree/master/adaptive_video" target="_blank">adaptive_video使用说明</a>。</p> </div></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section4241101815446">短视频自适应旋转<i class="anchor-icon anchor-icon-link" anchorid="section4241101815446" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1720702484419" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1720702484419" tips="复制节点链接"></i></h3><p>短视频页面旋转是指当用户改变设备的持握方向（如从竖屏切换为横屏）时，视频内容和页面布局能自动适应方向变化，从而实现视频连续旋转播放的特性。这一功能通常需要结合重力感应与屏幕方向监听来实现，根据监听结果动态调整页面内容与界面元素，保证用户在不同持握姿势下都能获得流畅的观感体验。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.7.3.1.4.1.1" valign="top" width="10%"><p>设备</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.7.3.1.4.1.2" valign="top" width="38.93%"><p>竖屏</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.7.3.1.4.1.3" valign="top" width="51.07000000000001%"><p>横屏</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="10%"><p>手机</p> </td> <td align="center" class="cellrowborder" valign="top" width="38.93%"><p><span><img height="563.4146000000001" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.82063785700689651839437688515910:50001231000000:2800:3EAF93AE679979A52412CE373DFBCCCDC2C7B98F9EEB1FCA08882ED2490891DE.png" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="51.07000000000001%"><p><span><img height="209.7743016510034" originheight="1092" originwidth="2317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.50616523568479682616269519543134:50001231000000:2800:11C559ED4227C4B0CF23A9B023782D01F6EDDC6E65429F9420A62FDAE1EAB853.png" title="点击放大" width="445.8440000000001"></span></p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="10%"><p>折叠屏</p> </td> <td align="center" class="cellrowborder" valign="top" width="38.93%"><p><span><img height="296.40380000000005" originheight="2425" originwidth="2176" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163345.32175820530533779976138629906593:50001231000000:2800:24B39EF0D5482002D3F1ED1DFBE441A0C7B0C38F7C03DE172A5BA87BE7D3FFCC.png" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="51.07000000000001%"><p><span><img height="266" originheight="2176" originwidth="2425" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163346.61617170710771039327678897315838:50001231000000:2800:C55D164461D91EB27253790930347235E6DCEDFF6C0344F8C3DC897719853841.png" title="点击放大" width="296.49690000000004"></span></p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="10%"><p>平板</p> </td> <td align="center" class="cellrowborder" valign="top" width="38.93%"><p><span><img height="411.4089" originheight="3524" originwidth="2278" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163346.67436852534977108453926157285645:50001231000000:2800:657C7EFB1489E491C152A986572A0AA32A4CC6A027D62389EB266810C3EFBFDF.png" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="51.07000000000001%"><p><span><img height="266" originheight="2278" originwidth="3524" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163346.41799037835852243157931157894264:50001231000000:2800:E1BCACFB799B7FE56FB4B467E44422926231428247AD2CEDD82103EFE6F475B5.png" title="点击放大" width="411.94090000000006"></span></p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="10%"><p>2in1</p> </td> <td align="center" class="cellrowborder" valign="top" width="38.93%"><p>无竖屏效果</p> </td> <td align="center" class="cellrowborder" valign="top" width="51.07000000000001%"><p><span><img height="253.9187733333334" originheight="1928" originwidth="3378" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.39135265146325214996138504145172:50001231000000:2800:3030B7D649A12A413724D024E753DC2C2E5B08BB7B53F45F58FE43271C9C964B.png" title="点击放大" width="445.8440000000001"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section19775184774410">规则描述<i class="anchor-icon anchor-icon-link" anchorid="section19775184774410" tips="复制节点链接"></i></h3><p>adaptive_video提供短视频自适应旋转的能力，降低开发者在多端设备上适配短视频页面旋转的工作量，确保短视频页面的旋转属性与当前主流应用的旋转属性相符合。总的来说，adaptive_video综合考虑设备类型、屏幕区间、视频类型、屏幕方向等因素，根据旋转规则自动设置屏幕旋转属性，并提供页面布局变化的监听功能。</p> <p>以下是adaptive_video使用的自适应旋转计算规则：</p> <ul><li>设备类型：2in1/PC、车机、TV不支持旋转，其他类型设备支持旋转。</li><li>屏幕区间：根据应用窗口宽高计算设备所在的屏幕区间。计算规则如下图，屏幕区间由应用窗口宽（图中横轴，单位为vp）和窗口宽高比（图中纵轴）计算得到，例如，设备Mate60（竖向）的屏幕区间为：Small_Portrait。<p><span><img height="453.8474486294719" originheight="1149" originwidth="2331" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.18704379251232066226555542528366:50001231000000:2800:74758BEDD2AE3341B2949DF5CA16148379204172FEEA9FA8BB6D6982EDCD5CC6.png" title="点击放大" width="920"></span></p> </li><li>视频类型：根据视频宽高判定：横向视频（宽&gt;高）、竖向视频（宽≤高）。</li><li>屏幕方向：根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-sensor#gravity9" target="_blank">重力传感器</a>判定：0：竖屏，1：反向横屏，2：反向竖屏， 3：横屏 。</li></ul> <p>以下是自适应旋转属性的详细计算规则：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.6.1.6.1.1" valign="top" width="8.680868086808681%"><p>序号</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.6.1.2" valign="top" width="18.011801180118013%"><p>屏幕区间</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.6.1.3" valign="top" width="10.26102610261026%"><p>视频类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.6.1.4" valign="top" width="12.51125112511251%"><p>全屏/非全屏</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.6.1.6.1.5" valign="top" width="50.53505350535053%"><p>屏幕方向：旋转属性</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>1</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Portrait</p> <p>Medium_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，2，3：window.Orientation.USER_ROTATION_LANDSCAPE</p> <p>1：window.Orientation.USER_ROTATION_LANDSCAPE_INVERTED</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>2</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Portrait</p> <p>Medium_Landscape</p> <p>Small_Square</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>竖向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.PORTRAIT</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>3</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Portrait</p> <p>Medium_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>非全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.USER_ROTATION_PORTRAIT</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>4</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Portrait</p> <p>Medium_Landscape</p> <p>Small_Square</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>竖向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>非全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.PORTRAIT</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>5</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Square</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>非全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.PORTRAIT</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>6</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Small_Square</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.PORTRAIT,</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>7</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Medium_Portrait</p> <p>Medium_Square</p> <p>Large_Portrait</p> <p>Large_Landscape</p> <p>Large_Square</p> <p>XLarge_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.AUTO_ROTATION_UNSPECIFIED,</p> <p></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>8</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Medium_Portrait</p> <p>Medium_Square</p> <p>Large_Portrait</p> <p>Large_Landscape</p> <p>Large_Square</p> <p>XLarge_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>竖向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.AUTO_ROTATION_UNSPECIFIED,</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>9</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Medium_Portrait</p> <p>Medium_Square</p> <p>Large_Portrait</p> <p>Large_Landscape</p> <p>Large_Square</p> <p>XLarge_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>横向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>非全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.AUTO_ROTATION_UNSPECIFIED,</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.680868086808681%"><p>10</p> </td> <td class="cellrowborder" valign="top" width="18.011801180118013%"><p>Medium_Portrait</p> <p>Medium_Square</p> <p>Large_Portrait</p> <p>Large_Landscape</p> <p>Large_Square</p> <p>XLarge_Landscape</p> </td> <td class="cellrowborder" valign="top" width="10.26102610261026%"><p>竖向视频</p> </td> <td class="cellrowborder" valign="top" width="12.51125112511251%"><p>非全屏</p> </td> <td class="cellrowborder" valign="top" width="50.53505350535053%"><p>0，1，2，3：window.Orientation.AUTO_ROTATION_UNSPECIFIED,</p> </td> </tr>  </tbody></table></div> </div> <p>当设备的短视频页面无法匹配上述旋转规则时，则设定旋转属性为：window.Orientation.UNSPECIFIED。关于窗口旋转属性，详情可见： <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-e#orientation9" target="_blank">window.Orientation</a>。</p> </div> <div class="tiledSection"><h3 id="section10768175918472">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section10768175918472" tips="复制节点链接"></i></h3><ul><li>从adaptive_video三方库导入AdaptiveRotation自适应旋转工具、ScreenModeNotifier页面布局变换工具并初始化。导入后开发者可直接通过调用AdaptiveRotation的接口设置视频页面旋转属性，并通过ScreenModeNotifier监听页面布局变换通知。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L25-L646" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { AdaptiveRotation, ScreenMode, ScreenModeNotifier } from <span class="hljs-string">'@hadss/adaptive_video'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">const</span> adaptiveRotation = AdaptiveRotation.getInstance(); <span class="hljs-comment">// get AdaptiveRotation instance</span></li><li><span class="hljs-keyword">const</span> screenModeNotifier: ScreenModeNotifier = ScreenModeNotifier.getInstance(); <span class="hljs-comment">// get ScreenModeNotifier instance</span></li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Component</span></li><li>export struct AdaptiveAVPlayer {</li><li>  <span class="hljs-comment">// ...</span></li><li>  aboutToAppear(): void {</li><li>    <span class="hljs-comment">// ...</span></li><li>    adaptiveRotation.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>.context) <span class="hljs-comment">// The UIAbilityContext is initialized with the adaptive rotation tool.</span></li><li>    screenModeNotifier.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>.context) <span class="hljs-comment">// Initialize the page layout transformation tool in the UIAbilityContext.</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L25-L646" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> </li><li>定义屏幕布局模式变化回调函数并注册。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L409-L640" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  screenModeNotifier.<span class="hljs-title function_">onScreenModeChange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">onScreenModeChange</span>); <span class="hljs-comment">// Register a screen mode listener</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Non-full-screen video playback</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">changePortraitVideo</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Exit the full-screen mode</span></li><li>    adaptiveRotation?.<span class="hljs-title function_">setOrientationNotFullScreen</span>({</li><li>      <span class="hljs-attr">width</span>: oriWidth, <span class="hljs-attr">height</span>: oriHeight</li><li>    }) <span class="hljs-comment">// Input the width and height of the current video to be played, control the rotation attribute, and play the video vertically</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`changePortraitVideo error = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// Horizontal full-screen video playback</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setOrientationFullScreen</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Play the video in full screen mode</span></li><li>    adaptiveRotation?.<span class="hljs-title function_">setOrientationFullScreen</span>({</li><li>      <span class="hljs-attr">width</span>: oriWidth, <span class="hljs-attr">height</span>: oriHeight</li><li>    }); <span class="hljs-comment">// Input the width and height of the current video, control the rotation attribute, and horizontal full-screen playback effect</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`setOrientationFullScreen error = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// Toggle Notifier with Layout</span></li><li><span class="hljs-keyword">private</span> onScreenModeChange = <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>) {</li><li>    <span class="hljs-comment">// Indicates that only the current listener on the foreground is processed</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentScreen</span> = data</li><li>    <span class="hljs-keyword">if</span> (data === <span class="hljs-title class_">ScreenMode</span>.<span class="hljs-property">FULL_SCREEN</span>) {</li><li>      <span class="hljs-comment">// UI layout switching logic when the horizontal layout needs to be entered (for example, when the horizontal video is played in full screen mode)</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`screen switch to fullScreen`</span>)</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hideTab</span> = <span class="hljs-literal">true</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setOrientationFullScreen</span>(); <span class="hljs-comment">// Invoke the full-screen playback method</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// UI layout switching logic when the vertical layout needs to be entered (for example, when the horizontal video exits full screen)</span></li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`screen switch to notFullScreen`</span>)</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hideTab</span> = <span class="hljs-literal">false</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changePortraitVideo</span>(); <span class="hljs-comment">// Invoke a non-full-screen player method</span></li><li>    }</li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L409-L640" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> </li><li>页面进入全屏播放时。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L568-L572" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Play the video in full screen mode</span></li><li><span class="hljs-variable">adaptiveRotation</span>?.<span class="hljs-title function_">setOrientationFullScreen</span>({</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">oriWidth</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">oriHeight</span></li><li>}); <span class="hljs-comment">// Input the width and height of the current video, control the rotation attribute, and horizontal full-screen playback effect</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L568-L572" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> </li><li>页面进入非全屏播放时。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L531-L535" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Exit the full-screen mode</span></li><li><span class="hljs-variable">adaptiveRotation</span>?.<span class="hljs-title function_">setOrientationNotFullScreen</span>({</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">oriWidth</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">oriHeight</span></li><li>}) <span class="hljs-comment">// Input the width and height of the current video to be played, control the rotation attribute, and play the video vertically</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L531-L535" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> </li><li>退出视频播放界面时，注销布局模式通知相关的监听。<div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L430-L431" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Unregister the screen mode listener</span></li><li>screenModeNotifier.offScreenModeChange(<span class="hljs-keyword">this</span>.onScreenModeChange);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/AdaptiveAVPlayer.ets#L430-L431" target="_blank">AdaptiveAVPlayer.ets</a></div></div></div></div> <p></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>短视频滑动播放页面通常懒加载了多个视频播放组件，这些组件包括不同宽高比例的视频。在视频切换时，需要重新调用AdaptiveRotation的接口来设置当前页面视频对应的旋转属性。</p> </div></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section111652915509">视频自适应沉浸高阶组件<i class="anchor-icon anchor-icon-link" anchorid="section111652915509" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17151182105110" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section17151182105110" tips="复制节点链接"></i></h3><p>视频播放页面通常包含以下核心元素：视频播放组件、沉浸式页面布局、视频加载与预加载、视频播放状态管理、视频旋转方向适配，以及与用户交互相关的事件。整体设计需兼顾流畅性、响应性与沉浸体验，确保用户在滑动浏览时能享受连续且一致的视觉感受。基于上述要素，adaptive_video提供了视频自适应沉浸高阶组件AdaptiveVideoComponent，帮助开发者高效构建视频播放场景。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><th align="center" class="firstcol" id="mcps1.3.11.3.1.4.1.1" valign="top" width="10.440000000000001%"><p>设备</p> </th> <td align="center" class="cellrowborder" valign="top" width="43.03%"><p>手机</p> </td> <td align="center" class="cellrowborder" valign="top" width="46.53%"><p>折叠屏展开</p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.11.3.1.4.2.1" valign="top" width="10.440000000000001%"><p>实现效果图</p> </th> <td align="center" class="cellrowborder" valign="top" width="43.03%"><p><span><img height="563.4146000000001" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.81154400873299421667555724126485:50001231000000:2800:49D1332E00D0DE16AF903ACBD17AD5418CC8A3A7E7EC85D329E67698490BBA4D.png" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="46.53%"><p><span><img height="450.2490389436736" originheight="2425" originwidth="2176" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.38636376562418925413330305269258:50001231000000:2800:4D9222C100C8ECE76B1E03D8ED5D9FCFC54EA2C9728687617DDE40257EF04242.png" title="点击放大" width="404.07599999999996"></span></p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.11.3.1.4.3.1" valign="top" width="10.440000000000001%"><p>设备</p> </th> <td align="center" class="cellrowborder" valign="top" width="43.03%"><p>平板</p> </td> <td align="center" class="cellrowborder" valign="top" width="46.53%"><p>2in1</p> </td> </tr> <tr><th align="center" class="firstcol" id="mcps1.3.11.3.1.4.4.1" valign="top" width="10.440000000000001%"><p>实现效果图</p> </th> <td align="center" class="cellrowborder" valign="top" width="43.03%"><p><span><img height="240.12914473896615" originheight="2278" originwidth="3524" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.67680413812877628417405928722793:50001231000000:2800:EE19674956E68B1E24C832AAC9F7D54B22D38CC370EA20514EF0297A8489B459.png" title="点击放大" width="371.876"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="46.53%"><p><span><img height="230.1312754506364" originheight="1928" originwidth="3378" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163347.24552755165859289407848145710771:50001231000000:2800:2572D7DAF4CCAE6409DC14610FD8D8C1EAE760FEC0E24B43D8728A99E4665AE7.png" title="点击放大" width="404.07599999999996"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section160462565112">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section160462565112" tips="复制节点链接"></i></h3><p>AdaptiveVideoComponent基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#xcomponent12" target="_blank">XComponent</a>实现，内部封装了自适应沉浸工具，无需开发者实现沉浸式布局。AdaptiveVideoComponent对外提供了视频播放控制器、播放过程事件监听接口，支持自定义默认组件（如播放图标、进度条）的样式与交互事件回调，开发者可根据实际需求灵活调整组件样式与交互行为。关于AdaptiveVideoComponent的使用，详情可参考<a href="https://gitcode.com/openharmony-sig/hadss_adaptive/tree/master/adaptive_video" target="_blank">adaptive_video使用说明</a>。</p> </div> <div class="tiledSection"><h3 id="section19168114616512">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section19168114616512" tips="复制节点链接"></i></h3><p>基于AdaptiveVideoComponent组件实现视频播放页面。使用该组件时，需提供视频源，同时指定视频控制器和播放监听器，以实现对视频状态的控制与逻辑处理。</p> <p>以短视频滑动页面为例，以下是使用AdaptiveVideoComponent组件的部分代码示例，其中，curIndex表示当前正在播放的视频播放器索引，index表示当前组件播放器索引。</p> <div class="screenLinkPre"><div _ngcontent-qni-c106="" class="highlight-div"><div _ngcontent-qni-c106="" class="highlight-div-header"><div _ngcontent-qni-c106="" class="highlight-div-header-left"><div _ngcontent-qni-c106="" class="handle-button expand-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qni-c106="" class="highlight-div-header-right"><div _ngcontent-qni-c106="" class="handle-button ai-button"></div><div _ngcontent-qni-c106="" class="handle-button line-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qni-c106="" class="handle-button theme-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qni-c106="" class="handle-button copy-button"><div _ngcontent-qni-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qni-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/CustomAdaptiveVideoComponent.ets#L125-L369" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">RelativeContainer</span>() {</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">AdaptiveVideoComponent</span>({</li><li>          <span class="hljs-variable">dataSource</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">dataSource</span>, <span class="hljs-comment">// Video playback source, which can be a URL or a file descriptor</span></li><li>          <span class="hljs-variable">adaptiveVideoController</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">adaptiveVideoController</span>, <span class="hljs-comment">// Video controller</span></li><li>          <span class="hljs-variable">adaptiveVideoListener</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">adaptiveVideoListener</span>, <span class="hljs-comment">// Video player listener, used to get the status/event of the currently playing video</span></li><li>          <span class="hljs-variable">isAutoPlay</span>: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// Auto play</span></li><li>          <span class="hljs-variable">isLoop</span>: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// Loop playback</span></li><li>          <span class="hljs-variable">viewMode</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">viewMode</span>, <span class="hljs-comment">// Video view mode</span></li><li>          <span class="hljs-variable">curIndex</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">curIndex</span>, <span class="hljs-comment">// Current Playback Index</span></li><li>          <span class="hljs-variable">index</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">index</span>, <span class="hljs-comment">// Player Index</span></li><li>          <span class="hljs-variable">bottomTabHeight</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">bottomTabHeight</span>, <span class="hljs-comment">// Bottom tab height</span></li><li>          <span class="hljs-variable">isFullScreenIconShow</span>: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// Show default full screen icon</span></li><li>          <span class="hljs-variable">adaptiveVideoSetting</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">adaptiveVideoSetting</span>, <span class="hljs-comment">// Video Player Config Options</span></li><li>          <span class="hljs-variable">isProgressBarShow</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isProgressBarShow</span> <span class="hljs-comment">// Show progress bar</span></li><li>        })</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-variable">adaptiveVideoSetting</span>?: <span class="hljs-title class_">AdaptiveVideoSetting</span> = {</li><li>  <span class="hljs-variable">interactionEventSetting</span>: {</li><li>    <span class="hljs-variable">onFullScreenIconClick</span>: () =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable">adaptiveRotation</span>.<span class="hljs-title function_">setOrientationFullScreen</span>({</li><li>        <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentVideoSize</span>.<span class="hljs-title class_">width</span>, <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentVideoSize</span>.<span class="hljs-title class_">height</span></li><li>      }) <span class="hljs-comment">// Pass in the width and height of the current video being played, control the rotation property, and achieve a horizontal full-screen playback effect</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">viewMode</span> = <span class="hljs-variable">ViewMode</span>.<span class="hljs-variable">FULL_SCREEN</span> <span class="hljs-comment">// The component mode is full screen mode</span></li><li>    },</li><li>    <span class="hljs-variable">onSingleClick</span>: () =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// Click the video to pause/play the video</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">controlPlayOrPause</span>();</li><li>        <span class="hljs-comment">// ...</span></li><li>    },</li><li>    <span class="hljs-variable">onDoubleClick</span>: () =&gt; {</li><li>      <span class="hljs-comment">// Double-click event handling</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    },</li><li>    <span class="hljs-variable">onLongPress</span>: () =&gt; {</li><li>      <span class="hljs-comment">// Long press event handling</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">adaptiveVideoController</span>?.<span class="hljs-variable">avPlayer</span>?.<span class="hljs-title function_">setSpeed</span>(<span class="hljs-variable">media</span>.<span class="hljs-variable">PlaybackSpeed</span>.<span class="hljs-variable">SPEED_FORWARD_2_00_X</span>)</li><li>      <span class="hljs-comment">// ...</span></li><li>    },</li><li>    <span class="hljs-variable">onLongPressEnd</span>: () =&gt; {</li><li>      <span class="hljs-comment">// Long press event end processing</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">adaptiveVideoController</span>?.<span class="hljs-variable">avPlayer</span>?.<span class="hljs-title function_">setSpeed</span>(<span class="hljs-variable">media</span>.<span class="hljs-variable">PlaybackSpeed</span>.<span class="hljs-variable">SPEED_FORWARD_1_00_X</span>)</li><li>    }</li><li>  },</li><li>  <span class="hljs-variable">progressBarSetting</span>: {</li><li>    <span class="hljs-variable">selectedColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-title class_">White</span>,</li><li>    <span class="hljs-variable">trackColor</span>: <span class="hljs-string">'#1AFFFFFF'</span>,</li><li>    <span class="hljs-variable">isTimeTextShow</span>: <span class="hljs-keyword">false</span></li><li>  } <span class="hljs-comment">// Progress config</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo/blob/master/features/adaptive_video_component/src/main/ets/components/CustomAdaptiveVideoComponent.ets#L125-L369" target="_blank">CustomAdaptiveVideoComponent.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section14757182985913">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section14757182985913" tips="复制节点链接"></i></h2></div> <ul><li>调用接口后未达到预期效果，如无法实现预期的沉浸式布局，视频页面无法根据旋转属性进行旋转</li></ul> <p>使用adaptive_video中的自适应工具前，需要调用init()方法进行初始化。</p> <ul><li>在实现短视频滑动播放页面时，视频播放器应选择使用单个AVPlayer还是多个AVPlayer</li></ul> <p>使用多个AVPlayer，每个AVPlayer控制一个视频播放，确保各视频的播放状态相互独立，并根据视频播放器的索引保证同一时间最多只有一个AVPlayer处于“playing”状态。</p> <ul><li>视频滑动播放页面的旋转属性需在点击全屏播放（调用setOrientationFullScreen()）后才能生效</li></ul> <p>可能是因为非全屏页面未设置初始旋转属性，建议在进入视频滑动页面或视频切换时主动调用一次AdaptiveRotation的setOrientationNotFullScreen()方法。</p> <div class="tiledSection"><h2 id="section9352821602">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section9352821602" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/AdaptiveVideo" target="_blank">基于adaptive_video的短视频适配</a></li></ul> </div> </div> <div></div></div>