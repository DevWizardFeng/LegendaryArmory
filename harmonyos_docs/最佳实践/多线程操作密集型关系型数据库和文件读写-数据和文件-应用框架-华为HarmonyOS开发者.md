<h1 _ngcontent-hff-c119="" class="doc-title ng-star-inserted" title="多线程操作密集型关系型数据库和文件读写"> 多线程操作密集型关系型数据库和文件读写 </h1>

<div _ngcontent-hff-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section14957205611294">概述<i class="anchor-icon anchor-icon-link" anchorid="section14957205611294" tips="复制节点链接"></i></h2><p>应用中的每个进程都会有一个主线程，主线程主要承担执行UI绘制操作、管理ArkTS引擎实例的创建和销毁、分发和处理事件、管理Ability生命周期等职责，具体可参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/thread-model-stage" target="_blank">线程模型概述</a>。在主线程中执行耗时操作将会引起UI绘制卡顿，因此，开发应用时应当尽量避免将耗时的操作放在主线程中执行。ArkTS提供了多线程并发能力，多线程并发允许在同一时间段内同时执行多段代码，本文介绍如何利用多线程解决密集型文件和数据库读写时造成主线程阻塞的问题。</p> </div> <div class="tiledSection"><h2 id="section9321235123011">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section9321235123011" tips="复制节点链接"></i></h2><p>在密集型读写操作时，由于系统会进行大量任务分发和数据拷贝，这两项任务均会阻塞主线程，系统提供了TaskPool和Sendable避免阻塞。</p> <p>其中，任务池（TaskPool）旨在为应用程序构建多线程运行环境，它具有易用性，并且可以避免对于主线程的占用；Sendable对象则提供了并发实例间高效的通信效率，凭借其引用传递的能力，在多并发实例的数据交互等场景中可避免传统通信方式的效率低下问题，从而进一步提升系统在密集型读写这类复杂场景下的性能表现，为系统的高效稳定运行提供有力支持。</p> </div> <div class="tiledSection"><h2 id="section11297165319308">使用TaskPool进行读写<i class="anchor-icon anchor-icon-link" anchorid="section11297165319308" tips="复制节点链接"></i></h2><p>本章介绍使用TaskPool进行读写的方案，以及讨论其对于性能的提升。</p> </div> <div class="tiledSection"><h3 id="section105041559115610" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section105041559115610" tips="复制节点链接"></i></h3><p>任务池（TaskPool）作用是为应用程序提供一个多线程的运行环境，降低整体资源的消耗、提高系统的整体性能，且开发者无需关心线程实例的生命周期。更多原理请详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction" target="_blank">TaskPool简介</a>。</p> <p><span><img height="371.55478500000004" originheight="535" originwidth="800" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.42310061616119084962595234024729:50001231000000:2800:0417BEE0BA6A221769ED4428ABB0C036933DA13AF240B46902DDC5BB0AF0377B.png" title="点击放大" width="555.6075000000001"></span></p> <p>TaskPool在执行密集型I/O读写方面具有以下优势：</p> <ol><li>自动任务分发：当调用Taskpool执行密集型读写时，其线程池会自动将任务分发到子线程完成，无需人工干预，实现了高效的任务分配流程。</li><li>不阻塞主线程：通过在子线程完成任务，有效避免了对主线程的阻塞，确保主线程能够继续执行其他操作，维持系统整体的流畅运行。</li><li>资源节约：TaskPool本身通过系统统一线程管理，结合动态调度及负载均衡算法可节约系统资源，这也为执行密集型读写提供了更优的系统资源环境，保障操作的顺利进行。</li></ol> </div> <div class="tiledSection"><h3 id="section2069102965716">TaskPool文件读写<i class="anchor-icon anchor-icon-link" anchorid="section2069102965716" tips="复制节点链接"></i></h3><p><strong>开发步骤</strong></p> <ol><li>封装write()函数，使用@Concurrent进行装饰，执行的并发函数需要使用该装饰器修饰，否则无法通过相关校验。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L21-L26" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">writeFile</span>(<span class="hljs-variable">fd</span>: <span class="hljs-title class_">number</span>[], <span class="hljs-variable">content</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">times</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">times</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">content</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L21-L26" target="_blank">FileTaskPool.ets</a></div></div></div></div> </li><li>封装read()函数，同样地，也使用@Concurrent进行装饰。在读文件时使用循环读取，这也是大文件读取时常用的方法，使用Array&lt;ArrayBuffer&gt;存储一个大文件中的信息。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L30-L56" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-variable">fd</span>: <span class="hljs-title class_">number</span>[], <span class="hljs-variable">path</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">fileName</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">times</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt; = [];</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">times</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">buffSize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">4096</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">state</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">statSync</span>(<span class="hljs-variable">path</span> + <span class="hljs-variable">fileName</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">i</span>) + <span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FILE_SUFFIX</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> === <span class="hljs-number">0</span>){</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable">buffSize</span>, <span class="hljs-variable">state</span>.<span class="hljs-variable">size</span>));</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">off</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">buffer</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">off</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">buffSize</span> });</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">readLen</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bufferList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt; = [];</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">len</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable">readLen</span> += <span class="hljs-variable">len</span>;</li><li>      <span class="hljs-variable">bufferList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">buffer</span>);</li><li>      <span class="hljs-variable">off</span> = <span class="hljs-variable">off</span> + <span class="hljs-variable">len</span>;</li><li>      <span class="hljs-keyword">if</span> ((<span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> - <span class="hljs-variable">readLen</span>) &lt; <span class="hljs-title class_">buffSize</span>) {</li><li>        <span class="hljs-variable">buffSize</span> = <span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> - <span class="hljs-variable">readLen</span>;</li><li>      }</li><li>      <span class="hljs-variable">len</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">buffer</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">off</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">buffSize</span> });</li><li>    }</li><li>    <span class="hljs-variable">result</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">bufferList</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L30-L56" target="_blank">FileTaskPool.ets</a></div></div></div></div> </li><li>使用taskpool.execute()执行任务时，传入的第一个参数是调用的函数名，其余参数则是该函数的参数。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L85-L100" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">write</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(writeFile, <span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">times</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">read</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> value = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(readFile, <span class="hljs-variable language_">this</span>.<span class="hljs-property">fd</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">path</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span>,</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">times</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt;;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">return</span> value.<span class="hljs-property">length</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileTaskPool.ets#L85-L100" target="_blank">FileTaskPool.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section14313183745718">TaskPool关系型数据库读写<i class="anchor-icon anchor-icon-link" anchorid="section14313183745718" tips="复制节点链接"></i></h3><p><strong>开发步骤</strong></p> <ol><li>封装关系型数据库的写数据库的函数，使用@Concurrent进行装饰。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L29-L34" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">async</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>, <span class="hljs-variable">valueBucket</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">ValuesBucket</span>&gt;,</li><li>  <span class="hljs-variable">config</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">store</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">relationalStore</span>.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">config</span>);</li><li>  <span class="hljs-variable">store</span>.<span class="hljs-title function_">batchInsert</span>(<span class="hljs-string">'EMPLOYEE'</span>, <span class="hljs-variable">valueBucket</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L29-L34" target="_blank">DatabaseTaskPool.ets</a></div></div></div></div> </li><li>封装数据库读出的函数，使用getRow()和goToNextRow()循环读出符合查询条件的数据，这里读出所有数据。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L38-L54" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title class_">Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-params">context: common.UIAbilityContext, config: relationalStore.StoreConfig</span>) {</li><li>  <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">await</span> relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, config);</li><li>  <span class="hljs-keyword">const</span> predicates = <span class="hljs-keyword">new</span> relationalStore.<span class="hljs-title class_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>  <span class="hljs-keyword">const</span> resultSet = store.<span class="hljs-title function_">querySync</span>(predicates);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">ValuesBucketArray</span>: <span class="hljs-title class_">ValuesBucket</span>[] = [];</li><li>  <span class="hljs-keyword">if</span> (resultSet.<span class="hljs-property">rowCount</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ValuesBucketArray</span>;</li><li>  }</li><li>  resultSet.<span class="hljs-title function_">goToFirstRow</span>();</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ValuesBucket</span> = resultSet.<span class="hljs-title function_">getRow</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">ValuesBucket</span>;</li><li>    <span class="hljs-title class_">ValuesBucketArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">ValuesBucket</span>);</li><li>  } <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>());</li><li>  resultSet.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ValuesBucketArray</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L38-L54" target="_blank">DatabaseTaskPool.ets</a></div></div></div></div> </li><li>taskpool.execute()执行任务。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L82-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">insertRDB</span>(): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {</li><li>  <span class="hljs-keyword">await</span> taskpool.execute(insert, <span class="hljs-keyword">this</span>.context, <span class="hljs-keyword">this</span>.valueBucketArray, STORE_CONFIG);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseTaskPool.ets#L82-L85" target="_blank">DatabaseTaskPool.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section593713717336">使用Sendable进一步提升性能<i class="anchor-icon anchor-icon-link" anchorid="section593713717336" tips="复制节点链接"></i></h2><p>在上一章节中介绍了如何使用TaskPool进行读写，解决了密集型读写场景下任务分发的的问题，但是实际开发中还面临密集的数据传递问题，系统提供了@Sendable进行解决，本章将介绍如何在TaskPool基础上使用@Sendable。</p> </div> <div class="tiledSection"><h3 id="section21301620933" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section21301620933" tips="复制节点链接"></i></h3><p>为了实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable支持的数据类型" target="_blank">Sendable数据</a>在不同并发实例间的引用传递，Sendable共享对象会分配在共享堆中，以实现跨并发实例的内存共享。</p> <p>共享堆（SharedHeap）是进程级别的堆空间，与虚拟机本地堆（LocalHeap）不同的是，LocalHeap只能被单个并发实例访问，而SharedHeap可以被所有线程访问。一个Sendable共享对象的跨线程行为是引用传递。因此，Sendable可能被多个并发实例引用，判断Sendable共享对象是否存活，取决于所有并发实例的对象是否存在对此Sendable共享对象的引用，更多原理请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable的实现原理" target="_blank">Sendable的实现原理</a>。</p> <p><span><img originheight="348" originwidth="592" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163006.21442251153388737524446509746285:50001231000000:2800:A667DD57B59DF3E6FB80DB2A0693ABCAFA2A037E5AAB5E10F5F957718E91436F.png" width="592" height="348"></span></p> <p>在密集型I/O处理场景中，文件读写会涉及大量数据的传输，而数据库读写则通常被封装成class进行传递，Sendable用引用代替拷贝，可以有效的降低序列化时间，从而提升性能，Sendable主要可以解决两个场景的问题：</p> <ul><li>跨并发实例传输大数据（例如可能达到100KB以上的数据）。</li><li>跨并发实例传递带方法的class实例对象。</li></ul> </div> <div class="tiledSection"><h3 id="section11887447137">文件读写大数据使用@Sendable传输<i class="anchor-icon anchor-icon-link" anchorid="section11887447137" tips="复制节点链接"></i></h3><p><strong>开发步骤</strong></p> <ol><li>在使用@Sendable进行文件写入操作时，首先需要定义Sendable对象存放写入数据，然后封装TaskPool函数传入。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L21-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span> {</li><li>  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L21-L28" target="_blank">FileSendable.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L32-L37" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">writeFile</span>(<span class="hljs-variable">fd</span>: <span class="hljs-title class_">number</span>[], <span class="hljs-variable">content</span>: <span class="hljs-title class_">Content</span>, <span class="hljs-variable">times</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">times</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">content</span>.<span class="hljs-variable">content</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L32-L37" target="_blank">FileSendable.ets</a></div></div></div></div> </li><li>接下来进行读取操作，封装TaskPool函数，需要使用collections.Array代替Array，collections.ArrayBuffer代替ArrayBuffer接收结果值，在使用Sendable时，需要注意该数据类型Sendable是否支持，详情请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-sendable#sendable支持的数据类型" target="_blank">sendable支持的数据类型</a>。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L41-L69" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-variable">fd</span>: <span class="hljs-title class_">number</span>[], <span class="hljs-variable">path</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">fileName</span>: <span class="hljs-title class_">string</span>,</li><li>  <span class="hljs-variable">times</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt; =</li><li>    <span class="hljs-variable">new</span> <span class="hljs-variable">collections</span>.<span class="hljs-variable">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span>&gt;&gt;();</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">times</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">buffSize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">4096</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">state</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">statSync</span>(<span class="hljs-variable">path</span> + <span class="hljs-variable">fileName</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">i</span>) + <span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">FILE_SUFFIX</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">collections</span>.<span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable">buffSize</span>, <span class="hljs-variable">state</span>.<span class="hljs-variable">size</span>));</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">off</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">buffer</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">ArrayBuffer</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">off</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">buffSize</span> });</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">readLen</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">bufferList</span>: <span class="hljs-title class_">collections</span>.<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span>&gt; = <span class="hljs-variable">new</span> <span class="hljs-variable">collections</span>.<span class="hljs-variable">Array</span>&lt;<span class="hljs-title class_">collections</span>.<span class="hljs-title class_">ArrayBuffer</span>&gt;();</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">len</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable">readLen</span> += <span class="hljs-variable">len</span>;</li><li>      <span class="hljs-variable">bufferList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">buffer</span>);</li><li>      <span class="hljs-variable">off</span> = <span class="hljs-variable">off</span> + <span class="hljs-variable">len</span>;</li><li>      <span class="hljs-keyword">if</span> ((<span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> - <span class="hljs-variable">readLen</span>) &lt; <span class="hljs-title class_">buffSize</span>) {</li><li>        <span class="hljs-variable">buffSize</span> = <span class="hljs-variable">state</span>.<span class="hljs-variable">size</span> - <span class="hljs-variable">readLen</span>;</li><li>      }</li><li>      <span class="hljs-variable">len</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">fd</span>[<span class="hljs-variable">i</span>], <span class="hljs-variable">buffer</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">ArrayBuffer</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">off</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">buffSize</span> });</li><li>    }</li><li>    <span class="hljs-variable">result</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">bufferList</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L41-L69" target="_blank">FileSendable.ets</a></div></div></div></div> </li><li>taskpool.execute()执行任务。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L98-L113" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">write</span>(): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {</li><li>  <span class="hljs-keyword">await</span> taskpool.execute(writeFile, <span class="hljs-keyword">this</span>.fd, <span class="hljs-keyword">this</span>.content, <span class="hljs-keyword">this</span>.times);</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">read</span>(): Promise&lt;number&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-keyword">value</span> = <span class="hljs-keyword">await</span> taskpool.execute(readFile, <span class="hljs-keyword">this</span>.fd, <span class="hljs-keyword">this</span>.path, <span class="hljs-keyword">this</span>.fileName,</li><li>    <span class="hljs-keyword">this</span>.times) <span class="hljs-keyword">as</span> collections.Array&lt;collections.Array&lt;collections.ArrayBuffer&gt;&gt;;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>.length;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/FileSendable.ets#L98-L113" target="_blank">FileSendable.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section38051851418">关系型数据库读写使用@Sendable<i class="anchor-icon anchor-icon-link" anchorid="section38051851418" tips="复制节点链接"></i></h3><p><strong>开发步骤</strong></p> <ol><li>在关系型数据库写入操作时，同样需要封装写入数据使用@Sendable进行装饰，传入TaskPool函数中。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L29-L40" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Sendable</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedValuesBucket</span> {</li><li>  <span class="hljs-variable">NAME</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">AGE</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">SALARY</span>: <span class="hljs-title class_">number</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">NAME</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">AGE</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">SALARY</span>: <span class="hljs-title class_">number</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">NAME</span> = <span class="hljs-variable">NAME</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">AGE</span> = <span class="hljs-variable">AGE</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">SALARY</span> = <span class="hljs-variable">SALARY</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L29-L40" target="_blank">DatabaseSendable.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L44-L49" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">async</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">insert</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>, <span class="hljs-variable">valueBucket</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">SharedValuesBucket</span>&gt;,</li><li>  <span class="hljs-variable">config</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">store</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">relationalStore</span>.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">config</span>);</li><li>  <span class="hljs-variable">store</span>.<span class="hljs-title function_">batchInsert</span>(<span class="hljs-string">'EMPLOYEE'</span>, <span class="hljs-variable">valueBucket</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">object</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">Array</span>&lt;<span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">ValuesBucket</span>&gt;);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L44-L49" target="_blank">DatabaseSendable.ets</a></div></div></div></div> </li><li>在读取时，关系型数据库模块提供了getSendableRow()可以直接获取当前行数据的Sendable形式。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L53-L69" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Concurrent</span></li><li><span class="hljs-variable">async</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">read</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>, <span class="hljs-variable">config</span>: <span class="hljs-title class_">relationalStore</span>.<span class="hljs-title class_">StoreConfig</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">store</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">relationalStore</span>.<span class="hljs-title function_">getRdbStore</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">config</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">predicates</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">relationalStore</span>.<span class="hljs-title function_">RdbPredicates</span>(<span class="hljs-string">'EMPLOYEE'</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">resultSet</span> = <span class="hljs-variable">store</span>.<span class="hljs-title function_">querySync</span>(<span class="hljs-variable">predicates</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">ValuesBucketArray</span>: <span class="hljs-title class_">sendableRelationalStore</span>.<span class="hljs-title class_">ValuesBucket</span>[] = [];</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">resultSet</span>.<span class="hljs-variable">rowCount</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">ValuesBucketArray</span>;</li><li>  }</li><li>  <span class="hljs-variable">resultSet</span>.<span class="hljs-title function_">goToFirstRow</span>();</li><li>  <span class="hljs-keyword">do</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">ValuesBucket</span> = <span class="hljs-variable">resultSet</span>.<span class="hljs-title function_">getSendableRow</span>();</li><li>    <span class="hljs-variable">ValuesBucketArray</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">ValuesBucket</span>);</li><li>  } <span class="hljs-keyword">while</span> (<span class="hljs-variable">resultSet</span>.<span class="hljs-title function_">goToNextRow</span>());</li><li>  <span class="hljs-variable">resultSet</span>.<span class="hljs-title function_">close</span>();</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">ValuesBucketArray</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L53-L69" target="_blank">DatabaseSendable.ets</a></div></div></div></div> </li><li>taskpool.execute()执行任务。<div class="screenLinkPre"><div _ngcontent-hff-c106="" class="highlight-div"><div _ngcontent-hff-c106="" class="highlight-div-header"><div _ngcontent-hff-c106="" class="highlight-div-header-left"><div _ngcontent-hff-c106="" class="handle-button expand-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-hff-c106="" class="highlight-div-header-right"><div _ngcontent-hff-c106="" class="handle-button ai-button"></div><div _ngcontent-hff-c106="" class="handle-button line-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-hff-c106="" class="handle-button theme-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-hff-c106="" class="handle-button copy-button"><div _ngcontent-hff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-hff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L93-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">insertRDB</span>(): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {</li><li>  <span class="hljs-keyword">await</span> taskpool.execute(insert, <span class="hljs-keyword">this</span>.context, <span class="hljs-keyword">this</span>.valueBucketArray, STORE_CONFIG);</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">readRDB</span>(): Promise&lt;number&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-keyword">value</span> = <span class="hljs-keyword">await</span> taskpool.execute(read, <span class="hljs-keyword">this</span>.context, STORE_CONFIG) <span class="hljs-keyword">as</span> sendableRelationalStore.ValuesBucket[];</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>.length;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/blob/master/entry/src/main/ets/common/utils/DatabaseSendable.ets#L93-L101" target="_blank">DatabaseSendable.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/MultiThreadIO/tree/master" target="_blank">多线程操作密集型关系型数据库和文件读写</a></li></ul> </div> </div> <div></div></div>