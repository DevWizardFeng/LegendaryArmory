<h1 _ngcontent-lrx-c119="" class="doc-title ng-star-inserted" title="多网并发网络加速"> 多网并发网络加速 </h1>

<div _ngcontent-lrx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1177584124015">概述<i class="anchor-icon anchor-icon-link" anchorid="section1177584124015" tips="复制节点链接"></i></h2><p>网络数据传输是应用的核心功能场景之一，而传输的性能直接决定着用户体验——例如高清晰度视频/图片的加载、大文件的上传下载、设备间多文件的同步迁移等场景，有限的网络传输性能导致的卡顿、长时间等待往往会导致用户使用感受变差。针对此类性能敏感的场景，Network Boost Kit的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/networkboost-netmultipathguide" target="_blank">多网并发</a>能力提供了网络加速的解决方案。</p> <p>本文将介绍多网并发的机制原理与基本开发流程，并结合大文件分片传输和多文件并发传输两个实际应用场景介绍多网并发能力的适配方案。</p> </div> <div class="tiledSection"><h2 id="section1943112334918">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1943112334918" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1091512315474" class="firsth2">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section1091512315474" tips="复制节点链接"></i></h3><p>多网并发是指通过系统接口同时建立并使用多个网络通路，例如同时使用Wi-Fi和流量，或者主卡和副卡的流量通路。通过多网并发，可以突破默认单网传输的带宽和速率限制，达到网络传输加速的效果。应用发起多网请求后，系统依据业务场景决定并发组合和实施相应的并发管控，并对并发做收益度量。使用多网并发功能的原则是应用申请（受限权限）、系统管控、最小化使用。</p> </div> <div class="tiledSection"><h3 id="section5836104344711">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section5836104344711" tips="复制节点链接"></i></h3><ol><li>开发前准备<p>多网并发能力在设备类型、网络状态及开发方案的选择上存在一定限制，具体接入要求可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/networkboost-netmultipath-request-release" target="_blank">多网发起和释放</a>，开发者也可以在调试过程中通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section8508131819279" target="_blank">请求多网错误码</a>分析。</p> </li><li>发起多网并发<p>(1) 权限配置：应用使用多网并发等网络加速能力，连接迁移能力部分接口需要ohos.permission.LINKTURBO权限，权限配置方法参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/networkboost-preparations#section1648815561221" target="_blank">申请权限步骤</a>。同时此权限为受限ACL权限需要特别配置和申请，具体操作步骤参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/networkboost-preparations#section94731428358" target="_blank">配置签名</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/networkboost-preparations#section13192154213515" target="_blank">受限ACL权限申请</a>。</p> <p>(2) 发起流程：多网并发能力发起的核心步骤包括<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netboost#section13106021163" target="_blank">netBoost.setSceneDesc()</a>设置多网场景、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section47829529513" target="_blank">netHandover.getMultiPathQuotaStats()</a>查询多网配额、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section8508131819279" target="_blank">netHandover.requestMultiPath()</a>请求发起多网以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section7919111205211" target="_blank">netHandover.on('multiPathStateChange')</a>多网状态监听，详细实现可参考<a href="/consumer/cn/doc/best-practices/bpta-multi-path-network-turbo#li4874151714524">多网发起与接入</a>。</p> </li><li>获取多网NetHandle并绑定Socket<p>(1) 成功发起多网请求后，可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section7919111205211" target="_blank">netHandover.on('multiPathStateChange')</a>回调中监听并获取到可用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#nethandle" target="_blank">NetHandle</a>数据网络句柄对象。</p> <p>(2) 针对需要在多网路径上传输的数据，创建对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-socket#tcpsocket" target="_blank">TCP Socket</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-socket#udpsocket" target="_blank">UDP Socket</a>，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#bindsocket9" target="_blank">bindSocket()</a>方法将Socket对象绑定到NetHandle对应的网络上。</p> </li><li>Socket发起网络传输任务<p>绑定网络后，TCP/UDP Socket进行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/socket-connection#应用通过tcp-socket-server进行数据传输" target="_blank">数据传输</a>时将会使用对应的网络通路，多个Socket使用不同的网络通路同时发起网络传输任务就可以起到多网并发的效果。</p> </li></ol> </div> <div class="tiledSection"><h2 id="section880284716486">大文件分片传输<i class="anchor-icon anchor-icon-link" anchorid="section880284716486" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6892104710498" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section6892104710498" tips="复制节点链接"></i></h3><p>当发布视频帖子、下载应用资源包时，应用本质上在进行大文件网络传输，通过将大文件分片可以充分发挥多网并发能力，将不同文件片段分配给不同网络通路同时传输，能极大地加快传输速度。</p> </div> <div class="tiledSection"><h3 id="section422613575020">关键技术<i class="anchor-icon anchor-icon-link" anchorid="section422613575020" tips="复制节点链接"></i></h3><ol><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/network-boost-kit-guide" target="_blank">Network Boost Kit</a>：多网能力的发起、监听、状态管理与绑定。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection" target="_blank">@ohos.net.connection</a>：网络连接管理，网络通路获取。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/socket-connection" target="_blank">Socket数据传输</a>：创建网络连接，执行网络传输任务。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/taskpool-introduction" target="_blank">TaskPool</a>：管理多线程网络并发任务。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs" target="_blank">@ohos.file.fs</a>：负责文件管理，包括文件分片、大小查询等。</li></ol> </div> <div class="tiledSection"><h3 id="section6369192220501">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section6369192220501" tips="复制节点链接"></i></h3><p><span><img height="56.79055624566564" originheight="375" originwidth="6075" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163027.62415575109859987299941877653291:50001231000000:2800:9E1F2D4BFC7F9A53707575DDDCDF2AFC7A0CC97704C2E483D82EE363AA5F70BA.png" title="点击放大" width="920"></span></p> </div> <div class="tiledSection"><h3 id="section4981241145011">代码实现<i class="anchor-icon anchor-icon-link" anchorid="section4981241145011" tips="复制节点链接"></i></h3><ol><li id="li4874151714524">多网发起与接入<div class="p">根据当前网络传输任务通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netboost#section13106021163" target="_blank">netBoost.setSceneDesc()</a>设置多网场景，帮助系统进行多网并发管控和业务时长分析，当前对于文件分片上传任务选择'upload'场景。<div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L44-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Enter or exit 'upload' scene.</span></li><li><span class="hljs-comment"> * @param enter true enter,false exit.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">setUploadSceneDesc</span>(<span class="hljs-variable">enter</span>: <span class="hljs-title class_">boolean</span>): <span class="hljs-title class_">boolean</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sceneDesc</span>: <span class="hljs-title class_">netBoost</span>.<span class="hljs-title class_">SceneDesc</span> = {</li><li>      <span class="hljs-variable">scene</span>: <span class="hljs-string">'upload'</span>,</li><li>      <span class="hljs-variable">sceneEvent</span>: <span class="hljs-title class_">enter</span> ? <span class="hljs-title class_">netBoost</span>.<span class="hljs-title class_">SceneEvent</span>.<span class="hljs-title class_">SCENE_EVENT_ENTER</span> : <span class="hljs-title class_">netBoost</span>.<span class="hljs-title class_">SceneEvent</span>.<span class="hljs-title class_">SCENE_EVENT_LEAVE</span></li><li>    };</li><li>    <span class="hljs-variable">netBoost</span>.<span class="hljs-title function_">setSceneDesc</span>(<span class="hljs-variable">sceneDesc</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span> = <span class="hljs-variable">err</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">DOMAIN</span>, <span class="hljs-variable">TAG</span>, `[<span class="hljs-variable">setUploadSceneDesc</span>] <span class="hljs-variable">Error</span>:${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>},${<span class="hljs-variable">error</span>.<span class="hljs-variable">name</span>}`);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L44-L61" target="_blank">NetBoostManager.ets</a></div></div></div></div> </div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section47829529513" target="_blank">netHandover.getMultiPathQuotaStats()</a>获取当前多网配额，包括次数和时长等，应用可按需添加业务逻辑如提示用户剩余配额等。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L176-L189" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Obtain multi-network quota information.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">multi</span>-network quota.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMultiPathQuota</span>(<span class="hljs-params"></span>): netHandover.<span class="hljs-property">MultiPathQuota</span> | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">quota</span>: netHandover.<span class="hljs-property">MultiPathQuota</span> = netHandover.<span class="hljs-title function_">getMultiPathQuotaStats</span>();</li><li>    <span class="hljs-keyword">return</span> quota;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[getMultiPathQuota] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L176-L189" target="_blank">NetBoostManager.ets</a></div></div></div></div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section8508131819279" target="_blank">netHandover.requestMultiPath()</a>请求开启多网，支持Wi-Fi和蜂窝并发以及主卡和副卡并发，不支持开发者指定并发组合，并发组合由系统决定。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L65-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Request a multi-network path.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> Returns true on success, otherwise false.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestMultiPath</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      netHandover.<span class="hljs-title function_">requestMultiPath</span>(<span class="hljs-function">(<span class="hljs-params">data: netHandover.MultiPathRequestResult</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (data &amp;&amp; data.<span class="hljs-property">result</span> === netHandover.<span class="hljs-property">MultiPathErrorResult</span>.<span class="hljs-property">MULTIPATH_ERROR_NONE</span>) {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[requestMultiPath] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L65-L85" target="_blank">NetBoostManager.ets</a></div></div></div></div> <p>多网请求成功后还需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section7919111205211" target="_blank">netHandover.on('multiPathStateChange')</a>监听多网状态，确认多网络通路的使能与可用情况，记录可用的NetHandle信息。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L139-L159" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Enable multi-network listening.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> netHandleChange The callback when the netHandle changes.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setOnMultiPathStateChange</span>(<span class="hljs-params">netHandleChange: NetHandleChange</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    netHandover.<span class="hljs-title function_">on</span>(<span class="hljs-string">'multiPathStateChange'</span>, <span class="hljs-function">(<span class="hljs-params">data: netHandover.MultiPathStateInfo</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">multiPathState</span> === netHandover.<span class="hljs-property">MultiPathState</span>.<span class="hljs-property">MULTIPATH_CREATED</span> &amp;&amp;</li><li>        data.<span class="hljs-property">netHandle</span>.<span class="hljs-property">netId</span> &gt;= <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">MIN_USEFUL_NET_ID</span>) {</li><li>        netHandleChange?.<span class="hljs-title function_">onMultiNetSuccess</span>(data.<span class="hljs-property">netHandle</span>);</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">multiPathState</span> === netHandover.<span class="hljs-property">MultiPathState</span>.<span class="hljs-property">MULTIPATH_CREATING</span>) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[setOnMultiPathStateChange.multiPathStateChange] <span class="hljs-subst">${data.netHandle.netId}</span> Creating`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        netHandleChange?.<span class="hljs-title function_">onMultiNetRelease</span>(data.<span class="hljs-property">netHandle</span>);</li><li>      }</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[setOnMultiPathStateChange] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L139-L159" target="_blank">NetBoostManager.ets</a></div></div></div></div> </li><li>多网通路绑定Socket<p>封装网络查询函数，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetallnetssync10" target="_blank">connection.getAllNetsSync()</a>获取当前所有网络信息。由于网络传输任务一般放在子线程实现，而当前无法跨线程传递Socket对象和NetHandle对象，为了在子线程实现网络与Socket绑定需要获取所有网络信息，再通过之前请求多网后记录的NetHandle对象的ID找到指定网络在执行绑定操作；如果应用业务不涉及多线程问题可直接绑定上一步多网状态监听中获取到的NetHandle。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetConnectionManager.ets#L44-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Get all netHandles.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> Returns all netHandles on success,otherwise returns undefined</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getAllNetHandles</span>(<span class="hljs-params"></span>): connection.<span class="hljs-property">NetHandle</span>[] | <span class="hljs-literal">undefined</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> netHandles = connection.<span class="hljs-title function_">getAllNetsSync</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">constNetHandles</span>: connection.<span class="hljs-property">NetHandle</span>[] = [];</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; netHandles.<span class="hljs-property">length</span>; i++) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[getAllNetHandles] success [<span class="hljs-subst">${i}</span>]&gt;&gt;&gt;<span class="hljs-subst">${netHandles[i].netId}</span>`</span>);</li><li>      <span class="hljs-keyword">if</span> (netHandles[i].<span class="hljs-property">netId</span> &gt;= <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">MIN_USEFUL_NET_ID</span>) {</li><li>        constNetHandles.<span class="hljs-title function_">push</span>(netHandles[i]);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> constNetHandles;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[getAllNetHandles] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetConnectionManager.ets#L44-L64" target="_blank">NetConnectionManager.ets</a></div></div></div></div> <p>遍历获取到的所有网络，将多网状态监听中记录的可用网络通过bindSocket()绑定到Socket上，后续的TCP Socket进行网络传输任务时将会使用绑定的网络。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L193-L227" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Binds the socket to the specified network path.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> socketInstance  socket client.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> netId netHandle Id.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> port binds port.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bindSpecifiedNet</span>(<span class="hljs-params">socketInstance: socket.TCPSocket, netId: <span class="hljs-built_in">number</span>, port: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">const</span> netHandles = <span class="hljs-title function_">getAllNetHandles</span>();</li><li>  <span class="hljs-keyword">if</span> (netHandles) {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; netHandles.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">if</span> (netHandles[i].<span class="hljs-property">netId</span> === netId) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">const</span> connectionProperties = connection.<span class="hljs-title function_">getConnectionPropertiesSync</span>(netHandles[i]);</li><li>          <span class="hljs-keyword">if</span> (connectionProperties &amp;&amp; connectionProperties.<span class="hljs-property">linkAddresses</span> &amp;&amp;</li><li>            connectionProperties.<span class="hljs-property">linkAddresses</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">netAddress</span>: socket.<span class="hljs-property">NetAddress</span> = {</li><li>              <span class="hljs-attr">address</span>: connectionProperties.<span class="hljs-property">linkAddresses</span>[<span class="hljs-number">0</span>].<span class="hljs-property">address</span>.<span class="hljs-property">address</span>,</li><li>              <span class="hljs-attr">port</span>: port</li><li>            };</li><li>            <span class="hljs-keyword">await</span> socketInstance.<span class="hljs-title function_">bind</span>(netAddress);</li><li>            <span class="hljs-keyword">await</span> netHandles[i].<span class="hljs-title function_">bindSocket</span>(socketInstance);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[socketBindNet] Get ConnectionProperties error`</span>);</li><li>          }</li><li>        } <span class="hljs-keyword">catch</span> (err) {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[socketBindNet] Error occurred:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>        }</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Net Empty`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L193-L227" target="_blank">NetBoostManager.ets</a></div></div></div></div> </li><li>文件分片处理<p>封装文件处理类，设置分片文件数据结构，包括当前文件片段数量、开始位置、分片大小、片段重试次数等信息。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L25-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * File upload chunk info.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUpChunk</span> {</li><li>  <span class="hljs-variable">chunkNumber</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-variable">startPosition</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">chunkSize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-number">0</span>);</li><li>  <span class="hljs-variable">retryTimes</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L25-L34" target="_blank">FileUtils.ets</a></div></div></div></div> <p>提供方法根据文件大小计算分片规格，开发者可根据业务需要自行实现分片策略。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L183-L189" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getChunkSize</span>(<span class="hljs-params">fileSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MB</span> = <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">MIN_SLICE_FILE_SIZE</span>;</li><li>  <span class="hljs-keyword">const</span> fullMBs = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(fileSize / <span class="hljs-variable constant_">MB</span>);</li><li>  <span class="hljs-keyword">let</span> res = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">MAX_SLICE_FILE_COUNT</span>, fullMBs));</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[getChunkSize] FileSize:<span class="hljs-subst">${fileSize}</span>,ChunkSize:<span class="hljs-subst">${res}</span>`</span>);</li><li>  <span class="hljs-keyword">return</span> res;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L183-L189" target="_blank">FileUtils.ets</a></div></div></div></div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#fsstatsync" target="_blank">fs.statSync()</a>获取待上传文件的大小等信息，按照计算出的分片规格对文件进行分片处理。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L152-L179" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Splits the file into segments.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> file An opened file</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> Returns all segments of the file.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">splitFile</span>(<span class="hljs-params">file: fileIo.File</span>): <span class="hljs-title class_">FileUpChunk</span>[] {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> fileStat = fileIo.<span class="hljs-title function_">statSync</span>(file.<span class="hljs-property">fd</span>);</li><li>    <span class="hljs-keyword">const</span> fileSize = fileStat.<span class="hljs-property">size</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">FileUpChunk</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> chunkNumber = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">const</span> splitChunkSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(fileStat.<span class="hljs-property">size</span> / <span class="hljs-title function_">getChunkSize</span>(fileSize));</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>; start &lt; fileSize; start += splitChunkSize) {</li><li>      <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(splitChunkSize, fileSize - start);</li><li>      <span class="hljs-keyword">const</span> chunk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileUpChunk</span>();</li><li>      chunk.<span class="hljs-property">chunkNumber</span> = chunkNumber++;</li><li>      chunk.<span class="hljs-property">startPosition</span> = start;</li><li>      chunk.<span class="hljs-property">chunkSize</span> = chunkSize;</li><li>      chunks.<span class="hljs-title function_">push</span>(chunk);</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[splitFile] success`</span>);</li><li>    <span class="hljs-keyword">return</span> chunks;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[splitFile] errror:<span class="hljs-subst">${err.code}</span>,<span class="hljs-subst">${err.name}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> [];</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/utils/FileUtils.ets#L152-L179" target="_blank">FileUtils.ets</a></div></div></div></div> </li><li>多Socket并发上传不同文件片段<p>封装分片文件上传类，提供初始化分片上传接口，通知服务端待上传文件片段对应的存储路径。此处代码片段仅供参考，开发者可以根据自己业务的实际实现方式调整通信格式、请求参数等。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L32-L95" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Initializes the upload.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> host Server host.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> port Server port.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> uploadFileName File save path.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> Returns a 'InitiateMultipartUpload' object if success,otherwise returns undefined.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMultiPartUpload</span>(<span class="hljs-params">host: <span class="hljs-built_in">string</span>, port: <span class="hljs-built_in">number</span>,</span></li><li><span class="hljs-params">  uploadFileName: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">InitiateMultipartUpload</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">objectKey</span>: <span class="hljs-built_in">string</span> = uploadFileName;</li><li>  <span class="hljs-keyword">const</span> path = <span class="hljs-string">`/<span class="hljs-subst">${objectKey}</span>?uploads`</span>;</li><li>  <span class="hljs-keyword">const</span> method = http.<span class="hljs-property">RequestMethod</span>.<span class="hljs-property">POST</span>;</li><li>  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toUTCString</span>();</li><li>
</li><li>  <span class="hljs-comment">// build request headers</span></li><li>  <span class="hljs-keyword">const</span> headers = [</li><li>    <span class="hljs-string">`Host: <span class="hljs-subst">${host}</span>`</span>,</li><li>    <span class="hljs-string">`Date: <span class="hljs-subst">${date}</span>`</span>,</li><li>    <span class="hljs-string">`Content-Length: 0`</span>,</li><li>    <span class="hljs-string">`Content-Type: application/xml`</span>,</li><li>    <span class="hljs-string">`Connection: close`</span></li><li>  ];</li><li>
</li><li>  <span class="hljs-comment">// build request info</span></li><li>  <span class="hljs-keyword">const</span> request = <span class="hljs-string">`<span class="hljs-subst">${method}</span> <span class="hljs-subst">${path}</span> HTTP/1.1\r\n`</span> + headers.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\r\n'</span>) + <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">HEADER_BODY_DELIMITER</span>;</li><li>  <span class="hljs-comment">// request data by socket</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">value</span>: socket.<span class="hljs-property">SocketMessageInfo</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataBySocket</span>(host, port, request);</li><li>  <span class="hljs-comment">// parse result</span></li><li>  <span class="hljs-keyword">if</span> (value) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> responseStr = buffer.<span class="hljs-title function_">from</span>(value.<span class="hljs-property">message</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'utf-8'</span>);</li><li>      <span class="hljs-keyword">const</span> uploadIdMatch = responseStr.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;UploadId&gt;(.*?)&lt;\/UploadId&gt;/</span>);</li><li>      <span class="hljs-keyword">if</span> (uploadIdMatch &amp;&amp; uploadIdMatch[<span class="hljs-number">1</span>]) {</li><li>        <span class="hljs-comment">// start build 'InitiateMultipartUpload' object</span></li><li>        <span class="hljs-keyword">let</span> result = <span class="hljs-title class_">XmlUtils</span>.<span class="hljs-title function_">xmlToObj</span>(<span class="hljs-title function_">extractHttpBody</span>(responseStr), <span class="hljs-literal">true</span>);</li><li>        <span class="hljs-keyword">if</span> (result &amp;&amp; result[<span class="hljs-string">'initiateMultipartUploadResult'</span>]) {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">json</span>: <span class="hljs-built_in">object</span> = result[<span class="hljs-string">'initiateMultipartUploadResult'</span>];</li><li>          <span class="hljs-keyword">if</span> (json) {</li><li>            <span class="hljs-keyword">return</span> {</li><li>              <span class="hljs-attr">bucket</span>: json[<span class="hljs-string">'bucket'</span>],</li><li>              <span class="hljs-attr">key</span>: json[<span class="hljs-string">'key'</span>],</li><li>              <span class="hljs-attr">uploadId</span>: json[<span class="hljs-string">'uploadId'</span>]</li><li>            } <span class="hljs-keyword">as</span> <span class="hljs-title class_">InitiateMultipartUpload</span>;</li><li>          }</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FilePartsUploadManager'</span>,</li><li>            <span class="hljs-string">`[initiateMultipartUploadResult.onResult]: parse xml info error`</span>);</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FilePartsUploadManager'</span>, <span class="hljs-string">`[initMultiPartUpload] onMessage ignore`</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FilePartsUploadManager'</span>, <span class="hljs-string">`[uploadPart] buffer.from error:<span class="hljs-subst">${err.code}</span>,<span class="hljs-subst">${err.name}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L32-L95" target="_blank">FilePartsUploadManager.ets</a></div></div></div></div> <p>封装网络上传接口，包括创建TCP Socket实例并绑定到指定网络NetHandle、设置网络请求头等配置、通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-socket#send-2" target="_blank">TCPSocket.send()</a>方法发送请求至服务端并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-socket#onmessage-1" target="_blank">TCPSocket.on('message')</a>监听响应。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L99-L162" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Upload file segment.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> host Server host.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> port Server port.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> initResult An 'InitiateMultipartUpload' object.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> fileChunk File info to uploaded.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> netId The ID of the netHandle to bind.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> Returns a 'UploadPartResult' object if success,otherwise returns undefined</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-meta">@Concurrent</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadSegment</span>(<span class="hljs-params">host: <span class="hljs-built_in">string</span>, port: <span class="hljs-built_in">number</span>, initResult: InitiateMultipartUpload, fileChunk: FileUpChunk,</span></li><li><span class="hljs-params">  netId: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UploadPartResult</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">socketInstance</span>: socket.<span class="hljs-property">TCPSocket</span> = socket.<span class="hljs-title function_">constructTCPSocketInstance</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">bindSpecifiedNet</span>(socketInstance, netId, <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">SOCKET_BIND_UP_PORT</span>);</li><li>
</li><li>  <span class="hljs-keyword">const</span> path = <span class="hljs-string">`/<span class="hljs-subst">${initResult.key}</span>?partNumber=<span class="hljs-subst">${fileChunk.chunkNumber}</span>&amp;uploadId=<span class="hljs-subst">${initResult.uploadId}</span>`</span>;</li><li>  <span class="hljs-keyword">const</span> method = http.<span class="hljs-property">RequestMethod</span>.<span class="hljs-property">PUT</span>;</li><li>  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toUTCString</span>();</li><li>  <span class="hljs-comment">// build request header</span></li><li>  <span class="hljs-keyword">const</span> headers = [</li><li>    <span class="hljs-string">`Host: <span class="hljs-subst">${host}</span>`</span>,</li><li>    <span class="hljs-string">`Date: <span class="hljs-subst">${date}</span>`</span>,</li><li>    <span class="hljs-string">`Content-Length: <span class="hljs-subst">${fileChunk.chunkSize}</span>`</span>,</li><li>    <span class="hljs-string">`Content-Type: application/octet-stream`</span>,</li><li>    <span class="hljs-string">`Connection: close`</span></li><li>  ];</li><li>
</li><li>  <span class="hljs-keyword">const</span> requestHeader = <span class="hljs-string">`<span class="hljs-subst">${method}</span> <span class="hljs-subst">${path}</span> HTTP/1.1\r\n`</span> + headers.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\r\n'</span>) + <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">HEADER_BODY_DELIMITER</span>;</li><li>  <span class="hljs-keyword">const</span> headerBuffer = buffer.<span class="hljs-title function_">from</span>(requestHeader, <span class="hljs-string">'utf-8'</span>).<span class="hljs-property">buffer</span>;</li><li>
</li><li>  <span class="hljs-comment">// build request header and body</span></li><li>  <span class="hljs-keyword">const</span> requestBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(headerBuffer.<span class="hljs-property">byteLength</span> + fileChunk.<span class="hljs-property">buffer</span>.<span class="hljs-property">byteLength</span>);</li><li>  requestBuffer.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(headerBuffer), <span class="hljs-number">0</span>);</li><li>  requestBuffer.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(fileChunk.<span class="hljs-property">buffer</span>), headerBuffer.<span class="hljs-property">byteLength</span>);</li><li>  <span class="hljs-comment">// get value from socket</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">value</span>: socket.<span class="hljs-property">SocketMessageInfo</span> | <span class="hljs-literal">undefined</span> =</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataBySocket</span>(host, port, requestBuffer.<span class="hljs-property">buffer</span>, socketInstance);</li><li>
</li><li>  <span class="hljs-comment">// parse value</span></li><li>  <span class="hljs-keyword">if</span> (value) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> responseStr = buffer.<span class="hljs-title function_">from</span>(value.<span class="hljs-property">message</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'utf-8'</span>);</li><li>      <span class="hljs-comment">// Get ETag</span></li><li>      <span class="hljs-keyword">const</span> eTagMatch = responseStr.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/ETag: "([^"]+)"/</span>);</li><li>      <span class="hljs-keyword">if</span> (eTagMatch &amp;&amp; eTagMatch[<span class="hljs-number">1</span>]) {</li><li>        <span class="hljs-keyword">return</span> ({</li><li>          <span class="hljs-attr">partNumber</span>: fileChunk.<span class="hljs-property">chunkNumber</span>,</li><li>          <span class="hljs-attr">eTag</span>: eTagMatch[<span class="hljs-number">1</span>]</li><li>        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">UploadPartResult</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FilePartsUploadManager'</span>,</li><li>          <span class="hljs-string">`[uploadPart] onMessage--&gt; fileChunkId:<span class="hljs-subst">${fileChunk.chunkNumber}</span> upload Faild`</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FilePartsUploadManager'</span>,</li><li>        <span class="hljs-string">`[uploadPart] buffer.from error:<span class="hljs-subst">${err.code}</span>,<span class="hljs-subst">${err.name}</span>,fileChunkId:<span class="hljs-subst">${fileChunk.chunkNumber}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L99-L162" target="_blank">FilePartsUploadManager.ets</a></div></div></div></div> <p>通过网络上传接口封装文件片段传输方法，包括读取当前文件片段、为当前NetHandle创建子线程发起上传任务、根据文件分片信息更新上传进度、以及失败重试等逻辑。在当前片段传输完毕后循环调用此方法上传剩余片段，直至无片段剩余。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L316-L356" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Upload file segment using assigned net.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> async uploadFileChunkWithNet(netHandle: connection.NetHandle) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.abortUpload) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fileChunks.length === <span class="hljs-number">0</span>) {</li><li>    hilog.info(DOMAIN, TAG, `[MultiNetworkUploader.uploadFileChunkWithNet] fileChunks empty`);</li><li>    <span class="hljs-keyword">this</span>.checkUploadSuccess();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">const</span> fileChunk = <span class="hljs-keyword">this</span>.fileChunks.shift()!;</li><li>  let fileChunkWithData = readFileChunkBuffer(<span class="hljs-keyword">this</span>.file!, fileChunk);</li><li>  <span class="hljs-comment">// start upload a file chunk</span></li><li>  <span class="hljs-keyword">if</span> (fileChunkWithData) {</li><li>    <span class="hljs-keyword">const</span> task =</li><li>      new taskpool.Task(uploadSegment, CommonConst.UP_HOST, CommonConst.HTTP_DEFAULT_PORT, <span class="hljs-keyword">this</span>.initMultipartUpload!,</li><li>        fileChunkWithData, netHandle.netId);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> uploadPartRes = await taskpool.execute(task);</li><li>      <span class="hljs-comment">// upload success</span></li><li>      <span class="hljs-keyword">if</span> (uploadPartRes) {</li><li>        <span class="hljs-keyword">this</span>.uploadResult.push(uploadPartRes <span class="hljs-keyword">as</span> UploadPartResult);</li><li>        <span class="hljs-keyword">this</span>.uploadFileChunkWithNet(netHandle);</li><li>        <span class="hljs-keyword">this</span>.onProgressUpdate(<span class="hljs-keyword">this</span>.uploadResult.length / <span class="hljs-keyword">this</span>.fileChunksSize);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.retryUpload(fileChunk, netHandle);</li><li>        hilog.error(DOMAIN, TAG, `[uploadFileChunkWithNet] upload failed`);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">this</span>.retryUpload(fileChunk, netHandle);</li><li>      <span class="hljs-keyword">const</span> err: BusinessError = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      hilog.error(DOMAIN, TAG, `[uploadFileChunkWithNet] taskpool error occurred:${err.code},${err.name}`);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.retryUpload(fileChunk, netHandle);</li><li>    hilog.error(DOMAIN, TAG, `[uploadFileChunkWithNet] readFileChunkBuffer failed`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L316-L356" target="_blank">FilePartsUploadManager.ets</a></div></div></div></div> <p>遍历NetHandle调用上传文件片段方法，为每个网络通路分配网络传输任务，实现多网络通路并发传输文件片段的效果。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L290-L307" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Start upload file.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> startUpload() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.netHandles || <span class="hljs-keyword">this</span>.netHandles.length === <span class="hljs-number">0</span>) {</li><li>    hilog.error(DOMAIN, TAG, `[MultiNetworkUploader.startUpload] netHandles <span class="hljs-keyword">is</span> empty`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.fileChunks || <span class="hljs-keyword">this</span>.fileChunks.length === <span class="hljs-number">0</span>) {</li><li>    hilog.error(DOMAIN, TAG, `[MultiNetworkUploader.startUpload] fileChunks <span class="hljs-keyword">is</span> empty`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.netHandles.length; i++) {</li><li>    <span class="hljs-keyword">this</span>.uploadFileChunkWithNet(<span class="hljs-keyword">this</span>.netHandles[i]);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L290-L307" target="_blank">FilePartsUploadManager.ets</a></div></div></div></div> </li><li>通知服务端整合分片文件<p>全部文件片段上传完毕后，通知服务端文件片段顺序，进行文件整合。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L398-L419" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  Merge all file segments.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">mergeSegmentsOnServer</span>(<span class="hljs-params"></span>) {</li><li>  fileIo.<span class="hljs-title function_">close</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>?.<span class="hljs-property">fd</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[mergeSegmentsOnServer] Close file error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>  });</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadResult</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">partNumber</span> - b.<span class="hljs-property">partNumber</span>);</li><li>  <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> taskpool.<span class="hljs-title class_">Task</span>(completeMultiPartUploadRequest, <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">UP_HOST</span>, <span class="hljs-title class_">CommonConst</span>.<span class="hljs-property">HTTP_DEFAULT_PORT</span>,</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">initMultipartUpload</span>!,</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadResult</span>);</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> taskpool.<span class="hljs-title function_">execute</span>(task);</li><li>    <span class="hljs-keyword">if</span> (res) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onUploadSuccess</span>();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onFailed</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onFailed</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/upload/FilePartsUploadManager.ets#L398-L419" target="_blank">FilePartsUploadManager.ets</a></div></div></div></div> </li><li>释放资源<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section196405414517" target="_blank">netHandover.releaseMultiPath()</a>释放多网，注销相关的监听方法。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/fxyyf1998/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L91-L181" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Stop multi net path.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">releaseMultiPath</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    netHandover.<span class="hljs-title function_">releaseMultiPath</span>();</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[releaseMultiPath] done`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[releaseMultiPath] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Stop listening on multiple network paths.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setOffMultiPathStateChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    netHandover.<span class="hljs-title function_">off</span>(<span class="hljs-string">'multiPathStateChange'</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[setOffMultiPathStateChange] off done`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">error</span>: <span class="hljs-title class_">BusinessError</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[setOffMultiPathStateChange] Error:<span class="hljs-subst">${error.code}</span>,<span class="hljs-subst">${error.name}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/fxyyf1998/NetBoost/blob/master/entry/src/main/ets/net/NetBoostManager.ets#L91-L181" target="_blank">NetBoostManager.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section14816428203814">多文件并发传输<i class="anchor-icon anchor-icon-link" anchorid="section14816428203814" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1350245103814" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1350245103814" tips="复制节点链接"></i></h3><p>当进行数据、文件同步，下载器下载资源时，往往会需要处理多个文件的传输任务，使用多网并发拓宽网络带宽，不同文件传输任务分配给不同网络通路并发传输，达到提升传输效率的效果。</p> <p>多文件并发传输与大文件分片传输对多网能力的使用原理相同，整体流程都是通过拉起多网后获取到多个netHandle，同时创建多个TCP Socket和不同netHandle绑定，再通过多个TCP Scoket建立连接并行发起传输任务，区别只在于分片传输每个连接传输的是文件片段，而本场景传输的是不同文件。此处以并发传输两个文件作为示例场景。</p> </div> <div class="tiledSection"><h3 id="section185031251153810">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section185031251153810" tips="复制节点链接"></i></h3><p><span><img height="56.79098904113764" originheight="375" originwidth="6075" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163027.98211112243548353335182159233103:50001231000000:2800:BDD26C4E6A0B7F862F451EC2F319721A12DDE2E37C6307A45D769539A9FDCDED.png" title="点击放大" width="920"></span></p> </div> <div class="tiledSection"><h3 id="section36548476389">代码实现<i class="anchor-icon anchor-icon-link" anchorid="section36548476389" tips="复制节点链接"></i></h3><p>多网接入和绑定部分与分片传输场景一致，此处不再赘述，仅提供关键差异部分代码:</p> <p>封装文件下载类，提供下载文件方法，根据下载对象链接与网络netId新建线程，发起文件下载任务。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/download/FileDownManager.ets#L174-L216" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Start download file.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">public</span> async startDownload() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downUrls) {</li><li>    <span class="hljs-keyword">this</span>.isFileDownloading = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">const</span> netId = <span class="hljs-keyword">this</span>.netHandle ? <span class="hljs-keyword">this</span>.netHandle.netId : -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">const</span> task = new taskpool.Task(getFileSizeWithNet, <span class="hljs-keyword">this</span>.downUrls, CommonConst.HTTP_DEFAULT_PORT, netId);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> fileSize = await taskpool.execute(task) <span class="hljs-keyword">as</span> number;</li><li>      <span class="hljs-keyword">if</span> (fileSize &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-comment">// notify download start</span></li><li>        <span class="hljs-keyword">this</span>.onDownStart(fileSize);</li><li>        <span class="hljs-keyword">this</span>.fileChunk.endPosition = fileSize;</li><li>        <span class="hljs-comment">// start download the file using taskpool</span></li><li>        <span class="hljs-keyword">const</span> downTask =</li><li>          new taskpool.Task(downloadFileChunkWithNet, <span class="hljs-keyword">this</span>.downUrls, CommonConst.HTTP_DEFAULT_PORT, <span class="hljs-keyword">this</span>.fileChunk,</li><li>            netId, <span class="hljs-keyword">this</span>.downListener);</li><li>        <span class="hljs-keyword">const</span> downRes = await taskpool.execute(downTask);</li><li>        <span class="hljs-keyword">if</span> (downRes) {</li><li>          <span class="hljs-comment">// notify download success</span></li><li>          <span class="hljs-keyword">this</span>.onDownSuccess();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-comment">// download failed,retry again</span></li><li>          <span class="hljs-keyword">this</span>.retryDownload();</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// download failed,retry again</span></li><li>        <span class="hljs-keyword">this</span>.retryDownload();</li><li>        hilog.error(DOMAIN, TAG, `[startDownload] upload failed`);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-comment">// download failed,retry again</span></li><li>      <span class="hljs-keyword">this</span>.retryDownload();</li><li>      <span class="hljs-keyword">const</span> err: BusinessError = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      hilog.error(DOMAIN, TAG, `[startDownload] taskpool error occurred:${err.code},${err.name}`);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.warn(DOMAIN, TAG, `[startDownload] Url <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>`);</li><li>    <span class="hljs-comment">// download failed,retry again</span></li><li>    <span class="hljs-keyword">this</span>.onDownFailed();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/viewmodel/download/FileDownManager.ets#L174-L216" target="_blank">FileDownManager.ets</a></div></div></div></div> <p>使用默认网络下载第一个文件，刷新对应的下载进度。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/pages/DownloadPage.ets#L113-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Downloads the first file using the specified netHandle.</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> netHandle The specified netHandle to access the server.</span></li><li><span class="hljs-comment"> * */</span></li><li><span class="hljs-keyword">private</span> startDownFirstFile(netHandle: connection.NetHandle) {</li><li>  <span class="hljs-keyword">this</span>.firstFileDownloader = new FileDownloadManager(<span class="hljs-keyword">this</span>.firstDownFileInfo!, netHandle);</li><li>  <span class="hljs-keyword">this</span>.firstFileDownloader.onProgress = (downloaded: number, fileSize: number, progress: number) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.downFirstProgress = progress;</li><li>    <span class="hljs-keyword">this</span>.downFirstProgressText = `${formatFileSize(downloaded)} / ${formatFileSize(fileSize)}`;</li><li>  }</li><li>  <span class="hljs-comment">// download success</span></li><li>  <span class="hljs-keyword">this</span>.firstFileDownloader.onSuccess = () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.firstFileDownloading = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.downBtnEnable = (!<span class="hljs-keyword">this</span>.firstFileDownloading) &amp;&amp; (!<span class="hljs-keyword">this</span>.secondFileDownloading) &amp;&amp; <span class="hljs-keyword">this</span>.taskArray.length === <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">this</span>.downFirstProgressColor = $r(<span class="hljs-string">'sys.color.confirm'</span>);</li><li>    let res = <span class="hljs-keyword">this</span>.taskArray.shift();</li><li>    <span class="hljs-keyword">this</span>.downFirstFileResult = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">if</span> (res) {</li><li>      <span class="hljs-keyword">this</span>.startDownSecondFile(netHandle);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      hilog.info(DOMAIN, TAG, `[startDownFirstFile]  File1 downloaded,no need to download File2`);</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// download failed</span></li><li>  <span class="hljs-keyword">this</span>.firstFileDownloader.onError = () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.firstFileDownloading = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.downBtnEnable = (!<span class="hljs-keyword">this</span>.firstFileDownloading) &amp;&amp; (!<span class="hljs-keyword">this</span>.secondFileDownloading);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downFirstProgress === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">this</span>.downFirstProgress = <span class="hljs-number">0.01</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.downFirstProgressColor = $r(<span class="hljs-string">'sys.color.multi_color_08'</span>);</li><li>    <span class="hljs-keyword">this</span>.taskArray.shift();</li><li>    <span class="hljs-keyword">this</span>.downFirstFileResult = $r(<span class="hljs-string">'app.string.down_failed'</span>);</li><li>  }</li><li>  <span class="hljs-comment">// init downloading status</span></li><li>  <span class="hljs-keyword">this</span>.firstFileDownloading = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">this</span>.downFirstProgress = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">this</span>.downFirstProgressColor = $r(<span class="hljs-string">'sys.color.comp_background_emphasize'</span>);</li><li>  <span class="hljs-keyword">this</span>.downFirstFileResult = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// start download</span></li><li>  <span class="hljs-keyword">this</span>.firstFileDownloader.startDownload();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/pages/DownloadPage.ets#L113-L154" target="_blank">DownloadPage.ets</a></div></div></div></div> <p>如果多网请求成功，在监听多网状态变更的回调中获取新的可用网络NetHandle，使用新网络NetHandle发起第二个文件的下载任务，达到并发下载的效果。</p> <div class="screenLinkPre"><div _ngcontent-lrx-c106="" class="highlight-div"><div _ngcontent-lrx-c106="" class="highlight-div-header"><div _ngcontent-lrx-c106="" class="highlight-div-header-left"><div _ngcontent-lrx-c106="" class="handle-button expand-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lrx-c106="" class="highlight-div-header-right"><div _ngcontent-lrx-c106="" class="handle-button ai-button"></div><div _ngcontent-lrx-c106="" class="handle-button line-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lrx-c106="" class="handle-button theme-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lrx-c106="" class="handle-button copy-button"><div _ngcontent-lrx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lrx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/pages/DownloadPage.ets#L67-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-attr">netHandleChange</span>: <span class="hljs-title class_">NetHandleChange</span> = {</li><li>  <span class="hljs-attr">onMultiNetSuccess</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">netHandle</span>: connection.<span class="hljs-property">NetHandle</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiNetHandle</span> = netHandle;</li><li>    <span class="hljs-keyword">let</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskArray</span>.<span class="hljs-title function_">shift</span>();</li><li>    <span class="hljs-keyword">if</span> (res) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startDownSecondFile</span>(netHandle);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`[netHandleChange] Multi-net enable,but no need to download file2`</span>);</li><li>    }</li><li>  },</li><li>
</li><li>  <span class="hljs-attr">onMultiNetRelease</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">netHandle</span>: connection.<span class="hljs-property">NetHandle</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiNetHandle</span> = <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetBoost/blob/master/entry/src/main/ets/pages/DownloadPage.ets#L67-L81" target="_blank">DownloadPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section20222046155115">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section20222046155115" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section873812112526" class="firsth2">在进行多网并发传输时，如何判断当前使用的网络是Wi-Fi还是流量<i class="anchor-icon anchor-icon-link" anchorid="section873812112526" tips="复制节点链接"></i></h3><p>请求多网成功后可以获取到多个可用的netHandle，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetnetcapabilities" target="_blank">connection.getNetCapabilities()</a>方法查询网络信息，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#netbeartype" target="_blank">NetBearType</a>字段判断网络类型，其中BEARER_CELLULAR是蜂窝网络，BEARER_WIFI是Wi-Fi网络。在设计多网并发策略时可以通过网络类型和网络能力调整对应网络通路的网络任务。</p> </div> <div class="tiledSection"><h3 id="section6899195716598">如果使用多网并发能力超过剩余配额限制，会发生什么<i class="anchor-icon anchor-icon-link" anchorid="section6899195716598" tips="复制节点链接"></i></h3><p>配额（次数或时长）耗尽会限制使用，多网会自动释放，应用可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section7919111205211" target="_blank">netHandover.on('multiPathStateChange')</a>中监听到多网退出回调。如果此时再请求多网会抛出错误码，应用可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-nethandover#section8508131819279" target="_blank">netHandover.requestMultiPath()</a>的错误码中判断错误类型。应用配额以24小时的周期进行刷新。</p> </div> <div class="tiledSection"><h2 id="section527525110195">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section527525110195" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/NetBoost" target="_blank">基于多网并发能力实现网络加速</a></li></ul> </div> </div></div>