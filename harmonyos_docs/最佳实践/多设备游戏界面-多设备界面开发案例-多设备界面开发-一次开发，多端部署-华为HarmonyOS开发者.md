<h1 _ngcontent-wyq-c119="" class="doc-title ng-star-inserted" title="多设备游戏界面"> 多设备游戏界面 </h1>

<div _ngcontent-wyq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section123002333589">概述<i class="anchor-icon anchor-icon-link" anchorid="section123002333589" tips="复制节点链接"></i></h2><p>本文选择游戏类应用作为典型案例，详细介绍“一多”策略在实际开发中的应用。游戏类应用由于其较强的互动性和操作性，特别重视用户的沉浸式体验，并且在大屏设备上，这类应用能够展现更广阔的视野，提供更加高效便捷的交互体验。</p> <ul><li>关键场景：<p>Native一多适配：通过监听断点变化，动态调整页面布局和元素。开发者可以从ArkTS侧获取断点值，并传入Native侧，使Native侧根据不同的断点值适配不同的页面及效果。</p> <p>安全区避让：在游戏类应用中，为确保用户的沉浸式体验，导航条会自动隐藏。这不仅增加可用的屏幕空间，还减少了视觉干扰，使用户更加专注于游戏本身。</p> <p>窗口旋转：由于不同游戏可能有特定的窗口方向偏好，可根据应用需求，自定义设置窗口的旋转方向，这对于游戏类应用尤其重要。</p> </li></ul> <p>游戏类应用需要适配多种屏幕尺寸，当前游戏类应用支持的主要产品形态包括手机、折叠屏和平板三种。下文将围绕这几种产品形态展开，同时从<a href="/consumer/cn/doc/best-practices/bpta-multi_game#section163791453125612">UX设计</a>、<a href="/consumer/cn/doc/best-practices/bpta-multi_game#section1383916515715">页面开发</a>两个角度分析介绍“一多”游戏类应用在开发过程中的关键场景实现方案。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-multi_game#section163791453125612">UX设计</a>章节介绍游戏类应用的页面逻辑与通用设计要点，提供可直接应用于实际项目中的设计模板与建议。</li><li><a href="/consumer/cn/doc/best-practices/bpta-multi_game#section1383916515715">页面开发</a>章节涵盖页面区域划分、一多适配、安全区域避让及屏幕旋转设置四个方面的详细指导，帮助开发者理解和实现游戏类应用中的关键开发场景。</li></ul> </div> <div class="tiledSection"><h2 id="section163791453125612">UX设计<i class="anchor-icon anchor-icon-link" anchorid="section163791453125612" tips="复制节点链接"></i></h2><p><strong>断点设计策略</strong></p> <p>游戏视野的大小对用户的游戏体验是一个重要的影响因素。在不同的设备和屏幕尺寸下，合理适配视野可以为用户提供更佳的游戏体验。以下是针对不同设备和屏幕尺寸的游戏视野适配策略：</p> <ol><li>手机（sm）<p>基础视野。</p> </li><li>双折叠展开态（md）<p>双折叠设备提供独特的挑战与机遇。在展开状态下，开发者可利用更大的屏幕空间扩展游戏视野，以增强游戏的沉浸感和信息显示，例如战绩展示。</p> <p>推荐做法：</p> <ul><li>基于手机视野，横向适当缺失部分视野，垂直方向扩充部分视野，确保补偿和缺失的面积相似，调整后整体视野同手机相似。</li><li>手机与双折叠展开态的横向视野保持一致，垂直方向拓展视野或利用留黑区域显示辅助信息，而非简单留黑，以优化屏幕空间利用，提升用户体验。</li></ul> </li><li>平板（lg）<div class="p">平板设备的布局策略与双折叠展开态类似：<ul><li>基于手机视野，横向适当缺失部分视野，垂直方向扩充部分视野，确保补偿和缺失的面积相似，调整后整体视野同手机相似。</li><li>手机与平板的横向视野保持一致，垂直方向扩展视野或使用留黑区域显示辅助信息，建议避免上下留黑。</li></ul> </div> </li><li>特殊考虑<p>对于休闲类游戏，尤其是垂直屏幕模式，可在双折叠展开态和平板上适当放大游戏画面，以适应更大的屏幕空间。</p> </li></ol> <p>通过以上策略，开发者可根据不同设备的特点优化游戏视野，进而提高游戏的可玩性和用户体验。详细设计建议参考下方的游戏类多设备响应式设计。</p> <p><strong>游戏类多设备响应式设计</strong></p> <p>游戏类的多设备响应式设计指南，<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/games-0000001930189974" target="_blank">点击访问</a>。</p> </div> <div class="tiledSection"><h2 id="section1383916515715">页面开发<i class="anchor-icon anchor-icon-link" anchorid="section1383916515715" tips="复制节点链接"></i></h2><p>本章阐述游戏类应用如何利用“一多”布局能力，实现页面层级的统一页面、多端适配。下文将从四个方面详细解释页面区域的布局能力，以帮助开发者完成游戏类应用的一多开发与适配。</p> </div> <div class="tiledSection"><h3 id="section998316444359" class="firsth2">游戏页分区<i class="anchor-icon anchor-icon-link" anchorid="section998316444359" tips="复制节点链接"></i></h3><p>游戏类应用的首页主要展示全屏游戏区域，即游戏渲染区域。通常使用XComponent组件来渲染OpenGL绘制的图形结果。</p> <ul><li>从游戏页划分出游戏渲染区域，效果图如下： <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.1.1.1.5.1.1" valign="top" width="8.32916708329167%"><p>示意图</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.1.1.5.1.2" valign="top" width="18.27817218278172%"><p>sm</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.1.1.5.1.3" valign="top" width="29.827017298270174%"><p>md</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.1.1.1.5.1.4" valign="top" width="43.56564343565643%"><p>lg</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="8.32916708329167%"><p>效果图</p> </td> <td class="cellrowborder" valign="top" width="18.27817218278172%"><p><span><img height="297.6526753324667" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163238.84344374846461283392916036933116:50001231000000:2800:F017355D4E346E6D5A89A67FEA8C552313B61B72DBC108FA6FCB59E6D7DFC489.png" title="点击放大" width="144.1591840815918"></span></p> </td> <td class="cellrowborder" valign="top" width="29.827017298270174%"><p><span><img height="279.02469281960697" originheight="2425" originwidth="2176" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163238.98943229381311348342584836852620:50001231000000:2800:3F6DB15FA4838D090877259441119BEC6FDEFF34924ADC954C4E62DC757F210D.png" title="点击放大" width="250.4085591440856"></span></p> </td> <td class="cellrowborder" valign="top" width="43.56564343565643%"><p><span><img height="243.30857095623776" originheight="2278" originwidth="3524" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163238.23867335175348834785226797827279:50001231000000:2800:362B618513EACFD186E49731614A2CDC2B3EA7D2CFB9566014B4D2D566089CFF.png" title="点击放大" width="376.8039196080392"></span></p> </td> </tr>  </tbody></table></div> </div> </li></ul> <ul><li>对游戏渲染区域的实现方案包括以下三个关键场景：<ol><li>Native一多适配：通过监听断点变化，动态调整页面布局和元素。开发者可以从ArkTS侧获取断点值并传入Native侧，使Native侧能够根据不同的断点值适配相应的页面及效果。</li><li>安全区避让：在游戏类应用中，为确保用户的沉浸式体验，需隐藏状态栏及导航条。这样不仅增加了可用的屏幕空间，还减少了视觉干扰，使用户更加专注于游戏本身。</li><li>窗口旋转：不同游戏可能有特定的窗口方向偏好，可根据应用需求自定义设置窗口旋转方向，这在游戏类应用中尤为重要。</li></ol> </li></ul> </div> <div class="tiledSection"><h3 id="section181610762911">Native一多适配<i class="anchor-icon anchor-icon-link" anchorid="section181610762911" tips="复制节点链接"></i></h3><p>在HarmonyOS上，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines" target="_blank">XComponent</a>控件常用于显示相机预览流和绘制的游戏画面。它可以通过与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-window-guidelines" target="_blank">NativeWindow</a>结合使用，创建OpenGL开发环境，并将OpenGL绘制的图形自定义渲染到页面的XComponent控件中进行展示。为了确保游戏在不同设备和屏幕尺寸下的适配效果，可以采取以下两种方法：</p> <ol><li>获取断点信息以适配不同页面效果<strong> </strong>：在HarmonyOS中，可以通过监听设备屏幕尺寸的变化来获取断点信息。这些信息能够帮助开发者根据屏幕尺寸的变化调整游戏的画面布局和元素大小。</li><li>监听surface大小变化并调整绘制区域：在使用OpenGL进行绘制时，surface的尺寸直接影响绘制区域的大小。因此，监听surface尺寸的变化，并据此调整绘制区域的大小，是实现多设备适配的关键。</li></ol> <p><strong>获取断点信息</strong></p> <p>将从ArkTS侧获取的断点值传递给Native侧，Native侧可以根据游戏设计需求，在不同的断点下实现不同的页面效果。本案例仅展示断点值的传递过程，适配过程可根据不同需求在Native侧自行完成。</p> <ol><li>使用UIContext中提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#getwindowwidthbreakpoint13" target="_blank">getWindowWidthBreakpoint()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#getwindowheightbreakpoint13" target="_blank">getWindowHeightBreakpoint()</a>接口，在EntryAbility文件的windowStage.loadContent()页面加载函数中直接获取横向和纵向的断点值，并监听窗口大小变化以获取新的断点值。更多获取断点策略可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-responsive-layout#section191481952131414">断点实现原理</a>。<div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L22-L148" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-keyword">public</span> uiContext?: <span class="hljs-title class_">UIContext</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">onWindowSizeChange</span>: <span class="hljs-function">(<span class="hljs-params">windowSize: <span class="hljs-variable language_">window</span>.Size</span>) =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">(<span class="hljs-params">windowSize: <span class="hljs-variable language_">window</span>.Size</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">widthBp</span>: <span class="hljs-title class_">WidthBreakpoint</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>!.<span class="hljs-title function_">getWindowWidthBreakpoint</span>();</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentWidthBreakpoint'</span>, widthBp);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">heightBp</span>: <span class="hljs-title class_">HeightBreakpoint</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>!.<span class="hljs-title function_">getWindowHeightBreakpoint</span>();</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentHeightBreakpoint'</span>, heightBp);</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowHeight'</span>, windowSize.<span class="hljs-property">height</span>);</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowWidth'</span>, windowSize.<span class="hljs-property">width</span>);</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>    <span class="hljs-comment">// Main window is created, set main page for this ability</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      windowStage.<span class="hljs-title function_">getMainWindow</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError, data</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to obtain the main window. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// Window size acquisition and monitoring.</span></li><li>        <span class="hljs-keyword">let</span> properties = data.<span class="hljs-title function_">getWindowProperties</span>();</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowHeight'</span>, properties.<span class="hljs-property">windowRect</span>.<span class="hljs-property">height</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowWidth'</span>, properties.<span class="hljs-property">windowRect</span>.<span class="hljs-property">width</span>);</li><li>        <span class="hljs-comment">// Breakpoint acquisition and listening.</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span> = data.<span class="hljs-title function_">getUIContext</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">widthBp</span>: <span class="hljs-title class_">WidthBreakpoint</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getWindowWidthBreakpoint</span>();</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">heightBp</span>: <span class="hljs-title class_">HeightBreakpoint</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>.<span class="hljs-title function_">getWindowHeightBreakpoint</span>();</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentWidthBreakpoint'</span>, widthBp);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentHeightBreakpoint'</span>, heightBp);</li><li>        data.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onWindowSizeChange</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>      })</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L22-L148" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>页面获取断点值，监听断点变化并传入Native侧。<div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L82-L271" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Define the variables passed into the Native side.</span></li><li>  <span class="hljs-meta">@State</span> cutoutAreas: Areas = {</li><li>    top: <span class="hljs-number">0</span>,</li><li>    right: <span class="hljs-number">0</span>,</li><li>    bottom: <span class="hljs-number">0</span>,</li><li>    left: <span class="hljs-number">0</span>,</li><li>    heightBreakpoint: <span class="hljs-number">0</span>,</li><li>    widthBreakpoint: <span class="hljs-number">0</span></li><li>  };</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Watching the changes in horizontal and vertical breakpoint values.</span></li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'currentHeightBreakpoint'</span>)</span> <span class="hljs-meta">@Watch(<span class="hljs-string">'breakPointChange'</span>)</span> heightBreakpoint: HeightBreakpoint =</li><li>    HeightBreakpoint.HEIGHT_SM;</li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'currentWidthBreakpoint'</span>)</span> <span class="hljs-meta">@Watch(<span class="hljs-string">'breakPointChange'</span>)</span> widthBreakpoint: WidthBreakpoint =</li><li>    WidthBreakpoint.WIDTH_XS;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// Breakpoint change, triggering value transfer.</span></li><li>  breakPointChange() {</li><li>    <span class="hljs-keyword">this</span>.cutoutAreas.heightBreakpoint = <span class="hljs-keyword">this</span>.heightBreakpoint;</li><li>    <span class="hljs-keyword">this</span>.cutoutAreas.widthBreakpoint = <span class="hljs-keyword">this</span>.widthBreakpoint;</li><li>    <span class="hljs-comment">// Encapsulate the Native method and pass in a breakpoint.</span></li><li>    tetrahedron_napi.objectPassing(<span class="hljs-keyword">this</span>.cutoutAreas);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L82-L271" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <p><strong>监听Surface大小变化</strong></p> <p>XComponent持有一个Surface，该Surface的默认位置及大小与XComponent组件相同。在Native层获取Native XComponent实例，作为ArkTS层和Native层XComponent绑定的桥梁。利用Native XComponent提供的接口注册XComponent的生命周期和事件回调，最后通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-window-guidelines" target="_blank">NativeWindow</a>等接口开发自定义绘制内容，并申请和提交Buffer到图形队列，以此方式将自定义绘制内容传送至XComponent持有的Surface。具体XComponent的开发流程可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-xcomponent-guidelines" target="_blank">自定义渲染</a>。</p> <p>在Native XComponent的事件回调中，OnSurfaceCreated和OnSurfaceChanged两个接口分别在Surface创建和Surface大小变化时进行回调，因此在适配不同屏幕尺寸设备时，应重点关注这两个接口。</p> <ul><li>OnSurfaceCreated：Surface创建时进行回调。</li><li>OnSurfaceChanged：Surface大小变化时进行回调。具体使用场景包括游戏横竖屏切换导致的Surface宽高变化，或双折叠设备在折叠和展开状态变化下的Surface大小变化。</li></ul> <p>在OnSurfaceCreated和OnSurfaceChanged回调中，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-xcomponent-h#oh_nativexcomponent_getxcomponentsize" target="_blank">OH_NativeXComponent_GetXComponentSize()</a>获取XComponent持有的Surface的大小，且每次Surface改变后都会重新获取对应的宽高，并通过自定义的reSizeWindow方法，重新设置OpenGL绘制区域的大小，以实现对不同设备和屏幕尺寸的良好适配。</p> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/cpp/app_napi.cpp#L202-L251" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">AppNapi</span>::<span class="hljs-title class_">OnSurfaceCreated</span>(<span class="hljs-variable">OH_NativeXComponent</span><span class="hljs-variable">* component</span>, <span class="hljs-variable">void</span><span class="hljs-variable">* window</span>)</li><li>{</li><li>    <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"AppNapi::OnSurfaceCreated"</span>);</li><li>    <span class="hljs-title function_">OH_NativeXComponent_RegisterOnFrameCallback</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">OnFrameCB</span>);</li><li>    <span class="hljs-comment">// Get surface size.</span></li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeXComponent_GetXComponentSize</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">window</span>, &amp;<span class="hljs-title class_">width_</span>, &amp;<span class="hljs-title class_">height_</span>);</li><li>    <span class="hljs-comment">// Draw the image to be displayed on the window and set the size of the drawing area.</span></li><li>    <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"Offset : x = %{public}f, y = %{public}f "</span>, <span class="hljs-variable">x_</span>, <span class="hljs-variable">y_</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> == <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) {</li><li>        <span class="hljs-variable">tetrahedron_</span>-&gt;<span class="hljs-title class_">Init</span>(<span class="hljs-title class_">window</span>, <span class="hljs-title class_">width_</span>, <span class="hljs-title class_">height_</span>);</li><li>        <span class="hljs-variable">tetrahedron_</span>-&gt;<span class="hljs-title class_">reSizeWindow</span>(<span class="hljs-title class_">width_</span>, <span class="hljs-title class_">height_</span>);</li><li>        <span class="hljs-variable">tetrahedron_</span>-&gt;<span class="hljs-title class_">Update</span>(<span class="hljs-title class_">angleX_</span>, <span class="hljs-title class_">angleY_</span>);</li><li>        <span class="hljs-variable">isCreated_</span>++;</li><li>        <span class="hljs-variable">xcHeight_</span> = <span class="hljs-variable">height_</span>;</li><li>        <span class="hljs-variable">xcWidth_</span> = <span class="hljs-variable">width_</span>;</li><li>
</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"AppNapi::OnSurfaceCreated success "</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"AppNapi::OnSurfaceCreated failed"</span>);</li><li>    }</li><li>}</li><li>
</li><li><span class="hljs-variable">void</span> <span class="hljs-variable">AppNapi</span>::<span class="hljs-title class_">OnSurfaceChanged</span>(<span class="hljs-variable">OH_NativeXComponent</span><span class="hljs-variable">* component</span>, <span class="hljs-variable">void</span><span class="hljs-variable">* window</span>)</li><li>{</li><li>    <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"AppNapi::OnSurfaceChanged"</span>);</li><li>    <span class="hljs-comment">// Retrieve surface size again</span></li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeXComponent_GetXComponentSize</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">window</span>, &amp;<span class="hljs-title class_">width_</span>, &amp;<span class="hljs-title class_">height_</span>);</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret1</span>;</li><li>    </li><li>    <span class="hljs-comment">// Set the size of the drawing area.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> == <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) {</li><li>        <span class="hljs-variable">tetrahedron_</span>-&gt;<span class="hljs-title class_">reSizeWindow</span>(<span class="hljs-title class_">width_</span>, <span class="hljs-title class_">height_</span>);</li><li>        <span class="hljs-variable">xcHeight_</span> = <span class="hljs-variable">height_</span>;</li><li>        <span class="hljs-variable">xcWidth_</span> = <span class="hljs-variable">width_</span>;</li><li>        <span class="hljs-title function_">LOGE</span>(<span class="hljs-string">"after width = %{public}d, height = %{public}d"</span>, <span class="hljs-variable">xcWidth_</span>, <span class="hljs-variable">xcHeight_</span>);</li><li>        <span class="hljs-variable">ret1</span>= <span class="hljs-title function_">OH_NativeXComponent_GetXComponentOffset</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">window</span>, &amp;<span class="hljs-title class_">x_</span>, &amp;<span class="hljs-title class_">y_</span>);</li><li>        <span class="hljs-variable">off_x</span> = <span class="hljs-variable">x_</span>;</li><li>        <span class="hljs-variable">off_y</span> = <span class="hljs-variable">y_</span>;</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/cpp/app_napi.cpp#L202-L251" target="_blank">app_napi.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section139015396298">安全区避让<i class="anchor-icon anchor-icon-link" anchorid="section139015396298" tips="复制节点链接"></i></h3><p>游戏类应用主要采用沉浸式界面设计。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-develop-apply-immersive-effects" target="_blank">开发应用沉浸式效果</a>主要是通过调整状态栏、应用界面和导航条的显示效果，以减少这些系统界面给用户带来的突兀感，从而提供更好的UI体验。</p> </div> <p>为了获得更好的游戏体验，游戏应用不仅需要设置沉浸式界面，还需要扩展布局并隐藏避让区，即隐藏状态栏和导航条（示意图所示的导航条在真实使用场景下已隐藏）。界面元素示意图如下所示：</p> <p><span><img height="411.4621" originheight="809" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163238.67877634250780556538543202349385:50001231000000:2800:89B06E9DBD16BD12BA5BE6671598AC9B43A6B649C90A3CAE4BA653C19F2622E7.png" title="点击放大" width="266"></span></p> <p>在这样的场景下，挖孔区（即摄像头区域）可能会遮挡部分页面信息或用户操作按钮。因此，为了优化用户体验，操作按钮需要移动到挖孔区的另一侧，同时避免侧边出现大量留白，需要获取挖孔区域并进行相应的避让设计。具体步骤分为以下三步：</p> <p><strong>应用扩展布局，隐藏避让区</strong></p> <p>首先调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setwindowlayoutfullscreen9" target="_blank">setWindowLayoutFullScreen()</a>接口设置窗口布局为沉浸式布局，接着调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setspecificsystembarenabled11" target="_blank">setSpecificSystemBarEnabled()</a>接口设置状态栏和导航条的具体显示/隐藏状态，此场景下将其设置为隐藏。</p> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L54-L137" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Set the main window to immersive and hide the navigation bar.</span></li><li>    windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">setWindowLayoutFullScreen</span>(<span class="hljs-literal">true</span>);</li><li>    windowStage.<span class="hljs-title function_">getMainWindowSync</span>().<span class="hljs-title function_">setWindowSystemBarEnable</span>([]);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'EntryAbility'</span>,</li><li>      <span class="hljs-string">`Failed to set the window state. Error code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L54-L137" target="_blank">EntryAbility.ets</a></div></div></div></div> <p><strong>挖孔区获取</strong></p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#getwindowavoidarea9" target="_blank">getWindowAvoidArea()</a>接口获取刘海屏区域，一般为前置摄像头位置，并使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onavoidareachange9" target="_blank">on('avoidAreaChange')</a>监听其位置信息的变化。<div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L35-L129" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-attr">onAvoidAreaChange</span>: <span class="hljs-function">(<span class="hljs-params">avoidArea: <span class="hljs-variable language_">window</span>.AvoidAreaOptions</span>) =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-function">(<span class="hljs-params">avoidArea: <span class="hljs-variable language_">window</span>.AvoidAreaOptions</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (avoidArea.<span class="hljs-property">type</span> === <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_CUTOUT</span>) {</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'cutout'</span>, avoidArea);</li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  windowStage.<span class="hljs-title function_">getMainWindow</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError, data</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// Monitor changes in the location of the cutout area.</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">avoidArea</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidArea</span> = data.<span class="hljs-title function_">getWindowAvoidArea</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_CUTOUT</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onAvoidAreaChange</span>({ <span class="hljs-attr">type</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaType</span>.<span class="hljs-property">TYPE_CUTOUT</span>, <span class="hljs-attr">area</span>: avoidArea });</li><li>      data.<span class="hljs-title function_">on</span>(<span class="hljs-string">'avoidAreaChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onAvoidAreaChange</span>);</li><li>    })</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L35-L129" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>监听到挖孔区位置变化后，计算避让区域的top、bottom、left和right。<div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L111-L157" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'cutout'</span>) <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'cutoutChange'</span>) <span class="hljs-attr">avoidAreas</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">AvoidAreaOptions</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-attr">windowHeight</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-attr">windowWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">cutoutChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> topPX = <span class="hljs-title function_">getTop</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avoidAreas</span>);</li><li>  <span class="hljs-keyword">let</span> rightPX = <span class="hljs-title function_">getRight</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avoidAreas</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowWidth</span>);</li><li>  <span class="hljs-keyword">let</span> bottomPX = <span class="hljs-title function_">getBottom</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avoidAreas</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowHeight</span>);</li><li>  <span class="hljs-keyword">let</span> leftPX = <span class="hljs-title function_">getLeft</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">avoidAreas</span>);</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L111-L157" target="_blank">Index.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L32-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getTop</span>(<span class="hljs-variable">avoidArea</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaOptions</span> | <span class="hljs-title class_">undefined</span>): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span> !== <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">topRect</span>.<span class="hljs-variable">height</span>) {</li><li>      <span class="hljs-variable">result</span> = <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">topRect</span>.<span class="hljs-variable">top</span> + <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">topRect</span>.<span class="hljs-variable">height</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'3D'</span>, <span class="hljs-string">'Can not get TopSafeAreaPixel, avoidArea visible false'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getBottom</span>(<span class="hljs-variable">avoidArea</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaOptions</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">windowHeight</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span> !== <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">bottomRect</span>.<span class="hljs-variable">height</span>) {</li><li>      <span class="hljs-variable">result</span> = <span class="hljs-variable">windowHeight</span> - <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">bottomRect</span>.<span class="hljs-variable">top</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'3D'</span>, <span class="hljs-string">'Can not get BottomSafeAreaPixel, avoidArea visible false'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getLeft</span>(<span class="hljs-variable">avoidArea</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaOptions</span> | <span class="hljs-title class_">undefined</span>): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span> !== <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">leftRect</span>.<span class="hljs-variable">width</span>) {</li><li>      <span class="hljs-variable">result</span> = <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">leftRect</span>.<span class="hljs-variable">left</span> + <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">leftRect</span>.<span class="hljs-variable">width</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'3D'</span>, <span class="hljs-string">'Can not get LeftSafeAreaPixel, avoidArea visible false'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getRight</span>(<span class="hljs-variable">avoidArea</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaOptions</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">windowWidth</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">number</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span> !== <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">rightRect</span>.<span class="hljs-variable">width</span>) {</li><li>      <span class="hljs-variable">result</span> = <span class="hljs-variable">windowWidth</span> - <span class="hljs-variable">avoidArea</span>.<span class="hljs-variable">area</span>.<span class="hljs-variable">rightRect</span>.<span class="hljs-variable">left</span>;</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'3D'</span>, <span class="hljs-string">'Can not get RightSafeAreaPixel, avoidArea visible false'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L32-L78" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <p><strong>安全区域避让</strong></p> <p>在获得挖孔避让区域后，可以在Native侧的surface上设置避让，或者在ArkTS侧进行避让。本篇文章将采用ArkTS侧避让，并将避让区域的值传递到Native侧。开发者可以根据游戏设计需求，使用传入的值在Native侧自行适配。</p> <ul><li>ArkTS侧避让<p>获取到挖孔区域位置后，设置页面的padding值为该区域大小，可实现安全区域避让的效果。</p> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L100-L268" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">State</span> <span class="hljs-variable">localPadding</span>: <span class="hljs-title class_">LocalizedPadding</span> = { <span class="hljs-variable">top</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">vp</span>(<span class="hljs-number">0</span>), <span class="hljs-variable">start</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">vp</span>(<span class="hljs-number">0</span>) };</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'cutout'</span>) @<span class="hljs-title function_">Watch</span>(<span class="hljs-string">'cutoutChange'</span>) <span class="hljs-variable">avoidAreas</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">AvoidAreaOptions</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">cutoutChange</span>() {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">topPX</span> = <span class="hljs-title function_">getTop</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">avoidAreas</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rightPX</span> = <span class="hljs-title function_">getRight</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">avoidAreas</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowWidth</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">bottomPX</span> = <span class="hljs-title function_">getBottom</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">avoidAreas</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowHeight</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">leftPX</span> = <span class="hljs-title function_">getLeft</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">avoidAreas</span>);</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">localPadding</span> = {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">px</span>(<span class="hljs-title class_">topPX</span>),</li><li>    <span class="hljs-variable">end</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">px</span>(<span class="hljs-title class_">rightPX</span>),</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">px</span>(<span class="hljs-title class_">bottomPX</span>),</li><li>    <span class="hljs-variable">start</span>: <span class="hljs-title class_">LengthMetrics</span>.<span class="hljs-title class_">px</span>(<span class="hljs-title class_">leftPX</span>)</li><li>  }</li><li>  <span class="hljs-comment">// ArkTS2Native</span></li><li>  <span class="hljs-variable">tetrahedron_napi</span>.<span class="hljs-title function_">objectPassing</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">cutoutAreas</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">padding</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">localPadding</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/pages/Index.ets#L100-L268" target="_blank">Index.ets</a></div></div></div></div> </li><li>Native侧避让<p>定义数据传递函数，用于将避让区域从ArkTS侧传输到Native侧，后续可根据应用需求自定义实现区域避让。更多数据交互可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-complex-type-pass#section412816619212" target="_blank">object类型数据交互</a>。</p> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/cpp/module.cpp#L29-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Responsible for transferring data from ArkTS to Native.</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">objectPassingTs2Napi</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>];</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    </li><li>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">NULL</span>, <span class="hljs-string">"Wrong number of arguments"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>    }</li><li>    </li><li>    napi_value obj = args[<span class="hljs-number">0</span>];</li><li>    napi_value keys;</li><li>    <span class="hljs-built_in">napi_get_property_names</span>(env, obj, &amp;keys); <span class="hljs-comment">// Get all attribute names.</span></li><li>    </li><li>    <span class="hljs-type">uint32_t</span> length;</li><li>    <span class="hljs-built_in">napi_get_array_length</span>(env, keys, &amp;length); <span class="hljs-comment">// Obtain the number of attributes.</span></li><li>    </li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; length; ++i) {</li><li>        napi_value key;</li><li>        <span class="hljs-built_in">napi_get_element</span>(env, keys, i, &amp;key); <span class="hljs-comment">// Get the i-th attribute name.</span></li><li>        </li><li>        <span class="hljs-comment">// Convert attribute names to strings.</span></li><li>        <span class="hljs-type">char</span> keyStr[<span class="hljs-number">128</span>];</li><li>        <span class="hljs-type">size_t</span> keyLen;</li><li>        <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, key, keyStr, <span class="hljs-built_in">sizeof</span>(keyStr), &amp;keyLen);</li><li>        </li><li>        <span class="hljs-comment">// Get attribute values.</span></li><li>        napi_value value;</li><li>        <span class="hljs-built_in">napi_get_property</span>(env, obj, key, &amp;value);</li><li>        </li><li>        <span class="hljs-comment">// Determine the type of attribute value and process it.</span></li><li>        napi_valuetype type;</li><li>        <span class="hljs-built_in">napi_typeof</span>(env, value, &amp;type);</li><li>        </li><li>        <span class="hljs-keyword">if</span> (type == napi_string) {</li><li>            <span class="hljs-type">char</span> valueStr[<span class="hljs-number">4</span>];</li><li>            <span class="hljs-type">size_t</span> valueLen;</li><li>            <span class="hljs-built_in">napi_get_value_string_utf8</span>(env, value, valueStr, <span class="hljs-built_in">sizeof</span>(valueStr), &amp;valueLen);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (type == napi_number) {</li><li>            <span class="hljs-type">double</span> num;</li><li>            <span class="hljs-built_in">napi_get_value_double</span>(env, value, &amp;num);</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</li><li>}</li><li>
</li><li><span class="hljs-comment">// Define data transfer function.</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">objectPassing</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-built_in">objectPassingTs2Napi</span>(env, info);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/cpp/module.cpp#L29-L83" target="_blank">module.cpp</a></div></div></div></div> </li></ul> <div class="tiledSection"><h3 id="section1688174822916">窗口旋转<i class="anchor-icon anchor-icon-link" anchorid="section1688174822916" tips="复制节点链接"></i></h3><p>由于不同游戏可能有特定的窗口方向偏好，通常仅支持横屏或竖屏，因此可以根据应用需求，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation()</a>接口自定义设置窗口的旋转方向。这一点对于游戏类应用较为重要。本篇文章以仅支持竖屏旋转为例，介绍如何实现游戏类应用的窗口旋转设置。</p> <div class="screenLinkPre"><div _ngcontent-wyq-c106="" class="highlight-div"><div _ngcontent-wyq-c106="" class="highlight-div-header"><div _ngcontent-wyq-c106="" class="highlight-div-header-left"><div _ngcontent-wyq-c106="" class="handle-button expand-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-wyq-c106="" class="highlight-div-header-right"><div _ngcontent-wyq-c106="" class="handle-button ai-button"></div><div _ngcontent-wyq-c106="" class="handle-button line-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-wyq-c106="" class="handle-button theme-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-wyq-c106="" class="handle-button copy-button"><div _ngcontent-wyq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-wyq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L76-L88" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Automatically rotate vertically following the sensor.</span></li><li><span class="hljs-keyword">let</span> orientation = <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">AUTO_ROTATION_PORTRAIT</span>;</li><li><span class="hljs-keyword">try</span> {</li><li>  windowClass.<span class="hljs-title function_">setPreferredOrientation</span>(orientation, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set window orientation. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in setting window orientation. Data: %{public}s'</span>);</li><li>  })</li><li>} <span class="hljs-keyword">catch</span> (exception) {</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to set window orientation. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(exception) ?? <span class="hljs-string">''</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ndk-opengl/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L76-L88" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section15132552115713">示例工程<i class="anchor-icon anchor-icon-link" anchorid="section15132552115713" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/ndk-opengl" target="_blank">多设备游戏界面</a></li></ul> </div> </div> <div></div></div>