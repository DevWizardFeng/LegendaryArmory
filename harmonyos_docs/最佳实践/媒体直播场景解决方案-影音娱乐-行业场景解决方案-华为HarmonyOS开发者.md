<h1 _ngcontent-mbh-c119="" class="doc-title ng-star-inserted" title="媒体直播场景解决方案"> 媒体直播场景解决方案 </h1>

<div _ngcontent-mbh-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section6125311161511">概述<i class="anchor-icon anchor-icon-link" anchorid="section6125311161511" tips="复制节点链接"></i></h2><p>本文基于系统的媒体底座能力，为开发者提供媒体直播系统的解决方案。系统在音视频采集、编解码、播放等方面能够高效处理多种格式的音视频数据，有效提升了音视频的质量和流畅度，助力开发者构建高清采集、高效编码及流畅播放等能力。本文主要涉及开播端的音视频采集与编码、看播端的流媒体播放与音画同步等技术方案。关于直播推拉流协议、云上服务器转码与分发等内容，本文暂不涉及。直播系统的完整链路可参考下图：</p> <p class="msonormal"><span><img height="284.763241" originheight="588" originwidth="1209" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.15749939613672871682426931757686:50001231000000:2800:3C20F5A691DD1E93030B7D68EE6D1542794053A27E9B94027EF5E1509D7D4BD6.png" title="点击放大" width="585.5325"></span></p> </div> <div class="tiledSection"><h2 id="section1343131711158">开播端解决方案<i class="anchor-icon anchor-icon-link" anchorid="section1343131711158" tips="复制节点链接"></i></h2><p>直播开播端方案主要是基于系统提供的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-kit" target="_blank">Audio Kit</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-kit" target="_blank">Camera Kit</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-kit" target="_blank">AVCodec Kit</a>以及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkgraphics-2d" target="_blank">ArkGraphics 2D</a>等能力实现开播端高清录制、音频播放、音视频编码和纹理渲染等功能。</p> </div> <div class="tiledSection"><h3 id="section4995622576" class="firsth2">开播端架构设计<i class="anchor-icon anchor-icon-link" anchorid="section4995622576" tips="复制节点链接"></i></h3><p><span><img height="514.144351" originheight="1079" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.26603130925585284393878931963051:50001231000000:2800:18F134FC181A438748E7938E9A0CA2E85FC9F309422D429320E7C1ED6023DE98.png" title="点击放大" width="876.8025"></span></p> <p>开播端架构设计如上图所示。图中将直播系统划分为云端、应用、系统与硬件四个逻辑层次。本文重点介绍应用SDK层如何通过调用底层媒体能力完成直播音视频基础能力的构建。应用SDK层主要为应用业务层提供平台技术的基础能力，通常可分为音频SDK和视频SDK两部分：</p> <ol><li>音频SDK主要包括音频采集、处理、编码、播放等模块。各模块的作用如下：<ul><li>音频内容采集模块提供音频内容输入，如主播的语聊输入、背景音乐等。</li><li>音频内容处理主要是对音频数据进行编码前的预处理，如回声消除（AEC）、背景音降噪（ANS）以及自动增益控制（AGC）等3A操作。</li><li>音频内容发送则包括解码播放和编码推送（推流）两种场景，如背景音乐通过本机扬声器播放让主播回听，推流内容则先进行音频编码后推送，经云上分发后让远端观众收听。</li></ul> </li><li>视频SDK需要管理整个视频处理的pipeline，串联采集、处理、编码、传输、显示等多个处理模块，各模块协同工作，为上层业务提供完整的视频处理能力。各模块的作用如下：<ul><li>视频采集模块为视频输入源头，通过摄像头采集原始视频数据。</li><li>视频处理模块负责画面优化，应用可进行美颜、滤镜、水印添加等后处理。</li><li>视频编码模块负责视频压缩，通过H.264、H.265等编码标准减小数据量。</li><li>视频推流模块实现编码后视频的传输，适配RTMP、WebRTC等协议，保障推流稳定性。</li><li>视频预览模块将本地预览或连麦接收到的视频数据在终端屏幕呈现，需要支持多分辨率适配。</li></ul> </li></ol> <p>媒体系统承上启下，对上为应用SDK提供音视频底座能力，对下可高效调用终端的硬件设备，如麦克风、扬声器、编解码芯片、相机、显示器以及GPU等。</p> </div> <div class="tiledSection"><h3 id="section18055218817">直播音频采集<i class="anchor-icon anchor-icon-link" anchorid="section18055218817" tips="复制节点链接"></i></h3><p>为了提高直播音频处理的效率，建议在直播SDK中使用Native侧的OHAudio接口进行开发。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio" target="_blank">OHAudio API</a>进行音频采集时，开发者需要指定录音流类型（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiostream-base-h#oh_audiostream_sourcetype" target="_blank">OH_AudioStream_SourceType</a>）。开发者应根据实际业务需求选择不同的录音流类型，以下是几种常用的录音流类型介绍如下：</p> <ol><li>常规录音（AUDIOSTREAM_SOURCE_TYPE_MIC）：支持录制48kHz双声道高清音频，但不具备回声消除等音频3A能力。</li><li>语音通话（AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION）：提供音频3A能力，但采样率只有16kHz。</li><li>直播录音（AUDIOSTREAM_SOURCE_TYPE_LIVE）：API20提供了一种专为直播场景设计的高保真录音流类型。该流类型在保证48kHz采样率的同时，新增了高保真回声消除的能力，能够同时满足音频高清晰度和连麦通话无回声干扰的需求。建议开发者在直播场景中全程使用此录音流类型，以避免在单播和连麦场景需要切换录音流类型时的复杂操作。</li></ol> <p>上述几种录音流类型的区别可参考下表。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.4.5.1.5.1.1" valign="top" width="9.85%"><p><strong>录音流类型</strong></p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.5.1.5.1.2" valign="top" width="29.45%"><p><strong>MIC</strong>常规录音</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.5.1.5.1.3" valign="top" width="30.930000000000003%"><p><strong>VOIP</strong>语音通话</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.4.5.1.5.1.4" valign="top" width="29.770000000000003%"><p><strong>LIVE</strong>直播录音</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="9.85%"><p>类型说明</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.45%"><ul><li>媒体模式高清录音（48kHz）</li><li>无降噪、回声消除等算法</li></ul> </td> <td align="left" class="cellrowborder" valign="top" width="30.930000000000003%"><ul><li>通话模式低时延录音</li><li>挂载音频3A算法（16kHz）</li></ul> </td> <td align="left" class="cellrowborder" valign="top" width="29.770000000000003%"><ul><li>直播模式高保真录音</li><li>挂载高保真AEC（48kHz）</li></ul> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="9.85%"><p>类型优点</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.45%"><p>高清录音，无损录制人声、周边声音、本机声音等</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.930000000000003%"><p>提供回声消除、降噪等能力</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.770000000000003%"><p>提供高保真回声消除能力</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="9.85%"><p>使用限制</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.45%"><p>无回声消除或降噪能力</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.930000000000003%"><p>音频带宽较低</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.770000000000003%"><p>无法录制本机下行播放的声音</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="9.85%"><p>适用场景</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.45%"><p>直播单播场景，非通话的录音场景</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.930000000000003%"><p>直播连麦、通话、会议等场景</p> </td> <td align="left" class="cellrowborder" valign="top" width="29.770000000000003%"><p>直播高清连麦、线上音乐教育场景</p> </td> </tr>  </tbody></table></div> </div> <p>应用接入AUDIOSTREAM_SOURCE_TYPE_LIVE录音流类型后，在未连接外设的情况下，将使用设备麦克风拾音，并具备48kHz回声抵消能力；而在连接有线或蓝牙耳机时，则会使用耳机麦克风拾音，具体拾音规格取决于耳机麦克风能力。关于录音流类型的详细使用方法，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-right-streamusage-and-sourcetype" target="_blank">《使用合适的音频流类型》</a>。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>高保真AEC的能力并非所有产品均支持，建议开发者在使用AUDIOSTREAM_SOURCE_TYPE_LIVE录音流类型前，先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audio-stream-manager-h#oh_audiostreammanager_isacousticechocancelersupported" target="_blank">OH_AudioStreamManager_IsAcousticEchoCancelerSupported</a>接口查询当前设备是否支持回声消除能力。</p> </div></div></div> <p>音频采集开发流程如下图所示：</p> <p><span><img height="643.563991" originheight="1194" originwidth="446" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.66533349961941651493337130828546:50001231000000:2800:991A22A76BB8D188ED6AC0CB7456439BE9A7272CE83215190A2E74BEF5214E49.png" title="点击放大" width="240.3975"></span></p> <p>音频采集开发详细步骤，可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-recording" target="_blank">《使用OHAudio开发音频录制功能》</a>。其中，开发者使用直播录音（AUDIOSTREAM_SOURCE_TYPE_LIVE）类型的回声消除能力的关键代码如下：</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioCapturer.cpp#L81-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioInfo</span>.<span class="hljs-variable">isOpenEchoCancel</span>) {</li><li>    <span class="hljs-comment">// Echo cancellation (audio pickup path): Setting the audio stream type to</span></li><li>    <span class="hljs-comment">// AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION or AUDIOSTREAM_SOURCE_TYPE_LIVE (live streaming scenario) enables</span></li><li>    <span class="hljs-comment">// built-in echo cancellation.</span></li><li>    <span class="hljs-variable">OH_AudioStream_SourceType</span> <span class="hljs-variable">sourceType</span> = <span class="hljs-variable">AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION</span>;</li><li>    <span class="hljs-variable">OH_AudioStreamManager</span> *<span class="hljs-variable">streamManager</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ApiCompat_OH_AudioManager_GetAudioStreamManager</span>.<span class="hljs-title function_">IsAvailable</span>() &amp;&amp;</li><li>        <span class="hljs-variable">ApiCompat_OH_AudioStreamManager_IsAcousticEchoCancelerSupported</span>.<span class="hljs-title function_">IsAvailable</span>()) {</li><li>        <span class="hljs-comment">// Logic for handling higher API versions: Pass input parameters directly, fully consistent with native</span></li><li>        <span class="hljs-comment">// calling method</span></li><li>        <span class="hljs-variable">int</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_">ApiCompat_OH_AudioManager_GetAudioStreamManager</span>(&amp;<span class="hljs-title class_">streamManager</span>);</li><li>        (<span class="hljs-variable">void</span>)<span class="hljs-variable">result</span>;</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">isSupportAec</span> = <span class="hljs-keyword">false</span>;</li><li>        (<span class="hljs-variable">void</span>)<span class="hljs-title function_">ApiCompat_OH_AudioStreamManager_IsAcousticEchoCancelerSupported</span>(</li><li>            <span class="hljs-variable">streamManager</span>, <span class="hljs-variable">AUDIOSTREAM_SOURCE_TYPE_LIVE</span>, &amp;<span class="hljs-title class_">isSupportAec</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">isSupportAec</span>) {</li><li>            <span class="hljs-variable">sourceType</span> = <span class="hljs-variable">AUDIOSTREAM_SOURCE_TYPE_LIVE</span>;</li><li>            <span class="hljs-title function_">SAMPLE_LOGI</span>(<span class="hljs-string">"high api:%{public}d version, audio stream source set to live type"</span>,</li><li>                        <span class="hljs-variable">ohos</span>::<span class="hljs-title class_">compatibility</span>::<span class="hljs-title class_">GetSystemApiVersion</span>());</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">sourceType</span> = <span class="hljs-variable">AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION</span>;</li><li>            <span class="hljs-title function_">SAMPLE_LOGI</span>(<span class="hljs-string">"high api:%{public}d version, audio stream source set to voip type"</span>,</li><li>                        <span class="hljs-variable">ohos</span>::<span class="hljs-title class_">compatibility</span>::<span class="hljs-title class_">GetSystemApiVersion</span>());</li><li>        }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// Logic for handling lower API versions</span></li><li>        <span class="hljs-variable">sourceType</span> = <span class="hljs-variable">AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION</span>;</li><li>        <span class="hljs-title function_">SAMPLE_LOGI</span>(<span class="hljs-string">"low api:%{public}d version, audio stream source set to voip type"</span>,</li><li>                    <span class="hljs-variable">ohos</span>::<span class="hljs-title class_">compatibility</span>::<span class="hljs-title class_">GetSystemApiVersion</span>());</li><li>    }</li><li>    <span class="hljs-title function_">OH_AudioStreamBuilder_SetCapturerInfo</span>(<span class="hljs-variable">builder_</span>, <span class="hljs-variable">sourceType</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioCapturer.cpp#L81-L112" target="_blank">AudioCapturer.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section10189195511102">直播音频编码<i class="anchor-icon anchor-icon-link" anchorid="section10189195511102" tips="复制节点链接"></i></h3><p>系统提供高效的音频编码能力，开发者可通过调用AVCodec Kit的Native侧<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avcodec-audiocodec-h" target="_blank">API接口</a>完成音频编码任务。该接口不限制PCM数据的来源，开发者可以调用麦克风录制获取，也可以导入编辑后的PCM数据。通过音频编码，输出对应格式的码流，最后封装为目标格式文件。当前支持的编码能力请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avcodec-support-formats#音频编码" target="_blank">AVCodec支持的格式</a>。</p> <p>音频编码的全流程主要包括：创建编码器、设置编码参数（采样率、码率、声道数等）、开始、刷新、重置、销毁资源。在应用开发过程中，开发者应按一定顺序调用方法，执行对应操作，否则系统可能会抛出异常或生成其他未定义的行为。关于音频编码的具体开发步骤，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-encoding" target="_blank">《音频编码》</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>根据直播业务类型，一般建议开发者在单播场景下选择AAC编码格式，而对于低时延实时通信的连麦场景，建议选择OPUS编码格式。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section142359529129">直播音频文件播放<i class="anchor-icon anchor-icon-link" anchorid="section142359529129" tips="复制节点链接"></i></h3><p>当开播端需要播放背景音乐或氛围音效时，需要用到系统的音频解封装、解码及音频播放能力。其基本流程为：音频文件 -&gt; 解封装 -&gt; 音频解码 -&gt; 播放。应用可通过先后调用AVCodec Kit中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-video-demuxer" target="_blank">OH_AVDemuxer</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-decoding" target="_blank">AudioCodec</a>接口分别进行解封装和解码，再调用Audio Kit中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback" target="_blank">OH_AudioRenderer</a>进行渲染播放。OH_AudioRenderer需设置音频播放流类型（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-e#streamusage" target="_blank">StreamUsage</a>），根据直播场景实际播放的音频类型，建议使用STREAM_USAGE_MUSIC音频流类型，以获得更通用的系统音效播放体验。具体开发流程如下：</p> <p><strong>（1）音频文件 -&gt; 解封装 -&gt; 音频解码</strong></p> <p><span><img height="523.4474166666666" originheight="1035" originwidth="1819" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.77428829552129762709234048176789:50001231000000:2800:832153348F20BA1104D19561229D27E7145258AC4E49CBA75DD0E663E0A791BA.png" title="点击放大" width="920"></span></p> <p><strong>（2）音频解码 -&gt; 播放</strong></p> <p><span><img height="665.066101" originheight="1191" originwidth="443" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.07780736753845256406975210160583:50001231000000:2800:1E2825BEA4D3C2ED9068711E0D1A610E046E85782952230959967DEA74E6E7E7.png" title="点击放大" width="247.38000000000002"></span></p> <p>开播端主播可能会使用本机扬声器或耳机进行音频文件收听。若主播播放的音频文件由应用提供，则应用需同时将该音频文件编码后推流发送，以方便看播端的观众同步收听。</p> <p>当主播使用本机扬声器收听时，按照前述直播音频采集中的建议，当采集录音流类型选择为AUDIOSTREAM_SOURCE_TYPE_LIVE流时，下行播放的音频会被回声抵消算法抑制，仅采集主播语音，看播端观众听到的是主播的语聊及编码推流发送的音频。当主播使用耳机收听时，无播放回声拾取问题。</p> </div> <div class="tiledSection"><h3 id="section101014915161">直播音频焦点管理<i class="anchor-icon anchor-icon-link" anchorid="section101014915161" tips="复制节点链接"></i></h3><p>在直播场景下，应用通常比较关心直播采集音频被其他音频打断的处理方式。系统中，音频中断有终止（Stop）、暂停（Pause）、降音（Duck）、并发（Mix）四种策略。应用一般需要关注和处理的是终止式打断和暂停式打断。</p> <p>在处理音频中断事件时，应用需主动监听音频焦点事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiocapturer-callbacks-struct#oh_audiocapturer_oninterruptevent" target="_blank">OH_AudioCapturer_OnInterruptEvent</a>/ <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiorenderer-callbacks-struct#oh_audiorenderer_oninterruptevent" target="_blank">OH_AudioRenderer_OnInterruptEvent</a>中的打断提示（InterruptHint）。建议处理方式如下：</p> <ul><li>当收到终止（INTERRUPT_HINT_STOP）式打断时：此时直播音频将永久失焦，待后起音频流结束后，先起音频流不恢复播放。建议应用通过UI提示用户手动恢复音频采集/播放；</li><li>当收到暂停（INTERRUPT_HINT_PAUSE）式打断时：此时直播音频会暂时失焦，建议应用通过UI提示用户此时音频采集/播放已暂停；待后续收到继续（INTERRUPT_HINT_RESUME）标志时，应用可选择通过start方法重启录音流/播放流。</li></ul> <p>关于音频焦点冲突处理的详细原理和解决方案，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-audio-focus-management" target="_blank">《音频焦点管理》</a>，关键代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioCapturer.cpp#L56-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Customize the audio interrupt event function</span></li><li>static int32_t <span class="hljs-built_in">AudioCapturerOnInterruptEvent</span>(OH_AudioCapturer *capturer, [[maybe_unused]]void* userData,</li><li>    OH_AudioInterrupt_ForceType type, OH_AudioInterrupt_Hint hint</li><li>)</li><li>{</li><li>    if ((type == AUDIOSTREAM_INTERRUPT_SHARE) &amp;&amp; (hint == AUDIOSTREAM_INTERRUPT_HINT_RESUME)) {</li><li>        <span class="hljs-built_in">OH_AudioCapturer_Start</span>(capturer);</li><li>    }</li><li>    return <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioCapturer.cpp#L56-L65" target="_blank">AudioCapturer.cpp</a></div></div></div></div> </div> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioRender.cpp#L30-L38" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Customize the audio interrupt event function</span></li><li>static int32_t <span class="hljs-built_in">OnRenderInterruptEvent</span>(OH_AudioRenderer *renderer, [[maybe_unused]]void *userData, </li><li>    OH_AudioInterrupt_ForceType type, OH_AudioInterrupt_Hint hint)</li><li>{</li><li>    if ((type == AUDIOSTREAM_INTERRUPT_SHARE) &amp;&amp; (hint == AUDIOSTREAM_INTERRUPT_HINT_RESUME)) {</li><li>        <span class="hljs-built_in">OH_AudioRenderer_Start</span>(renderer);</li><li>    }</li><li>    return <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/AudioRender.cpp#L30-L38" target="_blank">AudioRender.cpp</a></div></div></div></div> <div class="tiledSection"><h3 id="section648472771812">直播SDR视频采集<i class="anchor-icon anchor-icon-link" anchorid="section648472771812" tips="复制节点链接"></i></h3><p><strong>（一）SDR视频采集</strong></p> <p>在直播的视频采集场景中，建议应用仅采集一路预览流，以降低直播功耗和时延。同时，在SDR直播场景下，颜色空间可配置为BT709_LIMIT，以获得更广泛的设备支持。相机视频采集流程如下：</p> <p><span><img height="1217.1993750000001" originheight="4096" originwidth="2447" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.17452651129481979047296506509341:50001231000000:2800:EC3DF861A62A88D93730A9947A086693C3D09FF9A10F7323994A136747DD0102.png" title="点击放大" width="727.1775"></span></p> <p>关于相机视频采集的具体开发步骤，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-recording-case" target="_blank">《相机录像实践》</a>。其中，配置颜色空间的关键代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/ets/controller/CameraController.ets#L480-L506" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set the color space</span></li><li><span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>, <span class="hljs-variable">isHdr</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> =</li><li>    <span class="hljs-variable">isHdr</span> ? <span class="hljs-variable">colorSpaceManager</span>.<span class="hljs-variable">ColorSpace</span>.<span class="hljs-variable">BT2020_HLG_LIMIT</span> : <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>.<span class="hljs-title class_">BT709_LIMIT</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-variable">session</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">isSupportedColorSpaces</span> = <span class="hljs-variable">colorSpaces</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable">colorSpace</span>) &gt;= <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">isSupportedColorSpaces</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setColorSpace</span>: ${<span class="hljs-variable">colorSpace</span>}`);</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable">session</span>.<span class="hljs-title function_">setColorSpace</span>(<span class="hljs-variable">colorSpace</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setColorSpace</span> <span class="hljs-variable">fail</span> ${<span class="hljs-variable">error</span>}`)</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">activeColorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable">activeColorSpace</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">activeColorSpace</span> != <span class="hljs-variable">colorSpace</span>) {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">activeColorSpace</span>: ${<span class="hljs-variable">activeColorSpace</span>}, <span class="hljs-variable">but</span> <span class="hljs-variable">wait</span>: ${<span class="hljs-variable">colorSpace</span>}`);</li><li>      }</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">activeColorSpace</span>: ${<span class="hljs-variable">activeColorSpace</span>}`);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getActiveColorSpace</span> <span class="hljs-variable">fail</span> ${<span class="hljs-variable">error</span>}`);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">colorSpace</span>: ${<span class="hljs-variable">colorSpace</span>} <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">support</span>`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/ets/controller/CameraController.ets#L480-L506" target="_blank">CameraController.ets</a></div></div></div></div> <p><strong>（二）SDR视频处理</strong></p> <p>在视频处理过程中，开发者需要完成NativeImage的创建、SurfaceId的获取及帧可用性监听设置，为后续相机数据的处理（如美颜、滤镜等）提供基础图像载体，确保相机生产的数据能被正确接收与处理。本文建议开发者通过NativeImage绑定外部OpenGL纹理并关联相机采集数据，由系统完成视频数据的流转，开发者可重点关注shader算法的实现。具体流程如下图所示：</p> <p><span><img height="395.358194" originheight="782" originwidth="1462" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.94579239237112659728480712695618:50001231000000:2800:CC4709DBE686A939DE941DD1A99ED4D2A3D973790C9045E2B4342ED1FF32E7EF.png" title="点击放大" width="739.1475"></span></p> <p>该环节的关键代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/render/render_thread.cpp#L434-L463" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RenderThread::CreateNativeImage</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    nativeImage_ = <span class="hljs-built_in">OH_NativeImage_Create</span>(<span class="hljs-number">-1</span>, GL_TEXTURE_EXTERNAL_OES);</li><li>    <span class="hljs-keyword">if</span> (nativeImage_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"OH_NativeImage_Create failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;</li><li>    {</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(nativeImageSurfaceIdMutex_)</span></span>;</li><li>        nativeImageWindow_ = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(nativeImage_);</li><li>        ret = <span class="hljs-built_in">OH_NativeImage_GetSurfaceId</span>(nativeImage_, &amp;nativeImageSurfaceId_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>            <span class="hljs-string">"OH_NativeImage_GetSurfaceId failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    nativeImageFrameAvailableListener_.context = <span class="hljs-keyword">this</span>;</li><li>    nativeImageFrameAvailableListener_.onFrameAvailable = &amp;RenderThread::OnNativeImageFrameAvailable;</li><li>    ret = <span class="hljs-built_in">OH_NativeImage_SetOnFrameAvailableListener</span>(nativeImage_, nativeImageFrameAvailableListener_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_SetOnFrameAvailableListener failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/render/render_thread.cpp#L434-L463" target="_blank">render_thread.cpp</a></div></div></div></div> <p><strong>（三）色彩空间配置</strong></p> <p>在SDR直播场景下，视频编码及显示环节需注意渲染和显示的色彩空间也应配置为BT709_LIMIT，与相机采集时保持一致。关键代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/render/render_thread.cpp#L264-L265" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// SDR set BT709</span></li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeWindow_SetColorSpace</span>(nativeWindow_, OH_COLORSPACE_BT709_LIMIT);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/render/render_thread.cpp#L264-L265" target="_blank">render_thread.cpp</a></div></div></div></div> <p><strong>（四）使用系统红枫摄像能力</strong></p> <p>系统级的红枫色彩算法已全面开放给生态应用，三方应用基于上述标准统一的录像会话及预览流接口，即可获取标准原色高清图像，实现与系统相机一致的红枫色彩效果。同时，建议应用接入系统相机的自动对焦、长焦、微距等能力，充分发挥相机硬件的综合能力，全面获得系统级拍摄的优秀体验。此能力仅限支持红枫摄像的华为产品使用，不同产品的能力适配情况，根据设备自身规格而定。关于实现系统相机级别的效果和能力，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-third-party-camera" target="_blank">《生态应用相机实现系统级相机体验》</a>。</p> </div> <div class="tiledSection"><h3 id="section2426926182114">直播HDR Vivid视频采集<i class="anchor-icon anchor-icon-link" anchorid="section2426926182114" tips="复制节点链接"></i></h3><p>HDR Vivid是UWA认证的动态HDR视频标准，使用HDR Vivid标准进行视频直播可以为用户带来更宽广的色彩范围、更细腻的层次表现、更显著的明暗对比。系统支持HDR Vivid视频采集、编码和解码显示功能，应用调用系统提供的API，配合云上链路的适配，可实现端到端的HDR Vivid视频直播。关于HDR Vivid视频采集的开发实践，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-hdrvivid" target="_blank">《HDR Vivid视频录制、播放与转码》</a>，但直播场景需注意选用预览流，而非录制流。</p> <p><strong>（一）HDR Vivid视频采集</strong></p> <ul><li>采集数据格式需配置为CAMERA_FORMAT_YCRCB_P010：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-manager-h#oh_cameramanager_getsupportedcameraoutputcapabilitywithscenemode" target="_blank">OH_CameraManager_GetSupportedCameraOutputCapabilityWithSceneMode</a>接口获取目标相机设备在录像模式（NORMAL_VIDEO）下支持的所有输出规格。该接口调用成功后，参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-camera-camera-outputcapability" target="_blank">cameraOutputCapability</a>会包含一个profile数组，每个profile均携带宽高属性（对应分辨率）和format属性（对应数据格式）。从profile数组中筛选同时满足以下两个条件的profile：<ol><li>分辨率条件：profile的宽、高属性符合业务场景需求（例如根据屏幕尺寸、录像清晰度要求设定的宽高范围）。</li><li>数据格式条件：profile的format属性必须等于CAMERA_FORMAT_YCRCB_P010（确保数据格式适配后续处理流程）。</li></ol> </li></ul> <ul><li>采集颜色空间需配置为OH_COLORSPACE_BT2020_HLG_LIMIT：调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_getsupportedcolorspaces" target="_blank">OH_CaptureSession_GetSupportedColorSpaces</a>接口查询当前采集会话（Camera_CaptureSession）支持的所有颜色空间配置，遍历supportedColorSpaces列表，筛选出颜色空间项OH_COLORSPACE_BT2020_HLG_LIMIT。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-capture-session-h#oh_capturesession_setactivecolorspace" target="_blank">OH_CaptureSession_SetActiveColorSpace</a>接口将筛选出的OH_COLORSPACE_BT2020_HLG_LIMIT设置为采集会话的活跃颜色空间。</li></ul> <p><strong>（二）HDR Vivid视频处理</strong></p> <ul><li>OpenGL环境需配置为10bit YUV格式：首先需构建符合10bit YUV格式要求的EGL配置属性数组，明确YUV相关参数。然后调用eglChooseConfig函数，从EGL显示设备中筛选符合上述10bit YUV属性的配置。</li><li>通过NativeImage获取NativeBuffer：通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-image-h#oh_nativeimage_acquirenativewindowbuffer" target="_blank">OH_NativeImage_AcquireNativeWindowBuffer</a>接口从NativeImage对象中获取NativeBuffer，该缓冲区将作为后续OpenGL纹理数据的来源。</li><li>通过FrameBuffer绑定纹理进行10bit YUV数据处理：通过EGLImage将NativeBuffer关联为OpenGL纹理，再绑定到FrameBuffer完成10bit YUV数据的渲染/处理。</li></ul> <p><strong>（三）动态元数据复用方案</strong></p> <p>如果对相机输出内容没有后处理要求，保持原汁原味输出，可以从相机中获取动态元数据，传递到编码器。主要步骤如下：</p> <ul><li>获取HDR Vivid动态元数据和颜色空间：首先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-buffer-h#oh_nativebuffer_getcolorspace" target="_blank">OH_NativeBuffer_GetColorSpace</a>接口从输入NativeBuffer中读取当前帧的颜色空间信息。然后通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-buffer-h#oh_nativebuffer_getmetadatavalue" target="_blank">OH_NativeBuffer_GetMetadataValue</a>接口读取输入缓冲区中HDR Vivid所需的三类核心元数据（元数据类型、静态元数据、动态元数据）。</li><li>设置HDR Vivid动态元数据和颜色空间：将上一步读取到的颜色空间和HDR Vivid元数据，通过对应的设置函数写入输出NativeBuffer中，确保输出帧能正确承载HDR Vivid效果，操作需按“颜色空间→元数据”的顺序执行，避免依赖项缺失导致配置无效。<p>如果在调整相机输出内容后需要重新生成动态元数据，具体开发指导，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/generate-video-dynamic-metadata" target="_blank">《视频动态元数据生成》</a>。</p> </li></ul> </div> <div class="tiledSection"><h3 id="section105141540132417">直播视频编码<i class="anchor-icon anchor-icon-link" anchorid="section105141540132417" tips="复制节点链接"></i></h3><p><strong>（一）常规视频编码</strong></p> <p>由于Surface模式的数据流转性能优于Buffer模式，因此，在直播场景中建议开发者使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding#surface模式" target="_blank">Surface模式下的视频编码</a>。系统支持常见的H.264、H.265视频编码格式，如果需要对HDR Vivid视频进行编码，需要配置MimeType为H.265 (OH_AVCODEC_MIMETYPE_VIDEO_HEVC)。关于视频编码参数配置，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding-configuration-typical-scenarios" target="_blank">《典型场景的视频编码配置》</a>。</p> <p><strong>（二）ROI编码</strong></p> <p>ROI（Region of Interesting）编码是指对感兴趣区域和非感兴趣区域进行质量的人为干预调整，例如在码率或带宽受限情况下，对重点区域提高质量，对非重点区域降低质量（平衡码率）。</p> <p>ROI区域的坐标范围可由开发者自主指定。例如，开发者可以借助“美颜模块”的人脸识别功能，将检测输出的人脸区域范围作为ROI区域，并随视频的每一帧同步输出。开发者也可以利用相机的人脸区域检测能力来获取ROI区域（实际应用需先确认该能力是否受支持）。关于ROI编码具体开发指导，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-encoding-roi" target="_blank">《ROI编码》</a>。</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/VideoEncoder.cpp#L177-L221" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Static callback function: Used to handle encoder requests for input parameters</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">OnNeedInputParameter</span><span class="hljs-params">(OH_AVCodec *codec, <span class="hljs-type">uint32_t</span> index, OH_AVFormat *parameter, <span class="hljs-type">void</span> *userData)</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-comment">// Retrieve CodecUserRoi instance from user data</span></li><li>    VideoEncoder::CodecUserRoi* roiUserData = <span class="hljs-built_in">static_cast</span>&lt;VideoEncoder::CodecUserRoi*&gt;(userData);</li><li>    <span class="hljs-keyword">if</span> (!roiUserData || !roiUserData-&gt;vencoder) {</li><li>        <span class="hljs-built_in">SAMPLE_LOGE</span>(<span class="hljs-string">"Invalid user data in OnNeedInputParameter"</span>);</li><li>        <span class="hljs-built_in">OH_VideoEncoder_PushInputParameter</span>(codec, index);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    VideoEncoder* encoder = roiUserData-&gt;vencoder;</li><li>    FaceIntInfo faceInfo = encoder-&gt;<span class="hljs-built_in">GetLatestFaceInfo</span>();</li><li>    std::string roiInfo;</li><li>
</li><li>    <span class="hljs-comment">// If valid face information is available, use the face region as the ROI</span></li><li>    <span class="hljs-keyword">if</span> (faceInfo.valid) {</li><li>        <span class="hljs-type">int32_t</span> left = faceInfo.topLeftX;</li><li>        <span class="hljs-type">int32_t</span> top = faceInfo.topLeftY;</li><li>        <span class="hljs-type">int32_t</span> right = faceInfo.topLeftX + faceInfo.width;</li><li>        <span class="hljs-type">int32_t</span> bottom = faceInfo.topLeftY + faceInfo.height;</li><li>
</li><li>        <span class="hljs-comment">// Construct ROI information string, lowering the QP value in facial regions to enhance image quality</span></li><li>        <span class="hljs-type">char</span> roiBuffer[<span class="hljs-number">100</span>];</li><li>        <span class="hljs-type">int</span> len = <span class="hljs-built_in">snprintf</span>(roiBuffer, <span class="hljs-built_in">sizeof</span>(roiBuffer), <span class="hljs-string">"%d,%d-%d,%d=-4"</span>, left, top, right, bottom);</li><li>        <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">0</span> &amp;&amp; len &lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-built_in">sizeof</span>(roiBuffer))) {</li><li>            roiInfo = std::<span class="hljs-built_in">string</span>(roiBuffer, len);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-built_in">SAMPLE_LOGE</span>(<span class="hljs-string">"Failed to format ROI string, buffer size: %zu"</span>, <span class="hljs-built_in">sizeof</span>(roiBuffer));</li><li>        }</li><li><span class="hljs-meta">#<span class="hljs-keyword">if</span> ONLY_TEST_ROI_INFO</span></li><li>        <span class="hljs-built_in">SAMPLE_LOGI</span>(<span class="hljs-string">"HMOS_LiveStream: ROI face  timestamp: %{public}d, ROI: %{public}s"</span>,</li><li>            faceInfo.timestamp, roiBuffer);</li><li><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// If no face information is available, do not set any ROI, allowing the encoder to use global default</span></li><li>        <span class="hljs-comment">// parameters</span></li><li>        <span class="hljs-built_in">SAMPLE_LOGI</span>(<span class="hljs-string">"No valid face info, no ROI set."</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// Set ROI parameters</span></li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* roiKey = ApiCompat_OH_MD_KEY_VIDEO_ENCODER_ROI_PARAMS;</li><li>    <span class="hljs-built_in">OH_AVFormat_SetStringValue</span>(parameter, roiKey, roiInfo.<span class="hljs-built_in">c_str</span>());</li><li>    <span class="hljs-built_in">OH_VideoEncoder_PushInputParameter</span>(codec, index);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/cpp/capbilities/codec/VideoEncoder.cpp#L177-L221" target="_blank">VideoEncoder.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section16974174712262">直播系统压力反馈<i class="anchor-icon anchor-icon-link" anchorid="section16974174712262" tips="复制节点链接"></i></h3><p>直播作为典型的应用重负载场景，其系统性能设计直接影响设备续航、发热等关键指标，从而进一步影响用户体验。系统提供压力反馈监测方案，以帮助应用优化直播场景的性能及功耗。开发者可使用系统提供的压力反馈接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videosession#onsystempressurelevelchange20" target="_blank">on('systemPressureLevelChange')</a>，根据系统压力动态调整直播场景负载，例如在系统压力过大时主动进行动态应用负载降级。</p> <div class="screenLinkPre"><div _ngcontent-mbh-c106="" class="highlight-div"><div _ngcontent-mbh-c106="" class="highlight-div-header"><div _ngcontent-mbh-c106="" class="highlight-div-header-left"><div _ngcontent-mbh-c106="" class="handle-button expand-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mbh-c106="" class="highlight-div-header-right"><div _ngcontent-mbh-c106="" class="handle-button ai-button"></div><div _ngcontent-mbh-c106="" class="handle-button line-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mbh-c106="" class="handle-button theme-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mbh-c106="" class="handle-button copy-button"><div _ngcontent-mbh-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mbh-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/ets/controller/CameraController.ets#L510-L523" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">systemPressureLevelChangeCallback</span>(<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">systemPressureLevel</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">SystemPressureLevel</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> !== <span class="hljs-variable">undefined</span> &amp;&amp; <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span> !== <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Callback</span> <span class="hljs-variable">Error</span>, <span class="hljs-variable">errorCode</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">systemPressureLevel</span>: ${<span class="hljs-variable">systemPressureLevel</span>}`);</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-title function_">registerSystemPressureLevelChangeCallback</span>(<span class="hljs-variable">videoSession</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">deviceInfo</span>.<span class="hljs-variable">sdkApiVersion</span> &gt;= <span class="hljs-number">20</span>) {</li><li>    <span class="hljs-variable">videoSession</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'systemPressureLevelChange'</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">systemPressureLevelChangeCallback</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream/blob/master/entry/src/main/ets/controller/CameraController.ets#L510-L523" target="_blank">CameraController.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section1443814592710">开播端开发常见问题FAQ<i class="anchor-icon anchor-icon-link" anchorid="section1443814592710" tips="复制节点链接"></i></h3><p><strong>（1）高保真音频采集的焦点策略是怎么样的？</strong></p> <p>在系统中，高保真音频录音流类型（AUDIOSTREAM_SOURCE_TYPE_LIVE）的焦点优先级和普通录音流（AUDIOSTREAM_SOURCE_TYPE_MIC）一致，低于VOIP通话（AUDIOSTREAM_SOURCE_TYPE_VOICE_COMMUNICATION）的焦点优先级。例如，当开始语音通话时，将会停止正在直播采集的语音，同时应用会收到被打断的系统通知（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-ohaudio-oh-audiocapturer-callbacks-struct#oh_audiocapturer_oninterruptevent" target="_blank">OH_AudioCapturer_OnInterruptEvent</a>）。出于安全性的考虑，语音通话的录制流与普通录音录制流不能并发，当应用接收到被打断通知后，建议通过UI提示窗的形式通知用户在语音通话后手动恢复直播语音采集录制。</p> <p><strong>（2）高保真采集录音流能录制到本机扬声器播放的声音吗？</strong></p> <p>不能，正常情况下本机扬声器播放的声音会被回声消除算法抑制掉。如果需要在启用高保真音频采集的同时录制本机扬声器播放的声音，建议可同时启动一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-avscreencapture-arkts" target="_blank">系统内录</a>的录音工作流。</p> <p><strong>（3）相机在多设备（手机、大折叠、阔折叠、三折叠、平板）上如何实现正常状态和折叠状态切换时的预览旋转、切换镜头等功能？</strong></p> <p>设备形态较多，直播相机页面的多设备适配是开发者需面临的一大挑战。由于不同设备的屏幕尺寸、相机镜头、折叠形态以及系统特性等方面存在较大差异，相机界面的开发往往会遇到一系列兼容性问题，影响用户体验。</p> <p>对于该问题，系统提供<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-camera" target="_blank">多设备相机适配的实践建议</a>，包括如何选择相机设备、设置多设备上相机预览画面比例、设置录像旋转角度、实现悬停态相机页面等。</p> <p><strong>（4）直播页面前后台切换如何实现业务保活？</strong></p> <p>直播业务经常面临前后台切换的场景，当主播把开播页面切换至后台时，直播业务应停止音视频采集以保障主播的个人隐私，但同时业务有存活需求，以便于切换至前台时直播可以继续直播。</p> <p>该场景下，建议应用可在直播推后台时发送一张如“主播暂时离开”的画面垫片以告知看播端观众此时主播离开，音视频采集暂停。同时为满足后台存活需求，业务需向系统申请一个数据传输的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task" target="_blank">长时任务</a>，且持续发送直播画面垫片以满足数据传输长时任务的流量监控需求，如下图所示：</p> <p><span><img height="331.100175" originheight="703" originwidth="1868" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163348.03882673890036443944938324362627:50001231000000:2800:CFB364454E171446C6830F511DE98A3BDD3F979F83425291AEA49DEAD76AF566.png" title="点击放大" width="879.7950000000001"></span></p> <p><strong>（5）同一页面内的相机切换生命周期如何管理？</strong></p> <p>直播类应用经常会涉及在同一页面内切换不同的相机调用业务，例如，中间Tab页的业务需要用相机拍摄内容后发布到内容社区，右侧Tab页的业务则是直播页面需启动相机预览。在不同Tab页面切换时，需要特别注意相机使用的生命周期管理。</p> <p>在系统中，相机是单例的，每个页面只能运行一个，运行另一个自定义相机时需要将之前创建的自定义相机资源全部销毁。因此每个Tab页的业务需在感知窗口切换后即时释放相机资源，避免与另一Tab页的相机资源申请产生冲突。此外，在相机前后台切换时也需注意，如果切换后台再切回来，必须要重新初始化相机才可以。因为切后台，相机资源被全部回收，导致再回到相机页面也无法预览画面。关于相机前后台切换和资源释放的开发指导，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/architecture-guides/photo-v1_2-ts_12-0000002298869489" target="_blank">《相机前后台切换》</a>和<a href="https://developer.huawei.com/consumer/cn/doc/architecture-guides/architecture-v1-3_2-ts_10-0000002363076293" target="_blank">《正确关闭释放相机流》</a>。</p> <p><strong>（6）美颜线程需要在新建的子线程中进行吗？</strong></p> <p>需要，因为美颜处理的耗时较长，容易阻塞主线程，建议不要与相机出帧回调（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-image-h#oh_nativeimage_updatesurfaceimage" target="_blank">UpdateSurfaceImage</a>）处于同一线程。</p> </div> <div class="tiledSection"><h2 id="section1818019424273">看播端解决方案<i class="anchor-icon anchor-icon-link" anchorid="section1818019424273" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19538144610310" class="firsth2">流媒体播放<i class="anchor-icon anchor-icon-link" anchorid="section19538144610310" tips="复制节点链接"></i></h3><p>系统提供音视频播放器AVPlayer接口，可用于开发流媒体直播和点播功能，实现端到端的流媒体资源播放。其开发步骤包括创建AVPlayer、设置播放资源和窗口、设置播放参数（如音量、倍速、缩放模式）、进行播放控制（如播放、暂停、跳转、停止）、重置资源、销毁资源等。具体开发指导，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/streaming-media-playback-development-guide" target="_blank">《使用AVPlayer播放流媒体》</a>。</p> </div> <div class="tiledSection"><h3 id="section569847183219">音画同步<i class="anchor-icon anchor-icon-link" anchorid="section569847183219" tips="复制节点链接"></i></h3><p>在看播端，通常音频渲染的时延大于视频硬件送显的时延，因此建议应用获取音频实际渲染的时间戳，调整视频送帧时延以匹配音频实际播放时延，从而实现音画同步。</p> <p>获取音频流时间戳的接口推荐使用最新的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_getaudiotimestampinfo" target="_blank">OH_AudioRenderer_GetAudioTimestampInfo()</a>，该接口适配了倍速播放能力，相比<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>功能更为完备。关于音画同步的具体开发指导，开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-audio-video-synchronization" target="_blank">《音画同步最佳实践》</a>。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ul><li>在音频启动前，timestamp和framePosition返回结果为0。为避免卡顿等问题，建议开发者此时暂不同步，视频帧可直接送显。当获取到实际音频渲染时间戳时，再根据视频帧PTS和音频渲染位置计算延迟。</li><li>当framePosition和timestamp以稳定的速度前进后，建议调用OH_AudioRenderer_GetAudioTimestampInfo接口的频率不要过于频繁。推荐每200ms调用一次，也可以每分钟调用一次，最好不要低于200ms一次，频繁调用可能会带来功耗问题。因此在能保证音画同步效果的情况下，不需要频繁地查询时间戳。</li></ul> </div></div></div> </div> <div class="tiledSection"><h3 id="section92244418339">看播端开发场景问题<i class="anchor-icon anchor-icon-link" anchorid="section92244418339" tips="复制节点链接"></i></h3><p><strong>如何防止播放器的内存泄漏？</strong></p> <p>该问题通常由Native层资源未正确释放导致的，尤其是操作NativeWindow的接口（如引用/解引用、创建/销毁）未成对使用。</p> <p>开发者应严格确保Native代码中申请与释放资源的API成对调用，主要包括OH_NativeWindow_NativeObjectReference()与OH_NativeWindow_NativeObjectUnreference()、OH_NativeWindow_NativeWindowFromSurfaceId()与OH_NativeWindow_DestroyNativeWindow()。此外，建议开发者将资源管理逻辑纳入代码审查重点，确保生命周期一致，并在关键节点添加日志，通过反复测试验证资源释放是否彻底。同时，为XComponent设置具有业务意义的清晰组件ID，可在出现泄漏问题时快速定位问题源。</p> </div> <div class="tiledSection"><h2 id="section1481335518275">典型直播场景<i class="anchor-icon anchor-icon-link" anchorid="section1481335518275" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section937641814341" class="firsth2">电商直播场景<i class="anchor-icon anchor-icon-link" anchorid="section937641814341" tips="复制节点链接"></i></h3><p><strong>（一）场景描述</strong></p> <p>近年来，直播电商已成为商家推广产品、吸引消费者的重要途径。在直播电商中，主播通过视频直播的形式，为商品提供全方位、多角度的展示。试穿服装、示范化妆、详细介绍产品特性和使用方法，都能直观地呈现给观众，从而凸显商品的优势和特性，快速增加消费者对商品的了解和信任。这种“边看边买”的沉浸式购物体验模式既满足了消费者的购物需求，还能够实时给主播提供反馈和建议，极大地提升了购物过程的参与感和社交属性，能够将粉丝的热情转化为强大的购买力，是当前应用直播的重点场景之一。</p> <p><strong>（二）痛点分析</strong></p> <ol><li>由于直播间灯光、开播设备等环境因素，电商直播经常会因为色差、瑕疵隐藏等质量问题而面临高退货率，从而影响整体收益。</li><li>直播间主播在试穿服装、示范化妆等展示环节中，往往需要针对服饰与妆容细节内容进行精细化讲解，调焦时间长、主播频繁移动导致失焦，会影响消费者对展示商品的了解与观察，影响看播的沉浸感。</li></ol> <p><strong>（三）解决方案</strong></p> <ol><li>使用系统的红枫摄像能力进行直播，获得更好的商品色彩准确度<p>相机的红枫原色能力，通过150万光谱分辨率、9通道，捕捉更多光谱信息，从而大幅提升色彩还原准确性。借助色准的视觉效果，搭配主播专业的外观讲解，助力消费者更直观、更高效地感受商品色准。</p> </li><li>HDR Vivid视频直播<p>通过HDR Vivid直播模式能够达到高光不过曝、暗部有细节，画面层次更加丰富，色彩更加精准鲜活，能有效地还原真实场景，搭配高清的分辨率，可以让主播人物、背景等更清晰可见，给看播端观众更好更沉浸的体验。</p> </li><li>ROI编码，让直播核心区域画质更清晰<p>通过系统的ROI编码能力，可以提升指定核心区域的细节展示，结合主播知识介绍实现内容种草与价值传达，帮助消费者更好地理解直播商品介绍。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section9452193083413">娱乐直播场景<i class="anchor-icon anchor-icon-link" anchorid="section9452193083413" tips="复制节点链接"></i></h3><p><strong>（一）场景描述</strong></p> <p>娱乐直播已经替代早期流行的聊天室，逐步演变成一个庞大复杂且功能多样的生态系统，为普通消费者提供了很好的娱乐方式。娱乐直播所附带的弹幕、礼物互动、PK连麦等方式也带来了附加的经济价值。娱乐直播间的音频效果与主播装扮尤为重要，高保真的音频采集、高清的连麦PK、以及针对主播的人脸美颜效果等都是留住观众的重要因素。</p> <p><strong>（二）痛点分析</strong></p> <ol><li>娱乐直播常见的场景包括歌唱、舞蹈等，需要将设备或其他外界干扰因素对收音的影响降到最低，尽量还原主播原声。</li><li>娱乐主播的颜值是观众关注的重点之一，需要保障核心区域的画面清晰度。</li></ol> <p><strong>（三）解决方案</strong></p> <ol><li>高保真拾音<p>使用系统提供的高保真音频采集能力，可以让采集到的音频信号尽可能接近原声。同时，AUDIOSTREAM_SOURCE_TYPE_LIVE录音流所提供的高保真回声消除能力，可以让娱乐主播在连麦PK时也有高清的演唱、舞蹈伴奏效果。</p> </li><li>ROI编码<p>将颜值主播的人脸核心区域分配更多码率，对其进行高质量编码，对主播周边背景等非重要场景分配较少码率，在确保主播本身画质高效果好的情况下还可以节省网络带宽，确保直播画面整体的高质量。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section5288123883414">户外直播场景<i class="anchor-icon anchor-icon-link" anchorid="section5288123883414" tips="复制节点链接"></i></h3><p><strong>（一）场景描述</strong></p> <p>户外实景真人秀打破了传统直播室内布景的模式，可以给观众更直观、更真实的观看体验。户外直播的背景场景多样化，需要应对各种场景的诉求，如逆光和强光下如何优化直播间内的可见度清晰度，又或者是夜晚户外直播时如何提供夜景模式下的高画质直播。同时，如何保障直播设备的稳定也是户外直播需要考虑的关键问题。</p> <p><strong>（二）痛点分析</strong></p> <p>户外直播可能存在逆光、强光、暗光等场景，需要保障直播间的画质观众可接受且尽量贴合环境的肉眼原色。</p> <p>长时间户外直播可能带来设备发热、屏幕亮度降低、画面掉帧等问题，需要控制好户外直播设备的功耗。</p> <p><strong>（三）解决方案</strong></p> <ol><li>红枫原色<p>使用相机的红枫原色能力，让观众在观看直播时尽可能地看到户外的真实场景，带来更切身实际的感受。</p> </li><li>接入系统压力反馈监控主动调整户外直播功耗<p>推荐应用接入系统的压力反馈接口，根据户外直播系统压力情况主动在直播流畅度和功耗之间做平衡，避免长时间户外直播时硬件过载发热，影响户外直播的效果和时长。</p> </li></ol> </div> <div class="tiledSection"><h2 id="section0286111103614">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section0286111103614" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/HMOS_LiveStream" target="_blank">实现直播场景的开播和看播功能</a></li></ul> </div> </div> <div></div></div>