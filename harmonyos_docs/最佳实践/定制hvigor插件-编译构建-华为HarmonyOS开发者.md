<h1 _ngcontent-fry-c119="" class="doc-title ng-star-inserted" title="定制hvigor插件"> 定制hvigor插件 </h1>

<div _ngcontent-fry-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1655455914185">概述<i class="anchor-icon anchor-icon-link" anchorid="section1655455914185" tips="复制节点链接"></i></h2><p>在进行编译构建的过程中，开发者可以通过定制hvigor插件，扩展构建逻辑，实现个性化的打包流程。</p> </div> <p>定制hvigor插件，通常有以下目的：</p> <ul><li>满足自定义任务需求。<p>每个项目可能有独特的构建需求和流程，定制插件可以根据项目的具体要求来扩展hvigor构建的功能。</p> </li><li>加强构建任务可维护性。<p>定制插件可以将某些复杂的构建逻辑封装在同一个地方，使得项目的构建配置更加清晰和易于维护。可以自动化执行某些特定任务，减少手动干预，确保构建过程的一致可靠。</p> </li><li>提升团队协作效率。<p>在团队开发中，定制插件可以确保所有团队成员使用相同的构建流程和标准，减少因个人配置差异导致的问题，从而提升团队协作的效率。</p> </li></ul> <p>具体到应用场景上，定制插件可以根据不同的构建需求调整编译产物属性，从而实现灵活的构建管理。</p> <p>本文以<a href="/consumer/cn/doc/best-practices/bpta-custom-hvigor-plugin#section1748957151410">自定义编译产物的文件名及路径</a>为案例来介绍如何定制hvigor插件。</p> <div class="tiledSection"><h3 id="section195734144017" class="firsth2">基本概念<i class="anchor-icon anchor-icon-link" anchorid="section195734144017" tips="复制节点链接"></i></h3></div> <p>定制hvigor插件开发时，涉及以下概念：</p> <ul><li><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor" target="_blank">hvigor</a></strong>：基于TS实现的构建任务编排工具，主要提供任务管理机制，包括任务注册编排、工程模型管理、配置管理等关键能力。</li><li><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section199818016213" target="_blank">hvigor-ohos-plugin</a></strong>：hvigor默认提供的构建插件，利用hvigor的任务编排机制实现应用/元服务构建任务流的执行，完成HAP/App的构建打包，应用于应用/元服务的构建。</li><li><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-life-cycle#section194191858161220" target="_blank">Task</a></strong>：即构建任务，作为hvigor构建过程中的基本工作单元，构建项目的具体工作由Task描述表达，比如源码编译任务，打包任务或签名任务等。每一种任务的执行逻辑由plugin插件提供。</li><li>编译产物：即工程/模块编译后的目标，是项目打包生成的用于依赖或运行的包文件，包括<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/hap-package" target="_blank">HAP</a>（应用安装运行的基本单位）、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/har-package" target="_blank">HAR</a>（静态共享包）、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/in-app-hsp" target="_blank">HSP</a>（动态共享包）以及App（可上架的完整应用程序）等多种类型。</li></ul> <div class="tiledSection"><h2 id="section394719409152">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section394719409152" tips="复制节点链接"></i></h2><p>定制hvigor插件，就是在编译构建的过程中插入开发者需要的自定义任务，将这些自定义任务抽象后封装成可复用的部分，通过输出plugin插件的目标形式，实现编译构建个性化逻辑的复用和共享分发。</p> </div> <p><span><img height="481.194" originheight="715" originwidth="900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163512.85676398346080881324878777843802:50001231000000:2800:61524460B6984ACEA09EF950F9B95DF72DE83A42FC9EACCBA0B9428AAA36D271.png" title="点击放大" width="605.69397"></span></p> <p>如上图所示，hvigor插件的工作原理：</p> <ol><li>开发者编写自定义插件plugin，在插件中自定义任务Task，在项目构建脚本中应用插件。</li><li>hvigor-ohos-plugin将默认构建任务和自定义插件任务，都装进hvigor任务流。</li><li>hvigor任务流按序执行的过程中，hvigor在节点处检查，如果有自定义任务注册，执行相应的自定义任务逻辑。</li></ol> <div class="tiledSection"><h3 id="section10810335500" class="firsth2">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section10810335500" tips="复制节点链接"></i></h3><p>hvigor主要提供了两种方式以实现插件的开发：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section552855418188" target="_blank">基于hvigorfile脚本开发</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section1825121193616" target="_blank">基于typescript项目开发</a></li></ul> <p>两种方式的核心逻辑实现类似，都是以TS文件编写Task任务方法，区别主要在共享和应用方式上。</p> <p>二者对比如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>定制hvigor插件的两种方式对比</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.1" valign="top" width="20.79%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.2" valign="top" width="9.86%"><p>插件项目</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.3" valign="top" width="17.37%"><p>代码开发</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.4" valign="top" width="14.04%"><p>共享方式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.5" valign="top" width="18.529999999999998%"><p>插件使用</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.13.6.2.7.1.6" valign="top" width="19.41%"><p>特点总结</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="20.79%"><p><strong>基于hvigorfile脚本</strong></p> </td> <td class="cellrowborder" valign="top" width="9.86%"><p>不创建项目</p> </td> <td class="cellrowborder" valign="top" width="17.37%"><p>直接编辑工程/模块中hvigorfile.ts文件</p> </td> <td class="cellrowborder" valign="top" width="14.04%"><p>不发布，复制代码实现共享</p> </td> <td class="cellrowborder" valign="top" width="18.529999999999998%"><p>代码逻辑直接应用于编辑工程/模块</p> </td> <td class="cellrowborder" valign="top" width="19.41%"><p>开发使用快速；共享复用不方便</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="20.79%"><p><strong>基于typescript项目</strong></p> </td> <td class="cellrowborder" valign="top" width="9.86%"><p>新建npm项目</p> </td> <td class="cellrowborder" valign="top" width="17.37%"><p>新建custom-plugin.ts文件</p> </td> <td class="cellrowborder" valign="top" width="14.04%"><p>npm打包发布共享，或离线包共享</p> </td> <td class="cellrowborder" valign="top" width="18.529999999999998%"><p>hvigor-config.json5中配置插件依赖，或安装离线包</p> </td> <td class="cellrowborder" valign="top" width="19.41%"><p>易于分发、共享和维护；发布使用流程相对多</p> </td> </tr>  </tbody></table></div> </div> <p>下文的场景实例采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section1825121193616" target="_blank">基于typescript项目开发</a>的方法描述，开发者也可以将插件逻辑代码直接写于hvigorfile.ts中，切换为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section552855418188" target="_blank">基于hvigorfile脚本开发</a>的实现方式。</p> <p>定制hvigor插件涉及的相关能力，可查阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-apis" target="_blank">扩展构建API</a>。</p> </div> <div class="tiledSection"><h2 id="section1748957151410">自定义编译产物的文件名及路径<i class="anchor-icon anchor-icon-link" anchorid="section1748957151410" tips="复制节点链接"></i></h2><p><strong>场景描述</strong></p> <p>以名为library的module生成HAR包为例，默认情况下，HAR包编译产物的生成路径在library/build/default/outputs/default目录下，文件名为library.har。</p> <p>而开发者在用于生产的环境中，可能需要根据项目情况，使编译产物输出到指定路径，并更改其文件名，例如：带有版本号的文件名，或带有开发者名称等信息的文件名。</p> <p>下面示例中用oh-package.json5中配置的属性修改HAR包文件名，同时将生成路径改为library/build/default/outputs/target。</p> <p><strong>开发步骤</strong></p> <ol><li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section1243715533156" target="_blank">初始化typescript项目</a>：配置npm环境，安装typescript依赖，新建一个npm项目做为插件的工程。</span></li><li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section627771916612" target="_blank">开发插件</a>：对插件项目配置HarmonyOS镜像仓库，安装hvigor开发依赖，然后进行插件开发，以下是该场景的插件逻辑实现。</span><p></p><ol><li>在新建的custom-plugin.ts文件中，编写任务函数renameHarTask()。</li><li>在函数中注册自定义任务，使用pluginContext.registerTask()方法。</li><li>通过taskContext得到modulePath（模块路径）、moduleName（模块文件名），拼装得到编译产物的原始文件路径。</li><li>根据需要，读取oh-package.json5中配置属性，拼接生成目标文件名。</li><li>使用fs.mkdir()创建指定目录，再调用fs.rename()，将编译产物移动到目标路径，并修改为新文件名。</li></ol> <p>插件代码示例如下：</p> <div class="screenLinkPre"><div _ngcontent-fry-c106="" class="highlight-div"><div _ngcontent-fry-c106="" class="highlight-div-header"><div _ngcontent-fry-c106="" class="highlight-div-header-left"><div _ngcontent-fry-c106="" class="handle-button expand-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fry-c106="" class="highlight-div-header-right"><div _ngcontent-fry-c106="" class="handle-button ai-button"></div><div _ngcontent-fry-c106="" class="handle-button line-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fry-c106="" class="handle-button theme-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fry-c106="" class="handle-button copy-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fry-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/customPlugin/npm_plugin/pure_plugin.ts#L2-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;</li><li>
</li><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">OhPackage</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">version</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">author</span>: <span class="hljs-built_in">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renameHarTask</span>(<span class="hljs-params">str?: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-keyword">return</span> {</li><li>    <span class="hljs-attr">pluginId</span>: <span class="hljs-string">'RenameHarTaskID'</span>,</li><li>    <span class="hljs-title function_">apply</span>(<span class="hljs-params">pluginContext</span>) {</li><li>      pluginContext.<span class="hljs-title function_">registerTask</span>({</li><li>        <span class="hljs-comment">// Write custom tasks</span></li><li>        <span class="hljs-attr">name</span>: <span class="hljs-string">'renameHarTask'</span>,</li><li>        <span class="hljs-attr">run</span>: <span class="hljs-function">(<span class="hljs-params">taskContext</span>) =&gt;</span> {</li><li>          <span class="hljs-comment">// Read oh-package.json5 and parse the version</span></li><li>          <span class="hljs-keyword">const</span> packageFile = taskContext.<span class="hljs-property">modulePath</span> + <span class="hljs-string">'\\oh-package.json5'</span>;</li><li>          <span class="hljs-keyword">let</span> fileContent = fs.<span class="hljs-title function_">readFileSync</span>(packageFile, <span class="hljs-string">'utf8'</span>);</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">content</span>: <span class="hljs-title class_">OhPackage</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fileContent);</li><li>          <span class="hljs-keyword">const</span> version = content.<span class="hljs-property">version</span>;</li><li>          <span class="hljs-keyword">const</span> author = content.<span class="hljs-property">author</span>;</li><li>          <span class="hljs-keyword">const</span> sourceFile =</li><li>            taskContext.<span class="hljs-property">modulePath</span> + <span class="hljs-string">'\\build\\default\\outputs\\default\\'</span> + taskContext.<span class="hljs-property">moduleName</span> + <span class="hljs-string">'.har'</span>;</li><li>          <span class="hljs-keyword">const</span> targetPath = taskContext.<span class="hljs-property">modulePath</span> + <span class="hljs-string">'\\build\\default\\outputs\\target\\'</span>;</li><li>          <span class="hljs-keyword">const</span> targetFile = targetPath</li><li>            + taskContext.<span class="hljs-property">moduleName</span> + <span class="hljs-string">'-'</span> + version + <span class="hljs-string">'-'</span> + author + <span class="hljs-string">'.har'</span>;</li><li>
</li><li>          <span class="hljs-comment">// Create Directory</span></li><li>          fs.<span class="hljs-title function_">mkdir</span>(targetPath, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> }, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              <span class="hljs-keyword">throw</span> err;</li><li>            }</li><li>            <span class="hljs-comment">// Move and modify product file names</span></li><li>            fs.<span class="hljs-title function_">rename</span>(sourceFile, targetFile, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {</li><li>            });</li><li>          });</li><li>        },</li><li>        <span class="hljs-comment">// Confirm custom task insertion position</span></li><li>        <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'default@PackageHar'</span>],</li><li>        <span class="hljs-attr">postDependencies</span>: [<span class="hljs-string">'assembleHar'</span>]</li><li>      })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/customPlugin/npm_plugin/pure_plugin.ts#L2-L47" target="_blank">pure_plugin.ts</a></div></div></div></div> <p></p></li><li><span>共享插件：有两种方式可选。</span><p></p><ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section855411147" target="_blank">发布插件</a>：插件遵循npm发布规范，将其打包后发布到公共或自建的镜像仓库中。</li><li>共享离线包：将插件工程压缩打包后分享出去。</li></ul> <p></p></li><li><span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-plugin#section60171414358" target="_blank">使用插件</a>：在工程中的hvigor/hvigor-config.json5中，添加已发布的插件（或离线包插件）依赖，执行DevEco Studio菜单File -&gt; Sync and Refresh Project进行工程Sync后，在模块中的hvigorfile.ts导入并使用插件方法。</span><p></p><div _ngcontent-fry-c106="" class="highlight-div"><div _ngcontent-fry-c106="" class="highlight-div-header"><div _ngcontent-fry-c106="" class="highlight-div-header-left"><div _ngcontent-fry-c106="" class="handle-button expand-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fry-c106="" class="highlight-div-header-right"><div _ngcontent-fry-c106="" class="handle-button ai-button"></div><div _ngcontent-fry-c106="" class="handle-button line-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fry-c106="" class="handle-button theme-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fry-c106="" class="handle-button copy-button"><div _ngcontent-fry-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fry-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { harTasks } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/hvigor-ohos-plugin'</span>;</li><li><span class="hljs-keyword">import</span> { renameHarTask } <span class="hljs-keyword">from</span> <span class="hljs-string">'custom-plugin'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {</li><li>    <span class="hljs-attr">system</span>: harTasks,</li><li>    <span class="hljs-attr">plugins</span>:[<span class="hljs-title function_">renameHarTask</span>()] <span class="hljs-comment">// 应用自定义插件</span></li><li>}</li></ol></pre></div></div> <p></p></li><li><span>执行Build -&gt; Make Module编译，编译产物的文件名被修改为“name-version-author.har”的组成形式，同时生成路径从default目录改到了target目录下。结果如下图：</span><p></p><p><span><img height="410.97" originheight="566" originwidth="1014" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163512.60112900895732435672108786222486:50001231000000:2800:3F0698E4BD9EE1827286271FE8F6DAA6AD1DA35191B86DB7E1ACFD8C02B6789C.png" title="点击放大" width="736.2607350000001"></span></p> <p></p></li></ol> </div> </div> <div></div></div>